<div class="post__text post__text-html js-mediator-article">  On the way to creating our own cloud service, we have <a href="https://geektimes.ru/post/297093/">mastered the Debian system</a> and <a href="https://geektimes.ru/post/297601/">created a web server</a> .  Now it's time for the final step - creating and configuring a personal cloud based on Nextcloud server. <br><br><img src="https://habrastorage.org/webt/hd/zf/np/hdzfnpy3coj3pu5hr6xs8ssjop8.jpeg"><br><a name="habracut"></a><br><hr><a name="chap0"></a><br><h3>  Table of contents </h3><br>  <a href="https://geektimes.ru/post/297093/">Part 1. Setting up a Debian environment for everyday use.</a> <br>  <a href="https://geektimes.ru/post/297601/">Part 2. Creating a server - setting LAMP in Debian</a> <br>  <a href="https://geektimes.ru/post/297969/">Part 3. Creating a personal cloud - installing and configuring Nextcloud</a> <br>  <a href="https://geektimes.ru/post/300907/">Part 4. Update 2018 - Debian 9 and Nextcloud 13</a> <br><br><hr><br><h3>  Quick chapter navigation </h3><br>  <a href="https://habr.com/ru/post/410011/">Foreword</a> <br>  <a href="https://habr.com/ru/post/410011/">Preparing the server for the installation of Nextcloud</a> <br>  <a href="https://habr.com/ru/post/410011/">Install Nextcloud</a> <br>  <a href="https://habr.com/ru/post/410011/">Organization of Nextcloud storage</a> <br>  <a href="https://habr.com/ru/post/410011/">Setting up access to the Nextcloud virtual machine from the local network</a> <br>  <a href="https://habr.com/ru/post/410011/">Setting up Nextcloud</a> <br>  <a href="https://habr.com/ru/post/410011/">Additional "fine" setting Nextcloud</a> <br>  <a href="https://habr.com/ru/post/410011/">Protection for Nextcloud</a> <br>  <a href="https://habr.com/ru/post/410011/">Synchronization with the cloud of smartphones</a> <br>  <a href="https://habr.com/ru/post/410011/">Synchronization with the personal computer cloud</a> <br>  <a href="https://habr.com/ru/post/410011/">Afterword</a> <br><br><hr><a name="chap1"></a><br><h3>  Foreword </h3><br>  Here we come to the very thing for which everything was started and why we did not move quickly.  This part will describe the installation and some points in setting up a Nextcloud server in a VMWare virtual machine, as well as some experience with it in the form of synchronizing the contents of a pair of smartphones and folders on a Windows desktop computer.  The following instructions for installing Nextcloud imply that the service is deployed on a server that was created according to the instructions in the previous part of my story. <br><br>  Initially, this chapter was planned for a short one, since I wanted to confine myself to a description of the installation and configuration of Nextcloud, essentially completing this story about “just entering Linux for a specific task”.  But, thinking that it might seem interesting to someone, then I decided to show how I decided to synchronize the folders of my home computer, so this final chapter smoothly flowed from clear instructions on what to do and, in fact, programming.  This explains some "vinaigrette" in this part - it begins with the work and settings in Linux, flowing to the level of network settings and virtual software, and ends with the planning of crutches in Windows.  On the other hand, this series of articles has the title “History of creation ...” and I nevertheless decided to tell it to the end. <br><br>  <b>Note</b> <br>  Upon further reading in constructions of the form http: // 127.0.0.1 (https: // 127.0.0.1), the space after http: // (https: //) must be removed when entering into the address bar of the browser.  A space is inserted when publishing this article in order to prevent the text engine from automatically converting text into links. <br><br><hr><a name="chap2"></a><br><h3>  Preparing the server for the installation of Nextcloud </h3><br>  Nextcloud is a web application that has a set of files and works with the MySQL database.  The web application is installed as a regular site, for installation of which you need to upload the engine files to the server, run the installation file and specify the details of access to the database previously created for this site during the installation. <br><br>  Create a directory where Nextcloud files will be placed: <br>  <b># mkdir / var / www / nextcloud</b> <br><br>  I decided to refuse HTTP, leaving access only via HTTPS.  To do this, you need to configure apache. <br><br>  Open the file: <br>  <b># nano /etc/apache2/sites-available/default-ssl.conf</b> <br>  And before the tag add the following content: <br><br><pre><code class="apache hljs"><span class="hljs-section"><span class="hljs-section">&lt;Directory /var/www/nextcloud&gt;</span></span> <span class="hljs-attribute"><span class="hljs-nomarkup"><span class="hljs-attribute"><span class="hljs-nomarkup">Options</span></span></span></span> FollowSymLinks AllowOverride <span class="hljs-literal"><span class="hljs-literal">All</span></span> Require <span class="hljs-literal"><span class="hljs-literal">all</span></span> granted &lt;/Directory&gt;</code> </pre> <br><br>  Disable HTTP configuration: <br>  <b># a2dissite 000-default.conf</b> <br><br>  Close port 80: <br>  <b># ufw delete allow 80</b> <br><br>  And restart the web server: <br>  <b># service apache2 restart</b> <br><br>  Now you need to create a database for nextcloud.  Enter mysql by entering the password from the mysql superuser: <br>  <b># mysql -u root -p</b> <br><br>  Create a database called nextcloud: <br>  <b>mysql&gt; CREATE DATABASE `nextcloud`;</b> <br><br>  Create a user with the name nextcloud and the trivial password nc123: <br>  <b>mysql&gt; CREATE USER 'nextcloud' @ 'localhost' IDENTIFIED BY 'nc123';</b> <br><br>  We give full access to the nextcloud user to the nextcloud database: <br>  <b>mysql&gt; GRANT ALL PRIVILEGES ON `nextcloud`. * TO 'nextcloud' @ 'localhost';</b> <br><br>  Update privilege table: <br>  <b>mysql&gt; FLUSH PRIVILEGES;</b> <br><br>  Exit mysql: <br>  <b>mysql: mysql&gt; exit</b> <br><br>  In addition, you need to install additional modules for PHP: <br>  <b># apt-get install curl libcurl3 libcurl3-dev php5-curl</b> <b><br></b>  <b># a2enmod rewrite</b> <br><br>  In the first part of this story we opened ports for network and mail interaction, but under our target task they are not required and it is better to close them.  Delete the rules: <br>  <b># ufw delete allow 138 / udp</b> <b><br></b>  <b># ufw delete allow 139 / udp</b> <b><br></b>  <b># ufw delete allow 139 / tcp</b> <b><br></b>  <b># ufw delete allow 445 / tcp</b> <b><br></b>  <b># ufw delete allow 25</b> <b><br></b>  <b># ufw delete allow 465</b> <b><br></b>  <b># ufw delete allow 110</b> <b><br></b>  <b># ufw delete allow 143</b> <b><br></b>  <b># ufw delete allow 993</b> <br><br><hr><a name="chap3"></a><br><h3>  Install Nextcloud </h3><br>  Download files and unpack them into the intended directory: <br>  <b># wget <a href="">download.nextcloud.com/server/releases/nextcloud-11.0.2.tar.bz2</a></b> <b><br></b>  <b># tar xjf nextcloud-11.0.2.tar.bz2 -C / var / www</b> <br><br>  Change permissions on a folder: <br>  <b># chmod 755 / var / www / nextcloud</b> <br><br>  And we assign the web server as the owner of this folder so that there are no problems with writing to it: <br>  <b># chown -R www-data: www-data / var / www / nextcloud</b> <br><br>  Everything!  The service is installed, if you type in the browser https: // 127.0.0.1/nextcloud, the installation wizard will open.  But let's wait with this, having previously prepared a place to store user data. <br><br>  It is worth mentioning that the version of Nextcloud 11.0.2 is currently rather outdated and contains vulnerabilities that are not found in newer and current versions, so if you install the 11.x branch, it is better to install a more recent version (at the beginning of 2018 it’s version 11.0.7). <br><br><hr><a name="chap4"></a><br><h3>  Organization of Nextcloud storage </h3><br>  This part is optional and can be skipped without problems - everything will work without it.  However, if you go to make a directory with data outside of the virtual machine, I recommend to get acquainted with it. <br><br>  By default, synchronized content will be stored in the / var / www / nextcloud / nxcdata directory.  This option did not suit me at once for several reasons.  On the one hand, I would not want a permanent increase in the size of a virtual disk file.  On the other hand, I would like to have a separate and independent of the virtual machine storage solution.  The simplest thing that immediately comes to mind is the use of a USB drive.  In case of insufficient space, the disc can be simply replaced.  If necessary, you can connect it to another computer and download the necessary files.  Mobile and convenient.  However, I did not want to use USB 2.0 due to the relatively small bandwidth by modern standards, and with USB 3.0 I did not succeed - virtualization software (WMVare and VirtualBox) did not want to normally forward devices connected via a USB 3.0 controller. <br><br>  My appetites, in the process of creating the cloud, increased and I didn’t have at least one terabyte, so, in the end, I decided to connect a regular two-terabyte hard drive that was already located and connected inside the computer to the virtual machine.  If necessary, it is easily pulled out and connected via the existing SATA &lt;-&gt; USB 3.0 adapter. <br><br>  So, the main idea is to organize a fixed point for connecting a directory with user content outside the / var / www / nextcloud directory, in which a symbolic link is created with the name nxcdata, referring to the real data directory that can be connected in various ways on various media. <br><br>  Create a directory: <br>  <b># mkdir / mnt / nxcdata</b> <br><br>  We change the rights: <br>  <b># chmod 770 / mnt / nxcdata</b> <br><br>  Making the owner of a web server: <br>  <b># chown www-data: www-data / mnt / nxcdata</b> <br><br>  I can place data anywhere and anywhere, the main thing is to place the symbolic link to this directory in the / mnt / nxcdata directory and call it nxcdata, i.e.  the full path will look like / mnt / nxcdata / nxcdata. <br><br>  First, I tested the solution for the local folder I created in my home directory. <br><br>  Created a folder in the right place: <br>  <b>$ mkdir / home / user / nxcdata</b> <br><br>  Changed rights: <br>  <b># chmod 755 / home / user / nxcdata</b> <br><br>  Owned a web server: <br>  <b># chown -R www-data: www-data / home / user / nxcdata</b> <br><br>  Created a symbolic link: <br>  <b># ln -s / home / user / nxcdata / mnt / nxcdata / nxcdata</b> <br><br>  This solution was workable, so you can move on.  The external data directory can be connected in two ways - through the VMWare Shared service or directly as a physical disk or partition.  It is necessary to understand that the first solution is possible only if there are installed vmware tools, which are easily installed only if there is a graphical interface of the operating system (otherwise, you will have to edit the installation scripts of vmware tools).  If we abandon the graphical interface, then there remains only the option of connecting the disk directly to the virtual machine, but with this decision I had to suffer a lot.  After a while, I nevertheless found a stably working version, taking into account which a universal script was invented, incorporating both connection options. <br><br>  For the folder that is connected via VMWare Shared Folders in the Shared Folders section of the virtual machine settings, you need to connect the necessary folder from the host system and name it vmw-nxcdata.  This folder can refer to a directory on the hard disk or directly to the root directory of a disk on the host system. <br><br>  The connected folder will automatically appear in the virtual system along the path / mnt / hgfs / vmw-nxcdata.  However, the problem is that the web server will not have enough rights to write files along this path and it will not be possible to reassign the rights for this directory using standard system tools.  So I had to figure out how to manually mount these resources. <br><br>  Create a folder: <br>  <b># mkdir / mnt / vmw-nxcdata</b> <br><br>  Perform mounting using the vmhgfs module, which was installed along with the vmware-tools: <br>  <b># mount -t vmhgfs -o uid = www-data, gid = www-data, fmask = 007, dmask = 007 .host: / vmw-nxcdata / mnt / vmw-nxcdata</b> <br><br>  Mounting needs to be done with exactly these parameters to ensure smooth operation of the web server in the future.  Initially, I mounted without specifying uid / gid and masks, but this didn’t lead to anything good, since I could no longer change the permissions after mounting.  After the mount has been completed, the following can be issued: “Could not add entry to mtab, continuing” - however, it will be mounted and work. <br><br>  Great, we have mounted the directory.  Now you can place a symbolic link to this directory in / mnt / nxcdata.  But I would not like to do this manually every time you start or restart the server.  The easiest way is to enter the above command in the /etc/rc.local file for mounting to the “exit 0” line.  However, I wanted to ensure that when the virtual machine was turned off, automatic guaranteed unmounting occurred for reliable data integrity.  And I decided to do everything at the level of services and deal a little with the mechanisms of init / update-rc, the more I was curious and it turned out to be quite interesting. <br><br>  The meaning of the following steps is to create a system service that would be called and executed predefined commands when the system is turned on or off.  The service is described by a script compiled according to certain rules and is located in /etc/init.d.  The INIT INFO block is located at the very beginning of the script and contains service information in which I would like to note the Default-Start and Default-Stop directives - they set the execution levels at which the script should be started or stopped by default. <br><br>  Fulfillment levels: <br><br>  0 - script execution at system shutdown <br>  1 - script execution when starting the system in single user mode <br>  2 - script execution when starting the system in multiuser mode <br>  3 - 5 - reserved <br>  6 - script execution when rebooting the system <br><br>  After writing the script, it is activated using the update-rc mechanism, which, in fact, creates links to the script in the required directories /etc/rc0.d - /etc/rc6.d, the contents of which correspond to the tasks performed at launch levels.  Links can be created independently, but, in contrast to enabling or disabling apache web server configurations, many nuances need to be taken into account here, so you need to enable or disable the service through update-rc. <br><br>  So, create the file: <br>  <b># nano /etc/init.d/nxcdata_automount.sh</b> <br><br>  And write to it the following content: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh # nxcdata_automount.sh 1.0 ### BEGIN INIT INFO # Provides: myscript # Required-Start: # Required-Stop: # Default-Start: 1 2 3 4 5 # Default-Stop: 0 6 # Short-Description: nxcdata_automount.sh 1.0 # Description: nxcdata_automount.sh 1.0 ### END INIT INFO . /lib/lsb/init-functions # Start actions perform_start() { log_daemon_msg «Start nxcdata_automount» sleep 30 mount -t vmhgfs -o uid=www-data,gid=www-data,fmask=007,dmask=007 .host:/vmw-nxcdata /mnt/vmw-nxcdata #mount -t ntfs-3g -o uid=www-data,gid=www-data,fmask=007,dmask=007 /dev/sdb1 /mnt/sdb1 #mount -t ext4 /dev/sdb1 /mnt/sdb1 sleep 5 service fail2ban restart log_end_msg 0 return 0 } # Stop actions perform_stop() { log_daemon_msg «Stop nxcdata_automount» umount /mnt/nxcdata log_end_msg 0 return 0 } case $1 in start) perform_start ;; stop) perform_stop ;; *) echo “Usage: /etc/init.d/myscript {start|stop}” exit 3 ;; esac</span></span></code> </pre><br><br>  Pay attention to a couple of commented commands in the perform_start section - this is our reserve for the future.  Also, after the mount is completed, the fail2ban service is restarted. <br><br>  The paradox is that after a year I don’t remember why I did it, but I strongly doubt that this was done just like that.  Obviously, after the mount was completed, for some unknown reason, the service crashed or failed to start up initially and had to be restarted manually. <br><br>  After such a distraction, we continue the setting further.  Create a symbolic link: <br>  <b># ln -s / mnt / vmw-nxcdata / mnt / nxcdata / nxcdata</b> <br><br>  Making our script executable: <br>  <b># chmod + x /etc/init.d/nxcdata_automount.sh</b> <br><br>  Add the script to autoload: <br>  <b># update-rc.d nxcdata_automount.sh defaults</b> <br><br>  Reboot the system and make sure that the automount is successful and everything is available along the necessary paths. <br><br>  To remove the script you will need to execute a couple of commands: <br>  <b># update-rc.d -f nxcdata_automount.sh remove</b> <b><br></b>  <b># rm -f /etc/init.d/nxcdata_automount.sh</b> <br><br>  In the case of mounting the disk not through VMWare Shared Folders, but directly you should perform the actions similar to that when mounting through VMWare Shared Folders, but taking into account the fact that a full-fledged second disk appears in the system.  How to recognize the drive letter? <br><br>  Most Linux block devices are connected via the SCSI interface, so in most cases the disks will start with the letters sd.  The third letter in the disk name means its ordinal number in the system and is alphabetically designated: sda - the first disk, sdb - the second disk, sdc - the third one, and so on.  Next comes the number that identifies the partition number on the disk: sda1, sda2, and so on.  The easiest way to see all mounted disks is to look at the contents of the / dev / directory and filter the sd devices: <br><br>  <b>$ ls -l / dev / |</b>  <b>grep sd</b> <br><br>  For example, we need to connect the sdb1 drive with the NTFS file system. <br><br>  Create a directory and mount the disk into it: <br>  <b># mkdir / mnt / sdb1</b> <b><br></b>  <b># mount -t ext4 / dev / sdb1 / mnt / sdb1</b> <br><br>  Create a directory for the data, set its rights and user: <br>  <b># mkdir / mnt / sdb1 / nxcdata &amp; chmod 770 / mnt / sdb1 / nxcdata &amp; chown -R www-data: www-data / mnt / sdb1 / nxcdata</b> <br><br>  Next, you also need to create a script for automounting and correct the mount command in the script (examples of connecting a disk with NTFS and EXT4 are already in the script and commented out) and add the script to autoload. <br><br>  B create a symbolic link to the data directory: <br>  <b># ln -s / mnt / sdb1 / nxcdata / mnt / nxcdata / nxcdata</b> <br><br>  In fact, this whole mess with a bunch of nxcdata directories is designed for one thing: to ensure a simple transfer of the data directory in the future - you will not need to edit the configuration in the Nextcloud engine and generally go into it - all you need to do is plug in a new disk, copy to data from it and re-create the symbolic link leading to the new data directory.  In this case, all actions do not go beyond the directory / mnt.  So everything turned out to be complicated evolutionarily, I just did not want to lose the solutions I had worked out. <br><br>  What is the best way to take out data outside the virtual machine?  I will share my experience on which version I stopped and why. <br><br>  USB drives were automatically captured when the virtual machine was loaded, they were correctly and fully forwarded inside and everything always worked, but only until the drive was disconnected from the system for some reason.  It helped reboot or physically disconnect and connect the drive.  The solution turned out to be unreliable.  There was no such problem with flash drives, but I was absolutely not satisfied with their volume and speed of work.  Perhaps it was worth trying an external drive with autonomous power. <br><br>  Forwarding directories through VMWare Shared Folders worked stably and perfectly.  This solution fully satisfied the task of synchronizing two smartphones.  Everything worked for several days, tens of gigabytes of data were downloaded.  However, when I decided to add data from a computer to the cloud, then suddenly a problem was discovered related to long paths and file names.  In theory, the limit on the length of a file or folder name in NTFS is 255 characters, but in practice the Windows API limits it to 244 characters.  In theory, the limit on the path to a file or folder in NTFS is 32,767 characters, but in practice the Windows API limits it to 245 characters.  Considering that I am a big fan of structuring information, the length of the path I can have is very long.  The unabridged title of books can also easily be 100-150 characters, taking into account the spaces.  This limitation is a well-known VMWare Shared Folders problem that did not cure even when using Windows 10 with all sorts of clever keys in the registry to remove the 255-character limit.  Possible reason for the limitations of vmhgfs.  From this convenient method of connection had to be abandoned.  The reason is established exactly - a problem in the virtual file system that is used in the VMWare Shared Folders mechanism. <br><br>  The next solution is to connect the hard disk directly to the virtual machine.  Here, too, everything did not go smoothly.  The data structure (or file system, and this manifested itself for both NTFS and EXT2 / 3/4) constantly broke down either by “capturing” the disk or its partition with software of the virtual machine, or by returning it to the host system even if I translated disk offline on the host system.  In some modes, I don’t have to write or read data - I couldn’t even properly format the forwarded hard disk or partition.  However, it was possible to find a workable mode: a physical hard disk with a single partition, formatted in NTFS, in a particular connection mode was connected to the virtual machine: SATA / Independent / Persistent / Use individual partition.  The nxcdata folder containing the data must be located on the hard disk. <br><br><hr><a name="chap5"></a><br><h3>  Setting up access to the Nextcloud virtual machine from the local network </h3><br>  We have no problems opening sites within a virtual machine or from a host system.  But how to open the created site from another computer on the local network?  Let's look at the structure of our network, shown below. <br><br><img src="https://habrastorage.org/webt/vt/ge/zt/vtgeztmrqy5y22zje4pgdn-40ro.png"><br><br>  The picture shows that the router is connected to the Internet directly and configured so that it automatically distributes IP addresses to connected devices in the range 192.168.0.2-192.168.0.254.  The address 192.168.0.2 was received by our computer, and 192.168.0.3 - the second computer on which we make the server.  However, virtualization software is installed on the second computer, which created its virtual router and configured its <a href="http://ru-wiki.org/wiki/DHCP">DHCP</a> on the subnet 192.168.233.0/24.  Our virtual server received an IP of 192.168.133.138. <br><br>  I can easily open the site inside the virtual machine 192.168.233.138.  I can easily open the site from the 192.168.0.3 machine by simply entering the desired IP address in the browser - the virtualization software has already taken care of correctly configuring the network environment on the host machine.  But how can I get to the site from a computer 192.168.0.2?  If I enter the IP address 192.168.233.138, then nothing will open to me, since neither my computer nor the real router knows anything about this subnet.  If I enter the address 192.168.0.3, then nothing will open to me either, since there really is no site on this computer - it is inside its virtual machine. <br><br>  To resolve this issue, you need to configure the virtual router of the computer 192.168.0.3.  We already know that accessing sites goes through ports 80 and 443. When accessing these ports to machine 192.168.0.3, you need to build routing so that requests are forwarded to the virtual machine 192.168.233.138.  Fortunately for this we have available tools.  VMWare Workstation has the Virtual Network Editor tool, which can be opened from the virtual machine menu (Edit -&gt; Virtual Network Editor). <br><br><img src="https://habrastorage.org/webt/07/-x/ml/07-xmlj7novkph4sr6e0yrmabnw.jpeg"><br><br>  This tool allows quite flexible management of network parameters.  We need to select the VMNet8 virtual network card and click on the “NAT Settings ...” button that has become available.  In the window that opens, you need to add rules to create the desired routing. <br><br><img src="https://habrastorage.org/webt/uc/jh/dp/ucjhdp0cif4azermsxbwfra4v-o.jpeg"><br><br>  Specify the port of the host system and then write the IP address and port of the virtual machine where the requests should be redirected.  For forwarding HTTPS traffic, you must specify the port 443 of the host system and port 443 and the address 192.168.233.138 of the virtual machine.  After creating the rules, click "OK" in all windows - the virtual network environment is automatically reconfigured. <br><br>  After these changes, our sites will begin to open from the machine 192.168.0.2 when accessing the address 192.168.0.3. <br><br>  Such settings for port forwarding are available not only for VMWare, but also for VirtualBox (Settings → Network → select the required adapter → Advanced → Port forwarding).  However, in the process of experimenting to connect a hard disk to this stage, I found a free VMWare Player installed, in which the Virtual Network Editor was not.  I found nothing on the Internet about port forwarding for VMWare Player and I had to use the trial version of VMWare Workstation - when installing the product, it is given 30 days of its free use.  After 30 days, you can remove the product, clean the registry and reinstall it, but such attention to the server is somehow redundant and clearly undesirable.  And then I went for a little (or big) trick. В наборе файлов VMWare Workstation присутствует утилита vmnetcfg, которая по сути и запускается через пункт Virtual Network Editor. Однако в наборе файлов VMWare Player её не было. Но при установке VMWare Player как-то же конфигурирует своё сетевое окружение? Я просто взял эту утилиту и скопировал в папку с VMWare Player, после чего запустил. Удивительно, но всё получилось. Возможно, тонкие сетевые настройки в среде VMWare Player работать не будут, но проброс портов обеспечивается, а большего мне и не нужно. <br><br> Для доступа к нашему серверу из интернета нужно аналогично пробросить порты на маршрутизаторе, который подключен к интернету. В прошивках подавляющего большинства маршрутизаторов есть секция Port Forwarding, в которой и можно настроить маршрутизацию, указав внешний порт и порт и IP адрес внутренней машины. Однако есть небольшой нюанс. Если провайдер нам выдал реальный IP адрес или мы его купили у него, то тогда проблем не будет – с компьютера из любой точки планеты вводим этот IP адрес, реальный маршрутизатор перенаправит траффик на компьютер с виртуальной машиной, на котором виртуальный маршрутизатор перенаправит траффик непосредственно в виртуальную машину. А вот что делать тому, у кого нет возможности получить реальный IP адрес и он получает динамические адреса или оказывается за <a href="https://ru.wikipedia.org/wiki/NAT">NAT</a> провайдера, получая «серые» IP адреса? Мне такую задачу решать не пришлось, так как у меня есть статичный «белый» IP. Тому, кому придётся решать такую задачу так или иначе придётся разбираться с этой проблемой. Я бы советовал посмотреть в сторону dyndns или freedns.afraid.org в случае динамических адресов, либо купить дешевый VDS попробовать придумать какую-то маршрутизацию самому, так как в любом случае без внешнего сервера с статичным IP адресом подобную проблему не решить. <br><br> После конфигурирования маршрутизации я зафиксировал IP адреса компьютеров 192.168.0.3 и 192.168.233.138, прописав их в настройках сетевых карт указанных машин вручную для того, чтобы исключить их автоматическое переназначение. <br><br><hr><a name="chap6"></a><br><h3> Настройка Nextcloud </h3><br> Теперь пришла пора открыть в браузере https:// 127.0.0.1/nextcloud внутри виртуальной машины, https:// 192.168.233.138/nextcloud с хостовой системы или, исходя из вышеописанной настроенной маршрутизации, https:// 192.168.0.3/nextcloud с любого компьютера в локальной сети. <br><br> Далее задаём логин/пароль для администратора, доступ к ранее созданной БД, а в качестве места хранения указываем полный путь к директории nxcdata: /mnt/nxcdata/nxcdata. Данный этап настройки ничем не отличается от установки какого-нибудь сайта. <br><br> В настройках админки я сделал следующие нехитрые изменения: <br><br> — Personal → выбрал русский язык и указал e-mail для администратора user@localhost <br> — Администрирование → Общий доступ → отключил все пункты <br> — Администрирование → Usage survey → отключил все пункты <br> — Администрирование → Дополнительные настройки → Управление файлами: «Максимальный размер загружаемого файла» установил в 25 GB <br> — Пользователи → создал группу users и добавил в неё нового пользователя user <br><br> После настройки нужно включить кеширование. <br><br> Открываем файл: <br> <b># nano /var/www/nextcloud/config/config.php</b> <br><br> И в самый конец, перед «);» добавляем нижеследующее: <br><br> <code>'memcache.local' =&gt; '\OC\Memcache\Memcached', <br> 'memcache.distributed' =&gt; '\OC\Memcache\Memcached', <br> 'memcached_servers' =&gt; array( <br> array('localhost', 11211), <br> ), <br></code> <br><br> Теперь нужно разрешить внешний доступ к сайту на уровне его «движка». <br><br> Открываем файл: <br> <b># nano /var/www/nextcloud/config/config.php</b> <br><br> В секцию trusted_domains нужно в массив IP адрес сервера, добавить адрес, на котором установлен Nexcloud. Секция trusted_domains в нашем случае будет выглядеть следующим образом: <br><br> <code>'trusted_domains' =&gt; <br> array ( <br> 0 =&gt; '127.0.0.1', <br> 1 =&gt; '192.168.233.138', <br> ), <br></code> <br><br> Теперь можно проверить работоспособность сервиса – открываем сайт и авторизуемся под пользователем user. Если авторизация прошла успешно, то значит сервис готов к бою – можно ставить приложение для синхронизации на компьютеры и смартфоны, для доступа ввести IP адрес 192.168.0.3 и реквизиты доступа аккаунта, созданные под каждое устройство. <br> К счастью или к сожалению, мне не пришлось пользовался всем потенциалом созданного сервиса, так как изначально мне нужна была система резервного копирования с верификацией и стартово я вообще хотел обойтись только subversion, но скорость коммитов особенно большого количества мелких файлов меня сильно опечалила. Я сделал всё на вырост, но попользоваться этим так и не собрался, а потом стало как-то совсем не до облака. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A more detailed overview of the use of the service was made by the user </font></font><a href="https://habr.com/users/wtigga/" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wtigga</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> at the end of 2017 in his article </font></font><a href="https://geektimes.ru/post/294997/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“How to download a VPS: your Nextcloud cloud”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">The article, from the user's point of view, gives an overview of the newer Nextcloud server, version 12.</font></font><br><br><hr><a name="chap7"></a><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Additional "fine" setting Nextcloud </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">During the operation of the cloud during the first month of operation, some problems surfaced, which I had to solve with the help of the community or independently. </font><font style="vertical-align: inherit;">I must say that I used the service very hard and essentially checked it for stress resistance. </font><font style="vertical-align: inherit;">Synchronizing several gigabytes of data from the phones and up to a million small files from a computer in the evening was a common thing. </font><font style="vertical-align: inherit;">In general, the service made a very positive impression on me.</font></font><br><br> Я бы не сказал, что нижеизложенные решения правильны и красивы, но эти костыли работают по крайней мере для версии 11.0.2, иначе сервисом пользоваться было бы невозможно. В версии 12.х возможно что-то было улучшено и исправлено, поэтому я бы не рекомендовал эти настройки прописывать сразу в рамках стартовой настройки, в то время как для линейки 11.x их можно применять сразу. <br><br> <b>Проблема 1</b> <br><br> При синхронизации возникает ошибка типа «file is locked». Синхронизация останавливается. Проблема известна — необходимо очистить содержимое таблицы oc_file_locks выполнив из консоли mysql (при авторизации пользователя nextcloud) к ней следующий запрос: <br> <b>mysql &gt; DELETE FROM oc_file_locks WHERE 1</b> <br><br> Так как такие ошибки нередки, то я не придумал ничего лучше, как создать скрипт и положить его прямо в папку суперпользователя: <br> <b># nano /root/empty_oc_file_locks</b> <br><br> Содержимое скрипта: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash mysql -unextcloud &gt; -pnc123 -D nextcloud &lt;&lt;MY_QUERY DELETE FROM oc_file_locks WHERE 1 MY_QUERY</span></span></code> </pre><br><br> Скрипт можно выполнять вручную, но это же не наш метод. Я решил запускать его автоматически каждые 15 минут используя cron (https://ru.wikipedia.org/wiki/Cron ). <br> Для этого нужно создать файл: <br> <b># nano /root/crontab</b> <br><br> Со следующим содержимым: <br><br> <code>*/15 * * * * root bash /root/empty_oc_file_locks <br></code> <br><br> Теперь нужно внести изменения в планировщик: <br> <b># crontab /root/crontab</b> <br><br> Проверить наличие изменений можно так: <br> <b># crontab -l</b> <br><br> <b>Проблема 2</b> <br><br> При синхронизации по webDAV в логах (смотреть в панели администрирования, авторизовавшись администратором) могут появляться следующие ошибки: <br><br> <code>Error PHP reset() expects parameter 1 to be array, null given at /var/www/nextcloud/apps/files_versions/lib/Storage.php#783 <br> Error PHP ksort() expects parameter 1 to be array, null given at /var/www/nextcloud/apps/files_versions/lib/Storage.php#782 <br> Error PHP Invalid argument supplied for foreach() at /var/www/nextcloud/apps/files_versions/lib/Storage.php#759 <br> Error PHP Undefined index: by_file at /var/www/nextcloud/apps/files_versions/lib/Storage.php#759 <br> Error PHP Undefined index: all at /var/www/nextcloud/apps/files_versions/lib/Storage.php#757 <br></code> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This time the community did nothing and had to be investigated alone. The reason was the error "Undefined index ... Storage.php # 757", which cascadingly pulls a few more errors. We look at the code of this file. The whole problem was in quota. On this line in the code (Storage.php # 757) the free space is calculated taking into account the volume of archive files. Something goes wrong in the calculation, although the quota is set to "unlimited". To fix an error in the administration panel, I set an “infinite but numeric” quota for each user, for example, 100TB. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problem 3</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The problem with synchronizing .htaccess files - they just do not sync! </font><font style="vertical-align: inherit;">And I was not alone, in some forums asked similar questions. </font><font style="vertical-align: inherit;">However, I did not meet the ready solution. </font><font style="vertical-align: inherit;">I had to think again myself. </font><font style="vertical-align: inherit;">As a result of googling, viewing logs, analyzing the code, I did not think of anything better than how to correct the nextcloud engine file. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the /var/www/nextcloud/lib/private/Files/filesystem.php file, we are looking for the following line: </font><font style="vertical-align: inherit;">And we bring it to the following form:</font></font><br><br> <code>$blacklist = \OC::$server-&gt;getConfig()-&gt;getSystemValue('blacklisted_files', array('.htaccess')); <br></code> <br><br><font style="vertical-align: inherit;"></font><br><br> <code>$blacklist = \OC::$server-&gt;getConfig()-&gt;getSystemValue('blacklisted_files', array('')); <br></code> <br><br><hr><a name="chap8"></a><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Protection for Nextcloud </font></font></h3><br> Защитить наш сервис от подбора паролей к админке можно с помощью fail2ban. Для этого нужно описать характерное выражение, встречающееся в логах nextcloud при неудачной авторизации, по которому будет срабатывать соответствующий триггер. <br><br> Создаём файл: <br> <b># nano /etc/fail2ban/filter.d/nextcloud.conf</b> <br><br> С нижеприведённым содержимым: <br><br> [Definition] <br> failregex={«reqId»:".*",«remoteAddr»:".*",«app»:«core»,«message»:«Login failed: '.*' \(Remote IP: ''\)»,«level»:2,«time»:".*"} <br> ignoreregex = <br><br> Открываем файл: <br> <b># nano /etc/fail2ban/jail.local</b> <br><br> И в конец файла добавляем нижеприведённое: <br><br> <code># выявляем неудачные попытки ввода пароля к nextcloud <br> [nextcloud] <br> enabled = true <br> port = http,https <br> protocol = tcp <br> filter = nextcloud <br> logpath = /var/log/nextcloud.log <br></code> <br><br> Перезагружаем сервис: <br> <b># service fail2ban restart</b> <br><br> Проверяем наличие активного фильтра: <br> <b># fail2ban-client status nextcloud</b> <br><br> Не забываем, что в соответствии с настройками fail2ban из предыдущей части при неудачном вводе пароля шесть раз подряд в течение 12 часов ваш IP заблокируется ни много ни мало на 30 дней. Я как-то потратил два вечера из-за ошибочного ввода пароля на одном из телефонов, пока не выяснил этот простой факт в логах системы. <br><br><hr><a name="chap9"></a><br><h3> Синхронизация с облаком смартфонов </h3><br> Для синхронизации содержимого телефонов, работающих под Android, существует замечательное приложение FolderSync. Программа полностью оправдывает свою небольшую цену. <br><br> Для начала необходимо создать новую учётную запись, в которой в качестве адреса сервера указать https:// 192.168.0.3/nextcloud, ввести логин и пароль от предварительно созданной учётной записи и разрешить самоподписной сертификат. Нажимаем кнопку «Тест» и убеждаемся, что соединение с сервером в порядке. <br><br> Далее нужно создать задание. В задании указываем ранее созданную учётную запись и выбираем тип синхронизации – «На удалённую папку». Указываем удалённую папку (создать её можно прямо из приложения» и выбираем локальную папку для синхронизации. Расписание я установил в 2 часа ночи каждый день. В настройках синхронизации у меня было включено «Синхронизация подпапок» и «Синхронизация включенных папок», так же я выбрал опцию всегда заменять старые файлы и в случае конфликтов разрешил по умолчанию использовать локальный файл. В разделе «Соединения» я отключил все соединения кроме Wi-Fi, причём прописал SSID своей домашней Wi-Fi сети в раздел «Разрешённые WiFi SSID'ы» — приложение будет выполнять синхронизацию только в моей домашней сети и не пытаться искать сервер в других сетях. Остальные настройки я оставил по умолчанию. Здесь же можно добавить фильтрацию. Я создал новый фильтр «Имя папки содержит» и указал значение [nosync]. Таким образом, я могу исключить из синхронизации некоторые папки в указанной локальной папке, просто добавляя в конец их названия «[nosync]». <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This setting was made for local folders such as DCIM, Download, Telegram, viber, WhatsApp. </font><font style="vertical-align: inherit;">Plus a couple of my user folders of several gigabytes. </font><font style="vertical-align: inherit;">Once a day, the contents of these folders are synchronized with the server, and the old versions of the files on the server are not deleted, but renamed and moved to the archive. </font><font style="vertical-align: inherit;">This allowed me to quickly restore an accidentally deleted file or roll back changes to some other files.</font></font><br><br><hr><a name="chap10"></a><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Synchronization with the personal computer cloud </font></font></h3><br> Я не считаю себя настоящим программистом. Последние десять лет я программирую на таких языках программирования, которые применяются разве что при разработке процессоров или чипсетов. Ввиду того, что я уже как лет 15 ничего не делал на Си/Си++, но что-то автоматизировать на компьютере мне требовалось, я довольно активно применял скриптовые языки типа BAT/CMD или такой софт как Sign 0f Mistery или xStarter. Когда-то я узнал и попробовал что такое AutoIt и это стало новой эрой в моей автоматизации на ПК. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After I was convinced of the stability and reliability of the synchronization system on smartphones, I thought that it would be nice to synchronize data on my home computer. Nextcloud has its own client for Windows and, of course, it has become the first candidate for testing. Synchronize I was going to a terabyte order data volume, consisting of hundreds of thousands of files of different sizes. The data was different: music, pictures, documents, e-books, distributions, backup copies of sites and so on and so forth. It would be reasonable to reduce all this to synchronization of more critical data, such as documents, for example, but I was excited about excitement and wanted to check the service for strength.</font></font><br><br> Спустя десяток часов после начала синхронизации, а по сути первой закачки контента на сервер, клиент запнулся о файл с длинным именем. В то время на сервере я еще использовал подключение внешнего хранилища через VMWare Shared Folders и мне пришлось перепробовать с десяток клиентов, а потом ставить простые эксперименты по ручному копированию файлов на сервер, чтобы понять, что проблема – на стороне сервера. Так, спустя неделю удачного запуска сервиса, пришлось откатываться на резервную виртуальную машину и отказаться от механизма VMWare Shared Folders, начиная всё сначала. В конце концов, я убрал это узкое место на стороне сервера, протестировал надёжность решения неделей синхронизации смартфонов и решил вновь вернуться к домашнему компьютеру. На этот раз клиент не споткнулся о злополучный файл и я уже было возрадовался, однако спустя полсуток синхронизации мелких файлов клиент опять подвис. Теперь выяснилось, что слишком длинный путь именно на стороне домашнего компьютера и клиент Nextcloud не может его корректно обработать. К сожалению, с родным клиентом Nextcloud работы не получилось, да и информативность его была не совсем высока, поэтому от него пришлось отказаться. <br><br> Какое-то время я потратил на то, чтобы найти удобную программу для синхронизации, поддерживающее управление через командную строку. Мне хотелось на каждую крупную папку на компьютере сделать своё задание и запускать их в пакетном режиме. Ранее у меня уже был сделан и отработан набор BAT файлов для синхронизации, используя сценарии и управление FreeFileSync через командную строку. Проблема длинных путей или имён файлов решалась заданием локальных папок вида «\\?\D:\Info», т.е. по сути обращением к локальной папке как к сетевой. Однако, что такое webdav FreeFileSync не знает. Полных аналогов FolderSync для Windows, к сожалению, не нашлось, но не раз на форумах вместо неё рекомендовали GoodSync и, после кастинга десятка других программ, я решил попробовать его. К сожалению, GoodSync стоит на порядок дороже, но разовая трата 15$ ради сохранности своих драгоценных данных, в принципе, посильная трата. Программа имеет тестовый режим, поэтому сначала можно убедиться в её работоспособности и стабильности. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GoodSync was pretty friendly software. There is a special portable version called GoodSync2Go. Here she is and interested me. When installing, you need to select the drive letter and the program is installed on it in the GoodSync folder. I created the Sync folder in the root directory of the disk, say D, and moved the created GoodSync folder with all its contents to it. </font></font><br><br> <sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[ </font></font><a href="https://geektimes.ru/post/297969/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This text was</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> written specifically for the site </font></font><a href="https://geektimes.ru/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">geektimes.ru</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> by </font></font><a href="https://geektimes.ru/users/alexanders/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AlexanderS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reference to the source is optional, but its mention is highly desirable!</font></font></sup>  <sup>]</sup> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After installation, the program needs to create tasks: specify a local folder and a remote folder for synchronization. In the parameters of the task, I chose synchronization from left to right with the choice of options "Synchronous deletion" and "Save previous versions of deleted / replaced files." In the settings of the left side, I chose "Safe Copy" and "Do not create the _gsdata_ folder", the right side - "Safe Copy" and "Fast Predalizatsii on timestamps." Thus, jobs are created for each desired folder. Suppose I set up a task for the Info folder and called it “bck_Info”. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next, in the D: \ Sync folder, the bck_Info.bat file is created with the following contents:</font></font><br><br><pre> <code class="bash hljs">@<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> dir=%~dp0 @%dir%GoodSync\GoodSync2Go-v10.exe /miniwin /<span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> sync <span class="hljs-string"><span class="hljs-string">"%~n0"</span></span></code> </pre><br><br> Это скриптовый язык BAT. В первой строчке кода в переменную устанавливается текущий путь для запущенного скрипта. Вторая строчка запускает по этому пути из папки GoodSync файл GoodSync2Go-v10.exe, в котором должно выполнится задание с названием имени этого файла (bck_Info), окно выполнения задания минимизируется, по завершению задания программа должна автоматически закрыться. Я могу скопировать этот скрипт несколько раз, каждый раз меняя только его название на имя ранее созданного задания в GoodSync. Таким образом, просто щёлкая кнопкой Enter по BAT файлу я могу запускать синхронизацию нужных мне папок индивидуально. <br><br> Для добавления нового задания в FreeFileSync я мог просто скопировать xml файл сценария и вручную поправить его, т.е. запуска графической оболочки программы не требовалось вообще. В GoodSync же все задания прописываются в файле D:\Sync\GoodSync\GoodSync\Profile\jobs.tic и для добавления нового задания нужно будет отрыть программу и создать его, т.к. править этот файл несколько проблематично и неизвестно к чему это может привести. <br> Для синхронизации всех папок теперь можно написать простой скрипт bck_all.bat: <br><br><pre> <code class="bash hljs">@<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> dir=%~dp0 call %dir%bck_Info.bat call %dir%bck_Info2.bat call %dir%bck_Info3.bat call %dir%bck_Info4.bat</code> </pre><br> Каждая строчка скрипта просто вызывает выполнение отдельного скрипта, которое запускает синхронизацию. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is all very good and works comfortably, but there is no error control during synchronization. For example, if the server is not turned on, then all tasks will be promptly completed, and I, returning after an hour, will think that the synchronization has already been completed. At the same time, logs of all tasks are created using the path D: \ Sync \ GoodSync \ GoodSync \ Profile \ *. Log. It is enough just to view the log of each synchronization for the presence of the word “ERROR” - for some reason, this is how the synchronization failures are reported in the log. Therefore, it was decided to write a small program to analyze these logs after all the synchronizations, which will be launched automatically after the synchronization of all folders. The program received the proud name log_analayser and is written in the semi-script language </font></font><a href="https://www.autoitscript.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AutoIt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . If you are interested in someone, then </font></font><a href="https://www.autoitscript.com/site/autoit/downloads/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">download its full version.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can on the official site AutoIt, which contains the necessary libraries, compiler and SciTE - a cross-platform editor for the code from which you can and compile the program. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What time I spent on developing and debugging the code, the result was a file log_analayser.au3 with the following contents:</font></font><br><br><pre> <code class="hljs smalltalk">; <span class="hljs-type"><span class="hljs-type">LOG</span></span> <span class="hljs-type"><span class="hljs-type">Analyser</span></span> <span class="hljs-number"><span class="hljs-number">1.0</span></span> ; Программа предназначена для анализа текстовых лог-файлов <span class="hljs-symbol"><span class="hljs-symbol">#Region</span></span> ;**** <span class="hljs-type"><span class="hljs-type">Directives</span></span> created by <span class="hljs-type"><span class="hljs-type">AutoIt3Wrapper_GUI</span></span> **** <span class="hljs-symbol"><span class="hljs-symbol">#AutoIt3Wrapper_Res_Field</span></span>=<span class="hljs-type"><span class="hljs-type">ProductName</span></span>|<span class="hljs-type"><span class="hljs-type">LOG</span></span> <span class="hljs-type"><span class="hljs-type">Analyser</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#AutoIt3Wrapper_Res_Fileversion</span></span>=<span class="hljs-number"><span class="hljs-number">1.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#AutoIt3Wrapper_Res_Field</span></span>=<span class="hljs-type"><span class="hljs-type">OriginalFilename</span></span>|log_analyser.exe <span class="hljs-symbol"><span class="hljs-symbol">#AutoIt3Wrapper_Res_Comment</span></span>=Программа предназначена для анализа текстовых лог-файлов <span class="hljs-symbol"><span class="hljs-symbol">#AutoIt3Wrapper_Res_Description</span></span>=Анализ лог-файлов ;**** <span class="hljs-symbol"><span class="hljs-symbol">#AutoIt3Wrapper_Res_Language</span></span>=<span class="hljs-number"><span class="hljs-number">1049</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#AutoIt3Wrapper_Res_ProductVersion</span></span>=<span class="hljs-number"><span class="hljs-number">1.0</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#AutoIt3Wrapper_Compile_Both</span></span>=y <span class="hljs-symbol"><span class="hljs-symbol">#EndRegion</span></span> ;**** <span class="hljs-type"><span class="hljs-type">Directives</span></span> created by <span class="hljs-type"><span class="hljs-type">AutoIt3Wrapper_GUI</span></span> **** ;<span class="hljs-type"><span class="hljs-type">AutoItSetOption</span></span> (<span class="hljs-comment"><span class="hljs-comment">"WinTitleMatchMode"</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) ; сопоставление заголовка окна с произвольным фрагментом ;<span class="hljs-symbol"><span class="hljs-symbol">#NoTrayIcon</span></span> ; скрыть иконку из трея во время выполнения программы <span class="hljs-type"><span class="hljs-type">If</span></span> <span class="hljs-type"><span class="hljs-type">WinExists</span></span>(<span class="hljs-string"><span class="hljs-string">'[CLASS:AutoIt v3;TITLE:'</span></span> &amp; @<span class="hljs-type"><span class="hljs-type">ScriptName</span></span> &amp; <span class="hljs-string"><span class="hljs-string">']'</span></span>) <span class="hljs-type"><span class="hljs-type">Then</span></span> <span class="hljs-type"><span class="hljs-type">MsgBox</span></span>(<span class="hljs-number"><span class="hljs-number">48</span></span>, @<span class="hljs-type"><span class="hljs-type">ScriptName</span></span>, <span class="hljs-comment"><span class="hljs-comment">"Позволено запускать только одну копию программы!"</span></span>); ;Раскоментируйте следующую строчку если нужно активировать окно вашей программы при повторном её запуске ;<span class="hljs-type"><span class="hljs-type">WinActivate</span></span>(<span class="hljs-string"><span class="hljs-string">'Имя вашей программы'</span></span>) <span class="hljs-type"><span class="hljs-type">Exit</span></span> <span class="hljs-type"><span class="hljs-type">EndIf</span></span> <span class="hljs-type"><span class="hljs-type">AutoItWinSetTitle</span></span>(@<span class="hljs-type"><span class="hljs-type">ScriptName</span></span>) <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> &lt;<span class="hljs-type"><span class="hljs-type">Array</span></span>.au3&gt; <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> &lt;_FileDirList.au3&gt; ; настройки <span class="hljs-type"><span class="hljs-type">Local</span></span> <span class="hljs-string"><span class="hljs-string">$m</span></span>sg_title = <span class="hljs-comment"><span class="hljs-comment">"LOG Analyser 1.0"</span></span> <span class="hljs-type"><span class="hljs-type">Local</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>ath = @<span class="hljs-type"><span class="hljs-type">ScriptDir</span></span> <span class="hljs-type"><span class="hljs-type">Local</span></span> <span class="hljs-string"><span class="hljs-string">$s</span></span>oft_open_log = <span class="hljs-comment"><span class="hljs-comment">"notepad.exe"</span></span> <span class="hljs-type"><span class="hljs-type">Local</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>ath, <span class="hljs-string"><span class="hljs-string">$d</span></span>ir_mode, <span class="hljs-string"><span class="hljs-string">$w</span></span>ord, <span class="hljs-string"><span class="hljs-string">$f</span></span>ile_analyse_name, <span class="hljs-string"><span class="hljs-string">$f</span></span>ile_analyse_ext, <span class="hljs-string"><span class="hljs-string">$l</span></span>og_path, <span class="hljs-string"><span class="hljs-string">$l</span></span>og_msg_on <span class="hljs-type"><span class="hljs-type">Local</span></span> <span class="hljs-string"><span class="hljs-string">$f</span></span>ile_log, <span class="hljs-string"><span class="hljs-string">$w</span></span>ord_detect, <span class="hljs-string"><span class="hljs-string">$f</span></span>ile_analyse, <span class="hljs-string"><span class="hljs-string">$c</span></span>nt_files, <span class="hljs-string"><span class="hljs-string">$i</span></span> ;проверка и загрузка параметров if (<span class="hljs-string"><span class="hljs-string">$C</span></span>mdLine[<span class="hljs-number"><span class="hljs-number">0</span></span>] &lt; <span class="hljs-number"><span class="hljs-number">6</span></span>) then <span class="hljs-type"><span class="hljs-type">MsgBox</span></span>(<span class="hljs-number"><span class="hljs-number">0x10</span></span>, <span class="hljs-string"><span class="hljs-string">$m</span></span>sg_title, <span class="hljs-comment"><span class="hljs-comment">"Отсутствуют или недостаточно параметров!"</span></span> &amp; @<span class="hljs-type"><span class="hljs-type">CRLF</span></span> &amp; @<span class="hljs-type"><span class="hljs-type">CRLF</span></span> &amp; <span class="hljs-comment"><span class="hljs-comment">"Работа программы прекращена"</span></span>) <span class="hljs-type"><span class="hljs-type">Exit</span></span> else if (<span class="hljs-type"><span class="hljs-type">StringCompare</span></span>(<span class="hljs-string"><span class="hljs-string">$C</span></span>mdLine[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-comment"><span class="hljs-comment">"file"</span></span>) = <span class="hljs-number"><span class="hljs-number">0</span></span>) then <span class="hljs-string"><span class="hljs-string">$d</span></span>ir_mode = <span class="hljs-number"><span class="hljs-number">0</span></span> elseif (<span class="hljs-type"><span class="hljs-type">StringCompare</span></span>(<span class="hljs-string"><span class="hljs-string">$C</span></span>mdLine[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-comment"><span class="hljs-comment">"dir"</span></span>) = <span class="hljs-number"><span class="hljs-number">0</span></span>) then <span class="hljs-string"><span class="hljs-string">$d</span></span>ir_mode = <span class="hljs-number"><span class="hljs-number">1</span></span> else <span class="hljs-type"><span class="hljs-type">MsgBox</span></span>(<span class="hljs-number"><span class="hljs-number">0x10</span></span>, <span class="hljs-string"><span class="hljs-string">$m</span></span>sg_title, <span class="hljs-comment"><span class="hljs-comment">"Первый параметр должен принимать значения 'file' или 'dir'!"</span></span> &amp; @<span class="hljs-type"><span class="hljs-type">CRLF</span></span> &amp; @<span class="hljs-type"><span class="hljs-type">CRLF</span></span> &amp; <span class="hljs-comment"><span class="hljs-comment">"Работа программы прекращена"</span></span>) <span class="hljs-type"><span class="hljs-type">Exit</span></span> endif <span class="hljs-string"><span class="hljs-string">$w</span></span>ord = <span class="hljs-string"><span class="hljs-string">$C</span></span>mdLine[<span class="hljs-number"><span class="hljs-number">2</span></span>] if (<span class="hljs-string"><span class="hljs-string">$d</span></span>ir_mode = <span class="hljs-number"><span class="hljs-number">0</span></span>) then <span class="hljs-string"><span class="hljs-string">$f</span></span>ile_analyse_name = <span class="hljs-string"><span class="hljs-string">$C</span></span>mdLine[<span class="hljs-number"><span class="hljs-number">3</span></span>] else <span class="hljs-string"><span class="hljs-string">$d</span></span>ir_analyse = <span class="hljs-string"><span class="hljs-string">$C</span></span>mdLine[<span class="hljs-number"><span class="hljs-number">3</span></span>] endif <span class="hljs-string"><span class="hljs-string">$f</span></span>ile_analyse_ext = <span class="hljs-string"><span class="hljs-string">$C</span></span>mdLine[<span class="hljs-number"><span class="hljs-number">4</span></span>] <span class="hljs-string"><span class="hljs-string">$l</span></span>og_path = <span class="hljs-string"><span class="hljs-string">$C</span></span>mdLine[<span class="hljs-number"><span class="hljs-number">5</span></span>] if (<span class="hljs-type"><span class="hljs-type">StringCompare</span></span>(<span class="hljs-string"><span class="hljs-string">$C</span></span>mdLine[<span class="hljs-number"><span class="hljs-number">6</span></span>], <span class="hljs-comment"><span class="hljs-comment">"err_msg_on"</span></span>) = <span class="hljs-number"><span class="hljs-number">0</span></span>) then <span class="hljs-string"><span class="hljs-string">$l</span></span>og_msg_on = <span class="hljs-number"><span class="hljs-number">1</span></span> elseif (<span class="hljs-type"><span class="hljs-type">StringCompare</span></span>(<span class="hljs-string"><span class="hljs-string">$C</span></span>mdLine[<span class="hljs-number"><span class="hljs-number">6</span></span>], <span class="hljs-comment"><span class="hljs-comment">"err_msg_off"</span></span>) = <span class="hljs-number"><span class="hljs-number">0</span></span>) then <span class="hljs-string"><span class="hljs-string">$l</span></span>og_msg_on = <span class="hljs-number"><span class="hljs-number">0</span></span> else <span class="hljs-type"><span class="hljs-type">MsgBox</span></span>(<span class="hljs-number"><span class="hljs-number">0x10</span></span>, <span class="hljs-string"><span class="hljs-string">$m</span></span>sg_title, <span class="hljs-comment"><span class="hljs-comment">"Шестой параметр должен принимать значения 'log_msg_on' или 'log_msg_off'!"</span></span> &amp; @<span class="hljs-type"><span class="hljs-type">CRLF</span></span> &amp; @<span class="hljs-type"><span class="hljs-type">CRLF</span></span> &amp; <span class="hljs-comment"><span class="hljs-comment">"Работа программы прекращена"</span></span>) <span class="hljs-type"><span class="hljs-type">Exit</span></span> endif endIf ; инициализация переменных <span class="hljs-string"><span class="hljs-string">$f</span></span>ile_log = <span class="hljs-string"><span class="hljs-string">$l</span></span>og_path &amp; <span class="hljs-comment"><span class="hljs-comment">"\"</span></span> &amp; <span class="hljs-comment"><span class="hljs-comment">"log_analyser"</span></span> &amp; <span class="hljs-comment"><span class="hljs-comment">"-"</span></span> &amp; @<span class="hljs-type"><span class="hljs-type">YEAR</span></span> &amp; <span class="hljs-comment"><span class="hljs-comment">"-"</span></span> &amp; @<span class="hljs-type"><span class="hljs-type">MON</span></span> &amp; <span class="hljs-comment"><span class="hljs-comment">"-"</span></span> &amp; @<span class="hljs-type"><span class="hljs-type">MDAY</span></span> &amp; <span class="hljs-comment"><span class="hljs-comment">"-"</span></span> &amp; @<span class="hljs-type"><span class="hljs-type">HOUR</span></span> &amp; <span class="hljs-comment"><span class="hljs-comment">"-"</span></span> &amp; @<span class="hljs-type"><span class="hljs-type">MIN</span></span> &amp; <span class="hljs-comment"><span class="hljs-comment">"-"</span></span> &amp; @<span class="hljs-type"><span class="hljs-type">SEC</span></span> &amp; <span class="hljs-comment"><span class="hljs-comment">".log"</span></span> <span class="hljs-string"><span class="hljs-string">$w</span></span>ord_detect = <span class="hljs-number"><span class="hljs-number">0</span></span> ; основной код программы if (<span class="hljs-string"><span class="hljs-string">$d</span></span>ir_mode = <span class="hljs-number"><span class="hljs-number">0</span></span>) then <span class="hljs-string"><span class="hljs-string">$f</span></span>ile_analyse = <span class="hljs-string"><span class="hljs-string">$f</span></span>ile_analyse_name &amp; <span class="hljs-comment"><span class="hljs-comment">"."</span></span> &amp; <span class="hljs-string"><span class="hljs-string">$f</span></span>ile_analyse_ext if (_file_analyser(<span class="hljs-string"><span class="hljs-string">$f</span></span>ile_analyse, <span class="hljs-string"><span class="hljs-string">$m</span></span>sg_title, <span class="hljs-string"><span class="hljs-string">$w</span></span>ord, <span class="hljs-string"><span class="hljs-string">$f</span></span>ile_log, <span class="hljs-string"><span class="hljs-string">$w</span></span>ord_detect) = <span class="hljs-number"><span class="hljs-number">1</span></span>) then <span class="hljs-string"><span class="hljs-string">$w</span></span>ord_detect = <span class="hljs-number"><span class="hljs-number">1</span></span> endif else ; сканирование файлов для анализа <span class="hljs-string"><span class="hljs-string">$d</span></span>ir_arr = _FileDirList(<span class="hljs-string"><span class="hljs-string">$d</span></span>ir_analyse, <span class="hljs-comment"><span class="hljs-comment">"*."</span></span>&amp;<span class="hljs-string"><span class="hljs-string">$f</span></span>ile_analyse_ext, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) ;_ArrayDisplay(<span class="hljs-string"><span class="hljs-string">$d</span></span>ir_arr) ; проверка после сканирования - проверка на наличие файлов для анализа if (<span class="hljs-string"><span class="hljs-string">$d</span></span>ir_arr = <span class="hljs-number"><span class="hljs-number">0</span></span>) then <span class="hljs-type"><span class="hljs-type">MsgBox</span></span>(<span class="hljs-number"><span class="hljs-number">0x10</span></span>, <span class="hljs-string"><span class="hljs-string">$m</span></span>sg_title, <span class="hljs-comment"><span class="hljs-comment">"Неверный путь или не обнаружены файлы для анализа!"</span></span> &amp; @<span class="hljs-type"><span class="hljs-type">CRLF</span></span> &amp; @<span class="hljs-type"><span class="hljs-type">CRLF</span></span> &amp; <span class="hljs-comment"><span class="hljs-comment">"Работа программы прекращена"</span></span>) <span class="hljs-type"><span class="hljs-type">Exit</span></span> endif <span class="hljs-string"><span class="hljs-string">$c</span></span>nt_files = <span class="hljs-string"><span class="hljs-string">$d</span></span>ir_arr[<span class="hljs-number"><span class="hljs-number">0</span></span>] ; перебор анализируемых файлов <span class="hljs-string"><span class="hljs-string">$i</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-type"><span class="hljs-type">While</span></span> <span class="hljs-string"><span class="hljs-string">$i</span></span> &lt;&gt; <span class="hljs-string"><span class="hljs-string">$c</span></span>nt_files <span class="hljs-string"><span class="hljs-string">$i</span></span> = <span class="hljs-string"><span class="hljs-string">$i</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-string"><span class="hljs-string">$f</span></span>ile_analyse = <span class="hljs-string"><span class="hljs-string">$d</span></span>ir_arr[<span class="hljs-string"><span class="hljs-string">$i</span></span>] if (_file_analyser(<span class="hljs-string"><span class="hljs-string">$f</span></span>ile_analyse, <span class="hljs-string"><span class="hljs-string">$m</span></span>sg_title, <span class="hljs-string"><span class="hljs-string">$w</span></span>ord, <span class="hljs-string"><span class="hljs-string">$f</span></span>ile_log, <span class="hljs-string"><span class="hljs-string">$w</span></span>ord_detect) = <span class="hljs-number"><span class="hljs-number">1</span></span>) then <span class="hljs-string"><span class="hljs-string">$w</span></span>ord_detect = <span class="hljs-number"><span class="hljs-number">1</span></span> endif <span class="hljs-type"><span class="hljs-type">WEnd</span></span> endif ; обработка результатов анализа if (<span class="hljs-string"><span class="hljs-string">$w</span></span>ord_detect = <span class="hljs-number"><span class="hljs-number">1</span></span>) and (<span class="hljs-string"><span class="hljs-string">$l</span></span>og_msg_on = <span class="hljs-number"><span class="hljs-number">1</span></span>) then if (<span class="hljs-type"><span class="hljs-type">MsgBox</span></span> (<span class="hljs-number"><span class="hljs-number">0x41034</span></span>, <span class="hljs-string"><span class="hljs-string">$m</span></span>sg_title, <span class="hljs-comment"><span class="hljs-comment">"Обнаружены ошибки!"</span></span> &amp; @<span class="hljs-type"><span class="hljs-type">CRLF</span></span> &amp; <span class="hljs-comment"><span class="hljs-comment">"Все строки с ошибками записаны в файл: "</span></span> &amp; <span class="hljs-string"><span class="hljs-string">$f</span></span>ile_log &amp; @<span class="hljs-type"><span class="hljs-type">CRLF</span></span> &amp; @<span class="hljs-type"><span class="hljs-type">CRLF</span></span> &amp; <span class="hljs-comment"><span class="hljs-comment">"Открыть файл с ошибками?"</span></span>)) = <span class="hljs-number"><span class="hljs-number">6</span></span> then <span class="hljs-type"><span class="hljs-type">ShellExecuteWait</span></span>(<span class="hljs-string"><span class="hljs-string">$s</span></span>oft_open_log, <span class="hljs-string"><span class="hljs-string">$f</span></span>ile_log) endif endif <span class="hljs-type"><span class="hljs-type">Exit</span></span> ; функция выполняет построчный поиск слова в файле и возвращает переменную информирующую о наличии слова хотя бы в одной строке ; все обнаруженные строки, содержащие указанное слово, пишутся в файл лога <span class="hljs-type"><span class="hljs-type">Func</span></span> _file_analyser(<span class="hljs-string"><span class="hljs-string">$f</span></span>ile_analyse, <span class="hljs-string"><span class="hljs-string">$m</span></span>sg_title, <span class="hljs-string"><span class="hljs-string">$w</span></span>ord, <span class="hljs-string"><span class="hljs-string">$f</span></span>ile_log, <span class="hljs-string"><span class="hljs-string">$w</span></span>ord_detect) <span class="hljs-type"><span class="hljs-type">Local</span></span> <span class="hljs-string"><span class="hljs-string">$f</span></span>ile1, <span class="hljs-string"><span class="hljs-string">$f</span></span>ile2, <span class="hljs-string"><span class="hljs-string">$f</span></span>ile_line, <span class="hljs-string"><span class="hljs-string">$w</span></span>rite_once <span class="hljs-string"><span class="hljs-string">$w</span></span>ord_detect = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-string"><span class="hljs-string">$w</span></span>rite_once = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-string"><span class="hljs-string">$f</span></span>ile1 = <span class="hljs-type"><span class="hljs-type">FileOpen</span></span>(<span class="hljs-string"><span class="hljs-string">$f</span></span>ile_analyse, <span class="hljs-number"><span class="hljs-number">0</span></span>) ; проверка наличия анализируемого файла <span class="hljs-type"><span class="hljs-type">If</span></span> <span class="hljs-string"><span class="hljs-string">$f</span></span>ile1 = <span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-type"><span class="hljs-type">Then</span></span> <span class="hljs-type"><span class="hljs-type">FileClose</span></span>(<span class="hljs-string"><span class="hljs-string">$f</span></span>ile1) <span class="hljs-type"><span class="hljs-type">MsgBox</span></span>(<span class="hljs-number"><span class="hljs-number">0x10</span></span>, <span class="hljs-string"><span class="hljs-string">$m</span></span>sg_title, <span class="hljs-comment"><span class="hljs-comment">"Отсутствует файл для анализа!"</span></span> &amp; @<span class="hljs-type"><span class="hljs-type">CRLF</span></span> &amp; @<span class="hljs-type"><span class="hljs-type">CRLF</span></span> &amp; <span class="hljs-comment"><span class="hljs-comment">"Работа программы прекращена"</span></span>) <span class="hljs-type"><span class="hljs-type">Exit</span></span> <span class="hljs-type"><span class="hljs-type">EndIf</span></span> ; построчный поиск слова в анализируемом файле <span class="hljs-type"><span class="hljs-type">While</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-string"><span class="hljs-string">$f</span></span>ile_line = <span class="hljs-type"><span class="hljs-type">FileReadLine</span></span>(<span class="hljs-string"><span class="hljs-string">$f</span></span>ile1) <span class="hljs-type"><span class="hljs-type">If</span></span> @error = <span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-type"><span class="hljs-type">Then</span></span> <span class="hljs-type"><span class="hljs-type">ExitLoop</span></span> if (<span class="hljs-type"><span class="hljs-type">StringInStr</span></span>(<span class="hljs-string"><span class="hljs-string">$f</span></span>ile_line, <span class="hljs-string"><span class="hljs-string">$w</span></span>ord) &lt;&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) then <span class="hljs-string"><span class="hljs-string">$w</span></span>ord_detect = <span class="hljs-number"><span class="hljs-number">1</span></span> ; проверка наличия файла для лога и его создание в случае отсутствия if (<span class="hljs-type"><span class="hljs-type">FileExists</span></span>(<span class="hljs-string"><span class="hljs-string">$f</span></span>ile_log) = <span class="hljs-number"><span class="hljs-number">0</span></span>) then <span class="hljs-string"><span class="hljs-string">$f</span></span>ile2 = <span class="hljs-type"><span class="hljs-type">FileOpen</span></span>(<span class="hljs-string"><span class="hljs-string">$f</span></span>ile_log, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-type"><span class="hljs-type">FileClose</span></span>(<span class="hljs-string"><span class="hljs-string">$f</span></span>ile2) endif ; однакоратная запись в файл имени анализируемого файла if (<span class="hljs-string"><span class="hljs-string">$w</span></span>rite_once = <span class="hljs-number"><span class="hljs-number">0</span></span>) then <span class="hljs-string"><span class="hljs-string">$w</span></span>rite_once = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-string"><span class="hljs-string">$f</span></span>ile2 = <span class="hljs-type"><span class="hljs-type">FileOpen</span></span>(<span class="hljs-string"><span class="hljs-string">$f</span></span>ile_log, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-type"><span class="hljs-type">FileWriteLine</span></span>(<span class="hljs-string"><span class="hljs-string">$f</span></span>ile2, <span class="hljs-comment"><span class="hljs-comment">"Анализ файла: "</span></span> &amp; <span class="hljs-string"><span class="hljs-string">$f</span></span>ile_analyse) <span class="hljs-type"><span class="hljs-type">FileClose</span></span>(<span class="hljs-string"><span class="hljs-string">$f</span></span>ile2) endif ; вывод в лог строки с ошибкой <span class="hljs-string"><span class="hljs-string">$f</span></span>ile2 = <span class="hljs-type"><span class="hljs-type">FileOpen</span></span>(<span class="hljs-string"><span class="hljs-string">$f</span></span>ile_log, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-type"><span class="hljs-type">FileWriteLine</span></span>(<span class="hljs-string"><span class="hljs-string">$f</span></span>ile2, <span class="hljs-string"><span class="hljs-string">$f</span></span>ile_line) <span class="hljs-type"><span class="hljs-type">FileClose</span></span>(<span class="hljs-string"><span class="hljs-string">$f</span></span>ile2) endif <span class="hljs-type"><span class="hljs-type">WEnd</span></span> ; если были записи в файл, то отделяем их пустой строкой от следующего массива записей if (<span class="hljs-string"><span class="hljs-string">$w</span></span>ord_detect = <span class="hljs-number"><span class="hljs-number">1</span></span>) then <span class="hljs-string"><span class="hljs-string">$f</span></span>ile2 = <span class="hljs-type"><span class="hljs-type">FileOpen</span></span>(<span class="hljs-string"><span class="hljs-string">$f</span></span>ile_log, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-type"><span class="hljs-type">FileWriteLine</span></span>(<span class="hljs-string"><span class="hljs-string">$f</span></span>ile2, @<span class="hljs-type"><span class="hljs-type">CRLF</span></span>) <span class="hljs-type"><span class="hljs-type">FileClose</span></span>(<span class="hljs-string"><span class="hljs-string">$f</span></span>ile2) endif <span class="hljs-type"><span class="hljs-type">FileClose</span></span>(<span class="hljs-string"><span class="hljs-string">$f</span></span>ile1) <span class="hljs-type"><span class="hljs-type">Return</span></span> <span class="hljs-string"><span class="hljs-string">$w</span></span>ord_detect <span class="hljs-type"><span class="hljs-type">EndFunc</span></span></code> </pre><br> После набора кода нажимаем кнопку F7 в редакторе SciTE и получаем на выходе файл log_analayser.exe. <br><br> Программа анализирует файл на наличие какого-либо слова, при нахождении создаётся файл лога, в который копируется найденная строка, содержащая это слово. <br><br> Программа может работать в двух режимах: <br><br> — анализ конкретного файла <br> — анализ папки, содержащей файлы для анализа (анализируются так же все вложенные подпапки) <br><br> При консольном вызове необходимо задать шесть параметров для программы: <br><br> 1 — режим работы [file = анализ файла; dir = анализ папки, содержащей файлы] <br> 2 — ключевое слово для поиска <br> 3 — имя файла или полного пути к папке <br> 4 — расширения файла или файлов для анализа в папке <br> 5 — полный путь к папке, где будет расположен лог программы <br> 6 — отображение окна после анализа всех файлов в случае нахождения заданного слова [err_msg_on = отображать; err_msg_off = не отображать] <br><br> Таким образом, получился новый скрипт bck_auto.bat: <br><br><pre> <code class="bash hljs">@<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> Start Backup @<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> dir=%~dp0 call %dir%bck_all.bat log_analyser.exe dir ОШИБКА %dir%GoodSync\Profile <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> %dir%LOG err_msg_on <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span></code> </pre><br> Скрипт запускает файл, из которого индивидуально друг за другом вызываются задания на синхронизацию всех нужных папок, а затем вызывается анализатор логов синхронизаций, по завершении работы которого в случае ошибок показывается сообщение с предложением просмотреть строки логов, где обнаружены эти ошибки и можно понять с каким заданием случились проблемы. Эти строки пишутся в отдельный лог-файл в папке D:\Sync\LOG. <br> И тут меня постигла жуткая неудача. Анализатор логов не работал. Нет, он прекрасно работал на тестовых файлах, но упорно не хотел видеть ошибки в логах. Я долго не мог понять в чём причина, пока не выяснил одну жуткую вещь: мало того, что в англоязычном логе сбой выводится единственным русскоязычным словом «ОШИБКА», так ещё и кодировка этой кириллицы – Macintosh! Зачем так сделали программисты из Siber Systems я не знаю, всего скорее это результат какого-то ужасного костыля внутри софта. Ну а кто сказал, что программирование должно быть скучным? <br><br> Ничего не оставалось как подпереть один костыль другим и в результате появилась работающая конструкция: <br><br><pre> <code class="bash hljs">@<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> Start Backup @<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> dir=%~dp0 call %dir%bck_all.bat log_analyser.exe dir Ћ˜€ЃЉЂ %dir%GoodSync\Profile <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> %dir%LOG err_msg_on <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span></code> </pre><br> Однако появилась следующая проблема: сам GoodSync не удаляет файлы логов, с каждым новым выполнением задания появлялись новые файлы. И если какая-то синхронизация завершилась с ошибкой, то наш анализатор всегда будет находить этот файл и бодро рапортовать об ошибке. Поэтому перед запуском синхронизаций решено было автоматически очищать папку D:\Sync от любых файлов с логами. Для этого создан элегантный скрипт clean_logs.bat: <br><br><pre> <code class="bash hljs">@<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> off <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> dir=%~dp0 For /R %dir% %%i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (*.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>) Do ( Del /q <span class="hljs-string"><span class="hljs-string">"%%i"</span></span>) @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> on</code> </pre><br> Скрипт отключает вывод каких-либо сообщений, выясняет директорию запуска скрипта, сканирует все файлы (в том числе в подпапках) пока они не закончатся и удаляет все файлы с расширением log. По окончании работы вывод сообщений включается. <br> Скрипт bck_auto.bat преобразился: <br><br><pre> <code class="bash hljs">@<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> Start Backup @<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> dir=%~dp0 @call clean_logs.bat call %dir%bck_all.bat log_analyser.exe dir Ћ˜€ЃЉЂ %dir%GoodSync\Profile <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> %dir%LOG err_msg_on <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Everything works very well, but the point is in automating routine actions. </font><font style="vertical-align: inherit;">Why not just turn off the computer at night and go to sleep, but he synchronizes the path of a bunch of files, analyzes and turns off? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's refine our bck_auto.bat script:</font></font><br><br><pre> <code class="bash hljs">@<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> Start Backup &amp; PCOFF @<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> dir=%~dp0 start MonitorOnOff.exe 0 @call clean_logs.bat call %dir%bck_all.bat log_analyser.exe dir Ћ˜€ЃЉЂ %dir%GoodSync\Profile <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> %dir%LOG err_msg_off shutdown /s /t 0 <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The script has two new lines. </font><font style="vertical-align: inherit;">The MonitorOnOff application simply turns off the monitor (so that it does not light up the room, but I manually turn it off every evening and turn on every morning is very lazy), and the shutdown command turns off the computer. </font><font style="vertical-align: inherit;">In log_analyser, the parameter responsible for displaying messages when an error has been changed - after all, after synchronization, you do not need to slow down the execution of the script with this message, but allow it to turn off the computer. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The MonitorOnOff program is also written in AutoIt.</font></font><br><br><pre> <code class="hljs smalltalk">; <span class="hljs-type"><span class="hljs-type">Monitor</span></span> <span class="hljs-type"><span class="hljs-type">On</span></span> <span class="hljs-type"><span class="hljs-type">Off</span></span> <span class="hljs-number"><span class="hljs-number">1.0</span></span> ; Программа для включения/отключения монитора <span class="hljs-symbol"><span class="hljs-symbol">#Region</span></span> ;**** <span class="hljs-type"><span class="hljs-type">Directives</span></span> created by <span class="hljs-type"><span class="hljs-type">AutoIt3Wrapper_GUI</span></span> **** <span class="hljs-symbol"><span class="hljs-symbol">#AutoIt3Wrapper_Res_Field</span></span>=<span class="hljs-type"><span class="hljs-type">ProductName</span></span>|<span class="hljs-type"><span class="hljs-type">Monitor</span></span> <span class="hljs-type"><span class="hljs-type">On</span></span> <span class="hljs-type"><span class="hljs-type">Off</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#AutoIt3Wrapper_Res_Fileversion</span></span>=<span class="hljs-number"><span class="hljs-number">1.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#AutoIt3Wrapper_Res_Field</span></span>=<span class="hljs-type"><span class="hljs-type">OriginalFilename</span></span>|<span class="hljs-type"><span class="hljs-type">MonitorOnOff</span></span>.exe <span class="hljs-symbol"><span class="hljs-symbol">#AutoIt3Wrapper_Res_Comment</span></span>=Программа для включения/отключения монитора <span class="hljs-symbol"><span class="hljs-symbol">#AutoIt3Wrapper_Res_Description</span></span>=Программа для включения/отключения монитора ;**** <span class="hljs-symbol"><span class="hljs-symbol">#AutoIt3Wrapper_Res_Language</span></span>=<span class="hljs-number"><span class="hljs-number">1049</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#AutoIt3Wrapper_Res_ProductVersion</span></span>=<span class="hljs-number"><span class="hljs-number">1.0</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#AutoIt3Wrapper_Compile_Both</span></span>=y <span class="hljs-symbol"><span class="hljs-symbol">#EndRegion</span></span> ;**** <span class="hljs-type"><span class="hljs-type">Directives</span></span> created by <span class="hljs-type"><span class="hljs-type">AutoIt3Wrapper_GUI</span></span> **** ;<span class="hljs-type"><span class="hljs-type">AutoItSetOption</span></span> (<span class="hljs-comment"><span class="hljs-comment">"WinTitleMatchMode"</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) ; сопоставление заголовка окна с произвольным фрагментом ;<span class="hljs-symbol"><span class="hljs-symbol">#NoTrayIcon</span></span> ; скрыть иконку из трея во время выполнения программы <span class="hljs-type"><span class="hljs-type">If</span></span> <span class="hljs-type"><span class="hljs-type">WinExists</span></span>(<span class="hljs-string"><span class="hljs-string">'[CLASS:AutoIt v3;TITLE:'</span></span> &amp; @<span class="hljs-type"><span class="hljs-type">ScriptName</span></span> &amp; <span class="hljs-string"><span class="hljs-string">']'</span></span>) <span class="hljs-type"><span class="hljs-type">Then</span></span> <span class="hljs-type"><span class="hljs-type">MsgBox</span></span>(<span class="hljs-number"><span class="hljs-number">48</span></span>, @<span class="hljs-type"><span class="hljs-type">ScriptName</span></span>, <span class="hljs-comment"><span class="hljs-comment">"Позволено запускать только одну копию программы!"</span></span>); ;Раскоментируйте следующую строчку если нужно активировать окно вашей программы при повторном её запуске ;<span class="hljs-type"><span class="hljs-type">WinActivate</span></span>(<span class="hljs-string"><span class="hljs-string">'Имя вашей программы'</span></span>) <span class="hljs-type"><span class="hljs-type">Exit</span></span> <span class="hljs-type"><span class="hljs-type">EndIf</span></span> <span class="hljs-type"><span class="hljs-type">AutoItWinSetTitle</span></span>(@<span class="hljs-type"><span class="hljs-type">ScriptName</span></span>) <span class="hljs-type"><span class="hljs-type">HotKeySet</span></span>(<span class="hljs-comment"><span class="hljs-comment">"{F10}"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"_Monitor_ON"</span></span>) <span class="hljs-type"><span class="hljs-type">HotKeySet</span></span>(<span class="hljs-comment"><span class="hljs-comment">"{F11}"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"_Monitor_OFF"</span></span>) <span class="hljs-type"><span class="hljs-type">HotKeySet</span></span>(<span class="hljs-comment"><span class="hljs-comment">"{Esc}"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"_Quit"</span></span>) <span class="hljs-type"><span class="hljs-type">Global</span></span> <span class="hljs-type"><span class="hljs-type">Const</span></span> <span class="hljs-string"><span class="hljs-string">$l</span></span>ciWM_SYSCommand = <span class="hljs-number"><span class="hljs-number">274</span></span> <span class="hljs-type"><span class="hljs-type">Global</span></span> <span class="hljs-type"><span class="hljs-type">Const</span></span> <span class="hljs-string"><span class="hljs-string">$l</span></span>ciSC_MonitorPower = <span class="hljs-number"><span class="hljs-number">61808</span></span> <span class="hljs-type"><span class="hljs-type">Global</span></span> <span class="hljs-type"><span class="hljs-type">Const</span></span> <span class="hljs-string"><span class="hljs-string">$l</span></span>ciPower_Off = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-type"><span class="hljs-type">Global</span></span> <span class="hljs-type"><span class="hljs-type">Const</span></span> <span class="hljs-string"><span class="hljs-string">$l</span></span>ciPower_On = <span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-type"><span class="hljs-type">Global</span></span> <span class="hljs-string"><span class="hljs-string">$M</span></span>onitorIsOff = <span class="hljs-type"><span class="hljs-type">False</span></span> if (<span class="hljs-string"><span class="hljs-string">$C</span></span>mdLine[<span class="hljs-number"><span class="hljs-number">0</span></span>] &lt;&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) then _Monitor_OFF() endif <span class="hljs-type"><span class="hljs-type">While</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-type"><span class="hljs-type">Sleep</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-type"><span class="hljs-type">WEnd</span></span> <span class="hljs-type"><span class="hljs-type">Func</span></span> _Monitor_ON() <span class="hljs-string"><span class="hljs-string">$M</span></span>onitorIsOff = <span class="hljs-type"><span class="hljs-type">False</span></span> <span class="hljs-type"><span class="hljs-type">Local</span></span> <span class="hljs-string"><span class="hljs-string">$P</span></span>rogman_hwnd = <span class="hljs-type"><span class="hljs-type">WinGetHandle</span></span>(<span class="hljs-string"><span class="hljs-string">'[CLASS:Progman]'</span></span>) <span class="hljs-type"><span class="hljs-type">DllCall</span></span>(<span class="hljs-string"><span class="hljs-string">'user32.dll'</span></span>, <span class="hljs-string"><span class="hljs-string">'int'</span></span>, <span class="hljs-string"><span class="hljs-string">'SendMessage'</span></span>, _ <span class="hljs-string"><span class="hljs-string">'hwnd'</span></span>, <span class="hljs-string"><span class="hljs-string">$P</span></span>rogman_hwnd, _ <span class="hljs-string"><span class="hljs-string">'int'</span></span>, <span class="hljs-string"><span class="hljs-string">$l</span></span>ciWM_SYSCommand, _ <span class="hljs-string"><span class="hljs-string">'int'</span></span>, <span class="hljs-string"><span class="hljs-string">$l</span></span>ciSC_MonitorPower, _ <span class="hljs-string"><span class="hljs-string">'int'</span></span>, <span class="hljs-string"><span class="hljs-string">$l</span></span>ciPower_On) <span class="hljs-type"><span class="hljs-type">EndFunc</span></span> <span class="hljs-type"><span class="hljs-type">Func</span></span> _Monitor_OFF() <span class="hljs-string"><span class="hljs-string">$M</span></span>onitorIsOff = <span class="hljs-type"><span class="hljs-type">True</span></span> <span class="hljs-type"><span class="hljs-type">Local</span></span> <span class="hljs-string"><span class="hljs-string">$P</span></span>rogman_hwnd = <span class="hljs-type"><span class="hljs-type">WinGetHandle</span></span>(<span class="hljs-string"><span class="hljs-string">'[CLASS:Progman]'</span></span>) <span class="hljs-type"><span class="hljs-type">While</span></span> <span class="hljs-string"><span class="hljs-string">$M</span></span>onitorIsOff = <span class="hljs-type"><span class="hljs-type">True</span></span> <span class="hljs-type"><span class="hljs-type">DllCall</span></span>(<span class="hljs-string"><span class="hljs-string">'user32.dll'</span></span>, <span class="hljs-string"><span class="hljs-string">'int'</span></span>, <span class="hljs-string"><span class="hljs-string">'SendMessage'</span></span>, _ <span class="hljs-string"><span class="hljs-string">'hwnd'</span></span>, <span class="hljs-string"><span class="hljs-string">$P</span></span>rogman_hwnd, _ <span class="hljs-string"><span class="hljs-string">'int'</span></span>, <span class="hljs-string"><span class="hljs-string">$l</span></span>ciWM_SYSCommand, _ <span class="hljs-string"><span class="hljs-string">'int'</span></span>, <span class="hljs-string"><span class="hljs-string">$l</span></span>ciSC_MonitorPower, _ <span class="hljs-string"><span class="hljs-string">'int'</span></span>, <span class="hljs-string"><span class="hljs-string">$l</span></span>ciPower_Off) _IdleWaitCommit(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-type"><span class="hljs-type">Sleep</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-type"><span class="hljs-type">WEnd</span></span> <span class="hljs-type"><span class="hljs-type">EndFunc</span></span> <span class="hljs-type"><span class="hljs-type">Func</span></span> _IdleWaitCommit(<span class="hljs-string"><span class="hljs-string">$i</span></span>dlesec) <span class="hljs-type"><span class="hljs-type">Local</span></span> <span class="hljs-string"><span class="hljs-string">$i</span></span>Save, <span class="hljs-string"><span class="hljs-string">$L</span></span>astInputInfo = <span class="hljs-type"><span class="hljs-type">DllStructCreate</span></span> (<span class="hljs-comment"><span class="hljs-comment">"uint;dword"</span></span>) <span class="hljs-type"><span class="hljs-type">DllStructSetData</span></span> (<span class="hljs-string"><span class="hljs-string">$L</span></span>astInputInfo, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-type"><span class="hljs-type">DllStructGetSize</span></span> (<span class="hljs-string"><span class="hljs-string">$L</span></span>astInputInfo)) <span class="hljs-type"><span class="hljs-type">DllCall</span></span> (<span class="hljs-comment"><span class="hljs-comment">"user32.dll"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"int"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"GetLastInputInfo"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"ptr"</span></span>, <span class="hljs-type"><span class="hljs-type">DllStructGetPtr</span></span> (<span class="hljs-string"><span class="hljs-string">$L</span></span>astInputInfo)) <span class="hljs-type"><span class="hljs-type">Do</span></span> <span class="hljs-string"><span class="hljs-string">$i</span></span>Save = <span class="hljs-type"><span class="hljs-type">DllStructGetData</span></span> (<span class="hljs-string"><span class="hljs-string">$L</span></span>astInputInfo, <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-type"><span class="hljs-type">Sleep</span></span>(<span class="hljs-number"><span class="hljs-number">60</span></span>) <span class="hljs-type"><span class="hljs-type">DllCall</span></span> (<span class="hljs-comment"><span class="hljs-comment">"user32.dll"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"int"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"GetLastInputInfo"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"ptr"</span></span>, <span class="hljs-type"><span class="hljs-type">DllStructGetPtr</span></span> (<span class="hljs-string"><span class="hljs-string">$L</span></span>astInputInfo)) <span class="hljs-type"><span class="hljs-type">Until</span></span> (<span class="hljs-type"><span class="hljs-type">DllStructGetData</span></span> (<span class="hljs-string"><span class="hljs-string">$L</span></span>astInputInfo, <span class="hljs-number"><span class="hljs-number">2</span></span>)-<span class="hljs-string"><span class="hljs-string">$i</span></span>Save) &gt; <span class="hljs-string"><span class="hljs-string">$i</span></span>dlesec <span class="hljs-type"><span class="hljs-type">Or</span></span> <span class="hljs-string"><span class="hljs-string">$M</span></span>onitorIsOff = <span class="hljs-type"><span class="hljs-type">False</span></span> <span class="hljs-type"><span class="hljs-type">Return</span></span> <span class="hljs-type"><span class="hljs-type">DllStructGetData</span></span> (<span class="hljs-string"><span class="hljs-string">$L</span></span>astInputInfo, <span class="hljs-number"><span class="hljs-number">2</span></span>)-<span class="hljs-string"><span class="hljs-string">$i</span></span>Save <span class="hljs-type"><span class="hljs-type">EndFunc</span></span> <span class="hljs-type"><span class="hljs-type">Func</span></span> _Quit() _Monitor_ON() <span class="hljs-type"><span class="hljs-type">Exit</span></span> <span class="hljs-type"><span class="hljs-type">EndFunc</span></span></code> </pre><br> Запущенная программа управляется тремя клавишами: F10 включает монитор, F11 – отключает, а кнопка ESC завершает работу программы и выгружает её из памяти. При задании любого параметра при запуске программы запущенная программа сразу отключит экран. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now everything was fine - before going to sleep, I just ran bck_all.bat, instead of “Turn off computer” and went to sleep. The monitor did not illuminate the entire room, synchronization was performed automatically and its success was automatically analyzed. In the morning, it was necessary only to look at the contents of the folder D: \ Sync \ GoodSync \ LOG \ for at least some files. But this is also not the case - why waste time if everything is fine? It is necessary to make a log analyzer log analyzer and hang it in autoload of the system so that it will work the next day when the computer is booted and disturbed my attention only when synchronization fails. This is how the check_file_exist program appeared.</font></font><br><br><pre> <code class="hljs mel">; Check File Exist <span class="hljs-number"><span class="hljs-number">1.0</span></span> ; Программа предназначена для проверки наличия указанного файла #Region ;**** Directives created by AutoIt3Wrapper_GUI **** #AutoIt3Wrapper_Res_Field=ProductName|Check File Exist #AutoIt3Wrapper_Res_Fileversion=<span class="hljs-number"><span class="hljs-number">1.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> #AutoIt3Wrapper_Res_Field=OriginalFilename|check_file_exist.exe #AutoIt3Wrapper_Res_Comment=Программа предназначена для проверки наличия указанного файла #AutoIt3Wrapper_Res_Description=Провека существования файла ;**** #AutoIt3Wrapper_Res_Language=<span class="hljs-number"><span class="hljs-number">1049</span></span> #AutoIt3Wrapper_Res_ProductVersion=<span class="hljs-number"><span class="hljs-number">1.0</span></span> #AutoIt3Wrapper_Compile_Both=y #EndRegion ;**** Directives created by AutoIt3Wrapper_GUI **** ;AutoItSetOption (<span class="hljs-string"><span class="hljs-string">"WinTitleMatchMode"</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) ; сопоставление заголовка окна с произвольным фрагментом ;#NoTrayIcon ; скрыть иконку из трея во время выполнения программы If WinExists(<span class="hljs-string"><span class="hljs-string">'[CLASS:AutoIt v3;TITLE:'</span></span> &amp; @ScriptName &amp; <span class="hljs-string"><span class="hljs-string">']'</span></span>) Then MsgBox(<span class="hljs-number"><span class="hljs-number">48</span></span>, @ScriptName, <span class="hljs-string"><span class="hljs-string">"Позволено запускать только одну копию программы!"</span></span>); ;Раскоментируйте следующую строчку если нужно активировать окно вашей программы при повторном её запуске ;WinActivate(<span class="hljs-string"><span class="hljs-string">'Имя вашей программы'</span></span>) Exit EndIf AutoItWinSetTitle(@ScriptName) #include &lt;Array.au3&gt; #include &lt;_FileDirList.au3&gt; ; настройки Local $msg_title = <span class="hljs-string"><span class="hljs-string">"Check File Exist 1.0"</span></span> Local $path = @ScriptDir Local $soft_open_dir = <span class="hljs-string"><span class="hljs-string">"explorer.exe"</span></span> Local $path, $dir_analyse, $words, $msg_open ;проверка и загрузка параметров <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($CmdLine[<span class="hljs-number"><span class="hljs-number">0</span></span>] &lt; <span class="hljs-number"><span class="hljs-number">5</span></span>) then MsgBox(<span class="hljs-number"><span class="hljs-number">0x10</span></span>, $msg_title, <span class="hljs-string"><span class="hljs-string">"Отсутствуют или недостаточно параметров!"</span></span> &amp; @CRLF &amp; @CRLF &amp; <span class="hljs-string"><span class="hljs-string">"Работа программы прекращена"</span></span>) Exit <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> $dir_analyse = $CmdLine[<span class="hljs-number"><span class="hljs-number">1</span></span>] $file = $CmdLine[<span class="hljs-number"><span class="hljs-number">2</span></span>] $words0 = $CmdLine[<span class="hljs-number"><span class="hljs-number">3</span></span>] $words1 = $CmdLine[<span class="hljs-number"><span class="hljs-number">4</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (StringCompare($CmdLine[<span class="hljs-number"><span class="hljs-number">5</span></span>], <span class="hljs-string"><span class="hljs-string">"msg_on"</span></span>) = <span class="hljs-number"><span class="hljs-number">0</span></span>) then $msg_open = <span class="hljs-number"><span class="hljs-number">1</span></span> elseif (StringCompare($CmdLine[<span class="hljs-number"><span class="hljs-number">5</span></span>], <span class="hljs-string"><span class="hljs-string">"msg_off"</span></span>) = <span class="hljs-number"><span class="hljs-number">0</span></span>) then $msg_open = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> MsgBox(<span class="hljs-number"><span class="hljs-number">0x10</span></span>, $msg_title, <span class="hljs-string"><span class="hljs-string">"Пятый параметр должен принимать значения 'msg_on' или 'msg_off'!"</span></span> &amp; @CRLF &amp; @CRLF &amp; <span class="hljs-string"><span class="hljs-string">"Работа программы прекращена"</span></span>) Exit endif endIf ; сканирование директории на наличие файлов $dir_arr = _FileDirList($dir_analyse, <span class="hljs-string"><span class="hljs-string">"*"</span></span>&amp;$file&amp;<span class="hljs-string"><span class="hljs-string">"*"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) ;_ArrayDisplay($dir_arr) ; проверка наличия файла и действия <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($dir_arr = <span class="hljs-number"><span class="hljs-number">0</span></span>) then <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (StringCompare($words0, <span class="hljs-string"><span class="hljs-string">"0"</span></span>) &lt;&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) then <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($msg_open = <span class="hljs-number"><span class="hljs-number">0</span></span>) then MsgBox(<span class="hljs-number"><span class="hljs-number">0x41030</span></span>, $msg_title, $words0) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (MsgBox(<span class="hljs-number"><span class="hljs-number">0x41034</span></span>, $msg_title, $words0 &amp; @CRLF &amp; @CRLF &amp; <span class="hljs-string"><span class="hljs-string">"Открыть папку с не обнаруженными файлами?"</span></span>)) = <span class="hljs-number"><span class="hljs-number">6</span></span> then ShellExecuteWait($soft_open_dir, $dir_analyse) endif endif endif <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (StringCompare($words1, <span class="hljs-string"><span class="hljs-string">"0"</span></span>) &lt;&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) then <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($msg_open = <span class="hljs-number"><span class="hljs-number">0</span></span>) then MsgBox(<span class="hljs-number"><span class="hljs-number">0x41030</span></span>, $msg_title, $words1) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (MsgBox(<span class="hljs-number"><span class="hljs-number">0x41034</span></span>, $msg_title, $words1 &amp; @CRLF &amp; @CRLF &amp; <span class="hljs-string"><span class="hljs-string">"Открыть папку с обнаруженными файлами?"</span></span>)) = <span class="hljs-number"><span class="hljs-number">6</span></span> then ShellExecuteWait($soft_open_dir, $dir_analyse) endif endif endif endif Exit</code> </pre><br> По сути эта программа – немного урезанный функционал log_analyser. Программа анализирует указанную папку (без учёта подпапок) на наличие файлов и именами хотя бы частично совпадающими с указанным словом для поиска и выводит сообщение о результате проверки. <br><br> Параметры программы: <br><br> 1 — полный путь к папке (без символа слеша — /) <br> 2 — ключевое слово для поиска в именах файлов, либо полное название файла <br> 3 — текстовая строка, выводимая при ненахождении файл, если =0 — не выводить сообщение <br> 4 — текстовая строка, выводимая при нахождении файла, если =0 — не выводить сообщение <br> 5 — вывод сообщения: msg_off — выводится только сообщение о наличии/отсутствии файлов, msg_on — в выведенном окне предлагается так же открыть папку, в которой обнаружены или необнаружены файлы <br><br> Теперь, для этой программы я создал скрипт Check_LOG_from_log_analyser.bat, ссылку которого разместил в обычной автозагрузке Windows: <br><br><pre> <code class="bash hljs">@<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> dir=%~dp0LOG start check_file_exist.exe %dir% .<span class="hljs-built_in"><span class="hljs-built_in">log</span></span> 0 <span class="hljs-string"><span class="hljs-string">"Во время последней синхронизации были проблемы!"</span></span> msg_on <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span></code> </pre><br> Таким образом, в финале мы получили полностью автономное решение, которое не зависит от местонахождения папки Sync и корректно отработает из любого места нашего компьютера. Решение не только работоспособно, но и стабильно – на Windows 7 х64 данный комплект скриптов отработал год и абсолютно никаких проблем с ним не возникло. <br><br> Возможно сейчас всё это кажется несколько монстрообразным, однако ничего сложно в этом нет. Если внимательно присмотреться к коду AutoIt, то базовой конструкцией является обычные циклы if-then-else-end, однотипные для любого языка программирования, в которые встроены некоторые повторяющиеся операторы и функции AutoIt, которые изучаются буквально за пару вечеров. Скриптовый язык BAT можно даже не учить, так как большинство решений типовые и уже давно описаны в интернете. Уметь пользоваться программированием не только интересно, но может быть и весьма полезно. <br><br><div class="spoiler"> <b class="spoiler_title">Ода коду от Dark Dragon</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/mt/oe/bi/mtoebi7ufvsfmzqjs52tihnxwiy.jpeg"><br></div></div><br><hr><a name="chap11"></a><br><h3>  Afterword </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To be honest, I assumed, but did not expect such a volume of articles for which I had to spend up to fifty hours. As a rule, on the Internet, installing your own cloud is reduced to sayings like: “Yes, there you have to execute several commands”. This is true - the installation is trivial. When you know what commands to enter into the console and what they mean. When you understand the essence of network routing. When you already have a working server and when you understand how to add a host to it. When you know how to install the site. That is, to use these several commands you need to have a certain amount of knowledge and experience. The purpose of these three articles is an attempt to create such baggage, having collected the necessary sufficient information in one place and to explain how to use it correctly. I sincerely hopeThat this series of articles will help someone make their first conscious steps in the world of free software.</font></font><br><br><hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Return </font></font><a href="https://habr.com/ru/post/410011/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to the beginning, to the table of contents</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The history of creating a home cloud. </font><font style="vertical-align: inherit;">Part 3. Creating a personal cloud - installing and configuring Nextcloud. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Text version: 1.2.0. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Date of first publication: 08.02.2018. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Last edited on: February 08, 2018.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Update log</font></font></b> <div class="spoiler_text"> 1.2.0 [08-02-2018] <br> Коррекция текста. <br><br> 1.1.0 [08-02-2018] <br> Коррекция текста. <br><br> 1.0.0 [08-02-2018] <br> Первая версия. <br> Описывается установка и настройка Nextcloud 11.0.2 в виртуальной машине VMWare, конфигурация сетевого окружения VMWare и освещаются некоторые моменты настройки, проявившиеся в процессе эксплуатации Nextcloud. <br></div></div><br><hr><a name="bug"></a><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Information for the administration of the resource (suspicion of a bug)</font></font></b> <div class="spoiler_text"> Если в какой-то тег (например, code или blockquote) <b>в вышеприведённом тексте</b> обернуть следующую конструкцию: <br><blockquote> [Definition] <br> failregex={«reqId»:".*",«remoteAddr»:".*",«app»:«core»,«message»:«Login failed: '.*' \(Remote IP: ''\)»,«level»:2,«time»:".*"} <br> ignoreregex = <br></blockquote><br> То закрывающий тег фильтруется и оформление применяется до конца статьи! Подобный эффект проявляется именно в этом тексте, т.к. отдельно воспроизвести эффект мне не удалось. Парную корректность тегов (открыто/закрыто) проверил — вроде бы всё нормально. Методика повторения: <br> — создать черновик <br> — скопировать исходное форматирование этой статьи и разместить в черновике <br> — в тексте, в разделе «Защита для Nextcloud» обернуть вышеуказанную конструкцию, например, цитатой <br> — эффект проявляется, в цитату попадёт весь текст до конца статьи <br><br></div></div><br><hr></div>