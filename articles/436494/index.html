<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Replacing the disc while maintaining the correct numbering in CEPH</title>
  <meta name="description" content="It is assumed that as a result of this method we save the sequence in which the disks are displayed using the ceph osd tree command. If they are there...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-6974184241884155",
      enable_page_level_ads: true
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>Replacing the disc while maintaining the correct numbering in CEPH</h1><div class="post__text post__text-html js-mediator-article">  It is assumed that as a result of this method we save the sequence in which the disks are displayed using the ceph osd tree command.  If they are there in order, then it is easier to read and is considered, if necessary. <br><br>  Lyrical digression on the topic.  The official method of replacing a disk in ceph involves deleting all the logical entities associated with this disk from the cluster and then re-creating them.  As a result, a newly-created osd (under some circumstances) can change its number (the number in the entity name, which is osd. The number) and location in the crush map and will naturally appear in another dream on the ceph osd tree and others.  Change its sequence number. <br><br>  The idea of ‚Äã‚Äãthis method is that we will not change any logical entities, but simply slip a new disk to the ‚Äúold‚Äù place in the cluster.  To do this, on this new disk you need to (re) create the correct data structures: all sorts of id, symlinks, and keys. <br><a name="habracut"></a><br>  <b>Mark up the new disk.</b> <br><br><pre><code class="plaintext hljs">parted /dev/–¥–∏—Å–∫_—Å_–¥–∞–Ω–Ω—ã–º–∏ mklabel gpt</code> </pre> <br>  <b>Create a new section on our partition.</b> <br><br><pre> <code class="plaintext hljs">parted /dev/sdaa mkpart primary ext2 0% 100% /sbin/sgdisk --change-name=1:'ceph data' -- /dev/sda1</code> </pre> <br>  <b>We get the UUID of the dead osd</b> <br><br><pre> <code class="plaintext hljs">ceph osd dump|grep 'osd.–ù–æ–º–µ—Ä'</code> </pre> <br>  <b>We put PARTUUID on the data disk</b> <br><br><pre> <code class="plaintext hljs">/sbin/sgdisk --typecode=1:99886b14-7904-4396-acef-c031095d4b62 -- /dev/–î–∏—Å–∫_—Å_–¥–∞–Ω–Ω—ã–º–∏</code> </pre> <br>  <b>Find a section with a magazine</b> <br><br><pre> <code class="plaintext hljs">ceph-disk list | grep for | sort</code> </pre> <br>  <b>Create a file system disk</b> <br><br><pre> <code class="plaintext hljs">/sbin/mkfs -t xfs -f -i size=2048 -- /dev/sdaa1</code> </pre> <br>  <b>Mount FS</b> <br><br><pre> <code class="plaintext hljs">mount -o rw,noatime,attr2,inode64,noquota /dev/–ü–∞—Ä—Ç–∏—Ü–∏—è_–Ω–∞_–¥–∏—Å–∫–µ_—Å_–¥–∞–Ω–Ω—ã–º–∏ /var/lib/ceph/osd/ceph-–Ω–æ–º–µ—Ä_OSD</code> </pre> <br>  <b>We copy data from the next OSD</b> <br><br>  <i>In fact, this is the most disgusting part of the procedure, you need to do everything carefully.</i> <br><br>  When copying, you must skip the / var / lib / ceph / osd / ceph-NUMBER / current directory, this is the data directory.  We will create a symlink to journal later. <br><br>  <b>Copying</b> <br><br><pre> <code class="plaintext hljs">for i in activate.monmap active ceph_fsid fsid journal_uuid keyring magic ready store_version superblock systemd type whoami; do cp /var/lib/ceph/osd/ceph-–ù–û–ú–ï–†_–°–û–°–ï–î–ê/${i} /var/lib/ceph/osd/ceph-–ù–û–ú–ï–†; done</code> </pre> <br>  <b>Looking for a magazine</b> <br><br><pre> <code class="plaintext hljs">ceph-disk list | grep for | sort</code> </pre> <br>  accordingly, we find the partition, and do <br><br><pre> <code class="plaintext hljs">ls -l /dev/disk/by-partuuid | grep –ü–∞—Ä—Ç–∏—Ü–∏—è_–ù–æ–º–µ—Ä</code> </pre> <br>  <b>We make a symlink for this UUID</b> <br><br><pre> <code class="plaintext hljs">ln -s /dev/disk/by-partuuid/UUID /var/lib/ceph/osd/ceph-–ù–û–ú–ï–†/journal</code> </pre> <br>  <b>We fill fsid with the correct value</b> <br><br>  This fsid is actually a unique id, under which the osd scale is listed in the cluster, it is important because  if you do not guess with id, then the osd-scale itself will not see the cluster and it will be mutual. <br><br>  And the value must be taken from the partuuid partition on the log with the data. <br><br><pre> <code class="plaintext hljs">echo -n UUID &gt;/var/lib/ceph/osd/ceph-–ù–û–ú–ï–†/fsid</code> </pre><br>  <b>Fill in the keyring</b> <br><br>  With this, the osd scale is authorized in the cluster. <br><br><pre> <code class="plaintext hljs">ceph auth list|grep --after-context=1 'osd.–ù–û–ú–ï–†'</code> </pre> <br>  It is recorded in a file in the format <br><br><pre> <code class="plaintext hljs">[osd.–ù–û–ú–ï–†] key = –°–¢–†–û–ö–ê_–°_–ö–õ–Æ–ß–û–ú</code> </pre> <br>  <b>Fill whoami</b> <br><br>  Just write in this file the number of OSD-shki, which we want to revive. <br><br>  <b>We hammer in magazine</b> <br><br><pre> <code class="plaintext hljs">dd bs=32M oflag=direct if=/dev/zero of=/var/lib/ceph/osd/ceph-–ù–û–ú–ï–†/journal</code> </pre><br>  <b>Create log metadata and osd-shki</b> <br><br><pre> <code class="plaintext hljs">ceph-osd --mkfs -i –ù–æ–º–µ—Ä_OSD ceph-osd --mkjournal -i –ù–æ–º–µ—Ä_OSD</code> </pre> <br>  <b>Change data owner</b> <br><br><pre> <code class="plaintext hljs">chown -R ceph:ceph /var/lib/ceph/osd/ceph-–ù–û–ú–ï–†</code> </pre> <br>  <b>We start ceph-osd</b> <br><br>  Attention: Immediately after the launch of ceph-osd, rebuild will start if, until the moment when the disk exited the cliter, the ceph osd out NUMBER command was given. <br><br><pre> <code class="plaintext hljs">systemctl start ceph-osd.–ù–û–ú–ï–†</code> </pre> </div><p>Source: <a href="https://habr.com/ru/post/436494/">https://habr.com/ru/post/436494/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>