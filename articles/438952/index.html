<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>What can you learn when developing an audio player for different browsers?</title>
  <meta name="description" content="This story began about 1.5 years ago. It is associated with playing music in various browsers and the platforms on which they run. The path is full of...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-6974184241884155",
      enable_page_level_ads: true
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>What can you learn when developing an audio player for different browsers?</h1><div class="post__text post__text-html js-mediator-article">  This story began about 1.5 years ago.  It is associated with playing music in various browsers and the platforms on which they run.  The path is full of <s>‚Äúpain and suffering‚Äù the</s> realization that the seemingly easy task may not be so easy, and the ‚Äúminor‚Äù details that you don‚Äôt attach importance to at the very beginning can affect everything. <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Minor details for the most curious :)</b> <div class="spoiler_text">  1. Uploading data about each next track from the network. <br>  2. For each element of audio: new Audio () or &lt;audio&gt; you need user permission - a custom action on the page. <br></div></div><br><h3>  Prehistory </h3><br>  Probably, anyone who has ever written an audio player for browsers in his life has encountered the problem of cross-browser and cross-platform. <br><br>  Here I am, while working on a new MVP, I encountered various features with regard to audio playback in browsers. <br><br>  It all started with the fact that it was necessary to make a smooth mixing (crossfade) of two tracks during playback - this is the first feature.  Our team wanted to make a change of tracks on the radio.  And the second feature - each subsequent track is requested from the network. <br><br><img src="https://habrastorage.org/webt/7h/o6/4h/7ho64hihtgz3atuttk1vm0mucpq.png"><br><br><h3>  Research </h3><br>  Then, almost all of our projects used the library Sound Manager 2. <br><br>  Almost immediately you realize that playing two audio files on mobile devices at the same time does not work the same everywhere! <br><br>  In Chrome (~ 62 version) for PC, tracks are played as expected.  On mobile devices (also in Chrome), playback of tracks worked, but only with the active screen.  When the screen was locked, the next track for the current player was not played.  As for iOS / macOS, the playback worked in the same way.  More information can be found <a href="https://www.ibm.com/developerworks/ru/library/wa-ioshtml5/">here</a> - section ‚ÄúSingle audio stream‚Äù. <br><br>  So began the <s>trip over three seas</s> searching for information bit by bit about the features of the browsers with audio. <br><br>  Well, I try the solution with Web Audio without using any libraries.  Yes, this technology is designed for other purposes: synthesis, sound processing, for games, etc., rather than just playing tracks.  But for the sake of experiment, it was necessary to try, since it allows you to compose sounds from different sources on one <a href="https://www.html5rocks.com/en/tutorials/webaudio/intro/">sound output</a> - speakers / headphones / phone speaker / etc.  There are guys who are purposefully <a href="https://medium.com/%40Rich_Harris/phonograph-js-tolerable-mobile-web-audio-55286bd5e567">engaged in exploring the</a> possibilities of audio playback on mobile devices using the Web Audio API. <br><br>  After implementation, certain nuances emerged. <br><br>  First, you need to wait for the full load of the entire track.  With a slow connection to the Internet, there will be noticeable pauses due to the fact that the second track may not have time to load by the time the first track ends.  Full download can be avoided if you use a bunch of HTML5 Audio tags that act as sound sources for Web Audio, but in this case it becomes impossible to play two sounds at the same time again. <br><br>  Secondly, if you download a track over the network with fragments and decode them programmatically, this increases the load on the CPU.  For a PC it was acceptable, but for mobile devices it is critical. <br><br>  Thirdly, there were problems with decoding.  If fragments of mp3 / ogg / wav files came to the client, then these pieces were quietly <a href="https://developer.mozilla.org/ru/docs/Web/API/AudioContext/decodeAudioData">decoded</a> and reproduced.  But if chunks of an mp4 file that served as a container for HE-AAC came to the browser, then they could not be decoded.  To some extent, this also applies to the Opera browser, in which the playback of MP3 files is unstable from version to version ‚Äî it reproduces, it gives an error that this format is not supported. <br><br>  Fourthly, the name of the track on the locked screen on a plate with a native audio player (on the iPad) was not displayed / did not change, including  when switching between tracks.  Perhaps due to the fact that the iPad with version 9 of iOS was used for the tests - there was no other at that time. <br><br>  As a result, at this stage, Web Audio had to be abandoned.  Still, the crossfade is not for browsers, standard music in good quality weighs quite a lot. <br><br>  If we refuse the crossfade, we will implement a simple fade in and fade out, at the beginning and at the end of the music track, respectively. <br><br>  The code on the previous step was slightly modified and tested.  As a result of tests, various nuances surfaced (shown in the table).  All this using the library Sound Manager 2. <br><br><img src="https://habrastorage.org/webt/b5/bj/wg/b5bjwgh2mds3pn1x8ghbp3nuyue.png"><br><br>  We add logging of all events to determine the moment of transition between tracks and understand at what point they stop playing. <br><br><img src="https://habrastorage.org/webt/z_/nr/0g/z_nr0g8j0zxskeevs2e3loddlok.png"><br><br><div class="spoiler">  <b class="spoiler_title">Tab activation</b> <div class="spoiler_text">  In Safari 9+, the sound doesn‚Äôt always appear when you activate a tab. <br></div></div><br>  From this, it can be assumed that JS execution in the background is throttling or the execution flow stops completely (events and <a href="https://stackoverflow.com/questions/15871942/how-do-browsers-pause-change-javascript-when-tab-or-window-is-not-active">timers</a> ).  However, later it will become clear that this was partly the correct conclusion.  Below will be considered another 1 nuance associated with playing tracks and understanding why the sound does not appear. <br><br><div class="spoiler">  <b class="spoiler_title">Remark</b> <div class="spoiler_text">  To work with a progressbar, for example, by drawing it for a track, it is good to use requestAnimationFrame instead of setInterval / setTimeout.  You can avoid the cumulative effect when you deactivate (background tab) and then activate the tab and temporarily suspend it, associated with performing all the calculations and redrawing the progress state. <br></div></div><br>  At the same time, the question arose: what about autoplay tracks on PCs and mobile devices? <br><blockquote>  Autoplay is understood to mean the automatic start of playing a track without any user action when the page loads. <br></blockquote>  As for Safari in relation to <a href="https://mackeeper.com/blog/post/444-safari-11-block-autoplay-videos-and-website-tracking/">automatic playback</a> when the page is loaded, this is not possible; you need <a href="https://www.reddit.com/r/webdev/comments/71nkym/safari_11_has_a_major_change_to_web_audio_api/">user interaction</a> with the page, just like on <a href="https://bitmovin.com/play-not-play-new-autoplay-policies-safari-11-chrome-64/">mobile devices</a> .  This applies to both <a href="https://support.apple.com/ru-ru/guide/safari/stop-autoplay-videos-ibrw29c6ecf8/mac">video content</a> and <a href="https://webkit.org/blog/7734/auto-play-policy-changes-for-macos/">audio content</a> . <br><br>  And so, at that time was the following: <br><br><ol><li>  it is impossible (not desirable) to reproduce two or more sounds simultaneously; </li><li>  for the pseudo ‚Äúauto-play‚Äù track, user permission is needed ‚Äî the first interaction, later it was called ‚ÄúSell a finger to the device‚Äù; </li><li>  in the background (background tab / lock screen) JS (it all depends on the browser): <br>  either freezes completely; <br>  either exposed to throttling; <br>  either works the same as with the active tab; <br></li><li>  You can automatically start playback without sound, but it is not clear why (for audio content)? </li><li>  somewhere far away a thought begins to loom, but how to make JS in the background continue to be executed? </li></ol><br>  Other libraries implemented the functions of the player with the assumption that there might be a solution for this task.  Despite the fact that many issues were reviewed on GitHub with a description of the problems when playing tracks in various browsers, it was still hoped that you‚Äôll get to the point: why it doesn‚Äôt work and how to do it to work.  As it turned out, no ... <br><br>  A few code examples with a video demonstration of libraries: <br><br><ol><li>  Sound Manager 2 - <a href="https://dipiash.github.io/audio_examples/2.html">github pages</a> , <a href="https://github.com/dipiash/audio_examples/blob/master/2.html">github repository</a> , video: <a href="">macOS Safari 12</a> ;  <a href="">iOS Safari 10</a> with unlocked screen </li><li>  Howler <br>  Howler v2.0.9 - <a href="https://dipiash.github.io/audio_examples/3.html">github pages</a> , <a href="https://github.com/dipiash/audio_examples/blob/master/3.html">github repository</a> , video: <a href="">macOS Safari 12</a> , <a href="">iOS Safari 10</a> <br>  Howler v2.0.15 - <a href="https://dipiash.github.io/audio_examples/4.html">github pages</a> , <a href="https://github.com/dipiash/audio_examples/blob/master/4.html">github repository</a> , video: <a href="">macOS Safari 12</a> <br>  Howler v2.1.1 - <a href="https://dipiash.github.io/audio_examples/5.html">github pages</a> , <a href="https://github.com/dipiash/audio_examples/blob/master/5.html">github repository</a> , video: <a href="">macOS Safari 12</a> , <a href="">iOS Safari 10</a> <br></li></ol><br><blockquote>  For macOS, video recording is made without sound, so you need to look at the volume indicator - the speaker image, on the tab. <br><br>  More video examples are available in the repository. <br><br>  In the interactive example for Howler v2.1.1 - sometimes you can hear several sounds at the same time, this is due to the addition of a pool of unlocked audio elements by the user (in future versions of the library this should be fixed). <br></blockquote>  What is the reason for the inoperability of these libraries? <br><br>  Above, I wrote: <i>‚ÄúIn the background (background tab), JS either freezes completely or is subjected to throttling</i> . <i>‚Äù</i>  So another moment comes up: the libraries in the code use the creation of new audio objects through new Audio ().  If they are created dynamically, i.e.  an already existing audio object is not used, and the user does not interact with the site, the tab is inactive or the screen is locked, some browsers may find that the audio from this audio element should not be played until the tab is active again or the user does or action. <br><br>  An example of a test on <a href="https://dipiash.github.io/audio_examples/6.html">github pages</a> and in the <a href="https://github.com/dipiash/audio_examples/blob/master/6.html">repository on github</a> using new Audio ().  Video: <a href="">macOS Safari 12</a> ;  <a href="">iOS Safari 10</a> with unlocked screen. <br><br>  <b>It seems that some kind of universal tool does not exist and it is necessary to look for some other compromise solution.</b> <br><br>  Then sit down with the guys from the team to discuss, and what is really important in the audio player?  For it would be possible to continue the experiments indefinitely, but we need to move forward. <br><br>  First, important points were identified that prevented achieving the desired result: <br><br><ol><li>  Safari on macOS does not play tracks with an inactive tab; </li><li>  there is no possibility to listen to music in the background (with the screen locked) on smartphones running on iOS and Android, I would like to avoid aggressive redirecting users to the mobile application (later), as previous experience shows that quite a large part of users do not want to install a mobile application ; </li><li>  The player does not work correctly with a dynamic playlist, i.e.  when it is not known in advance what the next track will be. </li></ol><br>  Further, it was possible to formulate goals that were necessary to achieve: <br><br><ol><li>  ensure that the player works in the background - in various browsers and on various platforms; </li><li>  allow the user to choose what to use: listen to music on the site or in a mobile application; </li><li>  provide the ability to use the player (or approach) in various future projects. </li></ol><br>  Began a new phase of finding solutions to the problem.  At this stage, various libraries were not used, all studies were conducted using HTML5 Audio.  The bottom line is that a variant was found using <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers">dedicated workers</a> .  iOS did not allow this solution to win again - playback in the background does not work, but it turned out to work in Android (Chrome, Opera, Safari). <br><br>  HTML5 Audio + Dedicated Workers test sample <a href="https://dipiash.github.io/audio_examples/worker/index.html">on github pages</a> and in <a href="https://github.com/dipiash/audio_examples/tree/master/worker">a github repository</a> . <br><br>  During the initialization of the Worker, data about the current track is requested.  Worker is also engaged in sending a signal to receive a progress state ‚Äî how long the track plays ‚Äî from the main stream and, based on this data, decides when to request data about the next track from the network. <br><br><img src="https://habrastorage.org/webt/ln/t0/sh/lnt0shcslejecuvcenkh-rlv28y.png"><br><br>  Also at that time the following example was tested ( <a href="https://dipiash.github.io/audio_examples/index.html">github pages</a> , <a href="https://github.com/dipiash/audio_examples/blob/master/index.html">repository on github</a> ), when HTML5 audio tag is embedded in the DOM (video: <a href="">macOS Safari 12</a> , <a href="">iOS Safari 10</a> ) and it just replaces SRC when switching between tracks.  Today on macOS in 12 Safari this example works.  Unfortunately, now there is no way to test the performance of this example on macOS in Safari 10 and 11 versions, but at that time this example did not work during the tests ( <a href="https://bitmovin.com/play-not-play-new-autoplay-policies-safari-11-chrome-64/">autoplay policies</a> , <a href="https://stackoverflow.com/questions/44629198/safari-11s-new-autoplay-restrictions-on-html5-audio">autoplay restrictions</a> ). <br><br>  To summarize, for iOS and macOS, Safari does not consider a new instance of an audio element as an activated user if it was created in the background inside an event, for example, ajax, setTimeout, onended. <br><br>  Further, with regard to playing tracks in iOS Safari and iOS Chrome, it was found that it was possible to play tracks in the background (with the screen locked) only using <a href="https://developer.apple.com/streaming/">HLS</a> .  For iOS and macOS platforms, this format is standard and is supported by the operating system.  A native implementation is also available for Android Chrome and Edge.  And for PCs in Chrome, you can use software handlers, for example, <a href="https://github.com/video-dev/hls.js/">hls.js</a> , <a href="https://bitmovin.com/video-player/">Bitmovin Player</a> , etc. <br><br>  A <a href="https://github.com/dipiash/hls_audio_player_example">link to the github repository</a> is available sample code that covers the simplest use case ‚Äî simply playing the playback stream generated on the server without rewinding, switching to the next track, etc.  Examples are presented using the audio tag, the video tag, the hls.js library, and the player from Bitmovin.  Node.js required for launch. <br><br><h3>  findings </h3><br>  The first point, unfortunately, because of the whole variety of browsers, there is no any universal solution that would allow listening to music in browsers equally well everywhere.  Everywhere there are limitations, and as practice shows, it is possible to live with them comfortably. <br><br>  The second point, sometimes it is worth checking border cases as quickly as possible, for example, a native implementation.  Find some minimally acceptable set of requirements and quickly test its performance, and not take as a basis any library.  This will give more insight into how these libraries are built inside and why certain functions work or do not work.  Otherwise, you can run away quite far in the project and then understand that something is going wrong.  And it may be that abandoning the library will be quite expensive.  You will need to rewrite a significant portion of the code. <br><br>  The third point, be sure to pay attention to the audience of your service - from which browsers and operating systems come your users.  It is quite easy to track through various metrics and error monitoring systems.  Such an approach will make it possible to understand which platforms and browsers are important to maintain, and on which support you can save energy. <br><br><h4>  And finally </h4><br>  I announce a small contest related to playing music on iOS using HLS technology. <br><br>  Description can be seen on the <a href="https://github.com/dipiash/m3u8-playlist-generator">link to github</a> . </div><p>Source: <a href="https://habr.com/ru/post/438952/">https://habr.com/ru/post/438952/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>