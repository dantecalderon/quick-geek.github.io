<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Database serialization</title>
  <meta name="description" content="Hi, Habr! 


 Once I was sitting and trying to give the front JSON with real estate objects that had a lot of dependencies. Symfony 4, knp pagination ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>Database serialization</h1><div class="post__text post__text-html js-mediator-article"><p>  Hi, Habr! </p><br><p>  Once I was sitting and trying to give the front JSON with real estate objects that had a lot of dependencies.  Symfony 4, knp pagination and JMSSerializer were on the back, well, in principle, standard things, but the problem is that when you try to give an object with all nested entities and collections, everything starts to slow down at the level of serialization of this data. </p><br><p>  First you need to make a request to the database, then the serializer will gradually tighten everything else, then it will all be wrapped in JSON and only then everything will return to the front. </p><br><h2 id="ideya">  Idea </h2><br><p>  I had an idea, why not return JSON directly to the front from the back directly from the database, yes, write a drop dead SQL, but you can make a tool that does it for you.  I started writing the idea, <a href="https://github.com/AndreyMashukov/mysql-json-serializer">the githaba repository</a> , based on the data model from the doctrine, the OneToOne, ManyToOne, OneToMany and ManyToMany connections.  Also, this tool can be easily screwed to Symfony 4 and it will set itself up; in the end, you only need to inject the QueryBuilderFactory factory and get QueryBuilder from there for the desired table according to the entity class. </p><br><p>  Also, my serializer uses serialization groups that you can specify with the Expose annotation on the entity field, do not forget to hang the Table annotation on the entity and specify the table alias, it is better to use the ones that you usually specify. </p><br><h2 id="primer-generacii-sql">  SQL generation example </h2><br><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> \<span class="hljs-title"><span class="hljs-title">Mash</span></span>\<span class="hljs-title"><span class="hljs-title">MysqlJsonSerializer</span></span>\<span class="hljs-title"><span class="hljs-title">QueryBuilder</span></span>\<span class="hljs-title"><span class="hljs-title">Table</span></span>\<span class="hljs-title"><span class="hljs-title">JoinStrategy</span></span>\<span class="hljs-title"><span class="hljs-title">FieldStrategy</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> \<span class="hljs-title"><span class="hljs-title">Mash</span></span>\<span class="hljs-title"><span class="hljs-title">MysqlJsonSerializer</span></span>\<span class="hljs-title"><span class="hljs-title">Wrapper</span></span>\<span class="hljs-title"><span class="hljs-title">FieldWrapper</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> \<span class="hljs-title"><span class="hljs-title">Mash</span></span>\<span class="hljs-title"><span class="hljs-title">MysqlJsonSerializer</span></span>\<span class="hljs-title"><span class="hljs-title">QueryBuilder</span></span>\<span class="hljs-title"><span class="hljs-title">Table</span></span>\<span class="hljs-title"><span class="hljs-title">Table</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> \<span class="hljs-title"><span class="hljs-title">Mash</span></span>\<span class="hljs-title"><span class="hljs-title">MysqlJsonSerializer</span></span>\<span class="hljs-title"><span class="hljs-title">Wrapper</span></span>\<span class="hljs-title"><span class="hljs-title">Mapping</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> \<span class="hljs-title"><span class="hljs-title">Mash</span></span>\<span class="hljs-title"><span class="hljs-title">MysqlJsonSerializer</span></span>\<span class="hljs-title"><span class="hljs-title">QueryBuilder</span></span>\<span class="hljs-title"><span class="hljs-title">QueryBuilder</span></span>; $oneToManyTable = (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Table(<span class="hljs-string"><span class="hljs-string">'advert_group'</span></span>, <span class="hljs-string"><span class="hljs-string">'adg'</span></span>, <span class="hljs-string"><span class="hljs-string">'adg_id'</span></span>)) -&gt;addSimpleField(<span class="hljs-string"><span class="hljs-string">'adg_id'</span></span>) -&gt;addSimpleField(<span class="hljs-string"><span class="hljs-string">'adg_name'</span></span>) ; $table = (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Table(<span class="hljs-string"><span class="hljs-string">'estate'</span></span>, <span class="hljs-string"><span class="hljs-string">'est'</span></span>, <span class="hljs-string"><span class="hljs-string">'est_id'</span></span>)) -&gt;addSimpleField(<span class="hljs-string"><span class="hljs-string">'est_id'</span></span>) -&gt;addSimpleField(<span class="hljs-string"><span class="hljs-string">'est_name'</span></span>) -&gt;addOneToManyField($oneToManyTable, <span class="hljs-string"><span class="hljs-string">'advert_groups'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FieldStrategy(<span class="hljs-string"><span class="hljs-string">'adg_estate'</span></span>)); $mapping = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mapping(); $mapping -&gt;addMap($table, <span class="hljs-string"><span class="hljs-string">'est_id'</span></span>, <span class="hljs-string"><span class="hljs-string">'id'</span></span>) -&gt;addMap($table, <span class="hljs-string"><span class="hljs-string">'est_name'</span></span>, <span class="hljs-string"><span class="hljs-string">'name'</span></span>) -&gt;addMap($oneToManyTable, <span class="hljs-string"><span class="hljs-string">'adg_id'</span></span>, <span class="hljs-string"><span class="hljs-string">'id'</span></span>) -&gt;addMap($oneToManyTable, <span class="hljs-string"><span class="hljs-string">'adg_name'</span></span>, <span class="hljs-string"><span class="hljs-string">'name'</span></span>); $builder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> QueryBuilder($table, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FieldWrapper($mapping)); $builder -&gt;setOffset(<span class="hljs-number"><span class="hljs-number">2</span></span>) -&gt;setLimit(<span class="hljs-number"><span class="hljs-number">1</span></span>); $sql = $builder-&gt;jsonArray();</code> </pre> <br><p>  As a result, the following SQL will be generated: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> JSON_ARRAYAGG(JSON_OBJECT(<span class="hljs-string"><span class="hljs-string">'id'</span></span>,est_res.est_id,<span class="hljs-string"><span class="hljs-string">'name'</span></span>,est_res.est_name,<span class="hljs-string"><span class="hljs-string">'advert_groups'</span></span>,(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> JSON_ARRAYAGG(JSON_OBJECT(<span class="hljs-string"><span class="hljs-string">'id'</span></span>,adg.adg_id,<span class="hljs-string"><span class="hljs-string">'name'</span></span>,adg.adg_name)) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> advert_group adg <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> estate est_2 <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> est_2.est_id = adg.adg_estate <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> est_2.est_id = est_res.est_id))) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> estate est <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OFFSET</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) est_res</code> </pre> <br><p>  Result: </p><br><pre> <code class="json hljs">[{<span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"–ú–æ—Å–∫–≤–∞, –æ–∫—Å–∫–∞—è —É–ª–∏—Ü–∞, 3–∫1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"advert_groups"</span></span>: [{<span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"avito-1115362430"</span></span>}]}]</code> </pre> <a name="habracut"></a><br><h2 id="itogi">  Results </h2><br><p>  Full instructions for use will be added to the githab repository soon.  As a result, when I screwed it in my project, I received very fast responses from the REST API and at the same time I was able to give a lot of objects with a large number of nested dependencies, for example, what I wanted to get through JMSSerializer I received for 40 seconds, now for 230 millisek, and this is on condition that Kernel Subscriber reads annotations in the fields of entities through reflection, I want to implement it soon via cache Symfony. </p><br><p>  The article will be supplemented ... </p><br><p>  <a href="https://habr.com/en/post/438528/">The second part of</a> </p></div><p>Source: <a href="https://habr.com/ru/post/438460/">https://habr.com/ru/post/438460/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>