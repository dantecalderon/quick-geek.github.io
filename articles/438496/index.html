<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Python + Raspberry Pi + Pixhawk and quadrocopter. Or how not to do robots</title>
  <meta name="description" content="Hi, Habr! 

 My name is Alexey, for 7 years I am the leading developer of smart TV solutions in a large custom-made company from Izhevsk. Every year w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-6974184241884155",
      enable_page_level_ads: true
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>Python + Raspberry Pi + Pixhawk and quadrocopter. Or how not to do robots</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr! <br><br>  My name is Alexey, for 7 years I am the leading developer of smart TV solutions in a large custom-made company from Izhevsk.  Every year we hold a competition of Christmas decorations, and every time we do not decorate, and we saw all sorts of technological things.  This time, crossed the drone and Smart TV-application.  And what came out of it - read below. <br><br>  The idea was quite realizable.  They wanted to make a quadrocopter in the form of Santa Claus sleigh, who would deliver gifts for the staff to the office and to the music.  At the same time, he had to orient himself in space using the analysis of ArUco tags, interacting with television applications (‚Äúblowing out‚Äù smoke from the pipes with running screws, running out of animals for the quadcopter meeting / escorting). <br><br>  And for all three months.  Of course, we did not have time. <br><br>  Although at various times up to seven people worked on the project, the result was far from ideal.  In general, we have learned only to launch a copter and have written applications for televisions.  Set up a quadcopter interaction with TVs.  But first things first. <br><br><img src="https://habrastorage.org/webt/hs/tc/mo/hstcmoqfuqqeh1rkbir2abu-ozk.jpeg"><br><a name="habracut"></a><br>  I don‚Äôt remember in whose sick head (definitely not in mine, but this isn‚Äôt exactly) the idea to launch a quadcopter bomber in the office was born.  The task is new and difficult, but we haven‚Äôt found anything beyond our strength.  Yes, we rummaged Internets in order to find a library to manage the controller of the kopter.  Yes, it was necessary to transfer the image from the webcam to the stream client and analyze it on the server.  Yes, it was necessary to make a bomb bay.  Yes, it is necessary in general to write a shell that would collect all this in itself.  So what?  We have already done all this (except for controlling the controller).  Therefore, the project gave a green light. <br><br><h3>  Device </h3><br>  Each helicopter evolutionary mistake buzzing over your head, in principle, consists of one set of mechanisms and schemes.  It: <br><br><ol><li>  controller, </li><li>  motors with screws </li><li>  battery, </li><li>  speed control (ESC), </li><li>  telemetry antenna, </li><li>  GPS module and compass, </li><li>  camera. </li></ol><br>  The last two items are optional.  You can see the scheme of the rotor winged device here: <br><br><img src="https://habrastorage.org/webt/5r/bc/pn/5rbcpn-v4dc9z77ovgkcn90gfwa.jpeg"><br><br>  This good is put on the body.  However, the body decided to make their own.  Because: <br><br><ul><li>  yourself with a mustache, </li><li>  they needed the hull in the form of a sleigh, </li><li>  it was indecently expensive. </li></ul><br><h4>  Controller </h4><br><img src="https://habrastorage.org/webt/ox/fk/4k/oxfk4kiredowxa4zwundwzyhpky.jpeg"><br><br>  The most important part of any helicopter larvae.  It has accelerometers on three axes, software firmware, inputs for installing peripheral equipment and connecting engines, an output for controlling.  Without it, no drone will rise into the air.  The thing is so important that it is installed on a special shock-absorbing platform to reduce the effects of vibration and shock loads.  Something like this: <br><br><img src="https://habrastorage.org/webt/8c/km/nj/8ckmnjy5wqtlwssfdetqf03qoh4.jpeg"><br><br>  We have chosen relatively major controller.  ‚ÄúRelatively,‚Äù because then I took a closer look at the monsters that are proposed for serious uncles ... Nevertheless, the controller has a GPS, a compass, an autopilot, all sorts of other good buns, supports up to 8 engines. <br><br>  Strictly speaking, such controllers are designed not only for vertically flying brethren.  They can be installed on any moving platforms, ranging from helicopters, airplanes, to cars and boats.  A bunch of use options.  But we are somewhat distracted. <br><br><h4>  Engines </h4><br><img src="https://habrastorage.org/webt/23/cz/tp/23cztpptzslwxqeq-c2djuykfjs.jpeg"><br><br>  There are a lot of these friends.  Round, square, curves, slanting, big, small, expensive and cheap.  The main difference: the maximum power consumption, current strength and number of revolutions per second.  In a perfect view, the sleigh should have been able to lift a can of beer (0.5 kg).  Having estimated the total weight of the structure, we calculated the approximate required lifting force and took high-quality powerful engines.  As it turned out later, they never launched at full capacity.  But more is better than less ... <br><br><h4>  Battery </h4><br><img src="https://habrastorage.org/webt/jf/yf/qc/jfyfqcwbdvb7quzklsnq5knqxwq.jpeg"><br><br>  The only source of energy through which a potential kamikaze will stay in the air.  In the course of operation, several curious moments were found out. <br><br>  First, the buzzing bit of technology eats energy like free energy.  The can is landed at the moment, but it takes a long time to charge. <br><br>  Secondly, he not only eats, but also knows how to leave a charge "in reserve".  The idea is good, because when the threshold voltage is reached, the machine interrupts the flight and makes a soft landing, but this is expressed in the fact that the bank ‚Äúlands‚Äù even faster. <br><br><h4>  Speed ‚Äã‚Äãcontrol </h4><br><img src="https://habrastorage.org/webt/nv/da/h-/nvdah-7zi0hnfgq80t_wyddzrnu.jpeg"><br><br>  Small chip, without which the engines simply will not work.  Designed to distribute voltage from banks to the engine.  Very important thing, usually comes bundled with the motor to be bought. <br><br><h4>  Telemetry antenna </h4><br><img src="https://habrastorage.org/webt/wf/5l/9i/wf5l9ilqqy8bub5zwx1ch5xejpo.jpeg">  " <br><br>  In essence, the peripheral equipment, but without it, manage the stubby branch of the development of flying objects will not work.  In addition, telemetry is used not only to control, but also to transmit video from the camera, so there are usually two antennas.  By the way, telemetry is carried out by applying and transmitting signals to the channel list.  They can also be controlled programmatically, but this is absolutely not recommended, because in this way we actually abandon the embedded autopilot and write our own.  On the knee.  And substances and sticks.  On the last evening.  How we love. <br><br><h4>  GPS module </h4><br><img src="https://habrastorage.org/webt/yg/gm/iu/yggmiu0w0znbya1tantxjpommle.jpeg"><br><br>  The main and almost the only way to position a flying nerve destroyer in space.  Typically, the GPS module also contains a compass.  So that nothing influences it in flight, the module is placed on a special boom, so that nothing influences it at all.  We used it only for the sake of a compass, because it doesn‚Äôt catch GPS indoors.  Supports other positioning systems. <br><br>  Like any self-respecting GPS, can make mistakes.  The error varies from a few meters to several continents.  But in general, the necessary device on the street for the implementation of missions at a distance. <br><br><h4>  Camera </h4><br><img src="https://habrastorage.org/webt/qi/-c/e9/qi-ce9uvgdlvdj3l5gj7vojukhy.jpeg"><br><br>  That for which everything is done.  Thunderstorm English airports can not just chat under a camera.  The controller can stabilize, remotely control it and provide very detailed settings and tools for its management.  But we all did not use it.  Next time. <br><br><h3>  Control </h3><br>  All sapiens engineering handicrafts using controllers are essentially controlled by one program: Mission Planer.  It looks like this: <br><br><img src="https://habrastorage.org/webt/lb/yi/j_/lbyij_b3y4mi6ix4djnselaw4vg.jpeg"><br><br>  Read more about it <a href="http//ardupilot.org/planner/">here</a> . <br><br>  It presents a wide range of features and settings.  There is a flight plan planning, geo-positioning, manual control, various settings and equipment calibration. <br><br><h4>  Rule number 1: use only what you need </h4><br>  Yes, the program is necessary and useful.  Basically.  But not for our task, because the air divider should be managed programmatically, and we have ruined a lot of time to deal with this planner. <br><br>  Manual control itself can be carried out than your heart desires.  There are settings for the remote, for the joystick.  You can bring control to the mouse and keyboard.  The main requirement is to calibrate the control panel.  Well, manage manually.  Since we are lazy developers, we did not want to manage manually.  I wanted the rotor winged side result of the thinking activity to fly. <br><br><h3>  Program control </h3><br>  On the Internet, only <a href="http//python.dronekit.io/">this</a> library has been found, which is designed to programmatically control the similarity of aircraft.  And it was written (drum roll) on python.  In the general case for versions 2.x, but also on Python 3.5, it worked quite stably.  The library has rich functionality and relatively good documentation.  But before you start writing your mega-managing drone code, you first need to ... Yes, you need to connect to the controller. <br><br>  The Raspberry Pi microcomputer was used as a control software component, on which a web server was deployed on the aiohttp framework. <br><br>  The scheme and instructions for connecting the "raspberry" and the controller can be found <a href="http://ardupilot.org/dev/docs/raspberry-pi-via-mavlink.html">here</a> . <br><br>  Schematically it looks like this: <br><br><img src="https://habrastorage.org/webt/ez/cg/hs/ezcghscpuid6ul6os31ln2lotoy.jpeg"><br><br>  The connection method is as follows.  The controller and raspberry are connected by wires according to the specified scheme.  Thus, the radio signal is sent and received by the controller.  On raspberries, you need to start a proxy server that will cling to the controller and transfer data from it.  Connection can be made through telemetry, or via USB.  They use different COM ports.  The figure shows a method through telemetry. <br><br><h4>  Rule number 2: incomplete documentation.  Often do not write the most obvious things. </h4><br>  For example, to connect from python to the controller, you must specify the address and port: connectionString = '127.0.0.1:14540 ‚Ä≤ <br><br>  But it turned out that this address and port must be specified in the launch line of the proxy server.  Right here: <br><br><pre><code class="plaintext hljs">mavproxy.py ‚Äîmaster=/dev/ttyAMA0 ‚Äîbaudrate 921600 ‚Äîaircraft MyCopter</code> </pre> <br>  Yes, it is obvious, but it is never obvious.  And we spent a lot of time to figure it out. <br><br>  However, after starting the proxy with the correct string and after a successful connection to the drone from the python, the miracle of the hostile technology did not want to run.  That is, we get the data from the copter, we see them, but the future heavenly threat of mankind refuses to execute commands.  At the last moment it became clear that the data to connect to the drone should be significantly more.  Conventionally, he should start sending data to the connected telemetry, otherwise, he simply did not connect it and was satisfied. <br><br><h4>  Hence the rule number 3: use USB </h4><br>  Yes, the documentation for it was much less, but the stability of the connection would definitely be higher.  Because it would not have to use raspberry pins. <br><br><h3>  Test flight </h3><br><img src="https://habrastorage.org/webt/c4/uf/ui/c4ufuioqt8m4ny-ertllpkxklxs.jpeg"><br><br>  And then suddenly it turned out that: <br><br><ol><li>  kopter flies not exactly </li><li>  his telemetry errors ¬± meter and more, </li><li>  For a flight, tasks of the type are adequate: climb 10-20 meters, fly 100 meters to the north, etc. </li></ol><br>  Let me remind you that this design, created under the influence of helicopters from the Avatar film, was launched in the office, where there are a lot of office equipment, lamps, ventilation and decor hang from the ceiling.  Well, there are also employees.  In general, it quickly became clear that a serious indoor flight would be fraught with 160 severed heads. <br><br><h4>  Rule number 4: use normal test conditions </h4><br>  If a flying tank is 50 by 60 cm in size, its presence in the air in a confined space will inevitably lead either to damage or to those near it.  An ideal test area would be a room the size of a gym. <br><br><h3>  Computer vision </h3><br>  A separate portal to hell was the task of computer vision.  The idea is to read ArUco tags, each of which has a recorded position in the room plan, and relative to which the driver determines its position in space, as well as its position relative to the current point of the route. <br><br>  Example tags: <br><br><img src="https://habrastorage.org/webt/ti/nf/af/tinfafaqyovom08rfry4obo0lvg.png"><br><br>  For implementation, the <a href="https//opencv.org/">openCV</a> library was <a href="https//opencv.org/">used</a> .  It is used to recognize in general everything that is, in particular: the faces of people, objects, license plates, and of our tags.  Installing the library on the raspberry operating system - Rasbian - became a nightmare, with which four people fought in turn.  Nevertheless, we successfully solved it, and now the machine has ‚Äúlearned‚Äù to recognize tags in a video stream from a webcam.  But again, not enough time to configure everything.  For example, from two or more tags the library returned the recognized numbers of all tags, and the data is only one by one.  Why is that?  The mystery is great ... <br><br><h4>  Rule important: allocate enough time to fine-tune the decision </h4><br><h3>  Other senses </h3><br>  So that the mutant of the Icarus wings would not stick into the EARLY obstacles appearing, they wanted to use distance sensors.  They were supposed to be on all sides of the car and had to signal the approach of an obstacle, so that the driver should stop, take a ‚Äústep to the side‚Äù and continue on the route. <br><br>  We did not manage to do this functionality at all. <br><br><h3>  Routes </h3><br>  We talked a lot about the routes of the copter.  And what kind of animals are these?  I will say right away that this functionality was implemented very first and in full, but ... it was not useful. <br><br>  Movement routes are a connected graph with vertices, each of which has its three-dimensional coordinate in the space of the room.  Accordingly, the kopter should follow from the starting point to the finish, in the latter to perform the flight task.  It follows by moving from the current vertex to the next.  Since for each vertex we know its coordinates, and at the copter we know its location (compass) and position (marks), then it is a purely technical matter to calculate where to go.  The task of finding the path between the starting point and the finish is solved by a recursive function.  Routes, edges and vertices are stored in a database deployed on raspberries. <br><br><h4>  The last rule: do only what you need to implement </h4><br><h3>  Technology stack </h3><br>  Copter: <a href="https//www.raspberrypi.org/">Raspberry Pi</a> , <a href="https//www.raspbian.org/">Rasbian</a> , <a href="https//opencv.org/">OpenCV</a> , <a href="https//www.python.org/">Python 3.5</a> , <a href="http.readthedocs.io/">aiohttp</a> , <a href="http//python.dronekit.io/">DroneKit</a> , <a href="https//pypi.org/project/RPi.GPIO/">RPi.GPIO</a> , <a href="https//pypi.org/project/RPi.GPIO/">SQLite</a> . <br><br>  Server with dynamics for TV: <a href="https//nodejs.org/">node.js</a> , <a href="https//expressjs.com/">Express</a> , <a href="https//socket.io/">socket.io</a> . <br><br>  TV applications: <a href="http//es6-features.org/">JavaScript ES6</a> , <a href="http//es6-features.org/">webpack 2</a> , <a href="http//es6-features.org/">Canvas</a> . <br><br>  The repository with the code of the copter is <a href="https://github.com/alxtrusov/copter">here</a> .  For stars - the benefits of karma. <br><br>  A few words to clarify the terms (please consider any assessment as subjective). <br><br><ul><li>  Raspberry Pi.  A full-fledged microcomputer with available pins and outputs for a special camera and touch screen.  It is located on the control code, web server, openCV library.  In fact, the copter is a flying server. </li><li>  Raspbian  Linux operating system for "raspberry".  There are several of them and, in general, you can put any, but it is better to put specially designed, otherwise there may be problems with the interaction with computer hardware, with the same pin, for example.  There is even an adapted version of the tenth Windows. </li><li>  OpenCV.  A library for recognizing elements in a video stream.  Also able to stream video stream, which is used in the project to issue images to the client.  (yes, the copter has a web client) </li><li>  Python 3.5.  Python.  3.5.  Not 2. *. </li><li>  Aiohttp.  Asynchronous web server framework written in python.  For some reason, he liked more than <a href="https//www.djangoproject.com/">Django</a> .  But then the choice. </li><li>  DroneKit.  Library to connect to the controller kopter from the program.  Very rich functionality, multiplied by the relatively good documentation.  Provided there are no analogues - a brilliant tool. </li><li>  RPi.GPIO.  Python library for interacting with raspberry pins.  Allows you to enable and disable pins, listen to their values.  Cannot transfer values ‚Äã‚Äãother than 0 or 1-tsy.  Or I have not found. </li><li>  SQLite.  DBMS + DB + firewood, combined into one file.  Ideal for educational and non-educational projects, if you do not need to deploy something heavily loaded.  Convenient to make changes. </li><li>  Node.js.  Server-side javascript </li><li>  Express  A web server framework written in node.js.  Very comfortable and minimalist. </li><li>  Socket.io.  Server and client library for webSocket protocol implementation.  The main plus is the stability of work and the extensive functionality provided. </li></ul><br><h3>  findings </h3><br>  In the original formulation, the task is realizable, although it requires significantly more time and effort.  Due to the fact that the autopilot and the control methods of the copter are a little less than fully tied to GPS, they must be abandoned aside direct commands to the control channels.  This entails the need to write your autopilot, that the problem is solved.  And then - test, test and test. <br><br>  Personally, I was interested.  And I still will make an automated gift bomber, one way or another.  And I‚Äôm leaving everyone interested in <br><br><h4>  The only rule is: set high and complex goals and go to them! </h4><br>  Good luck everyone! </div><p>Source: <a href="https://habr.com/ru/post/438496/">https://habr.com/ru/post/438496/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>