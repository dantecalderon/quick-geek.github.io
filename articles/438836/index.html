<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Monitoring the temperature of the server itself</title>
  <meta name="description" content="When we once again learned about the failure of the air conditioner in the server based on angry messages from the built-in server monitoring, it was ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>Monitoring the temperature of the server itself</h1><div class="post__text post__text-html js-mediator-article">  When we once again learned about the failure of the air conditioner in the server based on angry messages from the built-in server monitoring, it was a volitional decision to teach Zabbix to monitor the temperature in the server room.  To take measures when repeating a similar situation before the server turns into a bath. <br><br><img src="https://habrastorage.org/webt/eq/dz/dr/eqdzdr901kdejk_kfe2sumbidys.png"><br><a name="habracut"></a><br>  The implementation is quite simple: the thermal sensor is polled by the controller via the 1wire bus, the controller itself is connected to any available server via USB and polled with the head -n1 / dev / cuaU command, which is written in the zabbix agent config as follows: <br><br><pre><code class="plaintext hljs">UserParameter=usbtemp,head -n1 /dev/cuaU0</code> </pre> <br>  The choice of a sensor with a digital interface is due to the fact that it is a good start for the future to add another ten sensors to the bus if you need to monitor the temperature of each rack separately, for example.  The controller itself is connected via USB and in order not to reinvent its drivers, it pretends to be a regular CDC serial emulator, that is, an ordinary virtual COM port, and you could of course use the HID class, since it ideologically fits better with all its structured HID-reports for polling all kinds of sensors.  But I decided to get by with the CDC for clarity and ease of implementation. <br><br>  So, all that is required to implement it is: a DS18B20 thermal sensor itself, a microcontroller with an onboard USB hardware module, a pair of resistors, capacitors, and a USB lanyard.  As a microcontroller that implements the 1wire-USB bridge, the PIC16F1454 MK is used, in general, the reader can use any other MK for its own taste (by connecting a couple of libraries - 1wire, USB-CDC), or connect an external UART-USB bridge of the CP2102 type.  I don‚Äôt really like such crutches, so I preferred the solution on a single chip - I took the cheapest controller from USB, at the time of creating the device it was PIC16F1454. <br><br><img src="https://habrastorage.org/webt/st/xt/nm/stxtnmnuyay2srjwpec4bkyxim0.jpeg"><br><br>  The project did not use ready-made USB stacks from Microchip or third-party ones; instead, a self-written stack developed earlier for another project was used.  However, I will not go into the specifics of implementing my USB library in this article.  Since working with the USB bus is beyond the scope of this article and deserves a separate, or even a series of articles.  For which I may take in the near future, if, of course, the reader will be interested in this topic. <br>  The scheme is very simple, so the board was immediately divorced in a sprint layout, nevertheless I cite a drawing of the scheme. <br><br><img src="https://habrastorage.org/webt/yi/ui/3o/yiui3ogprczv3gihieirqww1npg.png"><br><br>  The controller does not support the bootloader, so it can only be stitched through the programmer using the ICSP connector.  PICKIT2, for example, or its clone. <br><br>  Properly assembled device starts working immediately after power is applied and does not require adjustment.  The device does not require drivers since the standard CDC class is used, under Windows 10 and FreeBSD it is determined immediately, under Windows 7 you will need to specify the inf file (see the archive for the article), which clearly indicates usbser.sys driver.  Under other OS device was not tested.  When connecting, it should be defined as / dev / cuaUx, under FreeBSD, where x is the logical number of the device.  By executing the command #head -n1 / dev / cuaU0 you can check that the sensor is correctly polled and the current temperature is displayed. <br><br><img src="https://habrastorage.org/webt/ng/vu/23/ngvu23rw23zgzrbcssr1r5hppu8.png"><br><br>  Under Windows, you can use any terminal program, such as putty, for verification. <br><br><img src="https://habrastorage.org/webt/95/ve/qr/95veqrw1dkui-9jzzqtgnrkcj-y.png"><br><br>  If everything works correctly you can continue.  Next, we create a new parameter (item) where as key we set our UserParameter specified in the agent config. <br><br><img src="https://habrastorage.org/webt/8n/j2/cl/8nj2clbheh4_btu_fdfvjjiiumo.png"><br><br>  Well, after that it remains only to create a new graph from this parameter.  And add a trigger for example at 28-30 degrees. <br><br>  In the next version it is planned to add the ability to poll a variety of sensors and display the temperature from the selected sensor on the display on the device itself.  <a href="https://yadi.sk/d/Tbx2Uw3mOpNfvQ">Archive</a> with materials for the article. </div><p>Source: <a href="https://habr.com/ru/post/438836/">https://habr.com/ru/post/438836/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
</ul></nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>