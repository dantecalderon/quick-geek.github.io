<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We are looking for errors in the source code of the Amazon Web Services SDK for .NET</title>
  <meta name="description" content="Greetings to all fans to criticize someone else's code. :) Today in our laboratory a new study material is the source code of the AWS SDK project for ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-6974184241884155",
      enable_page_level_ads: true
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>We are looking for errors in the source code of the Amazon Web Services SDK for .NET</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/getpro/habr/post_images/188/292/f27/188292f271dd0648b09f848dbe66efa6.png" alt="Picture 1"></p><br>  Greetings to all fans to criticize someone else's code.  :) Today in our laboratory a new study material is the source code of the AWS SDK project for .NET.  At one time we wrote an article about checking the AWS SDK for C ++.  Then there was nothing particularly interesting.  Let's see how we enjoy the .NET version of the AWS SDK.  A good opportunity to once again demonstrate the capabilities of the PVS-Studio analyzer, as well as to make the world a little bit more perfect. <br><a name="habracut"></a><br>  The Amazon Web Services (AWS) SDK for .NET is a developer toolkit for building .NET-based applications in the AWS infrastructure and making it much easier to write code.  The SDK includes .NET API sets for various AWS services, such as Amazon S3, Amazon EC2, DynamoDB, and others.  The source code for the SDK is hosted on <a href="https://github.com/aws/aws-sdk-net">GitHub</a> . <br><br>  As I said, we wrote <a href="https://www.viva64.com/ru/b/0378/">an article</a> about testing the AWS SDK for C ++.  The article turned out to be small - only a couple of errors were found for 512 thousand lines of code.  This time we are dealing with a much larger amount of code, which includes about 34 thousand cs-files, and the total number of lines of code (excluding empty ones) is an impressive 5 million.  A small part of the code (200 thousand lines in 664 cs-files) falls on tests, I did not consider them. <br><br>  If the quality of the .NET SDK version is approximately the same as that of C ++ (two errors per 512 KLOC), then we should get about 10 times more errors.  This, of course, is a very inaccurate method of calculation, which does not take into account language features and many other factors, but I do not think that the reader now wants to delve into boring arguments.  Instead, I suggest going straight to the results. <br><br>  The check was performed using PVS-Studio version 6.27.  Incredibly, the analyzer was able to detect about 40 errors in the AWS SDK code for .NET, which would be worth telling.  This indicates not only the high quality of the SDK code (approximately 4 errors per 512 KLOC), but also the comparable quality of the C # performance of the PVS-Studio analyzer compared to C ++.  Excellent result! <br><br>  The authors of the AWS SDK for .NET are great fellows.  From project to project, they demonstrate amazing code quality.  This can serve as a good example for other teams.  But, of course, I would not be a developer of a static analyzer if I had not inserted my 5 kopecks.  :) We are already interacting with the Lumberyard team from Amazon on the use of PVS-Studio.  But since this is a very large company with a lot of divisions around the world, it is very likely that the AWS SDK team for .NET has never heard of PVS-Studio at all.  In any case, in the SDK code I did not find any signs of using our analyzer, although this does not mean anything.  However, the command, at a minimum, <a href="https://aws.amazon.com/ru/blogs/developer/code-analyzers-added-to-aws-sdk-for-net/">uses the</a> analyzer built into Visual Studio.  This is good, but the code checks can be <a href="https://www.viva64.com/ru/b/0506/">strengthened</a> :). <br><br>  As a result, I still managed to find a few errors in the SDK code and, finally, it was time to share them. <br><br>  <b>Error in logic</b> <br><br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v3008/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v3008/">V3008</a> [CWE-563] The 'this.linker.s3.region' variable is assigned values ‚Äã‚Äãtwice successively.  Perhaps this is a mistake.  Check lines: 116, 114. AWSSDK.DynamoDBv2.Net45 S3Link.cs 116 <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> Region { get { .... } <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (String.IsNullOrEmpty(value)) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.linker.s3.region = <span class="hljs-string"><span class="hljs-string">"us-east-1"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.linker.s3.region = value; } }</code> </pre> <br>  The analyzer warns about the reassignment of the value of the same variable.  From the code it becomes clear that this is due to an error that violates the logic of operation: the value of the variable <i>this.linker.s3.region</i> will always be equal to <i>value</i> , regardless of the condition <i>if (String.IsNullOrEmpty (value))</i> .  In the body of the <i>if</i> block, <i>return</i> was omitted  The code needs to be corrected as follows: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> Region { get { .... } <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (String.IsNullOrEmpty(value)) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.linker.s3.region = <span class="hljs-string"><span class="hljs-string">"us-east-1"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.linker.s3.region = value; } }</code> </pre> <br>  <b>Infinite recursion</b> <br><br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v3110/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v3110/">V3110</a> [CWE-674] Possible infinite recursion inside 'OnFailure' property.  AWSSDK.ElasticMapReduce.Net45 ResizeJobFlowStep.cs 171 <br><br><pre> <code class="cpp hljs">OnFailure? onFailure = null; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> OnFailure? OnFailure { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.OnFailure; } <span class="hljs-comment"><span class="hljs-comment">// &lt;= set { this.onFailure = value; } }</span></span></code> </pre> <br>  The classic example of a typo that causes an infinite recursion in the <i>get</i> access method of the <i>OnFailure</i> property.  Instead of returning the value of the private <i>onFailure</i> field <i>,</i> access the <i>OnFailure</i> property.  Corrected version: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> OnFailure? OnFailure { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.onFailure; } <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.onFailure = value; } }</code> </pre> <br>  You ask: ‚ÄúHow did it work?‚Äù So far - no way.  The property is not used anywhere, but this is a temporary phenomenon.  At one point, someone will start using it and will definitely get an unexpected result.  To prevent such typos, it is recommended not to use identifiers that differ only in the case of the first letter. <br><br>  Another note to this construct is the use of an identifier that fully matches the name of the <i>OnFailure</i> type.  From the point of view of the compiler, this is quite acceptable, but makes it difficult for a person to read the code. <br><br>  Another similar error: <br><br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v3110/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v3110/">V3110</a> [CWE-674] Possible infinite recursion inside 'SSES3' property.  AWSSDK.S3.Net45 InventoryEncryption.cs 37 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> SSES3 sSES3; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> SSES3 SSES3 { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SSES3; } <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SSES3 = value; } }</code> </pre> <br>  The situation is identical to that described above.  Only here infinite recursion will occur when accessing the <i>SSES3</i> property <i>for</i> both reading and writing.  Corrected version: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> SSES3 SSES3 { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.sSES3; } <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.sSES3 = value; } }</code> </pre> <br>  <b>Attention Test</b> <br><br>  The following is a task from a programmer who is passionate about using the Copy-Paste technique.  Look at how the code looks in the Visual Studio editor, and try to find the error. <br><br><p><img src="https://habrastorage.org/getpro/habr/post_images/bfa/71b/1ab/bfa71b1ab4af941c43e5349df51b1614.png" alt="Picture 3"></p><br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v3029/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v3029/">V3029</a> The <a href="https://www.viva64.com/ru/w/v3029/">terms</a> expressions of the "if" are expressed alongside each other are identical.  Check lines: 91, 95. AWSSDK.AppSync.Net45 CreateApiKeyResponseUnmarshaller.cs 91 <br><br>  I reduced the body of the <i>UnmarshallException</i> method, removing all unnecessary.  Now it is clear that identical checks follow one after the other: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> override AmazonServiceException </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UnmarshallException</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (errorResponse.Code != null &amp;&amp; errorResponse.Code.Equals(<span class="hljs-string"><span class="hljs-string">"LimitExceededException"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LimitExceededException(errorResponse.Message, innerException, errorResponse.Type, errorResponse.Code, errorResponse.RequestId, statusCode); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (errorResponse.Code != null &amp;&amp; errorResponse.Code.Equals(<span class="hljs-string"><span class="hljs-string">"LimitExceededException"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LimitExceededException(errorResponse.Message, innerException, errorResponse.Type, errorResponse.Code, errorResponse.RequestId, statusCode); } .... }</code> </pre> <br>  It may seem that the error is not gross - just an extra check.  But often such a pattern may indicate more serious problems in the code when some necessary verification is not performed. <br><br>  There are some more similar errors in the code. <br><br>  <b>PVS-Studio warnings:</b> <br><br><ul><li>  V3029 The conditional expressions of the statement "if" statements followed alongside each other are identical.  Check lines: 75, 79. AWSSDK.CloudDirectory.Net45 CreateSchemaResponseUnmarshaller.cs 75 </li><li>  V3029 The conditional expressions of the statement "if" statements followed alongside each other are identical.  Check lines: 105, 109. AWSSDK.CloudDirectory.Net45 GetSchemaAsJsonResponseUnmarshaller.cs 105 </li><li>  V3029 The conditional expressions of the statement "if" statements followed alongside each other are identical.  Check lines: 201, 205. AWSSDK.CodeCommit.Net45 PostCommentForPullRequestResponseUnmarshaller.cs 201 </li><li>  V3029 The conditional expressions of the statement "if" statements followed alongside each other are identical.  Check lines: 101, 105. AWSSDK.CognitoIdentityProvider.Net45 VerifySoftwareTokenResponseUnmarshaller.cs 101 </li><li>  V3029 The conditional expressions of the statement "if" statements followed alongside each other are identical.  Check lines: 72, 76. AWSSDK.Glue.Net45 UpdateConnectionResponseUnmarshaller.cs 72 </li><li>  V3029 The conditional expressions of the statement "if" statements followed alongside each other are identical.  Check lines: 123, 127. AWSSDK.Neptune.Net45 RestoreDBClusterFromSnapshotResponseUnmarshaller.cs 123 </li><li>  V3029 The conditional expressions of the statement "if" statements followed alongside each other are identical.  Check lines: 167, 171. AWSSDK.Neptune.Net45 RestoreDBClusterFromSnapshotResponseUnmarshaller.cs 167 </li><li>  V3029 The conditional expressions of the statement "if" statements followed alongside each other are identical.  Check lines: 127, 131. AWSSDK.RDS.Net45 RestoreDBClusterFromSnapshotResponseUnmarshaller.cs 127 </li><li>  V3029 The conditional expressions of the statement "if" statements followed alongside each other are identical.  Check lines: 171, 175. AWSSDK.RDS.Net45 RestoreDBClusterFromSnapshotResponseUnmarshaller.cs 171 </li><li>  V3029 The conditional expressions of the statement "if" statements followed alongside each other are identical.  Check lines: 99, 103. AWSSDK.Rekognition.Net45 RecognizeCelebritiesResponseUnmarshaller.cs 99 </li></ul><br>  <b>What are you?</b> <br><br>  <b>PVS-Studio Warning:</b> <a href="https://www.viva64.com/ru/w/v3062/">V3062</a> An object 'attributeName' is used.  Consider checking the first actual argument of the 'Contains' method.  AWSSDK.MobileAnalytics.Net45 CustomEvent.cs 261 <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/// &lt;summary&gt; /// Dictionary that stores attribute for this event only. /// &lt;/summary&gt; private Dictionary&lt;string,string&gt; _attributes = new Dictionary&lt;string,string&gt;(); /// &lt;summary&gt; /// Gets the attribute. /// &lt;/summary&gt; /// &lt;param name="attributeName"&gt;Attribute name.&lt;/param&gt; /// &lt;returns&gt;The attribute. Return null of attribute doesn't /// exist.&lt;/returns&gt; public string GetAttribute(string attributeName) { if(string.IsNullOrEmpty(attributeName)) { throw new ArgumentNullException("attributeName"); } string ret = null; lock(_lock) { if(attributeName.Contains(attributeName)) // &lt;= ret = _attributes[attributeName]; } return ret; }</span></span></code> </pre> <br>  The analyzer detected an error in the <i>GetAttribute</i> method: the string is checked that it contains itself.  From the description of the method it follows that if the attribute name ( <i>attributeName</i> key) is found (in the <i>_attributes</i> dictionary), then the attribute value should be returned, otherwise <i>null</i> .  In fact, since the condition <i>attributeName.Contains (attributeName) is</i> always true, an attempt is made to return a value using a key that may not be found in the dictionary.  Then, instead of returning <i>null,</i> <i>KeyNotFoundException</i> will be thrown. <br><br>  Let's try to fix this code.  To better understand how to do this, you should look at another method: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/// &lt;summary&gt; /// Determines whether this instance has attribute the specified /// attributeName. /// &lt;/summary&gt; /// &lt;param name="attributeName"&gt;Attribute name.&lt;/param&gt; /// &lt;returns&gt;Return true if the event has the attribute, else /// false.&lt;/returns&gt; public bool HasAttribute(string attributeName) { if(string.IsNullOrEmpty(attributeName)) { throw new ArgumentNullException("attributeName"); } bool ret = false; lock(_lock) { ret = _attributes.ContainsKey(attributeName); } return ret; }</span></span></code> </pre> <br>  This method checks whether the attribute name ( <i>attributeName</i> key) <i>exists</i> in the <i>_attributes</i> dictionary.  <i>Let's</i> go back to the <i>GetAttribute</i> method and correct the error: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetAttribute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> attributeName)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.IsNullOrEmpty(attributeName)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-string"><span class="hljs-string">"attributeName"</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> ret = null; lock(_lock) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(_attributes.ContainsKey(attributeName)) ret = _attributes[attributeName]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret; }</code> </pre> <br>  Now the method does exactly what is stated in the description. <br><br>  And one more small note to this code snippet.  I noticed that authors use <i>lock</i> when working with the <i>_attributes</i> dictionary.  It is clear that this is necessary for multi-threaded access, but the <i>lock</i> design is rather slow and cumbersome.  Instead of a <i>Dictionary</i> in this case, it might be more convenient to use a thread-safe version of the dictionary - <i>ConcurrentDictionary</i> .  Then the need for <i>lock</i> disappears.  Although, maybe I do not know about some features of the project. <br><br>  <b>Suspicious behavior</b> <br><br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v3063/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v3063/">V3063</a> [CWE-571] A part of the conditional expression is always true if it is evaluated: string.IsNullOrEmpty (inferredIndexName).  AWSSDK.DynamoDBv2.PCL ContextInternal.cs 802 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetQueryIndexName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> inferredIndexName = null; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.IsNullOrEmpty(specifiedIndexName) &amp;&amp; indexNames.Count == <span class="hljs-number"><span class="hljs-number">1</span></span>) { inferredIndexName = indexNames[<span class="hljs-number"><span class="hljs-number">0</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (indexNames.Contains(specifiedIndexName, StringComparer.Ordinal)) { inferredIndexName = specifiedIndexName; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.IsNullOrEmpty(inferredIndexName) &amp;&amp; <span class="hljs-comment"><span class="hljs-comment">// &lt;= indexNames.Count &gt; 0) throw new InvalidOperationException("Local Secondary Index range key conditions are used but no index could be inferred from model. Specified index name = " + specifiedIndexName); .... }</span></span></code> </pre> <br>  The analyzer alerted the verification of <i>string.IsNullOrEmpty (inferredIndexName)</i> .  Indeed, the string <i>inferredIndexName is</i> assigned <i>null</i> , then the value of this variable does not change anywhere, and then for some reason it is checked for <i>null</i> or an empty string.  It looks suspicious.  Let's take a closer look at the above code snippet.  I deliberately did not reduce it for a better understanding of the situation.  So, in the first <i>if statement</i> (and also in the next), the <i>specifiedIndexName</i> variable is checked in some way.  Depending on the result of the checks, the variable <i>inferredIndexName</i> gets a new value.  Now pay attention to the third <i>if statement</i> .  The body of this operator (throwing an exception) will be executed in the case of <i>indexNames.Count&gt; 0</i> , since the first part of the condition, <i>string.IsNullOrEmpty (inferredIndexName),</i> is always true.  Perhaps the variables <i>specifiedIndexName</i> and <i>inferredIndexName are</i> simply confused.  Or the third check should be without <i>else</i> , representing a stand-alone <i>if statement</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.IsNullOrEmpty(specifiedIndexName) &amp;&amp; indexNames.Count == <span class="hljs-number"><span class="hljs-number">1</span></span>) { inferredIndexName = indexNames[<span class="hljs-number"><span class="hljs-number">0</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (indexNames.Contains(specifiedIndexName, StringComparer.Ordinal)) { inferredIndexName = specifiedIndexName; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.IsNullOrEmpty(inferredIndexName) &amp;&amp; indexNames.Count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidOperationException(....);</code> </pre> <br>  In this case, it is difficult to give an unequivocal answer about the options for correcting this code.  But it is definitely necessary for the author to inspect it. <br><br>  <b>NullReferenceException</b> <br><br>  <b>PVS-Studio Warning:</b> <a href="https://www.viva64.com/ru/w/v3095/">V3095</a> [CWE-476] The 'conditionValues' object was used against it.  Check lines: 228, 238. AWSSDK.Core.Net45 JsonPolicyWriter.cs 228 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeConditions</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... foreach (....) { IList&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; conditionValues = keyEntry.Value; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (conditionValues.Count == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-comment"><span class="hljs-comment">// &lt;= continue; .... if (conditionValues != null &amp;&amp; conditionValues.Count != 0) { .... } .... } }</span></span></code> </pre> <br>  Classics of the genre.  The <i>conditionValues</i> variable is used without first checking for <i>null</i> equality.  In this case, further in the code, such verification is performed, but it is too late.  :) <br><br>  The code can be corrected as follows: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeConditions</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... foreach (....) { IList&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; conditionValues = keyEntry.Value; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (conditionValues != null &amp;&amp; conditionValues.Count == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (conditionValues != null &amp;&amp; conditionValues.Count != <span class="hljs-number"><span class="hljs-number">0</span></span>) { .... } .... } }</code> </pre> <br>  A few more similar errors were found in the code. <br><br>  <b>PVS-Studio warnings:</b> <br><br><ul><li>  V3095 [CWE-476] The 'ts.Listeners' object was used against it.  Check lines: 140, 143. AWSSDK.Core.Net45 Logger.Diagnostic.cs 140 </li><li>  V3095 [CWE-476] The 'obj' object has been verified against null.  Check lines: 743, 745. AWSSDK.Core.Net45 JsonMapper.cs 743 </li><li>  V3095 [CWE-476] The 'multipartUpload MultipartUploadpartsList' object has been verified against null.  Check lines: 65, 67. AWSSDK.S3.Net45 CompleteMultipartUploadRequestMarshaller.cs 65 </li></ul><br>  The following warning is very similar in meaning, but the situation is inverse of the one discussed above. <br><br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v3125/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v3125/">V3125</a> [CWE-476]  Check lines: 139, 127. AWSSDK.Core.Net45 RefreshingAWSCredentials.cs 139 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateToGeneratedCredentials</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( CredentialsRefreshState state)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> errorMessage; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ShouldUpdate) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (state == null) errorMessage = <span class="hljs-string"><span class="hljs-string">"Unable to generate temporary credentials"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> .... <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AmazonClientException(errorMessage); } state.Expiration -= PreemptExpiryTime; <span class="hljs-comment"><span class="hljs-comment">// &lt;= .... }</span></span></code> </pre> <br>  One of the code snippets contains a check for the value of the <i>state</i> variable for <i>null</i> equality.  Further, the <i>state</i> variable is used to unsubscribe from the <i>PreemptExpiryTime</i> event, the test for <i>null is</i> no longer performed, and a <i>NullReferenceException</i> exception <i>may be thrown</i> .  More secure code option: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateToGeneratedCredentials</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( CredentialsRefreshState state)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> errorMessage; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ShouldUpdate) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (state == null) errorMessage = <span class="hljs-string"><span class="hljs-string">"Unable to generate temporary credentials"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> .... <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AmazonClientException(errorMessage); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (state != null) state.Expiration -= PreemptExpiryTime; .... }</code> </pre> <br>  There are other similar errors in the code. <br><br>  <b>PVS-Studio warnings:</b> <br><br><ul><li>  V3125 [CWE-476] The 'wrappedRequest.Content' object was verified against null.  Check lines: 395, 383. AWSSDK.Core.Net45 HttpHandler.cs 395 </li><li>  V3125 [CWE-476] The 'datasetUpdates' object was verified against null.  Check lines: 477, 437. AWSSDK.CognitoSync.Net45 Dataset.cs 477 </li><li>  V3125 [CWE-476] The 'cORSConfigurationCORSConfigurationcORSRulesListValue' has been verified against null.  Check lines: 125, 111. AWSSDK.S3.Net45 PutCORSConfigurationRequestMarshaller.cs 125 </li><li>  V3125 [CWE-476] The lifecycle ConfigurationLifecycleConfigurationrulesListValue  Check lines: 157, 68. AWSSDK.S3.Net45 PutLifecycleConfigurationRequestMarshaller.cs 157 </li><li>  V3125 [CWE-476] The 'this. Key' object was used against it.  Check lines: 199, 183. AWSSDK.S3.Net45 S3PostUploadRequest.cs 199 </li></ul><br>  <b>No alternative reality</b> <br><br>  <b>PVS-Studio Warning:</b> <a href="https://www.viva64.com/ru/w/v3009/">V3009</a> [CWE-393] This is the odd one.  AWSSDK.Core.Net45 Lexer.cs 651 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">State19</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (....) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (....) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'"'</span></span>: .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'\\'</span></span>: .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: .... <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre> <br>  The method always returns <i>true</i> .  Let's see how critical this is for the calling code.  I tracked the use of the <i>State19</i> method.  It participates in filling the array of <i>fsm_handler_table</i> handlers along with other similar methods (there are 28 of them with names, respectively, from <i>State1</i> to <i>State28</i> ).  Here it is important to note that in addition to <i>State19</i> , warnings <a href="https://www.viva64.com/ru/w/v3009/">V3009</a> [CWE-393] were also issued for some other processors.  These are handlers: <i>State23, State26, State27, State28</i> .  Warnings issued by the analyzer for them: <br><br><ul><li>  V3009 [CWE-393] This is the true value of this method.  AWSSDK.Core.Net45 Lexer.cs 752 </li><li>  V3009 [CWE-393] This is the true value of this method.  AWSSDK.Core.Net45 Lexer.cs 810 </li><li>  V3009 [CWE-393] This is the true value of this method.  AWSSDK.Core.Net45 Lexer.cs 822 </li><li>  V3009 [CWE-393] This is the true value of this method.  AWSSDK.Core.Net45 Lexer.cs 834 </li></ul><br>  Here is the declaration and initialization of the array of handlers: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> StateHandler[] fsm_handler_table; .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PopulateFsmTables</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ fsm_handler_table = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StateHandler[<span class="hljs-number"><span class="hljs-number">28</span></span>] { State1, State2, .... State19, .... State23, .... State26, State27, State28 };</code> </pre> <br>  For completeness, let's look at the code of one of the handlers for which the analyzer had no complaints, for example, <i>State2</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">State2</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (....) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (....) { .... <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }</code> </pre> <br>  And this is how callback handlers occur: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NextToken</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { handler = fsm_handler_table[state - <span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (! handler (fsm_context)) <span class="hljs-comment"><span class="hljs-comment">// &lt;= throw new JsonException (input_char); .... } .... }</span></span></code> </pre> <br>  As you can see, the exception will be thrown if <i>false is</i> returned.  In our case, for <i>State19, State23, State26, State27,</i> and <i>State28 handlers,</i> this will never happen.  It looks suspicious.  On the other hand, as many as five handlers have a similar behavior (they always return <i>true</i> ), so perhaps it was so intended and not the result of a typo. <br><br>  Why did I stop at all this in such detail?  This situation is very indicative in the sense that a static analyzer is often only able to indicate a suspicious design.  And even a person (not a machine) who does not have sufficient knowledge of the project, having spent time studying the code, is still not able to give an exhaustive answer about the presence of an error.  The code must be studied by the developer. <br><br>  <b>Senseless checks</b> <br><br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v3022/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v3022/">V3022</a> [CWE-571] Expression 'doLog' is always true.  AWSSDK.Core.Net45 StoredProfileAWSCredentials.cs 235 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ValidCredentialsExistInSharedFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... var doLog = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (....) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { doLog = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (InvalidDataException) { doLog = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (doLog) <span class="hljs-comment"><span class="hljs-comment">// &lt;= { .... } .... }</span></span></code> </pre> <br>  Notice the <i>doLog</i> variable.  After initialization to <i>false</i> , then in the code this variable will be set to <i>true</i> in all cases.  Thus, the <i>if (doLog)</i> check is always true.  Perhaps, earlier in this method there was a branch in which no value was assigned to the <i>doLog</i> variable, then at the time of the test it could contain the value <i>false</i> obtained during initialization.  But now there is no such branch. <br><br>  Another similar error: <br><br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v3022/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v3022/">V3022</a> Expression '! Result' is always false.  AWSSDK.CognitoSync.PCL SQLiteLocalStorage.cs 353 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PutValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> result = PutValueHelper(....); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!result) &lt;= { _logger.DebugFormat(<span class="hljs-string"><span class="hljs-string">"{0}"</span></span>, @<span class="hljs-string"><span class="hljs-string">"Cognito Sync - SQLiteStorage - Put Value Failed"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { UpdateLastModifiedTimestamp(....); } .... }</code> </pre> <br>  The analyzer states that the value of the <i>result</i> variable is always <i>true</i> .  This is only possible if the <i>PutValueHelper</i> method always returns <i>true</i> .  Let's look at this method: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PutValueHelper</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (....)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (record == null) { .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } }</code> </pre> <br>  Indeed, the method returns <i>true</i> under any condition.  Moreover, the analyzer issued a warning for this method.  <b>PVS-Studio Warning:</b> <a href="https://www.viva64.com/ru/w/v3009/">V3009</a> [CWE-393] This is the odd one.  SQLiteLocalStorage.cs 1016 <br><br>  I intentionally did not give this warning earlier, when I considered other <a href="https://www.viva64.com/ru/w/v3009/">V3009</a> errors, and saved it for this case.  Thus, the analyzer was right to <a href="https://www.viva64.com/ru/w/v3022/">point</a> out the error <a href="https://www.viva64.com/ru/w/v3022/">V3022</a> in the calling code. <br><br>  <b>Copy-Paste.</b>  <b>Again</b> <br><br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v3001/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v3001/">V3001</a> There are identical sub-expressions 'this.token == JsonToken.String' for the left |  operator.  AWSSDK.Core.Net45 JsonReader.cs 343 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.token == JsonToken.ObjectEnd || <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.token == JsonToken.ArrayEnd || <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.token == JsonToken.String || <span class="hljs-comment"><span class="hljs-comment">// &lt;= this.token == JsonToken.Boolean || this.token == JsonToken.Double || this.token == JsonToken.Int || this.token == JsonToken.UInt || this.token == JsonToken.Long || this.token == JsonToken.ULong || this.token == JsonToken.Null || this.token == JsonToken.String // &lt;= )) { .... } .... }</span></span></code> </pre> <br>  Twice compare the field <i>this.token</i> with the value of the <i>JsonToken.String JsonToken</i> enumeration.  Probably one of the comparisons should contain a different enumeration value.  If so, then a serious mistake was made. <br><br>  <b>Refactoring + inattention?</b> <br><br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v3025/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v3025/">V3025</a> [CWE-685] Incorrect format.  A different number of formatted items is expected while calling 'Format' function.  Arguments not used: AWSConfigs.AWSRegionKey.  AWSSDK.Core.Net45 AWSRegion.cs 116 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InstanceProfileAWSRegion</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (region == null) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidOperationException( <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.Format(CultureInfo.InvariantCulture, <span class="hljs-string"><span class="hljs-string">"EC2 instance metadata was not available or did not contain region information."</span></span>, AWSConfigs.AWSRegionKey)); } .... }</code> </pre> <br>  Probably, the format string for the <i>string.Format</i> method previously contained the output specifier <i>{0}</i> , for which the <i>AWSConfigs.AWSRegionKey</i> argument was specified.  Then the string was changed, the specifier disappeared, but the argument was forgotten to be deleted.  The above code snippet works without errors (an exception would be thrown otherwise - a specifier without an argument), but it looks ugly.  The code should be corrected as follows: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (region == null) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidOperationException( <span class="hljs-string"><span class="hljs-string">"EC2 instance metadata was not available or did not contain region information."</span></span>); }</code> </pre> <br>  <b>Unsafe</b> <br><br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v3083/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v3083/">V3083</a> [CWE-367] Unsafe invocation of event 'mOnSyncSuccess', NullReferenceException is possible.  Consider assigning an event to a local variable before invoking it.  AWSSDK.CognitoSync.PCL Dataset.cs 827 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FireSyncSuccessEvent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(List&lt;Record&gt; records)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mOnSyncSuccess != null) { mOnSyncSuccess(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SyncSuccessEventArgs(records)); } }</code> </pre> <br>  A fairly common situation is an unsafe invocation of an event handler.  Between checking the <i>mOnSyncSuccess</i> variable for equality to <i>null</i> and calling the handler, you can unsubscribe from the event, and its value becomes zero.  The probability of such a scenario is small, but it is still better to make the code more secure: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FireSyncSuccessEvent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(List&lt;Record&gt; records)</span></span></span><span class="hljs-function"> </span></span>{ mOnSyncSuccess?.Invoke(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SyncSuccessEventArgs(records)); }</code> </pre> <br>  There are other similar errors in the code. <br><br>  <b>PVS-Studio warnings:</b> <br><br><ul><li>  V3083 [CWE-367] Unsafe invocation of event 'mOnSyncFailure', NullReferenceException is possible.  Consider assigning an event to a local variable before invoking it.  AWSSDK.CognitoSync.PCL Dataset.cs 839 </li><li>  V3083 [CWE-367] Unsafe invocation of event, NullReferenceException is possible.  Consider assigning an event to a local variable before invoking it.  AWSSDK.Core.PCL AmazonServiceClient.cs 332 </li><li>  V3083 [CWE-367] Unsafe invocation of event, NullReferenceException is possible.  Consider assigning an event to a local variable before invoking it.  AWSSDK.Core.PCL AmazonServiceClient.cs 344 </li><li>  V3083 [CWE-367] Unsafe invocation of event, NullReferenceException is possible.  Consider assigning an event to a local variable before invoking it.  AWSSDK.Core.PCL AmazonServiceClient.cs 357 </li><li>  V3083 [CWE-367] Unsafe invocation of event 'mExceptionEvent', NullReferenceException is possible.  Consider assigning an event to a local variable before invoking it.  AWSSDK.Core.PCL AmazonServiceClient.cs 366 </li><li>  V3083 [CWE-367] Unsafe invocation of event, NullReferenceException is possible.  Consider assigning an event to a local variable before invoking it.  AWSSDK.Core.PCL AmazonWebServiceRequest.cs 78 </li><li>  V3083 [CWE-367] Unsafe invocation of event 'OnRead', NullReferenceException is possible.  Consider assigning an event to a local variable before invoking it.  AWSSDK.Core.PCL EventStream.cs 97 </li><li>  V3083 [CWE-367] Unsafe invocation of event, NullReferenceException is possible.  Consider assigning an event to a local variable before invoking it.  AWSSDK.Core.Android NetworkReachability.cs 57 </li><li>  V3083 [CWE-367] Unsafe invocation of event, NullReferenceException is possible.  Consider assigning an event to a local variable before invoking it.  AWSSDK.Core.Android NetworkReachability.cs 94 </li><li>  V3083 [CWE-367] Unsafe invocation of event, NullReferenceException is possible.  Consider assigning an event to a local variable before invoking it.  AWSSDK.Core.iOS NetworkReachability.cs 54 </li></ul><br>  <b>Incomplete class</b> <br><br>  <b>PVS-Studio</b> <a href="https://www.viva64.com/ru/w/v3126/">warning</a> <b>:</b> <a href="https://www.viva64.com/ru/w/v3126/">V3126</a> Type 'JsonData' implementing the interface does not override the 'GetHashCode' method.  AWSSDK.Core.Net45 JsonData.cs 26 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JsonData</span></span></span><span class="hljs-class"> :</span></span> IJsonWrapper, IEquatable&lt;JsonData&gt; { .... }</code> </pre> <br>  The <i>JsonData</i> class contains quite a lot of code, so I didn‚Äôt cite it as a whole, limiting myself only to the declaration.  This class does not really contain the overridden method <i>GetHashCode</i> , which is not safe, as it can lead to erroneous behavior when using the <i>JsonData</i> type to work, for example, with collections.  Probably, at present there is no problem, but in the future the strategy of using this type may change.  This error is described in more detail in the <a href="https://www.viva64.com/ru/w/v3126/">documentation</a> . <br><br>  <b>Conclusion</b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">These are all the interesting errors that I managed to find in the AWS SDK code for .NET using the PVS-Studio static analyzer. </font><font style="vertical-align: inherit;">Once again I will emphasize the quality of the project. </font><font style="vertical-align: inherit;">I found a very small number of errors for 5 million lines of code. </font><font style="vertical-align: inherit;">Although it is likely that a more thorough analysis of the warnings issued would allow me to add a few more errors to this list. </font><font style="vertical-align: inherit;">But it is also very likely that I have in vain ranked some of the described warnings as errors. </font><font style="vertical-align: inherit;">In this case, only the developer who is in the context of the code being verified always makes unambiguous conclusions.</font></font><br><br><p> <a href="https://habr.com/en/company/pvs-studio/blog/437514/"><img src="https://habrastorage.org/webt/ts/z9/km/tsz9kmyjtteajhd4x1au60rsrvq.png" align="left"></a> </p><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you want to share this article with an English-speaking audience, then please use the link to the translation: Sergey Khrenov. </font></font><a href="https://habr.com/en/company/pvs-studio/blog/437514/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Amazon Web Services SDK source code for .NET</font></font></a> </div><p>Source: <a href="https://habr.com/ru/post/437516/">https://habr.com/ru/post/437516/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>