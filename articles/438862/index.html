<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Deploim isomorphic web application on the example of Nuxt.js</title>
  <meta name="description" content="In medium and large projects, the site is not limited to one service - for example, only a site, as a rule, there is a database, API, server that rout...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>Deploim isomorphic web application on the example of Nuxt.js</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/sa/ge/qb/sageqbm3jftmbtbdkftowwvwb3o.jpeg"><br>  In medium and large projects, the site is not limited to one service - for example, only a site, as a rule, there is a database, API, server that routes requests to all these services.  Rolling out and updating all this without any standardization is not easy, and scaling to multiple servers is even more difficult. <br><a name="habracut"></a><br>  Docker will help us solve this problem - it has become the de facto standard in the world of packaging, delivery and publication of applications. <br><br>  Docker allows us to wrap an application or service with all dependencies and settings in an isolated container, ensuring the consistency of the content on any platform. <br><br>  As an isomorphic application, we will use the Nuxt.js framework, which consists of Vue.js and Node.js, allowing us to write universal web applications with server-side rendering (SSR). <br><br>  This choice is due to personal preference, but in the same way you can take any other framework, for example, Next.js. <br><br><h3>  We collect and publish the first image. </h3><br>  First of all, you need to configure the port and host within the application.  There are several <a href="https://nuxtjs.org/faq/host-port">ways</a> to do this, we will use the settings in package.json, adding a new section: <br><br><pre><code class="json hljs"><span class="hljs-string"><span class="hljs-string">"config"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"nuxt"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"host"</span></span>: <span class="hljs-string"><span class="hljs-string">"0.0.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"port"</span></span>: <span class="hljs-string"><span class="hljs-string">"3000"</span></span> } }</code> </pre> <br>  For further action, we need docker, docker-compose installed on the system and an editor with an open project. <br><br>  Create a Dockerfile that we put in the root and describe the instructions for building the image. <br><br>  We need to build an image based on the Node.js version 10 image, in this case the light version of alpine is used: <br><br><pre> <code class="plaintext hljs">FROM node:10-alpine</code> </pre> <br>  Then set the environment variable with the directory name: <br><br><pre> <code class="plaintext hljs">ENV APP_ROOT /web</code> </pre> <br>  Install as a working directory and add the source: <br><br><pre> <code class="plaintext hljs">WORKDIR ${APP_ROOT} ADD . ${APP_ROOT}</code> </pre><br>  Install the dependencies and build the application: <br><br><pre> <code class="plaintext hljs">RUN npm ci RUN npm run build</code> </pre><br>  And we write the command to launch the application inside the image: <br><br><pre> <code class="plaintext hljs">CMD ["npm", "run", "start"]</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Dockerfile</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">FROM node:10-alpine ENV APP_ROOT /web ENV NODE_ENV production WORKDIR ${APP_ROOT} ADD . ${APP_ROOT} RUN npm ci RUN npm run build CMD ["npm", "run", "start"]</code> </pre><br></div></div><br>  After that, open the current folder in the terminal and collect the image: <br><br><pre> <code class="plaintext hljs">docker build -t registry.gitlab.com/vik_kod/nuxtjs_docker_example .</code> </pre><br>  Run the image locally to check that everything works correctly: <br><br><pre> <code class="plaintext hljs">docker run -p 3000:3000 registry.gitlab.com/vik_kod/nuxtjs_docker_example</code> </pre><br>  Going to <a href="http://localhost:3000/">localhost: 3000</a> we should see the following: <br><br><img src="https://habrastorage.org/webt/3m/8m/4e/3m8m4epncpbjdw0hxwfptw7rqh4.png"><br><br>  Fine!  We have successfully launched production assembly of the application on the local machine. <br><br>  Now we need to publish the image in the docker repository in order to use the ready-made image on the target server.  You can use either the self-hosted repository or any other repository, for example, the official <a href="https://hub.docker.com/">hub.docker.com</a> . <br><br>  I will use the repository in gitlab, the tab with the docker repositories there is called registry.  Previously, I have already created a repository for the project, so now I run the command: <br><br><pre> <code class="plaintext hljs">docker push registry.gitlab.com/vik_kod/nuxtjs_docker_example</code> </pre><br>  Once the image has successfully loaded, you can proceed to the configuration of the VPS server, <br>  my she has the following: <br><br><ul><li>  1 GB of RAM </li><li>  4 cores </li><li>  30 GB disk </li></ul><br>  I also took the opportunity to put docker right away when creating the server, so if it is not installed on your VPS, you can read the instructions on the <a href="https://docs.docker.com/install/">official website.</a> <br><br>  After creating the server, go to it and log in to the docker repository, in my case it is gitlab: <br><br><pre> <code class="plaintext hljs">docker login registry.gitlab.com</code> </pre><br>  After authorization, we can start applications with the command previously seen: <br><br><pre> <code class="plaintext hljs">docker run -p 3000:3000 registry.gitlab.com/vik_kod/nuxtjs_docker_example</code> </pre><br><img src="https://habrastorage.org/webt/8z/qh/su/8zqhsuvrva9zi4mgqhutiq4nwrk.png"><br><br>  The image downloaded and started, let's check: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1e4/609/85a/1e460985a476590d13d1a344c9a1a90b.png"><br><br>  We see a familiar picture, we launched the container with the application, but already on a remote server. <br><br>  The final touch remains, now when the terminal is closed, the image will be stopped, so we will add the -d attribute to start the container in the background. <br>  Stop and restart: <br><br><pre> <code class="plaintext hljs">docker run -d -p 3000:3000 registry.gitlab.com/vik_kod/nuxtjs_docker_example</code> </pre><br>  Now we can close the terminal and make sure that our application is functioning successfully. <br><br>  We have achieved the necessary - we launched the application in docker and now it is suitable for deployment, both as a standalone image and as part of a larger infrastructure. <br><br><h3>  Add reverse proxy </h3><br>  At the current stage, we can publish simple projects, but what if we need to put the application and API on the same domain, and in addition to this, give the static not through Node.js? <br><br>  Thus, there is a need for the so-called reverse proxy server, which will receive all requests and be redirected, depending on the request to related services. <br><br>  We will use nginx as such a server. <br><br>  Managing containers if there are more than one individually is not very convenient.  Therefore, we will use docker-compose as a way to organize and manage containers. <br><br>  Let's create a new empty project, in the root of which we will add the file docker-compose.yml and the nginx folder. <br><br>  In docker-compose.yml we write the following: <br><br><pre> <code class="plaintext hljs">version: "3.3" # –£–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–¥–µ–ª —Å–æ —Å–≤—è–∑–∞–Ω–Ω—ã–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏ services: # –ü–µ—Ä–≤—ã–π —Å–µ—Ä–≤–∏—Å, nginx nginx: image: nginx:latest # –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ—Ä—Ç—ã 80 –¥–ª—è http –∏ 443 –¥–ª—è https ports: - "80:80" - "443:443" # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä —Å –∏–º–µ–Ω–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ container_name: proxy_nginx volumes: # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–≤–æ–π nginx –∫–æ–Ω—Ñ–∏–≥, –æ–Ω –∑–∞–º–µ–Ω–∏—Ç –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ - ./nginx:/etc/nginx/conf.d # –ú–æ–Ω—Ç–∏—Ä—É–µ–º –ø–∞–ø–∫—É —Å –ª–æ–≥–∞–º–∏ –Ω–∞ —Ö–æ—Å—Ç –º–∞—à–∏–Ω—É –¥–ª—è –±–æ–ª–µ–µ —É–¥–æ–±–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ - ./logs:/var/log/nginx/ # –í—Ç–æ—Ä–æ–π —Å–µ—Ä–≤–∏—Å Nuxt.js –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ nuxt: # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞–Ω–µ–µ —Å–æ–±—Ä–∞–Ω–Ω—ã–π –æ–±—Ä–∞–∑ image: registry.gitlab.com/vik_kod/nuxtjs_docker_example container_name: nuxt_app # –¢–∞–∫–∂–µ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ—Ä—Ç –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –≤–∏—Å–∏—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ports: - "3000:3000"</code> </pre><br>  Add the config to the nginx folder, which is recommended by the official site <a href="https://nuxtjs.org/faq/nginx-proxy">Nuxt.js</a> , with minor changes. <br><br><div class="spoiler">  <b class="spoiler_title">nginx.conf</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">map $sent_http_content_type $expires { "text/html" epoch; "text/html; charset=utf-8" epoch; default off; } server { root /var/www; listen 80; # –ü–æ—Ä—Ç –∫–æ—Ç–æ—Ä—ã–π —Å–ª—É—à–∞–µ—Ç nginx server_name localhost; # –¥–æ–º–µ–Ω –∏–ª–∏ ip —Å–µ—Ä–≤–µ—Ä–∞ gzip on; gzip_types text/plain application/xml text/css application/javascript; gzip_min_length 1000; location / { expires $expires; proxy_redirect off; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_read_timeout 1m; proxy_connect_timeout 1m; # –ê–¥—Ä–µ—Å –Ω–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, —Ç–∞–∫ –∫–∞–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å–≤—è–∑–∞–Ω—ã –ø—Ä–∏ –ø–æ–º–æ—â–∏ # docker-compose –º—ã –º–æ–∂–µ–º –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –Ω–∏–º –ø–æ –∏–º–µ–Ω–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –≤ –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ nuxt_app proxy_pass http://nuxt_app:3000; } }</code> </pre><br></div></div><br>  Run the command to run: <br><br><pre> <code class="plaintext hljs">docker-compose up</code> </pre> <br><img src="https://habrastorage.org/webt/_e/nm/rt/_enmrtzkskhzce0dsha44ihxyde.png"><br><br>  Everything started correctly, now if we go to the address that listens to nginx, localhost, then we will see our application, there will be no visual differences, but now all requests first go to nginx where they are redirected depending on the specified rules. <br><br>  Now we have no additional services or statics, let's add a static folder in which we place some image. <br><br>  Mount it in the nginx container by adding a line to docker-compose: <br><br><pre> <code class="plaintext hljs">... container_name: proxy_nginx volumes: # –ú–æ–Ω—Ç–∏—Ä—É–µ–º –ø–∞–ø–∫—É —Å–æ —Å—Ç–∞—Ç–∏–∫–æ–π - ./static:/var/www/static ...</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Updated docker-compose.yml</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">version: "3.3" # –£–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–¥–µ–ª —Å–æ —Å–≤—è–∑–∞–Ω–Ω—ã–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏ services: # –ü–µ—Ä–≤—ã–π —Å–µ—Ä–≤–∏—Å, nginx nginx: image: nginx:latest # –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ—Ä—Ç—ã 80 –¥–ª—è http –∏ 443 –¥–ª—è https ports: - "80:80" - "443:443" # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä —Å –∏–º–µ–Ω–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ container_name: proxy_nginx volumes: # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–≤–æ–π nginx –∫–æ–Ω—Ñ–∏–≥, –æ–Ω –∑–∞–º–µ–Ω–∏—Ç –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ - ./nginx:/etc/nginx/conf.d # –ú–æ–Ω—Ç–∏—Ä—É–µ–º –ø–∞–ø–∫—É —Å –ª–æ–≥–∞–º–∏ –Ω–∞ —Ö–æ—Å—Ç –º–∞—à–∏–Ω—É –¥–ª—è –±–æ–ª–µ–µ —É–¥–æ–±–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ - ./logs:/var/log/nginx/ # –ú–æ–Ω—Ç–∏—Ä—É–µ–º –ø–∞–ø–∫—É —Å–æ —Å—Ç–∞—Ç–∏–∫–æ–π - ./static:/var/www/static # –í—Ç–æ—Ä–æ–π —Å–µ—Ä–≤–∏—Å Nuxt.js –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ nuxt: # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞–Ω–µ–µ —Å–æ–±—Ä–∞–Ω–Ω—ã–π –æ–±—Ä–∞–∑ image: registry.gitlab.com/vik_kod/nuxtjs_docker_example container_name: nuxt_app # –¢–∞–∫ –∂–µ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ—Ä—Ç –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –≤–∏—Å–∏—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ports: - "3000:3000"</code> </pre><br></div></div><br>  Then add a new location to nginx.conf: <br><br><pre> <code class="plaintext hljs">location /static/ { try_files $uri /var/www/static; }</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Updated nginx.conf</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">map $sent_http_content_type $expires { "text/html" epoch; "text/html; charset=utf-8" epoch; default off; } server { root /var/www; listen 80; # –ü–æ—Ä—Ç –∫–æ—Ç–æ—Ä—ã–π —Å–ª—É—à–∞–µ—Ç nginx server_name localhost; # –¥–æ–º–µ–Ω –∏–ª–∏ ip —Å–µ—Ä–≤–µ—Ä–∞ gzip on; gzip_types text/plain application/xml text/css application/javascript; gzip_min_length 1000; location / { expires $expires; proxy_redirect off; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_read_timeout 1m; proxy_connect_timeout 1m; # –ê–¥—Ä–µ—Å –Ω–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, —Ç–∞–∫ –∫–∞–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å–≤—è–∑–∞–Ω—ã –ø—Ä–∏ –ø–æ–º–æ—â–∏ # docker-compose –º—ã –º–æ–∂–µ–º –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –Ω–∏–º –ø–æ –∏–º–µ–Ω–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –≤ –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ nuxt_app proxy_pass http://nuxt_app:3000; } location /static/ { try_files $uri /var/www/static; } }</code> </pre><br></div></div><br>  Restart docker-compose: <br><br><pre> <code class="plaintext hljs">docker-compose up --build</code> </pre><br>  Go to <a href="">localhost / static / demo.jpg</a> <a href=""><br></a> <br><br><img src="https://habrastorage.org/webt/op/fv/op/opfvopehymnscgtysqtoxjcjzdw.png"><br><br>  Now the static is given through Nginx, removing the load from Node.js in the main application. <br><br>  Making sure that everything works, you can publish our assembly on the server.  To do this, I will create a repository in the current directory.  Pre-adding the logs and static folder to .gitignore. <br><br>  After that we go to the server, stop the previously launched docker image and clone the repository. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9ec/a7d/da4/9eca7dda43a5ed7623eb5fd12f41cdd6.png"><br><br>  Before you start the build, you need to move the folder with statics to the server, go to the terminal on the local machine and through the scp command utility move the folder to the server: <br><br><pre> <code class="plaintext hljs">scp -r /Users/vik_kod/PhpstormProjects/nuxtjs_docker_proxy_example/static root@5.101.48.172:/root/example_app/</code> </pre><br>  If the amount of static is large, it is better to first compress the folder and send it to the archive, then unpack it on the server.  Otherwise, the download may take a long time. <br><br>  We return to the terminal on the server and go to the cloned folder and run the command: <br><br><pre> <code class="plaintext hljs">docker-compose up -d</code> </pre><br>  We close the terminal and go to the site: <br><br><img src="https://habrastorage.org/webt/au/3l/yq/au3lyqjf74cr99zabxraau073m0.png"><br><br><img src="https://habrastorage.org/webt/hm/pv/id/hmpvidrp494pdol1dzf-lebt9vs.png"><br>  Fine!  Using reverse proxy, we separated the static from the application. <br><br><h3>  Further steps </h3><br>  All that we have done above is a fairly simple option, in large projects it is necessary to take into account more things, below is a short list of what can be done next. <br><br><ul><li>  Data only containers for static admins, SPA applications and databases </li><li>  Additional services for image processing and optimization, <a href="https://github.com/DarthSim/imgproxy">example</a> </li><li>  Integration of CI / CD, image assembly when pushing to the selected branch as well as automatic update and restart of services </li><li>  Creating a Kubernetes or Swarm cluster if there are more than 1 servers, for load balancing and easy horizontal scaling </li></ul><br><h3>  Total </h3><br><ul><li>  We successfully published the application to the server and prepared it for further scaling. </li><li>  We got acquainted with the docker and got an idea of ‚Äã‚Äãhow to wrap your application in a container. </li><li>  We learned what steps can be made further to improve the infrastructure. </li></ul><br><h3>  Sources </h3><br>  <a href="https://gitlab.com/vik_kod/nuxtjs_docker_example">application</a> <br>  <a href="https://gitlab.com/vik_kod/nuxtjs_docker_configs">Configs</a> <br><br>  <i>Thank you for your attention and I hope this material has helped you!</i> </div><p>Source: <a href="https://habr.com/ru/post/438862/">https://habr.com/ru/post/438862/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
</ul></nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>