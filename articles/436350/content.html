<div class="post__text post__text-html js-mediator-article"><h1>  <a href="https://attack.mitre.org/tactics/TA0007/">Part 7. Discovery</a> </h1><br>  <b>Links to all parts:</b> <br><br>  <a href="https://habr.com/post/423405/">Part 1. Getting Initial Access</a> <br>  <a href="https://habr.com/post/424027/">Part 2. Execution</a> <br>  <a href="https://habr.com/post/425177/">Part 3. Persistence</a> <br>  <a href="https://habr.com/post/428602/">Part 4. Privilege Escalation</a> <br>  <a href="https://habr.com/post/432624/">Part 5. Defense Evasion</a> <br>  <a href="https://habr.com/post/433566/">Part 6. Obtaining Credential Access</a> <br>  <a href="https://habr.com/ru/post/436350/">Part 7. Discovery</a> <br><br>  Having received, as a result of the initial compromise, the adversary must “look around” into the system, understand that he now controls what opportunities he has and whether the current access is sufficient to achieve a tactical or ultimate goal.  This stage of the attack is called “Discovery” (born <i>Discovery</i> - “scientific discovery”, “disclosure”, “disclosure”). <br><a name="habracut"></a><br>  <i>The author is not responsible for the possible consequences of the application of the information contained in the article, and also apologizes for any inaccuracies in some formulations and terms.</i>  <i>The published information is a free recount of the content of <a href="https://attack.mitre.org/wiki/Main_Page">MITER ATT &amp; CK</a> .</i> <br><br>  Operating systems have many built-in tools with which the enemy can carry out a study of the inner perimeter of the attacked network after it is compromised.  In Windows, direct interaction with the Windows API, WMI functionality and PowerShell can be used to gather information. <br><br>  The attacker uses detection methods during the study of the attacked environment, so identifying such activity should be considered as part of the attack chain, followed by attempts to move the enemy through the network. <br><br>  As a measure aimed at identifying the above described activity in the protected systems, monitoring of processes and command line arguments that can be used during the collection of information about the system or network is recommended.  A general recommendation to prevent unauthorized internal research of the protected system and network is to audit the presence of unnecessary system utilities and potentially dangerous software that can be used to study the protected environment, and use tools to block their launch, such as AppLocker or software restriction policies (Software Restriction Policies). <br><br><h3>  <a href="https://attack.mitre.org/wiki/Technique/T1087">Account Discovery</a> </h3><br>  <i>System:</i> Windows, Linux, macOS <br>  <i>Rights:</i> User <br>  <i>Description:</i> Malicious users may attempt to obtain a list of local system or domain accounts. <br><br>  <b>Windows</b> <br>  Utilities <i>Net</i> or <i>Dsquery</i> can be used to obtain account information: <br> <code>net user <br> net group <br> net localgroup <br> dsquery user <br> dsquery group</code> <br> <br>  An attacker could use <a href="https://attack.mitre.org/techniques/T1033/"><i>System Owner / User Discovery</i></a> techniques to find the main user, current user of the system, or a group of users who typically use the system. <br><br>  <b>Mac</b> <br>  On Mac, user groups can be obtained using the <i>groups</i> and <i>id</i> commands.  Also, user groups and users can be listed using the following commands: <br> <code>dscl . list /Groups <br> dscacheutile -q group</code> <br> <br>  <b>Linux</b> <br>  On Linux, local users can be obtained from the <i>/ etc / passwd file</i> , which is readable to all users.  On a Mac, the same file is used only in single user mode in addition to the <i>/etc/master.passwd</i> file.  In addition, the teams and <i>id</i> commands are also available in Linux. <br><br>  <i>Security Tips:</i> Prevent the ability to enumerate administrator accounts when elevating rights through UAC, as this will lead to the disclosure of administrator account names.  The corresponding registry key can be disabled using GPO: <br><br> <code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\CredUI\ <br> EnumerateAdministrators <br> <br> GPO: Computer Configuration &gt; [Policies] &gt; Administrative Templates &gt; Windows Components &gt; Credential User Interface: Enumerate administrator accounts on elevation.</code> <br> <br><h3>  <a href="https://attack.mitre.org/wiki/Technique/T1010">Application Window Discovery</a> </h3><br>  <i>System:</i> Windows, macOS <br>  <i>Rights:</i> User <br>  <i>Description:</i> Attackers may attempt to get lists of windows opened by applications.  Such lists may indicate how the system is used there or discover the context of the information collected by the keylogger.  On a Mac, this can be done using a small AppleScript script. <br><br><h3>  <a href="https://attack.mitre.org/wiki/Technique/T1217">Browser Bookmark Discovery</a> </h3><br>  <i>System:</i> Windows, Linux, macOS <br>  <i>Rights:</i> User <br>  <i>Description:</i> In order to learn as much information as possible about the compromised system, attackers can examine the user's browser bookmarks.  Bookmarks can reveal personal information about users (for example, banking sites, personal interests, social networks, etc.), as well as information about the internal network resources of the network — servers, tools, dashboards, and other infrastructure elements.  An adversary can use credentials cached in the browser to gain access to the user's services whose addresses are stored in browser tabs.  The storage locations for bookmarks depend on the platform and the specific application and OS.  Browser bookmarks are usually stored as local files or databases. <br><br>  <i>Protection recommendations:</i> Considering that the storage of information in files is a regular function of the OS, attempts to suppress this activity will be inappropriate.  For example, restricting access to browser bookmarks files is likely to result in unintended side effects and disrupt legitimate software.  Protection efforts should be directed at preventing the attacker from launching tools and tools at earlier stages of an attack. <br><br><h3>  <a href="https://attack.mitre.org/wiki/Technique/T1083">File and Directory Discovery Detection</a> </h3><br>  <i>System:</i> Windows, Linux, macOS <br>  <i>Rights:</i> User, Administrator, System <br>  <i>Description:</i> Attackers can list files and directories or search for specific information in specific locations on a host or on shared network resources. <br><br>  <b>Windows</b> <br>  Examples of utilities for obtaining information about files and directories are <i>dir</i> and <i>tree</i> .  Custom tools through direct interaction with the Windows API can also be used to collect information about files and directories. <br><br>  <b>Linux and macOS</b> <br>  On Linux and macOS, browsing files and directories is done with the <i>ls, find,</i> and <i>locate</i> commands. <br><br>  <i>Protection recommendations:</i> Considering that the presentation of information in the form of files and directories is a regular feature of the OS, attempts to suppress this activity will be inappropriate.  Protection efforts should be directed at preventing the attacker from launching tools and tools at earlier stages of an attack. <br><br><h3>  <a href="https://attack.mitre.org/wiki/Technique/T1046">Network Service Scanning</a> </h3><br>  <i>System:</i> Windows, Linux, macOS <br>  <i>Rights:</i> Administrator, System <br>  <i>Description:</i> Attackers may attempt to obtain a list of services running on remote hosts, including those that may be vulnerable to remote access tools.  Methods for obtaining such information include scanning ports and vulnerabilities using tools that are loaded into the system. <br><br>  <i>Security</i> Tips <i>:</i> Use IDS / IPS systems to detect and prevent remote scans.  Ensure that unnecessary ports are closed, unused services are disabled, and proper network segmentation is followed to protect critical servers and devices. <br><br><h3>  <a href="https://attack.mitre.org/wiki/Technique/T1135">Network Share Discovery (Network Share Discovery)</a> </h3><br>  <i>System:</i> Windows, macOS <br>  <i>Rights:</i> User <br>  <i>Description:</i> Local networks often have shared network drives and folders that allow users to access file directories hosted on different systems over the network.  Attackers can search for shared network folders and drives in remote systems in order to search for targeted data sources and identify potential systems for further promotion on the network. <br><br>  <b>Windows</b> <br>  File exchange in Windows-based networks using the SMB protocol.  The <i>Net</i> utility can be used to obtain information from a remote system on the presence of shared network drives in it: <code>net view \remotesystem</code> <br>  Or getting information about shared network drives on the local system: <code>net share</code> . <br><br>  <b>Mac</b> <br>  On a Mac, locally-mounted network shares can be viewed using the command: <code>df -aH</code> . <br><br><h3>  <a href="https://attack.mitre.org/wiki/Technique/T1040">Network Sniffing</a> </h3><br>  <i>System:</i> Windows, Linux, macOS <br>  <i>Description: An</i> attacker can use the network interface in <i>promiscuos mode</i> ("promiscuous" mode), in which the network card will accept all packets regardless of whom they are addressed to or use span ports (mirroring ports) to capture large amounts of data transmitted over wired or wireless networks. <br><br>  Data captured during sniffing may contain credentials sent via unprotected connections without using encryption protocols.  Various attacks on network name service such as poisoning LLMNR / NBT-NS by redirecting traffic can also be used to collect credentials on websites, proxy servers and internal systems.  While listening to the network, the adversary can also reveal various configuration information (running services, version numbers, IP addresses, host names, VLAN ID, etc.) necessary for further network propagation and / or circumvention of security features. <br><br>  <i>Security Tips:</i> Ensure that the wireless traffic is properly encrypted.  If possible, use Kerberos, SSL and multifactor authentication.  Monitor network switches for use of span ports, ARP / DNS poisoning, and unauthorized configuration changes to the router.  Use tools to detect and block potentially dangerous software that can be used to intercept and analyze network traffic. <br><br><h3>  <a href="https://attack.mitre.org/wiki/Technique/T1201">Password Policy Discovery</a> </h3><br>  <i>System:</i> Windows, Linux, macOS <br>  <i>Rights:</i> User <br>  <i>Description:</i> Password policy on the network is a way for users to use complex passwords that are difficult to guess or crack by brute force.  An attacker may try to access information about the password policy settings of the attacked network in order to create a list of common well-known passwords that meet the requirements of the policy (for example, if the policy sets a minimum password length of 8 characters, do not try to use pass123 passwords or check more than 3 4 passwords per account, if the number of unsuccessful attempts is 6) and the subsequent start of the selection of passwords in the dictionary.  Password policies can be applied and detected both in Windows and in Linux and macOS. <br><br>  <b>Windows</b> <br> <code>net accounts <br> net accounts /domain</code> <br> <br>  <b>Linux</b> <br> <code>chage -l <br> cat /etc/pam.d/comman-password</code> <br> <br>  <b>macOS</b> <br> <code>pwpolicy getaccountpolicies</code> <br> <br>  <i>Security Tips:</i> Attempts to directly obstruct the identification of a password policy are not recommended, since the password policy settings should be known to all systems and users of the network.  Make sure that the password policy you use makes it difficult to brute force passwords and prevent using too light passwords.  The most common way to use password policy in a corporate network is to implement Active Directory. <br><br>  If there is a task to detect malicious activity, monitor the processes for the presence of tools and command line arguments that indicate attempts to detect the password policy.  Match this activity with other suspicious actions of the source system to reduce the likelihood of a false event associated with the actions of the user or administrator.  The enemy is likely to try to identify the parameters of the password policy in the early stages of the attack or in conjunction with the use of other techniques of the detection and review stages. <br><br><h3>  <a href="https://attack.mitre.org/wiki/Technique/T1120">Peripheral Device Discovery (Peripheral Device Discovery)</a> </h3><br>  <i>System:</i> Windows <br>  <i>Rights:</i> User, Administrator, System <br>  <i>Description:</i> Attackers may attempt to gather information about peripherals connected to computers in the attacked network.  This information can be used to raise awareness of the attacked environment and to use it when planning further malicious actions. <br><br><h3>  <a href="https://attack.mitre.org/wiki/Technique/T1069">Permission Groups Discovery</a> </h3><br>  <i>System:</i> Windows, Linux, macOS <br>  <i>Rights:</i> User <br>  <i>Description:</i> Attackers can try to find local or domain access groups and investigate the parameters of their permissions. <br><br>  <b>Windows</b> <br>  You can list access groups using the <i>Net</i> utility: <br> <code>net group /domain <br> ner localgroup</code> <br> <br>  <b>Linux</b> <br>  In Linux, local groups can be listed using the <i>groups</i> command, domain groups can be listed using the <i>ldapsearch</i> command. <br><br>  <b>macOS</b> <br>  On a Mac, you can do the same with the following commands: <br>  <code>dscacheutil -q</code> - for domain groups; <br> <code>dscl . -list /Groups</code>  <code>dscl . -list /Groups</code> - for local groups. <br><br><h3>  <a href="https://attack.mitre.org/wiki/Technique/T1057">Process Discovery</a> </h3><br>  <i>System:</i> Windows, Linux, macOS <br>  <i>Rights:</i> User, Administrator, System <br>  <i>Description:</i> Opponents may attempt to obtain information about the processes launched from the system in order to obtain information about the software running on the systems of the attacked network. <br><br>  <b>Windows</b> <br>  An example of a way to get information about processes in Windows is the system <i>tasklist</i> utility. <br><br>  <b>Mac and Linux</b> <br>  On Mac and Linux, this is done using the <i>ps</i> command. <br><br><h3>  <a href="https://attack.mitre.org/wiki/Technique/T1012">Registry queries (Query Registry)</a> </h3><br>  <i>System:</i> Windows <br>  <i>Rights:</i> User, Administrator, System <br>  <i>Description:</i> Attackers can interact with the Windows registry to gather information about the system, configuration, and installed software.  The registry contains a significant amount of information about the operating system, configuration, software and security.  Some information may help the enemy in conducting further operations in the attacked network.  The interaction with the registry can occur using various utilities, for example, <i>Reg</i> or by running third-party tools that use the Windows API. <br><br><h3>  <a href="https://attack.mitre.org/wiki/Technique/T1018">Remote System Discovery</a> </h3><br>  <i>System:</i> Windows, Linux, macOS <br>  <i>Rights:</i> User, Administrator, System <br>  <i>Description: An</i> adversary is likely to attempt to get a list of systems on the attacked network.  Remote systems can be detected by IP address, host name, or other identifier, which can later be used to move an attacker through the network from the current system.  Corresponding functionality can be included in Remote Access Tools (RAT), and built-in system utilities can also be used. <br><br>  <b>Windows</b> <br>  <i>Ping</i> or <i>net view</i> commands. <br><br>  <b>Mac</b> <br>  For detection of Mac systems within a broadcast domain (broadcast domain), <i><a href="https://ru.wikipedia.org/wiki/Bonjour">Bonjour</a></i> protocol is used.  Utilities such as <i>ping</i> can also be used to collect information about remote systems. <br><br>  <i>Linux</i> <br>  Utilities such as ping can also be used to collect information about remote systems. <br><br><h3>  <a href="https://attack.mitre.org/wiki/Technique/T1063">Security Software Discovery Detection</a> </h3><br>  <i>System:</i> Windows, macOS <br>  <i>Rights:</i> User, Administrator, System <br>  <i>Description:</i> Attackers can try to get lists of security software, configurations, sensors installed in the system.  The purpose of the enemy can be such things as local firewall rules, antivirus and virtualization tools.  These checks can be embedded in remote access tools (RAT) used in the early stages of an attack. <br><br>  <b>Windows</b> <br>  Examples of commands that can be used to obtain information about security tools are the <i>netsh, reg query, dir,</i> and <i>tasklist utilities</i> , but other more specific tools can be used to identify the specific security systems that the adversary is looking for. <br><br>  <b>Mac</b> <br>  A common way to check for malware is to use the <i>LittleSnitch</i> and <i>KnockKnock programs</i> . <br><br><h3>  <a href="https://attack.mitre.org/wiki/Technique/T1082">System Information Discovery</a> </h3><br>  <i>System:</i> Windows, Linux, macOS <br>  <i>Rights:</i> User <br>  <i>Description: An</i> adversary may attempt to obtain detailed information about the operating system and hardware, including the architecture, version, fixes, and installed service packs. <br><br>  <b>Windows</b> <br>  Examples of utilities for getting system information are <i>ver, systeminfo,</i> and <i>dir</i> for identifying system information based on existing files and directories. <br><br>  <b>Mac</b> <br>  The <i>systemsetup</i> command provides detailed system information, but it requires administrative privileges.  In addition, a detailed breakdown of configurations, firewall rules, connected volumes, equipment, and many other things without the need for privilege escalation is <i>provided by system_profiler</i> . <br><br><h3>  <a href="https://attack.mitre.org/wiki/Technique/T1016">Network Configuration Configuration Discovery (System Network Configuration Discovery)</a> </h3><br>  <i>System:</i> Windows, Linux, macOS <br>  <i>Rights:</i> User <br>  <i>Description: An</i> attacker is most likely to look for detailed information about the network configuration and the parameters of the systems to which he has access or through the study of remote systems.  Some utilities designed to administer the operating system can be used to collect the above information.  Examples of such utilities are <i>arp, ipconfig / ifconfig, nbtstat, route, tracert / tracerout</i> , etc. <br><br><h3>  <a href="https://attack.mitre.org/wiki/Technique/T1049">Network Connections Discovery (System Network Connections Discovery)</a> </h3><br>  <i>System:</i> Windows, Linux, macOS <br>  <i>Rights:</i> User, Administrator <br>  <i>Description:</i> Attackers can attempt to get a list of incoming and outgoing network connections of the compromised system to which they have access, or of the remote system, requesting information over the network. <br><br>  <b>Windows</b> <br>  Utilities and commands for getting information about network connections: <br> <code>Netstat <br> net use <br> net session</code> <br> <br>  <b>Mac and Linux</b> <br>  <i>Netstat</i> and <i>lsof</i> can be used to display current connections.  Similar to the " <i>net session</i> ", the <i>who</i> and <i>w</i> utilities can display current logged users. <br><br><h3>  <a href="https://attack.mitre.org/wiki/Technique/T1033">Detection of the owner / user of the system (System Owner / User Discovery)</a> </h3><br>  <i>System:</i> Windows, Linux, macOS <br>  <i>Rights:</i> User, Administrator <br>  <i>Description:</i> Malefactors can try to identify the main user of the system, the current user who is currently registered, a group of users who usually use the system or determine how actively the user uses the system.  An adversary can obtain the above information through the methods of identifying accounts (see the “Account Discovery” technique) or by using <a href="https://attack.mitre.org/techniques/T1003/">Dumping credentials methods</a> .  Information about the user and his name is distributed throughout the system — included in the information on owners of processes, files and directories, in session information and system logs, so an adversary can use various detection methods. <br>  In Mac, the current user can be identified using the <i>users, w</i> and <i>who</i> utilities.  In linux systems, only with <i>w</i> and <i>who</i> . <br><br><h3>  <a href="https://attack.mitre.org/wiki/Technique/T1007">System Service Discovery</a> </h3><br>  <i>System:</i> Windows <br>  <i>Rights:</i> User, Administrator, System <br>  <i>Description: An</i> attacker may attempt to obtain information about registered services.  To collect data, the adversary can use various tools, including built-in utilities that can get information about services: <br> <code>sc <br> tasklist /svc <br> net start</code> <br> <br><h3>  <a href="https://attack.mitre.org/wiki/Technique/T1124">System Time Discovery (System Time Discovery)</a> </h3><br>  <i>System:</i> Windows <br>  <i>Rights:</i> User <br>  <i>Description: The</i> system time is set in the domain and stored by the Time Service (Windows Times Service) to ensure time synchronization between systems and services in the enterprise network.  An attacker can get the system time and / or time zone from a local or remote system.  This information can be collected in several ways: <br>  <code>net time \\hostname</code> — get host system time; <br>  <code>w32tm /tz</code> - getting time zone. <br>  Information on system time can be useful for the adversary to use various attack methods, such as executing a file with a scheduled task or, based on information about the time zone, to disclose the location of the victim. <br><br>  <i>Protection</i> Tips <i>:</i> Benign software uses legitimate processes to collect system time.  Security efforts need to be directed at preventing the execution of unwanted or unknown code in the system.  In order to prevent unauthorized receipt of time information from a remote system, tools such as the <i>Net</i> utility can be blocked by a security policy.  Monitoring the command line can be useful for detecting instances of Net.exe or other utilities used to collect system time and time zone.  Monitoring API calls for these purposes is less useful due to the fact that the API is often used by legitimate software. </div>