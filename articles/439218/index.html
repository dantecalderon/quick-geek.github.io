<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>VC bot on the knee, or how to please people February 14</title>
  <meta name="description" content="Of course, each of us loves gifts, but most of all we love the wishes that accompany them. And, until recently, we did not have the opportunity to ple...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>VC bot on the knee, or how to please people February 14</h1><div class="post__text post__text-html js-mediator-article">  Of course, each of us loves gifts, but most of all we love the wishes that accompany them.  And, until recently, we did not have the opportunity to pleasantly surprise a person with warm words until the idea came to mind: what if we give people the opportunity to exchange valentines (on February 14, on the nose, after all) without leaving the framework of the usual way chat - social network chat? <br><br>  Word for word, and here it is - a ready-made business plan for creating an atmosphere of the Valentine's Day holiday!  Make people happy? <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/dl/mp/13/dlmp134rko91zu7m-evwm5mlhem.jpeg" width="70%"></div><br><a name="habracut"></a><h2>  For an idea on the moon! </h2><br>  Of course, first of all it was necessary to draw up a plan of action and describe the idea.  Due to the fact that people have become more shy, and are not always ready to trust anyone, the choice fell on writing a fashionable and convenient bot for VK, which has a familiar interface, will always be at hand, and the anonymity of the messages will be fixed in the program code. <br>  Unfortunately, in addition to all the above advantages, the communities have two disadvantages: low bandwidth (number of messages per second) and a ban on starting a dialogue with a random user (the user must be the <b>first</b> <b>to</b> express his consent to receive messages on behalf of the community). <br><br>  So, we have a user who is ready to send a valentine to his soulmate, a recipient and an intermediary in the form of a chat bot.  The interaction scheme is simple, the bot should: suggest sending ‚Üí know the recipient ‚Üí save until February 14 ‚Üí deliver ‚Üí repeat. <br><br>  But this, of course, was not enough for the gluttonous imagination of the mind, and, in order to increase the activity and involvement of the audience, a scheme of a different interaction was considered, allowing people to meet inside the system, sending messages to random people.  These ‚Äúrandom valentines‚Äù can be appreciated, and if the valentines of two people like each other, we give them the opportunity to talk. <br><br><h4>  Disclaimer </h4><br>  <i>This project was created purely on enthusiasm by two people, a programmer (a <s>lesson)</s> (me) and an ideological inspirer (Stepan <a href="https://habr.com/ru/users/sadfun/" class="user_link">sadfun</a> Popov), does not carry the purpose of teaching you something (although it can help you understand the essence of the universe), only tell an interesting story of creation and follow the path from idea to naive implementation.</i> <br><br><hr><br><h2>  Learning to talk with VK </h2><br>  After <b>going</b> through 3-4 different libraries for the <b>‚ÄúNodeJS VK API‚Äù</b> request, I realized that there are no simple and functional libraries that allow using promises, as well as working through execute.  Remember one of the problems described above?  Yes, the execution of requests to VKontakte indirectly, but in batches of 25, allows us <b>to</b> increase the capacity <b>at times</b> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/v3/fl/bp/v3flbpnqymqn0wy51ohjddwenmo.png" width="70%"></div><br>  <i>Comparative ability of various methods of requests to VK</i> <br><br>  Therefore, it was decided to write something of their own, reliable and not very crutch decision, based on the <b>node-fetch</b> library. <br><br>  In order not to give all the code here, just describe the logic of the work. <br><br>  Since requests from the program need to be packaged into one execute, they are collected in a LIFO queue, and then sent if: <br><br><ul><li>  Calls 25 or more (maximum execute) </li><li>  Enough time has passed since the last dispatch, no less than 50 milliseconds, but no more than 150 (so that the queue moved, despite the small size) </li></ul><br>  Requests from the queue are assembled into the VK Script code, which (in this implementation) looks like this: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> returnables = []; returnables[<span class="hljs-number"><span class="hljs-number">0</span></span>] = API.messages.send({<span class="hljs-string"><span class="hljs-string">"message"</span></span>: <span class="hljs-string"><span class="hljs-string">"–ü—Ä–∏–≤–µ—Ç, –•–∞–±—Ä!"</span></span>, <span class="hljs-string"><span class="hljs-string">"peer_id"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"random_id"</span></span>: <span class="hljs-number"><span class="hljs-number">561427</span></span>}); returnables[<span class="hljs-number"><span class="hljs-number">1</span></span>] = API.users.get({<span class="hljs-string"><span class="hljs-string">"user_ids"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"fields"</span></span>: <span class="hljs-string"><span class="hljs-string">"sex"</span></span>}); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> returnables;</code> </pre> <br>  After executing the code with a request to VK, the result of each request (at the index <i>returnables</i> ) is returned to its callback, beautifully wrapped in Promise.  The effectiveness of the approach is off the scale - the <b>more</b> users (and, therefore, more requests to VKontakte to send), the <b>lower the</b> response delay.  In order to keep the limit under control, there is a counter in the dispatch system that shows the number of remaining requests for that second, which allows you to quickly process a surge of visitors. <br><br><h2>  Learning to listen to VK </h2><br>  There are two ways to receive notifications about events from VKontakte: <b>Longpoll-requests</b> and <b>Callback-server</b> .  Your server is convenient because it does not require special gestures to use, and also allows you to receive missed notifications (for example, when you restart the server).  Such a server can be written in several lines using the native <b>http.Server</b> class. <br><br>  All this creates an ideal ecosystem for the logic of the program, which is convenient to use. <br><br><h2>  Everything ever ends </h2><br>  Since the user is free to do anything in the chat, and we are not able to stop him, we need to restrict him to a reasonable framework.  The state machine perfectly copes with this, setting every possible transition inside the system, and using buttons (the <b>keyboard</b> parameter in messages.send) will make using the bot as simple as one touch of the screen. <br><br>  Here is a diagram of user interaction with the bot: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sz/1o/fw/sz1ofwuethupwaiet4syf6ahl4u.png"></div><br>  All this turns into a set of states ("Main Menu", "Valentine's Input" and so on), the transitions between which are set and transmitted in the buttons, or are known initially and do not change. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cq/dz/ml/cqdzmlalb1t2o-xpdet5mvfnnek.png"></div><br>  By the way, about the buttons.  Their color range is non-variable ( <b>4 colors</b> for all occasions), but it is the buttons that make keeping the number of user errors to a minimum.  On their basis, you can build absolutely any non-linear system, which is why they are used everywhere.  And in this project too. <br><br>  But you need to understand: if you are aiming at a large audience reach, you should consider another way of interaction, because someone may have an old application ( <b>VK for iPad</b> , for example, has not been updated for a very long time, I will not lie, but it seems more than a year and keyboard support is not there).  And it happens (yes, it happens, I checked) that people, not understanding that buttons can be pressed, simply rewrite their contents (and then the parameter of the payload button, of course, is not transmitted, and everything can break). <br><br>  It should be noted that not everything is as smooth as described in the diagram, and sometimes funny cases occur.  For example, the VKontakte link detection system incorrectly handled users whose short links began with <b>id</b> , and cut it off.  The surprise of the people who met with this bug cannot be described, because they wrote Valentine Valentine, but it turned out that Olezhka. <br><blockquote>  <b>What Olezhka ????</b> </blockquote><h2>  Accidents are not accidental </h2><br>  So, if everything is clear with ordinary valentines, there is a recipient and a sender, then how to bring two strangers together?  We need to exchange them with valentines, and if people like each other's valentines, they should be introduced!  Here it is, the formula of love! <br><br>  Although it sounds pathetic, but it works, and it becomes more interesting for people to work with the bot - they will get a positive response if there is at least one person (which, of course, the bot will take care of). <br><br>  This results in a big plus - the more people take advantage of this opportunity, the more chances they will get to know each other, and consequently, this, like a game, keeps a person in the chat.  It is worth admitting that the session of an average user is ~ 7 minutes, here there is the potential to tighten a person by <b>10-15</b> just for the sake of this feature. <br><br>  The message sending itself made a separate scheme, since there are several options for using this bot, the user can lose sight of something, and the bot reminds him of this neatly. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/pj/8a/bw/pj8abwsu2zjmkhotgiffi0jldse.jpeg"></div><br>  It is interesting how the second problem was solved, with the inability of the community to be the first to initiate a dialogue with the user: now this problem is solved with such a message. <br><blockquote>  But I have a condition!  For the recipient to receive your valentine, he must also write to me.  Your task now is to persuade him to write me something.  This is done so that you do not have the fear of talking to him! </blockquote>  In general, the traditional ‚ÄúNo, bug, but feature!‚Äù <br><br><h2>  Fireworks at the end </h2><br>  Actually, that's all!  If you do not take into account some difficulties in understanding the logic of the VK API, as well as confirming the account with one of the providers, everything went too smoothly. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/-7/gb/yt/-7gbythuuwaf87k6c-v4k5-shok.png"></div><br>  <i>Sample chat with bot</i> <br><br>  The bot works and will please people with valentines, making them happy.  This is done to help people be kinder to each other.  Rate it all you can personally in the community <a href="http://vk.com/verylovebot">Valentinych - vk.com/verylovebot</a> , if you wish.  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/439218/">https://habr.com/ru/post/439218/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>