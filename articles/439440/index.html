<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Implementation of Zimbra Collaboration Open Source, authorization through AD and automatic creation of mailboxes</title>
  <meta name="description" content="1. Baseline 
 Server OS : CentOS 7 

 About the OS  In fact, the difference between CentOS7 and any other system will be solely in the commands to the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>Implementation of Zimbra Collaboration Open Source, authorization through AD and automatic creation of mailboxes</h1><div class="post__text post__text-html js-mediator-article"><h3>  1. Baseline </h3><br>  <i>Server OS</i> : CentOS 7 <br><br><div class="spoiler">  <b class="spoiler_title">About the OS</b> <div class="spoiler_text">  In fact, the difference between CentOS7 and any other system will be solely in the commands to the server to install dependencies, and possibly the location of some files.  The work is carried out mainly with Zimbra cmdlets, so the configuration differences will be minimal. <br></div></div><br>  <i>Windows domain</i> : home.local <br>  <i>Address and name of the mail server</i> : 10.40.0.80 / zimbramail.home.local <br>  <i>User to access the AD directory</i> : ZimbraLDAP with password qwe123 <br><br><h3>  2. Pitfalls </h3><br>  The Zimbra installation process itself is fairly simple.  You need to install the dependent packages, download the archive, run the script and correctly answer the installer's questions.  But, as elsewhere, there are some small difficulties. <br><br>  1) Zimbra is sensitive to hostname.  The first thing to do before installing is to bring the / etc / hosts file to the form: <br><br><pre><code class="bash hljs">127.0.0.1 localhost.localdomain localhost 10.40.0.80 zimbramail.home.local zimbramail</code> </pre> <br>  2) Without access to the internet miracle will not happen.  If there is no access to the Internet, the script will hang for 20-40 minutes, and as a result, of course, it will end with an error.  It would seem, why do we need a mail server without access to the Internet, but "what just does not happen in the sublunary world." <br><a name="habracut"></a><br><h3>  3. Directly installation </h3><br>  So, to the point! <br><br>  1) Installing dependencies: <br><br><pre> <code class="bash hljs">$ yum install perl perl-core ntpl nmap sudo libidn gmp libaio libstdc++ unzip sysstat sqlite wget</code> </pre> <br>  2) Download archive: <br><br><pre> <code class="bash hljs">$ wget https://files.zimbra.com/downloads/8.8.11_GA/zcs-8.8.11_GA_3737.RHEL7_64.20181207111719.tgz</code> </pre> <br>  3) Unzip the downloaded archive, go to the directory and start the installation: <br><br><pre> <code class="bash hljs">$ tar ‚Äìxzf zcs-8.8.11_GA_3737.RHEL7_64.20181207111719.tgz $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> zcs-8.8.11_GA_3737.RHEL7_64.20181207111719 $ ./install.sh --platform-override</code> </pre> <br>  4) Agree with the license agreement and use of the Zimbra repository: <br><br><pre> <code class="bash hljs">Do you agree with the terms of the software license agreement? [N] Y Use Zimbra<span class="hljs-string"><span class="hljs-string">'s package repository [Y] Y</span></span></code> </pre> <br>  5) Select the necessary components and confirm the change: <br><br><div class="spoiler">  <b class="spoiler_title">Text output</b> <div class="spoiler_text"><pre> <code class="bash hljs">Select the packages to install Install zimbra-ldap [Y] Y Install zimbra-logger [Y] Y Install zimbra-mta [Y] Y Install zimbra-dnscache [Y] N Install zimbra-snmp [Y] Y Install zimbra-store [Y] Y Install zimbra-apache [Y] Y Install zimbra-spell [Y] Y Install zimbra-memcached [Y] Y Install zimbra-proxy [Y] N The system will be modified. Continue? [N] Y</code> </pre> </div></div><br>  6) Next you need to enter the administrator password for Zimbra: <br><br><div class="spoiler">  <b class="spoiler_title">Text output</b> <div class="spoiler_text"><pre> <code class="bash hljs">Main menu 1) Common Configuration: 2) zimbra-ldap: Enabled 3) zimbra-logger: Enabled 4) zimbra-mta: Enabled 5) zimbra-snmp: Enabled 6) zimbra-store: Enabled +Create Admin User: yes +Admin user to create: admin@zimbramail.home.local ******* +Admin Password UNSET +Anti-virus quarantine user: virus-quarantine.2hwbbw7msh@zimbramail.ciam.local +Enable automated spam training: yes +Spam training user: spam.jedk1fhggz@zimbramail.home.local +Non-spam(Ham) training user: ham.y4nb2o4bt@zimbramail.home.local +SMTP host: zimbramail.home.local +Web server HTTP port: 8080 +Web server HTTPS port: 8443 +Web server mode: https +IMAP server port: 7143 +IMAP server SSL port: 7993 +POP server port: 7110 +POP server SSL port: 7995 +Use spell check server: yes +Spell server URL: http:// zimbramail.home.local :7780/aspell.php +Enable version update checks: TRUE +Enable version update notifications: TRUE +Version update notification email: admin@zimbramail.home.local +Version update <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> email: admin@zimbramail.home.local +Install mailstore (service webapp): yes +Install UI (zimbra,zimbraAdmin webapps): yes 7) zimbra-spell: Enabled 8) zimbra-proxy: Enabled 9) Default Class of Service Configuration: s) Save config to file x) Expand menu q) Quit Address unconfigured (**) items (? - <span class="hljs-built_in"><span class="hljs-built_in">help</span></span>) 6 Select, or <span class="hljs-string"><span class="hljs-string">'r'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> previous menu [r] 4 Password <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> admin@example.com (min 6 characters): [MFSPcRW18] qwe123</code> </pre> <br></div></div><br>  The rest of this menu does not particularly interest us.  But.  By default, Zimbra will create its own internal domain in the image of its zmhostname (read hostname), that is, it will be the zimbramail.home.local domain.  I am satisfied with this option, if you are not, and the domain name should strictly correspond to [home.local], I recommend immediately changing the receiving addresses of Version update notification and Version update source to admin@home.local <br><br>  7) Here you need to press the [a] button to apply the changes, then agree to saving the configuration to a file and press [Enter] again to continue the installation. <br><br>  The system did not freeze after the word ‚Äúdone‚Äù, it waits for the key to be pressed. <br><br><div class="spoiler">  <b class="spoiler_title">Text output</b> <div class="spoiler_text"><pre> <code class="bash hljs">Select from menu, or press <span class="hljs-string"><span class="hljs-string">'a'</span></span> to apply config (? - <span class="hljs-built_in"><span class="hljs-built_in">help</span></span>) a Save configuration data to a file? [Yes] Save config <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> file: [/opt/zimbra/config.10925] Saving config <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> /opt/zimbra/config.10925...done.</code> </pre> <br></div></div><br>  Next comes the installation script, after which it offers to press any key to continue <br><br>  8) After the installation is completed, you need to open the necessary ports in the firewall.  A list of ports can be found in the developer‚Äôs wiki by <a href="https://wiki.zimbra.com/wiki/Ports">reference.</a> <br><br>  9) I strongly recommend also to make sure that Zimbra understood everything correctly, and her zmhostname matches the hostname of the server: <br><br><pre> <code class="bash hljs">$ su ‚Äì zimbra $ zmhostname zimbramail.home.local</code> </pre> <br>  If the name does not match, do the following: <br><br>  a) first of all, we check if DNS A and MX records are in our new zmhostname, if not, create them <br><br>  b) <pre> <code class="bash hljs">$ su ‚Äì zimbra /opt/zimbra/libexec/zmsetservername -n [servername]</code> </pre> <br>  c) clean zmloggerhostmap: <br><br><pre> <code class="bash hljs">$ zmloggerhostmap</code> </pre> <br>  This command lists all Hostname Map. <br><br>  Delete with the command: <br><br><pre> <code class="bash hljs">$ zmloggerhostmap -d localhost localhost.localdomain</code> </pre> <br>  where localhost and localhost.localdomain need to be replaced with a string from the Hostname Map list <br>  then restart Zimbra <br><br>  10) Start the server: <br><br><pre> <code class="bash hljs">$ su ‚Äì zimbra $ zmcontrol start</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Text output</b> <div class="spoiler_text"><pre> <code class="bash hljs"> Host zimbramail.home.local Starting zmconfigd...Done. Starting logger...Done. Starting mailbox...Done. Starting memcached...Done. Starting proxy...Done. Starting amavis...Done. Starting antispam...Done. Starting antivirus...Done. Starting opendkim...Done. Starting snmp...Done. Starting spell...Done. Starting mta...Done. Starting stats...Done. Starting service webapp...Done. Starting zimbra webapp...Done. Starting zimbraAdmin webapp...Done. Starting zimlet webapp...Done.</code> </pre> </div></div><br>  Now the server is available at <a href="https://zimbramail.home.local:7071/">https: //zimbramail.home.local: 7071</a> <br><br><img src="https://habrastorage.org/webt/t7/qh/w1/t7qhw1k1h7tdf5lm0gnblup-lsu.png" alt="image"><br><br>  11) To enable access to the server both via https and http do the following: <br><br><pre> <code class="bash hljs">$ su ‚Äì zimbra $ zmtlsctl both $ zmcontrol restart</code> </pre> <br>  12) For those who do not have access to the Internet, or if the server lives behind NAT, you will need to also register the command: <br><br><pre> <code class="bash hljs">$ su ‚Äì zimbra $ zmprov ms mail.example.com zimbraMtaLmtpHostLookup native $ zmcontrol restart</code> </pre> <br>  zmprov is a utility for managing server settings, we still need it when we need to configure automatic mailbox creation <br><br>  13) The problem with the self-signed certificate is solved by importing the certificate from the Zimbra server: <br><br><pre> <code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /opt/zimbra/ssl/zimbra/ca $ openssl x509 -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ca.pem -outform DER -out ~/zimbra-mail-example.cer</code> </pre> <br>  with the subsequent export to its client machines or hands, or domain group policies, by installing the certificate in "Trusted Root Certification Authorities". <br>  This completes the installation and initial setup. <br><br><h3>  4. Configure authorization via LDAP </h3><br>  First of all, you need to create a user in AD to access the directory.  I have this ZimbraLDAP, then go to the administrator console via the web and set up authorization in the zimbramail.home.local domain. <br><br>  1) Go to "setup" - "domains", PCM by domain name - "configure authentication": <br><br><img src="https://habrastorage.org/webt/4h/hr/d6/4hhrd6ngquye27u1jtwzxezcqsg.png" alt="image"><br><br>  2) Select ‚ÄúExternal Active Directory‚Äù, click next: <br><br><img src="https://habrastorage.org/webt/l_/93/27/l_9327lzaznyddgwig2hd4ln_zm.png" alt="image"><br><br>  3) In the "Domain Name AD" field, enter the domain name, in the "ldap: //" field, write the domain name or the domain controller name, or the IP domain controller.  I have several controllers, so I am writing a domain name.  Port left unchanged.  Click next: <br><br><img src="https://habrastorage.org/webt/_w/nr/in/_wnrinlayfmmet_1q2gmqzwaak8.png" alt="image"><br><br>  4) Leave the LDAP binding unchanged. <br><br>  5) Authentication configuration summary.  ZimbraLDAP username, password qwe123.  Click the button "test": <br><br><img src="https://habrastorage.org/webt/sr/he/vu/srhevudbaivqyvrlvzki4extyvs.png" alt="image"><br><br>  Setting up an external group is responsible for exactly where in AD Zimbra will look for users and which filters it will apply.  You can apply the filter: <br><br><pre> <code class="bash hljs">(&amp;(objectClass=user)(objectClass=person))</code> </pre> <br>  in this case, only objects AD "users" and "persons" will be selected.  And the External Group LDAP Search Base parameter will not be used, it will be replaced with ‚Äú <b>zimbraAutoProvLdapSearchBase</b> ‚Äù during the configuration of the EAGER mode. <br><br>  Now users will be logged in using their passwords from AD.  And even when creating a new mailbox, the password will not be set. <br><br><h3>  5. Setting up automatic mailbox creation </h3><br>  <i>A bit of theory:</i> <br><br>  Zimbra can in 3 options for creating boxes: <br><br>  <b>EAGER</b> - fully automatic, which, at regular intervals, scans AD and creates mailboxes for new users. <br><br>  <b>LAZY</b> - semi-automatic, which creates a mailbox when the user first logs on to the mail server under domain credentials. <br><br>  <b>MANUAL</b> - manual search and selection of accounts for which you want to create mailboxes. <br><br>  For obvious reasons, the MANUAL mode is suitable only for small companies with a sluggish turnover of personnel.  LAZY-mode is suitable for using mail with a web-interface, without connecting an email client.  I was not satisfied with both options, since the task was to automate to the maximum (automatic installation of the Zimbra Desktop client application, so that the user just needed to enter the login password and get access to the mail).  Therefore, only EAGER.  Yes, it is more convenient, to be honest. <br><br>  For ease of editing and applying the parameters easier and more convenient to create a file.  Let it be / tmp / prov <br><br>  File filling is as follows: <br><br><div class="spoiler">  <b class="spoiler_title">File contents</b> <div class="spoiler_text"><pre> <code class="bash hljs">md zimbramail.home.local zimbraAutoProvAccountNameMap <span class="hljs-string"><span class="hljs-string">"samAccountName"</span></span> md zimbramail.home.local +zimbraAutoProvAttrMap description=description md zimbramail.home.local +zimbraAutoProvAttrMap displayName=displayName md zimbramail.home.local +zimbraAutoProvAttrMap givenName=givenName md zimbramail.home.local +zimbraAutoProvAttrMap cn=cn md zimbramail.home.local +zimbraAutoProvAttrMap sn=sn md zimbramail.home.local zimbraAutoProvAuthMech LDAP md zimbramail.home.local zimbraAutoProvBatchSize 300 md zimbramail.home.local zimbraAutoProvLdapAdminBindDn <span class="hljs-string"><span class="hljs-string">"CN=ZimbraLDAP,OU=HOME_Users,DC=home,DC=local"</span></span> md zimbramail.home.local zimbraAutoProvLdapAdminBindPassword qwe123 md zimbramail.home.local zimbraAutoProvLdapBindDn <span class="hljs-string"><span class="hljs-string">"admin@zimbramail.home.local"</span></span> md zimbramail.home.local zimbraAutoProvLdapSearchBase <span class="hljs-string"><span class="hljs-string">"CN=HOME_Users,dc=home,dc=local"</span></span> md zimbramail.home.local zimbraAutoProvLdapSearchFilter <span class="hljs-string"><span class="hljs-string">"(&amp;(objectClass=user)(objectClass=person))"</span></span> md zimbramail.home.local zimbraAutoProvLdapURL <span class="hljs-string"><span class="hljs-string">"ldap://home.local:389"</span></span> md zimbramail.home.local zimbraAutoProvMode EAGER md zimbramail.home.local zimbraAutoProvNotificationBody <span class="hljs-string"><span class="hljs-string">"Your account has been auto provisioned. Your email address is </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${ACCOUNT_ADDRESS}</span></span></span><span class="hljs-string">."</span></span> md zimbramail.home.local zimbraAutoProvNotificationFromAddress prov-admin@zimbramail.home.local md zimbramail.home.local zimbraAutoProvNotificationSubject <span class="hljs-string"><span class="hljs-string">"New account auto provisioned"</span></span> ms zimbramail.home.local zimbraAutoProvPollingInterval <span class="hljs-string"><span class="hljs-string">"1m"</span></span> ms zimbramail.home.local +zimbraAutoProvScheduledDomains <span class="hljs-string"><span class="hljs-string">"zimbramail.home.local"</span></span></code> </pre> <br></div></div><br>  <i>A bit more theory:</i> <br><br>  This file contains commands for assigning variables.  So, for example, the parameter <b>zimbraAutoProvAttrMap cn = cn</b> means that Zimbra will form its boxes in such a way that ‚Äúthe display name (CN in AD) will be substituted in the field‚Äú display name ‚Äùin Zimbra. <br><br>  The <b>zimbraAutoProvLdapAdminBindDn</b> parameter <b>is</b> responsible for the account that Zimbra will use to access the AD directory.  In this case, ‚ÄúCN = ZimbraLDAP, OU = HOME_Users, DC = home, DC = local‚Äù, which means the following: the account with the display name ZimbraLDAP stored in the OU HOME_Users, which is located in the root of the home.local domain will be used <br><br>  <b>zimbraAutoProvLdapAdminBindPassword</b> stores the password of the ZimbraLDAP account <br><br>  <b>zimbraAutoProvLdapBindDn</b> stores the Zimbra server administrator account for the zimbramail.home.local domain <br><br>  <b>zimbraAutoProvLdapSearchBase</b> is responsible for the OU, in which Zimbra will look for domain accounts to create mailboxes.  In my case, this is the same container that the ZimbraLDAP user is in. <br><br>  <b>zimbraAutoProvPollingInterval</b> is the period of appeal to AD to look for new accounts. <br><br>  With the other parameters, everything is clear. <br><br>  It‚Äôs written on the developer‚Äôs website that if you use Zimbra version up to 8.0.8, then for the EAGER mode to work, you need to set the zimbraAutoProvLastPolledTimestamp parameter to the empty ‚Äú‚Äù value, otherwise it will not work more than once. <br><br>  Next, execute the command: <br><br><pre> <code class="bash hljs">$ su ‚Äì zimbra $ zmprov &lt; /tmp/prov</code> </pre> <br>  To view all zmprov values, you can enter the command: <br><br><pre> <code class="bash hljs">$ su ‚Äì zimbra $ zmprov gd zimbramail.home.local</code> </pre> <br>  You can edit the parameters using the same utility zmprov, rewriting the values ‚Äã‚Äãof variables (utility - action - domain - variable - value), can help for debugging: <br><br><pre> <code class="bash hljs">$ su ‚Äì zimbra $ zmprov md zimbramail.home.local zimbraAutoProvBatchSize 200</code> </pre> <br>  On the developer's site there is a small sign of troubleshooting of LDAP errors.  Logs are autoruns written in <b>/opt/zimbra/log/mailbox.log</b> <br><br>  <a href="https://wiki.zimbra.com/wiki/How_to_configure_auto-provisioning_with_AD">Link</a> <br><br><h3>  6. Installing client applications </h3><br>  Download from the official site msi-package of the latest version.  We copy it in the shared network folder accessible to all for reading.  You can also copy to Netlogon, but the package weighs more than 100 MB, so I decided to use the balloon. <br><br>  Zimbra Desktop uses java, which means you need to download it also, and put it in the same folder. <br>  Next to taste - KIX, GPO, hands.  I am using GPO. <br><br>  In the same ball, create the installZimbra.cmd file with the following content: <br><br><pre> <code class="bash hljs">\\SharedFolder\jrex64.exe INSTALL_SILENT=Enable \\SharedFolder\ZimbraInstall.msi /q /norestart</code> </pre> <br>  Add to the section "computer configuration" - "Windows configuration" - "Scripts (start / stop)" - "Startup" installation script created earlier.  The script will install java and Zimbra Desktop in silent mode and will not require a reboot.  Next - a rampant fantasy administrator. <br><br>  But.  In order for Zimbra Desktop to be configured on our server, you need to drive the parameters by hand. <br><br><img src="https://habrastorage.org/webt/0u/9w/rw/0u9wrw6toy4xpctfb0gufokyjge.png" alt="image"><br><br>  Therefore, users need to create some kind of instruction sheet, in which fields they need to be driven in, and which button to press to get access to the mail.  In general - not difficult. <br><br><h3>  Conclusion </h3><br>  Thus, we very easily and quickly introduced a completely free corporate interaction system based on the Zimbra Collaboration Suite, set up its interaction with the domain, simplifying the creation of mailboxes and getting rid of problems with a bunch of unnecessary accounts. <br><br>  In my opinion, Zimbra is quite a powerful tool for the corporate segment.  But on this occasion the articles have already been written a great many, I will not be sprayed. </div><p>Source: <a href="https://habr.com/ru/post/439440/">https://habr.com/ru/post/439440/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
</ul></nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>