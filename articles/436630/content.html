<div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/-0/t1/l0/-0t1l0j7yjj4y-ysaqxqu5no3my.png"><br><br><h2>  Introduction </h2><br>  Good day to all.  I am a Python developer in a company that deals with complex solutions for automating business processes, developing solutions for solving single problems, analytics and consulting.  My responsibilities include the development and maintenance of microservice architecture.  And today I would like to tell you how we are fighting microservices and why unification is so important for them. <br><br>  It's no secret that this approach to product development is increasingly capturing the market.  And the more we dip into them, the more you need to remember the basic rules for working with them.  In order to structure our experience in writing microservice products, it was decided to write a series of articles on how to summarize some aspects of the development for all services. <br><br>  One of these rules is unification.  In our company, most products consist of a heap of different languages ​​and technologies.  In all this booth one has to think how one can generalize the basic principles to all microservices for their easy support, customization and convenient development.  This will be discussed in a series of articles. <br><br>  All interested in asking under the cat. <br><a name="habracut"></a><br><h3>  Problem </h3><br>  Perhaps the first thing you encounter in the development of a service is its configuration methods.  In microservice architecture, this issue becomes even more acute. <br><br>  Imagine that you have about two dozen services and you need to change a parameter in each one.  For example, disable the use of CORS.  Since the system is multi-component and built on microservices, for convenient management it is best to use a uniform approach to the configuration of all modules.  Therefore, you need to use the same approach when setting up each module. <br><br>  You can say that the developer of each service should deal with this, but what if all your configs are stored in the same Kubernetes, where all developers should not be given access?  Poor DevOps will have to spend a lot of time just learning the services and methods of their configurations.  And this procedure will be repeated with the update of services, especially if someone wants to try something new in setting up the service.  With this approach, the team will constantly spend some time on working with configs, and not on developing new features, editing bugs, etc. <br><br>  Just for this case, a common configuration method is required, which will not be tied to a specific language or technology and will allow you to configure all services with minimal differences in the general structure of the config.  For this task, we developed a system for setting up "modules" (services) using yaml files, the ability to store configurations for different stages (dev / prod / local etc) and divide the whole thing into different blocks related to certain things. <br><br><h2>  Specification </h2><br>  You can rant a lot about where and how it can be used, but I suggest you go straight to the specification of this configuration method.  As they say, theory is good, and practice is even better. <br><br><h3>  System requirements </h3><br>  Let's start by defining our system and requirements for it. <br><ul><li>  <b>Each</b> module is an independent component in a container. </li><li>  We can pass environment variables into the container. </li><li>  We can <b>NOT</b> change the configuration on the fly without rebooting the service (creating a new container). </li><li>  All fallback actions (such as switching to the backup database) are <b>performed outside the component</b> and are transparent to it. </li></ul><br><br><h3>  Configuration Method Requirements </h3><br>  Now we’ll decide what we want to see from our configuration method to satisfy all requirements. <br><br><ol><li>  The type of configuration file is YAML of the specified structure.  YAML was chosen by us for several reasons: <br><ul><li>  The ability to write comments and a convenient structure unlike JSON </li><li>  Ability to describe arrays in contrast to ENV </li><li>  Out of the box, you can use it for values ​​from values.yaml in helm (Kubernetes) </li></ul><br></li><li>  Configuration files should merzhitsya in the configuration tree </li><li>  The configuration must be stage-specific.  Each stage has its own full set.  There are several reservations to clarify: <br><ul><li>  You <b>cannot</b> reuse the values ​​of variables from another stage <b>, except for the defaults stage</b> , which is reserved for default values. <br></li><li>  When loading a configuration, you need to do a recursive merge of the configuration layer from the specified stage <b>over defaults with the priority of the layer of the specified stage.</b>  <b>Values ​​(arrays, etc.) should not be combined.</b> </li><li>  If there are several configuration files for one stage, the keys in them must be merged and, accordingly, <b>must be unique relative to each other.</b> </li></ul><br></li><li>  The current used stack should be determined by the value of the "STAGE" environment variable.  Changing the variable for a running service instance is not supposed. </li><li>  The absolute path to the configuration directory should be determined by the value of the CONFIG_PATH environment variable.  For convenience, a fallback is possible in the absence of a variable to some default path, which must be indicated in the documentation for the module.  In this case, the specified path must be relative to the root directory of the application. </li></ol><br><br><h2>  Configuration examples </h2><br>  Suppose we have a service that needs to store connection settings for Postgres, as well as some information about ourselves <br><br>  First you need to define a config for STAGE = defaults.  In it, we describe the general structure, as well as make the data independent of the stage. <br><br><h4>  defaults </h4><br><pre><code class="javascript hljs"># configuration/defaults/service.yaml defaults: version: <span class="hljs-number"><span class="hljs-number">1.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> name: <span class="hljs-string"><span class="hljs-string">"config-example"</span></span> # configuration/defaults/redis.yaml defaults: redis: host: <span class="hljs-string"><span class="hljs-string">"host"</span></span> db: <span class="hljs-number"><span class="hljs-number">0</span></span> port: <span class="hljs-number"><span class="hljs-number">6379</span></span> password: <span class="hljs-string"><span class="hljs-string">"password"</span></span></code> </pre> <br><br><h4>  dev </h4><br><pre> <code class="javascript hljs"># configuration/dev/redis.yaml dev: redis: host: <span class="hljs-string"><span class="hljs-string">"localhost"</span></span> password: <span class="hljs-string"><span class="hljs-string">"hard_pwd"</span></span></code> </pre><br><br><h4>  Resulting config </h4><br><pre> <code class="javascript hljs">version: <span class="hljs-number"><span class="hljs-number">1.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> name: <span class="hljs-string"><span class="hljs-string">"config-example"</span></span> redis: host: <span class="hljs-string"><span class="hljs-string">"localhost"</span></span> db: <span class="hljs-number"><span class="hljs-number">0</span></span> port: <span class="hljs-number"><span class="hljs-number">6379</span></span> password: <span class="hljs-string"><span class="hljs-string">"hard_pwd"</span></span></code> </pre><br><br><h2>  findings </h2><br><br>  In this cunning way, we solved the problem of the configuration of services in our zoo and brought everything to a general view.  This example is only a starting point and can be modified for the specifics of your project. <br><br>  For those who are interested in this configuration method in the "bare form": <br><div class="spoiler">  <b class="spoiler_title">Our packages for different programming languages</b> <div class="spoiler_text"><ul><li>  <a href="https://github.com/microparts/configuration-golang">go</a> </li><li>  <a href="https://github.com/microparts/configuration-php">php</a> </li><li>  <a href="https://github.com/microparts/configuration-python">python</a> </li><li>  <a href="https://github.com/microparts/configuration-js">js</a> </li></ul><br></div></div><br><br>  For help in writing to become a separate thank you <a href="https://habr.com/ru/users/roque/" class="user_link">Roque</a> , <a href="https://habr.com/ru/users/smgladkovskiy/" class="user_link">SMGladkovskiy</a> </div>