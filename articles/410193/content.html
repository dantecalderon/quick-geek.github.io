<div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/i5/x6/sm/i5x6smb2wdc5hqkliea6wn5otbo.jpeg"></p><br><p>  It is no secret that in the modern high-tech world, we are required to constantly confirm our identity and access rights - with passwords, contactless tags, fingerprints, and so on.  You can do this with the help of a visual fingerprint - the user's face.  Just look at our gadget, as he understands that he is an authorized user, and removes the screen lock. </p><br><p>  We decided to implement a similar scheme with the help of available materials and open source solutions.  As a physical object, which will have the appropriate "selectivity for discoveries," a safe was chosen. </p><br><p>  All the details under the cut. </p><a name="habracut"></a><br><h1 id="korpus">  Housing </h1><br><p><img src="https://habrastorage.org/webt/8r/c_/nz/8rc_nzatw10hgl7yddyh-xiiuu4.jpeg"><br>  <em>Figure 1. Chassis Assembly Process</em> </p><br><p>  The body is made of scraps of laminated MDF panels 40 x 40 cm, connected by furniture screws.  Subsequently, all the joints were thickly smeared with acrylic putty on wood, <del>  Not really </del>  thoroughly sanded, after which the whole body was coated several times with acrylic white paint in a thick layer.  We paint, wait until the current layer dries, sand, cover with another layer.  After three layers, I got a uniform white matte coating, on which I walked with a thin layer of white glossy enamel. </p><br><p><img src="https://habrastorage.org/webt/mh/t9/lf/mht9lftpsupns5xy1lcszrpqmkq.jpeg"><br>  <em>Figure 2. Final body during electrical installation</em> </p><br><p>  From the bottom of the case, fasten the printed legs - the first parts drawn in the 3D editor. </p><br><p><img src="https://habrastorage.org/webt/5p/ag/wr/5pagwrqs7ll8fqyui3a78m90tng.jpeg"><br>  <em>Figure 3. Legs.</em>  <em>PLA plastic</em> </p><br><h1 id="elektrika">  Electrician </h1><br><p>  The lock for the safe was made of a hybrid of the drive of the central lock and the fold tongue of the interior door - from the last one we throw out the swivel sleeve and make a hook under the traction. <br>  With the help of printed parts, everything is assembled into a single structure and is mounted on the door.  The main plate itself is quite thin (3mm) and easily bends, but everything changes after installation in place.  The final design turned out strong enough for further experiments. </p><br><p><img src="https://habrastorage.org/webt/fy/ck/za/fyckzapbweumcpfupyrllc76xpy.jpeg"><br>  <em>Figure 4. Lock Assembly Mechanism</em> </p><br><p>  Of course, if we are talking about a complete access control system, then you can buy an all-metal ready-made electric lock by installing it in a normal metal safe.  But no. </p><br><p>  In addition to the lock, we still need a limit switch in order to monitor the state of the door, a three-position switch to control the system, and a two-color LED to display the current program status. </p><br><p><img src="https://habrastorage.org/webt/op/ko/be/opkobeaz2jx50lmhehg-6dixiny.jpeg"><br>  <em>Figure 5. Schematic diagram of body kit</em> </p><br><p>  We do not forget that the voltage on the pins is 1.8V (with an expansion board already 3.3V), so the LEDs are connected through a transistor stage - they will not light up from 1.8V. </p><br><h1 id="elektronika">  Electronics </h1><br><p>  The main components of the system — a camera and a single-board computer — were made for each other (in our case, this is not a speech turn, but a known fact): </p><br><p><img src="https://habrastorage.org/webt/-f/9n/hd/-f9nhdydisl4omfltvwypqclzsm.jpeg"><br>  <em>Figure 6. <a href="https://ark.intel.com/products/96414/Intel-Joule-570x-Developer-Kit%255D">Intel Joule 570x Development Kit</a> - single board microcomputer with 4-core 64-bit Intel Atom onboard, 4GB of memory and USB 3.0 connector</em> </p><br><p><img src="https://habrastorage.org/webt/du/1q/9v/du1q9vdmwp7zfyqkujb601eqmgs.jpeg"><br>  <em>Figure 7. <a href="https://software.intel.com/en-us/realsense/sr300">Intel RealSense Camera SR300</a> - 3D near-range camera as an organ of vision.</em>  <em>Effective recognition distance depth of 0.2 - 1.2 m.</em> </p><br><p>  Literally a couple of days after the start of the project, Intel Joule managed to acquire EOL (End Of Life) status, but this did not stop us. </p><br><p>  As a computing module, you can take almost any modern single-board with a USB3.0 processor based on Intel.  For example <a href="https://software.intel.com/en-us/iot/hardware/up-squared-grove-dev-kit">Up Squared <em>Grove</em> IoT Developement Kit</a> or <a href="https://software.intel.com/en-us/iot/hardware/minnow-board-turbot">MinnowBoard Turbot *</a> .  Intel NUC is also suitable. </p><br><h1 id="sborka">  Assembly </h1><br><p>  Install the parts of the lock on the box so that the lock closes normally.  In order for the door to bounce when triggered (as in postamats), we print and install a spring pusher.  His task is to pull the door off the latch by several millimeters after the tongue is pulled in, so that after removing the tension the box does not close again. </p><br><p><img src="https://habrastorage.org/webt/rl/qe/yb/rlqeybnzeczhoxz2fnkqmfivpb8.jpeg"><br>  <em>Figure 8. Latch for tongue and spring door pusher</em> </p><br><p>  Front mount the camera.  We put a LED in the cover for the camera, to a point above i - for certain reasons, he managed to metamorphize into one green LED.  Fix it with a pair of screws. </p><br><p><img src="https://habrastorage.org/webt/qq/ni/u0/qqniu04unreexnplechpp90uimm.jpeg"><br>  <em>Figure 9. Installed Camera</em> </p><br><p>  For Intel Joule, a case is needed, so a case of the required dimensions with windows for connectors is drawn in the 3D editor. </p><br><p><img src="https://habrastorage.org/webt/c-/kw/k6/c-kwk6gggnei9dspfro6gmvbewa.jpeg"><br>  <em>Figure 10. Housing drawing for Intel Joule</em> </p><br><p>  For 40-pin GPIO-connectors, no windows are provided, since it was decided to place the entire electrician inside the case.  To do this, draw a thick cover, with grooves for the relay and 4 contacts, as well as windows for switches.  Do not forget that the processor on the board is not the weakest, so we make several ventilation holes in the cover. </p><br><p><img src="https://habrastorage.org/webt/av/ek/ag/avekagvknife3mrfhgcd4axip40.jpeg"><br>  <em>Figure 11. Cover drawing</em> </p><br><p>  There are two shoals.  Firstly, the development of the body kit did not take into account the connector to connect the LED, which led to the fact that: </p><br><ol><li>  The case does not provide a hole for the cable / connector and had to burn the hole with a soldering iron; </li><li>  The assembled body has a long tail with LEDs on the end. </li></ol><br><p>  Secondly, the body must somehow be connected and nothing better than to do it with the help of pieces of wire as a result was not invented ¯_ () _ / ¯.  About mounting generally keep quiet.  You can not see, but somewhere there, under the thermo-sauce, 3 transistors and five heels of rescuers are hidden. </p><br><div class="spoiler">  <b class="spoiler_title">smoker's prototype</b> <div class="spoiler_text"><p>  Here I remember the picture of my own authorship: <br><img src="https://habrastorage.org/webt/nt/ob/l6/ntobl6zn74dyj75-l1pv5ywtayq.jpeg"><br>  And the words of the person who brought me the right device - “I’ve already made a prototype, I just need to tweak the firmware a bit - something is unstable and the battery quickly sits down”. </p></div></div><br><p><img src="https://habrastorage.org/webt/zg/wf/e0/zgwfe04zlzy_nwkidibzockvnb4.jpeg"><br>  <em>Figure 12. Assembled electronics unit</em> </p><br><p>  The inside of the box - four terminals - two for power and two for the motor, the limit switch for the door, back and forth to control the program, and the relay supplying voltage to the lock.  During printing, the angle near the cavity for the relay was cut off from the table and the relay decided not to fit in it.  I had to glue the switch on thermosoopl.  As well as single-board. </p><br><p>  Wi-Fi antennas of the board are glued with green tape.  In general, they are on self-bonding, but we have already glued them so many times during experiments, that they have lost the property of sticking to the surface. </p><br><p><img src="https://habrastorage.org/webt/c5/uz/jd/c5uzjdeh9cps9xuxzubtw8wclaq.jpeg"><br>  <em>Figure 13. Assembled closed electronics unit</em> </p><br><p>  We place the guts inside the case, close it and proceed to the development of the program part. </p><br><h2 id="liricheskoe-otstuplenie-po-3d-pechati">  Lyrical digression on 3D printing. </h2><br><p>  The details of the castle are my favorite and hated PLA.  The material is very good for printing high-precision models, but it is completely impossible to process.  And this infection floats when heated, which is a very bad property for structural elements. </p><br><p>  All other parts of HIPS - IMHO, it is less naughty than ABS, and when printed, it gives almost no smell.  The only caveat - until he raised the temperature of the table to 95 degrees, the detail on the table warped.  According to the instructions, the temperature of the table should be about 100 degrees, but who reads it so far so good? </p><br><h1 id="programmnaya-chast">  Software part </h1><br><h2 id="podgotovka-sistemy">  System preparation </h2><br><p>  First of all, you need to update the BIOS on the board to install the image of the operating system we need.  We used <a href="https://software.intel.com/en-us/flashing-the-bios-on-joule">this</a> and <a href="https://software.intel.com/en-us/videos/flashing-the-bios-on-the-intel-joule-compute-module">this</a> instructions from the official documentation on the Intel website. </p><br><p>  Next, by connecting a monitor and keyboard to the board, we install the special <a href="https://developer.ubuntu.com/core/get-started/intel-joule">Ubuntu * Desktop 16.04 LTS</a> distribution kit <a href="https://developer.ubuntu.com/core/get-started/intel-joule">for Intel Joule</a> in the usual graphic or text mode.  If Intel NUC or another computer is used as a computer, the stock image of the system will also go. </p><br><p>  After installing the OS using standard tools, we connect to the Internet via the built-in Wi-Fi.  Since there is only one USB connector on the board and we need it to connect the camera, we connect to the board via ssh.  Now we can free the port from the keyboard and connect Intel RealSense. </p><br><h2 id="ustanovka-paketov-i-zavisimostey">  Installing packages and dependencies. </h2><br><p>  First, install Python 3.5.4, in which our project is written.  Download and build <a href="https://github.com/opencv/opencv">an OpenCV Python module</a> from the source code, since the unofficial OpenCV module for Python on Intel Joule does not work correctly. </p><br><p>  Install or update additional dependencies: </p><br><pre><code class="bash hljs">apt install -y --fix-missing build-essential cmake gfortran git wget curl graphicsmagick libgraphicsmagick1-dev libatlas-dev libavcodec-dev libavformat-dev libboost-all-dev libgtk2.0-dev libjpeg-dev liblapack-dev libswscale-dev pkg-config python3-dev python3-numpy software-properties-common zip git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/davisking/dlib.git /root/dlib; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /root/dlib; mkdir build; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> build; cmake .. -DUSE_AVX_INSTRUCTIONS=1; cmake --build . ; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> .. ; python3 setup.py install --yes USE_AVX_INSTRUCTIONS --no DLIB_USE_CUDA pip3 install face_recognition</code> </pre> <br><p>  We <a href="https://github.com/intel-iot-devkit/mraa">put libmraa</a> - this library is useful to us for communication with the box.  Detailed assembly instructions are located <a href="http://iotdk.intel.com/docs/master/mraa/building.html">here</a> . </p><br><p>  Or you can install prebuilt PPA binaries: </p><br><pre> <code class="bash hljs">sudo add-apt-repository ppa:mraa/mraa sudo apt-get update sudo apt-get install libmraa1 libmraa-dev libmraa-java python-mraa python3-mraa node-mraa mraa-tools</code> </pre> <br><p>  After installing all the dependencies, we can verify that everything is working correctly.  To do this, raise the VNC - vnc4server is our everything, <a href="http://opencv-python-tutroals.readthedocs.io/en/latest/py_tutorials/py_gui/py_video_display/py_video_display.html">launch the sample</a> for working with the camera and make sure that the camera is working. </p><br><p>  The final test point is the correct import of the <a href="https://github.com/ageitgey/face_recognition">face_recognition</a> module.  In fact, this is our ResNet neural network, sharpened to identify people in the photo.  So it looks like in the author's demo: </p><br><p><img src="https://habrastorage.org/webt/ep/kj/-r/epkj-ryhqww7awdqxnatobaquac.gif"></p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> face_recognition</code> </pre> <br><p>  As everything will be ready, we unload the <a href="https://github.com/dmitryvodop/fr3onn">source code of our application</a> from the repository and get down to work. </p><br><p>  For convenience, we added all the libraries as submodules to our project.  To download them, run <em>git submodule update --init --recursive</em> from the project directory. </p><br><h1 id="rabota">  Job </h1><br><pre> <code class="bash hljs">./launcher.py</code> </pre> <br><p>  When you first turn on the database is not persons, therefore the box will be closed.  Open it manually (we have a built-in backdoor for this - a small hole is clearly opposite the tongue) and we carry out training. </p><br><p>  To do this, we stand in front of the box - on the front panel the LED lights up, indicating that a certain person is in the field of view of the camera. </p><br><p>  Click the switch in the direction of remembering the person and the corresponding entry appears in the console. </p><br><p><img src="https://habrastorage.org/webt/0t/ji/qm/0tjiqmradgxtko3jogbrl-secco.png"></p><br><p>  Now, if you close the box and stand in front of him - the system recognizes his face and happily opens the door. </p><br><p><img src="https://habrastorage.org/webt/cf/yl/o_/cfylo_my10qxbzuvlmw3h_tli7y.gif"></p><br><p>  Access grants will appear in the console. </p><br><p><img src="https://habrastorage.org/webt/sf/es/q9/sfesq9unf1b90rxiwmislt2fzkm.png"></p><br><p>  If a stranger gets up - the system will not be able to identify him, as a result of which the door will remain closed.  Another thing is that the system can be taken out of moderation - the percentage of false positives in our case was quite high and if you walk for a long time with a bunch of different objects in your hands - it will open sesame. </p><br><p>  This can be solved by using the depth channel - in the current version it is not used, since it was never possible to get it to work stably, and it was too late to send a compatibility issue with Intel Joule.  Author's face_recognition measured accuracy of 99.38% on the benchmark <a href="http://vis-www.cs.umass.edu/lfw/">Labeled Faces in the Wild Home</a> </p><br><h1 id="zaklyuchenie">  Conclusion </h1><br><p>  Of course, this Proof-Of-Concept can be significantly improved, and its functionality has been expanded many times over.  For example, you can add logging of successful and unsuccessful access, as well as convenient management via a web interface. </p><br><p>  The basic principle of the design of this device was: "I blinded him from what it was."  We just wanted to show that it is possible to make something interesting out of the materials at hand. </p><br><p>  Thanks to Dmitry ( <a href="https://habr.com/users/dmitryvodop/" class="user_link">dmitryvodop</a> ) and Sergey for working on the program part of the project. </p><br><p>  All models in the * .stl format and the source code of the program is laid out on <a href="https://github.com/dmitryvodop/fr3onn/">GitHub</a> under the MIT license. </p></div>