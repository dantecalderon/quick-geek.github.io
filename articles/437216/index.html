<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Molecule - Testing Ansible Roles</title>
  <meta name="description" content="Good day. On Habr√© I was repeatedly mentioned ansible, but I didn‚Äôt find any articles about testing his roles using a molecule, however I find this fr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>Molecule - Testing Ansible Roles</h1><div class="post__text post__text-html js-mediator-article">  Good day.  On Habr√© I was repeatedly mentioned ansible, but I didn‚Äôt find any articles about testing his roles using a molecule, however I find this framework extremely convenient and would like to share this with Habr‚Äôs audience. <br><div style="text-align:center;"><img src="https://habrastorage.org/files/edc/21b/51f/edc21b51f91f44cfae26159fde4875b5.png"></div>  But first, a little about what I used before. <br><a name="habracut"></a><br>  Formerly, I used vagrant to test the roles that I create, which I create, by driving straightforward ones: <br><br><pre><code class="bash hljs">$ vagrant init debian/jessie64 $ vagrant up</code> </pre> <br>  Creating virtual machines, after which I wrote inventory and playbook to start the role, until one day I had a chance to get acquainted with the molecule. <br><br><h4>  What can a molecule offer? </h4><br><ol><li>  Initial role initialization </li><li>  Driver / Provider </li><li>  Idempotency tests </li><li>  Verification </li></ol><br><h4>  Initial role initialization </h4><br>  In the case of specifying a new role creates a generic structure for the role ansible <br><br><h4>  Driver / Provider </h4><br>  Molecule allows us to use either a Docker container or a virtual machine as a guinea pig using a Vagrant, which is determined by specifying the driver during initialization, or in molecule.yml.  Since  I have to test the roles of orchestrating containers, then Vagrant remains the preferred driver for me as a driver.  Selecting Vagrant as a driver also allows you to select a Provider. <br><br>  The following are available: <br><br><ul><li>  Libvirt </li><li>  Parallels </li><li>  VirtualBox (default) </li><li>  VMware Fusion </li></ul><br>  Further, the Vagrant variant with VirtualBox as a provider will be considered. <br><br><h4>  Idempotency tests </h4><br>  According to wiki: <br><blockquote>  property of an object or operation when re-applying an operation to an object to give the same result as with a single. </blockquote><br>  With regard to roles ansible - when you restart the role should not be made any changes. <br><br><h4>  Verification </h4><br>  In order to make sure that the role has worked properly - not to overwhelm any of the tasks is not enough.  After all, it is necessary to check that the services have started, the ports are open, etc. <br><br>  The following frameworks are available for verification: <br><br><ul><li>  Goss </li><li>  Serverspec </li><li>  Testinfra (default) </li></ul><br>  I have tested Goss and Testinfra.  For myself, I chose Testinfra. <br><br>  Usage example: <br><br><pre> <code class="bash hljs">$ molecule init --role sample-role</code> </pre> <br>  After executing this command, we get the sample-role directory with the typical ansible structure and the necessary yaml files: <br><br><pre> <code class="bash hljs">defaults handlers meta molecule.yml // –∫–æ–Ω—Ñ–∏–≥-—Ñ–∞–π–ª –¥–ª—è molecule playbook.yml // –ø–ª—ç–π–±—É–∫ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –Ω–∞—à–µ–π —Ä–æ–ª–∏ README.md tasks tests // —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ vars</code> </pre> <br>  You can run without specifying the --role key, in this case the molecule.yml and playbook.yml files will be created in the current directory. <br><br>  It happens that it is required to ensure the work of the role on several distributions in this case in molecyle.yml it is necessary to specify the names of the vagrant boxes (in platforms): <br><br><pre> <code class="plaintext hljs">vagrant: platforms: - name: jessie64 box: debian/jessie64 - name: centos7 box: centos/7</code> </pre> <br>  Next, add the necessary actions / variables, etc.  in the role, after which we test on all specific platforms: <br><br><pre> <code class="bash hljs">$ molecule <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> --platform all</code> </pre> <br>  After this molecule: <br><br><ul><li>  if there are already created virtual machines, stop and delete them </li><li>  raise the necessary virtual machines </li><li>  check our role with ansible-lint </li><li>  perform our role but newly created containers </li><li>  will test idempotency </li><li>  run testinfra tests </li><li>  will delete the created virtual machines </li></ul><br>  You may need to change the behavior of a molecule when you run test, for example, do not test for idempotency, for this you should add the following to molecule.yml: <br><br><pre> <code class="plaintext hljs">molecule: test: sequence: - destroy - syntax - create - converge - verify - destroy</code> </pre> <br>  You can also call each of the corresponding steps separately using the appropriate command, example: <br><br><pre> <code class="bash hljs">$ molecule create --platform all $ molecule syntax $ molecule create $ molecule converge $ molecule verify</code> </pre> <br>  As one of the options - do not delete / create a new virtual machine before each converge. <br><br>  You can specify a specific platform and test it separately: <br><br><pre> <code class="bash hljs">$ molecule create --platform jessie64 $ molecule syntax $ molecule create $ molecule converge $ molecule verify</code> </pre> <br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/437216/">https://habr.com/ru/post/437216/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>