<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>I try .NET Core + Kubernetes + appmetrics + prometheus + grafana + jobs + health checks</title>
  <meta name="description" content="Brief acquaintance with kubernetes for developers on the example of deploying a simple template site, with its monitoring, execution of jobs according...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-6974184241884155",
      enable_page_level_ads: true
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>I try .NET Core + Kubernetes + appmetrics + prometheus + grafana + jobs + health checks</h1><div class="post__text post__text-html js-mediator-article">  Brief acquaintance with kubernetes for developers on the example of deploying a simple template site, with its monitoring, execution of jobs according to the schedule and health checks (all sources attached) <br><br>  - <a href="https://habr.com/ru/post/437286/">Kubernetes installation</a> <br>  - <a href="https://habr.com/ru/post/437286/">Set UI</a> <br>  - <a href="https://habr.com/ru/post/437286/">Run your application in a cluster</a> <br>  - <a href="https://habr.com/ru/post/437286/">Adding custom metrics to the application</a> <br>  - <a href="https://habr.com/ru/post/437286/">Collect metrics through Prometheus</a> <br>  - <a href="https://habr.com/ru/post/437286/">Displaying metrics in Grafana</a> <br>  - <a href="https://habr.com/ru/post/437286/">performing scheduled tasks</a> <br>  - <a href="https://habr.com/ru/post/437286/">Fault tolerance</a> <br>  - <a href="https://habr.com/ru/post/437286/">Conclusions</a> <br>  - <a href="https://habr.com/ru/post/437286/">Notes</a> <br>  - <a href="https://habr.com/ru/post/437286/">References</a> <br><a name="habracut"></a><br><a name="1"></a><h2>  Kubernetes installation </h2><br>  <i>not suitable for linux users, you will have to use <a href="https://kubernetes.io/docs/tasks/tools/install-minikube/">minikube</a></i> <br><ol><li>  Do you have a docker desktop </li><li>  In it you need to find and enable Kubernetes single-node cluster <br><img src="https://habrastorage.org/webt/zc/ij/zs/zcijzspy007dfz7ilba9xhv3mg0.png"></li><li>  Now you have api <a href="http://localhost:8001/">http: // localhost: 8001 /</a> for working with cubernetis </li><li> Communication with him through a convenient utility kubectl <br>  Check its version with the command&gt; <code>kubectl version</code> <br>  The last actual is written here <a href="https://storage.googleapis.com/kubernetes-release/release/stable.txt">https://storage.googleapis.com/kubernetes-release/release/stable.txt</a> <br>  You can download the corresponding link <a href="">https://storage.googleapis.com/kubernetes-release/release/v1.13.2/bin/windows/amd64/kubectl.exe</a> </li><li>  Check that the cluster works&gt; <code>kubectl cluster-info</code> </li></ol><br><a name="2"></a><h2>  UI installation </h2><br><ol><li>  The interface is deployed in the cluster itself. <br><pre> <code class="bash hljs">kubectl create -f https://raw.githubusercontent.com/kubernetes/dashboard/master/aio/deploy/recommended/kubernetes-dashboard.yaml</code> </pre> </li><li>  Get a token to access the interface <pre> <code class="bash hljs">kubectl describe secret</code> </pre> <br>  And copy <br><img src="https://habrastorage.org/webt/9q/kl/fa/9qklfaacfs9863l1s5cy7nnz1-k.png"></li><li>  Now run the proxy <pre> <code class="bash hljs">kubectl proxy</code> </pre> </li><li>  And you can use <a href="https:kubernetes-dashboard:/proxy/">http: // localhost: 8001 / api / v1 / namespaces / kube-system / services / https: kubernetes-dashboard: / proxy /</a> <img src="https://habrastorage.org/webt/-w/si/i1/-wsii1ckz09obhzqxwsf25yauvm.png"></li></ol><br><br><a name="3"></a><h2>  Run your application in a cluster </h2><br><ol><li>  I made a standard mvc netcoreapp2.1 application through the studio <a href="https://github.com/SanSYS/kuberfirst">https://github.com/SanSYS/kuberfirst</a> </li><li>  Dockerfile: <pre> <code class="actionscript hljs">FROM microsoft/dotnet:<span class="hljs-number"><span class="hljs-number">2.1</span></span>-aspnetcore-runtime AS base WORKDIR /app EXPOSE <span class="hljs-number"><span class="hljs-number">80</span></span> FROM microsoft/dotnet:<span class="hljs-number"><span class="hljs-number">2.1</span></span>-sdk AS build WORKDIR /src COPY ./MetricsDemo.csproj . RUN ls RUN dotnet restore <span class="hljs-string"><span class="hljs-string">"MetricsDemo.csproj"</span></span> COPY . . RUN dotnet build <span class="hljs-string"><span class="hljs-string">"MetricsDemo.csproj"</span></span> -c Release -o /app FROM build AS publish RUN dotnet publish <span class="hljs-string"><span class="hljs-string">"MetricsDemo.csproj"</span></span> -c Release -o /app FROM base AS <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> WORKDIR /app COPY --from=publish /app . ENTRYPOINT [<span class="hljs-string"><span class="hljs-string">"dotnet"</span></span>, <span class="hljs-string"><span class="hljs-string">"MetricsDemo.dll"</span></span>]</code> </pre> </li><li>  Collected this business with a metricsdemo3 tag <pre> <code class="bash hljs">docker build -t metricsdemo3 .</code> </pre> </li><li>  But!  Kuber by default pulls images from the hub, so I raise the local register </li><li>  note - did not try to run in cubernetis <pre> <code class="bash hljs">docker create -p 5000:5000 --restart always --name registry registry:2</code> </pre></li><li>  And I prescribe it as permitted unsafe: <br><img src="https://habrastorage.org/webt/0e/h3/5e/0eh35ewv6frgqwrwaqddcriqhpu.png"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"registry-mirrors"</span></span>: [], <span class="hljs-attr"><span class="hljs-attr">"insecure-registries"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"localhost:5000"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"debug"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"experimental"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span> }</code> </pre> </li><li>  Before we push in, register a couple more gestures <pre> <code class="bash hljs">docker start registry docker tag metricsdemo3 localhost:5000/sansys/metricsdemo3 docker push localhost:5000/sansys/metricsdemo3</code> </pre> </li><li>  It turns out like this: <br><img src="https://habrastorage.org/webt/ep/6i/5o/ep6i5ofhvqdr8cokxqbidrqisvk.png"></li><li><div class="spoiler">  <b class="spoiler_title">Run via UI</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/tv/oa/ed/tvoaedah5gqbrqftpcxjdlwrkpi.png"><br></div></div></li></ol><br><br><h4>  If started, then everything is OK and you can start using </h4><br>  Create a deployment file <br><div class="spoiler">  <b class="spoiler_title">1-deployment-app.yaml</b> <div class="spoiler_text"><pre> <code class="bash hljs">kind: Deployment apiVersion: apps/v1 metadata: name: metricsdemo labels: app: web spec: replicas: 2 <span class="hljs-comment"><span class="hljs-comment"># —Å–∫–æ–ª—å–∫–æ –ø–æ–¥–æ–≤ –ø–æ–¥–Ω—è—Ç—å (–∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π) # —Å–µ–ª–µ–∫—Ç–æ—Ä —Ä–µ—à–∞–µ—Ç, –Ω–∞ –∫–∞–∫–∏–µ —à–∞–±–ª–æ–Ω—ã —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è –¥–µ–ø–ª–æ–π selector: matchLabels: app: metricsdemo template: metadata: labels: app: metricsdemo # –ø–æ —ç—Ç–æ–π –º–µ—Ç–∫–µ –∏—â–µ—Ç selector –≤ kind: Service spec: containers: - name: metricsdemo # –∏–º—è –¥–µ–ø–ª–æ—è image: localhost:5000/sansys/metricsdemo3 # –æ–±—Ä–∞–∑ –≤ –¥–æ–∫–µ—Ä–µ ports: - containerPort: 80 # –∫–∞–∫–æ–π –ø–æ—Ä—Ç —Å–ª—É—à–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ –¥–æ–∫–µ—Ä–∞ # –í–ê–ñ–ù–û: —Ç—Ä–∏ –¥–µ—Ñ–∏—Å–∞ –¥–µ–ª—è—Ç —Ñ–∞–π–ª, –∫–∞–∫ –±—ã –Ω–∞ –¥–≤–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —è–º–ª–∞ --- kind: Service apiVersion: v1 metadata: name: metricsdemo # –∏–º—è –¥–ª—è –ø—Ä–æ–º–µ—Ç–µ—É—Å–∞ __meta_kubernetes_service_name="metricsdemo", —Å–º https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config labels: apptype: business # –∏–º—è –¥–ª—è –ø—Ä–æ–º–µ—Ç–µ—É—Å–∞ __meta_kubernetes_service_label_apptype="business" - –∑–∞–ø–æ–º–Ω–∏ instancetype: web # –∏–º—è –¥–ª—è –ø—Ä–æ–º–µ—Ç–µ—É—Å–∞ __meta_kubernetes_service_label_instancetype="web" spec: selector: app: metricsdemo # —Å–µ–ª–µ–∫—Ç–æ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –ø–æ labels:app type: LoadBalancer # —Ä–µ–≤–µ—Ä—Å–ø—Ä–æ–∫—Å–∏ –∏–∑ –≤–Ω–µ –¥–æ –ø–æ–¥–æ–≤ ports: - protocol: TCP # –∏–º—è –¥–ª—è –ø—Ä–æ–º–µ—Ç–µ—É—Å–∞ _meta_kubernetes_service_port_protocol="TCP" port: 9376 targetPort: 80 name: portapi # –∏–º—è –¥–ª—è –ø—Ä–æ–º–µ—Ç–µ—É—Å–∞ __meta_kubernetes_service_port_name="portapi"</span></span></code> </pre> </div></div><br>  Small description <ul><li>  Kind - indicates that the entity type is described through the yaml file. </li><li>  apiVersion - in which the object is passed </li><li>  labels - in fact, just labels (the keys on the left and the values ‚Äã‚Äãcan be created by ourselves) </li><li>  selector - allows you to associate services with deploem, for example, through tags </li></ul><br>  Further: <pre> <code class="bash hljs">kubectl create -f .\1-deployment-app.yaml</code> </pre><br>  And you should see your interface <a href="https:kubernetes-dashboard:/proxy/">http: // localhost: 8001 / api / v1 / namespaces / kube-system / services / https: kubernetes-dashboard: / proxy / #! / Deployment? Namespace = default</a> <br><div class="spoiler">  <b class="spoiler_title">Screen</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/8c/sp/gj/8cspgj27ws9tcjd-6euq5s3djig.png"></div></div><br>  Inside of which there is a Replica Set, showing that the application is running in duplicate (Pods) and there is one related service with an address from the outside to open the completed application in the browser <br><div class="spoiler">  <b class="spoiler_title">Screenshots</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/zl/ix/tl/zlixtl8tehddvrk36ykdfx6hd48.png"><br><img src="https://habrastorage.org/webt/5u/kq/cx/5ukqcxek-nslcezxse0dqot_cym.png"><br></div></div><br><a name="4"></a><h2>  Adding custom metrics to the application </h2><br>  Added <a href="https://www.app-metrics.io/">https://www.app-metrics.io/ to the</a> application. <br>  I will not describe in detail how to add them, while briefly - register the middleware for the increment of call counters of the api methods <div class="spoiler">  <b class="spoiler_title">This is what middleware looks like.</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AutoDiscoverRoutes</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HttpContext context</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (context.Request.Path.Value == <span class="hljs-string"><span class="hljs-string">"/favicon.ico"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; keys = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(); List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; vals = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> routeData = context.GetRouteData(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (routeData != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { keys.AddRange(routeData.Values.Keys); vals.AddRange(routeData.Values.Values.Select(p =&gt; p.ToString())); } keys.Add(<span class="hljs-string"><span class="hljs-string">"method"</span></span>); vals.Add(context.Request.Method); keys.Add(<span class="hljs-string"><span class="hljs-string">"response"</span></span>); vals.Add(context.Response.StatusCode.ToString()); keys.Add(<span class="hljs-string"><span class="hljs-string">"url"</span></span>); vals.Add(context.Request.Path.Value); Program.Metrics.Measure.Counter.Increment(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CounterOptions { Name = <span class="hljs-string"><span class="hljs-string">"api"</span></span>, <span class="hljs-comment"><span class="hljs-comment">//ResetOnReporting = true, // –æ–±–Ω—É–ª—è—Ç—å, –µ—Å–ª–∏ –∫–æ–ª–ª–µ—Ç–æ—Ä —Å–æ–±—Ä–∞–ª –¥–∞–Ω–Ω—ã–µ MeasurementUnit = Unit.Calls, Tags = new MetricTags(keys.ToArray(), vals.ToArray()) }); }</span></span></code> </pre></div></div><br>  And collected metrics are available at <a href="http://localhost:9376/metrics">http: // localhost: 9376 / metrics</a> <br><br><img src="https://habrastorage.org/webt/yc/-h/9n/yc-h9ndhal2nj4kgeablgor4oba.png"><br><br>  * IMetricRoot or its abstraction can be easily registered in services and used in the application ( <i>services.AddMetrics (Program.Metrics);</i> ) <br><br><a name="5"></a><h2>  Collecting metrics through Prometheus </h2><br>  The most basic setting of prometheus: add a new job to its config (prometheus.yml) and feed it a new target: <br><pre> <code class="bash hljs">global: scrape_interval: 15s evaluation_interval: 15s rule_files: <span class="hljs-comment"><span class="hljs-comment"># - "first.rules" # - "second.rules" scrape_configs: - job_name: prometheus static_configs: - targets: ['localhost:9090', '–µ—â—ë_–æ–¥–∏–Ω_—Å–µ—Ä–≤–∏—Å:–ø–æ—Ä—Ç']</span></span></code> </pre> <br>  But Prometheus has native support for collecting metrics from cubernetis <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/">https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config</a> <br>  I want to monitor each service individually filtering by tag apptype: business <br>  Having familiarized with dock it turns out so: <br><pre> <code class="bash hljs">- job_name: business-metrics <span class="hljs-comment"><span class="hljs-comment"># –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–¥—É–º–∞–ª –∏–º—è –¥–∂–æ–±–∞ metrics_path: /metrics kubernetes_sd_configs: - role: endpoints # –∫–∞–∫—É—é —Å—É—â–Ω–æ—Å—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å. –µ—â—ë –µ—Å—Ç—å service,pod,ingress static_configs: - targets: - localhost:9090 relabel_configs: # —Å–æ–±–∏—Ä–∞—é –º–µ—Ç—Ä–∏–∫–∏ —Å–µ—Ä–≤–∏—Å–æ–≤ —Ç–æ–ª—å–∫–æ –∏–∑ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ default –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π c –º–µ—Ç–∫–æ–π apptype = business - action: keep regex: default;business source_labels: - __meta_kubernetes_namespace - __meta_kubernetes_service_label_apptype</span></span></code> </pre> <br>  In Cubernetis there is a special place for storing configs files - <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/">ConfigMap</a> <br>  This is where the config is saved: <br><div class="spoiler">  <b class="spoiler_title">2-prometheus-configmap.yaml</b> <div class="spoiler_text"><pre> <code class="bash hljs">apiVersion: v1 kind: ConfigMap <span class="hljs-comment"><span class="hljs-comment"># —Ç–∏–ø —Å—É—â–Ω–æ—Å—Ç–∏, –æ–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ metadata: name: prometheus-config # –∏–º—è –∫–æ–Ω—Ñ–∏–≥-–º–∞–ø–ø—ã namespace: default labels: kubernetes.io/cluster-service: "true" addonmanager.kubernetes.io/mode: EnsureExists data: # –∏–º—è —Ñ–∞–π–ª–∞ –≤ –∫–æ–Ω—Ñ–∏–≥–µ prometheus.yml: | global: scrape_interval: 5s # Default is every 1 minute. evaluation_interval: 5s # The default is every 1 minute. scrape_configs: - job_name: prometheus static_configs: - targets: - localhost:9090 - job_name: business-metrics # –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–¥—É–º–∞–ª –∏–º—è –¥–∂–æ–±–∞ metrics_path: /metrics kubernetes_sd_configs: - role: endpoints # –∫–∞–∫—É—é —Å—É—â–Ω–æ—Å—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å. –µ—â—ë –µ—Å—Ç—å service,pod,ingress static_configs: - targets: - localhost:9090 relabel_configs: # —Å–æ–±–∏—Ä–∞—é –º–µ—Ç—Ä–∏–∫–∏ —Å–µ—Ä–≤–∏—Å–æ–≤ —Ç–æ–ª—å–∫–æ –∏–∑ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ default –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π c –º–µ—Ç–∫–æ–π apptype = business - action: keep regex: default;business source_labels: - __meta_kubernetes_namespace - __meta_kubernetes_service_label_apptype</span></span></code> </pre></div></div><br>  Departure for Cubernetis <br><pre> <code class="bash hljs">kubectl create -f .\2-prometheus-configmap.yaml</code> </pre> <br>  Now you need to shut the prometheus with this config file. <br><div class="spoiler">  <b class="spoiler_title">kubectl create -f. \ 3-deployment-prometheus.yaml</b> <div class="spoiler_text"><pre> <code class="bash hljs">apiVersion: extensions/v1beta1 kind: Deployment metadata: name: prometheus namespace: default spec: replicas: 1 template: metadata: labels: app: prometheus-server spec: containers: - name: prometheus image: prom/prometheus args: - <span class="hljs-string"><span class="hljs-string">"--config.file=/etc/config/prometheus.yml"</span></span> - <span class="hljs-string"><span class="hljs-string">"--web.enable-lifecycle"</span></span> ports: - containerPort: 9090 volumeMounts: - name: prometheus-config-volume <span class="hljs-comment"><span class="hljs-comment"># –∫–∞–∫–æ–π –≤–æ–ª—å—é–º –º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å mountPath: /etc/config/ # –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∫–∞–∫–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ volumes: - name: prometheus-config-volume # –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –≤–æ–ª—å—é–º–∞ –≤ –¥–µ–ø–ª–æ–µ configMap: defaultMode: 420 name: prometheus-config # –∏–º—è –∫–æ–Ω—Ñ–∏–≥-–º–∞–ø–ø—ã --- kind: Service apiVersion: v1 metadata: name: prometheus spec: selector: app: prometheus-server # —Å–µ–ª–µ–∫—Ç–æ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –ø–æ labels:app type: LoadBalancer # —Ä–µ–≤–µ—Ä—Å–ø—Ä–æ–∫—Å–∏ –∏–∑ –≤–Ω–µ –¥–æ –ø–æ–¥–æ–≤ ports: - protocol: TCP port: 9090 targetPort: 9090</span></span></code> </pre></div></div><br>  Pay attention - the file prometheus.yml is not indicated anywhere <br>  All files that have been specified in the config-map become files in the prometheus-config-volume section, which is mounted in the / etc / config / directory <br>  Also, the container contains the launch arguments with the path to the config <br>  --web.enable-lifecycle - says that you can pull POST / - / reload, which will apply new configs (useful if the config changes ‚Äúon the fly‚Äù and you don't want to restart the container) <br><br>  Properly warm <br><pre> <code class="bash hljs">kubectl create -f .\3-deployment-prometheus.yaml</code> </pre> <br>  Take a little over the rise of the basement and go to <a href="http://localhost:9090/targets">http: // localhost: 9090 / targets</a> , should see the endpoints of your service there <br><br><img src="https://habrastorage.org/webt/sz/vw/vg/szvwvg5evcq_gfbusz56mx1k-se.png"><br><br>  And on the main page, you can write requests to prometeus <br><pre> <code class="bash hljs">sum by (response, action, url, app) (delta(application_api[15s]))</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Provided that the site still someone like, it turns out</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/pq/gl/ss/pqglssktt2mud6b2i1nltnqptou.png"><br></div></div><br>  The query language is <a href="https://prometheus.io/docs/prometheus/latest/querying/basics/">https://prometheus.io/docs/prometheus/latest/querying/basics/</a> <br><br><a name="6"></a><h2>  Displaying metrics in Grafana </h2><br>  We were lucky - up to version 5 you could only slip configs of dashboards via HTTP API, but now you can do the same trick as with Prometheus <br>  Graphan by default at startup <a href="http://docs.grafana.org/administration/provisioning/">can tighten</a> data source <a href="http://docs.grafana.org/administration/provisioning/">configs</a> and dashboards <br><ol><li>  <code>/etc/grafana/provisioning/datasources/</code> - source configs (settings for access to prometheus, postgres, zabbiks, elastic, etc.) </li><li>  <code>/etc/grafana/provisioning/dashboards/</code> - access <code>/etc/grafana/provisioning/dashboards/</code> settings </li><li>  <code>/var/lib/grafana/dashboards/</code> - here I will store the dashboards themselves as json files </li></ol><br><div class="spoiler">  <b class="spoiler_title">It turned out like this</b> <div class="spoiler_text"><pre> <code class="bash hljs">apiVersion: v1 kind: ConfigMap metadata: creationTimestamp: null name: grafana-provisioning-datasources namespace: default data: all.yml: | datasources: - name: <span class="hljs-string"><span class="hljs-string">'Prometheus'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: <span class="hljs-string"><span class="hljs-string">'prometheus'</span></span> access: <span class="hljs-string"><span class="hljs-string">'proxy'</span></span> org_id: 1 url: <span class="hljs-string"><span class="hljs-string">'http://prometheus:9090'</span></span> is_default: <span class="hljs-literal"><span class="hljs-literal">true</span></span> version: 1 editable: <span class="hljs-literal"><span class="hljs-literal">true</span></span> --- apiVersion: v1 kind: ConfigMap metadata: creationTimestamp: null name: grafana-provisioning-dashboards namespace: default data: all.yml: | apiVersion: 1 providers: - name: <span class="hljs-string"><span class="hljs-string">'default'</span></span> orgId: 1 folder: <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: file disableDeletion: <span class="hljs-literal"><span class="hljs-literal">false</span></span> updateIntervalSeconds: 10 <span class="hljs-comment"><span class="hljs-comment">#how often Grafana will scan for changed dashboards options: path: /var/lib/grafana/dashboards --- apiVersion: v1 kind: ConfigMap metadata: creationTimestamp: null name: grafana-dashboards namespace: default data: service-http-requests.json: | { "annotations": { "list": [ { "builtIn": 1, "datasource": "-- Grafana --", "enable": true, "hide": true, "iconColor": "rgba(0, 211, 255, 1)", "name": "Annotations &amp; Alerts", "type": "dashboard" } ] }, "editable": true, "gnetId": null, "graphTooltip": 0, "links": [], "panels": [ { "aliasColors": {}, "bars": false, "dashLength": 10, "dashes": false, "fill": 1, "gridPos": { "h": 9, "w": 12, "x": 0, "y": 0 }, "id": 2, "legend": { "alignAsTable": false, "avg": false, "current": false, "max": false, "min": false, "rightSide": true, "show": true, "total": false, "values": false }, "lines": true, "linewidth": 1, "links": [], "nullPointMode": "null", "percentage": false, "pointradius": 5, "points": false, "renderer": "flot", "seriesOverrides": [], "spaceLength": 10, "stack": false, "steppedLine": false, "targets": [ { "expr": "sum by (response, action, url, app) (delta(application_api[15s]))", "format": "time_series", "interval": "15s", "intervalFactor": 1, "legendFormat": "{{app}} {{response}} - {{url}}", "refId": "A" } ], "thresholds": [], "timeFrom": null, "timeRegions": [], "timeShift": null, "title": "Http requests", "tooltip": { "shared": true, "sort": 0, "value_type": "individual" }, "type": "graph", "xaxis": { "buckets": null, "mode": "time", "name": null, "show": true, "values": [] }, "yaxes": [ { "format": "short", "label": null, "logBase": 1, "max": null, "min": null, "show": true }, { "format": "short", "label": null, "logBase": 1, "max": null, "min": null, "show": true } ], "yaxis": { "align": false, "alignLevel": null } } ], "refresh": "5s", "schemaVersion": 16, "style": "dark", "tags": [], "templating": { "list": [] }, "time": { "from": "now-30m", "to": "now" }, "timepicker": { "refresh_intervals": [ "5s", "10s", "30s", "1m", "5m", "15m", "30m", "1h", "2h", "1d" ], "time_options": [ "5m", "15m", "1h", "6h", "12h", "24h", "2d", "7d", "30d" ] }, "timezone": "", "title": "Business metrics", "uid": "Dm0tD0Qik", "version": 1 }</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Deploy itself, nothing new</b> <div class="spoiler_text"><pre> <code class="bash hljs">apiVersion: extensions/v1beta1 kind: Deployment metadata: name: grafana namespace: default labels: app: grafana component: core spec: replicas: 1 template: metadata: labels: app: grafana component: core spec: containers: - image: grafana/grafana name: grafana imagePullPolicy: IfNotPresent resources: limits: cpu: 100m memory: 100Mi requests: cpu: 100m memory: 100Mi env: - name: GF_AUTH_BASIC_ENABLED value: <span class="hljs-string"><span class="hljs-string">"true"</span></span> - name: GF_AUTH_ANONYMOUS_ENABLED value: <span class="hljs-string"><span class="hljs-string">"true"</span></span> - name: GF_AUTH_ANONYMOUS_ORG_ROLE value: Admin readinessProbe: httpGet: path: /login port: 3000 <span class="hljs-comment"><span class="hljs-comment"># initialDelaySeconds: 30 # timeoutSeconds: 1 volumeMounts: - name: grafana-provisioning-datasources mountPath: /etc/grafana/provisioning/datasources/ - name: grafana-provisioning-dashboards mountPath: /etc/grafana/provisioning/dashboards/ - name: grafana-dashboards mountPath: /var/lib/grafana/dashboards/ volumes: - name: grafana-provisioning-datasources configMap: defaultMode: 420 name: grafana-provisioning-datasources - name: grafana-provisioning-dashboards configMap: defaultMode: 420 name: grafana-provisioning-dashboards - name: grafana-dashboards configMap: defaultMode: 420 name: grafana-dashboards nodeSelector: beta.kubernetes.io/os: linux --- apiVersion: v1 kind: Service metadata: name: grafana namespace: default labels: app: grafana component: core spec: type: LoadBalancer ports: - protocol: TCP port: 3000 targetPort: 3000 selector: app: grafana component: core</span></span></code> </pre> </div></div><br>  Expanding <br><pre> <code class="bash hljs">kubectl create -f .\4-grafana-configmap.yaml kubectl create -f .\5-deployment-grafana.yaml</code> </pre> <br>  Remember that grafana doesn‚Äôt immediately rise, it scares a bit of sqlite migrations that you can <a href="https:kubernetes-dashboard:/proxy/">see in the submenu logs</a> <br>  Now go to <a href="http://localhost:3000/">http: // localhost: 3000 /</a> <br>  And click on the dashboard <br><br><img src="https://habrastorage.org/webt/-s/qu/vp/-squvpxh7r3uxz75j3oripxch_8.png"><br><img src="https://habrastorage.org/webt/pl/yp/ze/plypzemdf5a1z0lpshu6uli3tyi.png"><br><br>  If you want to add a new view or change an existing one - change it directly in the interface, and then click Save, you will get a modal window with json, which you need to put into the config-map <br><div class="spoiler">  <b class="spoiler_title">Everything is deployed and works fine</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/go/id/tl/goidtlbneravv92p6g-4mkeonro.png"></div></div><br><a name="7"></a><h2>  Scheduled Tasks </h2><br>  To perform crown tasks in a cuber there is a concept CronJob <br>  With the help of CronJob, you can schedule the execution of any tasks, the simplest example: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># https://kubernetes.io/docs/tasks/job/automated-tasks-with-cron-jobs/ apiVersion: batch/v1beta1 kind: CronJob metadata: name: runapijob spec: schedule: "*/1 * * * *" jobTemplate: spec: template: spec: containers: - name: runapijob image: busybox args: - /bin/sh - -c - date; wget -O - http://metricsdemo:9376/api/job/run/wakeUp &gt; /dev/null restartPolicy: OnFailure</span></span></code> </pre> <br>  In the section of the schedule sets the classic rule for the crown <br>  On the trigger pod of the container (busybox) is launched in which I pull the metricsdemo service api method <br>  You can use the command to monitor the job. <br><pre> <code class="bash hljs">kubectl.exe get cronjob runapijob --watch</code> </pre> <br><img src="https://habrastorage.org/webt/vt/1y/9v/vt1y9vjfhpygkk3xzokbywcbvnc.png"><br><br>  The main service, which is pulled from the job, is launched in several copies, because the call to the service goes to one of the pods with an approximately uniform spread <br><div class="spoiler">  <b class="spoiler_title">What it looks like in Prometheus</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/hu/v2/tt/huv2ttrdtjee5ddvgxyk4ucwkou.png"></div></div><br><div class="spoiler">  <b class="spoiler_title">In order to debug joba you can trigger manually</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ev/k2/c7/evk2c7bl5zdr4gdqf1jcwvddu_w.png"></div></div><br>  A small demo on the example of calculating the number œÄ, about the difference in launches from the console <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># –∑–∞–ø—É—Å–∫ —Ü–µ–ª–æ–≥–æ –¥–µ–ø–ª–æ–π–º–µ–Ω—Ç–∞, –Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å - —Ä–µ–ø–ª–∏–∫–∞—Å–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –ø—ã—Ç–∞–µ—Ç—Å—è –µ–≥–æ —Ä–µ—Å—Ç–∞—Ä—Ç–∞–Ω—É—Ç—å kubectl run pi --image=perl -- perl -Mbignum=bpi -wle 'print bpi(2000)' # –∑–∞–ø—É—Å–∫ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–≥–æ –¥–∂–æ–±–∞. –ó–∞–ø—É—Å—Ç–∏—Ç—Å—è, –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è, –∏ –≤—Å—ë. –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—á—ë—Ç–∞ - –≤ –ª–æ–≥–∞—Ö kubectl run pi --image=perl --restart=OnFailure -- perl -Mbignum=bpi -wle 'print bpi(2000)' # –∑–∞–ø—É—Å–∫ –∫—Ä–æ–Ω–¥–∂–æ–±–∞ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç kubectl run pi --image=perl --restart=OnFailure --schedule="0/5 * * * ?" -- perl -Mbignum=bpi -wle 'print bpi(2000)'</span></span></code> </pre> <br><br><a name="8"></a><h2>  fault tolerance </h2><br>  If the application terminates unexpectedly, the cluster restarts pod <br>  For example, I made a method that drops api <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">HttpGet(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"kill/me"</span></span></span><span class="hljs-meta">)</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Kill</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exception(<span class="hljs-string"><span class="hljs-string">"Selfkill"</span></span>); }</code> </pre> <br>  <i>* an exception occurred in api in the async method; void is considered an unhandled exception, which completely crashes the application</i> <br><br>  I make a call to <a href="http://localhost:9376/api/job/kill/me">http: // localhost: 9376 / api / job / kill / me</a> <br>  The list of pods shows that one of the pods of the service was restarted. <br><br><img src="https://habrastorage.org/webt/f9/qr/t3/f9qrt3v1y1oo1ks2bucvt5tarvi.png"><br><br>  The logs command shows the current output, and with the -p option will output the logs of the previous instance.  This way you can find out the reason for the restart <br><br>  I think with a simple fall, everything is clear: fell - rose <br><br>  But the application can be conditionally alive, i.e.  not fallen but doing nothing or doing their work, but slowly <br><br>  According to the <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/">documentation,</a> there are at least two types of tests for "survivability" of applications in the hearth <br><ol><li>  readiness - this type of test is used to understand whether it is possible to start traffic to this pod.  If not, pod is unbalanced until it returns to normal. <br></li><li>  liveness - test the application for survivability.  In particular - if there is no access to a vital resource or the application does not respond at all (say, deadlock and therefore timeout), the container will be restarted.  All http codes between 200 and 400 are considered successful, the rest are Fail. <br></li></ol><br>  I will check the restart by timeout, for this I add a new api method, which, according to a certain command, will begin to slow down the method of checking survivability for 123 seconds <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> deadlock; [HttpGet(<span class="hljs-string"><span class="hljs-string">"alive/{cmd}"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Kill</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> cmd</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cmd == <span class="hljs-string"><span class="hljs-string">"deadlock"</span></span>) { deadlock = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Deadlocked"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (deadlock) Thread.Sleep(<span class="hljs-number"><span class="hljs-number">123</span></span> * <span class="hljs-number"><span class="hljs-number">1000</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> deadlock ? <span class="hljs-string"><span class="hljs-string">"Deadlocked!!!"</span></span> : <span class="hljs-string"><span class="hljs-string">"Alive"</span></span>; }</code> </pre> <br><br>  In the file 1-deployment-app.yaml I add a couple of sections to the container: <br><pre> <code class="bash hljs">containers: - name: metricsdemo image: localhost:5000/sansys/metricsdemo3:6 ports: - containerPort: 80 readinessProbe: <span class="hljs-comment"><span class="hljs-comment"># —Å–ø–æ—Å–æ–±–Ω–æ –ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–µ–π—á–∞—Å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã httpGet: path: /health port: 80 initialDelaySeconds: 5 periodSeconds: 5 livenessProbe: # –∂–∏–≤–æ –ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ –ø—Ä–∏–Ω—Ü–∏–ø–µ httpGet: path: /api/job/alive/check port: 80 initialDelaySeconds: 5 periodSeconds: 5</span></span></code> </pre> <br>  Redeploy, make sure the apish is running and subscribe to events <br><pre> <code class="bash hljs">kubectl get events --watch</code> </pre> <br>  I press the menu Deadlock me ( <a href="http://localhost:9376/api/job/alive/deadlock">http: // localhost: 9376 / api / job / alive / deadlock</a> ) <br><br><img src="https://habrastorage.org/webt/ed/ir/bb/edirbbiw3gjjoptubdh7992z6yy.png"><br><br>  And within five seconds I start to observe the problem and its solution. <br><br><pre> <code class="bash hljs">1s Warning Unhealthy Pod Liveness probe failed: Get http://10.1.0.137:80/api/job/alive/check: net/http: request canceled (Client.Timeout exceeded <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> awaiting headers) 1s Warning Unhealthy Pod Liveness probe failed: Get http://10.1.0.137:80/api/job/alive/check: net/http: request canceled (Client.Timeout exceeded <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> awaiting headers) 0s Warning Unhealthy Pod Liveness probe failed: Get http://10.1.0.137:80/api/job/alive/check: net/http: request canceled (Client.Timeout exceeded <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> awaiting headers) 0s Warning Unhealthy Pod Readiness probe failed: Get http://10.1.0.137:80/health: dial tcp 10.1.0.137:80: connect: connection refused 0s Normal Killing Pod Killing container with id docker://metricsdemo:Container failed liveness probe.. Container will be killed and recreated. 0s Normal Pulled Pod Container image <span class="hljs-string"><span class="hljs-string">"localhost:5000/sansys/metricsdemo3:6"</span></span> already present on machine 0s Normal Created Pod Created container 0s Normal Started Pod Started container</code> </pre> <br><br><a name="9"></a><h2>  findings </h2><br><ol><li>  On the one hand, the threshold of entry was much lower than I thought, on the other hand, this is not a real kubernetes-cluster, but only a developer‚Äôs computer.  And the limits for resources, stateful applications, a / b testing, etc. were not considered. </li><li>  Prometheus tried for the first time at all, but reading various documents and examples in the process of reviewing the cuber made it clear that it was quite good for collecting metrics from the cluster and applications in it </li><li>  So good that it allows the developer to implement a feature on his computer and, in addition to information, also applies to the deployment - the schedule of graphics to the graph.  As a consequence, the new metrics automatically without add.  efforts will be displayed on the Stage and Prode.  Conveniently </li></ol><br><br><a name="10"></a><h2>  Notes </h2><br><ol><li>  Applications can contact each other by <code>–∏–º–µ–Ω–∏ —Å–µ—Ä–≤–∏—Å–∞:–ø–æ—Ä—Ç—É</code> , which is done with graph ‚Üí prometheus.  For those familiar with docker-compose, there is nothing new here. </li><li>  <code>kubectl create -f file.yml</code> - create an entity </li><li>  <code>kubectl delete -f file.yml</code> - delete entity </li><li>  <code>kubectl get pod</code> - get a list of all the pods (service, endpoints ...) <ul><li>  <code>--namespace=kube-system</code> - namespace filtering </li><li>  <code>-n kube-system</code> - the same as </li></ul></li><li>  <code>kubectl -it exec grafana-d8d4d9f5c-cvnkh -- /bin/bash</code> - attachment to the sub </li><li>  <code>kubectl delete service grafana</code> - delete service, pod.  deploy (--all - delete all) </li><li>  <code>kubectl describe</code> - describe the entity (all at once) </li><li>  <code>kubectl edit service metricsdemo</code> - edit all ditches "on the fly" through the launch of the notebook <div class="spoiler">  <b class="spoiler_title">Demo</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/xh/nc/c2/xhncc23bokunuyqam3ekkntdxrw.png"></div></div></li><li>  <code>kubectl --help</code> - great help) </li><li>  A typical problem is pod (consider a running image), something went wrong and there are no options, except how to unwind inside (via tcpdump / nc etc.).  - Yuzay kubectl-debug <a href="https://habr.com/ru/company/flant/blog/436112/">habr.com/en/company/flant/blog/436112</a> <br></li></ol><br><br><a name="11"></a><h2>  Bibliography </h2><br><ol><li>  <a href="https://www.app-metrics.io/">What is the App Metrics?</a> </li><li>  Kubernetes <br><ul><li>  <a href="https://devopscube.com/kubernetes-deployment-tutorial/">Kubernetes Deployment Tutorial For Beginners</a> </li><li>  <a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/deployment/">Deployments</a> </li><li>  <a href="https://kubernetes.io/docs/tasks/run-application/run-stateless-application-deployment/">Run a Stateless Application Using a Deployment</a> </li><li>  <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/">What is ConfigMap</a> </li><li>  <a href="https://kubernetes.io/docs/tasks/job/automated-tasks-with-cron-jobs/">Cronjob</a> </li><li>  <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/">Liveness an readiness probes</a> </li><li>  <a href="https://kubernetes.io/docs/reference/kubectl/cheatsheet/">kubectl cheat sheet</a> </li></ul></li><li>  Prometheus <br><ul><li>  <a href="https://prometheus.io/docs/prometheus/latest/querying/basics/">Query language</a> </li><li>  <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/">Prometheus configuration for cuber</a> </li><li>  <a href="https://habr.com/ru/company/flant/blog/353410/">Device and mechanism of work of Prometheus Operator in Kubernetes</a> </li></ul></li><li>  <a href="http://docs.grafana.org/administration/provisioning/">Pre-prepared grafana configuration</a> </li><li>  <a href="https://github.com/microservices-demo/microservices-demo/tree/master/deploy/kubernetes/manifests-monitoring">Spy on how people are doing</a> (but there are already some things out of date) - in principle there is about logging, alerting, etc. </li><li>  <a href="https://github.com/helm/helm">Helm</a> - The package manager for Kubernetes - through it, it was easier to organize Prometheus + Grafana, but manually - more understanding appears </li><li>  <a href="https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/prometheus">Jamla for promethus from cuber</a> </li><li>  <a href="https://github.com/hjacobs/kubernetes-failure-stories">Kubernetes Failure Stories</a> </li><li>  <a href="https://habr.com/ru/post/358264/">Kubernetes-ha.</a>  <a href="https://habr.com/ru/post/358264/">Deploy Kubernetes failover cluster with 5 masters</a> </li></ol><br> <a href="https://github.com/SanSYS/kuberfirst"><img src="https://github.com/favicon.ico" width="22"></a>  <a href="https://github.com/SanSYS/kuberfirst">Source code and jade are available on github</a> </div><p>Source: <a href="https://habr.com/ru/post/437286/">https://habr.com/ru/post/437286/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>