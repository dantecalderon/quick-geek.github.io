<div class="post__text post__text-html js-mediator-article"><p>  Information on Sphinx is not as much as we would like.  Excess article does not hurt. <br>  The first steps in mastering Sphinx helped me to make articles. <a href="https://habr.com/ru/post/104690/">Creating an exploratory search engine on Sphinx + php</a> and an <a href="https://habr.com/ru/post/132118/">example of Sphinx search on a real project - Tecdoc auto parts store.</a> I advise you to start with them. </p><br><p>  Some time on my site worked search through LIKE for each word of the query.  I wanted more, and here are the cases that will now be handled correctly: </p><br><ul><li>  Word forms.  The issuance of "screws" and "screws" should be the same. </li><li>  Search by word fragment. </li><li>  Search for non-integer numbers.  Separator point and comma. </li><li>  Letter yo </li><li>  Typical mistakes.  For example, "shock absorber." </li><li>  Synonyms.  Regulator and ESC. </li><li>  Tongue.  mAh and mAh, B and V, AAA in Latin and Cyrillic. </li><li>  Word of letters and numbers.  10x15x4, 6000mAh </li></ul><a name="habracut"></a><br><h2 id="razdel-source-i-dopolnitelnaya-sortirovka">  Source section and additional sorting </h2><br><p>  Issuance must first contain positions available, then temporarily absent, then archived.  And all these three groups should be sorted by relevance.  To do this, you must specify the attributes.  In my case, these are the clearance and in_stock fields of the source section sphinx.conf </p><br><pre><code class="sql hljs">sql_query = \ <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-string"><span class="hljs-string">`art`</span></span>, <span class="hljs-string"><span class="hljs-string">`name`</span></span>, <span class="hljs-string"><span class="hljs-string">`clearance`</span></span>, <span class="hljs-string"><span class="hljs-string">`in_stock`</span></span> \ <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> items_zip <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> show_flag=<span class="hljs-number"><span class="hljs-number">1</span></span> sql_attr_bool = clearance sql_attr_uint = in_stock</code> </pre> <br><p>  These fields will be used in generating the output in PHP.  I will describe below. </p><br><h2 id="razdel-index-v-sphinxconf">  The index section in sphinx.conf </h2><br><p>  <strong>morphology = stem_enru</strong> <br>  Morphology solves my first task.  Searching for 'bearings', 'bearing', 'bearings' will lead to a single result. </p><br><p>  Stems (stem_enru) are faster, lemmas (lemmatize_ru) are more accurate.  I tried only stammy.  The choice will affect your wordforms replacement dictionary.  Want to change - will have to rewrite. </p><br><p>  <strong>min_word_len = 1</strong> <br>  We index words of any length. </p><br><p>  <strong>html_strip = 1</strong> <br>  Remove html tags </p><br><p>  <strong>min_infix_len = 1</strong> <br>  Search will be on a fragment of the word.  Let's index fragments up to 1 letter.  Since I have a base of less than 10,000 items, I don’t save on the index. </p><br><p>  <strong>expand_keywords = 1</strong> <br>  Automatically leads the query to the form "(running | <em>running</em> | = running)".  min_infix_len and expand_keywords will cause the RV 2205 request to issue the RV2205.  By the way, a dash is a separator equivalent to a space.  So the RV-2205 will issue the same RV2205. </p><br><p>  <strong>charset_table = 0..9, A..Z-&gt; a..z, _, a..z, U + 410..U + 42F-&gt; U + 430..U + 44F, U + 430..U + 44F, U + 401-&gt; U + 0435, U + 451-&gt; U + 0435</strong> <br>  We give Latin and Cyrillic in lower case.  We replace it with e. </p><br><p>  <strong>blend_chars = +, &amp;, U + 2C, U + 2E</strong> <br>  I have a lot of non-integer numbers.  They need to be indexed completely.  U + 2C and U + 2E is a period and comma.  For example, 1.25 will be indexed as '1.25', '1' and '25'. </p><br><p>  <strong>regexp_filter = (\ d +) \, (\ d +) =&gt; \ 1. \ 2</strong> <br>  Decimals in numbers can be separated by dots and commas: "1.75", "1.75".  Let's get everything to the point </p><br><p>  <strong>Synonyms and Typos</strong> </p><br><p>  Units of measurement can be written in Russian or English: mm-mm, mAh-mAh, mW-mW.  We add to the dictionary of synonyms, the path to which is specified in wordforms: "moc&gt; mah".  I choose the language for the index according to my own preferences. </p><br><p>  The ~ sign indicates to apply the replacement after the morphology handler.  This allows you not to write all the word forms and instead of the rules for 'peel', 'peel', 'peel' write "~ cork&gt; body" </p><br><p>  My list is complete: </p><br><pre> <code class="plaintext hljs">~регулятор &gt; esc регуль &gt; esc мач &gt; mah ~корк &gt; кузов ~корпус &gt; кузов ~пищалк &gt; buzz ~бузер &gt; buzz ~буззер &gt; buzz ~зуммер &gt; buzz ~зумер &gt; buzz ~бальс &gt; бальз ~двигатель &gt; мотор ~электродвигатель &gt; мотор li-po &gt; lipo ~аммортизатор &gt; амортизатор ~зарядк &gt; зарядн серво &gt; сервопривод серва &gt; сервопривод vtx &gt; видеопередатчик ~антен &gt; антенн lollipop &gt; lolipop battery &gt; аккумулятор ~пульт &gt; аппаратур ~безколлекторн &gt; бесколлекторн ~пиньен &gt; пиньон mkF &gt; мкФ бек &gt; BEC бэк &gt; BEC ~термоусадк &gt; термоусадочн LED &gt; светодиод ~светодиодн &gt; светодиод driver &gt; драйвер ~пакет &gt; сумк ~пропеллер &gt; лопаст ААА &gt; AAA АА &gt; AA М &gt; M mm &gt; мм мВт &gt; mW В &gt; V А &gt; A deans &gt; t-plug tplug &gt; t-plug</code> </pre> <br><p>  <strong>Sticking letters to numbers</strong> </p><br><p>  Sometimes numbers are part of the name (for example LCD5208D), but more often the characteristic (100mAh, 10x15x4mm).  Separate all numbers from letters and index them. </p><br><p>  This will solve several problems: </p><br><ul><li>  Someone will look for a '10x15x4' bearing, someone will look for a '15x10x4' bearing.  Indexed numbers will lead to the correct issue. </li><li>  Units of measurement may or may not be separated by a space from the number: "1.75mm", "1.75 mm". </li><li>  For titles this is also useful.  The correct output will be on the three recording options LCD-5208, LCD 5208 and LCD5208 </li></ul><br><p>  Before writing a regular expression for separating numbers, you need to unify the delimiters.  It is important to remember that regular expressions are all executed sequentially. </p><br><p>  We remove X, He and a star in sizes such as 10x15x4 M3x10: </p><br><pre> <code class="plaintext hljs">regexp_filter = (\d+)[x\x{0445}\*] =&gt; \1 x</code> </pre> <br><p>  Drop tails: </p><br><pre> <code class="plaintext hljs">regexp_filter = (\d*\.?\d+)(\D+) =&gt; \1 \2</code> </pre> <br><p>  And heads: </p><br><pre> <code class="plaintext hljs">regexp_filter = (\D+)(\d*\.?\d+) =&gt; \1 \2</code> </pre> <br><p>  Let's drop the "mm", as they are often not listed in the product name. <br>  Make the stop.txt file and write it in stopwords. <br>  Content: </p><br><pre> <code class="plaintext hljs">мм mm</code> </pre> <br><h2 id="teper-nemnogo-pro-php">  Now a little about PHP </h2><br><p>  Sphinxapi will sooner or later be depricated.  We will use Sphinxql.  For this you need to connect to the database.  In my case Sphinx connected via hosting it looks like this: </p><br><pre> <code class="php hljs">$opt = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( PDO::ATTR_ERRMODE =&gt; PDO::ERRMODE_EXCEPTION, PDO::ATTR_DEFAULT_FETCH_MODE =&gt; PDO::FETCH_ASSOC, PDO::ATTR_EMULATE_PREPARES =&gt; <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>, ); $dsn = <span class="hljs-string"><span class="hljs-string">'mysql:host=127.0.0.1;port=9306;'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;pdo = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PDO($dsn, DB_USER, DB_PASS, $opt);</code> </pre> <br><p>  And all communication with Spinxql is one SELECT sending the filtered query text </p><br><pre> <code class="php hljs">$stmt = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;pdo-&gt;prepare(<span class="hljs-string"><span class="hljs-string">"SELECT `id`, WEIGHT() as `w`, in_stock&gt;0 AS stock FROM `items` WHERE MATCH ('"</span></span>.$search.<span class="hljs-string"><span class="hljs-string">"') ORDER BY clearance ASC, stock DESC, w DESC LIMIT "</span></span>.$limit.<span class="hljs-string"><span class="hljs-string">" OPTION field_weights=(name=10, art=3, cat_names=3, model_names=3)"</span></span>);</code> </pre> <br><p>  SphinxQL does not understand the expression in the ORDER BY sorting section, so WEIGHT () and in_stock&gt; 0 had to be placed in the fields.  By the way, the default LIMIT is only 20. </p><br><p>  Sorting will first give the position available, then temporarily absent, then archived.  And all these three groups will be sorted by relevance (weight). </p><br><p>  Through field_weights we set what fields will have big weight. </p><br><p>  Having executed request, we will receive the sorted array id.  But, unfortunately, the selection of data through WHERE id IN () will break this sorting.  We'll have to form your request for each id. </p><br><p>  At the debugging stage, the query <strong>"SHOW META"</strong> helps immediately after the SELECT query.  Especially for checking wordforms dictionary and regular expression filters.  You can see a list of keywords into which the query has decomposed. </p><br><h2 id="uslozhnyaem-sql_query">  Complement sql_query </h2><br><p>  We sell parts.  I decided to add to the index the name of the product category and the name of the model for which the spare part is intended.  But each product can be tied to several categories at once and be suitable for several models.  And I discovered the <a href="http://blog.nagaychenko.com/2010/06/15/%25D1%2580%25D0%25B0%25D0%25B1%25D0%25BE%25D1%2582%25D0%25B0-%25D1%2581-%25D1%2584%25D1%2583%25D0%25BD%25D0%25BA%25D1%2586%25D0%25B8%25D0%25B5%25D0%25B9-group_concat/">GROUP_CONCAT</a> function. It allows you to get data by grouping into a string.  For example, the categories.name field will contain all categories of the selected items_zip.id separated by spaces. </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> items_zip.id, <span class="hljs-string"><span class="hljs-string">`art`</span></span>, items_zip.<span class="hljs-string"><span class="hljs-string">`name`</span></span>, <span class="hljs-string"><span class="hljs-string">`clearance`</span></span>, <span class="hljs-string"><span class="hljs-string">`in_stock`</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">GROUP_CONCAT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> categories.name SEPARATOR <span class="hljs-string"><span class="hljs-string">' '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> cat_names, <span class="hljs-keyword"><span class="hljs-keyword">GROUP_CONCAT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> items.family SEPARATOR <span class="hljs-string"><span class="hljs-string">' '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> model_names <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> items_zip <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> items_cat <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> items_cat.item_id=items_zip.id <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> categories <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> categories.id=items_cat.cat_id <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> zip_comp <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> zip_comp.zip_id=items_zip.id <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> items <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> zip_comp.model_id=items.id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> items_zip.show_flag=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> items_zip.id</code> </pre> </div>