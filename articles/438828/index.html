<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Lazarus - write component for sprite animation</title>
  <meta name="description" content="Instead of the preface 
 In the Odessa school, students of the 8th grade at computer science lessons use the free Lazarus cross-platform development e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-6974184241884155",
      enable_page_level_ads: true
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>Lazarus - write component for sprite animation</h1><div class="post__text post__text-html js-mediator-article"><h6>  Instead of the preface </h6><br>  In the Odessa school, students of the 8th grade at computer science lessons use the free Lazarus cross-platform development environment ( <a href="http://www.lazarus-ide.org/">official website</a> ), which outwardly and internally resembles the favorite by many Delphi, using the version of Object Pascal called Free Pascal and in fact greatly simplifies the process of entering programming. <br><br>  But children are not interested in writing a program for calculating the force of gravity using the formula F = mg, which is not yet understood by them.  Almost all the children I tried to teach programming, from the first lesson they want to write a game.  Fortunately, Lazarus is also great for writing simple games. <br><br>  However, to create animated sprites, I needed a component that represents an arbitrary image fragment (which shows several different projections of the same character in different phases of the movement), but there is no such component in the standard package.  It turned out to be quite easy to write it myself, and I want to tell about this technology in this article. <a name="habracut"></a><br><br>  For displaying fun graphic content, instead of a dry business set of standard components, Lazarus (like Delphi) has 3 components on the Additional tab: <br>  - TImage (display images from an arbitrary file); <br>  - TShape (display of one of several predefined graphics primitives); <br>  - TPaintBox (display canvas, on which you can draw programmatically). <br><br>  The most spectacular for the student is to load a small sprite into a TImage and write a program to move it around the screen - on mouse / keyboard events, automatically in a loop, or automatically on an event from the timer. <br><br>  As soon as it starts to work, the student has the following legitimate question: is it possible to make the character move?  And is it possible to make it so that he does not constantly look at us, but turn in the direction coinciding with the direction of movement? <br><br>  On the Web, you can find a large number of ready-made images for use in game development.  And many characters are pre-designed in several projections and several animation frames (as, for example, <a href="http://untamed.wild-refuge.net/rmxpresources.php%3Fcharacters">here on this site</a> ). <br><br>  Here is an example of an image where the sprites are arranged in a table, in which each row corresponds to a certain projection, and each column represents a specific phase of the animation: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/g1/kg/c-/g1kgc-kfi7lnktzp3npiaed3vhy.png"></div><br><div class="spoiler">  <b class="spoiler_title">Why so many pictures?</b> <div class="spoiler_text">  To display such a sprite, it is enough to place a simple component on the screen that displays not the entire image, but only one fragment of it;  and then, by changing the offset of the selected fragment horizontally and vertically, you can force the character to turn in different directions and make cyclical movements (for example, flapping wings or steps with legs).  This technique is often used in web development: even simple icon sets for business graphics are often placed in one file and displayed in different places on the page with different offsets, giving the impression of different images. </div></div><br>  Unfortunately, the TImage component included in the standard delivery of Lazarus (and Delphi) does not allow to show an arbitrary fragment of the image: by changing its properties, we can make it show only the entire image, the upper left corner or its central part.  To display an arbitrary fragment of the image, given the displacement and dimensions along both axes, some other component is needed.  But as it turned out, making it yourself in Lazarus is a snap! <br><br><h6>  Create a new component </h6><br>  As an instruction for creating components, I used the <a href="http://wiki.freepascal.org/How_To_Write_Lazarus_Component">official manual</a> . <br><br>  Everything is written there in sufficient detail, duplicating does not make sense.  I will only dwell on some points. <br><br>  1. Standard Project Wizard does not offer us to create a package, and in order to somehow get access to the editor, select ‚ÄúNew Project‚Äù (in the Russian version - ‚ÄúNew Project‚Äù) <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sf/9m/gu/sf9mguxgv3kux3gf9jeika4aoew.png"></div><br>  and then "Application" (in the Russian version - "Application"): <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/se/8y/p1/se8yp1ohh6ipqartxklpqijmtg0.png"></div><br>  2. Acting further on the instructions, in the ‚ÄúPackage‚Äù menu (in the Russian version - ‚ÄúPackage‚Äù), select the top item ‚ÄúNew Package ...‚Äù (in the Russian version - ‚ÄúNew Package ...‚Äù), select the file name and path to save.  I called my new package ‚ÄúGame‚Äù and placed it in a separate folder with the same name: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/-7/5c/ji/-75cji5nhkxma0oabjnsinegqwo.png"></div><br>  I created a separate Lazarus / Cmp folder with the expectation that I may have several different packages with components, and already in this folder I created the ‚ÄúGame‚Äù folder. <br><br>  If everything is done correctly, a new (still empty) package window should appear on the screen. <br><br>  3. Acting further again according to the instructions, to create a new component in the package window, click the ‚ÄúAdd‚Äù button (in the Russian version - ‚ÄúAdd‚Äù) and in the drop-down list select ‚ÄúNew Component‚Äù (in the Russian version - ‚ÄúNew Component‚Äù): <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/1v/rr/hc/1vrrhccbkjyh7jte6m0c4j6cfcw.png"></div><br>  We specify TCustomImage as an ancestor class - this class is actually used to implement the TImage component, but differs from it in that it does not contain published properties and allows us to determine the set of properties that will be available in the designer for our component. <br><br><div class="spoiler">  <b class="spoiler_title">What is published properties?</b> <div class="spoiler_text">  For those who do not know this, I‚Äôll clarify that published is a class section (like public) that describes new ones or simply specifies inherited properties that should be available in the visual property editor at the program development stage.  Intermediate classes do not declare anything in this section, leaving the programmer himself to put in there what he deems necessary.  So, the TImage class does not add any functionality, but only puts into the published section a number of properties inherited from the parent TCustomImage.  We need to hide some of these properties, so we will also inherit our new component from TCustomImage and print only what does not contradict the logic of our component. </div></div><br><div class="spoiler">  <b class="spoiler_title">Icon for component</b> <div class="spoiler_text">  It would be a good style to draw a personalized icon for each new component, but since our task is to show how simple it is, we will leave this field blank, which will result in the standard icon used in Lazarus / Delphi for all self-made components displayed on the toolbar. . <br>  By the way, the above mentioned instruction contains a separate section dedicated to creating icons for components - this is for those who are not satisfied with the ‚Äúdefault‚Äù icon. </div></div><br>  Having filled in all the fields, we press the button ‚ÄúCreate New Component‚Äù (in the Russian version - ‚ÄúCreate a new component‚Äù). <br><br><h6>  Add code to new component </h6><br>  Immediately after creating a new component, its source code is approximately as follows: <br><br><pre><code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">unit</span></span> ImageFragment; <span class="hljs-meta"><span class="hljs-meta">{$mode objfpc}</span></span><span class="hljs-meta"><span class="hljs-meta">{$H+}</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uses</span></span> Classes, SysUtils, LResources, Forms, Controls, Graphics, Dialogs; <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-title"><span class="hljs-title">TImageFragment</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TCustomImage) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">published</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Register</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">implementation</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Register</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> RegisterComponents(<span class="hljs-string"><span class="hljs-string">'Game'</span></span>, [TImageFragment]); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>.</code> </pre> <br>  As expected, the class declaration is completely empty, and there is no implementation at all.  All that is - the registration function of the component on the tab "Game". <br><br>  We need to add several inherited published properties, create two of our own and override one virtual function.  Let's get started! <br><br>  0. In the import section, we will need two additional modules: ExtCtrls and LCLProc - we add them to the uses section: <br><br><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">uses</span></span> Classes, SysUtils, LResources, Forms, Controls, Graphics, Dialogs, ExtCtrls, LCLProc;</code> </pre><br>  1. Add the list of published properties, completely similar to the TImage component, with the exception of several properties that allow you to change the scale and position of the image: <br><br><pre> <code class="delphi hljs"> <span class="hljs-keyword"><span class="hljs-keyword">published</span></span> <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> AntialiasingMode; <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> Align; <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> Anchors; <span class="hljs-comment"><span class="hljs-comment">//property AutoSize; property BorderSpacing; //property Center; //property KeepOriginXWhenClipped; //property KeepOriginYWhenClipped; property Constraints; property DragCursor; property DragMode; property Enabled; property OnChangeBounds; property OnClick; property OnDblClick; property OnDragDrop; property OnDragOver; property OnEndDrag; property OnMouseDown; property OnMouseEnter; property OnMouseLeave; property OnMouseMove; property OnMouseUp; property OnMouseWheel; property OnMouseWheelDown; property OnMouseWheelUp; property OnPaint; property OnPictureChanged; property OnPaintBackground; property OnResize; property OnStartDrag; property ParentShowHint; property Picture; property PopupMenu; //property Proportional; property ShowHint; //property Stretch; //property StretchOutEnabled; //property StretchInEnabled; property Transparent; property Visible; end;</span></span></code> </pre><br>  For greater certainty, I did not delete, but commented out the properties that are in the TImage component, but will interfere in our new TImageFragment component. <br><br>  2. Add two new properties to the class declaration to set the image displacement horizontally and vertically: <br><br><pre> <code class="delphi hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> FOffsetX: Integer; FOffsetY: Integer; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetOffsetX</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AValue: Integer)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetOffsetY</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AValue: Integer)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">published</span></span> <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> OffsetX: Integer <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> FOffsetX <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> SetOffsetX <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> OffsetY: Integer <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> FOffsetY <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> SetOffsetY <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>;</code> </pre><br>  and do not forget to add two declared procedures to the implementation of the class: <br><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">implementation</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TImageFragment</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetOffsetX</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AValue: Integer)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> FOffsetX = AValue <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>; FOffsetX := AValue; PictureChanged(Self); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TImageFragment</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetOffsetY</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AValue: Integer)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> FOffsetY = AValue <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>; FOffsetY := AValue; PictureChanged(Self); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br>  3. Override the DestRect virtual function: <br><br><pre> <code class="delphi hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DestRect</span></span></span><span class="hljs-function">:</span></span> TRect; <span class="hljs-keyword"><span class="hljs-keyword">override</span></span>;</code> </pre><br>  and add its implementation to the class implementation: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TImageFragment</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DestRect</span></span></span><span class="hljs-function">:</span></span> TRect; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Result := <span class="hljs-keyword"><span class="hljs-keyword">inherited</span></span> DestRect(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (FOffsetX &lt;&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> (FOffsetY &lt;&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> LCLProc.OffsetRect(Result, -FOffsetX, -FOffsetY); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br><h6>  Compile the package and reassemble Lazarus </h6><br>  1. In the package window, click the ‚ÄúCompile‚Äù button (in the Russian version - ‚ÄúCompile‚Äù).  If everything is done correctly, a green inscription on successful compilation will appear in the message window; if not, the inscription will be yellow or red. <br><br>  2. In the same window, click on the ‚ÄúUse‚Äù button (in the Russian version - ‚ÄúUse‚Äù) and select the second ‚ÄúInstall‚Äù item in the drop-down menu (in the Russian version - ‚ÄúInstall‚Äù).  The program will offer to rebuild and restart IDE - we agree: <br><br><img src="https://habrastorage.org/webt/7b/xo/vp/7bxovpy3xzjrri9jkwyrvoeqwkm.png"><br><br>  3. After restarting, a new ‚ÄúGame‚Äù tab will appear on the toolbar, and an icon for our new component will appear on it. <br><br><h6>  Instead of an afterword </h6><br>  In the following <a href="https://habr.com/ru/post/439732/">Lazarus</a> article <a href="https://habr.com/ru/post/439732/">- simple animation using the TImageFragment component,</a> I described how such a component can be used - in 5 minutes to create a window in which the animated character moves in different directions and turns in the direction of the movement. <br><br>  If the topic turns out to be interesting to readers, I can supplement this cycle with an article about how, having spent a little more time, you can do, for example, a football field with a pair of players, controlled from the keyboard. <br><br>  And if there is enough time and desire - I will try to write different algorithms for controlling characters (for example, football players) and arrange competitions between them! </div><p>Source: <a href="https://habr.com/ru/post/438828/">https://habr.com/ru/post/438828/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>