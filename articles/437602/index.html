<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We profile Unity project with Android Studio</title>
  <meta name="description" content="Good day to all! This article is about how to profile Unity games on Android with Android Studio. I will talk about how to set up Android Studio and g...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-6974184241884155",
      enable_page_level_ads: true
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>We profile Unity project with Android Studio</h1><div class="post__text post__text-html js-mediator-article">  Good day to all!  This article is about how to profile Unity games on Android with Android Studio.  I will talk about how to set up Android Studio and get the maximum amount of data.  The questions of analysis and conclusions based on the result obtained are beyond the scope of this article. <br><a name="habracut"></a><br><h2>  Requirements </h2><br>  For full profiling of the application, you need a phone with Android 8 or newer (API 27).  By experience, profiling with Android of older versions carries more adventures than benefits.  For this reason, I recommend to get a full line of Nexus devices, as they have old hardware and the latest Android updates. <br><br><h2>  Setting up the Unity project </h2><br>  To get the result, you have to set up a Unity project in a certain way. <br><br><h3>  Settings in Build Settings </h3><br><img src="https://habrastorage.org/webt/av/tr/ju/avtrjuzmsq9xk8egl88e_osxbz4.jpeg" alt="image"><br><br><ul><li>  First of all, you should switch the <b>Build System</b> to <b>‚ÄúGradle‚Äù</b> and tick the <b>‚ÄúExport Project‚Äù</b> .  In this way we will get a ready-made Android Studio project, which we will further profile.  Profiling a finished APK is also possible, but more limited and requires more preparation. </li><li>  It is advisable to turn off the <b>Development Build</b> mode, since the resulting timings in the profiler will be as close to real as possible. </li></ul><br><h3>  Settings in Player Settings </h3><br><img src="https://habrastorage.org/webt/-7/hz/ho/-7hzhozfm55alhksgs0jozpm488.jpeg" alt="image"><br><br><ul><li>  Install <b>Scripting Backend</b> in <b>IL2CPP</b> .  If we leave Mono, then with native profiling we will see many Mono functions, without information on how they relate to C # code. <br></li><li>  The option <b>'C ++ Compiler Configuration'</b> for Android does not affect anything (in Unity 2018.3).  You can put it in 'Release', perhaps in future versions of the Unity Android toolchain this setting will affect the compiler settings. <br></li><li>  It is advisable to limit the <b>'Target Architecture'</b> to <b>ARMv7</b> .  So you save on compile time and from experience a lot of architectures sometimes introduces Android Studio into a stupor. <br></li><li>  It is also worth setting a number of additional settings: <ul><li>  Install Location - 'Prefer external' </li><li>  Internet Access - 'Require' </li><li>  Write Permission - 'External (SDCard)' </li></ul><br>  Android Studio and other profilers use simpleperf to collect statistics, and it will need access to a memory card to write temporary files. <br></li></ul><br><h2>  Gradle project preparation </h2><br>  After you have installed all the settings, build the Unity project.  You should get a folder with the Gradle project. <br><img src="https://habrastorage.org/webt/vt/qq/fi/vtqqfixujd8ntg_ipoycbp9exwc.jpeg" alt="image"><br><br>  Unity by default collects the project at the rate that you plan to build the final APK from it.  Therefore, all debug information has been removed from it, but fortunately it can be returned.  To do this, you need to replace libil2cpp.so and libunity.so with debug information. <br><br><h3>  libil2cpp.so </h3><br>  This is the file that contains all the C ++ code that IL2CPP generated from your C # code.  Unity generates all the necessary information for profiling, but cuts it out for the optimization of the APK size.  To return it: <br><ul><li>  Go to your project folder </li><li>  Find in it the <b>Temp</b> subfolder and go to the <b>Temp / StagingArea / symbols / armeabi-v7a subfolder.</b> </li><li>  Find in it <b>'libil2cpp.so.debug'</b> .  This is the debug version of 'libil2cpp.so'. </li><li>  Now go to the Gradle project and find the folder <b>'\ src \ main \ jniLibs \ armeabi-v7a' in it</b> </li><li>  Replace <b>'libil2cpp.so' with the</b> file <b>'libil2cpp.so.debug'</b> </li></ul><br><h3>  libunity.so </h3><br>  This is the file that contains the low-level part of the Unity Player.  Since we are doing a release build, Unity has put a file without debugging information into your project.  You need to replace libunity.so with a file with symbols. <br><br><ul><li>  Go to the folder where you have Unity installed </li><li>  Navigate to the <b>"\ Data \ PlaybackEngines \ AndroidPlayer \ Variations \ il2cpp \ Development \ Libs \ armeabi-v7a \" folder</b> </li><li>  Take from there the file <b>libunity.so</b> , and replace the file in your project, which lies in the folder <b>'\ src \ main \ jniLibs \ armeabi-v7a'</b> </li></ul><br><h2>  Profiling </h2><br>  Now you can start profiling in Android Studio, just press the profiler launch button. <br><br><img src="https://habrastorage.org/webt/le/b3/yi/leb3yimardolvn0inirdf0hh-ak.jpeg" alt="image"><br><br>  Android Studio launches the application and starts the profiling session. <br><br><img src="https://habrastorage.org/webt/q7/jv/na/q7jvnadenwr-9ixtxu-ac7l0exe.jpeg" alt="image"><br><br>  By default, Android Studio displays graphics, but does not sample data.  To start the process, you need to click on the CPU track so that the profiler switches to the CPU view.  At the same time, a dropdown and a 'Record' button will appear on top of the window. <br><br><img src="https://habrastorage.org/webt/_q/1t/qi/_q1tqikjnm-9vqltl3zvwh8t1am.jpeg" alt="image"><br><br>  Select Sampled 'Native' (In Android Studio 3.3 - C / C ++ Native), and tap the 'Record' button. <br>  Since the recording is made on the device's disk, it is better not to record more than 5-8 seconds from experience, many devices will fade on a smaller amount of data (see the list of tested devices at the end of the article). <br><br>  To get the result, click 'Stop' and then a red square to interrupt the session.  It is difficult to understand the idea of ‚Äã‚Äãthe authors, but if you do not stop the recording completely, then the profiler does not always start analyzing the obtained data and your segment with this data will go far away. <br><br><img src="https://habrastorage.org/webt/nc/s6/wb/ncs6wbzxzmnl2ekezsbeikdalto.jpeg" alt="image"><br><br>  After that, it remains only to wait a bit, in 30-50 seconds the profiler will give you the result.  If everything is set up correctly, you will get capture with all the function names. <br><br><img src="https://habrastorage.org/webt/ft/ws/9a/ftws9av2ird_wbbvppc3af9smey.jpeg" alt="image"><br><br><h2>  Known features </h2><br><ul><li>  The most stable results can be obtained on root devices. </li><li>  Do not use Samsung, and they have a lot of security features that interfere with debugging </li><li>  In many places, your kolstek will go into functions of the form 'kernel.kptr + address'.  These are calls inside the Android Kernel that are protected due to security policy.  You can disable protection on a rooted device: <br><ul><li>  Run `adb shell` </li><li>  Run `su` to get root user rights </li><li>  Run 'sysctl -w kernel.kptr_restrict = 0' - this will remove the protection from the kernel </li><li>  <b>[!]</b> After debugging is finished, execute 'sysctl -w kernel.kptr_restrict = 1'.  Some devices will not be able to boot the OS otherwise.  In many cases, it is treated only by flashing the clean core. </li></ul></li><li>  If Android Studio crashes often, you can try to increase the heap Java VM: <ul><li>  2Gb - for medium-sized projects ('-Xmx2g') </li><li>  4Gb - for large projects ('-Xmx4g') </li></ul></li><li>  On non-rooted devices, the situation sometimes improves by switching the kernel in 'permissive mode' <br><ul><li>  Run the command 'adb shell setenforce 0' </li></ul></li></ul><br><h2>  Unity specifics </h2><br><ul><li>  The main Unity thread is called UnityMain, but you can see a lot of UnityMain when profiling.  These are custom threads that you create inside C # code.  By default, they get the same name.  The main stream of Unity is usually easy to distinguish, since it will be the most loaded. </li><li>  The graphics stream is called UnityGfxWorkerW </li><li>  Unity Job System Threads are called Worker Thread </li><li>  Unfortunately, some of the wait-functions that Unity uses (futex-s), Android Studio shows and considers not as a wait-time, but as an activity. </li><li>  When you watch the call graph in the Top Down view, you have to go through a lot of levels with a Java call, unfortunately you can‚Äôt filter it in Android Studio. </li></ul><br><img src="https://habrastorage.org/webt/f_/it/lp/f_itlpp-dlvolgu5pb-ze7rz4oe.jpeg" alt="image"><br><br><h2>  Recommended devices </h2><br>  We used the following devices for experiments: <br><ul><li>  Samsung Galaxy S8 </li><li>  Google Pixel 2XL </li><li>  Google pixel </li><li>  Sony Xperia XA1 </li><li>  Huawei Honor 7 </li><li>  Huawei Nexus 6P </li><li>  Moto G5P </li><li>  Asus Nexus 7 (2013) </li></ul><br>  All devices have been installed, for Huawei Nexus 6P, we have assembled the core and <a href="https://source.android.com/">AOSP</a> .  As a result, Google and Sony turned out to be the most hassle-free and easy-to-work.  Sony has an excellent site for developers - <a href="https://developer.sony.com/develop/open-devices/">Open Devices</a> .  Huawei no longer allows you to unlock devices in an easy way, Samsung causes constant difficulties with additional levels of protection.  Moto G5P often led to a drop in the profiler data collection process (simpleperf). </div><p>Source: <a href="https://habr.com/ru/post/437602/">https://habr.com/ru/post/437602/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>