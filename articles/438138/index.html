<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Falcon anatomy</title>
  <meta name="description" content="We recently announced the development of the Falcon Age game about growing an adult bird from a falcon chick and jointly opposing forces seeking to co...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>Falcon anatomy</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/webt/xv/l_/tk/xvl_tkbo3ywcawf0llwbblpruls.gif"></div><br>  We recently announced the development of the <b><i>Falcon Age</i></b> game about growing an adult bird from a falcon chick and jointly opposing forces seeking to colonize the planet.  Falcon Age will be released in 2019 on PS4 and PS VR. <br><br>  Last week we showed the game on <b><i>PAX</i></b> and got great reviews, especially about the falcon itself.  Let's take a closer look at its design, animation settings and rig, AI and navigation, technology for creating feathers and sounds of a predator. <br><br><h2>  Falcon design </h2><br>  Chandana Ekanayake and Derran Coldbath are told. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4b9/d67/5c8/4b9d675c8a94b8c699fe14e534dd08cd.png"></div><br>  The design of the falcon combines different types of birds of prey.  Our falcon is the size of a golden eagle, it fights like a hawk, resembles both an eagle and a hawk, has a topknot like an owl, and care of it is carried out like a falcon.  She is one of the last representatives of her kind in our world, and we wanted to make her appearance unique and suitable for the plot.  At the same time during the game process it should stand out against the sky and deserts. <br><a name="habracut"></a><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ad0/b07/70a/ad0b0770aa0ab7ff8dfc0780a2aee0fa.jpg"></div><br>  One of the first sources of inspiration for creating the Falcon Age was video of golden eagles hunting large mountain goats.  We began to conduct research on falconry, and we had the idea of ‚Äã‚Äãtaming a falcon and creating a mechanic and gameplay based on this.  In the early stages of development, we created a rough prototype to test our concepts.  As soon as we whistled the bird for the first time in VR, and saw how its scale was changing, it approached us and sat on our hands, it became clear to us that this could become the basis of a unique game. <br><br><h2>  Animations and rig </h2><br>  Says Aung Zaw Oo. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b5e/988/ce1/b5e988ce11221d248517aea8efb51a5c.png"></div><br>  <b>Falcon paw tracking</b> <br><br>  There are a lot of animation options, but none of them could solve our falcon paw tracking problem in a simple way.  Systems with inverse kinematics, root motion and other complex plugins would allow us to cope with the work, if we had a bigger team and enough time.  We wanted to achieve a more predictable result, so we chose a solution based on the set of poses created in 3dsmax. <br><br>  However, the most important reason for rejecting IK was that it was the best solution that I found in a couple of days.  At the beginning of the project, we assembled a prototype so quickly that we did not have time to consider other available solutions.  It was the most reliable and least awkward way I‚Äôve found, so since then we have been sticking to it.  No need to repair something that is not broken. <br><br>  This is how I imagined mixing the movement of bird claws in real life.  A ball is a fist attached to a VR motion control device.  This method has limitations.  The claws should be able to bend around most of the fist, and the fist posture should be as spherical as possible. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/65a/35e/8ac/65a35e8ac0893a72d88d7be62b10526a.gif"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3bb/5de/244/3bb5de244cd1b3732e2aba4049a85209.jpg"></div><br>  Note that the head and legs are at the same level of hierarchy in the pelvis.  This simplifies masking bones and creating separate blend trees.  Do not pay attention to the word "eagle" ("eagle") in the title.  It was just the name of the temporary asset before we decided on the design of the bird. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b08/d9e/5dd/b08d9e5dd58d5cd23bf9202789c7c8fd.gif"></div><br>  A short version of how this was done: the fist is a ball, and the paws rotate around the ball with 30 poses of mixing and prancing through the paws to bring them back to the center when the ball (moving hand) turns too far. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7ef/ac7/cee/7efac7ceed88f84eb6c3c1ff94c825ac.gif"></div><br>  <i>30 Blending Poses on a ball</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9dd/4dd/220/9dd4dd2207ca00aed668e0039593c531.gif"></div><br>  <i>Animation of stepping allows you to return the paws to the center.</i> <br><br>  Mixing begins again after a short animation of stepping out of a new turn of the hand.  According to our programmer Justin, he implemented it with the usual quaternion formulas and linear algebra.  And I use the three float values ‚Äã‚Äãthat it gives me, and pass them to these animation blending states. <br><br>  In the chick, the second joint of the index finger is treated as a ball. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/210/351/c4e/210351c4eb189d37b335c6ba34e79b76.gif"></div><br>  The only borderline case in which the ball idea does not work is when the glove is pointing straight down, as shown in the figure below. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/757/d16/89b/757d1689b942c585db79165c16c65231.jpg"></div><br>  We could cope with this case in various ways.  One solution is to add a collider to the part of the glove on the forearm collider so that the bird takes off when a collision with it occurs.  But in the end they decided to leave everything as is.  This is more player-friendly: you can scratch your left thigh, and the bird will not fly away in VR.  In addition, most people never tilt their hands while playing. <br><br>  Only if they for some reason do not play, standing on his head. <br><br>  In the headstand, all animations will look incorrect or broken. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/881/71c/2c7/88171c2c7316df2c8810f5a8b21a60fb.png"></div><br><br><h2>  Falcon Head Tracking </h2><br>  Briefly tell how we have achieved this;  The head (bone_Head) is the first child of the topmost object in the bird's skeletal hierarchy (bone_Root). <br><br>  The position (not the rotation) of the Bone_Root follows the position of the motion controller and the bone_Head counteracts this movement.  In essence, this is a two-object hierarchy in which position mixing is used to counteract the movement of the parent object in order to preserve the global position of the child object.  The rest of the bird's body uses a mix of 27 poses for the most natural position of the bird. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5b3/29d/9be/5b329d9be39fbc7bbfc8d4d5e45c5091.gif"></div><br>  Taking into account the size of the adult bird, moving 12 cm across all axes (cube size 24x24x24) turned out to be ideal for obtaining a stabilizer effect without pulling the neck out too much.  The head will move on the border of this range, and when the hand with movement tracking stops moving, the new position will be considered a new center around which another cube with a side of 24 cm is created. From a mathematical point of view, head stabilization is just a vector transformation with many different appendages to limit the speed, start and end of the transition, move the stabilization point when it is too far from the body, and the bird is still in the area. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/31d/270/a03/31d270a03141c96d281fe943a442a387.gif"></div><br><h2>  Navigation and AI birds </h2><br>  Justin Lovely narrates. <br><br>  <b>When the bird is bored</b> <br><br>  Most often the falcon obeys the orders of Ary (the main character of the game) and follows her.  If it is too long to stand in one area, while the bird just flies in circles, or if you let it go without giving orders, then it will start to look for work in the area itself - usually to hunt or land on various important points of relief.  She also takes the initiative when she sits on the Are and someone tries to grab her, and likes to show Aare the next hole while playing lightning golf. <br><br>  <b>The sun blinding the victim</b> <br><br>  Some prey species, such as rabbits, are very shy, and when they see a falcon diving in the air, trying to grab them, they run to the nearest hole.  It is much more difficult for them to notice the Ary bird when it approaches from the sunny side, so you can simplify the capture of prey if you pay attention to where the light falls from and send the bird from this direction.  On the other hand, it may be quite enough to just dive down from a height, because the bird will be able to gain more speed before it is noticed, giving the victim less time to escape. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/00f/1bc/4e6/00f1bc4e6ccb7d120ac7607eb2fa8bd7.png"></div><br>  <i>We go quickly and from the sun to accurately grab the prey.</i> <br><br><hr><br>  <b>Falcon 3D navigation</b> <br><br>  Usually, in the standard set of the game engine there are no mechanisms for reliable movement of a flying animal in 3D space, which in this case would look natural.  We have about three levels of bird navigation logic, performed to move the bird from point A to point B, so as not to complicate the system too much and not get stuck in the corners. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0b8/846/f9a/0b8846f9a5b93872926eb33a14d5f7e8.jpg"></div><br>  For high-level navigation, which allows you to find a route around the world, we build a 3D navigation graph and use the A * algorithm to find the path.  In this implementation, it is rather unique that to perform all operations on finding a path using the A * algorithm, we use a fairly new Unity task system.  It provides a fast search, not loading the main thread, which leaves more time for AI, physics and other aspects.  Most of the graph is generated automatically, and for passage through narrow openings, for example through windows, the connections are placed manually, because they are small or require landing at a right angle. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/56f/eb0/c86/56feb0c86f2c68e4c857e882b3dbab2e.png"></div><br>  The purple line is an approximate way to fly around large rocks in the middle, where the falcon begins to fly and Macaw stands.  The bird does not seek to follow this line especially closely;  if that were the case, she would have made very strange and abrupt turns, so if you can get to the next part of the journey without hindrance, then she will go there. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f4d/ad4/fba/f4dad4fba2b6bbb31a7bd8ed65f33fd7.jpg"></div><br>  Sometimes on the way she may come across small or moving objects.  A falcon looks forward and flies over or near these objects.  The rock is big enough to navigate around with the usual A * algorithm, but I made it ‚Äúforget‚Äù about it for now.  Here, in order to go around the rock, the bird turns left - the red lines show where it looked in the last few frames.  I usually try not to do that, but A * navigation can make a bird fly under arches or bridges. <br><br>  The last level of bird flight logic is the logic of maneuvering itself, the choice of how quickly a bird decides to fly, how much it needs to climb or descend, how to turn quickly, how it applies physical acceleration, what restrictions are placed on its actions to get to the end point.  This data is transmitted to the system of animations, informing how actively the bird works, what type of pose it should be in, whether it should turn, etc.  This system is quite closely related to avoiding objects, but all navigation A * is completely separate.  It uses a large amount of mathematics and logic. <br><br><h2>  Feathers and Rendering </h2><br>  Says Ben Golus. <br><br>  The small feathers on the body, or the contour feathers of our bird, sway in the wind and react to the player's smoothing hands to add a deeper sense of tactile interactivity.  The way PAX was implemented in the demo was a hack, so I hope to replace it before the game is released.  (Of course, this means that exactly this solution will be implemented in the finished game.) In short, each small bird feather is considered to be several shaders of grass or vegetation.  To calculate the simple noise of vibrations of feathers, several superimposed sinusoids are calculated, which gives the feathers a natural look.  Their temporal changes are offset by a random value for each pen, stored in the vertex color, and the swaying motion is also scaled according to the vertex color.  This means that the base of the feathers, unlike the ends, does not move.  It also means that long feathers move more than short ones. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/680/c68/cb2/680c68cb21999cb7d473f9ac05232405.png"></div><br>  We want the feathers not to move in random directions, as in most grass shaders, so you cannot use the directions of the world or local space.  Plus, they are on the skinning mesh, which makes the direction even more dynamic.  Therefore, I used a combination of normals and tangential vertices of feathers so that the feathers sway in and out, as well as in different directions relative to their orientation.  The system is not very accurate, but with such small movements the errors will almost not be noticeable. <br><br>  For processing interactions with the hand in the player's hand, there is a script that tracks the bones and creates a list of capsules that follow the shape of each finger, and a sphere is used as a palm.  If the hand is in the area of ‚Äã‚Äãaction, then the vertex shader bypasses the list of capsules and finds the shortest distance to one of them, and then smoothly scales the fluttering if the capsule crosses it.  In addition, feathers pressed to the body.  The capsules have an increased size, because the overlay checks are soft, that is, they switch not abruptly, but with a smooth transition.  All this is set up approximately so that when the visible finger touches the pen, it would completely stop and hang down. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/63a/694/5b0/63a6945b04202badc82443c3fdffd5c7.png"></div><br>  Here is a test of the earlier version of this system.  You can see how the feathers react to the sphere even before they touch it, but the interactions still look convincing. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2e6/7ef/d53/2e67efd533b217f0432a988906bbbaca.gif"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/be0/a22/c2e/be0a22c2ea62c3ed5266359f0f6abdc5.gif"></div><br>  For the final release of the game, I want to create a system with a geometric or computational shader that would solve some of the problems arising from touching only one of the feather tips and eliminate the fact that the illumination normals of the feathers do not change when they are touched. <br><br>  <b>Falcon Wound Information</b> <br><br>  We wanted to somehow show when the bird was injured, and not to use health bands or similar mechanics.  To show that the bird is tired or hurting it, animations are used, but we still could not quite clearly convey to the users that it had taken damage.  In order to clearly convey her condition, we decided to show her physical injuries with blood and disheveled feathers.  The obvious solution would be to replace the materials.  However, we wanted to show a gradual increase in damage, not just a hard ‚Äúeat / no‚Äù, and did not want to create many different cards.  We also had a problem with the fact that most of the feathers use the same UV coordinates, that is, the whole bird will be covered with bloody stains. <br><br>  As a result, we came to a two-part solution.  The first was feather damage and shabby.  The alpha channel of each pen is configured in a special way so that the damaged and intact versions are in alpha with different opacities.  To switch between two states of pens, alpha values ‚Äã‚Äãare used (in fact, this is alpha to coverage).  50% of opacity means normal health, and 25% of opacity means wounds. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/724/905/a72/724905a726b54a119253d8e93bc15d42.png"></div><br>  For blood stains, the bird has the second UV coordinates of the blood texture, so we do not need to reuse the UV coordinates of the texture of the pen itself.  The blood is mixed on top of the base texture.  As a result, we need only one set of basic textures, one set of blood textures, and this is enough for obtaining different effects of wounds on the bird. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f21/995/7cc/f219957cc5812b7182685071a6a4a3b9.jpg"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/771/faf/dce/771fafdce0e603d446291c180625155f.jpg"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bdc/11a/3d6/bdc11a3d694ff2f0d0d68eb2e600139d.jpg"></div><br><h2>  Sounds of a predator </h2><br>  Says Rob Pearsall. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9b4/2ad/21c/9b42ad21c1e55b7bf28984be1d885718.gif"></div><br>  We did not want the bird to be different (for example, to be futuristic or magical) from any other bird in the world, but simply combined in it the different features of several flying predators (they only added a hat to it).  Therefore, there was no point in creating for her a voice that sounded "with cinematic quality" - it is enough that he worked and was believable. <br><br>  In other words, I could ‚Äúborrow‚Äù the cries of any predator that would convey to the player information about different moods, feelings and responses of the bird.  I listened to sounds made by predators.  To my surprise, the largest and most impressive predator, the eagle, was the worst sound of them all.  He was the first in the list of "better not to use." <br><br>  Hawk is always a great choice.  Everybody loves the hawk to scream.  I used to think that all sound producers have one record of hawkish gibberish, and that all hawks have the same sound in all films.  But it is not.  As it turned out, these hawks all sound the same.  Almost no difference.  Don't get me wrong, the sound is excellent, so ... yes, for our bird, we also used it.  But that is not all. <br><br>  Best of all, I was not obliged to confine myself to one particular species of falcon;  And there are a lot of these kinds.  Therefore, I could choose for my taste any suitable sounds emitted by any falcon, which would resemble a kind of emotional statement of a bird. <br><br>  It is very convenient that the range of emotions was limited.  I will call them bird messages: <br><br><ul><li>  Everything is quiet, everything is good </li><li>  I heard you calling me </li><li>  Attacking </li><li>  I'm injured, but still flying </li><li>  Painfully </li></ul><br>  It is very easy to record the sound of an annoyed predator;  it is enough to appear on its territory with recording equipment, and it will already be annoyed.  Therefore, there are many materials where predators sound angry and angry.  They are suitable for the sounds of "pain."  The sounds of the hawk came up for responses in flight and reports of an attack.  With the sounds "all is quiet", there are difficulties.  I had several types of twitter, but then I had to edit many different types of messages in order to get partial, short, shrill cries corresponding to twitter, and they were suitable for playing. <br><br>  Tracking the bird in a game of sound is a completely different story for another article. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c8e/27b/c03/c8e27bc03face36cf44ba1317d3138dc.gif"></div></div><p>Source: <a href="https://habr.com/ru/post/438138/">https://habr.com/ru/post/438138/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>