<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>New Year's dances around the FC-adapter or a tale about how far the causes of the problem are far from the symptoms</title>
  <meta name="description" content="So, on January 4 at 7:15, wiping my eyes from sleep, I discover a packet in the Telegram group from the Zabbix server that the load on the CPU has inc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-6974184241884155",
      enable_page_level_ads: true
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>New Year's dances around the FC-adapter or a tale about how far the causes of the problem are far from the symptoms</h1><div class="post__text post__text-html js-mediator-article"><p>  So, on January 4 at 7:15, wiping my eyes from sleep, I discover a packet in the Telegram group from the Zabbix server that the load on the CPU has increased on one of the virtualization servers: </p><br><p><img src="https://habrastorage.org/webt/mb/6o/wz/mb6owzivk1hb0e_mfwe5_ycsobk.png"><a name="habracut"></a><cut></cut><br>  Having looked at the story in Zabbix, I climb to the server and look in the dmesg, where I find the following: </p><br><pre><code class="plaintext hljs">[–ß—Ç —è–Ω–≤ 3 20:05:18 2019] qla2xxx [0000:21:00.1]-015b:10: Disabling adapter. [–ß—Ç —è–Ω–≤ 3 20:05:28 2019] sd 10:0:0:1: rejecting I/O to offline device [–ß—Ç —è–Ω–≤ 3 20:05:28 2019] sd 10:0:0:1: rejecting I/O to offline device [–ß—Ç —è–Ω–≤ 3 20:05:28 2019] sd 10:0:0:1: rejecting I/O to offline device [–ß—Ç —è–Ω–≤ 3 20:05:28 2019] sd 10:0:0:1: rejecting I/O to offline device [–ß—Ç —è–Ω–≤ 3 20:05:28 2019] sd 10:0:0:1: rejecting I/O to offline device</code> </pre> <br><p>  I climbed to the storage at which the QLogic FC adapter is looking, I see that on January 1 at 19:54 one of the drives in the storage was taken out of work, the Spare drive was picked up and on January 2 at 9:11 am the resilvering ended: </p><br><p><img src="https://habrastorage.org/webt/ub/9-/jg/ub9-jgtho_qzgy6payivxhvmwqs.png"></p><br><p>  I thought: maybe something came from the storage or the FC switch, from which the driver got tangled up in the QLogic adapter. </p><br><p>  Created a task in the tracker, restarted the server, everything worked again as it should, at first glance. </p><br><p>  On this postponed further action until the end of the New Year holidays. </p><br><p>  With the beginning of the working week on January 9, I began to investigate the cause of the failure. </p><br><p>  Since the message: </p><br><pre> <code class="plaintext hljs">[–ß—Ç —è–Ω–≤ 3 20:05:18 2019] qla2xxx [0000:21:00.1]-015b:10: Disabling adapter.</code> </pre> <br><p>  not too informative, got into the source of the driver. </p><br><p>  Judging by the driver code, the message is issued when the driver is unloaded due to a PCI error (linux / drivers / scsi / qla2xxx / qla_os.c (v4.15 kernel)): </p><br><pre> <code class="plaintext hljs">qla2x00_disable_board_on_pci_error(struct work_struct *work) { struct qla_hw_data *ha = container_of(work, struct qla_hw_data, board_disable); struct pci_dev *pdev = ha-&gt;pdev; scsi_qla_host_t *base_vha = pci_get_drvdata(ha-&gt;pdev); /* * if UNLOAD flag is already set, then continue unload, * where it was set first. */ if (test_bit(UNLOADING, &amp;base_vha-&gt;dpc_flags)) return; ql_log(ql_log_warn, base_vha, 0x015b, "Disabling adapter.\n");</code> </pre> <br><p>  Began to dig further, got into the BMC, I look in the Event Log: </p><br><p><img src="https://habrastorage.org/webt/kd/w_/rm/kdw_rm1wokwi6sblbx-jdvfxj9u.png"></p><br><p>  It turns out that one of the two CPU nodes in the platform is heated and throttly, and the time of the message about the unloading of the FC-adapter driver correlates with the start time of the throttling. </p><br><p>  Here it is worth making a remark that the server platform here is <a href="https://www.supermicro.com/Aplus/system/2U/2123/AS-2123BT-HNC0R.cfm">https://www.supermicro.com/Aplus/system/2U/2123/AS-2123BT-HNC0R.cfm</a> with two EPYC 7601 for each node: </p><br><p><img src="https://habrastorage.org/webt/4g/qj/_m/4gqj_mauh8b6ogspym5sau493oi.jpeg"></p><br><p>  I moved it to the data center, took the node out of the server, changed the thermal paste, stuck it back, but it still heats up. </p><br><p>  We noticed that the air flow in one part of the server is not as strong as in the other.  Having a little loaded all the nodes with the help of stress-ng, it became clear that the processors of the nodes in the right side of the platform are not blown properly and the temperature of the second CPU in two nodes very quickly reaches the critical one. </p><br><p>  After trying to change the parameters of the blower in the BMC, it turned out that they do not have an action: </p><br><p><img src="https://habrastorage.org/webt/q5/e-/ng/q5e-ngkv2nevpw9bz2aod-rbgum.png"></p><br><p>  Restarting the BMC also had no effect. </p><br><p>  Looking into the Sensor Readings, I saw that on one node of 53 sensors, only 4 are detected, and on the other node only 6: </p><br><p><img src="https://habrastorage.org/webt/dn/47/d3/dn47d3mxpac_i_gktmyjql3rn7u.png"></p><br><p>  And then, I remembered that flashing the new BIOS version and a new BMC into nodes from a month or two ago, on two nodes I did not reset the BMC configuration to the factory settings (to check one special case of settings). </p><br><p>  After resetting the BMC to the factory settings, all 53 sensors again showed up, fan speed control started up again, and the processors stopped warming up. </p><br><p>  The fact that the reason for unloading the QLogic driver is overheating of the processor is not certain, but I did not find any close correlations. </p><br><p>  Findings: </p><br><ol><li>  after the BMC firmware, even if everything works fine at first glance, it is still worth resetting the settings to the factory settings; </li><li>  Of course, the temperature and error messages of the kernel should be put under monitoring, and this is natural in the plans, but not all at once. </li></ol></div><p>Source: <a href="https://habr.com/ru/post/436874/">https://habr.com/ru/post/436874/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>