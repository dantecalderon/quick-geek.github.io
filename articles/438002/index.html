<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Configure reverse proxy for Nextcloud and ONLYOFFICE</title>
  <meta name="description" content="Hi, Habr! 


 I am engaged in testing ONLYOFFICE document editors, as well as testing the integration of editors into third-party services. We are oft...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>Configure reverse proxy for Nextcloud and ONLYOFFICE</h1><div class="post__text post__text-html js-mediator-article"><p>  Hi, Habr! </p><br><p>  I am engaged in testing ONLYOFFICE document editors, as well as testing the integration of editors into third-party services.  We are often approached by users with various configuration problems, solutions of which are simply not found. </p><br><p>  One of the most popular integrations is with the open-source system Nextcloud, which allows you to create your own cloud storage.  For example, you have documents, spreadsheets and presentations that you want to share with other users, and a server (alternatively, a wheelbarrow in DigitalOcean).  You install Nextcloud there (or ownCloud, from which he actually stuck), connect document editors and get the opportunity to work with these documents together. </p><br><p>  Most integration options are described in our documentation.  But sometimes interesting user cases come up.  For example, how to configure a proxy server for Nextcloud and ONLYOFFICE if all three services are installed on different servers (Nextcloud, editors, proxy).  This can happen if there is a complex system where document editors and document management systems are part of a larger system with many services. </p><a name="habracut"></a><br><p>  Note: Nextcloud and editors host either one server or different servers.  And in fact, and in another case, you must have a proxy server for the correct work of editors, which can be raised on one of these servers. </p><br><p>  <strong>Given:</strong> </p><br><p>  Three servers: the first is installed nginx ( <a href="http://nginx/">http: // nginx</a> ), the second is Nextcloud ( <a href="http://nextcloud/">http: // nextcloud</a> ), the third is the document editors ( <a href="http://onlyoffice/">http: // onlyoffice</a> ).  Everything was installed using docker, port 80 was used. </p><br><p>  <strong>Task:</strong> </p><br><p>  Configure nginx so that when prompted for <a href="http://nginx/">http: // nginx</a> opens Nextcloud.  Configure Nextcloud to work with document editors available at <a href="http://nginx/editors">http: // nginx / editors</a> </p><br><p>  We deconstruct the problem and solve it according to the following plan: </p><br><ul><li>  Proxy configuration for Nextcloud </li><li>  Configure proxies for document editors so that they are available at <a href="http://nginx/editors">http: // nginx / editors</a> </li><li>  Installing the connector in Nextcloud and setting it up <br>  (A connector is a small program that allows you to link Nextcloud and editors: adds a new settings menu, buttons for creating documents, spreadsheets and presentations, etc.) </li></ul><br><h1 id="proksi-dlya-nextcloud">  Proxy for Nextcloud </h1><br><p>  To proxy Nextcloud through nginx, you need to change the settings of nginx and add its address to the trusted Nextcloud domains. </p><br><p>  Trusted domains are a white list of domains from which entry can be made.  If you try to open Nextcloud through a proxy without adding its domain to the list, we will see an error. </p><br><p><img src="https://docs.nextcloud.com/server/14/admin_manual/_images/install-wizard-a4.png" alt="image"></p><br><p>  The domain from which the wizard is passed to Nextcloud is added there automatically, and the rest must be registered.  Read more about trusted domains in the <a href="https://docs.nextcloud.com/server/14/admin_manual/installation/installation_wizard.html">documentation</a> . </p><br><p>  The settings we need are in the nginx container on the path /etc/nginx/conf.d/default.conf.  We bring this file to the following form: </p><br><pre><code class="nginx hljs"><span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass_header</span></span> Server; <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://nextcloud/; } }</code> </pre> <br><p>  Note the slash at the end of the proxy_pass path. </p><br><p>  Update nginx settings with the command </p><br><pre> <code class="bash hljs">service nginx reload</code> </pre> <br><p>  Now you need to add the <a href="http://nginx/">http: // nginx</a> domain to the Nextcloud trusted domains.  For this, you need to open the config in the Nextcloud container, which is located here /var/www/html/config/config.php.  In it you need to find (or add) the trusted_domain section, add the nginx address there.  After the changes, this part of the config will look like this: </p><br><pre> <code class="nginx hljs">'trusted_domain' =&gt; (0 =&gt; 'nextcloud', 1 =&gt; 'nginx')</code> </pre> <br><h1 id="proksi-dlya-redaktorov-dokumentov">  Proxy for document editors </h1><br><p>  Open default.conf on the nginx server again and add another location: </p><br><pre> <code class="nginx hljs"> <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /editors/ { <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://onlyoffice/; }</code> </pre><br><p>  But for the work of editors this is not enough.  By default, the document editor generates links to resources using the address that comes in the request.  And since the editor knows nothing about the proxy server, it will generate paths relative to it (for example, <a href="http://nginx/apps/files/">http: // nginx / apps / files /</a> ).  This is incorrect, because the / apps / files / files are located on the <a href="http://onlyoffice/">http: // onlyoffice /</a> server.  To fix this, you need to specify in the request header the path relative to which the links should be generated.  This is done using the ‚ÄúX-Forwarded-Host‚Äù header. </p><br><p>  Add the following code to the beginning of the configuration file: </p><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Forwarded-Host <span class="hljs-variable"><span class="hljs-variable">$http_host</span></span>/editors;</code> </pre> <br><p>  Two other important headers are Upgrade and Connection.  They allow you to use websocket protocol for the work of document editors.  Without them, editors will also work, but not as efficiently, because xhr will be used instead of websocket. </p><br><p>  The resulting default.conf file will look like this: </p><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Upgrade <span class="hljs-variable"><span class="hljs-variable">$http_upgrade</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Connection <span class="hljs-variable"><span class="hljs-variable">$proxy_connection</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Forwarded-Host <span class="hljs-variable"><span class="hljs-variable">$http_host</span></span>/editors; <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass_header</span></span> Server; <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://nextcloud/; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /editors/ { <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://onlyoffice/; } }</code> </pre> <br><h1 id="ustanovka-konnektora-v-nextcloud-i-ego-nastroyka">  Installing the connector in Nextcloud and setting it up </h1><br><p>  The connector is in opensource ( <a href="https://github.com/ONLYOFFICE/onlyoffice-nextcloud">github</a> ), and it can be installed manually, but it is easier to do this through the Nextcloud App Store.  Immediately after installation, a new menu item appears in the settings, which is responsible for the configuration of the connector.  Add the address of the editors of the documents ( <a href="http://nginx/editors/">http: // nginx / editors /</a> ). </p><br><p>  Thus, ONLYOFFICE and Nextcloud can be installed and configured. </p><br><p><img src="https://user-images.githubusercontent.com/6047261/51901002-b4c84a80-23c7-11e9-9175-917e4d29723a.png" alt="image"></p><br><h1 id="v-zaklyuchenie">  Finally </h1><br><p>  It turned out something in between the article and the instruction.  I hope it will be useful. </p><br><p>  I deliberately omitted some of the details when setting up, because I wanted to describe only the necessary things so that it was quite simple and understandable.  But if something seemed confusing - write in the comments, I will try to explain.  Thanks for attention. </p></div><p>Source: <a href="https://habr.com/ru/post/438002/">https://habr.com/ru/post/438002/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>