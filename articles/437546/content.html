<div class="post__text post__text-html js-mediator-article">  There was a need to introduce a Ubuntu machine into the Windows domain.  For these purposes, Samba and Winbind are commonly used.  But an alternative is possible with sssd, a brief guide to it below. <br><br>  For example, we will use: <br><br>  <i>Domain</i> = contoso.com <br>  <i>Domain Controller</i> = dc.contoso.com <br><a name="habracut"></a><br>  Launch Ubuntu terminal: <br><br>  1. Switch to root <br><br><pre><code class="bash hljs">sudo -i</code> </pre> <br>  2. Install the necessary packages <br><br><pre> <code class="bash hljs">apt install sssd heimdal-clients msktutil</code> </pre> <br>  3. Edit /etc/krb5.conf, use tabs as indents. <br><br><pre> <code class="bash hljs">[libdefaults] default_realm = CONTOSO.COM [realms] CONTOSO.COM = { kdc = DC admin_server = dc.contoso.com default_domain = contoso.com } [login] krb4_convert = <span class="hljs-literal"><span class="hljs-literal">true</span></span> krb4_get_tickets = <span class="hljs-literal"><span class="hljs-literal">false</span></span> [domain_realm] .contoso.com = CONTOSO.COM contoso.com = CONTOSO.COM</code> </pre> <br>  4. Edit the / etc / hosts file, specify the FQDN for this host: <br><br><pre> <code class="bash hljs">127.0.0.1 localhost 127.0.1.1 &lt;hostname&gt;.contoso.com &lt;hostname&gt;</code> </pre><br>  5. We try to get the Kerberos ticket on behalf of the domain administrator: <br><br><pre> <code class="bash hljs">root@ubuntu:~<span class="hljs-comment"><span class="hljs-comment"># kinit YourDomainAdmin YourDomainAdmin@CONTOSO.COM's Password:</span></span></code> </pre> <br>  Checking: <br><br><pre> <code class="bash hljs">root@ubuntu:~<span class="hljs-comment"><span class="hljs-comment"># klist Credentials cache: FILE:/tmp/krb5cc_0 Principal: YourDomainAdmin@CONTOSO.COM Issued Expires Principal Dec 1 15:08:27 2018 Dec 2 01:08:22 2018 krbtgt/CONTOSO.COM@CONTOSO.COM</span></span></code> </pre> <br>  If the ticket is received successfully, then now Kerberos principals can be generated for this host, the register is important: <br><br><pre> <code class="bash hljs">msktutil -c -b <span class="hljs-string"><span class="hljs-string">'CN=YourComputersOU'</span></span> -s HOST/HOSTNAME.contoso.com -k /etc/sssd/HOSTNAME.keytab --computer-name HOSTNAME --upn HOSTNAME$ --server dc.contoso.com —user-creds-only msktutil -c -b <span class="hljs-string"><span class="hljs-string">'CN=YourComputersOU'</span></span> -s HOST/HOSTNAME -k /etc/sssd/HOSTNAME.keytab --computer-name HOSTNAME --upn HOSTNAME$ --server dc.contoso.com --user-creds-only</code> </pre><br>  Now our host should appear in the list of computers in the directory.  If everything is so, we delete the received Kerberos ticket: <br><br><pre> <code class="bash hljs">kdestroy</code> </pre><br>  6. Create the file /etc/sssd/sssd.conf with the following contents: <br><br><pre> <code class="bash hljs">[sssd] services = nss, pam config_file_version = 2 domains = contoso.com [nss] entry_negative_timeout = 0 debug_level = 3 [pam] debug_level = 3 [domain/contoso.com] debug_level = 3 ad_domain = contoso.com ad_server = dc.contoso.com enumerate = <span class="hljs-literal"><span class="hljs-literal">false</span></span> id_provider = ad auth_provider = ad chpass_provider = ad access_provider = simple simple_allow_groups = users <span class="hljs-comment"><span class="hljs-comment">#каким группам разрешено логиниться, через запятую. Есть ограничение — названия групп должны быть с маленькой буквы. ldap_schema = ad ldap_id_mapping = true fallback_homedir = /home/%u default_shell = /bin/bash ldap_sasl_mech = gssapi ldap_sasl_authid = &lt;HOSTNAME&gt;$ ldap_krb5_init_creds = true krb5_keytab = /etc/sssd/&lt;HOSTNAME&gt;.keytab</span></span></code> </pre> <br>  Description of sssd config parameters can be found <a href="">here.</a> <br><br>  Set permissions for the sssd.conf file: <br><br><pre> <code class="bash hljs">chmod 600 /etc/sssd/sssd.conf</code> </pre> <br>  Restart the SSSD service <br><br><pre> <code class="bash hljs">service sssd restart</code> </pre> <br>  7. Edit PAM Settings <br><br>  <i>Bad decision:</i> <br><br>  edit the file /etc/pam.d/common-session, after the line <br><br><pre> <code class="bash hljs">session required pam_unix.so</code> </pre> <br>  add row <br><br><pre> <code class="bash hljs">session required pam_mkhomedir.so skel=/etc/skel <span class="hljs-built_in"><span class="hljs-built_in">umask</span></span>=0022</code> </pre> <br>  <i>Good decision:</i> <br><br>  override parameters via PAM system settings, call <br><br><pre> <code class="bash hljs">pam-auth-update</code> </pre> <br>  and mark the points <i>sss auth</i> and <i>makehomdir</i> .  This will automatically add <br>  The line is higher in common-session and it will not be overwritten when the system is updated. <br><br>  Now we can log in to the machine by domain users who are allowed to login. <br><br>  PS: You can give the right to use sudo domain groups.  Using visudo, we edit the file / etc / sudoers, or better, as recommended by <a href="https://habr.com/ru/users/maxzhurkin/" class="user_link">maxzhurkin</a> and <a href="https://habr.com/ru/users/iluvar/" class="user_link">iluvar</a> , create a new file in /etc/sudoers.d/ and edit it <br><br><pre> <code class="bash hljs">visudo -f /etc/sudoers.d/ваш_файл</code> </pre> <br>  Add the required group - for example, Domain Admins (if there are spaces in the group name, they must be escaped): <br><br><pre> <code class="bash hljs">%Domain\ Admins ALL=(ALL) ALL</code> </pre> </div>