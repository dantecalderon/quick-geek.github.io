<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Gomoku's winning strategy - 35 moves</title>
  <meta name="description" content="When playing according to standard Gomoku rules, Black needs no more than 35 moves to win. The article presents to your attention the complete winning...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-6974184241884155",
      enable_page_level_ads: true
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>Gomoku's winning strategy - 35 moves</h1><div class="post__text post__text-html js-mediator-article">  When playing according to standard Gomoku rules, Black needs no more than <b>35</b> moves to win.  The article presents to your attention the complete winning strategy and the corresponding game algorithm. <br> <a href="https://maximrud.github.io/rv2/"><img src="https://habrastorage.org/webt/mq/os/dd/mqosddugiqv8zt2yt2-1nb8kqgk.png"></a> <br>  Demonstration of the complete solution - <a href="https://maximrud.github.io/rv2/">here</a> - you can play and find the longest options.  The program always wins and spends no more than 35 moves on it.  The source code of the application, the decision itself and examples of parties at the end of the article. <br><a name="habracut"></a><br>  I will not dwell on the rules and tactics of the game.  The topic was discussed in detail at habr <a href="https://habr.com/ru/post/383907/">here</a> , as well as decision algorithms <a href="https://habr.com/ru/post/278837/">here</a> and <a href="https://habr.com/ru/post/202264/">here</a> . <br><br><h3>  Small retreat </h3><br>  Before the era of smartphones, tic / tac-toe "five in a row" (Gomoku, Renju) was one of the most popular time killers in school.  It was more interesting to consider combinations of the development of the national economy of North Africa or the classification of clover flowers. <br><br>  In the fall of 1985, the girls from our 10 "b" were taken from a math lesson.  We, the remaining six children, were most likely to have informal communication with a mathematics teacher on abstract topics.  The teacher entered the class in silence, handed out a piece of paper to everyone in the cell and began writing the names of those present on the board.  We depressed, was planned independent work or a quiz.  But the list on the board turned into a standings and the championship rules were announced to us.  Each with each series of five games.  The prize for the winner is the top five in the magazine.  According to the results of the tournament I was lucky to win, but the game did not end there.  The teacher promised to put the five to all the guys if the winner wins him in a row all five games in the series.  The right of the first move is given to the winner.  Contrary to our teacher's statement that, on such a condition, if you play correctly, you can win both 10 and 100, and in general any number of games in a row, victory seemed to me an incredible luck. <br><br>  9 years later, in 1994, Dr. Lewis Victor Allis stated that he had proof of this hypothesis in an article by <a href="https://pdfs.semanticscholar.org/f476/00662cadb0975f9cfd7867389efedda6f873.pdf">Go-Moku and Threat-Space Search</a> .  The author did not publish his winning strategy, which allows him to verify the evidence.  However, in his 1996 book, <a href="http://fragrieu.free.fr/SearchingForSolutions.pdf">Searching for Solutions in Games and Artificial Intelligence</a> , he gave a general description of the algorithms.  In conclusion, the procedure for checking the completeness of a winning strategy is specifically mentioned, which is based on the correctness of the implementation of the ‚Äúsequence of threats‚Äù search algorithm and the analysis of the opponent‚Äôs counterplay options. <br><br>  The examples of solutions given in the article and in the book with the ‚Äúcorrect moves‚Äù of rivals, which are part of a winning strategy, demonstrate the weakness of the algorithm used. <br><img src="https://habrastorage.org/webt/uo/lv/qt/uolvqtblhcjmkkkgd61s5f7u1ei.png"><br>  For example, in the figure, the solution of the program for the standard Gomoku rules.  If White responds to the 10th move with g9, Black responds with j10 and then j8, then the game ends with 29 moves instead of 45. Next, the program ‚Äúdid not notice‚Äù the combination of Black‚Äôs ‚Äúsequence of threats‚Äù twice in 17 moves after the 16th and after 26- White's move.  And in the end, if White makes the 36th move f12 instead of j12, then they will hold on at least until the 49th move.  To be fair, in this example, all Black‚Äôs moves do not leave White a single chance to complete the game in his favor. <br><br>  On the Internet, I found several references to similar work of finding a winning strategy.  Unresolved is the question of the optimality of the solutions found.  What is the minimum number of moves Black needs to win? <br><br>  So, having some free time, modern computing resources and paying tribute to children's hobbies 33 years after the memorable school championship, I set the task of finding the optimal winning strategy for Black in Gomoku. <br><br><h3>  Digitizing position on board </h3><br>  The recording of the game is quite primitive.  On the field only 225 cells.  Accordingly, each cell is encoded by 1 byte.  To record a batch of 35 moves, only 35 bytes are required.  But such a record is poorly suited for evaluating a position due to two reasons: the same position can be obtained in a different sequence of moves and the symmetric positions are not taken into account. <br><br>  Achieving the goal of the game - building five stones in a row - can be done in one of four directions: vertically, horizontally, and in two diagonals.  Thus, we can represent any position as a set of lines.  Horizontal and vertical lines are 15 cells long and diagonal lines are from 1 to 15 cells long.  Each turn changes the value of 4 lines at once in different directions. <br><br>  The task of assessing the position is to determine all significant figures for each line.  For simplicity, each cell line is described by 2 bits.  The first bit is filled when a white stone is set, the second bit is a black stone.  Each line contains no more than 15 cells and is encoded in a 32-bit integer.  Thus, the search for figures on the line is reduced to a comparison of the numerical value of the line through a sliding window with a bit pattern of the figure. <br><br><img src="https://habrastorage.org/webt/vc/ch/8l/vcch8l0smdyw4ay3ugehpszc-ba.png"><br><br>  In the example shown in the figure, the position is described by 26 lines.  Respectively encoded with 104 bytes, while the normal batch entry requires only 17 bytes. <br>  It is not difficult to guess that all symmetries - turns and mirror images - are obtained by simply changing the number (shuffling) and the direction of the lines.  To identify the position and quickly search collections, this principle implements a 32-bit hash function, which gives different values ‚Äã‚Äãonly for asymmetric positions. <br><br>  The use of symmetries significantly reduces the number of considered positions.  For example, the number of options for the second move is reduced from 224 to 35. <br><br>  When searching for solutions and combinations (this will be discussed below), the calculated positions make up the vertices of the multi-layer graph.  Vertices are grouped into layers according to the number of filled cells.  The moves make up the edges of the graph connecting the vertices of the adjacent layers.  When searching for failed moves are discarded, the edges are removed and part of the vertices loses connectivity with the main branch.  Therefore, after the calculation steps, garbage collection is performed (or the graph is rebuilt from the vertex). <br><br>  In the development process, several coding algorithms were considered, but the one described above showed the highest position estimation speed. <br><br><h3>  We evaluate the position </h3><br>  An important factor in assessing the position is how significant figures are built rivals. <br><br>  <b>Five</b> - if such a figure is found on the board, the game is over.  For the standard Gomoku rules, no six, seven, etc. give a win.  Therefore, the five, as, indeed, all other figures, requires the absence of their stones on the adjacent cells in the line. <br><br><img src="https://habrastorage.org/webt/jv/i7/oc/jvi7ochyhbqf2t4uor23yuvvdre.png"><br><br>  <b>The open four</b> is 6 cells long, the middle four are occupied by stones of the same color, the outer ones are necessarily empty.  Well, as for the five, your stones are absent in the neighboring cells.  A very strong figure means winning even on someone else‚Äôs turn. <br><br><img src="https://habrastorage.org/webt/hl/ax/bt/hlaxbtehdktbb-qyxh9a2a_r1fw.png"><br><br>  <b>Four</b> - the length of 5 cells, one (any) of the five cells free.  Gives a win on his turn.  It creates a threat and compels the opponent to make a move in a free cell if he does not have his own four.  Gives 5 points in the position rating under protection. <br><br><img src="https://habrastorage.org/webt/ri/qc/i4/riqci4ib69yx4vfonbygsfnmnbk.png"><br><br><img src="https://habrastorage.org/webt/vo/ji/6c/voji6cdt_-w09yfrav9xlnh4utq.png"><br><br>  <b>An open triple</b> is 6 or 7 cells long, the outermost cells are necessarily free.  For 6 cells, three out of four medium ones are occupied by stones of the same color, one is free.  For 7 cells, three medium ones are occupied by stones of the same color.  The figure in its turn becomes an open four, if the opponent does not have a four or an open three.  On someone else's course, it creates a threat and forces the opponent to close the top three or set up his four in response.  The 6th cell three has 1 upward stroke and 3 closing ones.  The 7th cell three has 2 upward moves and only 2 closing ones.  Gives from 2 to 4 points in the ranking position. <br><br><img src="https://habrastorage.org/webt/nq/p2/uy/nqp2uy_g732dvaw80jne7l2diss.png"><br><br><img src="https://habrastorage.org/webt/cv/x4/sn/cvx4sne2smh9dasu1va_zwn9x_m.png"><br><br><img src="https://habrastorage.org/webt/35/bt/vd/35btvdffg5chcb3x27pc0qwaa1g.png"><br><br>  <b>Three</b> , or three closed - the length of 5 cells, any three of which are occupied by stones of the same color.  A triple on his turn can be turned into a quadruple and is used during attack and defense, creating a threat more than the open three of the opponent.  Gives 1 point in the ranking position. <br><br><img src="https://habrastorage.org/webt/xm/cm/0b/xmcm0burpfuvl61yr4dibp3lyhc.png"><br><br><img src="https://habrastorage.org/webt/2q/ia/jm/2qiajmlw_jdqml6ppuh6btmw94y.png"><br><br><img src="https://habrastorage.org/webt/fv/dx/az/fvdxazstgmbxazow3sr9vszxa6u.png"><br><br>  <b>An open</b> (perspective) <b>two</b> - from 6 to 7 cells long.  When attacking, it is transformed into an open three.  Gives 1 or 2 points in the position rating. <br><br><img src="https://habrastorage.org/webt/wg/pa/pa/wgpapauepfjwkfhomfe7qxrxtge.png"><br><br><img src="https://habrastorage.org/webt/ql/fc/fn/qlfcfn038u9fywlic9_gze90fam.png"><br><br><img src="https://habrastorage.org/webt/dx/bc/up/dxbcupckdzf3grkswynvstgwgb8.png"><br><br>  <b>Fork</b> - at the same time two or more threats that can not be closed in one move.  There are 3x3 forks (two open triples), 3x4 (open three and four) and 4x4 (two open fours. Forks give a win if the opponent has no greater threat - a four or an open three for a 3x3 plug, or the opponent cannot close the fork consistently, creating big threats - a sequence of fours for a 3x3 plug. <br><br><img src="https://habrastorage.org/webt/0_/pv/36/0_pv36msyig6kkitovoqfhqiup0.png"><br><br><img src="https://habrastorage.org/webt/zy/r3/by/zyr3byoch5yqsofw_s_kpot1hpq.png"><br><br><img src="https://habrastorage.org/webt/kk/cj/if/kkcjif1kqjf-yad-ghyjak2syzs.png"><br><br><img src="https://habrastorage.org/webt/yl/m3/iq/ylm3iqinyhrfpd1ruifnap8clqq.png"><br><br>  <b>A combination</b> is a continuous sequence of threats and defenses against more significant threats from an opponent, leading to a positive result for the player.  Combinations are attacking (or winning) and defensive. <br><br>  An attacking or winning combination is successful if any defensive or attacking moves of the opponent have been answered in return moves leading to a win.  The attacking combination ends with the installation of a fork, which the opponent cannot close. <br><br>  The protective combination, on the contrary, is successful when the opponent ceases to create threats, or the limit of moves for calculation is exceeded.  The protective combination consists of moves to protect or create a greater threat to the opponent. <br><br>  When evaluating a position, a winning combination is searched.  If successful, we won.  Otherwise, if there are no threats from the opponent - the state is neutral.  If there are threats from an opponent, we search for a protective combination.  If successful, the state is neutral, in case of failure, we lost. <br><br>  Since the number of options for attacking and forced retaliatory moves is rather limited, it is permissible to search for combinations to a sufficiently large depth.  During the initial construction of the optimal strategy, the allowed depth of the search for combinations was set at more than 25 moves.  When recalculating the solution for the implementation of the javascript position estimation algorithm, the allowable search depth was reduced to 17 moves. <br>  When calculating the optimal strategy, the depth of search for a winning combination from above was additionally limited by the target maximum number of moves. <br><br><h3>  We are looking for a solution </h3><br>  So, we rated the given position as neutral and choose what the next move will be.  Our behavior in this case depends on whether we are attacking or defending.  For the attacking side, the complete solution will be a sequence of moves in which for any opponent‚Äôs return move the position is evaluated as winning (a winning combination is found) or contains the following own move in the solution.  It is worth noting that to calculate the optimal strategy, the attacking side is always black, the defensive side is white. <br><br>  The attacking side needs to find only one move, leading to the fastest victory.  In the conditions of lack of resources, the attacking side artificially limits the number of options for busting, investigating first of all the moves leading to the position with the highest rating score.  After finding any solutions, in the direction of the longest of them, the attacker expands the range of options, exploring less rated positions in order to achieve a reduction in the length of the decision. <br><br>  It is enough for the defending party to find one single move that does not lead to the victory of the opponent within a given limit of moves.  All free cells can be used for enumeration. <br>  To reduce the number of protection moves, we use the ‚Äúskip move‚Äù algorithm.  Skip the defensive move and look for a winning offensive combination.  If successful, possible moves of defense may be limited to moves that affect the success of the combination found.  On average, at each step, this allows you to reduce the search area by 4-6 times.  It is necessary to take into account that among the ignored moves there may be longer branches of the solution.  Therefore, to find the best solutions, we use the ‚Äúskip move‚Äù algorithm only during the primary search. <br><br><h3>  Calculate the strategy </h3><br>  All components are ready, we put the first black stone in the center of the field, launch a search for a solution and ... After a few hours, my laptop‚Äôs resources run out and we have to admit defeat ‚Äúin battle, but not in battle‚Äù. <br><br>  To tell the truth, I had computational power at my disposal with a hundred and fifty Xeon cores and a terabyte of free RAM.  But, dented that in the mid-nineties, Allis had only 10 SUN SPARCstation 2 each with 128 MB of RAM, felt remorse for unsportsmanlike behavior and decided to limit the amount of RAM on the java-machine to 1GB and allocated only 1 stream for the task processor.  It could somehow compensate for my GHz compared to its MHz.  Plus, he promised himself at the end of his work to transfer the algorithms to javascript under the browser. <br><br>  So, the search for strategies needed to begin with the solution of debut etudes.  A detailed description of the debuts for the game Renju in Russian can be found in the well-known books of the Sagar ‚ÄúFrom the debut to the middlegame‚Äù and Mikhail Kozhin and Alexander Nosovsky ‚ÄúRinging of the stones‚Äù <a href="https://sites.google.com/site/renjurussia/pravila/teoreticeskie-materialy">here</a> .  The books are already 20 years old, but since then there has been little such literature.  The more recent collection of Dmitry Yepifanov "Tiger in a cage" of 2015, unfortunately, is not available in electronic form. <br><br>  The search for optimal solutions for the debut was carried out according to the following algorithm.  At the first step, a preliminary calculation was carried out without limiting the length of the lot.  Then, the longest solutions were optimized: replacing the found combinations with shorter solutions for the final steps and searching for shorter branches of solutions for all intermediate moves.  Optimization was performed before reaching the target limit for all branches of the solution.  Then the target limit was decreased and an attempt was made to optimize to the new value. <br><br><img src="https://habrastorage.org/webt/9e/vr/o4/9evro4nlkmpbgmiuo1wvaad7bj0.png"><br><br><img src="https://habrastorage.org/webt/8c/0s/gh/8c0sghxz-vcodr2hzw7vnbdefoe.png"><br><br>  With the 3rd vertical debut shown in the figure, there were no problems.  It turned out a complete set of solutions.  The most difficult positions after the 4th move i8 and j10 as a result were solved in 31 moves.  Then the target limit was set at 35 moves per game. <br><br><img src="https://habrastorage.org/webt/ea/si/lu/easilurzckolnwa4nxmby3vdmkm.png"><br><br><img src="https://habrastorage.org/webt/h-/ou/0r/h-ou0r2kkefr5vkhmfc9wujscu8.png"><br><br>  From the diagonal for the decision traditionally chose the 7th debut.  The most difficult position occurs after the 4th move of g9.  Solutions of admissible length were found for 6 moves g8 and g7. <br><br><img src="https://habrastorage.org/webt/mt/zh/6q/mtzh6qaiqfqwnpnef87esqq-2ee.png"><br><br>  But for this variant of the 6th move on j9 I could not manage to find a solution shorter than 33 moves.  It was almost a disaster.  Out of desperation, I tried solutions for the alternative 5th move, as well as all other types of diagonal debuts.  Debuts were decided to the end, but nothing shorter than 39 moves per game could not be found. <br><br>  Returning to the initial 7th diagonal debut, he redid the algorithm for generating sentences for attacking moves.  As a result, moves leading to positions with a rating score from the third ten, suddenly began to give results and reduce the length of the solution path.  The variability of the calculation with such an amount became quite large.  With a solution depth of 12 moves, there were more than 2 million positions (excluding positions when searching for combinations).  The continuation rested on the allocated 1GB of RAM.  Thus, in order to check the solution before the final fork, in some cases it was necessary to separately resolve positions from the 18th move. <br><br>  After the 7th diagonal debut was decided in a given 35 moves, you could celebrate the victory - the fight for the center was won.  Ahead, there was still a large amount of routine computational work, calculations of ‚Äúnon-optimal‚Äù white moves for completeness of the strategy.  Of the total optimal strategy, the response to such moves as a result was 80%.  Fortunately, they were automatically solved completely on a preliminary calculation after the 2nd move, and all this volume was added to the optimal strategy in a couple of days. <br><br>  So, solutions for all 2 moves found.  We put the first black stone in the center of the field, start the search for a solution and do not even have time to feel the importance of the moment - the initial position is solved in 35 moves.  The graph of the optimal winning strategy is built. <br><br><h3>  We check ourselves </h3><br>  The next step is to test the solution.  Completely turn off the intelligence of the defending side.  After each black move, White goes to any empty cell of the board.  The position obtained after White‚Äôs move must either be found in the decision graph or evaluated as winning for the number of moves that do not exceed the longest branch in the initial position.  When evaluating each position, we check the winning combination found by White‚Äôs admissible moves before Black draws the final piece - five in a row. <br><br>  The check was performed several times to complete.  The final error-free run in single-threaded mode took 14 hours.  In the course of the check, errors were discovered and corrected as a result of differences in the depth of search for combinations, assumptions of skipping, duplication of symmetrical positions. <br><br>  Answer the question - whether the solution in 35 moves is the most optimal.  According to my research for a number of the longest branches of the vertical debut, it is possible to find more optimal solutions with a length of 33 turns.  But for the diagonal after the 6th move on j9, a lot of time was spent on finding a solution of 33 moves, the variation for Black expanded to 50 moves at each step and to no avail.  Strictly prove the absence of a decision in 33 moves fails, the time allocated for the project came to an end and the decision was made to stop at the target limit of 35 moves. <br><br><h3>  Convert from java to javascript </h3><br>  Publication of the solution to the problem requires clarity.  To use the solution directly in the browser it took: <br><br><ul><li>  Reduce the search depth combinations in the evaluation of positions to 17 moves.  This resulted in a 2-3 times increase in the number of pre-calculated moves of the optimal strategy. </li><li>  Convert the binary format of the decision graph to a JSON sequence of moves.  This format is more convenient in javascript and visual. </li><li>  Convert java classes to javascript modules, except for the search for solutions.  Here, in the web-interface, replace calls to rest-services with local functions. </li></ul><br>  List of application classes: <br><br><ul><li>  <a href="">Board</a> - party management on the board, visual interface </li><li>  <a href="">Vertex</a> - the vertex of the decision graph, inherited from the position </li><li>  <a href="">Edge</a> - the edge of the decision graph, the course of connecting positions </li><li>  <a href="">Layout</a> - position, contains a collection of lines </li><li>  <a href="">Line</a> - a line in predetermined directions, contains a collection of figures </li><li>  <a href="">Figure</a> - figure, determines the type and the beginning of the figure on the line </li><li>  <a href="">Pattern</a> - patterns of shapes to compare when searching </li></ul><br>  The complete JSON solution can be downloaded from <a href="">gomoku.json</a> . <br><br>  Sources in the repository on <a href="https://github.com/MaximRud/rv2">GitHub</a> . <br><br>  For clarity, here are examples of the longest games obtained in the demonstration by clicking Next. <br><br>  Diagonal Debut: <br><br><img src="https://habrastorage.org/webt/ut/xg/6g/utxg6gkl_d15x4zgjg1xwi_m5s4.png"><br><br><img src="https://habrastorage.org/webt/18/jh/oy/18jhoyzp05r1swbl7kdi2zkacp0.png"><br><br>  Vertical debut: <br><br><img src="https://habrastorage.org/webt/ko/ps/px/kopspxbbw8g13ti2rxmbdxy8o-a.png"><br><br><img src="https://habrastorage.org/webt/rw/jo/x2/rwjox2wlhopomjsaamqv7t2v3yq.png"></div><p>Source: <a href="https://habr.com/ru/post/437064/">https://habr.com/ru/post/437064/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>