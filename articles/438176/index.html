<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Overview of IPSec in Mikrotik</title>
  <meta name="description" content="IPSec (IP Security) is a set of protocols and algorithms for encrypting data in IPv4 and IPv6 networks. It doesn't sound complicated, but IPSec does n...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>Overview of IPSec in Mikrotik</h1><div class="post__text post__text-html js-mediator-article"><p>  IPSec (IP Security) is a set of protocols and algorithms for encrypting data in IPv4 and IPv6 networks.  It doesn't sound complicated, but IPSec does not set clear rules for encrypting traffic; instead, developers implement a set of tools (protocols and algorithms) that the administrator uses to create a secure channel for data. </p><br><p>  I want to talk about the topic of IPSec in RouterOS a little deeper than a simple HOWTO, with minimal immersion in theory and examples of how to configure and debug IPSec.  This is not a guide and without practice on a test bench, it is not recommended to start setting up real tunnels and VPN servers. </p><a name="habracut"></a><br><h3 id="preimuschestva-i-nedostatki-ipsec">  Advantages and disadvantages of IPSec </h3><br><p>  Strengths: </p><br><ul><li>  Works on the network layer of the OSI model </li><li>  It can encrypt the source packet entirely from the transport layer and above. </li><li>  There is a mechanism to overcome NAT </li><li>  A large set of encryption and hashing algorithms to choose from </li><li>  IPSec - a set of open, extensible standards </li><li>  In the case of Mikrotik, does not require the purchase of additional fees or licenses </li></ul><br><p>  Weak sides: </p><br><ul><li>  Complexity </li><li>  Different terminology and configuration tools from different vendors. </li><li>  Using strong encryption algorithms requires good computing power. </li><li>  Easy to detect DPI </li></ul><br><h3 id="protokoly-v-sostave-ipsec">  Protocols included with IPSec </h3><br><p><img src="https://habrastorage.org/webt/nd/k6/0m/ndk60mwkllka7jpnl2flzdqt8ce.png"></p><br><p>  Globally, all the protocols you will deal with during configuration can be divided into two groups: key exchange protocols and data protection protocols. </p><br><p>  <strong>Key Exchange Protocols (IKE)</strong> <br>  The main task is to authenticate the participants of the connection and agree on the parameters and encryption keys to protect the transmitted information. </p><br><ul><li>  IKE (Internet Key Exchange) - defined in 1998.  Many features (for example, overcoming NAT) were added later as add-ons and may not be implemented by various vendors.  The basis for key negotiation is the ISAKMP protocol. </li><li>  IKEv2 (Internet Key Exchange version 2) is the latest edition from 2014.  Is the development of the IKE protocol, in which some problems were solved, the key agreement mechanism was simplified, extensions (NAT-T, Keepalives, Mode Config) became part of the protocol. </li></ul><br><p>  In practice, most IPSec connections are implemented using IKE, due to outdated equipment, or the reluctance to change something with administrators. </p><br><p>  <strong>Data Security Protocols (ESP, AH)</strong> <br>  The main task is to protect user data. </p><br><ul><li> ESP (Encapsulating Security Payload) - encrypts and partially authenticates transmitted data </li><li>  AH (Authentication Header) - authenticates the entire packet (with the exception of changeable fields), does not encrypt data, but allows you to make sure that the packet was not changed during transmission over the network </li></ul><br><h3 id="poryadok-ustanovki-ipsec-soedineniya">  IPSec connection setup procedure </h3><br><p><img src="https://habrastorage.org/webt/lu/rv/ps/lurvpsvrdub2tcgkmpx8ut5ep58.png"></p><br><p>  The participants of an IPSec connection are called peers (peers), which indicates their equivalence in the established connection.  A configuration close to the client-server is possible, but when building persistent IPSec tunnels, any of the peers can be an initializer. </p><br><ol><li>  One of the peers initializes the IPSec connection </li><li>  Key information is exchanged, peer authentication, connection parameters negotiation </li><li>  Based on the received key information, an auxiliary encrypted tunnel is formed. </li><li>  Using an encrypted tunnel, peers determine data encryption parameters and exchange information to generate keys. </li><li>  The result of the previous phase is a set of rules and keys for data protection (SA). </li><li>  Periodically peers update encryption keys </li></ol><br><p>  One of the key concepts in IPSec is the SA (Security Association) - it is a peer-coordinated set of information encryption and hashing algorithms, as well as encryption keys. </p><br><p>  Sometimes you can find a division on: </p><br><ul><li>  ISAKMP SA - parameters and keys related to the auxiliary tunnel </li><li>  Data SA (or just SA) - parameters and keys related to traffic encryption </li></ul><br><h3 id="poryadok-raboty-protokolov-soglasovaniya-klyuchey">  The operation of the key agreement protocols </h3><br><p>  IKE protocol can operate in two modes: mainly (main) and aggressive (aggressive), IKEv2 protocol contains one mode. </p><br><h4 id="ike-main">  Ike main </h4><br><p><img src="https://habrastorage.org/webt/zw/jb/yv/zwjbyvrpmup5t7nfgaol329rudi.png"></p><br><p>  The first phase consists of six packages: <br>  1-2: Matching the encryption parameters of the secondary tunnel and various IPSec options <br>  3-4: Exchange of information to generate a secret key <br>  5-6: Peer authentication using an auxiliary encrypted channel </p><br><p>  The second phase consists of three packages: <br>  1-3: Using an encrypted auxiliary channel.  Coordination of traffic protection parameters, information exchange for generating a secret key </p><br><h3 id="ike-aggressive">  IKE Aggressive </h3><br><p><img src="https://habrastorage.org/webt/xu/wz/qu/xuwzqu4qle5lxlcvb-hnvuhqehg.png"></p><br><p>  The first phase consists of three packages: <br>  1: Sending a proposal for installing an auxiliary encrypted channel and information for generating a secret key <br>  2: Response to the proposal, information for generating a secret key, data for authentication <br>  3: Authentication data </p><br><p>  The second phase consists of three packages: <br>  1-3: Using an encrypted auxiliary channel.  Coordination of traffic protection parameters, information exchange for generating a secret key </p><br><p>  In aggressive mode, the initiator sends only one set of parameters in the offer.  Peer authentication information is exchanged prior to the installation of a secure auxiliary tunnel.  Aggressive mode is consistent faster, but less secure. </p><br><h3 id="ikev2">  IKEv2 </h3><br><p><img src="https://habrastorage.org/webt/ev/mq/ni/evmqnimq5_sdeybuz63x3ddssbu.png"></p><br><p>  In IKEv2, the phases are named: IKE_SA_INIT and IKE_AUTH.  <em>But if in the text below I‚Äôm talking about Phase1 and Phase2, then this also applies to IKEv2 phases.</em> </p><br><p>  Each IKEv2 phase consists of two packets: <br>  IKE_SA_INIT: Coordinating the encryption parameters of the secondary tunnel, sharing information to generate the private key </p><br><p>  IKE_AUTH: using an encrypted auxiliary channel.  Authenticating peers, negotiating traffic protection parameters, exchanging information for generating a secret key </p><br><h3 id="security-assotiations-database-sad">  Security Assotiations Database (SAD) </h3><br><p>  The result of the work of IKE (and IKEv2) are Security Assotiations (SA), which determine the parameters of traffic protection and encryption keys.  Each SA is unidirectional and the IPSec connection contains a pair of SA.  All SAs are stored in the SAD database and are available to the administrator for viewing and resetting. </p><br><h3 id="inkapsulyaciya-dannyh">  Data encapsulation </h3><br><p><img src="https://habrastorage.org/webt/3z/3k/aa/3z3kaaj2rwmnx59apvueigp3lno.png"></p><br><p>  IPSec provides two options for encapsulating data: </p><br><ul><li>  Transport mode - only the payload of the packet is protected, leaving the original header.  To build tunnels, the transport mode is usually used in conjunction with ipip or gre, the payload of which already contains the entire source packet. </li><li>  Tunnel mode - fully encapsulates the original packet into a new one (by analogy with gre or ipip).  But for tunnel ipsec, no explicit interface is created in the system; this can be a problem if dynamic or complex static routing is used. </li></ul><br><h3 id="security-policy-database-spd">  Security Policy Database (SPD) </h3><br><p>  The base of rules determining which traffic should be encrypted, data protection protocol, encapsulation type and a number of other parameters. <br>  The SPD check position can be displayed on the Packet Flow schematic. </p><br><p><img src="https://habrastorage.org/webt/nh/jo/rm/nhjorm-je866yymx0_cxwdnyop8.png"></p><br><h3 id="preodolenie-nat">  Overcoming NAT </h3><br><p>  IPSec uses network layer protocols to transfer data that NAT cannot handle.  To solve the problem, the NAT-T protocol is used (extension in IKE and part of IKEv2).  The essence of NAT-T is the additional encapsulation of IPSec packets into UDP packets that NAT processes. </p><br><h3 id="ipsec-v-mikrotik">  IPSec in Mikrotik </h3><br><p>  IPSec is available for free on any device running RouterOS with the Security package installed. </p><br><h3 id="apparatnoe-shifrovanie">  Hardware encryption </h3><br><p>  For offloading the CPU, hardware acceleration of encryption is added to some models of MikroTik routers, a full list can be found <a href="https://wiki.mikrotik.com/wiki/Manual:IP/IPsec">on the wiki</a> . <br>  The most budget options: <a href="https://mikrotik.com/product/RB750Gr3">RB750Gr3</a> , <a href="https://mikrotik.com/product/RB3011UiAS-RM">RB3011</a> , <a href="https://mikrotik.com/product/hap_ac2">HAP AC ^ 2</a> . </p><br><p>  On my own, I checked the IPSec speed between two RB1100AHx2 and between two RB750Gr3. </p><br><p>  To achieve maximum results on RB1100AHx2, you need: </p><br><ul><li>  Use port 11 directly connected to the CPU and configure one CPU core to handle traffic on port 11 </li><li>  Use only-hardware-queues on interfaces, disable RPS </li><li>  Enable Layer3 FastPath (about 800mb / sec), or exclude IPSec traffic from conntrack (about 700mb / sec) <br>  Without the described manipulations on the slowest port (ether13) it is possible to get ~ 170Mb / sec, on the usual ~ 400Mb / sec. </li></ul><br><p>  On RB750Gr3 without optimizations around 200Mb / sec. </p><br><p>  Routers on single-core Qualcomm show a result of 10-40mb / sec, depending on the model, optimizations and congestion with other processes. </p><br><p>  I recommend to get acquainted with the <a href="https://www.youtube.com/watch%3Fv%3Du1URSgvAxX8">presentation</a> from the employee mikrotik, there are topics on how to optimize settings to reduce the load on the CPU and increase the speed, which I did not add to the text. </p><br><h3 id="razlichiya-642x-i-643x">  Differences 6.42.X and 6.43.X </h3><br><p>  Depending on the version of RouterOS used, the IPSec configuration menu will vary. </p><br><p><img src="https://habrastorage.org/webt/6q/pz/5c/6qpz5cgthate04bihl8gq2zr9t8.png"></p><br><p><img src="https://habrastorage.org/webt/ng/ug/hi/ngughirhx6nwd1v8mjaa9omfb7g.png"></p><br><p><img src="https://habrastorage.org/webt/kv/ow/3-/kvow3-bmivzfr_tf6bqnywr5wu8.png"></p><br><p>  There are already new changes in the testing version, so read the Release Notes before updating. </p><br><p><img src="https://habrastorage.org/webt/ri/rd/gu/rirdgucrebbf1ucxjqbj65gzf-s.png"></p><br><h3 id="konfiguraciya-ipsec">  IPSec configuration </h3><br><p><img src="https://habrastorage.org/webt/r6/lf/j5/r6lfj5hlclkbx9qmph0owsqf_ak.png"><br>  Menu [IP] -&gt; [IPSec] is not as scary as it seems at first glance.  The diagram shows that the main configuration items are: Peers and Profiles. <br>  The Remote Peers and Installed SAs tabs are informational. </p><br><h4 id="peers-i-peers-profiles">  Peers and Peers Profiles </h4><br><p>  IPSec peers configuration to establish an IKE connection and create an auxiliary secure tunnel. </p><br><p><img src="https://habrastorage.org/webt/e2/kj/e1/e2kje1zwzhubqsyriypavj3bmfm.png" alt="image"></p><br><p>  <strong>Setting up IPSec remote peers</strong> </p><br><p><img src="https://habrastorage.org/webt/pq/9d/cv/pq9dcvyqrf64pdklohgf1eapoze.png"></p><br><div class="spoiler">  <b class="spoiler_title">Notes</b> <div class="spoiler_text"><ul><li>  Starting at 6.43, RouterOS swears when using PSK without additional authentication.  If you do not want to further configure the keys, certificates, or xAuth, you can switch to IKEv2 or ignore the warning. </li><li>  As peers, you can specify specific IP or subnet (relevant for Client-Server VPN) </li><li>  If there are conflicting rules, a rule with a more accurate subnet will be used to connect to the peer (by analogy with routes) </li><li>  XAuth and rsa key authentication does not work in IKEv2 </li><li>  For IKEv2, Mikrotik made their xAuth implementation incompatible with other platforms. </li><li>  Passive mode is usually used to create Client-Server VPN (L2TP / IPsec or IKEv2 mode config), but can be useful when connecting a large number of Site-to-Site tunnels to a single point, to reduce spurious traffic. </li><li>  If you plan to use xAuth, then the "server" should be passive.  Users for the server are created in [IPSec] -&gt; [Users] </li><li>  When using Generate policy, choose the port-strict mode. </li></ul></div></div><br><p>  <strong>Setting Profiles (Proposals) for Phase 1 Matching</strong> </p><br><p><img src="https://habrastorage.org/webt/w8/s9/vj/w8s9vjxiguir63a_hfpci1ih1bi.png" alt="image"></p><br><p><img src="https://habrastorage.org/webt/_v/x3/ff/_vx3ff1ogwsxjggebdjqazfqhve.png"></p><br><div class="spoiler">  <b class="spoiler_title">Notes</b> <div class="spoiler_text"><ul><li>  Additional options for IKE have become part of IKEv2, settings ignored </li><li>  <a href="https://wiki.mikrotik.com/wiki/Manual:IP/IPsec">The ratio of DH groups with their numbers</a> (group numbers are used by other vendors) </li><li>  When sending offers (Proposals), the system sorts pairs of algorithm + group dh from more resistant to less resistant <br><img src="https://habrastorage.org/webt/7i/h8/fj/7ih8fjegurxodmq-daxuwxfhpii.png"></li></ul></div></div><br><h4 id="policies-i-policy-proposals">  Policies and Policy Proposals </h4><br><p>  Policies check passing packages for compliance with the conditions and apply the specified actions.  If you return to Packet flow, then blocks with IPSec Policy are reconciliation with policies.  The actions specify: IPSec security protocol (ESP or AH), suggestions for SA negotiation, encapsulation mode. <br><img src="https://habrastorage.org/webt/tp/bk/1n/tpbk1nrkowlvaqdnrfvgpvbaxg0.png" alt="image"></p><br><p>  The package passes the policy one by one until it matches the terms of one of them. </p><br><p>  <strong>Policy setting</strong> <br><img src="https://habrastorage.org/webt/yw/cp/nj/ywcpnjdyjonrxpnfel79irfov4g.png"></p><br><div class="spoiler">  <b class="spoiler_title">Rumors</b> <div class="spoiler_text"><ul><li>  Usually it is not required to specify a specific Src.  and Dst.  Port, but in general the ability to encrypt the traffic of a separate application is interesting </li><li>  Not all ip protocols are presented in the Protocols list (for example, no gre), you can specify the number of the desired protocol manually. </li><li>  Templates are not politicians!  They are used if generate-policy is set in the peer configuration </li><li>  What to do if certain SAs for the policy were not found.  Previously, there was a problem with L2TP / IPSec, when several clients could not connect due to a single NAT (using IKE), this bug is solved (provided that these clients are not windows) if you set level = unique.  Otherwise, go to IKEv2 </li><li>  When setting policies, use [Safe mode], one awkward movement and you risk losing access to the router via Level3 </li></ul></div></div><br><p>  <strong>Setting up offers (Proposals) to negotiate SA</strong> <br><img src="https://habrastorage.org/webt/mh/yf/cd/mhyfcd2-2nsxbouuxhgbecj3kyu.png"></p><br><p><img src="https://habrastorage.org/webt/0n/xk/tw/0nxktwxmxyu2quyanfw-rco-yqa.png"></p><br><h4 id="groups">  Groups </h4><br><p>  Used to associate policy templates and peers. </p><br><p><img src="https://habrastorage.org/webt/do/r7/gc/dor7gc6s4zuwlo2mmz5irrc3alm.png" alt="image"></p><br><p>  In one of the old versions of RouterOS, there was a bug with the default non-working group. </p><br><h4 id="mode-config">  Mode Config </h4><br><p>  Sending and receiving IP parameters without using additional protocols.  Allows you to create a self-contained Client-to-Server VPN only IPSec. </p><br><p><img src="https://habrastorage.org/webt/sr/s2/dl/srs2dl4tcpixxiwi2mrletlguva.png"></p><br><p><img src="https://habrastorage.org/webt/os/r2/gg/osr2ggrnm_0-vqtoukxb5hnzfjs.png"></p><br><h4 id="keys-i-users">  Keys and Users </h4><br><p>  Used for advanced peer authentication. <br>  <strong>Keys</strong> <br>  RSA keys: generation, import, export.  Not supported in IKEv2. </p><br><p><img src="https://habrastorage.org/webt/ec/7z/j4/ec7zj4doiqkdgwe4soh7lrk21f8.png"></p><br><p>  <strong>Users</strong> <br>  XAuth user database for "server".  The client specifies the xAuth settings in the peer configuration.  It is possible to forward xAuth authentication to a RADIUS server. </p><br><p><img src="https://habrastorage.org/webt/pi/wl/vq/piwlvq80v1cnndmhyjg91jzrqle.png"></p><br><h4 id="remote-peers">  Remote peers </h4><br><p>  A list of all peers installing and installing an auxiliary tunnel (Phase 1).  You can delete peers to update secondary tunnel keys. </p><br><p><img src="https://habrastorage.org/webt/j2/-g/ct/j2-gct_8wrf7bl2zgtzqsswwbgk.png" alt="image"></p><br><p><img src="https://habrastorage.org/webt/2k/37/3m/2k373mg8qxox4y-ruph-jza_d0m.png" alt="image"></p><br><h4 id="installed-sas">  Installed SAs </h4><br><p>  SAD database or list of all agreed SAs.  You can see the data protection algorithms and keys used. </p><br><p><img src="https://habrastorage.org/webt/jw/jb/su/jwjbsuorsms85vw656xfgvcneuc.png" alt="image"></p><br><p><img src="https://habrastorage.org/webt/wd/8x/gr/wd8xgrc-h0ngxcfq77qun4ymuhk.png" alt="image"></p><br><p>  The Hardware AEAD flag indicates the use of hardware encryption. </p><br><p><img src="https://habrastorage.org/webt/jz/5-/yv/jz5-yv-xaw_a8gx5zrxz1hlesye.png" alt="image"></p><br><p>  The administrator can reset the SA, but only simultaneously all of the same type (esp or ah). </p><br><h4 id="ipsec-i-firewall">  IPSec and Firewall </h4><br><p>  In the Firewall, you can check whether the traffic is inbound or outbound IPSec policy or not.  The obvious use is L2TP / IPSec, you can prevent the installation of L2TP connections if the traffic was not previously encrypted. </p><br><p><img src="https://habrastorage.org/webt/xt/06/sw/xt06swif3vlsv_vjcyywb1lepf0.png"></p><br><p>  <strong>Protocols and ports used in IPSec</strong> </p><br><ul><li>  IKE-UDP: 500 </li><li>  IKEv2 - UDP: 4500 </li><li>  NAT-T - UDP: 4500 </li><li>  ESP - ipsec-esp (50) </li><li>  AH - ipsec-ah (51) </li></ul><br><h3 id="ipsec-i-endpoinds">  IPSec and Endpoinds </h3><br><p>  And now about the sore ... <br>  The wiki mikrotik has tables with hashing and encryption algorithms for: <a href="https://wiki.mikrotik.com/wiki/Manual:IP/IPsec">Windows</a> , <a href="https://wiki.mikrotik.com/wiki/Manual:IP/IPsec">iOS</a> , <a href="https://wiki.mikrotik.com/wiki/Manual:IP/IPsec">OS-X</a> . </p><br><p>  I did not find any information about the client built into the android vpn, but in general it works with the proposals from windows.  IKEv2 does not support Android, you must use <a href="https://download.strongswan.org/Android/">StrongSwan</a> . </p><br><h3 id="primery-konfiguracii">  Configuration examples </h3><br><p>  Scheme and basic configuration for examples with Site-to-Site tunnels: </p><br><p><img src="https://habrastorage.org/webt/bn/a7/xu/bna7xud0pazv4ipia2k0083wqom.png"></p><br><pre><code class="plaintext hljs">#Mikrotik1 /ip address add address=10.10.10.10/24 interface=ether1 network=10.10.10.0 add address=192.168.100.1/24 interface=ether2 network=192.168.100.0 /ip firewall nat add action=masquerade chain=srcnat out-interface=ether1 /ip route add distance=1 gateway=10.10.10.1 dst-address=0.0.0.0/0 #Mikrotik2 /ip address add address=10.20.20.20/24 interface=ether1 network=10.20.20.0 add address=192.168.200.1/24 interface=ether2 network=192.168.200.0 /ip firewall nat add action=masquerade chain=srcnat out-interface=ether1 /ip route add distance=1 gateway=10.20.20.1 dst-address=0.0.0.0/0</code> </pre> <br><h4 id="ipsec-v-tunnelnom-rezhime">  IPSec in tunnel mode </h4><br><p><img src="https://habrastorage.org/webt/wy/cg/ad/wycgadjksxuyftckhoctoxciub4.png"></p><br><p>  Step configuration: </p><br><ol><li>  Create Proposals for IKE Phase1 </li><li>  Create a feast.  Specify the address, proposals, exchange mode, key PSK.  I chose IKEv2, you can use main / agressive as desired </li><li>  Create Proposals for SA </li><li>  Specify the subnets between which we create the tunnel </li><li>  Specify the SA addresses, tunnel mode and proposals to encrypt traffic </li><li>  Editing the NAT rule </li></ol><br><div class="spoiler">  <b class="spoiler_title">Mikrotik1</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/c2/tg/at/c2tgatfqb3bgw5qer0u6lvi_jt0.png"></a> </p><br><p>  Console option: </p><br><pre> <code class="plaintext hljs">#1 /ip ipsec peer profile add dh-group=modp2048 enc-algorithm=aes-128 hash-algorithm=sha256 name=ipsec-tunnel-ike nat-traversal=no #2 /ip ipsec peer add address=10.20.20.20/32 exchange-mode=ike2 profile=ipsec-tunnel-ike secret=test-ipsec #3 /ip ipsec proposal add auth-algorithms=sha256 enc-algorithms=aes-256-cbc name=ipsec-tunnel-sa #4-5 /ip ipsec policy add dst-address=192.168.200.0/24 proposal=ipsec-tunnel-sa sa-dst-address=10.20.20.20 sa-src-address=10.10.10.10 src-address=192.168.100.0/24 tunnel=yes #6 /ip firewall nat set 0 ipsec-policy=out,none</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Mikrotik2</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/je/5y/gq/je5ygqbnhfjklyqxu8pg1kf2saq.png"></a> </p><br><p>  Console option: </p><br><pre> <code class="plaintext hljs">#1 /ip ipsec peer profile add dh-group=modp2048 enc-algorithm=aes-128 hash-algorithm=sha256 name=ipsec-tunnel-ike nat-traversal=no #2 /ip ipsec peer add address=10.10.10.10/32 exchange-mode=ike2 profile=ipsec-tunnel-ike secret=test-ipsec #3 /ip ipsec proposal add auth-algorithms=sha256 enc-algorithms=aes-256-cbc name=tets-ipsec-sa #4-5 /ip ipsec policy add dst-address=192.168.100.0/24 proposal=tets-ipsec-sa sa-dst-address=10.10.10.10 sa-src-address=10.20.20.20 src-address=192.168.200.0/24 tunnel=yes #6 /ip firewall nat set 0 ipsec-policy=out,none</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">And then NAT?</b> <div class="spoiler_text"><p>  To work in tunnel mode, you need a fake route to the remote subnet, or a default route, otherwise the packets will not go further Routing decision.  There are usually no problems with the first option, but with the default route and Source NAT (the first and second are present on the vast majority of home and office routers) there will be problems. </p><br><p>  Remember Packet Flow.  Packages go through Source NAT earlier than IPSec policies, the rule with masquerade is unaware that the traffic is meant to be sent to the ‚Äúephemeral‚Äù tunnel and will broadcast the headers of packets to be sent to IPSec when the packet with the changed header gets sent to Policies source address the header will not fit the rule and the packet will fly away to the default route, which, having seen the destination address from the private network, will most likely drop it. </p><br><p>  There are several solutions to the problem: </p><br><ul><li>  Using the fake route </li><li>  Using additional accept rules before SourceNAT </li><li>  Expose src-nat only to packets for which there are no IPSec policies (in the example) </li><li>  Exclude traffic from connection tracking with RAW </li></ul></div></div><br><p>  <strong>Check connection</strong> <br><img src="https://habrastorage.org/webt/no/xd/cn/noxdcnqrsbftj6mfsxlmpruizmq.png" alt="image"></p><br><ol><li>  We see a neighbor in the Remote Peers </li><li>  We see installed SA (traffic counters will not change until you let it go) </li><li>  Established status and flag (A) ctive in politics </li></ol><br><h4 id="ipipipsec">  IPIP / IPSec </h4><br><p><img src="https://habrastorage.org/webt/2b/hy/1d/2bhy1d1tnwd57iyppymvb8dbkww.png"></p><br><p>  Pre-configuration of IPIP tunnel: </p><br><pre> <code class="plaintext hljs">#Mikrotik1 #–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ ipip /interface ipip add allow-fast-path=no clamp-tcp-mss=no name=ipip-vpn remote-address=10.20.20.20 #–£—Å—Ç–∞–Ω–æ–≤–∫–∞ ip –∞–¥—Ä–µ—Å–∞ –Ω–∞ ipip –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å /ip address add address=10.30.30.1/30 interface=ipip-vpn #–°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –º–∞—Ä—à—Ä—É—Ç –¥–æ —É–¥–∞–ª–µ–Ω–Ω–æ–π –ø–æ–¥—Å–µ—Ç–∏ /ip route add distance=1 dst-address=192.168.200.0/24 gateway=10.30.30.2 #Mikrotik2 #–í—Å–µ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ, –º–µ–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∞–¥—Ä–µ—Å–∞ –∏ –ø–æ–¥—Å–µ—Ç–∏ /interface ipip add allow-fast-path=no clamp-tcp-mss=no name=ipip-vpn remote-address=10.10.10.10 /ip address add address=10.30.30.2/30 interface=ipip-vpn /ip route add distance=1 dst-address=192.168.100.0/24 gateway=10.30.30.1</code> </pre> <br><p>  Step by Step IPSec Configuration: </p><br><ol><li>  Create Proposals for IKE Phase1 </li><li>  Create a feast.  Specify the address, proposals, exchange mode, PSK key </li><li>  Create Proposals for SA </li><li>  Specify the subnets between which we create the tunnel </li><li>  Specify the addresses of SA, the type of traffic that we will encrypt and proposals </li></ol><br><div class="spoiler">  <b class="spoiler_title">Mikrotik1</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/5e/mf/_w/5emf_wcxb3ulnjv3fykuino9stg.png"></a> </p><br><p>  Console option: </p><br><pre> <code class="plaintext hljs">#1 /ip ipsec peer profile add dh-group=modp2048 enc-algorithm=aes-128 hash-algorithm=sha256 name=ipsec-tunnel-ike nat-traversal=no #2 /ip ipsec peer add address=10.20.20.20/32 exchange-mode=ike2 profile=ipsec-tunnel-ike secret=test-ipsec #3 /ip ipsec proposal add auth-algorithms=sha256 enc-algorithms=aes-256-cbc name=ipsec-tunnel-sa #4-5 /ip ipsec policy add dst-address=10.20.20.20/32 proposal=ipsec-tunnel-sa protocol=ipencap src-address=10.10.10.10/32 sa-dst-address=10.20.20.20 sa-src-address=10.10.10.10</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Mikrotik2</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/9o/dk/oy/9odkoy8krqem4mck9rkfibhm220.png"></a> </p><br><pre> <code class="plaintext hljs">#1 /ip ipsec peer profile add dh-group=modp2048 enc-algorithm=aes-128 hash-algorithm=sha256 name=ipsec-tunnel-ike nat-traversal=no #2 /ip ipsec peer add address=10.10.10.10/32 exchange-mode=ike2 profile=ipsec-tunnel-ike secret=test-ipsec #3 /ip ipsec proposal add auth-algorithms=sha256 enc-algorithms=aes-256-cbc name=tets-ipsec-sa #4-5 /ip ipsec policy add dst-address=10.10.10.10/32 proposal=tets-ipsec-sa protocol=ipencap src-address=10.20.20.20/32 sa-dst-address=10.10.10.10 sa-src-address=10.20.20.20</code> </pre> </div></div><br><p>  For the inattentive, the real difference is the configuration of the tunnel and transport mode in IPSec Policies: <br><img src="https://habrastorage.org/webt/5v/ka/fg/5vkafg3ca8vilvv0s-lv1tdbxhw.png" alt="image"></p><br><p>  Connection test is similar to tunnel mode. </p><br><h4 id="l2tpipsec">  L2TP / IPSec </h4><br><p>  The previous examples are well suited for creating persistent VPNs between two peers, with static external IP addresses. </p><br><p>  If the address of one of the peers is dynamic (and is usually located behind a NAT), you must use another Client-to-Server VPN. <br><img src="https://habrastorage.org/webt/ms/l5/3a/msl53ahdcdv8fl2vd-62m1exdmk.png" alt="image"></p><br><p>  Preliminary L2TP configuration: </p><br><pre> <code class="plaintext hljs">#–°–æ–∑–¥–∞–Ω–∏–µ –ø—É–ª–∞ –∞–¥—Ä–µ—Å–æ–≤ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ /ip pool add name=pool-l2tp ranges=192.168.77.10-192.168.77.20 #–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ /ppp profile add change-tcp-mss=yes local-address=192.168.77.1 name=l2tp-ipsec only-one=yes remote-address=pool-l2tp use-compression=no use-encryption=no use-mpls=no use-upnp=no #–°–æ–∑–¥–∞–Ω–∏–µ —É—á–µ—Ç–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π /ppp secret add name=user1 password=test1 profile=l2tp-ipsec service=l2tp add name=user2 password=test2 profile=l2tp-ipsec service=l2tp add name=user3 password=test3 profile=l2tp-ipsec service=l2tp #–í–∫–ª—é—á–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ L2TP (–±–µ–∑ –∞–≤—Ç–æ–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ipsec) /interface l2tp-server server set authentication=chap,mschap2 default-profile=l2tp-ipsec enabled=yes</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Why do I ignore IPSec auto configuration</b> <div class="spoiler_text"><p>  In the configuration of ipip, gre, eoip, l2tp there is an auto-configuration of ipsec connections, in fact the system creates dynamic rules for Peers and Policies for you, but firstly - we are not looking for easy ways, secondly, when upgrading from 6.42 to 6.43, automatically created tunnels broke and not the fact that this will not happen again. </p></div></div><br><p>  Step by Step IPSec Configuration: </p><br><ol><li>  Create a new group (you can use default) </li><li>  Create Proposals for IKE Phase1 </li><li>  Create a feast, or rather a subnet.  Swears on the PSK key, but if we are dealing with windows as a client, then we have a choice: Certificates or PSK. </li><li>  Set passive = yes and send-init-contact = no, generate-policy = port-strict (accept port from client) </li><li>  Create Proposals for SA </li><li>  Create a template for generating policies </li><li>  Specify proposal for SA </li></ol><br><div class="spoiler">  <b class="spoiler_title">Mikrotik configuration</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/ua/a8/ph/uaa8phm-3iy-qvrxuc6m4kbirr8.png" alt="image"></a> <br>  <em>On the screenshot of the error - indicate dst.</em>  <em>port and src.</em>  <em>port is not needed</em> </p><br><p>  Console option: </p><br><pre> <code class="plaintext hljs">#1 /ip ipsec policy group add name=l2tp-ipsec #2 /ip ipsec peer profile add dh-group=modp1024 enc-algorithm=aes-256 hash-algorithm=sha256 name=l2tp-ipsec-ike #3-4 /ip ipsec peer add address=0.0.0.0/0 generate-policy=port-strict passive=yes policy-template-group=l2tp-ipsec profile=l2tp-ipsec-ike secret=secret-ipsec-pass send-initial-contact=no #5 /ip ipsec proposal add auth-algorithms=sha256,sha1 enc-algorithms=aes-256-cbc,aes-128-cbc name=l2tp-ipsec-sa pfs-group=none #6-7 /ip ipsec policy add dst-address=0.0.0.0/0 group=l2tp-ipsec proposal=l2tp-ipsec-sa protocol=udp src-address=0.0.0.0/0 template=yes</code> </pre> </div></div><br><p>  <strong>Configuring a firewall to create L2TP connections only after IPSec</strong> </p><br><pre> <code class="plaintext hljs">/ip firewall filter #–†–∞–∑—Ä–µ—à–∞–µ–º IKE, NAT-T –∏ ipsec-esp add chain=input protocol=17 dst-port=500,4500 action=accept add chain=input protocol=50 action=accept #–†–∞–∑—Ä–µ—à–∞–µ–º L2TP, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ–ª–∏—Ç–∏–∫–∞ ipsec –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞ add chain=input protocol=17 dst-port=1701 ipsec-policy=in,ipsec action=accept add chain=input protocol=17 dst-port=1701 action-drop</code> </pre> <br><h4 id="ikev2-vpn">  IKEv2 VPN </h4><br><p>  The variant with L2TP is popular, but thanks to the mode config you can configure the VPN server using only IPSec.  This is a promising type of VPN, but rarely used so far, so besides the configuration of the server part, I will give an example of setting up a strongSwan client on android. </p><br><p><img src="https://habrastorage.org/webt/el/un/fu/elunfukm2k6qajijslvcfd-zvuy.png" alt="image"></p><br><p>  Of course, not everything is so rosy.  Most of the "user" OS (in particular, Windows and Android) agree to work with such a VPN only if they are authenticated by certificates or EAP. </p><br><p>  <em>Certificates are my weak point, if someone knows how to correctly generate a self-signed certificate that windows imports and will use in a connection - write in the comment.</em> </p><br><p>  Pre-generation certificates: </p><br><pre> <code class="plaintext hljs">#Root CA –∏ —Å–∞–ø–æ–º–æ–¥–ø–∏—Å—å /certificate add name=ca common-name="IKEv2 CA" days-valid=6928 /certificate sign ca ca-crl-host=&lt;IP —Ä–æ—É—Ç–µ—Ä–∞&gt; #–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞ vpn /certificate add common-name=&lt;IP —Ä–æ—É—Ç–µ—Ä–∞&gt; subject-alt-name=IP:&lt;IP —Ä–æ—É—Ç–µ—Ä–∞&gt; key-usage=tls-server name=vpn days-valid=6928 #–ü–æ–¥–ø–∏—Å—å —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ /certificate sign vpn ca=ca #–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ #–ö–ª–∏–µ–Ω—Ç—ã —Å –æ–¥–Ω–∏–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º –Ω–µ —Å–º–æ–≥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ, –ø–æ—ç—Ç–æ–º—É –≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –ø–æ –æ–¥–Ω–æ–º—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ #–î–ª—è –æ—Ç–º–µ–Ω—ã –¥–æ—Å—Ç—É–ø–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–¥–µ–ª–∞—Ç—å Revoke –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ /certificate add common-name=client key-usage=tls-client name=client days-valid=6928 #–ü–æ–¥–ø–∏—Å—å –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ /certificate sign client ca=ca</code> </pre> <br><p>  Step-by-step configuration of IKEv2 VPN: </p><br><ol><li>  We create a pool of addresses for distribution to clients </li><li>  Create a mode config profile for distributing IP settings to clients </li><li>  Create groups to link Peers and templates policies </li><li>  Create Proposals for IKE Phase1 </li><li>  Create a profile to connect peers.  Authentication via certificates, IKEv2 protocol, passive mode </li><li>  Specify the profile mode config profile, a group of 3 steps and enable policy generation </li><li>  Create Proposals for SA </li><li>  Create a template for generating policies </li><li>  Specifying Proposals for SA </li></ol><br><div class="spoiler">  <b class="spoiler_title">Mikrotik setup</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/1r/8w/vj/1r8wvjsgjjwhijje2dhwb90qv78.png" alt="image"></a> </p><br><pre> <code class="plaintext hljs">#1 /ip pool add name=pool-ike ranges=192.168.77.10-192.168.77.20 #2 /ip ipsec mode-config add address-pool=pool-ike address-prefix-length=32 name=ikev2-vpn static-dns=77.88.8.8 system-dns=no #3 /ip ipsec policy group add name=ikev2-vpn #4 /ip ipsec peer profile add enc-algorithm=aes-256,aes-128 hash-algorithm=sha256 name=ikev2-vpn #5-6 /ip ipsec peer add address=0.0.0.0/0 auth-method=rsa-signature certificate=vpn exchange-mode=ike2 generate-policy=port-strict mode-config=ikev2-vpn passive=yes policy-template-group=ikev2-vpn profile=ikev2-vpn send-initial-contact=no #7 /ip ipsec proposal add auth-algorithms=sha256,sha1 enc-algorithms=aes-256-cbc,aes-128-cbc name=ikev2-vpn #8-9 /ip ipsec policy add dst-address=0.0.0.0/0 group=ikev2-vpn proposal=ikev2-vpn src-address= 0.0.0.0/0 template=yes</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Configuration strongSwan on android.</b> <div class="spoiler_text"><p>  <em>You must first transfer the client and ca certificates to your phone.</em> <br>  <a href="">https://habrastorage.org/webt/tp/pk/ad/tppkadaifd1k7xi6hf3jxgg7vcs.png</a> </p><br><p>  <em>For big-eyed: A cross near the wi-fi is because</em>  <em>Most of the system applications are blocked by AFWall +.</em> </p></div></div><br><p>  If the connection is successful, there will be: a dynamic policy, an entry in remote Peers and a pair of SA. </p><br><p><img src="https://habrastorage.org/webt/89/ov/4w/89ov4wsqvw7r-dvsoz2crontmlk.png" alt="image"></p><br><p><img src="https://habrastorage.org/webt/cc/b2/ic/ccb2icr_nqz32btmghwptrz7svc.png" alt="image"></p><br><p><img src="https://habrastorage.org/webt/sl/cn/gz/slcngz0e3objej8x3fw4-m3wypc.png" alt="image"></p><br><p>  <em>The RouterOS x86 demo license has no restrictions on the number of IPSec tunnels, including IKEv2 VPN.</em>  <em>You can deploy RouterOS x86 demo (do not confuse with RouterOS CHR free, everything is sad there) on the VPS and get a personal VPN server with a minimum of administrative effort, without buying a license for RouterOS or RouterOS CHR.</em> </p><br><h3 id="para-slov-pro-analiz-logov-ipsec">  A couple of words about the analysis of IPSec logs </h3><br><p>  The logs in Mikrotik are a separate story, and sometimes they are detailed enough to analyze the problem, but the lack of commonplace features: clear, copy, find, forces you to install a separate syslog server. </p><br><p>  As for IPSec, here‚Äôs a quick log analysis option (leaving only the one you need on a separate tab): </p><br><p><img src="https://habrastorage.org/webt/05/rz/_g/05rz_grffjd7zz1r-a8zhsi87cy.png" alt="image"></p><br><pre> <code class="plaintext hljs">/system logging action add memory-lines=100000 name=ipsec target=memory /system logging add action=ipsec topics=ipsec,error add action=ipsec topics=ipsec,debug,!packet add action=ipsec topics=ipsec,info</code> </pre> <br><p>  And a couple of examples of typical IPSec configuration problems: </p><br><div class="spoiler">  <b class="spoiler_title">Proposals matching problem on Phase1</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/bp/jm/y1/bpjmy12i4eieobnfhrnj3hlvpcq.png" alt="image"></p><br><ol><li>  We read the error message.  The problem with the negotiation of Proposals in the first phase. </li><li>  We look above, the router itself tells what sent a feast, and what is configured locally </li></ol></div></div><br><div class="spoiler">  <b class="spoiler_title">Problem of coordination of proposals IKE_SA_INIT</b> <div class="spoiler_text"><p>  In the logs you will see something like the following: </p><br><p><img src="https://habrastorage.org/webt/8i/d9/gh/8id9ghqgdgxsjjsfhn3zcn5_vtq.png"></p><br><p>  Analyzing traffic </p><br><p>  In the request you can see the proposals from the feast: </p><br><p><img src="https://habrastorage.org/webt/pw/u2/ib/pwu2ibw3dyxswemrr74wcbphcoy.png"></p><br><p>  In the answer, we see that there are no suitable proposals: </p><br><p><img src="https://habrastorage.org/webt/q2/lb/qk/q2lbqkcr8qvtd1hgia4fj0hrb44.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">Proposals negotiation problem for SA</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/2y/yg/7m/2yyg7ma7ko4lce5vsyef4nmojdi.png"><br>  The router prompts about the error of the proposals on phase2 and shows what is configured locally and what is remote. </p></div></div><br><div class="spoiler">  <b class="spoiler_title">Proposals negotiation problem IKE_AUTH</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/bn/pk/vn/bnpkvnfazxyqmpbvdg78e26mfgy.png"><br>  We see that connection and authentication of peers have occurred, but further the error of proposals.  You will not see details in the debug, in wireshark too (the IKE_AUTH traffic is encrypted). </p></div></div><br><div class="spoiler">  <b class="spoiler_title">PSK authentication error</b> <div class="spoiler_text"><p>  For IKE: </p><br><p><img src="https://habrastorage.org/webt/cp/wm/b5/cpwmb55qp8qyjmba_xijboxmiwa.png"></p><br><p>  For IKEv2: <br><img src="https://habrastorage.org/webt/ks/fn/k0/ksfnk0qdgmgizzusfsyrlwxvcfs.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">Wrong IKE mode</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/md/fb/ll/mdfbllmvedawn5ptdd-yvjcsrpw.png" alt="image"><br>  We see that Phase1 breaks on timeout, although the packets between peers go.  But the size of the incoming packet is much larger, if we analyze via wireshark, we will see that the remote peer uses aggressive mode. </p><br><p><img src="https://habrastorage.org/webt/3g/ke/ii/3gkeiidaj8m-fs0ky7ucxqjxx6k.png"><br>  We see that from us packets are sent to UDP: 500, and come to UDP: 4500 and quite large.  Here the remote peer is on IKEv2 mode. </p></div></div><br><p>  And finally, read the <a href="https://wiki.mikrotik.com/wiki/Manual:IP/IPsec">troubleshooting</a> section <a href="https://wiki.mikrotik.com/wiki/Manual:IP/IPsec">of the wiki</a> .  And all the material about IPSec is desirable for review, I described only the basic set of tools and settings. </p></div><p>Source: <a href="https://habr.com/ru/post/438176/">https://habr.com/ru/post/438176/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>