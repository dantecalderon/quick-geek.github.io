<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Veeam solution for backup and recovery of virtual machines on the Nutanix AHV platform. Part 2</title>
  <meta name="description" content="Greetings to all in the new, 2019 year! 

 First, let's take a look back, that is, the first part of the review of the integrated solution Veeam Avail...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>Veeam solution for backup and recovery of virtual machines on the Nutanix AHV platform. Part 2</h1><div class="post__text post__text-html js-mediator-article">  Greetings to all in the new, 2019 year! <br><br>  First, let's take a look back, that is, the <a href="https://habr.com/ru/company/veeam/blog/434402/">first part of the</a> review of the integrated solution Veeam Availability for Nutanix AHV - there was a story about how to deploy and configure the components.  Now you can proceed to setting up a backup, as well as get acquainted with the recovery options. <br><br>  In today's article I will tell about: <br><br><ul><li>  <a href="https://habr.com/ru/company/veeam/blog/436842/">Backup Repository Access Settings</a> </li><li>  <a href="https://habr.com/ru/company/veeam/blog/436842/">Introduction to the web console solution</a> </li><li>  <a href="https://habr.com/ru/company/veeam/blog/436842/">Backup</a> </li><li>  <a href="https://habr.com/ru/company/veeam/blog/436842/">Data recovery</a> </li><li>  <a href="https://habr.com/ru/company/veeam/blog/436842/">Restrictions of operations</a> </li></ul><br><img src="https://habrastorage.org/webt/wt/o1/wq/wto1wqwxzfd4m67prrc5jtoba9k.png"><br><br>  So, welcome under cat. <br><a name="habracut"></a><br><h1><a name="repo"></a>  We provide access to the repository Veeam Backup </h1><br>  To work with the Veeam backup repository, the user must provide the appropriate permissions.  To do this, you can use <i>security principals</i> - user accounts or Active Directory groups.  Users with access rights can both save backups in the repository, and perform recovery from these backups. <br>  Therefore we do the following: <br><br><ol><li>  In the Veeam Backup &amp; Replication console, open the <b>Backup Infrastructure</b> view. </li><li>  In the <b>Inventory</b> panel (left) click on the <b>Backup Repositories</b> node. </li><li>  In the right pane, right-click on the repository and select <b>Access Permissions</b> from the menu that opens.  (If this command is not available when you try to call it in this way, then try pressing and holding the [CTRL] key when you right-click.) </li><li>  In the <b>Access Permissions</b> dialog, let us indicate who will have access rights to the repository. <br><ul><li>  <b>Allow to everyone</b> - any user can save backups to this repository.  The effect is the same as from the issuance of rights to the <i>Everyone</i> group in Windows ( <i>Anonymous</i> - anonymous users are excluded). </li><li>  <b>Allow to the following accounts or groups only</b> ‚Äî only specified users or groups will have access to the repository.  Click <b>Add</b> and add the necessary accounts. </li></ul><br></li><li>  If you want backups to be protected by encryption while saving to the repository, you can check the <b>Encrypt backups stored on this repository</b> checkbox and specify the type of password. </li></ol><br><img src="https://habrastorage.org/webt/lu/rg/uo/lurguo7lvaghl1ctxsli1bepfcy.png"><br><br>  More information about setting permissions can be found in <a href="https://helpcenter.veeam.com/docs/agentforwindows/userguide/integrate_permissions.html">the documentation section</a> (in English). <br><br><h1><a name="console"></a>  Introduction to the web console solution </h1><br>  After login (see <a href="https://habr.com/ru/company/veeam/blog/434402/">Part 1</a> ) in the web console proxy let's go through the main interface elements. <br><br><h3>  Dashboard Tab </h3><br>  The <b>Dashboard</b> tab shows the status of virtual machines, the status of backup jobs, the status of the repository, the Veeam backup server, and the latest data from the event logs. <br><br><img src="https://habrastorage.org/webt/wt/o1/wq/wto1wqwxzfd4m67prrc5jtoba9k.png"><br><br>  Statistics on protected VM shows the <b>Protection Status</b> widget, which displays: <br><br><ul><li>  The total number of VMs in the Nutanix AHV cluster added to our proxy infrastructure. </li><li>  The number of protected VMs (those that are backed up with Veeam) is green, and black is the number of unprotected VMs (not included in the backup tasks) </li></ul><br>  Statistics on the repository shows the <b>Repository Status</b> widget, which uses the following notation: <br><br><ul><li>  <i>Low on space</i> - runs out of free space. </li><li>  <i>Out of space</i> - no free space </li><li>  <i>Ok</i> - enough space </li></ul><br>  The backup job data shows the <b>Backup Jobs</b> widget: green indicates the number of jobs currently running, black indicates jobs in the ' <i>Idle</i> ' status (‚Äúdoing nothing‚Äù). <br><br>  Server status data Veeam backup shows the <b>Backup Server Status</b> widget. <br><br><h3>  Backup Jobs tab </h3><br>  Here you can manage backup jobs: <br><br><ul><li>  Using the <b>Add</b> command, you can start the wizard to create a new task.  More about him talk a little below. </li><li>  To edit, of course, select the task and click <b>Edit</b> , and to delete - <b>Delete</b> . </li><li>  To start the job, click <b>Start</b> . <br>  <i>Note:</i> If this is the first run, a full backup will be created, and if not the first, an increment will be created. </li><li>  If you need to force a full backup and save it to an existing chain, then click <b>Active Full</b> . </li><li>  You can filter the list of tasks by status (click <b>Status</b> ). </li></ul><br><img src="https://habrastorage.org/webt/1o/wj/sf/1owjsfjih47piod5prmemvilgr4.png"><br><br><h3>  Protected VMs Tab </h3><br>  It displays the virtual machines from the Nutanix AHV cluster, for which there is a backup in the repository.  You can select the desired machine from the list and then restore it by clicking <b>Restore</b> , or restore a virtual disk by clicking <b>Disk Restore</b> . <br><br><img src="https://habrastorage.org/webt/kn/rk/7w/knrk7wtsnlmtwdczlvrs1hdhdri.png"><br><br><h3>  Events tab </h3><br>  Well, the <b>Events</b> tab displays events from the logs.  If you have eliminated the cause of an error, you can select the appropriate entry and click <b>Reslove</b> . <br><br>  Finally, you can learn how to set up VM backup jobs on Nutanix AHV.  So let's get started. <br><br><h1><a name="backup"></a>  Backup job </h1><br>  We will customize it using the wizard: <br><br><ol><li>  In the console of our solution, go to the <b>Backup Jobs</b> tab and click <b>Add</b> in the toolbar. </li><li>  On the step of the <b>General Settings</b> wizard we specify the name and description for the new task. </li><li>  In the <b>Assign VMs</b> step, <b>we</b> select the virtual machines for backup: first, click <b>Add</b> , then in the <b>Add new</b> dialog we check the checkboxes near the necessary VMs.  Click <b>Add</b> again. <br><ul><li>  If you want to add not individual VMs, but the protected domain, then in the dialog you should check out the <b>Dynamic mode</b> checkbox.  Then you need to select a domain and click <b>Add</b> . </li><li>  (optional) To work with the domain to exclude individual VMs from processing, click <b>Exclusions</b> and in the <b>VM name contains</b> field enter the required filter. <br>  <i>Note:</i> You can use the * and? Characters.  Several filters in a row can not be specified. </li></ul><br><br><img src="https://habrastorage.org/webt/2x/_b/7p/2x_b7pqxoospzdb6olfptnboekk.png"><br></li><li>  Click <b>Confirm</b> and go ahead. </li><li>  At the <b>Backup Destination</b> step, we specify the repository where the backups will be saved - we select it from the <b>Backup repository</b> list. <br>  <i>Note:</i> Only repositories added to the backup infrastructure are visible in the list. </li><li>  If necessary, we will additionally indicate how many days to save backups of those VMs that are no longer included in the backup tasks.  To do this, click <b>Advanced</b> , mark the checkmark <b>Remove deleted VMs data after</b> (delete the data of such VM after expiration) and specify how many days you can delete backups.  Click <b>Add</b> again. <br><br><img src="https://habrastorage.org/webt/3_/d8/0c/3_d80cm6fhjxaac5wranef21ykg.png"><br></li><li>  At the <b>Configure Schedule</b> step, we set the schedule for launching the task.  For the launch to be automatic, you need to check the <b>Run the job automatically</b> checkbox.  Next, choose how often to run the task - here everything is similar to Veeam Backup &amp; Replication: daily start, once a month or at a different interval.  We also indicate the number of recovery points that should be stored in the repository.  When this number is exceeded, the oldest point will be deleted. </li><li>  In the <b>Review Summary</b> step, we check the settings.  If necessary, we enable the launch option immediately after the completion of the wizard steps - <b>Run backup job when I click Finish</b> .  Click <b>Finish</b> - the task is ready to go. </li></ol><br>  <i>Useful: The</i> policies and backups created by Veeam Availability for Nutanix AHV are displayed in the Veeam Backup &amp; Replication console.  You can also customize the task of transferring backups and archiving to magnetic tape. <br><br><h1><a name="restore"></a>  Virtual Machine Recovery </h1><br>  During the recovery process, the proxy takes the VM disk data from the backup, copies it to the original datastore, and then registers the restored machine on the node of the Nutanix AHV cluster. <br>  <i>Note:</i> When planning a recovery, you should consider the current limitations (see below). <br><br><h3>  We restore the whole car </h3><br>  For this we need a recovery wizard: <br><ol><li>  Go to the tab <b>Protected VMs</b> and click <b>Restore there</b> .  Then go through the steps of the wizard. </li><li>  At the <b>Virtual Machines</b> step, click <b>Add</b> and select the machine you want to restore.  By default, the process will take the last created restore point.  You can select another point or snapshot - to do this, click on <b>Point</b> , select the one you need from the list, then click <b>OK</b> . <br><br><img src="https://habrastorage.org/webt/cr/fg/y7/crfgy70kt4lpmpjeffyzj2i4que.png"><br><br>  <i>Useful:</i> Recovery from snapshot is faster than from backup.  However, you can recover from snapshot only if the machine has at least one successfully created backup. </li><li>  At the <b>Restore Mode</b> step, select the recovery mode - to the original location or to a new one. <br><br>  <i>Note:</i> If you want to restore the VM to the original cluster, and the original machine still works there, then you will need to confirm whether you intend to replace it with the version from the backup. </li><li>  In the <b>VM name</b> step, you can give a new name to the machine being restored - to do this, click on the <b>Rename VM</b> and enter the new name, optionally adding a prefix or suffix.  And you can leave with the same name. </li><li>  (if you restore it to its original location) in the <b>Select Containe</b> r step, select the container where the VM will be saved - for this, first select the disk, then press the <b>Container</b> button.  Select the desired container and click <b>Add</b> . </li><li>  Then, in the <b>Reason</b> step, you can enter a comment (specify the reason for the recovery, etc.). </li><li>  <b>Finish</b> working with the wizard at the <b>Summary</b> step, checking the settings and clicking the <b>Finish</b> button. </li></ol><br><h3>  Recover VM Disk </h3><br>  For this type of recovery, the same restrictions apply as for VM recovery, and also this: if you want to restore a disk that was marked as bootable in the VM settings, keep in mind that this setting will be reset and you will have to tag it after recovery. <br><br>  The recovery procedure is identical to the one described above: on the <b>Protected VM</b> s tab, click <b>Disk Restore</b> and then go through the wizard steps. <br><br>  You will need to select the machine whose disks you will be restoring, then specify the desired recovery point. <br><br>  Then, at the <b>Disk Mapping</b> step, select the machine to which the recovered disks will be attached.  Here you can change the mapping settings by clicking the <b>Remap disk</b> and specifying the container, connection type and address. <br><br><img src="https://habrastorage.org/webt/za/7x/vs/za7xvswj-qrocaf9ajcspzqkkha.png"><br><br><h3>  Other recovery options </h3><br>  You can use the various recovery options available in the Veeam Backup &amp; Replication console: <br><br><ul><li>  Export to virtual disk format </li><li>  Restore guest OS files </li><li>  Application object recovery </li><li>  Microsoft Azure Cloud Restore </li><li>  Restore to VM on Hyper-V platform </li></ul><br>  For more information about these operations, you can read, for example, <a href="https://helpcenter.veeam.com/evaluation/backup/hyperv/ru/introduction.html">here</a> . <br><br><h1><a name="constrains"></a>  Restrictions of operations </h1><br><h3>  Working with Nutanix AHV Clusters </h3><br><ol><li>  Some of the calls to the Nutanix API may not work due to an AHV 5.5.x API error.  If this happens, then, as a rule, with a large number of simultaneously running backup tasks. <br>  The manufacturer is preparing an update that should deal with this problem. </li><li>  Nutanix CVM Restrictions: <br><ul><li>  Backup for Nutanix CVM is not supported. </li><li>  If you increase the number of tasks being processed in parallel, the backup tasks may fail with an error due to CVM resource constraints, since CVM requires additional resources on each node of the cluster. </li></ul><br></li></ol><br><h3>  Backup </h3><br><ol><li>  Creating backups based on application performance is possible only for those machines that meet the conditions described <a href="https://portal.nutanix.com/">in the documentation</a> .  Otherwise, only a crash-friendly backup will be created. <br>  Note that the proxy does not participate in the processing of the guest OS.  Creating snapshots in view of the work of applications occurs on the side of Nutanix AHV. <br><br>  In addition, Nutanix AHV does not perform data trunking.  For this operation, you can use pre-freeze and post-thaw scripts or use Veeam Agent for Linux or Veeam Agent for Windows.  For them, you can activate the license issued to you (see <a href="https://habr.com/ru/company/veeam/blog/434402/">Part 1</a> ). </li><li>  For machines with NearSync enabled, snapshots will not be created due to the limitations of Nutanix NearSync.  See the <a href="https://portal.nutanix.com/">documentation for</a> details. </li><li> When backing up, an infinite-incremental backup chain will be created for each VM.  If the backup task processes several VMs, then the corresponding backup chains will be stored in the repository, one for each VM. </li><li>  Compression, deduplication, and block size settings are built-in for backup jobs and cannot be changed.  Their meanings are: <br><br><ul><li>  block size - 1 MB; </li><li>  compression method - LZ4; </li><li>  deduplication is enabled. </li></ul><br></li><li>  Fast cloning technology on repositories with the ReFS file system is not supported. </li><li>  Encryption settings on the repository can be set in the Veeam Backup &amp; Replication console. </li><li>  Location settings according to GDPR in backup jobs will not be supported. </li><li>  Also, the health check of backup files will not be performed. </li></ol><br><h3>  Restrictions for protected domains </h3><br><ol><li>  In the backup job settings, you can add only 1 protected domain.  If you need to add multiple domains, create multiple tasks. </li><li>  Inactive protected domains are not displayed in the backup task. </li><li>  If the protected domain was specified as the source for the backup task, then this task will process only VMs from this domain.  Separate volume groups added to such a domain will not be backed up by the backup task. </li></ol><br><h3>  Restrictions for the chain of backups </h3><br><ol><li>  One chain is created for one virtual machine.  If the task includes several VMs, then a separate chain will be created for each VM. </li><li>  Compression and deduplication will always be applied. </li><li>  The chain is infinitely incremental, but you can create an active full backup at any time.  For more information about the methods of building chains, see <a href="https://habr.com/ru/company/veeam/blog/242983/">here</a> . </li></ol><br><h3>  Recovery of virtual machines and disks </h3><br><ol><li>  The current version of the solution does not support recovery from one Nutanix cluster to another. </li><li>  Changing the network settings of the VM during the recovery will not work.  This can be done only after recovery, through the ‚Äúnative‚Äù Prism Element or Prism Central. </li><li>  When attempting to restore from AOS 5.6 to AOS 5.1, the error <i>‚ÄúCannot construct a map key of type com.nutanix.prism.dto.uhura.VmConfigDTO $ VmFeature from String" VGA_CONSOLE "‚Äù occurs</i> because of a known compatibility issue in AHV 5.6. </li><li>  Parallel recovery of multiple VM / disks is not supported. </li><li>  If the source VM has a preferred host (affinity), a situation may arise when this host is not available during recovery (or the original VM was in a different cluster during backup).  In this case, you need to manually configure your preferred host after you restore the VM before you start it. </li></ol><br><h1>  useful links </h1><br><ul><li>  <a href="https://habr.com/ru/company/veeam/blog/434402/">The first part of the review of the solution Veeam Availability for Nutanix AHV</a> </li><li>  <a href="https://helpcenter.veeam.com/docs/van/userguide/">User Guide (in English)</a> </li><li>  <a href="https://helpcenter.veeam.com/evaluation/backup/hyperv/ru/introduction.html">Basic scenarios for using Veeam Backup &amp; Replication (in Russian)</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/436842/">https://habr.com/ru/post/436842/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>