<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Developing a hexapod from scratch (part 3) - Math</title>
  <meta name="description" content="Hello! The development of the hexapod is progressing and finally the basic mathematical part has been tested and is ready for documentation. In order ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>Developing a hexapod from scratch (part 3) - Math</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/webt/ft/93/m5/ft93m5szh_bfaxkmnxialxpkoiu.png"></div><br>  Hello!  The development of the hexapod is progressing and finally the basic mathematical part has been tested and is ready for documentation.  In order for the project to live to the end and not get dusty on the shelf, you need to see its shifts in a positive direction, even if they are minor.  In this article I will talk about the algorithm for solving the inverse problem of kinematics and clearly show it in action.  I hope it will be interesting. <br><a name="habracut"></a><br><h2>  Coordinate systems </h2><br>  For a start, it‚Äôs worth deciding on the coordinate systems of the robot - there are as many as three: <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ep/kk/om/epkkomc-ghrprmw3z1bjpclmh1a.png"></div><br>  In fact, they are no different from each other, but are located in different parts of the body and can be rotated relative to each other at some angle.  When viewed from above, the location of the axes will be as follows (the coxa_zero_rotate parameter will be described a bit later): <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sb/12/jw/sb12jwy030ga17pcg3ojmmgd72i.png"></div><br>  As you may have noticed, the coordinate systems on the left and right sides are located symmetrically relative to the center of the body.  It seemed to me that it would be easier. <br><br>  The coordinates of each point are relative to the limb for which this point is intended.  This approach will allow you to safely move the limb anywhere without interfering with the configuration. <br><br>  And this is how they are located relative to the limb: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ns/go/_j/nsgo_jsxf44m21vb7zzsu23vwqc.png"></div><br>  The coordinates of the target point are relative to the MAIN COORDINATE SYSTEM.  Initially, I wanted to set the coordinates relative to the center of the case, but this was not very convenient and required storing a number of additional parameters. <br><br>  Hereinafter, the designation X *, X **, etc.  will be replaced by X ‚Ä≤, X ‚Ä≤ ‚Ä≤. <br><br><h2>  The solution of the inverse problem of kinematics </h2><br>  Let's start with the most difficult and interesting moment for me - kinematics.  I invented the algorithm myself, sometimes looking at the properties of the triangle and trigonometric functions.  I have a hard time with mechanics, but worse with trigonometry, so maybe I could not take into account something somewhere, but this algorithm works (video at the end). <br><br><h3>  1. Statement of the problem </h3><br>  Suppose we need the front right limb to reach point A with coordinates (150; -20; 100).  It is also known that the limb is rotated 45 degrees relative to the body (parameter coxa_zero_rotate): <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/rx/np/x7/rxnpx7to91tpdvzoltoy7doxess.png"></div><br>  The limb itself has the following parameters: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zr/4w/ky/zr4wkywizwhqwemrdst1yndvyug.png"></div><br>  I think it is not necessary to describe what these parameters mean, the names speak for themselves.  You can only add that all these parameters are determined by the configuration of the case, are permanent and are stored in FLASH memory with the ability to edit from the outside (for flexibility). <br><br><div class="spoiler">  <b class="spoiler_title">That's why it is needed</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/xv/gq/lg/xvgqlgpgv0rtosh2gujqn6kflsy.png"><br>  The picture shows various variations of the hulls and the location of the legs of the hexapod.  It now corresponds to the ARACNID configuration.  Suppose I had a knock on changing the body to REPTILES and for this it would be enough just to change the values ‚Äã‚Äãof the parameters without measurement in the program itself, even the target points will not have to be changed (unless of course you correctly approach this). <br></div></div><br>  All the above parameters are enough to solve the problem. <br><br><h2>  2. Problem solving </h2><br>  <b>2.1 Finding the angle of rotation of COXA</b> <br><br>  This stage is the easiest.  First you need to recalculate the coordinates of point A relative to LIMB COORDINATE SYSTEM.  Obviously, you need to rotate the angle coxa_zero_rotate, you can do this using the following formulas: <br><p><math> </math> $$ display $$ x ‚Ä≤ = x ‚ãÖ cos (Œ±) + z sin (Œ±) = 150 ‚ãÖ cos (45) + 100 sin (45) = 176.78 $$ display $$ </p><br><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math MJXp-display" id="MJXp-Span-45"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-46">y</span><span class="MJXp-mrow" id="MJXp-Span-47"><span class="MJXp-mo" id="MJXp-Span-48" style="margin-left: 0em; margin-right: 0.167em;">‚Ä≤</span></span><span class="MJXp-mo" id="MJXp-Span-49" style="margin-left: 0.333em; margin-right: 0.333em;">=</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-50">y</span><span class="MJXp-mo" id="MJXp-Span-51" style="margin-left: 0.333em; margin-right: 0.333em;">=</span><span class="MJXp-mo" id="MJXp-Span-52" style="margin-left: 0.267em; margin-right: 0.267em;">‚àí</span><span class="MJXp-mn" id="MJXp-Span-53">20</span></span></span><div class="MathJax_SVG_Display MathJax_SVG_Processing"><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span></div><script type="math/tex;mode=display" id="MathJax-Element-2"> y ‚Ä≤ = y = -20 </script></p><br><p><math> </math> $$ display $$ z ‚Ä≤ = -x ‚ãÖ sin (Œ±) + z cos (Œ±) = -150 sin (45) + 100 ‚ãÖ cos (45) = -35.36 $$ display $$ </p><br>  Thus, we obtained the coordinates of the target point A (176.78; -20; -35.36) relative to LIMB COORDINATE SYSTEM. <br><br>  Now you can find the angle COXA using the function atan2: <br><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math MJXp-display" id="MJXp-Span-101"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-102">C</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-103">O</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-104">X</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-105">A</span><span class="MJXp-mo" id="MJXp-Span-106" style="margin-left: 0.333em; margin-right: 0.333em;">=</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-107">a</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-108">t</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-109">a</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-110">n</span><span class="MJXp-mn" id="MJXp-Span-111">2</span><span class="MJXp-mo" id="MJXp-Span-112" style="margin-left: 0em; margin-right: 0em;">(</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-113">z</span><span class="MJXp-mrow" id="MJXp-Span-114"><span class="MJXp-mo" id="MJXp-Span-115" style="margin-left: 0em; margin-right: 0.167em;">‚Ä≤</span></span><span class="MJXp-mo" id="MJXp-Span-116" style="margin-left: 0em; margin-right: 0.222em;">,</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-117">x</span><span class="MJXp-mrow" id="MJXp-Span-118"><span class="MJXp-mo" id="MJXp-Span-119" style="margin-left: 0em; margin-right: 0.167em;">‚Ä≤</span></span><span class="MJXp-mo" id="MJXp-Span-120" style="margin-left: 0em; margin-right: 0em;">)</span><span class="MJXp-mo" id="MJXp-Span-121" style="margin-left: 0.333em; margin-right: 0.333em;">=</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-122">a</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-123">t</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-124">a</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-125">n</span><span class="MJXp-mn" id="MJXp-Span-126">2</span><span class="MJXp-mo" id="MJXp-Span-127" style="margin-left: 0em; margin-right: 0em;">(</span><span class="MJXp-mo" id="MJXp-Span-128" style="margin-left: 0.267em; margin-right: 0.267em;">‚àí</span><span class="MJXp-mn" id="MJXp-Span-129">35.36</span><span class="MJXp-mo" id="MJXp-Span-130" style="margin-left: 0em; margin-right: 0.222em;">,</span><span class="MJXp-mn" id="MJXp-Span-131">176.78</span><span class="MJXp-mo" id="MJXp-Span-132" style="margin-left: 0em; margin-right: 0em;">)</span><span class="MJXp-mo" id="MJXp-Span-133" style="margin-left: 0.333em; margin-right: 0.333em;">=</span><span class="MJXp-mo" id="MJXp-Span-134" style="margin-left: 0.267em; margin-right: 0.267em;">‚àí</span><span class="MJXp-mn" id="MJXp-Span-135">11.30</span><span class="MJXp-mrow" id="MJXp-Span-136"><span class="MJXp-mo" id="MJXp-Span-137" style="margin-left: 0em; margin-right: 0em;">¬∞</span></span></span></span><div class="MathJax_SVG_Display MathJax_SVG_Processing"><span class="MathJax_SVG" id="MathJax-Element-4-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span></div><script type="math/tex;mode=display" id="MathJax-Element-4"> COXA = atan2 (z ‚Ä≤, x ‚Ä≤) = atan2 (-35.36, 176.78) = -11.30 ¬∞ </script></p><br>  And so, we got the angle to which the COXA servo needs to be turned so that point A is in the X‚Ä≤Y ‚Ä≤ plane.  Let's now check our calculations in KOMPAS 3D: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/uz/u0/l1/uzu0l1hk8pu5d06mstriyvqcll4.png"></div><br>  That's right. <br><br>  <b>2.2 Finding the rotation angle of FEMUR and TIBIA</b> <br>  To find these angles, it is necessary to go to the plane X‚Ä≤Y ‚Ä≤.  To go to the plane, you need to rotate the point by the angle COXA, which we have already calculated earlier. <br><p><math> </math> $$ display $$ x ‚Ä≤ = x ‚Ä≤ ‚ãÖ cos (Œ±) + y ‚Ä≤ ‚ãÖ sin (Œ±) = 176.78 cos (-11) + -20 sin (-11) = 180.28 $$ display $$ </p><br><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math MJXp-display" id="MJXp-Span-189"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-190">y</span><span class="MJXp-mrow" id="MJXp-Span-191"><span class="MJXp-mo" id="MJXp-Span-192" style="margin-left: 0em; margin-right: 0.167em;">‚Ä≤</span></span><span class="MJXp-mo" id="MJXp-Span-193" style="margin-left: 0.333em; margin-right: 0.333em;">=</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-194">y</span><span class="MJXp-mo" id="MJXp-Span-195" style="margin-left: 0.333em; margin-right: 0.333em;">=</span><span class="MJXp-mo" id="MJXp-Span-196" style="margin-left: 0.267em; margin-right: 0.267em;">‚àí</span><span class="MJXp-mn" id="MJXp-Span-197">20</span></span></span><div class="MathJax_SVG_Display MathJax_SVG_Processing"><span class="MathJax_SVG" id="MathJax-Element-6-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span></div><script type="math/tex;mode=display" id="MathJax-Element-6"> y ‚Ä≤ = y = -20 </script></p><br>  The coordinate <i>y ‚Ä≤</i> does not change, as we perform the rotation along the axis Y ‚Ä≤. <br><br>  Then you need to remove the length of COXA from the calculation, i.e.  let's move to the X‚Ä≤‚Ä≤Y ‚Ä≤ ‚Ä≤ plane, to do this, we shift the <i>x-</i> coordinate of the point by the length of COXA: <br><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math MJXp-display" id="MJXp-Span-198"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-199">x</span><span class="MJXp-mrow" id="MJXp-Span-200"><span class="MJXp-mo" id="MJXp-Span-201" style="margin-left: 0em; margin-right: 0.167em;">‚Ä≤</span></span><span class="MJXp-mrow" id="MJXp-Span-202"><span class="MJXp-mo" id="MJXp-Span-203" style="margin-left: 0em; margin-right: 0.167em;">‚Ä≤</span></span><span class="MJXp-mo" id="MJXp-Span-204" style="margin-left: 0.333em; margin-right: 0.333em;">=</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-205">x</span><span class="MJXp-mrow" id="MJXp-Span-206"><span class="MJXp-mo" id="MJXp-Span-207" style="margin-left: 0em; margin-right: 0.167em;">‚Ä≤</span></span><span class="MJXp-mo" id="MJXp-Span-208" style="margin-left: 0.267em; margin-right: 0.267em;">‚àí</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-209">c</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-210">o</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-211">x</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-212">a</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-213">L</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-214">e</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-215">n</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-216">g</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-217">t</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-218">h</span><span class="MJXp-mo" id="MJXp-Span-219" style="margin-left: 0.333em; margin-right: 0.333em;">=</span><span class="MJXp-mn" id="MJXp-Span-220">180.28</span><span class="MJXp-mo" id="MJXp-Span-221" style="margin-left: 0.267em; margin-right: 0.267em;">‚àí</span><span class="MJXp-mn" id="MJXp-Span-222">40</span><span class="MJXp-mo" id="MJXp-Span-223" style="margin-left: 0.333em; margin-right: 0.333em;">=</span><span class="MJXp-mn" id="MJXp-Span-224">140.28</span></span></span><div class="MathJax_SVG_Display MathJax_SVG_Processing"><span class="MathJax_SVG" id="MathJax-Element-7-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span></div><script type="math/tex;mode=display" id="MathJax-Element-7"> x ‚Ä≤ ‚Ä≤ = x ‚Ä≤ - coxaLength = 180.28 - 40 = 140.28 </script></p><br><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math MJXp-display" id="MJXp-Span-225"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-226">y</span><span class="MJXp-mrow" id="MJXp-Span-227"><span class="MJXp-mo" id="MJXp-Span-228" style="margin-left: 0em; margin-right: 0.167em;">‚Ä≤</span></span><span class="MJXp-mrow" id="MJXp-Span-229"><span class="MJXp-mo" id="MJXp-Span-230" style="margin-left: 0em; margin-right: 0.167em;">‚Ä≤</span></span><span class="MJXp-mo" id="MJXp-Span-231" style="margin-left: 0.333em; margin-right: 0.333em;">=</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-232">y</span><span class="MJXp-mrow" id="MJXp-Span-233"><span class="MJXp-mo" id="MJXp-Span-234" style="margin-left: 0em; margin-right: 0.167em;">‚Ä≤</span></span></span></span><div class="MathJax_SVG_Display MathJax_SVG_Processing"><span class="MathJax_SVG" id="MathJax-Element-8-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span></div><script type="math/tex;mode=display" id="MathJax-Element-8"> y ‚Ä≤ ‚Ä≤ = y ‚Ä≤ </script></p><br>  After all these manipulations, the further solution of the problem is reduced to finding the angles <i>a</i> and <i>b of the</i> triangle: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/mu/jf/gz/mujfgzm73qouo2q9vnjgn2qgeei.png"></div><br>  Before finding the angles, you must find the third side C of this triangle.  This distance is nothing more than the length of the vector and is calculated by the formula: <br><p><math> </math> $$ display $$ C = \ sqrt {x ‚Ä≤ ‚Ä≤ ^ 2 + y ‚Ä≤ ‚Ä≤ ^ 2} = \ sqrt {140.28 ^ 2 + (-20) ^ 2} = 141.70 $$ display $$ </p><br>  Now you need to check whether the limb can reach this point.  If C is greater than the sum of the lengths of FEMUR and TIBIA, then the point is not attainable.  In our case, 141.70 &lt;141 + 85 - the point is reachable. <br><br>  Now we know all sides of the triangle and we can find the angles <i>a</i> and <i>b</i> we need using the cosine theorem: <br><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math MJXp-display" id="MJXp-Span-268"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-269">a</span><span class="MJXp-mo" id="MJXp-Span-270" style="margin-left: 0.333em; margin-right: 0.333em;">=</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-271">a</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-272">c</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-273">o</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-274">s</span><span class="MJXp-mo" id="MJXp-Span-275" style="margin-left: 0em; margin-right: 0em;">(</span><span class="MJXp-mrow" id="MJXp-Span-276"><span class="MJXp-msubsup" id="MJXp-Span-277"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-278" style="margin-right: 0.05em;">A</span><span class="MJXp-mn MJXp-script" id="MJXp-Span-279" style="vertical-align: 0.5em;">2</span></span><span class="MJXp-mo" id="MJXp-Span-280" style="margin-left: 0.267em; margin-right: 0.267em;">+</span><span class="MJXp-msubsup" id="MJXp-Span-281"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-282" style="margin-right: 0.05em;">C</span><span class="MJXp-mn MJXp-script" id="MJXp-Span-283" style="vertical-align: 0.5em;">2</span></span><span class="MJXp-mo" id="MJXp-Span-284" style="margin-left: 0.267em; margin-right: 0.267em;">‚àí</span><span class="MJXp-msubsup" id="MJXp-Span-285"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-286" style="margin-right: 0.05em;">B</span><span class="MJXp-mn MJXp-script" id="MJXp-Span-287" style="vertical-align: 0.5em;">2</span></span><span class="MJXp-mtext" id="MJXp-Span-288">&nbsp;</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-289">o</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-290">v</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-291">e</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-292">r</span><span class="MJXp-mn" id="MJXp-Span-293">2</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-294">A</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-295">C</span></span><span class="MJXp-mo" id="MJXp-Span-296" style="margin-left: 0em; margin-right: 0em;">)</span><span class="MJXp-mo" id="MJXp-Span-297" style="margin-left: 0.333em; margin-right: 0.333em;">=</span><span class="MJXp-mn" id="MJXp-Span-298">72.05</span><span class="MJXp-mrow" id="MJXp-Span-299"><span class="MJXp-mo" id="MJXp-Span-300" style="margin-left: 0em; margin-right: 0em;">¬∞</span></span></span></span><div class="MathJax_SVG_Display MathJax_SVG_Processing"><span class="MathJax_SVG" id="MathJax-Element-10-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span></div><script type="math/tex;mode=display" id="MathJax-Element-10"> a = acos ({A ^ 2 + C ^ 2 - B ^ 2 \ over 2AC}) = 72.05 ¬∞ </script></p><br><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math MJXp-display" id="MJXp-Span-301"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-302">b</span><span class="MJXp-mo" id="MJXp-Span-303" style="margin-left: 0.333em; margin-right: 0.333em;">=</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-304">a</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-305">c</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-306">o</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-307">s</span><span class="MJXp-mo" id="MJXp-Span-308" style="margin-left: 0em; margin-right: 0em;">(</span><span class="MJXp-mrow" id="MJXp-Span-309"><span class="MJXp-msubsup" id="MJXp-Span-310"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-311" style="margin-right: 0.05em;">B</span><span class="MJXp-mn MJXp-script" id="MJXp-Span-312" style="vertical-align: 0.5em;">2</span></span><span class="MJXp-mo" id="MJXp-Span-313" style="margin-left: 0.267em; margin-right: 0.267em;">+</span><span class="MJXp-msubsup" id="MJXp-Span-314"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-315" style="margin-right: 0.05em;">A</span><span class="MJXp-mn MJXp-script" id="MJXp-Span-316" style="vertical-align: 0.5em;">2</span></span><span class="MJXp-mo" id="MJXp-Span-317" style="margin-left: 0.267em; margin-right: 0.267em;">‚àí</span><span class="MJXp-msubsup" id="MJXp-Span-318"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-319" style="margin-right: 0.05em;">C</span><span class="MJXp-mn MJXp-script" id="MJXp-Span-320" style="vertical-align: 0.5em;">2</span></span><span class="MJXp-mtext" id="MJXp-Span-321">&nbsp;</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-322">o</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-323">v</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-324">e</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-325">r</span><span class="MJXp-mn" id="MJXp-Span-326">2</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-327">B</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-328">A</span></span><span class="MJXp-mo" id="MJXp-Span-329" style="margin-left: 0em; margin-right: 0em;">)</span><span class="MJXp-mo" id="MJXp-Span-330" style="margin-left: 0.333em; margin-right: 0.333em;">=</span><span class="MJXp-mn" id="MJXp-Span-331">72.95</span><span class="MJXp-mrow" id="MJXp-Span-332"><span class="MJXp-mo" id="MJXp-Span-333" style="margin-left: 0em; margin-right: 0em;">¬∞</span></span></span></span><div class="MathJax_SVG_Display MathJax_SVG_Processing"><span class="MathJax_SVG" id="MathJax-Element-11-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span></div><script type="math/tex;mode=display" id="MathJax-Element-11"> b = acos ({B ^ 2 + A ^ 2 - C ^ 2 \ over 2BA}) = 72.95 ¬∞ </script></p><br>  The angles obtained are not applicable for feeding them to servo drives, since the initial position and the angle of inclination of the straight line C to the X axis are not taken into account here. known.  You can find it using the function atan2 (y ‚Ä≤ ‚Ä≤, x ‚Ä≤ ‚Ä≤): <br><p><math> </math> $$ display $$ œÜ = atan2 (y ‚Ä≤ ‚Ä≤, x ‚Ä≤ ‚Ä≤) = atan2 (-20, 140.28) = -8.11 ¬∞ $$ display $$ </p><br>  Finally, we can calculate the angle of rotation of the FEMUR and TIBIA servos: <br><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math MJXp-display" id="MJXp-Span-373"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-374">F</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-375">E</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-376">M</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-377">U</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-378">R</span><span class="MJXp-mo" id="MJXp-Span-379" style="margin-left: 0.333em; margin-right: 0.333em;">=</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-380">f</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-381">e</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-382">m</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-383">u</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-384">r</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-385">Z</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-386">e</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-387">r</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-388">o</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-389">R</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-390">o</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-391">t</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-392">a</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-393">t</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-394">e</span><span class="MJXp-mo" id="MJXp-Span-395" style="margin-left: 0.267em; margin-right: 0.267em;">‚àí</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-396">a</span><span class="MJXp-mo" id="MJXp-Span-397" style="margin-left: 0.267em; margin-right: 0.267em;">‚àí</span><span class="MJXp-mrow" id="MJXp-Span-398"><span class="MJXp-mo" id="MJXp-Span-399" style="margin-left: 0em; margin-right: 0em;">œÜ</span></span><span class="MJXp-mo" id="MJXp-Span-400" style="margin-left: 0.333em; margin-right: 0.333em;">=</span><span class="MJXp-mn" id="MJXp-Span-401">135</span><span class="MJXp-mo" id="MJXp-Span-402" style="margin-left: 0.267em; margin-right: 0.267em;">‚àí</span><span class="MJXp-mn" id="MJXp-Span-403">72.05</span><span class="MJXp-mo" id="MJXp-Span-404" style="margin-left: 0.267em; margin-right: 0.267em;">+</span><span class="MJXp-mn" id="MJXp-Span-405">8.11</span><span class="MJXp-mo" id="MJXp-Span-406" style="margin-left: 0.333em; margin-right: 0.333em;">=</span><span class="MJXp-mn" id="MJXp-Span-407">71.06</span><span class="MJXp-mrow" id="MJXp-Span-408"><span class="MJXp-mo" id="MJXp-Span-409" style="margin-left: 0em; margin-right: 0em;">¬∞</span></span></span></span><div class="MathJax_SVG_Display MathJax_SVG_Processing"><span class="MathJax_SVG" id="MathJax-Element-13-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span></div><script type="math/tex;mode=display" id="MathJax-Element-13"> FEMUR = femurZeroRotate - a - œÜ = 135 - 72.05 + 8.11 = 71.06 ¬∞ </script></p><br><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math MJXp-display" id="MJXp-Span-410"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-411">F</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-412">E</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-413">M</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-414">U</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-415">R</span><span class="MJXp-mo" id="MJXp-Span-416" style="margin-left: 0.333em; margin-right: 0.333em;">=</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-417">b</span><span class="MJXp-mo" id="MJXp-Span-418" style="margin-left: 0.267em; margin-right: 0.267em;">‚àí</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-419">t</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-420">i</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-421">b</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-422">i</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-423">a</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-424">Z</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-425">e</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-426">r</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-427">o</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-428">R</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-429">o</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-430">t</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-431">a</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-432">t</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-433">e</span><span class="MJXp-mo" id="MJXp-Span-434" style="margin-left: 0.333em; margin-right: 0.333em;">=</span><span class="MJXp-mn" id="MJXp-Span-435">45</span><span class="MJXp-mo" id="MJXp-Span-436" style="margin-left: 0.267em; margin-right: 0.267em;">‚àí</span><span class="MJXp-mn" id="MJXp-Span-437">72.95</span><span class="MJXp-mo" id="MJXp-Span-438" style="margin-left: 0.333em; margin-right: 0.333em;">=</span><span class="MJXp-mn" id="MJXp-Span-439">27.95</span><span class="MJXp-mrow" id="MJXp-Span-440"><span class="MJXp-mo" id="MJXp-Span-441" style="margin-left: 0em; margin-right: 0em;">¬∞</span></span></span></span><div class="MathJax_SVG_Display MathJax_SVG_Processing"><span class="MathJax_SVG" id="MathJax-Element-14-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span></div><script type="math/tex;mode=display" id="MathJax-Element-14"> FEMUR = b - tibiaZeroRotate = 45 - 72.95 = 27.95 ¬∞ </script></p><br><br>  Let's check our calculations: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/y0/9g/pd/y09gpdnkxfecblnzpf2ssfmxti8.png"></div><br>  It seems to be true. <br><br><h2>  Total </h2><br>  The calculated angles of COXA, FEMUR and TIBIA are suitable for feeding them to servos.  You may notice that the angle of COXA is negative and, accordingly, the question arises: "How to turn the drive by -11.3 degrees?".  The trick is that I use the neutral position of the COXA servo as a logical zero, this allows the drive to be rotated both at positive angles and negative.  This is of course obvious, but I think it would not be superfluous to mention this.  I will tell about it in more detail in the following articles, when I will talk about the implementation of all the above mentioned. <br><br><h2>  Sources </h2><br><div class="spoiler">  <b class="spoiler_title">Enough words, let me see the code</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> RAD_TO_DEG(rad) ((rad) * 180.0 / M_PI) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> DEG_TO_RAD(deg) ((deg) * M_PI / 180.0) typedef enum { LINK_COXA, LINK_FEMUR, LINK_TIBIA } link_id_t; typedef struct { </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// Current link state float angle; // Link configuration uint32_t length; int32_t zero_rotate; int32_t min_angle; int32_t max_angle; } link_info_t; typedef struct { point_3d_t position; path_3d_t movement_path; link_info_t links[3]; } limb_info_t; // *************************************************************************** /// @brief Calculate angles /// @param info: limb info @ref limb_info_t /// @return true - calculation success, false - no // *************************************************************************** static bool kinematic_calculate_angles(limb_info_t* info) { int32_t coxa_zero_rotate_deg = info-&gt;links[LINK_COXA].zero_rotate; int32_t femur_zero_rotate_deg = info-&gt;links[LINK_FEMUR].zero_rotate; int32_t tibia_zero_rotate_deg = info-&gt;links[LINK_TIBIA].zero_rotate; uint32_t coxa_length = info-&gt;links[LINK_COXA].length; uint32_t femur_length = info-&gt;links[LINK_FEMUR].length; uint32_t tibia_length = info-&gt;links[LINK_TIBIA].length; float x = info-&gt;position.x; float y = info-&gt;position.y; float z = info-&gt;position.z; // Move to (X*, Y*, Z*) coordinate system - rotate float coxa_zero_rotate_rad = DEG_TO_RAD(coxa_zero_rotate_deg); float x1 = x * cos(coxa_zero_rotate_rad) + z * sin(coxa_zero_rotate_rad); float y1 = y; float z1 = -x * sin(coxa_zero_rotate_rad) + z * cos(coxa_zero_rotate_rad); // // Calculate COXA angle // float coxa_angle_rad = atan2(z1, x1); info-&gt;links[LINK_COXA].angle = RAD_TO_DEG(coxa_angle_rad); // // Prepare for calculation FEMUR and TIBIA angles // // Move to (X*, Y*) coordinate system (rotate on axis Y) x1 = x1 * cos(coxa_angle_rad) + z1 * sin(coxa_angle_rad); // Move to (X**, Y**) coordinate system (remove coxa from calculations) x1 = x1 - coxa_length; // Calculate angle between axis X and destination point float fi = atan2(y1, x1); // Calculate distance to destination point float d = sqrt(x1 * x1 + y1 * y1); if (d &gt; femur_length + tibia_length) { return false; // Point not attainable } // // Calculate triangle angles // float a = tibia_length; float b = femur_length; float c = d; float alpha = acos( (b * b + c * c - a * a) / (2 * b * c) ); float gamma = acos( (a * a + b * b - c * c) / (2 * a * b) ); // // Calculate FEMUR and TIBIA angle // info-&gt;links[LINK_FEMUR].angle = femur_zero_rotate_deg - RAD_TO_DEG(alpha) - RAD_TO_DEG(fi); info-&gt;links[LINK_TIBIA].angle = RAD_TO_DEG(gamma) - tibia_zero_rotate_deg; // // Check angles // if (info-&gt;links[LINK_COXA].angle &lt; info-&gt;links[LINK_COXA].min_angle || info-&gt;links[LINK_COXA].angle &gt; info-&gt;links[LINK_COXA].max_angle) { return false; } if (info-&gt;links[LINK_FEMUR].angle &lt; info-&gt;links[LINK_FEMUR].min_angle || info-&gt;links[LINK_FEMUR].angle &gt; info-&gt;links[LINK_FEMUR].max_angle) { return false; } if (info-&gt;links[LINK_TIBIA].angle &lt; info-&gt;links[LINK_TIBIA].min_angle || info-&gt;links[LINK_TIBIA].angle &gt; info-&gt;links[LINK_TIBIA].max_angle) { return false; } return true; }</span></span></span></span></code> </pre> <br></div></div><br><h2>  Algorithm in action </h2><br><iframe width="560" height="315" src="https://www.youtube.com/embed/LzmEDeKPMTA" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  It was a random sequence that resembled a dance. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/jmxpjjCkGQE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h2>  PS </h2><br>  I would be glad if someone could simplify this algorithm.  I did it so as to understand it later, say, half a year. </div><p>Source: <a href="https://habr.com/ru/post/436748/">https://habr.com/ru/post/436748/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>