<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>For those who want to play detective: find a bug in the function from Midnight Commander</title>
  <meta name="description" content="We invite you to try to find a bug in a very simple function from the GNU Midnight Commander project. What for? Just. It is fun and interesting. No, w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-6974184241884155",
      enable_page_level_ads: true
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>For those who want to play detective: find a bug in the function from Midnight Commander</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/getpro/habr/post_images/687/3a6/927/6873a6927bd61a58aa2d2a53b7a31df6.png" alt="Find a mistake!"></p><br>  We invite you to try to find a bug in a very simple function from the GNU Midnight Commander project.  What for?  Just.  It is fun and interesting.  No, we lied.  Once again we want to demonstrate an error that a person hardly finds in the process of code review, but easily finds the PVS-Studio static code analyzer. <br><a name="habracut"></a><br>  Recently we were sent a letter asking where the analyzer issues a warning to the <i>EatWhitespace</i> function, the code of which is given below.  In fact, the question is not so simple.  Try it yourself to guess what is wrong with this code. <br><br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EatWhitespace</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(FILE * InFile)</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">/* ----------------------------------------------------------------------- ** * Scan past whitespace (see ctype(3C)) and return the first non-whitespace * character, or newline, or EOF. * * Input: InFile - Input source. * * Output: The next non-whitespace character in the input stream. * * Notes: Because the config files use a line-oriented grammar, we * explicitly exclude the newline character from the list of * whitespace characters. * - Note that both EOF (-1) and the nul character ('\0') are * considered end-of-file markers. * * ----------------------------------------------------------------------- ** */</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (c = getc (InFile); <span class="hljs-built_in"><span class="hljs-built_in">isspace</span></span> (c) &amp;&amp; (<span class="hljs-string"><span class="hljs-string">'\n'</span></span> != c); c = getc (InFile)) ; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (c); } <span class="hljs-comment"><span class="hljs-comment">/* EatWhitespace */</span></span></code> </pre> <br>  As you can see, the <i>EatWhitespace</i> function <i>is</i> quite small.  Even a comment on a function takes up more space than the body of the function itself :).  Now for some details. <br><br>  Description of the <i>getc</i> function: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getc</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( FILE * stream )</span></span></span></span>;</code> </pre> <br>  The function returns the character pointed to by the internal file position indicator of the specified stream.  The indicator then moves to the next character.  If the end of the file is reached at the time the stream is called, the function returns the <a href="http://www.cplusplus.com/EOF">EOF</a> value and sets the end-of-file indicator for the stream.  If a read error occurs, the function returns the value EOF and sets the error indicator for the stream (ferror). <br><br>  Description of the <i>isspace</i> function: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isspace</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ch )</span></span></span></span>;</code> </pre> <br>  The function checks whether the character is whitespace by the classification of the current locale.  In standard locale, the following characters are whitespace: <br><br><ul><li>  space (0x20, ''); </li><li>  page change (0x0c, '\ f'); </li><li>  line feed LF (0x0a, '\ n'); </li><li>  CR carriage return (0x0d, '\ r'); </li><li>  horizontal tab (0x09, '\ t'); </li><li>  vertical tab (0x0b, '\ v'). </li></ul><br>  <b>Return value</b>  Non-zero if the character is whitespace, zero otherwise. <br><br>  The <i>EatWhitespace</i> function should skip all characters that are considered whitespace, except for the line feed '\ n'.  Another reason to stop reading from a file can be to achieve the end of the file (EOF). <br><br>  And now, knowing all this, try to find a mistake! <br><br>  To prevent the reader from looking at the answer at once by chance, add a couple of waiting unicorns. <br><br><p><img src="https://habrastorage.org/getpro/habr/post_images/58d/139/130/58d1391306fa2c02969581281747e5fb.png" alt="Figure 1. Time to look for a mistake. Unicorns will wait."></p><br>  <font color="#999999"><i>Figure 1. Time to look for a mistake.</i></font>  <font color="#999999"><i>Unicorns will wait.</i></font> <br><br>  Don't you see the error anyway? <br><br>  The fact is that we have deceived readers about <i>isspace</i> .  Haha  This is not a standard function at all, but a self-made macro.  Yes, we - byaki and made you confused. <br><br><p><img src="https://habrastorage.org/getpro/habr/post_images/011/c8b/5cf/011c8b5cfed117704c596889c41f7e46.png" alt="Figure 2. Unicorn gives readers a false idea of ‚Äã‚Äãwhat isspace."></p><br>  <font color="#999999"><i>Figure 2. Unicorn gives readers a false idea of ‚Äã‚Äãwhat <i>isspace</i> .</i></font> <br><br>  In fact, of course, it is not us or our unicorn that is to blame.  Confusion was made by the authors of the GNU Midnight Commander project, deciding to create their own <i>isspace</i> implementation in the <i>charset.h</i> file: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> isspace #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">undef</span></span></span><span class="hljs-meta"> isspace #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> .... #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> isspace(c) ((c)==</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">' '</span></span></span><span class="hljs-meta"> || (c) == </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'\t'</span></span></span><span class="hljs-meta">)</span></span></code> </pre> <br>  By creating such a macro, some developers have confused other developers.  The code is written on the assumption that <i>isspace</i> is a standard function that considers carriage return (0x0d, '\ r') as one of the whitespace. <br><br>  The implemented macro considers only spaces and tabs as whitespace characters.  Let's substitute the macro and see what happens. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (c = getc (InFile); ((c)==<span class="hljs-string"><span class="hljs-string">' '</span></span> || (c) == <span class="hljs-string"><span class="hljs-string">'\t'</span></span>) &amp;&amp; (<span class="hljs-string"><span class="hljs-string">'\n'</span></span> != c); c = getc (InFile))</code> </pre> <br>  The subexpression ('\ n'! = C) is redundant (redundant), since its result will always be true.  The PVS-Studio analyzer warns about this, issuing a warning: <br><br>  <a href="https://www.viva64.com/ru/w/v560/">V560</a> A part of the conditional expression is always true: ('\ n'! = C).  params.c 136. <br><br>  For complete clarity, let's look at 3 scenarios: <br><br><ul><li>  Reached end of file.  End of file (EOF) is not a space or tab.  The subexpression ('\ n'! = C) is not evaluated due to <a href="https://en.wikipedia.org/wiki/Short-circuit_evaluation">short circuit evaluation</a> .  The cycle stops. </li><li>  Read any character that is not a space or tab.  The subexpression ('\ n'! = C) is not evaluated due to the short circuit evaluation.  The cycle stops. </li><li>  Read space character or horizontal tab.  The subexpression ('\ n'! = C) is calculated, but its result will always be true. </li></ul><br>  In other words, the code considered is equivalent to this: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (c = getc (InFile); c==<span class="hljs-string"><span class="hljs-string">' '</span></span> || c == <span class="hljs-string"><span class="hljs-string">'\t'</span></span>; c = getc (InFile))</code> </pre> <br>  We found out that the code does not work as intended.  Let's now figure out what the consequences are. <br><br>  The programmer, who wrote the <i>isspace</i> call in the body of the <i>EatWhitespace</i> function, expected that the standard function would be called.  That is why he added the condition that the translation of the string LF ('\ n') should not be considered a space character. <br><br>  Consequently, the programmer planned that in addition to the space and horizontal tab, such characters as page change and vertical tab would be omitted. <br><br>  Notably, it was planned to skip the carriage return symbol CR (0x0d, '\ r').  This does not happen and the cycle will stop when it encounters this symbol.  This will lead to unpleasant surprises if the string separator in the file is a CR + LF sequence used in some non-UNIX systems, such as Microsoft Windows. <br><br>  For those who want to learn more about the historical reasons for using LF or CR + LF as line delimiters, we offer you the article on Wikipedia " <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D0%25B5%25D1%2580%25D0%25B5%25D0%25B2%25D0%25BE%25D0%25B4_%25D1%2581%25D1%2582%25D1%2580%25D0%25BE%25D0%25BA%25D0%25B8">Line feed</a> ". <br><br>  The <i>EatWhitespace</i> function is <i>supposed</i> to process files in the same way, where both LF and CR + LF are used as separators.  For the case of CR + LF, this is not the case.  In other words, if your file came from the world of Windows, then you are not lucky :). <br><br>  Perhaps this is not a serious mistake, especially since the GNU Midnight Commander is common in UNIX-like operating systems, where the LF character (0x0a, '\ n') is used for line breaks.  However, because of such trifles, there are various annoying problems of incompatibility of data prepared in Linux and Windows systems. <br><br>  The described error is interesting because it is almost impossible to detect with a classic code review.  Not all project developers can know about the subtleties of the macro, and forget them very easily.  This is a good example when static code analysis complements code reviews and other error-checking techniques. <br><br>  Redefining standard functions is a bad practice.  By the way, recently in the article " <a href="https://www.viva64.com/ru/b/0535/">Love static code analysis</a> " a similar case was considered with the <i>#define sprintf std :: printf</i> macro. <br><br>  A better solution would be to give the macro a unique name, for example, <i>is_space_or_tab</i> .  Then confusion would be impossible. <br><br>  Perhaps the reason for creating the macro was the slow work of the standard <i>isspace</i> function and the programmer created its faster version, sufficient to solve all the necessary tasks.  But still this decision is wrong.  It would be <i>safer</i> to define <i>isspace</i> so that non-compiled code is obtained.  And the necessary functionality is implemented in a macro with a unique name. <br><br>  Thanks for attention.  We invite you to <a href="https://www.viva64.com/ru/pvs-studio-download/">download</a> and try the PVS-Studio analyzer to test your projects.  Plus, we remind you that the Java language support has recently appeared in the analyzer. <br><br><p> <a href="https://habr.com/ru/company/pvs-studio/blog/439372/"><img src="https://habrastorage.org/webt/ts/z9/km/tsz9kmyjtteajhd4x1au60rsrvq.png" align="left"></a> </p><br><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Andrey Karpov.  <a href="https://habr.com/ru/company/pvs-studio/blog/439372/">Wanna Play a Detective?</a>  <a href="https://habr.com/ru/company/pvs-studio/blog/439372/">Find the Bug in a Function from Midnight Commander</a> . </div><p>Source: <a href="https://habr.com/ru/post/439374/">https://habr.com/ru/post/439374/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>