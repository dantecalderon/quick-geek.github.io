<div class="post__text post__text-html js-mediator-article">  <b>Introduction</b> <br><br>  When working with distributed system controllers, it is often necessary to reboot controllers.  Using the Arduino IDE console to restart the customer is not very convenient, because for each type of controller you need to configure (or check) the type of board and COM port numbers, this work should be done by personnel familiar with the IDE, and not every customer wants to know that the system is built on Arduino controllers. <br><br>  This paper discusses options for loading controllers (Arduino on Atmega328 and Atmega32u4 and a compatible Teensy controller) by separate commands and through a batch file, without using the IDE. <br><a name="habracut"></a><br>  <b>Organization of USB COM communications Arduino boards</b> <br><br>  By organizing the serial communication channel, the Arduino boards can be divided into boards with a USB-UART converter and motherboards with microcontrollers that support USB communication without external converters.  The first are Arduino UNO, Arduino NANO, Arduino Mini, Arduino UNO Ethernet, Arduino UNO WiFi based on <b>Atmega328</b> microcontrollers.  To the second - Arduino Leonardo, Arduino Micro, Arduino Yun Mini, Arduino Industrial 101, Arduino Leonardo Ethernet boards with <b>Atmega32u4</b> controllers [1]. <br><br>  <b>Download of Arduino controller (Atmega328) with avrdude.exe</b> <br><br>  You can download the <b>hex</b> file to the Arduino controller using the <b>avrdude.exe</b> program.  This program is part of the IDE console package, for example, Arduino version 1.8.5.  The avrdude.exe loader is started by the <b>cmd</b> or <b>Command Prompt</b> utility, which starts as shown in Figure 1. <br><br><img src="https://habrastorage.org/webt/wl/ss/2z/wlss2zwbdi6n07hyhpnq0dil3cs.png"><br>  <i><b>Figure 1</b> .</i>  <i>An example of running the Command Prompt utility.</i> <br><br>  To get a sample of writing the command to download the <b>hex</b> code to the Arduino controller on your computer, perform the following sequence. <br><br>  • Connect Arduino <br>  • Download the Arduino IDE <br>  • Select Arduino board type from menu&gt; Tools&gt; Board&gt; <br>  • Select board COM port from menu&gt; Tools&gt; Port&gt; <br>  • Select the upload checkbox in the Preferences tab: menu Arduino IDE&gt; File&gt; Preferences&gt; Show verbose output during&gt; upload <br>  • Launch menu&gt; Sketch&gt; Upload <br>  • After the download is complete, in the Arduino IDE console output window, find the command from <b>avrdude</b> , it looks like this: <br><br><pre><code class="dos hljs"><span class="hljs-function"><span class="hljs-function">C:\</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Program</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Files</span></span></span><span class="hljs-function"> (</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x86</span></span></span><span class="hljs-function">)\</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Arduino</span></span></span><span class="hljs-function">\</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hardware</span></span></span><span class="hljs-function">\</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tools</span></span></span><span class="hljs-function">\</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">avr</span></span></span><span class="hljs-function">/</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bin</span></span></span><span class="hljs-function">/</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">avrdude</span></span></span><span class="hljs-function"> -</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CC</span></span></span><span class="hljs-function">:\</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Program</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Files</span></span></span><span class="hljs-function"> (</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x86</span></span></span><span class="hljs-function">)\</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Arduino</span></span></span><span class="hljs-function">\</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hardware</span></span></span><span class="hljs-function">\</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tools</span></span></span><span class="hljs-function">\</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">avr</span></span></span><span class="hljs-function">/</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">etc</span></span></span><span class="hljs-function">/</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">avrdude.conf</span></span></span><span class="hljs-function"> -</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">v</span></span></span><span class="hljs-function"> -</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">patmega328p</span></span></span><span class="hljs-function"> -</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">carduino</span></span></span><span class="hljs-function"> -</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PCOM3</span></span></span><span class="hljs-function"> -</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b115200</span></span></span><span class="hljs-function"> -</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">D</span></span></span><span class="hljs-function"> -</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Uflash:w</span></span></span><span class="hljs-function">:</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">C</span></span></span><span class="hljs-function">:\</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Users</span></span></span><span class="hljs-function">\</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">user</span></span></span><span class="hljs-function">-2\</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AppData</span></span></span><span class="hljs-function">\</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Local</span></span></span><span class="hljs-function">\</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Temp</span></span></span><span class="hljs-function">\</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">arduino_build_628118</span></span></span><span class="hljs-function">/</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Blink.ino.hex:i</span></span></span></span></code> </pre> <br>  To run the <b>avrdude command</b> using the Command Prompt utility, you must enter double quotes in the command, as shown below. <br><br><pre> <code class="dos hljs">"C:\Program Files (x86)\Arduino\hardware\tools\avr/bin/&lt;b&gt;avrdude&lt;/b&gt;" -"CC:\Program Files (x86)\Arduino\hardware\tools\avr/etc/avrdude.conf" -v -patmega328p -carduino -PCOM3 -b115200 -D -Uflash:w:C:\Users\user-<span class="hljs-number"><span class="hljs-number">2</span></span>\AppData\Local\Temp\arduino_build_628118/Blink.ino.hex:i</code> </pre> <br>  This command can be used to load <b>hex</b> programs into an Arduino controller with an Atmega328 chip and a separate USB to UART converter.  For controllers with Atmega32u4 that support USB communication without a hardware converter, additional steps are required to execute the command, which are described below in the corresponding section. <br><br>  Since the compiled program - the hex file is stored in the temporary files folder while the IDE console is open (.. \ AppData \ Local \ Temp \ ..), it is better to copy the hex file to a separate folder, copy the avrdude.exe loader and the avrdude.conf file as well . <br><br>  After moving files (Figure 2), for example, in the C: \ ArdIDE folder, the download command with the updated file access paths takes on the form shown in Figure 3. <br><br><img src="https://habrastorage.org/webt/3y/a9/qu/3ya9quyk39sfe7b4wrimctn1oj4.png" alt="image"><br>  <i><b>Figure 2</b> .</i>  <i>Placing loader files and hex files in a separate folder.</i> <br><br><img src="https://habrastorage.org/webt/db/z8/o4/dbz8o4hd_gxxctq5eylpqfy5fpi.png" alt="image"><br>  <i><b>Figure 3</b> .</i>  <i>Run the avrdude loader with the Command Prompt utility.</i> <br><br>  <b>Teensy controller boot with teensy_post_compile.exe</b> <br>  After installing the <b>Teensyduino</b> software of the <b>Teensy</b> controllers, the corresponding controllers appear in the device list of the Arduino IDE console (see Figure 4). <br><br><img src="https://habrastorage.org/webt/d1/i9/fm/d1i9fmfdets2d189mht-nin6fuk.png" alt="image"><br>  <i><b>Figure 4</b> .</i>  <i>List of Teensy controllers in the Arduino IDE console.</i> <br><br>  An example of writing a command to load a hex code into a <b>Teensy</b> controller can be obtained by completing the sequence shown above for Arduino controllers.  In the output window, you need to find a sample loader - the command <b>teensy_post_compile</b> .  For offline download, the necessary files can be copied to a separate folder, for example, as shown below.  The files teensy_post_compile, teensy_post_compile.exe and teensy.exe can be taken from the Arduino package with the addition of the Teensy application. <br><br><img src="https://habrastorage.org/webt/vl/gg/0l/vlgg0lyhdxajm9sao25nkywshgw.png" alt="image"><br><br>  Below are examples of commands to load hex files Blink_1.ino and Blink_2.ino into two Teensy controllers connected to a computer via a USB hub. <br><br><pre> <code class="dos hljs">"C:\TnsIDE/teensy_post_compile" -file=Blink_2.ino "-<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=C:\TnsIDE" "-tools=C:\TnsIDE" -board=TEENSY31 -reboot -port=usb:<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span>A0000/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span> -portlabel=COM19 (Teensy <span class="hljs-number"><span class="hljs-number">3</span></span>.<span class="hljs-number"><span class="hljs-number">2</span></span>) Serial -portprotocol=Teensy</code> </pre> <br><pre> <code class="dos hljs">"C:\TnsIDE/teensy_post_compile" -file=Blink_1.ino "-<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=C:\TnsIDE" "-tools=C:\TnsIDE" -board=TEENSY31 -reboot -port=usb:<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span>A0000/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">2</span></span> -portlabel=COM23 (Teensy <span class="hljs-number"><span class="hljs-number">3</span></span>.<span class="hljs-number"><span class="hljs-number">2</span></span>) Serial -portprotocol=Teensy</code> </pre> <br>  In these entries, the hub ports are denoted as usb: 0 / 1A0000 / 0/1/1/1 and usb: 0 / 1A0000 / 0/1/1/2. <br><br>  <b>Download of Arduino controller (Atmega32U4) with avrdude.exe</b> <br><br>  Arduino UNO, Leonardo, Micro and others are based on the ATmega32U4 microcontroller.  This microcontroller has a built-in USB channel (full speed USB 2.0), therefore downloading programs to it differs from the considered download to ATmega328 microcontrollers via an additional USB-UART converter. <br><br>  The Arduino controller's COM port number is listed in the device manager list, for example. <br><br><img src="https://habrastorage.org/webt/is/1f/l1/is1fl1gua3m9pqumjbm_ewjcznc.png" alt="image"><br><br>  When the virtual COM port of the Arduino pro Micro controller is opened (with any transmission frequency of 1200, ..., 9600, ... 115200 baud), the controller is reset and the user program is started.  In the MATLAB environment, the program for creating a virtual port looks like this. <br><br><pre> <code class="matlab hljs"><span class="hljs-comment"><span class="hljs-comment">% create port. s=serial('COM15','Baudrate',9600); % 115200 fopen(s);</span></span></code> </pre> <br>  After closing the virtual COM port with a frequency not equal to 1200 baud, for example, as shown below <br><br><pre> <code class="matlab hljs">fclose(s); delete(s); clear s</code> </pre> <br>  the user program of the controller is executed. <br><br>  The controller is reset and the controller loader is started after opening and closing the COM port with a frequency of 12,000 baud by the external environment, for example, MATLAB, as shown below. <br><br><pre> <code class="matlab hljs"><span class="hljs-comment"><span class="hljs-comment">% create port. s=serial('COM15','Baudrate',1200); % 115200 fopen(s); pause(1.5); fclose(s); delete(s); clear s</span></span></code> </pre><br>  The same operation can be performed with the <b>mode</b> command, as shown in Figure 5. <br><br><img src="https://habrastorage.org/webt/-h/ur/s6/-hurs6ijb6cerpwn77rcapxe0ja.png" alt="image"><br>  <i><b>Figure 5</b> .</i>  <i>Execute the mode command in Command Prompt.</i>  <i>The command sets the transmission rate of 1200 baud for the COM15 port, which causes the controller to reset and the bootloader to start, as well as temporarily change the controller's virtual port numbers in the device list.</i> <br><br>  After the port is closed (the fclose (s) command), the controller loader creates its own virtual (CDC) port, which is displayed in the device manager list with a new number for about 8 seconds. <br><br><img src="https://habrastorage.org/webt/yf/ft/xr/yfftxr16gynamwlmykfujcv7e9w.png" alt="image"><br><br>  After the lifetime of the new virtual port (8 sec.), The COM port with the original number is returned to the device manager list. <br><br><img src="https://habrastorage.org/webt/ma/rn/zp/marnzpy8381ca1qibgndsvrwqva.png" alt="image"><br><br>  During the existence of a new COM port, through it you can manually load a user program into the controller using the sample command <b>avrdude of</b> the Arduino IDE console.  Obtaining a sample of the avrdude bootloader command in the Arduino IDE is similar to the one shown above for Atmega328 microcontrollers.  The created virtual port disappears from the list of devices after the board is rebooted and the COM port with the original number is returned to the list. <br><br>  The loader can also be started by connecting the RST contact of the Arduino board to GND ground. <br>  If the automatic reset of the controller (through the creation and disconnection of the COM port at 1200 baud) does not work, you can boot the devices (Arduino Leonardo, Arduino Pro Micro) based on the ATmega32U4 microcontroller via the Arduino IDE console in the following sequence. <br><br>  1. Press and hold the “Reset” button (or close the RST contact to the ground).  Serial USB connection is broken.  The controller's COM port disappears from the device manager list. <br><br>  2. Click the button <img src="https://habrastorage.org/webt/ct/el/-_/ctel-_2i_bs4uuoxpuwb_vvbecy.png" alt="image">  Upload (Ctrl + U) Arduino IDE.  Figure 6 shows the initial state of the device manager (left) and the Arduino IDE (right) at this stage. <br><img src="https://habrastorage.org/webt/tt/hg/pp/tthgpp3zk28gngzwuhitxzxmcam.png" alt="image"><br>  <i><b>Figure 6</b> .</i>  <i>The number of the COM port in the device manager and the indication of the process of compiling the program in the Arduino IDE console.</i> <br><br>  3. Wait until the status indicator completes the “Compiling” compilation and proceeds to uploading the “Uploading”, as shown in Figure 7. <br><br><img src="https://habrastorage.org/webt/qd/zq/rl/qdzqrlrq4o3aj3whqvmul_ctvpu.png" alt="image"><br>  <i><b>Figure 7</b> .</i>  <i>The number of the new temporary COM port in the device manager and the indication of the process of loading the program in the Arduino IDE console.</i> <br><br>  4. Release the “Reset” button (open the RST contact).  USB connection is restored.  Loading.  The end of loading is indicated by the phrase Done uploading (see Figure 8) <br><br><img src="https://habrastorage.org/webt/ij/9m/76/ij9m76fez8yzm1x-utxv5tsmqgo.png" alt="image"><br>  <i><b>Figure 8</b> .</i>  <i>The COM port number in the device manager and the indication that the program is loaded in the Arduino IDE console.</i> <br><br>  <b>Download controllers via batch (command) bat file</b> <br><br>  Offline boot (without using the Arduino IDE console) can be performed using a batch (command) file.  An example of a batch file (with the bat extension) for downloading HEX files to two Arduino Pro Micro controllers (Atmega32u4) connected to a computer via the first hub, to two Teensy controllers connected to a computer via a second hub, and to the Arduino UNO controller (Atmega328) is shown below.  The downloaded HEX files and all the necessary programs for this were previously placed in the shared folder shown in Figure 9. <br><br><img src="https://habrastorage.org/webt/ik/s8/7j/iks87jfpuuccla8c9jfubiidypg.png" alt="image"><br>  <i><b>Figure 9</b> .</i>  <i>An example of the contents of a folder for offline loading of 5 controllers: Arduino Pro Micro (Atmega32u4), Teensy and Arduino UNO (Atmega328)</i> <i><br></i> <br>  The batch file mcLoad.bat for offline loading of five controllers is shown below.  One second delays (TIMEOUT / T 1 / NOBREAK) are added before loading the Arduino Pro Micro controllers.  A delay of 2 seconds is entered before loading the second Teensy controller.  After all the controllers are loaded, the Teensy.exe program window closes. <br><br><pre> <code class="dos hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> OFF <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> UPLOAD: Arduino Pro Micro <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">mode</span></span> COM42 BAUD=<span class="hljs-number"><span class="hljs-number">12000</span></span> TIMEOUT /T <span class="hljs-number"><span class="hljs-number">1</span></span> /NOBREAK avrdude -Cavrdude.conf -v -patmega32u4 -cavr109 -PCOM45 -b57600 -D -Uflash:w:micro.ino.hex:i <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> UPLOAD: Arduino Pro Micro <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-built_in"><span class="hljs-built_in">mode</span></span> COM43 BAUD=<span class="hljs-number"><span class="hljs-number">12000</span></span> TIMEOUT /T <span class="hljs-number"><span class="hljs-number">1</span></span> /NOBREAK avrdude -Cavrdude.conf -v -patmega32u4 -cavr109 -PCOM44 -b57600 -D -Uflash:w:micro.ino.hex:i <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> UPLOAD: Arduino UNO avrdude -Cavrdude.conf -v -patmega328p -carduino -PCOM3 -b115200 -D -Uflash:w: BlinkUNO.ino.hex:i <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> UPLOAD: Teensy <span class="hljs-number"><span class="hljs-number">1</span></span> "C:\mcLOAD/teensy_post_compile" -file=Blink_1_Teensy.ino "-<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=C:\mcLOAD" "-tools=C:\mcLOAD" -board=TEENSY31 -reboot -port=usb:<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span>A0000/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">2</span></span> -portlabel=COM23 (Teensy <span class="hljs-number"><span class="hljs-number">3</span></span>.<span class="hljs-number"><span class="hljs-number">2</span></span>) Serial -portprotocol=Teensy <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> Delay <span class="hljs-number"><span class="hljs-number">2</span></span> seconds: TIMEOUT /T <span class="hljs-number"><span class="hljs-number">2</span></span> /NOBREAK <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> UPLOAD: Teensy <span class="hljs-number"><span class="hljs-number">2</span></span> "C:\mcLOAD/teensy_post_compile" -file=Blink_2_Teensy.ino "-<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>=C:\mcLOAD" "-tools=C:\mcLOAD" -board=TEENSY31 -reboot -port=usb:<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span>A0000/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span> -portlabel=COM19 (Teensy <span class="hljs-number"><span class="hljs-number">3</span></span>.<span class="hljs-number"><span class="hljs-number">2</span></span>) Serial -portprotocol=Teensy <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> Close Teensy.exe <span class="hljs-built_in"><span class="hljs-built_in">taskkill</span></span> /f /IM Teensy.exe</code> </pre> <br>  Disconnecting the controller from the USB line does not affect the load on the other controllers. <br><br>  To exclude an Arduino name from the device manager list, for example, “Arduino UNO (COMX)”, you can use programs, for example, RegOwnersahipEx, or hardware clones of Arduino controllers, for example, WAVGAT, which is indicated in the device list as “USB-SERIAL CH340 (COMX ) ”. <br><br>  <b>Bibliographic list</b> <br><br>  1. Comparison of Arduino boards (table) <a href="http://digitrode.ru/arduino-comparison.html">digitrode.ru/arduino-comparison.html</a> <br>  2. Arduino Micro, <a href="https://shop.pimoroni.com/products/arduino-micro">shop.pimoroni.com/products/arduino-micro</a> <br>  3. Dr.  Bob Davidov.  Computer control technologies in the technical systems portalnp.ru/author/bobdavidov. </div>