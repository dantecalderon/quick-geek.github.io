<div class="post__text post__text-html js-mediator-article">  From January 1, 2019, a law was adopted for four constituent entities of the Russian Federation (Moscow, Moscow and Kaluga regions, as well as the Republic of Tatarstan) introducing a new Professional Work Tax (NPA) pilot project.  In short, his main task is to save professional figures from all the difficulties of small business: a tax of 6% (in the case of individual entrepreneurs), mandatory pension contributions, the amount of which every year only for one person itself approaches 50 thousand rubles, a tax declaration.  Thus, the state supports small business, providing low-cost start-up entrepreneurs (4% for income from individuals and 6% from legal).  If you want more details - you can see detailed information on the Internet. <br><br>  NPA is entitled to use even individuals who work in the field of IT.  How can this help?  For example, you have developed a service that works on the Internet, you want to accept payments.  You do not have to register a legal entity for the sake of such business activities and solve a bunch of questions right from the start.  It is enough to register as a self-employed person and on a word of honor to manually hammer in each service or product.  At the same moment, the developer of the service thinks: “Is it possible to automate this process?”.  And the answer here - "Of course, you can!".  The article, in fact, is to tell you how this is done. <a name="habracut"></a><blockquote>  Important note: the author of the article uses the knowledge gained from the study of the application, only for good - automation of routine.  He wishes you the same motives. </blockquote><br><h3>  Step 1. Determining HTTP traffic </h3><br>  Here you will need the official application of the taxpayer "My Tax".  You can download it through Google Play. <br><br>  For this article, it will be sufficient to determine the sourceDeviceId (I suspect that this is the same as the android id) and refreshToken, however, you can explore absolutely all the API methods proposed by the application to the study.  To determine it, you need to receive HTTPS requests from your smartphone.  For a stock device without root rights, you can use a computer, the free Fiddler program.  To understand the work of the program, I took advantage of a not quite relevant <a href="https://habr.com/ru/company/infopulse/blog/156711/">guide</a> , however, it was enough to intercept https traffic of the smartphone and display the work of the application on the computer screen. <br><br>  After installing all the necessary you need to register as a taxpayer and close the application.  Then activate the Fiddler program, establish a proxy connection on the smartphone and start the application again.  The application will make an authorization request with a refresh token, which at the time of this article is created with an indefinite expiration date: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/56e/95f/110/56e95f11079ba61fb902f9a1872f768c.jpg" alt="image"><br><br>  As you can see in the screenshot, the application has the base domain lknpd.nalog.ru (subdomain of the RF tax service website) and API version 1. Authorization for the methods is used by Bearer, the token for it is generated via the / auth / token method.  The data from the sourceDeviceId and refreshToken request fields are extremely necessary.  I checked the work of the refreshToken'a 3 days after the experiment - it works, therefore, the token for 1 hour can be safely taken, knowingly having one actual refreshToken. <br><br>  The method of sending a parish itself looks like this and has all the necessary fields: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8c3/938/bee/8c3938bee0be7d3bc0bfe6fb81065130.jpg" alt="image"><br><br>  Please note that all fields are required.  The services field may make you want to send several services in an array, but only the first service will appear on the check, although the final cost will be complete.  Still, the service is rather damp, and it was launched only recently, we will not dwell on it (although it’s a shame actually, several positions are sometimes necessary). <br><br>  It is also worth paying attention to the answer: approvedReceiptUuid: the field contains a unique check code, which can be obtained without any difficulties from your TIN and UUID check. <br><br><h3>  Step 2. Script development </h3><br>  To quickly demonstrate the concept of automation, Python 3.7.2 is used with the requests library: <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> requests <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> shutil TIME_OFFSET = <span class="hljs-string"><span class="hljs-string">'+03:00'</span></span> DEVICE_ID = <span class="hljs-string"><span class="hljs-string">''</span></span> REFRESH_TOKEN = <span class="hljs-string"><span class="hljs-string">''</span></span> API_PROVIDER = <span class="hljs-string"><span class="hljs-string">'https://lknpd.nalog.ru/api/v1/'</span></span> TOKEN = <span class="hljs-string"><span class="hljs-string">''</span></span> INN = <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DO</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(method, params)</span></span></span><span class="hljs-function">:</span></span> headers = {<span class="hljs-string"><span class="hljs-string">"Authorization"</span></span>:<span class="hljs-string"><span class="hljs-string">"Bearer "</span></span>+TOKEN} <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> TOKEN != <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {} r = requests.post(API_PROVIDER+method, json=params, headers=headers) print(r.text) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> r.json() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_token</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> reqparam = { <span class="hljs-string"><span class="hljs-string">"deviceInfo"</span></span>: { <span class="hljs-string"><span class="hljs-string">"appVersion"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.0.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"metaDetails"</span></span>: { <span class="hljs-string"><span class="hljs-string">"browser"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"browserVersion"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"os"</span></span>: <span class="hljs-string"><span class="hljs-string">"android"</span></span> }, <span class="hljs-string"><span class="hljs-string">"sourceDeviceId"</span></span>: DEVICE_ID, <span class="hljs-string"><span class="hljs-string">"sourceType"</span></span>: <span class="hljs-string"><span class="hljs-string">"android"</span></span> }, <span class="hljs-string"><span class="hljs-string">"refreshToken"</span></span>: REFRESH_TOKEN } res = DO(<span class="hljs-string"><span class="hljs-string">'auth/token'</span></span>, reqparam) <span class="hljs-comment"><span class="hljs-comment"># </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> сохранять tokenExpireIn и не вызывать авторизацию каждый раз return res['token'] # </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> научиться нормально программировать TOKEN = get_token() def new_transaction(service, amount): trans_time = datetime.datetime.now().isoformat()[:-3]+TIME_OFFSET reqparam = { "ignoreMaxTotalIncomeRestriction": False, "operationTime": trans_time, "paymentType": "CASH", "requestTime": trans_time, "services": [ { "amount": amount, "name": service, "quantity": 1 } ], "totalAmount": amount } res = DO('income', reqparam) return res['approvedReceiptUuid'] def get_receipt(receipt_uuid): headers = {"Authorization":"Bearer "+TOKEN} r = requests.get( 'https://lknpd.nalog.ru/api/v1/receipt/'+INN+"/"+receipt_uuid+"/print", stream=True, headers=headers ) with open('receipt.png', 'wb') as f: r.raw.decode_content = True shutil.copyfileobj(r.raw, f) if __name__ == '__main__': rec = new_transaction('Тестовая услуга', '1.00') get_receipt(rec)</span></span></code> </pre> <br>  Substitute the necessary values ​​- the script will work as it should.  You can add error handlers and improve delivery - the above script only shows how to work with the NAP tax API. <br><blockquote>  <b>Note</b> It is possible that the tax agency will publish the API in the future, but now it does not do it just because few people need it.  Therefore, this case is postponed until later.  However, I hasten to note that if the official manual is published, it will contain either similar information or slightly improved information, in terms of authorization for sure. </blockquote><br><br><h3>  Conclusion </h3><br>  In conclusion, I would like to note: <s>do not repeat this at home;</s> nothing is impossible.  Even such a routine thing can be safely automated.  Copy the code, modify in your own way.  Perhaps, then I implement the library so that the automation will be much more accessible to everyone.  I am waiting for your objective criticism and continue to dig in the direction of the API.  My next goal is to idealize the principle of authorization and create a library for Python. </div>