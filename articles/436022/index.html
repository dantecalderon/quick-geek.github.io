<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How did we develop the Librem 5 devkit completely on free software?</title>
  <meta name="description" content="From the translator: Librem 5 (on the render) - a protected smartphone for Linux from the company Purism, which is created on the most open hardware a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-6974184241884155",
      enable_page_level_ads: true
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>How did we develop the Librem 5 devkit completely on free software?</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/677/f32/6fb/677f326fbfe89b47dc402ba404049144.png" align="left">  <b><font color="gray">From the translator: Librem 5 (on the render) - a protected smartphone for Linux from the company Purism, which is created on the most open hardware and software <a href="https://habr.com/post/370873/">through crowdfunding</a> .</font></b> <br><br>  Today we will talk about the development of the Librem 5 Developer Kit and how we used only 100% free software to develop it. <br><br>  The devkit design is published under the GNU GPLv3 + license, the Git hardware repository <a href="https://source.puri.sm/Librem5/dvk-mx8m-bsb">is here</a> . <br><br>  <b>KiCad - the obvious choice of EDA</b> <br><br>  Before the start of development, it was not entirely clear which way to develop the project.  In particular, which tool to choose to <a href="https://en.wikipedia.org/wiki/Electronic_design_automation">automate electronics design (EDA)</a> .  Initially, the idea was to change the i.MX 6QP OpenRex board from FEDEVEL to meet all the requirements for a devkit, but we immediately faced two main problems: it used an archaic i.MX 6QP processor, and even worse, the board was developed in a proprietary Altium system .  Fortunately, I already had the experience of designing electronics using EDA KiCad, so we managed to create a devkit design using 100% free software. <br><a name="habracut"></a><br>  KiCad is an obvious choice not only because of the free license (GNU GPLv3 +), but also because it is a very functional set for designing electronics, which even surpasses some expensive proprietary tools. <br><br><h1>  Selection of components that meet the requirements </h1><br>  The first step in devikit development is to search for components that meet the requirements defined during the campaign.  In addition to compliance with the stated specifications, when searching for components, we decided to add a few additional bells and whistles;  including: <br><br><ul><li>  charge controller (BQ25896) </li><li>  18650 battery holder for optional lithium-ion battery </li><li>  USB-C </li><li>  mini-HDMI </li><li>  SD card controller and micro-SD connector (since i.MX 8M has only two uSDHC controllers) </li><li>  Ethernet / RJ45 </li><li>  audio codec </li><li>  headphone speaker </li><li>  microphone </li><li>  4-pin CTIA / AHJ 3.5 mm headphone jack (with a choice between built-in and external microphone) </li><li>  GPG smart card reader and connector </li><li>  vibration motor </li><li>  programmable LED </li><li>  volume and power buttons </li><li>  hardware switches and boot mode switch </li><li>  16Mb SPI NOR flash memory </li><li>  real time clock (RTC) </li></ul><br>  As planned, we added through holes for UART debugging pins that are not occupied by default (serial over USB works on the default image that comes with the devkit).  Hint: if you don‚Äôt like to solder, then heders support press fit, look for part number Autosplice 23-1063.  The board has a SMD 2 √ó 5 JTAG support surface, and its functionality has been tested on a prototype;  If you want to play around, then look for the part number GRPB052VWQS-RC. <br><br>  For the WWAN / baseband modem and WiFi + BT, it was clear that you need to find some ready-made modules, for example, with surface mount.  At an early stage, Nicole had the brilliant idea of ‚Äã‚Äãusing the mPCIe and M.2 modules to make modular modules, with the possibility of an upgrade in the future.  In the end, we stopped at the SIMCom SIM7100A / E mPCIe modem module and the M.2 RedPine RS9116 Wi-Fi + BT module. <br><br><h1>  Start drawing </h1><br>  At the conclusion of the research phase, we should have begun to implement our ideas.  The i.MX 8M Quad processor has just appeared on the market.  To get a breakthrough in development, as well as add modularity and the possibility of future upgrades, we chose the <a href="https://en.wikipedia.org/wiki/System_on_module">system-on-module (SOM)</a> option, including SoC, SDRAM, eMMC and PMIC.  But even in the early stages of development, when we were just starting to draw diagrams, the serial production of some of the SOMs of interest to us had not yet begun.  Around mid-April, we established a good relationship with EmCraft, which just started the first major SOM production cycle and was close to issuing a hardware architecture specification.  We decided that the EmCraft SOM and their resources are exactly what we need.  As soon as a specific SOM was chosen, we immediately proceeded to drawing diagrams. <br><br>  The process of selecting specific components for devikit was carried out simultaneously with the mapping.  All work was carried out in the Git version control system. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/002/f50/b83/002f50b8307d32400b024771aa5e869d.png"><br>  <i><font color="gray">Fig.</font></i>  <i><font color="gray">1. Early edition of the scheme of May 2 (git-commit hash 023915d5)</font></i> <br><br>  At the completion of the schemes, we exported the <a href="https://en.wikipedia.org/wiki/Netlist">netlist</a> file, which brought us closer to bringing the devitch to life. <br><br><h1>  HP_DET simulation </h1><br>  In addition to KiCad, from free software, we also used a tool called <a href="https://ra3xdh.github.io/">Qucs-S</a> and a SPICE-compatible <a href="https://xyce.sandia.gov/">Xyce</a> emulation <a href="https://xyce.sandia.gov/">tool</a> to emulate a headphone sensor chip, which includes a zener diode to protect the corresponding GPIO from too high or too low input voltage from the HP DAC output from audio codec.  The combination of Qucs-S and Xyce made it possible to use in the chip the <a href="https://www.onsemi.com/PowerSolutions/supportDoc.do%3Ftype%3Dmodels%26rpn%3DMMSZ4688">SPICE model of the MMSZ4688T1G diode</a> , which best represents the physical state of the empty 3.5 mm jack with simultaneously active HP DAC. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e29/e1f/e8c/e29e1fe8cf98b7fe79c09a676ffe01d7.png"><br>  <i><font color="gray">Fig.</font></i>  <i><font color="gray">2. Simulation of the HP_DET scheme using Qucs-S and Xyce</font></i> <br><br>  This simulation, as well as the simple case of DC, where the internal 3.5 mm jack switch is open and 1MŒ© only reaches the default voltage of 3V3_P - this made sure that a particular protection method really works. <br><br><h1>  Creating sites </h1><br>  Around the middle of June, we completed the compilation of a <a href="https://en.wikipedia.org/wiki/Bill_of_materials">list of materials (BOM)</a> , began to place orders for components and began to create the outlines of all the sites in the device (chips, connectors, modules, etc.).  We took the recommended specifications from the documentation and checked four times that everything is correct. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/836/86a/436/83686a4361446f4b6e4e98d2ff7f8793.png"><br>  <i><font color="gray">Fig.</font></i>  <i><font color="gray">3. Platform charge controller BQ25896 (U301 on the dev-board, is under the SOM)</font></i> <br><br>  In the awesome 3D viewer mode of KiCad, we created three-dimensional outlines of almost all the components. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/069/5f2/b2e/0695f2b2e92acc299901f4b1291bba89.png"><br>  <i><font color="gray">Fig.</font></i>  <i><font color="gray">4. 3D-model charge controller BQ25896</font></i> <br><br><h1>  Level Planning, Layout and KiCad Update </h1><br>  At an early stage, a rough <a href="https://en.wikipedia.org/wiki/Floorplan_(microelectronics)">level plan</a> was drawn <a href="https://en.wikipedia.org/wiki/Floorplan_(microelectronics)">up</a> to quickly estimate what area of ‚Äã‚Äãthe integrated circuit would be used (90 √ó 180 mm) and where to place larger components (connectors, jacks, card slots, mPCIe and M.2 sockets, modules, and t d.)  After placing on the layout, some of the details were still moving, but quickly consolidated on specific places. <br><br>  At the end of June, we began to lay the layout, starting with USB-C (commit a1bfc689).  This marked the beginning of the layout. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0f0/aef/ec3/0f0aefec31996ed6d227b30997b66eeb.png"><br>  <i><font color="gray">Fig.</font></i>  <i><font color="gray">5. The first commit with wiring</font></i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cae/58c/a5d/cae58ca5df27193c9d40472404fa36a6.png"><br>  <i><font color="gray">Fig.</font></i>  <i><font color="gray">6. What was the final USB-C layout?</font></i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ddd/b0a/e40/dddb0ae40b3977458280006626c31ae6.png"><br>  <i><font color="gray">Fig.</font></i>  <i><font color="gray">7. Early version of the scheme before placing components and wiring</font></i> <br><br>  The wiring process required a delicate balance between the speed of work and the verification that everything was done correctly without errors, including careful routing of resistance control tracks and sensitive analog lines. <br><br>  Initially, there was no certainty how many layers are needed and whether components should be placed on both sides of the board.  We knew that on the i.MX 8M board there are eight layers and components on both sides, but we were sure that we could reduce the number of layers.  We quickly realized that the back side of the board would have to be placed components, because on the phone some modules are on the back side of the board (display side), including display connectors, proximity sensor / light sensor, programmable LED, speaker and microphone.  The presence of components on both sides made the layout process somewhat easier, as it freed up some space where you can place SPI NOR flash memory, card reader, RTC, 2.8V LDO, various ICs and other components.  As for the number of layers, we decided to reduce it to six.  Two additional layers were decided to add only if we were stuck in a dead end and could not lay any chains.  Fortunately, this did not happen and the design with six layers remained. <br><br>  We decided to use a common layout that provides the optimal balance between ease of wiring and reduces unintentional emissions.  As a dielectric substrate, we took a laminated plastic with a copper foil NP-180TL from NAN YA, which has a relative dielectric constant of about 4.11 at our average operating frequency of about 1.7 GHz.  Our RF powerline calculations for microstrip and coplanar waveguide supply lines of the board (CPW) using this layout can be found in the Git repository. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a98/202/905/a98202905bec5e9c3c89a85145a3b631.png"><br>  <i><font color="gray">Fig.</font></i>  <i><font color="gray">8: DevKit Layer Layout</font></i> <br><br>  Before the implementation of devikit in KiCad, we did not know whether to release alpha versions or stick to classic more stable releases like 4.0.7.  Although the ‚Äúnightly builds‚Äù have a few useful features, we still decided to stick with stable releases so that we don‚Äôt have to frequently update KiCad and risk the emergence of several simultaneous versions. <br><br>  When we started, KiCad version 5.0.0 was released!  On July 16, we upgraded the project to KiCad 5.0.0 without any problems (in particular, commits 4f70b865 and a4e3de8a).  Fortunately, this update coincided with the transition of most of our passive components from 0603 to 0402, since the new sites in KiCad are slightly different from the old default values, and the rounded corners of the sites are more effective for lead-free solder. <br><br>  After updating to 5.0.0, we focused on prototyping - and within a month (namely, on August 14, with a commit 9b4dd2e0), we brought the number of undissolved chains to zero. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2c2/f1a/559/2c2f1a559a31665c94e4e0ba72a0db8c.png"><br>  <i><font color="gray">Fig.</font></i>  <i><font color="gray">9: Release candidate dated August 14 with a commit 9b4dd2e0 fixed zero number of undiluted chains</font></i> <br><br>  After the wiring was completed and Design Rules Check (DRC) was checked, we arranged the layout for a week. <br><br>  When prototyping the board, the most useful resources were the reference book on prototyping integrated circuits from the official documentation and the <i><a href="https://docs.toradex.com/102492-layout-design-guide.pdf">Toradex prototyping guide</a></i> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e75/c0c/f13/e75c0cf13027bf480210fb5c03a4ce7e.png"><br>  <i><font color="gray">Fig.</font></i>  <i><font color="gray">10. Final layout (copper coated areas are hidden)</font></i> <br><br><h1>  Export files and send to production </h1><br>  After the layout was completed, it was necessary to export all the files necessary for the production and assembly of the boards.  Exporting <a href="https://en.wikipedia.org/wiki/Gerber_format">Gerber files</a> to KiCad is fairly straightforward.  However, the contractor requested another layout and layout for the assembly, which required some effort. <br><br>  We usually used Gerbv from gEDA to preview the files on export.  <a href="http://gerblook.org/pcb/rTgd4Aqusxr7XQLSdKa9V3">This is what</a> our girlfriend in Gerblook <a href="http://gerblook.org/pcb/rTgd4Aqusxr7XQLSdKa9V3">looks like</a> - this tool uses Gerbv and ImageMagick for web rendering. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/415/bc8/af1/415bc8af18124f9e29826d1b728334bc.png"><br>  <i><font color="gray">Fig.</font></i>  <i><font color="gray">11. Gerber devkita files when viewed in Gerbv</font></i> <br><br>  To create a drawing of the required type, we used layers F.Fab / B.Fab.  They display the locations, contours, polarity, and reference designations of all components on the board.  Using the F / B.Fab layers for each site, we were able to create the final drawing by printing out F.Fab and B.Fab into separate PDF files, and then merging them into one document. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d12/b18/50c/d12b1850c44c3dad1e54ff6f084c0102.png"><br>  <i><font color="gray">Fig.</font></i>  <i><font color="gray">12. Scheme by SOM</font></i> <br><br>  Even more had to work on the scheme for production.  To do this, you had to export notes from the Cmts.User layer along with the board outline as one DXF archive, and then export all the marks for drilling holes as another DXF archive.  After creating these two files, they are combined in the footprint drawing.  Having received this special ‚Äúfootprint‚Äù, which combines two DXF files, we hide almost everything in the layout - and import this special footprint ‚Äúfor the plant‚Äù (without saving the temporary layout).  At the moment everything you need is on the Dwgs.User layer;  therefore, you can print it together with the frame into the final PDF for production. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/00a/bd4/abe/00abd4abe3eb54b8ebb5d523214a26f1.png"><br>  <i><font color="gray">Fig.</font></i>  <i><font color="gray">13. Marks for drilling holes</font></i> <br><br>  Together with all these files and documents, the IPC-D-356 netlist is used, with which the plant can carry out a <a href="https://en.wikipedia.org/wiki/Flying_probe">test using the ‚Äúflying probe‚Äù method</a> and make sure that there is no short circuit or an open circuit.  We also prepared a CSV file (so that the factory knew where to place and how to orient all the components), and finally, a manually edited GenCAD file (for programming a factory soldering robot). <br><br><h1>  Prototype testing </h1><br>  We sent the final files for production, answered all the contractor‚Äôs questions and changed everything they asked.  The files were sent around the end of August - and we waited impatiently for our design to hit the assembly line in Shenzhen.  Unfortunately, as we <a href="https://puri.sm/posts/librem5-2018-11-hardware-report/">told in the blog</a> , significant delays in the production of prototypes occurred due to unforeseen circumstances, such as severe weather and Golden Week [a national holiday in China - approx.  trans.].  Because of these delays, we decided to order the production of prototypes at a domestic plant that delivered us the boards two weeks faster than the Chinese. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0e0/53f/397/0e053f397d0620a30e89a3f733dc8403.png"><br>  <i><font color="gray">Fig.</font></i>  <i><font color="gray">14. The prototype of the devkit panel v0.1.2 (before assembly)</font></i> <br><br>  After building a small batch of prototypes, they were quickly sent to our engineers for debugging and software development.  Fortunately, due to public discussion and a comprehensive analysis of the design, there were very few errors in the hardware (three relatively minor adjustments to the layout / list of circuits and one mechanical correction).  Over the next two months, prototypes were used to polish the software. <br><br><h1>  Final production and supply </h1><br>  Around early-mid-November, after making minor adjustments to the design and <a href="https://developer.puri.sm/Librem5/Development_Environment/Boards/Known_Issues.html">testing of</a> almost all the hardware subsystems, we conducted a re-export procedure and re-released the files for production and final assembly.  Some of our employees spent December 10-22 helping with the assembly, testing, packaging and shipment of girls to our bakers (many delivered before Christmas!) <br><br><img src="https://habrastorage.org/getpro/habr/post_images/743/92a/c40/74392ac40af7ecb75a82176f5f8d7ed5.png"><br>  <i><font color="gray">Fig.</font></i>  <i><font color="gray">15. The final view of the devkit panel v1.0.0 (before assembly)</font></i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a9f/afb/98c/a9fafb98c817fcb4dff08e366f5c5b35.png"><br> <i><font color="gray"><img src="https://habrastorage.org/getpro/habr/post_images/8e3/9dd/e82/8e39dde8227922ef84704dc9ee512a70.png"><br></font></i>  <i><font color="gray">Fig.</font></i>  <i><font color="gray">16. Fully assembled device compared to 3D model (display side)</font></i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8db/e83/594/8dbe83594ca0c6698726f563e5b32196.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/11a/7c6/16f/11a7c616f05ab2cfbf4e7c69945b68ea.png"><br>  <i><font color="gray">Fig.</font></i>  <i><font color="gray">17. Fully assembled device compared to 3D model (SOM side)</font></i> <br><br>  The whole process required a lot of effort, but it was worth it.  Especially when we saw how fruitfully the community can use the results of our work.  Some have already begun to develop 3D printed enclosures for the devkit.  I can't wait to see what cool software and what use cases you can think of for these amazing cards!  Feel free to report all the cool stuff by email to <code>feedback@puri.sm</code> .  If this is really great, we will talk about your development in future blog posts. <br><br>  Now we have all the time it takes to send out Librem 5 phones. So until the next time, do not lose resource! </div><p>Source: <a href="https://habr.com/ru/post/436022/">https://habr.com/ru/post/436022/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>