<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How I create VKontakte recommendation service</title>
  <meta name="description" content="The summer ended, it was a particularly cold August. My 11th grade started and I realized that now is the last chance (spoiler: no) to somehow improve...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-6974184241884155",
      enable_page_level_ads: true
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>How I create VKontakte recommendation service</h1><div class="post__text post__text-html js-mediator-article">  The summer ended, it was a particularly cold August.  My 11th grade started and I realized that now is the last chance (spoiler: no) to somehow improve my professional competence.  For several years I have been diligently doing various IT projects, some one, some in a team.  But all the <s>sons of my mother's friend are</s> already doing something beautiful.  Perhaps useless, but beautiful in appearance.  Someone does a sticky simulation of particles in the form of gifs, someone plunges into machine learning and does all sorts of style transfers.  And I'm worse?  I also want! <br><br>  <i>An example of the simulation is also under the cut</i> <br><a name="habracut"></a><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/g0/ht/sh/g0htshdl9xzixux3j0-3aviwqxa.gif"></div><br>  <i>An example of the simulation of particles from my friend</i> <br><br>  It was with this thought that my study of the topic of machine learning began.  And in terms of training for me there was nothing new, as in any other field of IT practice is needed here.  But what if I‚Äôm not interested in any tonality analyzers?  We have to invent something of our own. <br><br>  Once again, leafing through the VKontakte news feed, I realized that the communities of this social network are a real treasure for data science.  If you process the text, memes in the form of pictures or music from collections, you can get a huge slice of relevant information about modern people: popular music genres, lexicon, or the time of day of the most active people.  This field is for many discoveries. <br><br>  But how much will such statistics be needed for ordinary people?  As if I miss my music, or I can‚Äôt go to the ‚ÄúPopular‚Äù section?  It means that we need to think something practical, something that may appeal to at least some significant percentage of users. <br><br>  It is worth noting that a couple of months before that I read a cool article about <a href="https://habr.com/post/123671/">creating my own home search engine</a> , which really hurt me.  As well as the author, I felt a great craving for huge projects, which day and night handle a huge number of equally great thousands of gigabytes of information. <br><br><img src="https://habrastorage.org/webt/ar/bx/uk/arbxukqaqo48ycseasyl07jdxz8.png"><br><br>  And now, back in August, which was a little warmer than at the beginning of the article.  When I realized that I now have a huge source of information, I realized that it was time.  It's time for your own monstrous system.  But the main question remained a few more days - what should I do with all this?  What to offer the user?  I will not torment the reader, I will tell only that it is very difficult for me, like some of my friends, to search for new VKontakte groups that I might like.  Now every first public name has a random set of words.  Admins are trying to make it the most absurd, probably, this is some kind of race that is understandable only for them. <br><br>  And then I decided to write a service that will help the user with the choice of communities, recommend what you can subscribe to.  That was my idea. <br><br>  The introduction was not accidental, it should convey my emotions and show that the idea did not appear out of the blue.  Actually, like any other ideas on Habr√©. <br><br>  My service is still in operation, it has been going on for more than four months (if you count from the moment of the first successful experiment).  But I already have an experience that I want to share with you.  There will be a brief, concise description of the project.  Further I will paint some basic points.  And if the article is especially hard for habrayusers, then its continuation will also be released, in which there will be more purely technical information and code. <br><br>  Everything consists of three parts: <br><br><ul><li>  search bot (if you can call it that) </li><li>  data processing engine </li><li>  website for users (with control panel and monitoring for admins) </li></ul><br>  The bot functionality includes searching for new groups and ‚Äústripping‚Äù text and other information into the database.  The engine is also engaged in the further processing of this data, as I will write below.  And the site simply allows users to use all of this. <br><br><h1>  Search bot </h1><br>  There is nothing new here.  I just take the profile of a person in VK and get a list of groups and his friends from him.  All this happens with the VK API.  And if this API manages to get the list of groups of the user and his friends, then he cannot cope with getting the contents of the groups ... I just bump into the restriction and that's it.  Then I remembered that some time ago, VKontakte was promoting its awesome system just for such things.  And the name of this system is streaming api. <br><blockquote>  Streaming API is a tool for getting a random selection of records from VK.  It‚Äôs written on the description page that you can simply get up to 1% of all information in order to get up to a hundred, you need to write to Support and explain your intentions to them. </blockquote> It would seem that everything is great.  But no.  I, like many, probably, missed the most important word in the description above.  And this is the preposition "before."  Nobody is going to give you all 100% of the data.  It's just a beautiful top bar and that's it.  In fact, we get this: <br><br><img src="https://habrastorage.org/webt/gp/vh/pz/gpvhpzq6dgcenzxvzgvmyz-l0hs.png"><br>  <i>I hope agent # 365 will not hate me all 365 days a year for this screenshot</i> <br><br>  That is, I can only get 30K events per day.  And this number includes comments, and just repost.  It is necessary to specify also some words-tags, messages will come only with them.  Some of the remaining posts just do not interest me, as it is on the wall with users.  It remains quite a bit.  For reference, in my current implementation I can receive up to 8.5M records in several days of incomplete uptime (in total - about 10 hours, but there were no exact measurements). <br><br>  Here I have to say about one rule that I discovered from all this experiment.  Never judge a group by one post.  Especially if you - artificial intelligence, susceptible to such noise.  So, you need at least a few posts to create an objective characteristic of the public.  Now let's estimate that some groups with really high-quality content release it every few weeks.  And even then I can skip it because of the imperfect Streaming API.  And if I get it, how long will it take me to collect the content bit by bit? <br><br>  I decided that for too long and went the other way.  Since I can't get a neat answer from VKontakte in JSON format, then I will parse the walls of the communities.  Yes, the task is a little more complicated, and its solution is slowing down, but I have no alternative.  That's how I started writing the first block of my system.  I wrote it, by the way, in Java using Jsoup, a library that makes it very convenient to extract content from HTML text.  I did not forget about the processing of the publication date of the last post, I do not need dead communities, I simply do not index them.  Also discarded and posts marked with advertising.  Not all administrators make such notes, but this problem is not so easy to solve, I could not create an adequate advertising filter and because of this, for the time being, I refuse such filtering. <br><br><h1>  Engine </h1><br>  This is probably the most interesting part of the project, but I will not describe everything in detail in this publication.  If someone will be interested in the details, then ask them to me in all possible ways. <br><br>  The easiest of all ways to present text in a format understandable for a neural network is bag-of-words. <br><br><img src="https://habrastorage.org/webt/ux/c-/kt/uxc-ktsdoepwc2ykzlf0cojafui.png"><br><br><div class="spoiler">  <b class="spoiler_title">The process of vectorization and more about BOW</b> <div class="spoiler_text">  I prepare in advance the dictionary of all frequent words (not forgetting to exclude direct very frequent ones, such as ‚Äúa‚Äù, ‚Äúwhat‚Äù, ‚Äúwhich‚Äù and others; they do not distinguish their text from others), in it each word has its number.  Then, when I need to process the text with a neural network, I get the number of each word from the dictionary (if it is there) and get a vector (aka array in programming).  This is such an ordered set of numbers, in which in place of each number of the word from the text there is a unit (see picture above).  It turns out quite understandable for the network data type.  I have the length of each vector is 30,000, about as many adequate words I gathered in the early stages of development. <br></div></div><br>  Another important thing is not to forget about the fact that, for example, the words "Habr" and "(in) Habr√©" are almost the same to understand.  But for the algorithm described above, these are completely different words.  In order to fix this, I use the <a href="https://github.com/kmike/pymorphy2">JMorphy2</a> morphological analyzer.  This is the port of the original PyMorphy2 under Java.  He can do a lot of cool things, for example, change the shape of a word (case, gender, number, etc.).  I need it to get the initial form of the word.  As you know, the initial forms of the "identical" words are the same.  And this solves the problem above. <br><br><pre><code class="plaintext hljs">–Ω–æ–ª—å 6929 –º–∞—Å–ª–æ–≤ 21903 –¥—Ä–∞–∫–æ–Ω—á–∏–∫ 25126 —Ü–≤–µ—Ç–∫–æ–≤—ã–π 11441 –±—É–¥–¥–∞ 7374 –∞–≤—Ç–æ–±—É—Å 1925 —Å—É–ø–µ—Ä 1626 –ø–ª–æ–π–∫–∞ 23128 –Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ 6241 –∏—Å—Ç–µ—Ä–∏—á–Ω—ã–π 25584</code> </pre> <br>  <i>Example of a list of words in the dictionary and their numbers (separated by a space)</i> <br><br>  The list above shows that the word "dragon" has not turned into a "dragon".  This is a bit wrong, but even this kind of text preprocessing is enough.  And in general, this library has many errors, but most of them do not affect the operation of the system. <br><br>  The service is focused on the Russian-speaking audience.  And for simplicity, only the Russian language is being processed now.  All characters (letters among them) from other alphabets are thrown away, as are punctuation marks, numbers, emoji ... Again, a simplification.  You also need to remember to filter words from languages ‚Äã‚Äãthat partially use the Russian alphabet, but add their own letters there (Ukrainian, for example). <br><br>  But I will continue from the moment any post from VKontakte has already turned into a vector (I call it vectorization).  Here connects the following link: neural network.  I decided to use it as it was interesting to me and managed to find a suitable architecture for my task.  This was helped by the <a href="https://habr.com/post/331382/">first article from the series ‚ÄúAutoencoders in Keras‚Äù</a> .  And yes, I decided to use the most common autoencoder, as it is beneficial in terms of speed of work and training.  But let's get everything in order. <br><br>  As for all other autoencoders, it is necessary to create two neural networks (encoder and decoder) and combine them into one.  I did this as follows: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> keras.layers <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Input, Dense, Flatten, Reshape <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> keras.models <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Model <span class="hljs-comment"><span class="hljs-comment"># –†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è encoding_dim = 64 # –≠–Ω–∫–æ–¥–µ—Ä inp = Input(shape=(30000, )) # 30000 - —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å # –ö–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø–æ–ª–Ω–æ—Å–≤—è–∑–Ω—ã–º —Å–ª–æ–µ–º –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ encoded = Dense(encoding_dim, activation='linear')(inp) # –î–µ–∫–æ–¥–µ—Ä # –†–∞—Å–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –¥—Ä—É–≥–∏–º –ø–æ–ª–Ω–æ—Å–≤—è–∑–Ω—ã–º —Å–ª–æ–µ–º input_encoded = Input(shape=(encoding_dim,)) decoded = Dense(30000, activation='sigmoid')(input_encoded) # –î—Ä—É–≥–∏–µ –º–æ–¥–µ–ª–∏ –º–æ–∂–Ω–æ —Ç–∞–∫ –∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫ –∏ —Å–ª–æ–∏ encoder = Model(inp, encoded, name="encoder") decoder = Model(input_encoded, decoded, name="decoder") autoencoder = Model(inp, decoder(encoder(inp)), name="autoencoder")</span></span></code> </pre><br>  But why do we need two networks?  And in general, the author, you did not describe why this is <i>all</i> ! <br><br>  Easy, now everything will be.  To teach, for example, only the encoder is impossible - it will be just not clear how much he made the correct prediction.  And for this we are training the second network, which will immediately decode the output of the first (decoder).  The same input and output data is still used.  A bunch of two networks (just called autoencoder) learns to get the same output from the input data.  But all data passes through a narrow "bottleneck" in the form of 64 neurons.  This discards the most unnecessary information.  Thus, neural networks learn to transmit the most important information about the text as accurately as possible and to emit all noises.  Then I just remove the decoder and that's it.  You can get a better result, but then you need to either increase the dimension of the output layer of the encoder / input decoder.  Then it will be necessary to store more values ‚Äã‚Äãin the database, it will weigh more + all operations on long vectors will be longer (more on that later).  Or you can add layers / neurons, but then the training and vectorization will be longer. <br><br>  The encoder itself allows "to compress the dimension of the vector."  Remember that vector of zeros and ones?  So, the encoder allows you to change its size from 30K to 64 without much loss of important information.  After this step, you can normally compare two vectors to determine their similarities ... <br><br>  But we are looking at the work of the service on the recommendation of the communities VK, and not individual records.  This means that we need to somehow get the vector of the entire public.  This is done very easily, mathematics at the fifth grade level.  This is a bit rough method, but it works.  I just take and add all the vectors of records from one community (for example, take three small vectors {1, 2, 3}, {2, 3, 4}, {0, 4, 2}, we get the vector {3, 9, 9 }).  And I divide each of its elements by the number of vectors (we get the vector {1, 3, 3}).  Everything, we have combined all the records of the group into one.  In the future, you need to come up with something more cunning, so that you can reject noise in the form of posts with advertising, for example.  But now this is enough. <br><br>  We proceed to the mathematical part itself, but since for some reason everyone is afraid of it, I will sign it as strongly as possible.  Let's start with vectors in a mathematical sense.  Vector - directed segment.  This is such a thing, which has the coordinates of the beginning (it is most convenient to take them with zeros) and the coordinates of the end.  It is the latter that are written in curly brackets.  For example, the coordinates of the end of the vector {1, 0, 1} <s>YouTube</s> is a point with coordinates (1, 0, 1).  But we consider two two-dimensional vectors, <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-1"><span class="MJXp-mtext" id="MJXp-Span-2">&nbsp;</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-3">v</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-4">e</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-5">c</span><span class="MJXp-mrow" id="MJXp-Span-6"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-7">a</span></span></span></span><script type="math/tex" id="MathJax-Element-1"> \ vec {a} </script>  {5, 2} and <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-8"><span class="MJXp-mtext" id="MJXp-Span-9">&nbsp;</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-10">v</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-11">e</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-12">c</span><span class="MJXp-mrow" id="MJXp-Span-13"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-14">b</span></span></span></span><script type="math/tex" id="MathJax-Element-2"> \ vec {b} </script>  {50}.  Let's build them in one coordinate system: <br><br><img src="https://habrastorage.org/webt/6a/ax/hn/6aaxhnmmwy42zoz5uan5jarnd8i.png"><br><br>  Let the vector <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-15"><span class="MJXp-mtext" id="MJXp-Span-16">&nbsp;</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-17">v</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-18">e</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-19">c</span><span class="MJXp-mrow" id="MJXp-Span-20"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-21">a</span></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-22">a</span></span></span><script type="math/tex" id="MathJax-Element-3"> \ vec {a} a </script>  pink, <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-23"><span class="MJXp-mtext" id="MJXp-Span-24">&nbsp;</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-25">v</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-26">e</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-27">c</span><span class="MJXp-mrow" id="MJXp-Span-28"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-29">b</span></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-30">a</span></span></span><script type="math/tex" id="MathJax-Element-4"> \ vec {b} a </script>  - yellow.  Then, by the mathematical fact of the ninth class, the cosine of the angle between them is equal to the ratio of their scalar product to the product of their modules. <br><br>  Dot product &lt; <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-31"><span class="MJXp-mtext" id="MJXp-Span-32">&nbsp;</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-33">v</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-34">e</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-35">c</span><span class="MJXp-mrow" id="MJXp-Span-36"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-37">a</span></span></span></span><script type="math/tex" id="MathJax-Element-5"> \ vec {a} </script>  , <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-38"><span class="MJXp-mtext" id="MJXp-Span-39">&nbsp;</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-40">v</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-41">e</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-42">c</span><span class="MJXp-mrow" id="MJXp-Span-43"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-44">b</span></span></span></span><script type="math/tex" id="MathJax-Element-6"> \ vec {b} </script>  &gt; equal to the sum of the products of the corresponding elements, we have <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-45"><span class="MJXp-mo" id="MJXp-Span-46" style="margin-left: 0.333em; margin-right: 0.333em;">&lt;</span><span class="MJXp-mtext" id="MJXp-Span-47">&nbsp;</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-48">v</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-49">e</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-50">c</span><span class="MJXp-mrow" id="MJXp-Span-51"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-52">a</span></span><span class="MJXp-mo" id="MJXp-Span-53" style="margin-left: 0em; margin-right: 0.222em;">,</span><span class="MJXp-mtext" id="MJXp-Span-54">&nbsp;</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-55">v</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-56">e</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-57">c</span><span class="MJXp-mrow" id="MJXp-Span-58"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-59">b</span></span><span class="MJXp-mo" id="MJXp-Span-60" style="margin-left: 0.333em; margin-right: 0.333em;">&gt;=</span><span class="MJXp-mn" id="MJXp-Span-61">5</span><span class="MJXp-mo" id="MJXp-Span-62" style="margin-left: 0.267em; margin-right: 0.267em;">‚àó</span><span class="MJXp-mn" id="MJXp-Span-63">5</span><span class="MJXp-mo" id="MJXp-Span-64" style="margin-left: 0.267em; margin-right: 0.267em;">+</span><span class="MJXp-mn" id="MJXp-Span-65">2</span><span class="MJXp-mo" id="MJXp-Span-66" style="margin-left: 0.267em; margin-right: 0.267em;">‚àó</span><span class="MJXp-mn" id="MJXp-Span-67">0</span><span class="MJXp-mo" id="MJXp-Span-68" style="margin-left: 0.333em; margin-right: 0.333em;">=</span><span class="MJXp-mn" id="MJXp-Span-69">25</span></span></span><script type="math/tex" id="MathJax-Element-7"> <\ vec {a}, \ vec {b}> = 5 * 5 + 2 * 0 = 25 </script>  . <br><br>  The module of the vector is according to the following formula: <br><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math MJXp-display" id="MJXp-Span-70"><span class="MJXp-mrow" id="MJXp-Span-71"><span class="MJXp-mo" id="MJXp-Span-72" style="margin-left: 0.167em; margin-right: 0.167em;">|</span></span><span class="MJXp-mtext" id="MJXp-Span-73">&nbsp;</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-74">v</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-75">e</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-76">c</span><span class="MJXp-mrow" id="MJXp-Span-77"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-78">a</span></span><span class="MJXp-mrow" id="MJXp-Span-79"><span class="MJXp-mo" id="MJXp-Span-80" style="margin-left: 0.167em; margin-right: 0.167em;">|</span></span><span class="MJXp-mo" id="MJXp-Span-81" style="margin-left: 0.333em; margin-right: 0.333em;">=</span><span class="MJXp-mtext" id="MJXp-Span-82">&nbsp;</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-83">s</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-84">q</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-85">r</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-86">t</span><span class="MJXp-mrow" id="MJXp-Span-87"><span class="MJXp-msubsup" id="MJXp-Span-88"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-89" style="margin-right: 0.05em;">a</span><span class="MJXp-script-box" style="height: 1.86em; vertical-align: -0.64em;"><span class=" MJXp-script"><span><span style="margin-bottom: -0.25em;"><span class="MJXp-mn" id="MJXp-Span-91">2</span></span></span></span><span class=" MJXp-script"><span><span style="margin-top: -0.85em;"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-90">x</span></span></span></span></span></span><span class="MJXp-mo" id="MJXp-Span-92" style="margin-left: 0.267em; margin-right: 0.267em;">+</span><span class="MJXp-msubsup" id="MJXp-Span-93"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-94" style="margin-right: 0.05em;">a</span><span class="MJXp-script-box" style="height: 1.86em; vertical-align: -0.64em;"><span class=" MJXp-script"><span><span style="margin-bottom: -0.25em;"><span class="MJXp-mn" id="MJXp-Span-96">2</span></span></span></span><span class=" MJXp-script"><span><span style="margin-top: -0.85em;"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-95">y</span></span></span></span></span></span></span></span></span><script type="math/tex;mode=display" id="MathJax-Element-8"> | \ vec {a} | = \ sqrt {a ^ 2_x + a ^ 2_y} </script></p><br>  Where <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-97"><span class="MJXp-msubsup" id="MJXp-Span-98"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-99" style="margin-right: 0.05em;">a</span><span class="MJXp-mi MJXp-italic MJXp-script" id="MJXp-Span-100" style="vertical-align: -0.4em;">x</span></span></span></span><script type="math/tex" id="MathJax-Element-9"> a_x </script>  and <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-101"><span class="MJXp-msubsup" id="MJXp-Span-102"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-103" style="margin-right: 0.05em;">a</span><span class="MJXp-mi MJXp-italic MJXp-script" id="MJXp-Span-104" style="vertical-align: -0.4em;">y</span></span></span></span><script type="math/tex" id="MathJax-Element-10"> a_y </script>  this is the first and second value of vector a, respectively.  So: <br><math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-105"><span class="MJXp-mrow" id="MJXp-Span-106"><span class="MJXp-mo" id="MJXp-Span-107" style="margin-left: 0.167em; margin-right: 0.167em;">|</span></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-108">a</span><span class="MJXp-mrow" id="MJXp-Span-109"><span class="MJXp-mo" id="MJXp-Span-110" style="margin-left: 0.167em; margin-right: 0.167em;">|</span></span><span class="MJXp-mo" id="MJXp-Span-111" style="margin-left: 0.333em; margin-right: 0.333em;">=</span><span class="MJXp-mtext" id="MJXp-Span-112">&nbsp;</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-113">s</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-114">q</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-115">r</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-116">t</span><span class="MJXp-mrow" id="MJXp-Span-117"><span class="MJXp-msubsup" id="MJXp-Span-118"><span class="MJXp-mn" id="MJXp-Span-119" style="margin-right: 0.05em;">5</span><span class="MJXp-mn MJXp-script" id="MJXp-Span-120" style="vertical-align: 0.5em;">2</span></span><span class="MJXp-mo" id="MJXp-Span-121" style="margin-left: 0.267em; margin-right: 0.267em;">+</span><span class="MJXp-msubsup" id="MJXp-Span-122"><span class="MJXp-mn" id="MJXp-Span-123" style="margin-right: 0.05em;">2</span><span class="MJXp-mn MJXp-script" id="MJXp-Span-124" style="vertical-align: 0.5em;">2</span></span></span><span class="MJXp-mo" id="MJXp-Span-125" style="margin-left: 0.333em; margin-right: 0.333em;">=</span><span class="MJXp-mtext" id="MJXp-Span-126">&nbsp;</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-127">s</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-128">q</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-129">r</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-130">t</span><span class="MJXp-mrow" id="MJXp-Span-131"><span class="MJXp-mn" id="MJXp-Span-132">29</span></span></span></span><script type="math/tex" id="MathJax-Element-11"> | a | = \ sqrt {5 ^ 2 + 2 ^ 2} = \ sqrt {29} </script><br><math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-133"><span class="MJXp-mrow" id="MJXp-Span-134"><span class="MJXp-mo" id="MJXp-Span-135" style="margin-left: 0.167em; margin-right: 0.167em;">|</span></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-136">b</span><span class="MJXp-mrow" id="MJXp-Span-137"><span class="MJXp-mo" id="MJXp-Span-138" style="margin-left: 0.167em; margin-right: 0.167em;">|</span></span><span class="MJXp-mo" id="MJXp-Span-139" style="margin-left: 0.333em; margin-right: 0.333em;">=</span><span class="MJXp-mtext" id="MJXp-Span-140">&nbsp;</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-141">s</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-142">q</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-143">r</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-144">t</span><span class="MJXp-mrow" id="MJXp-Span-145"><span class="MJXp-msubsup" id="MJXp-Span-146"><span class="MJXp-mn" id="MJXp-Span-147" style="margin-right: 0.05em;">5</span><span class="MJXp-mn MJXp-script" id="MJXp-Span-148" style="vertical-align: 0.5em;">2</span></span><span class="MJXp-mo" id="MJXp-Span-149" style="margin-left: 0.267em; margin-right: 0.267em;">+</span><span class="MJXp-msubsup" id="MJXp-Span-150"><span class="MJXp-mn" id="MJXp-Span-151" style="margin-right: 0.05em;">0</span><span class="MJXp-mn MJXp-script" id="MJXp-Span-152" style="vertical-align: 0.5em;">2</span></span></span><span class="MJXp-mo" id="MJXp-Span-153" style="margin-left: 0.333em; margin-right: 0.333em;">=</span><span class="MJXp-mn" id="MJXp-Span-154">5</span></span></span><script type="math/tex" id="MathJax-Element-12"> | b | = \ sqrt {5 ^ 2 + 0 ^ 2} = 5 </script><br><br>  Combining all the formula we get: <br><math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-155"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-156">c</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-157">o</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-158">s</span><span class="MJXp-mo" id="MJXp-Span-159" style="margin-left: 0em; margin-right: 0em;">(</span><span class="MJXp-mtext" id="MJXp-Span-160">&nbsp;</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-161">v</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-162">e</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-163">c</span><span class="MJXp-mrow" id="MJXp-Span-164"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-165">a</span></span><span class="MJXp-mo" id="MJXp-Span-166" style="margin-left: 0em; margin-right: 0.222em;">,</span><span class="MJXp-mtext" id="MJXp-Span-167">&nbsp;</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-168">v</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-169">e</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-170">c</span><span class="MJXp-mrow" id="MJXp-Span-171"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-172">b</span></span><span class="MJXp-mo" id="MJXp-Span-173" style="margin-left: 0em; margin-right: 0em;">)</span><span class="MJXp-mo" id="MJXp-Span-174" style="margin-left: 0.333em; margin-right: 0.333em;">=</span><span class="MJXp-mtext" id="MJXp-Span-175">&nbsp;</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-176">f</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-177">r</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-178">a</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-179">c</span><span class="MJXp-mrow" id="MJXp-Span-180"><span class="MJXp-mn" id="MJXp-Span-181">25</span></span><span class="MJXp-mrow" id="MJXp-Span-182"><span class="MJXp-mtext" id="MJXp-Span-183">&nbsp;</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-184">s</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-185">q</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-186">r</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-187">t</span><span class="MJXp-mrow" id="MJXp-Span-188"><span class="MJXp-mn" id="MJXp-Span-189">29</span></span><span class="MJXp-mo" id="MJXp-Span-190" style="margin-left: 0.267em; margin-right: 0.267em;">‚àó</span><span class="MJXp-mn" id="MJXp-Span-191">5</span></span><span class="MJXp-mtext" id="MJXp-Span-192">&nbsp;</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-193">a</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-194">p</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-195">p</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-196">r</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-197">o</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-198">x</span><span class="MJXp-mn" id="MJXp-Span-199">0.93</span></span></span><script type="math/tex" id="MathJax-Element-13"> cos (\ vec {a}, \ vec {b}) = \ frac {25} {\ sqrt {29} * 5} \ approx 0.93 </script><br>  The correctness of the calculations can be checked through the trigonometric functions of the resulting right triangle.  In the project, all calculations are made using the following formulas, but I only have the coordinates of the end of a vector of two, but sixty-four. <br><br>  What does this information give?  As it turned out, the greater the cosine value (the smaller the angle), the more similar the texts that correspond to the vectors.  Thus, the task of finding a group most similar to group A is reduced to finding the cosine of the angle between the vector of this group and all others.  Then the engine leaves all groups in which the cosine value paired with A will be greater, say, 0.99.  At this stage, you can simply output the result, so it was with me before.  But this process is very long already at 100K communities, and what will happen, say, at 1M? <br><br>  To solve this problem, I use the graph.  All groups are represented as its vertices, and two points are connected if the cosine of the angle between the corresponding vectors is greater than 0.99.  But if the structure with the name of the graph is incomprehensible to you, then you can simply imagine that I pre-calculate the most similar pairs of communities in the database and save them.  And do not forget to update the graph as new groups are added to the database.  Yes, it is very long, but still easier for the user than it was before. <br><br><h1>  Site </h1><br>  I will not describe everything about the site, as this is the simplest and most boring part.  I have never written websites from scratch, always used various ready-made engines.  But in this project, I realized that it would be easier to make a self-recording.  So, the site engine is written in Python 3 using Flask.  And the Ninja2 template engine is used, which makes it more convenient to substitute dynamic values ‚Äã‚Äãinto static HTML (and js) code.  I did not forget about authorization via VKontakte, since this is the best option.  A designer, like a coder, is simply terrible of me; if someone wants to join the project, you are welcome. <br><br><img src="https://habrastorage.org/webt/b3/pt/t2/b3ptt2glf6ex1ggakahmil_9e_c.png"><br>  <i>The first line of results from the site</i> <br><br><h1>  Problems </h1><br>  I encountered some unpleasant situations that I successfully resolved.  The above is a problem with the VK API and its solution was especially unpleasant for the service, as the speed dropped very much.  If earlier I received a hundred posts in one request, then now I need to do a few downloads of large HTML code, parse it and only after that process.  Now there is a problem with the restriction on getting users, their friends and groups, but this limit does not really hinder at this stage.  Then you have to solve it the same way as the first one. <br><br>  The text in the modern Internet every day becomes less significant.  For many years, VKontakte has many groups with videos, pictures and music.  And to get good recommendations you need to process them. <br><br><img src="https://habrastorage.org/webt/k_/do/fk/k_dofkqnhrqjioy1mplfkzktysy.png"><br><br>  But this is not the text and we need truly serious computing power.  For example, this is a top-end video card, but now I don‚Äôt have it, but I don‚Äôt want to take a server for all of this (it‚Äôs too early).  But in general, I already have the neural network architecture for this task.  I'm going to use some kind of neuron to classify images, ‚Äúcutting off‚Äù the upper part from it, which is responsible for the classification of objects itself.  All that will map the signs of the image will remain.  I, probably, will compress this card with one more encoder and that's it, all subsequent operations are similar to ‚Äútext‚Äù. <br><br>  There remains one more unresolved question regarding how many requests to the VKontakte site I can do per unit of time.  Or for the day.  Now I have not rested on this restriction, but it can happen at the most inappropriate moment. <br><br><h1>  Future plans </h1><br>  I urgently need a beautiful dashboard and statistics.  It is already in the initial state, but it must be finished.  From it I want to manage the start / stop of microservices (namely, the engine consists of them), the size of the queues, the processing speed and all that.  Well, statistics, who would not want to look at your numbers?  Of course, I need to optimize everything and make it suitable for users, in particular, I need to redo the external part of the site, since it does not meet my standards of convenience. <br><br><h1>  Conclusion </h1><br>  I managed to embark on the path of creating a service with an interesting (at least for me) structure that I am going to use for one of the competitions, allowing me to enter the best university in Russia (I will not say what kind of first non-classical one is).  I think that if you still have to work, you can squeeze out of it something more interesting, for example, the analyzer of the quality of publications, make analytics service for the community administration or something else. <br><br>  I came across many things from the text above for the first time.  This means that something I could do wrong.  If my readers know what can be improved / corrected, where I may have other problems, and so on - please write about it in the comments.  And I ask for criticism about the very quality of the article, so that I can improve it in the next times.  Thank. </div><p>Source: <a href="https://habr.com/ru/post/436636/">https://habr.com/ru/post/436636/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>