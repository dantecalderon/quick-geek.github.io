<div class="post__text post__text-html js-mediator-article">  In addition to our last <a href="https://habr.com/ru/post/434514/">article</a> on decrypting DPAPI blobs, we’ll tell you about two more cases we had to face.  It will be about saved passwords in MS IE11 and Edge browsers. <br><br>  The strategy remains the same - we will decipher everything in offline mode.  For this you need to pick up the necessary files. <br><br>  Depending on the operating system (Windows 7 or higher), saved passwords should be searched in two places: <br><br>  In the case of Windows 7, this is the registry branch. <br><br><pre><code class="plaintext hljs">HKEY_CURRENT_USER\Software\Microsoft\Internet Explorer\IntelliForms\Storage2</code> </pre> <br>  In the case of Windows 8 and higher - the storage of Windows Vault. <br><br>  It should also be noted that on Windows 7, http basic authorization passwords are also stored in the Windows Vault, so it will not hurt to pick it up anyway. <br><br>  Well, according to the good old tradition - all this is of course encrypted through DPAPI mechanisms. <br><br>  Now consider the decryption algorithm in more detail. <br><a name="habracut"></a><br><h3>  Windows 7 + IE11 (Edge) </h3><br>  As mentioned above, passwords are stored in the registry of the current user and are DPAPI blobs encrypted with the user's master key. <br><br>  But there is an important difference - when encrypting a password, entropy is applied.  Entropy is the URL by which the password is entered in the format <code>("https://url"+"\x00").lower().encode("utf-16-le")</code> . <br><br>  <b>To decrypt the password you need to know the full URL!</b>  No other way. <br><br>  But so that IE himself knows how to decrypt the password - this URL is hashed and stored in the registry as the key name with the DPAPI-blob. <br><br>  Consider a small example.  For <code>https://rdot.org/forum/</code> saved password will look like this: <br><br><pre> <code class="plaintext hljs">A88E21329B5372B856CE238B79D1F28D8EA1FD359D REG_BINARY 01000000D08C9DDF0115D1118C7A00C......BC310C51EE0F9B05D</code> </pre> <br>  Where <br>  A88 ... is a hashed URL <code>https://rdot.org/forum/</code> <br>  01000000D08C ... - DPAPI blob containing username and password <br><br>  URL hashing algorithm is straightforward.  More information about him can be read in the CIA-shnyh developments <a href="https://wikileaks.org/ciav7p1/cms/index.html">Vault7</a> . <br><br>  On python, it looks like this: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> hashlib url = <span class="hljs-string"><span class="hljs-string">"https://rdot.org/Forum/"</span></span>.lower() + <span class="hljs-string"><span class="hljs-string">"\x00"</span></span> url_utf_16_le = url.encode(<span class="hljs-string"><span class="hljs-string">"utf-16-le"</span></span>) sha1obj = hashlib.sha1(url_utf_16_le) urldigest = sha1obj.digest() checksum = <span class="hljs-number"><span class="hljs-number">0</span></span> len(urldigest) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> abyte <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> urldigest: checksum = (checksum + (ord(abyte))) &amp; <span class="hljs-number"><span class="hljs-number">0xFF</span></span> hash = sha1obj.hexdigest().upper() cksum = <span class="hljs-string"><span class="hljs-string">"%02X"</span></span> % checksum reg_value_name = <span class="hljs-string"><span class="hljs-string">"%s%s"</span></span> % (hash, cksum) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> reg_value_name</code> </pre> <br>  The list of the last 50 entered URLs can also be found in the registry: <br><br><pre> <code class="plaintext hljs"> HKEY_CURRENT_USER\Software\Microsoft\Internet Explorer\typedurls</code> </pre> <br>  Let's go back to the example.  Suppose we need to find in the registry the saved password from <code>https://rdot.org/forum/</code> . <br><br>  Substituting the value of the URL in the conversion script - we get the value <br><br><pre> <code class="plaintext hljs">A88E21329B5372B856CE238B79D1F28D8EA1FD359D</code> </pre> <br>  The key with this name we need to find in the registry <br><br><pre> <code class="xml hljs">req query "HKEY_USERS\<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SID</span></span></span><span class="hljs-tag">&gt;</span></span>\Software\Microsoft\Internet Explorer\IntelliForms\Storage2"</code> </pre> <br>  If such a key is found, it must be copied to the file as hex values ​​(that is, interpreted as the key value as a hex blob) and decrypted as a DPAPI-blob using entropy: <code>("https://rdot.org/forum/".lower() + "\x00").encode("utf-16-le") <br></code> <code>("https://rdot.org/forum/".lower() + "\x00").encode("utf-16-le") <br></code> <br><br>  For decoding, you can use dpapick, making the appropriate changes to account for the entropy in decoding. <br><br>  In the examples / filegeneric.py file, the function call <br><br><pre> <code class="python hljs"> probe.try_decrypt_with_password(options.password, mkp, options.sid)</code> </pre> <br>  replaced by <br><br><pre> <code class="python hljs">probe.try_decrypt_with_password(options.password, mkp, options.sid, entropy=(<span class="hljs-string"><span class="hljs-string">"https://rdot.org/forum/"</span></span>.lower() + <span class="hljs-string"><span class="hljs-string">"\x00"</span></span>).encode(<span class="hljs-string"><span class="hljs-string">"utf-16-le"</span></span>))</code> </pre> <br>  and then call dpapick as usual: <br><br><pre> <code class="xml hljs"> ./filegeneric.py --sid <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SID</span></span></span><span class="hljs-tag">&gt;</span></span> --masterkey <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">mk</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">dir</span></span></span><span class="hljs-tag">&gt;</span></span> --password <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">..</span></span></span><span class="hljs-tag">&gt;</span></span> --inputfile <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dpapi</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">blob</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">from</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">registry</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  If the master key is decrypted correctly, then at the output we will get the saved login and password (after a certain amount of service binary data). <br><br><h3>  Windows 8.1 and above </h3><br>  In the case of saving passwords on Win8 and higher, passwords from http forms, as well as http basic authorization, are stored in Windows Vault.  And what is good - along with the password, the full URL of the site to which it fits is saved. <br><br>  Vault itself is encrypted in two steps - first, the entire data block is encrypted with AES, and the symmetric key for decryption is encrypted with DPAPI and saved to a file.  The full encryption-decryption algorithm is described in the article by the guys from <a href="http://blog.digital-forensics.it/2016/01/windows-revaulting.html">Zena Forensics</a> . <br><br>  They also developed special decryptors for Windows Vault based on dpapick (dpapilab).  You can take them on the ZF <a href="https://github.com/mis-team/dpapilab">gith</a> or download the fork from our <a href="https://github.com/mis-team/dpapilab">github</a> . <br><br>  The Vault repository is located in the user profile: <br><br><pre> <code class="xml hljs">C:\Users\<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">user</span></span></span><span class="hljs-tag">&gt;</span></span>\AppData\Local\Microsoft\Vault\<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">GUID</span></span></span><span class="hljs-tag">&gt;</span></span>\</code> </pre> <br>  Inside a .vpol file is a DPAPI blob, encrypted with a user's key, and storing an AES-key to decrypt .vcrd <br><br>  To decrypt Vault you need to run: <br><br><pre> <code class="python hljs">./vaultdec.py --masterkey &lt;mk dir&gt; --sid &lt;SID&gt; --password &lt;<span class="hljs-keyword"><span class="hljs-keyword">pass</span></span>&gt; &lt;VAULT DIR&gt;</code> </pre> <br>  Instead of a password, you can use a domain key, as shown in the <a href="https://habr.com/ru/post/434514/">previous article</a> .  It should also be noted that if the Credential Roaming policy is enabled on the machine in the domain, then the Windows Vault data will be stored in ldap.  You can read about this in our first article about DPAPI. <br><br>  A small addition: for the script to work correctly, you will most likely need to install the old Python libs: <br><br><pre> <code class="plaintext hljs">apt install python-construct.legacy</code> </pre> <br><h3>  Crib </h3><br>  To decrypt passwords from IE, Edge and passwords stored in Windows, you need to collect: <br><br>  <b>c Vault catalog</b> <br><br><pre> <code class="xml hljs">c:\Users\<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">user</span></span></span><span class="hljs-tag">&gt;</span></span>\AppData\Local\Microsoft\Vault\<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">GUID</span></span></span><span class="hljs-tag">&gt;</span></span>\</code> </pre> <br>  <b>directory with master keys</b> <br><br><pre> <code class="xml hljs">c:\Users\<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">user</span></span></span><span class="hljs-tag">&gt;</span></span>\AppData\roaming\microsoft\Protect\<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SID</span></span></span><span class="hljs-tag">&gt;</span></span>\</code> </pre> <br>  <b>registry key contents</b> <br><br><pre> <code class="xml hljs">HKEY_USERS\<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SID</span></span></span><span class="hljs-tag">&gt;</span></span>\Software\Microsoft\Internet Explorer\IntelliForms\Storage2 HKEY_USERS&gt;\<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SID</span></span></span><span class="hljs-tag">&gt;</span></span>\Software\Microsoft\Internet Explorer\typedurls</code> </pre> <br>  In addition, you need to know the user's password or domain dpapi backup-key to decrypt without a password. </div>