<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Android, Rx and Kotlin or how to make the claw of Lego shrink. Part 1</title>
  <meta name="description" content="Hello, Habr lovers! By a lucky chance, in August 2018 I was lucky to start working with my comrade ( kirillskiy ) on a project of amazing interestingn...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>Android, Rx and Kotlin or how to make the claw of Lego shrink. Part 1</h1><div class="post__text post__text-html js-mediator-article">  Hello, Habr lovers!  By a lucky chance, in August 2018 I was lucky to start working with my comrade ( <a href="https://habr.com/ru/users/kirillskiy/" class="user_link">kirillskiy</a> ) on a project of amazing interestingness.  And so, in the daytime we were ordinary programmers, and at night we were programmers who struggle with motion recognition issues for people with functional limitations of their limbs, of course, healthy people could use this, using similar technology in a variety of ways. <br><a name="habracut"></a><br>  In <a href="https://habr.com/ru/post/437888/">this article</a> , Kirill tells in general about the project, but I will tell you in more detail and touch on the topic of the android in it. <br>  I will tell you first about the project in its entirety, what we have invented and how we wanted to implement it: <br><br>  1) <a href="https://ru.wikipedia.org/wiki/%25D0%25AD%25D0%25BB%25D0%25B5%25D0%25BA%25D1%2582%25D1%2580%25D0%25BE%25D0%25BC%25D0%25B8%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D1%2584%25D0%25B8%25D1%258F">EMG</a> (Electromyography - recording of the electrical activity of the muscles) was chosen as a way to obtain data (oh yes, there will be a lot of data).  For the first time this method was applied in 1907, so we walked the beaten track. <br><br>  2) Found an 8-channel EMG sensor working via bluetooth (even having its own API, which in the end turned out to be absolutely useless, because I had to connect independently as a BT device. Thanks at least they wrote the specification) <br><br>  3) We decided that everything will work like this: <br><br><ul><li>  training mode.  We put the sensor on the forearm, choose the type of movement that we will train.  For example ... "bending the brush."  and start the turnout (12 times we repeat the movement).  The data received at this moment will be saved and sent later to the server, where we will teach the neural network (calmly, I will tell you about it too) </li><li>  recognition mode directly movement.  Data taken in the process of movement is already compared with the model obtained as a result of training the neural network.  Based on the results, we will already get ‚ÄúFOLDING THE BRUSH‚Äù, for example. </li><li>  driving mode.  It is necessary according to a certain type of movement, to force something to move.  For example, a manipulator assembled in the kitchen from a designer (PPC, which is expensive) of a famous Danish manufacturer. </li></ul><br>  4) Item Android.  I am an Android developer - and it was a sin not to use it.  The Android does this: <br><br><ul><li>  finds all available BT devices </li><li>  connects to the sensor </li><li>  draws a graph based on data taken from the sensors (8 channels, frequency 200 Hz).  8 beautiful, multicolored curves. </li><li>  implements a training mode (selection of the type of the learner movement, training start button, data sending button) </li><li>  implements client-server interaction.  It is necessary to send data to the server to learn the neural network. </li><li>  realizes connection and interaction with the Raspberry PI 3B, to which the motors, which drive the manipulator, are soldered. </li></ul><br>  5) Raspberry PI 3B.  it was on raspberries that we put Android Things, and then we lifted the BT server on it, which receives messages from the Android device and moves the corresponding motors driving the super-claw from LEGO. <br><br>  6) Server.  Deployed by Docker locally on a computer.  Accepts the data sent by your device, trains the neural network, returns the model. <br><br>  <i><b>Part number 1. Android.</b></i>  <i><b>This time we will consider the under hood space of the project, concerning Android before the data is sent to the server.</b></i> <br><br>  It is called NUKLEOS (https://github.com/cyber-punk-me/nukleos) <br>  Stack: <br><br>  - Kotlin <br>  - MVP <br>  - Dagger2 <br>  - Retrofit2 <br>  - RxKotlin, RxAndroid <br><br>  for raspberry: <br><br>  -Android things <br><br>  At work, they do not let me play with architecture, and then finally there is an opportunity to play around with an old toy called MVP. <br><br>  The application consists of one BottomNavigation Style Activation and 4 fragments: <br>  The first one is <i>‚ÄúList of all available BT devices‚Äù</i> <br><br>  We chose the 8 channel BT sensor, which had its own API for working with BT.  Unfortunately, api turned out to be absolutely useless, for he immediately suggested defining one of 6 (like) movement types, but the recognition accuracy was 80% - and this is no good.  Well, we needed actual data.  The value of changes in bioelectric potentials that occur in the muscles of a person when muscle fibers are excited.  And for this it was necessary to work with this sensor directly.  The creators have left a description of the protocol of working with him, so it took not so long to pick one.  I can describe an example of working with bare BT devices in a separate article, if it is interesting, but in brief it looks like this: <br><br><pre><code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BluetoothConnector</span></span></span></span>(<span class="hljs-keyword"><span class="hljs-keyword">val</span></span> context: Context) { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> mBTLowEnergyScanner <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> lazy { (context.getSystemService(Activity.BLUETOOTH_SERVICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> BluetoothManager) .adapter.bluetoothLeScanner } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mBluetoothScanCallback: BluetoothScanCallback? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-comment"><span class="hljs-comment">// scan. fun startBluetoothScan(serviceUUID: UUID?) = Flowable.create&lt;BluetoothDevice&gt;({ mBluetoothScanCallback = BluetoothScanCallback(it) if (serviceUUID == null) { mBTLowEnergyScanner.startScan(mBluetoothScanCallback) } else { mBTLowEnergyScanner.startScan( arrayListOf(ScanFilter.Builder().setServiceUuid(ParcelUuid(serviceUUID)).build()), ScanSettings.Builder().setScanMode(ScanSettings.SCAN_MODE_LOW_LATENCY).build(), mBluetoothScanCallback) } }, BackpressureStrategy.BUFFER).apply { doOnCancel { mBTLowEnergyScanner.stopScan(mBluetoothScanCallback) } } // scan with timeout fun startBluetoothScan(interval: Long, timeUnit: TimeUnit, serviceUUID: UUID? = null) = startBluetoothScan(serviceUUID).takeUntil(Flowable.timer(interval, timeUnit)) inner class BluetoothScanCallback(private val emitter: FlowableEmitter&lt;BluetoothDevice&gt;) : ScanCallback() { override fun onScanResult(callbackType: Int, result: ScanResult?) { super.onScanResult(callbackType, result) result?.let { it.device.apply { emitter.onNext(this) } } } override fun onScanFailed(errorCode: Int) { super.onScanFailed(errorCode) emitter.onError(RuntimeException()) } } }</span></span></code> </pre> <br>  Carefully wrap the standard BT service in the RX and get less pain. <br><br>  Next, we launch the scan, and thanks to rx on the subscription we form a list of all devices, cramming them into RecyclerView: <br><br><pre> <code class="kotlin hljs">mFindSubscription = mFindFlowable ?.subscribeOn(Schedulers.io()) ?.observeOn(AndroidSchedulers.mainThread()) ?.subscribe({ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (it !<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> mBluetoothStuffManager.foundBTDevicesList) { addSensorToList(SensorStuff(it.name, it.address)) mBluetoothStuffManager.foundBTDevicesList.add(it) } }, { hideFindLoader() showFindError() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mBluetoothStuffManager.foundBTDevicesList.isEmpty()) { showEmptyListText() } }, { hideFindLoader() showFindSuccess() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mBluetoothStuffManager.foundBTDevicesList.isEmpty()) { showEmptyListText() } })</code> </pre> <br>  Select one of the devices, select it, and go to the next screen: <br>  <i>"Sensor Settings"</i> <br><br>  We connect to it and start streaming the sensor data using the commands we prepared in advance.  Fortunately, the protocol of work with this device by the creators of the sensor is described: <br><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">object</span></span> CommandList { <span class="hljs-comment"><span class="hljs-comment">//Stop the streaming fun stopStreaming(): Command { val command_data = 0x01.toByte() val payload_data = 3.toByte() val emg_mode = 0x00.toByte() val imu_mode = 0x00.toByte() val class_mode = 0x00.toByte() return byteArrayOf(command_data, payload_data, emg_mode, imu_mode, class_mode) } // Start streaming (with filter) fun emgFilteredOnly(): Command { val command_data = 0x01.toByte() val payload_data = 3.toByte() val emg_mode = 0x02.toByte() val imu_mode = 0x00.toByte() val class_mode = 0x00.toByte() return byteArrayOf(command_data, payload_data, emg_mode, imu_mode, class_mode) } .....</span></span></code> </pre> <br>  Working with the device is also carefully wrapped in rx to work without pain. <br><br>  Sensors return ByteArrei naturally, and it was necessary to gash the converter, the frequency of operation of the sensors is 200 Hz ... if it is interesting, I can describe in detail (well, or look at the code), but in the end we work with a sufficiently large amount of data this way: <br><br>  1 - We need to draw the curves of each of the sensors.  Of course, that drawing ABSOLUTELY all the data makes no sense, because on a mobile device it makes no sense for the eye to consider 200 changes per second on each sensor.  Therefore, we will not take everything. <br><br>  2 - We need to work with the entire volume of data, if it is a process of learning or recognition. <br><br>  for these needs, the RX is perfect with all its filters. <br><br>  Charts had to make their own.  Who cares - see PowerfullChartsView in the views folder. <br><br>  And now a little video: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/pBnoCYWC6y0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  In the video you will see how Cyril works with the system as a whole.  The video is working with the model.  But the model is on the server.  In the future, it will of course be on the device, which will significantly speed up the response) <br><br>  Write, what aspects are interesting, what to tell in more detail.  Naturally, we are working on the project and are open to your suggestions. <br><br>  <b>All project on github <a href="https://github.com/cyber-punk-me">here</a></b> </div><p>Source: <a href="https://habr.com/ru/post/438034/">https://habr.com/ru/post/438034/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>