<div class="post__text post__text-html js-mediator-article">  This article is for those who use G Suite and 1C. <br><br>  PIK Digital is an IT company that makes construction technological.  Last year we transferred the PIK Group of Companies to the <a href="https://gsuite.digital/">G Suite</a> .  In order to fully work with Google Spreadsheets and Documents, it was necessary to refine our systems. <br><br>  One of these improvements is the extension for uploading reports and 1C forms to Google Disk in the format of <a href="https://www.google.com/intl/ru/sheets/about/">Google Tables</a> and <a href="https://www.google.com/docs/about/">Google Docs</a> .  In the article we will share a ready-made solution and useful information on its implementation.  Expansion is free.  Take and use. <br><br>  <a href="https://s.pik.ru/g1ccfe">Download</a> extension <br>  <a href="https://s.pik.ru/g1ccode">View</a> code on github <br><br><img src="https://habrastorage.org/webt/g_/k8/i6/g_k8i6ikwt9gk_by1qkgodwpy7w.jpeg"><br><a name="habracut"></a><br>  To work expansion will require: <br><br><ol><li>  Sign up for a Google Account </li><li>  Create a project in the Google Cloud Platform </li><li>  Create OAuth Client </li><li>  Configure access to Google Drive API </li><li>  Install extension 1C </li><li>  Set up a connection to Google API in 1C </li></ol><br>  Next, we consider each stage separately and give code examples. <br><br><h2>  Google Account Registration </h2><br>  To work you need a <a href="https://accounts.google.com/signup/v2/webcreateaccount%3Fservice%3Daccountsettings">Google account</a> .  Without it, the extension will not be able to interact with the G Suite services.  Already have a valid account - use it. <br><br><h2>  Creating a project in GCP </h2><br>  To activate access to the Google Drive API, you need to create a project in the <a href="https://cloud.google.com/">Google Cloud Platform</a> (GCP).  There are <a href="https://cloud.google.com/free/">two options</a> for free work with GCP: <br><br><ul><li>  A 12-month trial period with a budget of $ 300. </li><li>  Always Free — access most GCP resources. </li></ul><br>  Both methods have limitations, more about them described in <a href="https://cloud.google.com/free/docs/gcp-free-tier">here</a> .  We recommend the option with a 12-month trial period.  After the trial period expires, the money will not be debited unless you start using paid services.  Everything you need for integration work for free. <br><br>  We register the project using the <a href="https://console.cloud.google.com/">console.cloud.google.com</a> link, click “Select a project”, then “Create a project”.  After creating the project, select it by pressing the button “Select project” again. <br><br><img src="https://habrastorage.org/webt/-m/q5/lz/-mq5lzrbqzwx7g3dconm7-x17ng.png"><br><br><h3>  Creating an OAuth Client </h3><br>  Create credentials to connect to G Suite using OAUth 2.0 protocol.  In GCP, we go to the menu item "API and services" - "Credentials" - "Create credentials" - "OAUth key identifier". <br><br>  You will be prompted to create an access request window.  This window is formed when the user is asked permission to access his data. <br><br><img src="https://habrastorage.org/webt/82/xt/sm/82xtsmkgs70pbswjvomkwjojtsk.png"><br><br>  Leave the “Open Access” access type and enter the name of the application, which will be displayed when the employee starts the project and requires consent to access the data.  Click “Save”. <br><br>  After that, set the "Application Type".  Select Other Types and enter your OAuth Client ID.  Please note that this is not the same as the display name of the application.  As a result, a window opens with the ID and secret of the client.  Save them, this is important. <br><br><h2>  Connecting the Google Drive API library </h2><br>  To gain access to the API functionality, go to the “API Library” menu item, find the required library and enable it. <br><br><img src="https://habrastorage.org/webt/mc/d9/sa/mcd9sasmv9p1ca1usutujkn5xra.png"><br><br>  Since we want to work with the G Suite formats, we need to connect the Google Drive API library to the project.  In addition, we need the Google Sheets API library, Google Docs API.  Find and connect it in the same way. <br><br><h2>  Installing an extension in user mode </h2><br>  Now it is possible to form requests to the API.  Recall: our task is to upload data from the 1C report of a standard form to Google Spreadsheet or Google Document. <br><br>  <a href="https://s.pik.ru/g1ccfe">Download</a> extension 1C. <br><br>  In 1C there is an opportunity to independently install configuration extensions.  If this is your first challenge, watch our short <a href="https://youtu.be/ojdUtFGojgY">video</a> on how to do it. <br><br>  Our extension works with the platform starting with version 8.3.10, on configurations of BP (starting with 3.0.65 and higher), ERP (starting with 2.4.6 and higher) and UT (starting with 11.4.6 and higher). <br><br>  If you see a security warning when you install the extension, click Yes.  You will see a message stating that "The current execution of the action was interrupted to issue a warning."  This means that you have enabled the safe mode, therefore, the procedure for adding an extension must be repeated, and the safe mode must be disabled.  After adding restart 1C. <br><br>  If the installation was successful, then you will see the "Save to Google Drive" button in reports and print forms. <br><br><img src="https://habrastorage.org/webt/jv/ca/ma/jvcama-ei85tl4nwyqt-rujwpr4.png"><br><br><h2>  Setting parameters for connecting to Google API in 1C </h2><br>  It remains to configure the settings for connecting to the Google API, and you can work.  Again select the menu item "All functions" and in the section "Processing" look for the item "Connection parameters to Google API." <br><br><img src="https://habrastorage.org/webt/nl/yq/lw/nlyqlwepq_bqvzjweiyerukenio.png"><br><br>  We fill in the Clientid, Clientsecret and “Port” fields with the values ​​obtained when creating a project in GCP.  By default, the file name and the folder where the temporary keys used for the connection will be stored are substituted.  Key data (refresh and access-tokens) of a user is saved for security purposes in the current user's temporary files directory, in the folder &lt;folder name&gt; and in the file &lt;file name&gt;.  If the same Google project is created in different configurations, you can make the file name the same in all of them, so as not to create multiple files with the same information.  When you save the connection settings are stored in the storage of general settings. <br><br><h2>  Saving a report </h2><br>  Now you can save reports in Google Spreadsheets and Google Docs formats on <a href="https://drive.google.com/drive/u/0/my-drive">Google Drive</a> . <br><br>  When you first try to save a report, you will need to go through a one-time user authorization procedure in each configuration in order for the service to receive access rights to save data. <br><br><img src="https://habrastorage.org/webt/xi/qn/jt/xiqnjtmzavqmhxsileeempyf8j4.png"><br><br>  In the window that appears, enter your Gmail email address and password.  Further <br>  in the window that opens, click "Allow".  So you give the application to save information in your Google Drive. <br><br><img src="https://habrastorage.org/webt/-u/tj/yk/-utjykqwshmj99tr1cyry1plzee.png"><br><br>  You will need to enter the file name, select its type and directory to save on a shared or private disk.  Click “Save”.  After saving the report will open in the browser.  Enjoy watching. <br><br><h2>  The technical side of the issue </h2><br>  Now let's see how this works inside the 1C platform. <br>  To connect, the following query line is generated to the Google service: <br><br><pre><code class="1c hljs">АдресПодключения=<span class="hljs-string"><span class="hljs-string">"https://accounts.google.com/o/oauth2/auth"</span></span>+<span class="hljs-string"><span class="hljs-string">"?"</span></span> + <span class="hljs-string"><span class="hljs-string">"response_type=code"</span></span> + <span class="hljs-string"><span class="hljs-string">"&amp;client_id="</span></span> + ид_клиента + <span class="hljs-string"><span class="hljs-string">"&amp;redirect_uri=http://localhost"</span></span> + <span class="hljs-string"><span class="hljs-string">"&amp;access_type=offline"</span></span> + <span class="hljs-string"><span class="hljs-string">"&amp;scope=https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.apps.readonly https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.appdata https://www.googleapis.com/auth/drive.metadata;</span></span></code> </pre> <br>  client_id— customer ID, in which we previously saved the value of a variable. <br>  scope - addresses of the API libraries that we will use.  If you need to connect multiple libraries, list them separated by spaces. <br><br>  This query string is needed for a one-time connection of our client application to the Google service.  You can enter the query string in the browser, in response, the service will return a URL similar to the following: <br><br><pre> <code class="1c hljs">http:<span class="hljs-comment"><span class="hljs-comment">//localhost/?code=&lt;КОД&gt;&amp;scope=https://www.googleapis.com/auth/admin.directory.user%20https://www.googleapis.com/auth/admin.directory.orgunit</span></span></code> </pre> <br>  You can add a field for HTML data in the 1C form designer and execute a query through it.  We need from this URL to get the value of &lt;CODE&gt; - service access code. <br><br>  It remains to receive two tokens by making an HTTP request.  As a result, the query returns a string with the access and refresh values ​​in JSON format.  Refresh-token does not lose relevance over time, and access-token lives 60 minutes and then requires updating.  To obtain these tokens, we will need the just received &lt;CODE&gt;, as well as the client identifier and secret that we saved earlier. <br><br>  The code could be something like this: <br><br><pre> <code class="1c hljs">Сервер = <span class="hljs-string"><span class="hljs-string">"accounts.google.com"</span></span>; Ресурс = <span class="hljs-string"><span class="hljs-string">"/o/oauth2/token"</span></span>; СтрокаЗапроса = <span class="hljs-built_in"><span class="hljs-built_in">СтрШаблон</span></span>(<span class="hljs-string"><span class="hljs-string">"client_id=%1&amp;client_secret=%2&amp;grant_type=authorization_code&amp;code=%3&amp;redirect_uri=http://localhost"</span></span>, ид_клиента, секрет_клиента, КодДоступа); Соединение = <span class="hljs-keyword"><span class="hljs-keyword">Новый</span></span> <span class="hljs-type"><span class="hljs-type">HTTPСоединение</span></span>(Сервер,<span class="hljs-number"><span class="hljs-number">443</span></span>,,,,,<span class="hljs-keyword"><span class="hljs-keyword">Новый</span></span> <span class="hljs-type"><span class="hljs-type">ЗащищенноеСоединениеOpenSSL</span></span>); Заголовки = <span class="hljs-keyword"><span class="hljs-keyword">Новый</span></span> <span class="hljs-type"><span class="hljs-type">Соответствие</span></span>; Заголовки.Вставить(<span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span>,<span class="hljs-string"><span class="hljs-string">"application/x-www-form-urlencoded”) ЗапросHTTP = Новый HTTPЗапрос(Ресурс,Заголовки); ЗапросHTTP.УстановитьТелоИзСтроки(СтрокаЗапроса); Ответ = Соединение.ВызватьHTTPМетод("</span></span>POST<span class="hljs-string"><span class="hljs-string">", ЗапросHTTP); Если НЕ Ответ.КодСостояния = 200 Тогда ОбщегоНазначенияКлиентСервер.СообщитьПользователю(СтрШаблон("</span></span>Ошибка получения параметров авторизации: %<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-string"><span class="hljs-string">", Ответ.ПолучитьТелоКакСтроку())); Возврат; КонецЕсли; Строка = Ответ.ПолучитьТелоКакСтроку(); Чтение = Новый ЧтениеJSON(); Чтение.УстановитьСтроку(Строка); Фабрика = ФабрикаXDTO.ПрочитатьJSON(Чтение); Чтение.Закрыть(); ТокенДоступа = Фабрика.access_token; ТокенОбновления = Фабрика.refresh_token; ВремяЖизниТокена = Фабрика.expires_in;</span></span></code> </pre><br>  The expires_in variable contains the lifetime of the access token. <br>  The following is a request to update the token: <br><br><pre> <code class="1c hljs">Сервер = <span class="hljs-string"><span class="hljs-string">"accounts.google.com"</span></span>; Ресурс = <span class="hljs-string"><span class="hljs-string">"/o/oauth2/token"</span></span>; ТокенОбновления = GoogleНастройки.refresh_token; ид_клиента = GoogleНастройки.client_id; секрет_клиента = GoogleНастройки.client_secret; СтрокаЗапроса = <span class="hljs-string"><span class="hljs-string">"grant_type=refresh_token"</span></span> + <span class="hljs-string"><span class="hljs-string">"&amp;client_id="</span></span> + ид_клиента + <span class="hljs-string"><span class="hljs-string">"&amp;client_secret="</span></span> + секрет_клиента + <span class="hljs-string"><span class="hljs-string">"&amp;refresh_token="</span></span> + ТокенОбновления;</code> </pre><br><h2>  Saving a tabular document to Google Drive </h2><br>  Now let's see how to save a spreadsheet document on Google Drive and then convert it to Google Tables format. <br><br><pre> <code class="1c hljs"><span class="hljs-comment"><span class="hljs-comment">//разделитель для HTTP сообщения Разделитель = "file_for_drive"; //определяем HTTP заголовок по типу файла ЗаголовокПоТипуФайла = СоответствиеТипуФайлаЗаголовкамGoogle()[ТипФайла]; ЗаголовкиОсновногоЗапроса.Вставить("Content-Type", "multipart/related; boundary=" + Разделитель); //----- //первый запрос //----- //заголовки Заголовки = Новый Массив; Заголовки.Добавить("Content-Type: application/json; charset=UTF-8"); //запрос метаданных //формируем json с параметрами имя файла, заголовок и родитель ТелоЗапроса = СформироватьТелоЗапросаСозданиеФайлаGSs(ИмяФайла, ЗаголовокПоТипуФайла, id_папки); ДвоичныеДанныеСообщения = GoogleAPI_ОбщегоНазначения.СоздатьСообщение_Текст(Заголовки, ТелоЗапроса); //----- //конец первого запроса //----- //----- //второй запрос //----- //заголовки Заголовки.Очистить(); Заголовки.Добавить("Content-Type: " + ЗаголовокПоТипуФайла); Заголовки.Добавить("uploadType: media"); //запрос метаданных ВременныйФайл = ПолучитьИмяВременногоФайла(ТипФайла); ТабДок.Записать(ВременныйФайл, ТипТабличногоДокументаПоТипуФайла()[ТипФайла]); ДвоичныеДанныеФайла = GoogleAPI_ОбщегоНазначения.СоздатьСообщение_Файл(Заголовки, Новый ДвоичныеДанные(ВременныйФайл)); //----- //конец второго запроса //----- //----- // Формируем основное составное сообщение. МассивСообщений = Новый Массив; МассивСообщений.Добавить(ДвоичныеДанныеСообщения); МассивСообщений.Добавить(ДвоичныеДанныеФайла); ДвоичныеДанныеТело = GoogleAPI_ОбщегоНазначения.ПолучаемДвоичныеДанныеДляПакетныхСообщенийHTTP(Разделитель, МассивСообщений); //----- ЗапросHTTP = Новый HTTPЗапрос("/upload/drive/v2/files" + "?uploadType=multipart&amp;convert=true",ЗаголовкиОсновногоЗапроса); ЗапросHTTP.УстановитьТелоИзДвоичныхДанных(ДвоичныеДанныеТело); Ответ =Соединение.ВызватьHTTPМетод("POST", ЗапросHTTP); Если Не Ответ.КодСостояния = 200 Тогда ТекстОшибок = "Ошибка HTTP запроса " + Ответ.ПолучитьТелоКакСтроку() + ", код ошибки " + Ответ.КодСостояния; GoogleAPI_ОбщегоНазначения.ЗаписьОшибкиПриРаботеСGS(ТекстОшибок, ". Запись документа"); Возврат ""; КонецЕсли; HTTPСоединение = Неопределено; ЗапросHTTP = Неопределено; Попытка УдалитьФайлы(ВременныйФайл); Исключение ЗаписьЖурналаРегистрации("Удалить файлы",УровеньЖурналаРегистрации.Ошибка,,,ОписаниеОшибки()); КонецПопытки; ОтветHTTPТело = Ответ.ПолучитьТелоКакСтроку(); ОбъектJSON = GoogleAPI_ПроцедурыРаботыСGSheets.СформироватьЗначениеОбъектаJSON(ОтветHTTPТело); //возвращаем ссылку на документ из google drive Возврат GoogleAPI_ПроцедурыРаботыСGSheets.ПрочитатьСвойствоВСтрокеОбъектаJSON(ОбъектJSON, "alternateLink");</span></span></code> </pre><br>  This code uses the <a href="https://developers.google.com/drive/api/v2/manage-uploads">multipart upload</a> method to upload a file. <br>  We form a POST request from two data blocks.  In the first block, write the title and mimeType of the file.  In the second block, the contents of the file are transferred.  Blocks are defined by separators, which are specified at the end and beginning of the block. <br><br>  Learn more about this in the <a href="https://developers.google.com/drive/api/v2/reference/files/insert">article</a> on inserting Google Drive knowledge base files. <br><br>  This is how it works.  We hope that now you will not waste time converting the data unloaded from 1C. <br><br>  The author of our extension is the leading developer of PIK Digital Brazhnikova Maria <a href="https://habr.com/ru/users/mbrazh/" class="user_link">mbrazh</a> </div>