<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to take control of network infrastructure. Part Three Network security Continuation</title>
  <meta name="description" content="This is the second part of the chapter ‚ÄúNetwork Security‚Äù (which in turn is the third part of the series ‚ÄúHow to take control of the network infrastru...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-6974184241884155",
      enable_page_level_ads: true
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>How to take control of network infrastructure. Part Three Network security Continuation</h1><div class="post__text post__text-html js-mediator-article">  <i>This is the second part of the chapter ‚ÄúNetwork Security‚Äù (which in turn is the third part of the series ‚ÄúHow to take control of the network infrastructure‚Äù).</i>  <i>In the <a href="https://habr.com/ru/post/435138/">first part of</a> this chapter, we looked at some aspects of the network security of the Data Center segment.</i>  <i>This chapter will focus on the ‚ÄúInternet Access‚Äù segment.</i> <br><br><img src="https://habrastorage.org/webt/90/cg/fg/90cgfgwjckdeac9trcmr6gifhcy.png" alt="image"><br><br><h1>  Internet access </h1><br>  Security is undoubtedly one of the most complex topics in the world of data networks.  As in previous cases, without pretending to the depth and completeness, I will consider here quite simple, but, in my opinion, important questions, the answers to which, I hope, will help raise the level of security of your network. <br><br>  When auditing this segment, pay attention to the following aspects: <br><br><ul><li>  design </li><li>  BGP settings </li><li>  DOS / DDOS protection </li><li>  firewall traffic filtering </li></ul><a name="habracut"></a><br><h3>  Design </h3><br>  As an example of the design of this segment for an enterprise network, I would recommend a <a href="https://www.cisco.com/c/dam/en/us/solutions/collateral/enterprise/design-zone-security/safe-architecture-guide-pin-secure-internet-edge.pdf">guide</a> from Cisco within the <a href="https://www.cisco.com/c/en/us/solutions/enterprise/design-zone-security/landing_safe.html">SAFE model</a> . <br><br>  Of course, perhaps the decision of other vendors will seem more attractive to you (see the <a href="https://researchcenter.paloaltonetworks.com/2018/10/palo-alto-networks-seven-time-gartner-magic-quadrant-leader/">Gartner quadrant for 2018</a> ), but without urging you to follow this design in detail, I still find it useful to understand the principles and ideas underlying it. <br><blockquote>  <b>Comment</b> <br><br>  In SAFE, the ‚ÄúRemote Access‚Äù segment is part of ‚ÄúInternet Access‚Äù.  But in this series of articles we will consider it separately. </blockquote>  The standard set of equipment in this segment for an enterprise network (enterprise network) is <br><br><ul><li>  border routers (border routers) </li><li>  firewalls </li></ul><br><blockquote>  <b>Remark 1</b> <br><br>  In this series of articles, when I talk about firewalls, I mean <a href="https://en.wikipedia.org/wiki/Next-generation_firewall">NGFW</a> . </blockquote><blockquote>  <b>Remark 2</b> <br><br>  I omit consideration of various types of L2 / L1 or overlay L2 over L3 solutions necessary for providing L1 / L2 connectivity and I limit myself only to questions of level L3 and higher.  In part, L1 / L2 issues were addressed in the chapter ‚Äú <a href="https://habr.com/ru/post/434750/">Cleaning and Documentation</a> ‚Äù. </blockquote>  If you did not find a firewall in this segment, then you should not rush to conclusions. <br><br>  Let us, as in the <a href="https://habr.com/ru/post/435138/">previous part</a> , begin with the question, is it necessary to use a firewall in this segment in your case? <br><br>  I can say that this seems to be the most justified place for using firewalls and for applying complex traffic filtering algorithms.  In <a href="https://habr.com/ru/post/435138/">Part 1,</a> we mentioned 4 factors that can prevent the use of firewalls in the data center segment.  But here they are not so significant. <br><blockquote>  Example 1. <b>Delay</b> <br><br>  With regard to the Internet, it makes no sense to talk about delays, even about 1 millisecond.  Therefore, the delay in this segment cannot be a factor limiting the use of the firewall. </blockquote><blockquote>  Example 2. <b>Performance</b> <br><br>  In some cases, this factor can still be significant.  Therefore, it is possible that you will have to bypass the firewall by passing some traffic (for example, traffic load balancers). </blockquote><blockquote>  Example 3. <b>Reliability</b> <br><br>  This factor still needs to be taken into account, but still, given the unreliability of the Internet itself, its importance for this segment is not as significant as for the data center. <br><br>  So, suppose your service lives over http / https (with short sessions).  In this case, you can use two independent boxes (without HA) and in case of a problem with one of them, by routing, transfer all traffic to the second. <br><br>  Or you can use firewalls in transporter mode and, if they fail to resolve the problem, let traffic bypass firewalls. </blockquote>  Therefore, it is more likely that only the <b>price</b> can be the factor that will force you to abandon the use of firewalls in this segment. <br><blockquote>  <b>Important!</b> <br><br>  There is a temptation to combine this firewall with the data center firewall (use one firewall for these segments).  The decision, in principle, is possible, but you need to understand that  "Internet Access" firewall actually stands at the forefront of your defense and "takes over" at least part of the malicious traffic, then, of course, you need to take into account the increased risk that this firewall will be disabled.  That is, using the same devices in these two segments, you will significantly reduce the availability of your data center segment. </blockquote>  As usual, it should be understood that, depending on the service the company provides, the design of this segment can be very different.  As usual, you can choose different approaches depending on your requirements. <br><blockquote>  <b>Example</b> <br><br>  If you are a content provider, with a CDN network (see, for example, a <a href="https://habr.com/ru/users/ramax/posts/">series of articles</a> ), then you may not want to create tens or even hundreds of infrastructure presence points using separate devices for routing and filtering traffic.  It will be expensive, and just may be redundant. <br><br>  For BGP, you don‚Äôt need to have dedicated routers at all, you can use open-source tools like <a href="https://www.quagga.net/">Quagga</a> .  Therefore, perhaps all you need is a server or several servers, a switch and BGP. <br><br>  In this case, your server or several servers can play the role of not only the CDN server, but also the router.  Of course, there are still a lot of details (for example, how to ensure balancing), but this is realizable, and we have successfully applied this approach for one of our partners. <br><br>  You can have several data centers with full protection (firewalls, DDOS protection services provided by your Internet providers) and dozens or hundreds of ‚Äúsimplified‚Äù points of presence with only L2 switches and servers. <br><br>  But what about the protection in this case? <br><br>  Let's look at, for example, the recently popular <a href="https://www.cloudflare.com/learning/ddos/dns-amplification-ddos-attack/">DNS Amplification DDOS attack</a> .  Its danger lies in the fact that a large amount of traffic is generated, which simply ‚Äúclogs‚Äù 100% of all your uplinks. <br><br>  What we have in the case of our design. <br><br><ul><li>  if you use AnyCast, the traffic is distributed between your points of presence.  If the total bandwidth of yours is terabits, then this in itself (in fact, there have been several attacks with malicious traffic of the terabit order recently) prevents you from overflowing uplinks </li><li>  if, however, some uplinks are ‚Äúhammered‚Äù, then you simply take this site out of service (stop announcing the prefix) </li><li>  You can also increase the share of traffic sent from your ‚Äúfull-fledged‚Äù (and, accordingly, protected) data centers, thus removing a significant portion of malicious traffic from unprotected points of presence </li></ul><br>  And a small note to this example.  If you give enough traffic through IXs, this also reduces your exposure to such attacks. </blockquote><h3>  BGP Setup </h3><br>  There are two topics here. <br><br><ul><li>  Connectivity </li><li>  BGP Setup </li></ul><br>  We have already talked a bit about connectivity in <a href="https://habr.com/ru/post/435138/">part 1</a> .  The bottom line is that traffic to your customers goes the best way.  Although, optimality is not always about delay, but usually it is low latency that is the main indicator of optimality.  For some companies it is more important, for others - less.  It all depends on the service you provide. <br><blockquote>  <b>Example 1</b> <br><br>  If you are an exchange, and for your customers important time intervals are less than milliseconds, then, of course, there is no question of any kind of Internet. </blockquote><blockquote>  <b>Example 2</b> <br><br>  If you are a gaming company, and tens of milliseconds are important to you, then, of course, connectivity is very important to you. </blockquote><blockquote> <b>Example 3</b> <br><br>  You also need to understand that, due to the properties of the TCP protocol, the data transfer rate within one TCP session also depends on RTT (Round Trip Time).  CDN networks are also built to solve this problem, bringing the content distribution servers closer to the consumer of this content. </blockquote>  The study of connectivity is a separate interesting topic, worthy of a separate article or series of articles and requires a good understanding of how the Internet works. <br><br>  Useful resources: <br><br>  <a href="https://ripe.net/">ripe.net</a> <br>  <a href="https://bgp.he.net/">bgp.he.net</a> <br><blockquote>  <b>Example</b> <br><br>  I will give just one small example. <br><br>  Suppose your data center is in Moscow and you have a single uplink - Rostelecom (AS12389).  In this case (single homed) you do not need BGP, and you most likely use the address pool from Rostelecom as public addresses. <br><br>  Suppose that you provide a certain service, and you have a sufficient number of customers from Ukraine, and they complain of long delays.  In the study, you found that the IP addresses of some of them are in the grid 37.52.0.0/21. <br><br>  By running traceroute, you saw that the traffic was going through AS1299 (Telia), and by ping, you got an average RTT of 70 - 80 milliseconds.  You can see it also on <a href="http://lg.ip.rt.ru/">Rostelecom's looking glass</a> . <br><br>  With the whois utility (on ripe.net or a local utility) you can easily determine that the block 37.52.0.0/21 belongs to AS6849 (Ukrtelecom). <br><br>  Further, going to <a href="https://bgp.he.net/">bgp.he.net</a> you see that AS6849 has no relationship with AS12389 (they are neither clients nor uplinks to each other, nor do they have peering).  But if you look at the <a href="https://bgp.he.net/AS6849">list of peers</a> for AS6849, then you will see, for example, AS29226 (Mastertel) and AS31133 (Megafon). <br><br>  By finding these providers' looking glass, you can compare the path and RTT.  For example, for Mastertel RTT will be about 30 milliseconds. <br><br>  So, if the difference between 80 and 30 milliseconds is essential for your service, then perhaps you need to think about connectivity, get your AS number, your address pool in RIPE, and add additional uplinks and / or create points of presence on IXs. </blockquote><br>  With BGP, you not only have the opportunity to improve connectivity, but you also reserve your internet connection. <br><br>  <a href="https://www.ssi.gouv.fr/uploads/2016/03/bgp-configuration-best-practices.pdf">This document</a> provides guidelines for configuring BGP.  Despite the fact that these recommendations were developed on the basis of the ‚Äúbest practice‚Äù of providers, still (if your BGP settings are not quite elementary) they are undoubtedly useful and should actually be part of the hardening that we discussed in the <a href="https://habr.com/ru/post/435138/">first part</a> . <br><br><h3>  DOS / DDOS protection </h3><br>  Now DOS / DDOS attacks have become a daily reality for many companies.  In fact, in one form or another, you are attacked quite often.  The fact that you do not notice this yet indicates only that a targeted attack has not yet been organized against you, and that the means of protection that you use even without knowing it (various built-in protection of operating systems), are sufficient to minimize the degradation of the service provided for you and your customers. <br><br>  There are Internet resources that, based on logs from equipment, draw beautiful attack maps in real time. <br><br>  <a href="https://www.csoonline.com/article/3217944/security/8-top-cyber-attack-maps-and-how-to-use-them.html">Here</a> you can find links to them. <br><br>  My favorite <a href="https://threatmap.checkpoint.com/ThreatPortal/livemap.html">card</a> from CheckPoint. <br><br>  DDOS / DOS protection is usually layered.  To understand why, you need to understand what types of DOS / DDOS attacks exist (see, for example, <a href="https://www.csoonline.com/article/3222095/network-security/ddos-explained-how-denial-of-service-attacks-are-evolving.html">here</a> or <a href="https://blog.thousandeyes.com/three-types-ddos-attacks/">here</a> ) <br><br>  That is, we have three types of attacks: <br><br><ul><li>  volumetric attacks </li><li>  protocol attacks </li><li>  application attacks </li></ul><br>  If you can defend yourself against the last two types of attacks using firewalls, for example, then you will not defend yourself against attacks aimed at ‚Äúoverflowing‚Äù your uplinks (of course, if your total capacity of Internet channels is not calculated as terabits, but better than terabit). <br><br>  Therefore, the first line of defense is protection against ‚Äúvolumetric‚Äù attacks, and your provider or providers owe this protection to you.  If you have not realized this yet, then you are just lucky. <br><blockquote>  <b>Example</b> <br><br>  Suppose you have several uplinks, but only one of the providers can provide you with this protection.  But if all the traffic goes through one provider, then how is the connectivity, which we briefly discussed a little earlier? <br><br>  At the time of the attack, you will have to partly sacrifice connectivity in this case.  But <br><br><ul><li>  This is only for the duration of the attack.  In the case of an attack, you can manually or automatically reconfigure BGP, so that the traffic goes only through the provider that provides you with an umbrella.  After the end of the attack, you can return the routing to its previous state </li><li>  It is not necessary to transfer all traffic.  If, for example, you see that through some uplinks or peering does not attack (or traffic is not significant) you can continue to announce prefixes with competitive attributes in the direction of these BGP neighbors. </li></ul></blockquote><br>  You can also outsource protection from ‚Äúprotocol attacks‚Äù and ‚Äúapplication attacks‚Äù to partners. <br>  Here you can read a good study ( <a href="https://habr.com/company/hosting-cafe/blog/324848/">translation</a> ).  True, the article is two years ago, but it will give you an idea of ‚Äã‚Äãthe approaches, how you can defend against DDOS attacks. <br><br>  In principle, you can restrict yourself to this, having completely surrendered your protection to outsourcing.  There are advantages to this decision, but there is also an obvious minus.  The fact is that we can talk (again, depending on what your company does) about business survival.  And trust such things to third-party organizations ... <br><br>  Therefore, let's consider how to organize the second and third lines of defense (as an addition to the protection from the provider). <br><br>  So, the second line of defense is filtering and policers at the entrance to your network. <br><blockquote>  <b>Example 1</b> <br><br>  Suppose that you ‚Äúclosed the umbrella‚Äù from DDOS using one of the providers.  Suppose that this provider uses Arbor to filter traffic and filters at the edge of its network. <br><br>  The band that Arbor can ‚Äúprocess‚Äù is limited, and the provider, of course, cannot constantly pass the traffic of all its partners who have ordered this service through filtering equipment.  Therefore, under normal conditions, traffic is not filtered. <br><br>  Suppose that there is an attack SYN flood.  Even if you have ordered a service in which in the event of an attack, traffic is automatically transferred to filtering, this does not happen instantly.  For a minute or more, you remain under attack.  And this may lead to the failure of your equipment or degradation of the service.  In this case, the restriction of traffic at the boundary routing, though, will lead to the fact that some TCP sessions will not be established during this time, but it will save your infrastructure from more large-scale problems. </blockquote><blockquote>  <b>Example 2</b> <br><br>  An abnormally large number of SYN packets can be not only the result of a SYN flood attack.  Let's assume that you provide a service in which you can have about 100 thousand TCP connections at the same time (in one data center). <br><br>  Suppose that as a result of a short-term problem with one of your main providers, you have ‚Äúkicked‚Äù half of the sessions.  If your application is designed in such a way that it ‚Äúwithout thinking twice‚Äù immediately (or after some interval of the same time for all sessions) tries to re-establish the connection, then you will receive approximately at least 50 thousand SYN packets at the same time. <br><br>  If, for example, ssl / tls handshake should work on top of these sessions, which involves the exchange of certificates, then from the point of view of resource exhaustion for your load balancer, this will be a much stronger DDOS than a simple SYN flood.  It would seem that the balancers should work out such an event, but ... unfortunately, we are faced with such a problem. <br><br>  And, of course, a policer on the border router will save your equipment in this case too. </blockquote>  The third level of DDOS / DOS protection is the settings of your firewall. <br><br>  Here you can stop both attacks of the second and third types.  In general, everything that reaches the firewall can be filtered here. <br><blockquote>  <b>The board</b> <br><br>  Try to give the firewall as little work as possible by filtering as much as possible on the first two lines of defense.  And that's why. <br><br>  It didn‚Äôt happen to you that accidentally generating traffic to check, for example, how resistant your servers operating system to DDOS attacks were, did you ‚Äúkill‚Äù your firewall, loading it 100 percent, while using traffic with normal intensity?  If not, then maybe just because you haven't tried? <br><br>  In general, the firewall, as I said, is a tricky thing, and it works well with known vulnerabilities and tested solutions, but if you send something unusual, just some garbage or packages with incorrect headers, then you‚Äôve got some so small (based on my experience), the probability can enter into a stupor and top equipment.  Therefore, at stage 2, using normal ACLs (at the L3 / L4 level), allow only the traffic that should go into your network. </blockquote><h3>  Firewall traffic filtering </h3><br>  We continue to talk about the firewall.  It should be understood that DOS / DDOS attacks are just one of the types of cyber attacks. <br><br>  In addition to DOS / DDOS protection, we can still have something like the following list of features: <br><br><ul><li>  application firewalling </li><li>  threat prevention (antivirus, anti-spyware, and vulnerability) </li><li>  URL filtering </li><li>  data filtering (content filtering) </li><li>  file blocking (file types blocking) </li></ul><br>  You decide what you need from this list. <br><br>  <i>To be continued</i> </div><p>Source: <a href="https://habr.com/ru/post/436230/">https://habr.com/ru/post/436230/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>