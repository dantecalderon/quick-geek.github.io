<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>What would the Internet system look like in the game EvE Online</title>
  <meta name="description" content="EvE online is an exciting game. This is one of the few MMOs in which there is only one ‚Äúserver‚Äù to enter, which means that everyone plays in the same ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>What would the Internet system look like in the game EvE Online</h1><div class="post__text post__text-html js-mediator-article">  EvE online is an exciting game.  This is one of the few MMOs in which there is only one ‚Äúserver‚Äù to enter, which means that everyone plays in the same logical world.  She also had an exciting set of events that occurred inside the game, and she also remains a very visually appealing game: <br><br><div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;">  Your browser does not support HTML5 video. <source src="https://blog.benjojo.co.uk/asset/FIm6v3lfJe" type="video/mp4"></video></div></div></div><br>  There is also an extensive map of the world on which all these players can be placed.  At its peak, EvE had 63,000 online players in one world with 500,000 paid subscriptions at its peak of popularity, and although this number is getting smaller every year, the world remains incredibly large.  This means that the transition from one side to the other is a significant amount of time (as well as the risk due to the player‚Äôs dependence on the faction). <br><a name="habracut"></a><br>  <em><font color="#999999">The translation was made with the support of the company <a href="https://www.edsd.com/">EDISON Software</a> , which professionally deals with <a href="https://www.edsd.com/about/blog/global-security-exchange-2018">security</a> , as well as develops <a href="https://www.edsd.com/electronic-health-checkup-system-for-people-responsible-for-the-safety-of-others">electronic medical verification systems</a> .</font></em> <br><br>  You travel to different areas using the warp mode (within the same system), or jump into different systems using the jump gate: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1fe/3ff/d88/1fe3ffd887f5e0363abc0a9f39902242.jpg" alt="image"><br><br>  And all these systems combine to create a map of beauty and complexity: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/66a/8fb/f44/66a8fbf446875bd2f216108b35ac2ca0.png" alt="image"><br><br>  I have always viewed this map as a network, it is a large network of systems that connect with each other so that people can pass through them, and most systems have more than two hopping gates.  It made me think about what would happen if you literally took the idea of ‚Äã‚Äãa map as a network?  What will the EvE Internet system look like? <br><br>  To do this, we need to understand how the real Internet works.  The Internet is a large collection of ISPs that are all numerically identified using a standardized and unique ISP number called an autonomous system number or ASN (or AS for a shorter version).  This AS needs a way to exchange routes with each other, since they will own IP address ranges, and they need a way to inform other ISPs that their routers can route these IP addresses.  For this, the world settled on a border gateway protocol or BGP. <br><br>  BGP works by ‚Äúcommunicating‚Äù to other AS (known as a node) their routes: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a07/42e/d75/a0742ed752b8f9b79ab16182a074d2cc.gif" alt="image"><br><br>  The standard behavior of BGP when it receives a route from a node is to transfer it to all other nodes to which it is also connected.  This means that the nodes will automatically share their routing tables with each other. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f71/49a/451/f7149a451a34f6a1ee77688078976719.gif" alt="image"><br><br>  However, this behavior is only useful if you use BGP to send routes to internal routers, since the modern Internet has different logical relationships with each other.  Instead of a network, the modern Internet looks like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d80/72b/010/d8072b010c3c2d32e124481d331d81fc.png" alt="image"><br><br>  However, EvE online is installed in the future.  Who knows if the Internet relies on this routing scheme for profit.  Let's imagine that this is not so that we can see how BGP is scaled in larger networks. <br><br>  To do this, we need to simulate the actual behavior of the BGP router and the connection.  Considering that EvE has a relatively low 8000 ~ number of systems, and a reasonable 13.8 thousand connections between them.  I assumed that it would actually be impossible to run 8000 ~ virtual machines with real BGP and a network to figure out how these real systems look when they act together as a network. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2bd/8ee/2c7/2bd8ee2c761ab5829dc9074147963918.png" alt="image"><br><br>  However, we do not have unlimited resources, so we will need to find a way to make the smallest Linux image, both when using disk space and when using memory.  To do this, I paid attention to embedded systems, because embedded systems often have to work in environments with very low levels of resources.  I came across <a href="https://buildroot.org/">Buildroot</a> , and after a few hours I had a small Linux image containing only what I needed to run this project. <br><br><pre><code class="plaintext hljs">$ ls -alh total 17M drwxrwxr-x 2 ben ben 4.0K Jan 22 22:46 . drwxrwxr-x 6 ben ben 4.0K Jan 22 22:45 .. -rw-r--r-- 1 ben ben 7.0M Jan 22 22:46 bzImage -rw-r--r-- 1 ben ben 10M Jan 22 22:46 rootfs.ext2</code> </pre> <br>  This image contains bootable linux, which also has: * <a href="https://bird.network.cz/">Bird 2</a> BGP Daemon * <a href="http://manpages.ubuntu.com/manpages/trusty/man8/tcpdump.8.html">tcpdump</a> and My Traceroute (mtr) for network debugging * <a href="http://manpages.ubuntu.com/manpages/trusty/man8/mtr.8.html">busybox</a> for the base shell and system utilities <br><br>  This image can be easily launched in qemu with a small number of options: <br><br><pre> <code class="plaintext hljs">qemu-system-i386 -kernel ../bzImage \ -hda rootfs.ext2 \ -hdb fat:./30045343/ \ -append "root=/dev/sda rw" \ -m 64</code> </pre> <br>  For networking, I decided to use the undocumented function from qemu (in my version), in which you can send two qemu processes to each other and use UDP sockets to transfer data between them.  This is convenient, as we plan to provide a large number of links, so using the usual <a href="https://en.wikibooks.org/wiki/QEMU/Networking">TUN / TAP</a> adapter method can quickly lead to confusion. <br><br>  Since this function is partly undocumented, there were some problems with its work.  It took me a long time to understand that the network name on the command line should be the same for both sides of the connection.  Later it turned out that this function is already well documented, as is usually the case.  Changes take time to get to older versions of the distribution. <br><br>  As soon as it worked, we had a couple of virtual machines that could send packets between themselves, and the hypervisor sends them as UDP datagrams.  Since we will be launching a large number of such systems, we will need a quick way to configure them using the previously created configuration.  To do this, we can use the convenient qemu function, which allows you to take a directory on the hypervisor and turn it into a virtual FAT32 file system.  This is useful because it allows us to create a directory for each system that we plan to run, and each qemu process points to that directory, which means that we can use the same boot image for all virtual machines in the cluster. <br><br>  Since each system has 64 MB of RAM, and we plan to use 8000 ~ VM, we certainly need a decent amount of RAM.  For this, I used 3 m2.xlarge.x86 with packet.net's, as they offer 256 GB of RAM with 2x Xeon Gold 5120, which means they have a decent amount of support. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/321/13f/e13/32113fe138c8a3eee531cc84d9f14c54.png" alt="image"><br><br>  I used <a href="https://github.com/mickdekkers/eve-map-json">another open source project</a> to create an EvE map in the form of JSON, and then created a custom configuration program based on this data.  Having conducted several test runs of just a few systems, I proved that they can take configuration from VFAT and establish BGP sessions with each other about this. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/257/ce0/34e/257ce034ea2f1a15863ed3382b4a83da.png" alt="image"><br><br>  So, I took the decisive step to loading the universe: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/47e/48a/5b4/47e48a5b49dc9368406289539bfda294.png" alt="image"><br><br>  At first, I tried to run all the systems in one big event, but, unfortunately, this led to a big bang for the system boot, so after that I switched to launching the system every 2.5 seconds and 48 system cores took care of this. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e5f/ab2/779/e5fab2779ad34e3407278b86016f9f2e.png" alt="image"><br><br>  During the boot process, I found that you would see large explosions of CPU usage over all virtual machines, I later found out that these were large parts of the universe, connecting with each other, thus causing large amounts of BGP traffic on both sides of newly connected virtual networks. machines. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/af2/450/930/af2450930f669d1311f9ccf641784cce.png" alt="image"><br><br><pre> <code class="plaintext hljs">root@evehyper1:~/147.75.81.189# ifstat -i bond0,lo bond0 lo KB/s in KB/s out KB/s in KB/s out 690.46 157.37 11568.95 11568.95 352.62 392.74 20413.64 20413.64 468.95 424.58 21983.50 21983.50</code> </pre><br>  In the end, we saw some pretty awesome BGP paths, since each system advertises / 48 IPv6 addresses, you can see the routes to each system and to all other systems that it would have to go through to get there. <br><br><pre> <code class="plaintext hljs">$ birdc6 s ro all 2a07:1500:b4f::/48 unicast [session0 18:13:15.471] * (100) [AS2895i] via 2a07:1500:d45::2215 on eth0 Type: BGP univ BGP.origin: IGP BGP.as_path: 3397 3396 3394 3385 3386 3387 2049 2051 2721 2720 2719 2692 2645 2644 2643 145 144 146 2755 1381 1385 1386 1446 1448 849 847 862 867 863 854 861 859 1262 1263 1264 1266 1267 2890 2892 2895 BGP.next_hop: 2a07:1500:d45::2215 fe80::5054:ff:fe6e:5068 BGP.local_pref: 100</code> </pre> <br>  I took a snapshot of the routing table on each router in the universe, and then depicted frequently used systems to access other systems, but this image is huge.  Here is a small version of this in a publication; if you click on an image, keep in mind <i>that this image will most likely cause your device to run out of memory.</i> <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/a95/a4c/d38/a95a4cd385aa56ef84c77431bda94365.png" alt="image"></a> <br><br>  After that, I thought, what else can you display on BGP routed networks?  Could you use a smaller model to test how the routing configuration works in large networks?  <a href="">I prepared a file that displayed the London Underground system to check this</a> : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4a6/4c2/141/4a64c2141edbe3c17b214bff95ea0a8f.gif" alt="image"><br><br>  The TFL system is much smaller and has much more jumps that have only one direction, since most stations have only one ‚Äúline‚Äù of transport, however we can extract one thing from this, we can use it to play safely with <a href="https://www.cisco.com/c/en/us/support/docs/ip/border-gateway-protocol-bgp/112965-bgpmed-attr-00.html">BGP MED</a> 's. <br><br>  However, there is a problem when we view the TFL card as a BGP network, in the real world the time / delay between each stop is not the same, and therefore, if we simulated this delay, we would not bypass the system as fast as we could, since we only look at the fewest stations to go. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/de7/348/f6f/de7348f6fa14df607cb749d3ea486bd7.png" alt="image"><br><br>  However, thanks to the Freedom of Information Act (FOIA), the request that was sent to the <a href="https://www.whatdotheyknow.com/request/distance_between_tfl_stations">TFL</a> provided us with the time needed to move from one station to another.  They were generated in a BGP router configuration, for example: <br><br><pre> <code class="plaintext hljs">protocol bgp session1 { neighbor 2a07:1500:34::62 as 1337; source address 2a07:1500:34::63; local as 1337; enable extended messages; enable route refresh; ipv6 { import filter{ bgp_med = bgp_med + 162; accept; }; export all; }; } protocol bgp session2 { neighbor 2a07:1500:1a::b3 as 1337; source address 2a07:1500:1a::b2; local as 1337; enable extended messages; enable route refresh; ipv6 { import filter{ bgp_med = bgp_med + 486; accept; }; export all; }; }</code> </pre> <br>  In <code>session1</code> time interval between two stations is 1.6 minutes, the other path from this station is 4.86 minutes.  This number is added to the route for each station / router through which it passes.  This means that each router / station in the network knows that it is time to get to each station through each route: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/35e/76c/024/35e76c02451330f4b569c7a9f97e9d69.png" alt="image"><br><br>  This means that traceroutes determine exactly how you can navigate around London, for example, to my station in Paddington: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5a3/cca/16b/5a3cca16b7325f156b09fac2dd8422db.png" alt="image"><br><br>  We can also have fun with BGP, simulating a maintenance or incident at Waterloo Station: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ae0/015/dfb/ae0015dfb28455d4124ce2ab2b7d01ec.png" alt="image"><br><br>  And as the entire network instantly chooses the next fastest route, not the one with the fewest passing stations. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8d3/808/055/8d380805595dbb0f0eed78a1aab1ab87.png" alt="image"><br><br>  And this is BGP MED magic in routing! <br><br>  The code for all this is already available.  You can create your own network structures with a fairly simple JSON schema, or simply use EvE online or TFL, as they are already in the repository. <br><br>  <a href="https://github.com/benjojo/eve-online-bgp-backbone">You can find all the code for this here.</a> </div><p>Source: <a href="https://habr.com/ru/post/439298/">https://habr.com/ru/post/439298/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
</ul></nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>