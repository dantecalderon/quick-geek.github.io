<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>NGINX Installation Instructions ModSecurity</title>
  <meta name="description" content="This article provides instructions for installing the Dynamic ModSecurity module on the NGINX web server as a web application firewall (WAF). NGINX wo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>NGINX Installation Instructions ModSecurity</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/fa/sb/hd/fasbhdxiqd3t7vsip3ugbjwqej8.png"><br><br>  This article provides instructions for installing the Dynamic ModSecurity module on the NGINX web server as a web application firewall (WAF).  NGINX works in <b>reverse proxy mode</b> .  Work done on the distribution of Linux - <b>CentOS 7</b> .  The module is set as ‚Äúdynamic‚Äù so that the service remains flexible in configuration.  Used <a href="https://www.nginx.com/resources/library/modsecurity-3-nginx-quick-start-guide/">official NGINX</a> installation <a href="https://www.nginx.com/resources/library/modsecurity-3-nginx-quick-start-guide/">guide</a> . <br><br><a name="habracut"></a><br><h3>  1. Pre-install components </h3><br>  For the service to work correctly, you need to install additional libraries to work.  Libraries will be needed to build a project from source code.  It is assumed that the user has updated the system ( <b><i># yum update</i></b> ). <br><br><pre><code class="bash hljs">yum install install -y apt-utils autoconf automake build-essential git libcurl4-openssl-dev libgeoip-dev liblmdb-dev libpcre++-dev libtool libxml2-dev libyajl-dev pkgconf wget zlib1g-dev</code> </pre> <br><br><h3>  2. Starting to install the service </h3><br><br>  In order that later there would be no problems with starting the service using the <b>service nginx start</b> command, the version from the official repository on GitHub is installed. <br><br>  Create a file <b><i>/etc/yum.repos.d/nginx.repo</i></b> in which you want to add a version of the distribution.  Without specifying the version of NGINX, the last one is pulled, which is launched on the site. <br><br><pre> <code class="plaintext hljs">[nginx] name=nginx repo baseurl=http://nginx.org/packages/mainline/centos/7/$basearch/ gpgcheck=0 enabled=1</code> </pre> <br>  Next, just install <br><br><pre> <code class="bash hljs">yum install nginx</code> </pre> <br><h3>  3. Compile a module </h3><br><img src="https://habrastorage.org/webt/jc/zf/e4/jczfe4wmx_pgsdlexdotbmdmbqo.png"><br><br>  To begin, go to the appropriate directory: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /home/user/Downloads</code> </pre> <br>  Download the module from the main branch on GitHub: <br><br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> --depth 1 -b v3/master --single-branch https://github.com/SpiderLabs/ModSecurity.git</code> </pre> <br>  Next, go to the folder with the firewall and compile the source code: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ModSecurity git submodule init git submodule update ./build.sh ./configure make make install</code> </pre> <br><h3>  4. Installation of the connector </h3><br>  In order for the entire system to be flexible, a connector will be installed for connecting <b>NGINX and ModSecurity</b> .  This means that the module will not be sewn into the server code, but will only be a dynamic component, which will allow it to be removed at any time, change the code, and so on. <br><br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> --depth 1 https://github.com/SpiderLabs/ModSecurity-nginx.git</code> </pre> <br><h3>  5. Rebuilding the web server </h3><br>  In order for NGINX to work with the connector to which the module will be connected, you need to rebuild the server.  To do this, first find out which version of NGINX is installed: <br><br><pre> <code class="bash hljs">nginx ‚Äìv</code> </pre> <br>  The output should be something like this (depending on the version) <br><br>  <i>nginx version: nginx / 1.13.7</i> <br><br>  Next, from the official site, download the appropriate version so that there would be no error when starting the service and compile with a certain parameter: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> .. wget http://nginx.org/download/nginx-1.13.7.tar.gz tar zxvf nginx-1.13.7.tar.gz <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> nginx-1.13.7 ./configure --with-compat --add-dynamic-module=../ModSecurity-nginx make modules</code> </pre><br>  Next, copy the module file to the web service folder: <br><br><pre> <code class="bash hljs">cp objs/ngx_http_modsecurity_module.so /etc/nginx/modules</code> </pre> <br>  Before the first block in <i><b>/etc/nginx/nginx.conf</b></i> add: <br><br><pre> <code class="plaintext hljs">load_module modules/ngx_http_modsecurity_module.so;</code> </pre> <br><h3>  6. Module configuration file </h3><br>  Developers offer their basic rules for protecting a web resource.  It should be noted that by setting them you should not count on a decent level, since the creators leave complete freedom of configuration and writing rules by the user, which limits them in adding basic rules to the standard configuration file. <br><br><pre> <code class="bash hljs">mkdir /etc/nginx/modsec <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /etc/nginx/modsec sudo wget https://raw.githubusercontent.com/SpiderLabs/ModSecurity/v3/master/modsecurity.conf-recommended sudo mv modsecurity.conf-recommended modsecurity.conf</code> </pre> <br><br>  In the <i><b>modsecurity.conf</b></i> file <i><b>,</b></i> replace <i>SecRuleEngine DetectionOnly</i> with <i>SecRuleEngine On</i> <br>  Next, create the file <b><i>/etc/nginx/modsec/main.conf</i></b> and finish it into it: <br><br><pre> <code class="plaintext hljs"># Include the recommended configuration Include /etc/nginx/modsec/modsecurity.conf</code> </pre> <br><h3>  7. OWASP rules </h3><br>  It's no secret that <a href="https://www.owasp.org/index.php/Main_Page"><b>OWASP</b></a> is a web security leader.  They have their own roll-set for this module, which, like the project, is open to users.  Therefore, we will install it as a basic set of rules: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> wget https://github.com/SpiderLabs/owasp-modsecurity-crs/archive/v3.0.0.tar.gz tar -xzvf v3.0.0.tar.gz mv owasp-modsecurity-crs-3.0.0 /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/owasp-modsecurity-crs-3.0.0 cp crs-setup.conf.example crs-setup.conf</code> </pre> <br>  Add the following to <b><i>/etc/nginx/modsec/main.conf</i></b> : <br><br><pre> <code class="plaintext hljs"># OWASP CRS v3 rules Include /usr/local/owasp-modsecurity-crs-3.0.0/crs-setup.conf Include /usr/local/owasp-modsecurity-crs-3.0.0/rules/*.conf</code> </pre><br><h3>  8. Completion of work </h3><br>  Add to <i><b>/etc/nginx/conf.d/proxy.conf</b></i> file <br><br><pre> <code class="plaintext hljs">server { listen 80; modsecurity on; modsecurity_rules_file /etc/nginx/modsec/main.conf; # If you have proxy location / { proxy_pass http://192.168.xx; } }</code> </pre> <br><h3>  9. Functioning test </h3><br>  To check the components of a web service, just run it and view the errors.  Often you will need to remove the rule that is responsible for checking where another module is used ( <i>GeoIP</i> , for example).  Therefore, we can safely remove this rule. <br><br><pre> <code class="bash hljs">rm /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/owasp-modsecurity-crs-3.0.0/rules/REQUEST-910-IP-REPUTATION.conf</code> </pre> <br>  <i>Unicode</i> error is also possible.  In order for it not to interfere with the work of the service, simply comment it out in the configuration file ( <i>at the end</i> ). <br><br><pre> <code class="plaintext hljs">#SecUnicodeMapFile unicode.mapping 20127</code> </pre> <br>  To test the server, use the <i><b>curl</b></i> utility.  It will show whether the application returns.  If everything is correct, you will receive an optet with the code <b>200 OK</b> <br><br><pre> <code class="bash hljs">curl -I 127.0.0.1</code> </pre> <br>  To test the protection mechanisms, you can use any dedicated utility.  As recommendations, it is proposed to use <i><b>nikto</b></i> : <br><br><pre> <code class="bash hljs">nikto -host localhost</code> </pre> <br>  To start the server: <br><br><pre> <code class="bash hljs">service nginx start</code> </pre> </div><p>Source: <a href="https://habr.com/ru/post/437032/">https://habr.com/ru/post/437032/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>