<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>For the sake of money: search and exploit vulnerabilities in mobile payment terminals</title>
  <meta name="description" content="Card payments are becoming increasingly popular. Mobile payment terminals (mPOS-terminals) contribute to the development of this trend, reducing barri...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-6974184241884155",
      enable_page_level_ads: true
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>For the sake of money: search and exploit vulnerabilities in mobile payment terminals</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/xa/ia/pm/xaiapmgmvndlezav6j6nglpfj5k.png"><br><br>  Card payments are becoming increasingly popular.  Mobile payment terminals (mPOS-terminals) contribute to the development of this trend, reducing barriers to entry into the market of card payments for small firms and private entrepreneurs.  Moreover, under certain conditions, operations can still be carried out in many countries (including Russia) with the help of a magnetic strip.  Each new round of technological progress endangers the payment ecosystem.  What security problems can easier access to the card payments market lead to?  And how do we risk continuing to rely on old card technologies, in particular, on the magnetic strip? <br><br>  In recent years, the number of operations carried out with the help of mPOS terminals has increased significantly.  Intense competition among mPOS providers has made it extremely easy to get such a payment terminal.  Signing a contract takes less than five minutes, and the mPOS terminals themselves are often provided free of charge.  Now they can be seen everywhere.  Like ordinary POS terminals, they are the final link in the payment infrastructure.  This makes them interesting and easily accessible to intruders. <a name="habracut"></a><br><br><h2>  Field of study </h2><br>  We evaluated the products of the leading suppliers of mPOS terminals: PayPal, Square, iZettle and SumUp.  Some of them provide services in several regions of the world.  We tried to access services in different regions where it was possible, since the payment process, applications and devices, as well as security settings differ depending on location. <br><br><table><tbody><tr><th>  Provider </th><th>  Manufacturer </th><th>  Terminal </th><th>  Region </th></tr><tr><td>  Square </td><td>  Square </td><td>  Terminal for contactless <br>  cards and cards with Square (S8) chip </td><td>  USA </td></tr><tr><td>  Square </td><td>  Square </td><td>  Terminal for magnetic cards <br>  Square (S4) </td><td>  USA </td></tr><tr><td>  Square </td><td>  Square </td><td>  Terminal for contactless cards and cards with Square (S8) chip </td><td>  Europe </td></tr><tr><td>  Square </td><td>  Square </td><td>  Terminal for magnetic cards Square (S4) </td><td>  Europe </td></tr><tr><td>  Square </td><td>  Miura Systems </td><td>  Miura M010 </td><td>  USA </td></tr><tr><td>  SumUp </td><td>  (not public) </td><td>  AIR1 E001 </td><td>  Europe </td></tr><tr><td>  iZettle </td><td>  DATECS </td><td>  YRWCRONE </td><td>  Europe </td></tr><tr><td>  Paypal </td><td>  Miura Systems </td><td>  Miura M010 </td><td>  Europe </td></tr></tbody></table><br>  <i>Manufacturers and suppliers of mPOS-terminals</i> <i><br></i> <br><br><img src="https://habrastorage.org/webt/e-/fe/ug/e-feug3evxfpow3aqhvqeojsdmk.png"><br><br>  <i>mPOS terminals</i> <br><br>  We analyzed the safety of devices in five categories: <br><br><ul><li>  communication between the telephone and the payment system server; </li><li>  communication between the phone and the mPOS terminal; </li><li>  physical protection mechanisms of the mPOS terminal; </li><li>  mobile app; </li><li>  additional factors affecting security, in particular, check-in during registration. </li></ul><br><br><img src="https://habrastorage.org/webt/pk/og/ww/pkogwwqnw26idbqqpxm4voirlle.png"><br><br>  <i>Main areas of research</i> <br><br><h2>  Payment process </h2><br>  We studied in detail the attack vectors and card payment security issues.  The vulnerabilities that we discovered threaten the basic functionality of the mPOS terminal. <br><br>  The main difference between mPOS and ordinary POS terminals is that the seller is not directly connected with the acquiring bank.  Instead, mPOS providers act as payment aggregators that charge a transaction fee.  Such payment services cannot always guarantee the level of security provided by the acquiring bank.  The mPOS providers minimize security risks in their own way, often shifting responsibility for fraud to the acquiring bank.  It is important to understand that such payment aggregators are in fact themselves sellers who interact with the acquiring bank. <br><br><img src="https://habrastorage.org/webt/au/gb/y9/augby98vtvh1jg-etwajrvec_yk.png"><br><br>  <i>Payment process through mPOS-terminal</i> <br><br><h2>  Risks when paying by card </h2><br>  There are various ways of card payments.  They depend on the payment system, issuer and country of issue.  During the transaction, the card transmits a list of supported cardholder verification methods (CVM), which describes the supported methods and their priority.  CVM also regulates what should happen if the selected method fails.  The terminal stores the configuration file, which also describes the supported verification methods.  The terminal compares these two files and tries to make a transaction using the first priority method.  The priority method should provide a high degree of assurance that the card holder was present during the operation. <br><br>  Some types of payments are obviously safer than others.  Payment by a card with a chip and using a PIN code is considered the safest method, because it gives a high degree of guarantee that the operation has been approved by the cardholder.  The magnetic stripe is considered to be a less secure technology, since an attacker can easily clone the magnetic stripe and Track2 data stored on it and forge the signature of the cardholder.  The operations carried out with the use of a magnetic strip do not give confidence that the card holder was indeed present at the transaction.  Unlike card operations that support the EMV standard, transactions using magnetic stripe pass without a cryptogram.  This means that such operations do not ensure the integrity and authenticity of the transaction during its execution. <br><br><h2>  Adopt EMV standard </h2><br>  More and more payments in the world are made according to the EMV standard (Europay, Mastercard, Visa), that is, with the help of chip cards.  However, the adoption of the standard in some regions is slower than in others.  In the US, EMV operations account for <a href="https://www.emvco.com/about/deployment-statistics/">less than half of all transactions</a> .  Most operations are still carried out using a magnetic strip.  In Europe, about 90% of all operations are <a href="http://cryptovision.com/wp-content/uploads/2017/07/Mindshare-2017-D1-1615-Cards-on-the-Table.pdf">carried out according to the EMV standard</a> . <br><br><h2>  Research results </h2><br><h3>  Manipulation with the device: sending arbitrary commands </h3><br>  An attacker can connect to the device via Bluetooth and perform arbitrary operations.  To do this, he needs information about Bluetooth services running on the device, as well as relevant characteristics and functions.  This information can be obtained using reverse engineering prior to the attack.  The attacker will only need access to the mPOS terminal, a phone that supports the registration of events of the host controller interface (HCI), and a mobile application.  With the help of HCI event logging, an attacker will try to get information about the main functions of the mPOS terminal.  For this, he will conduct trial operations using different methods of payment and comparing the results.  When the necessary information is received, the attacker will use Wireshark to analyze the communication between the phone and the mPOS terminal.  This information, as well as mobile application data, will allow you to map functions with their commands and identifiers.  Figure 5 shows the sending of the message ‚ÄúInsert (swipe) the card‚Äù to the display of the mPOS terminal. <br><br><img src="https://habrastorage.org/webt/xp/uc/e5/xpuce5dz8m9e_ciefjkz-x0iaxi.png"><br><br>  <i>The message "Insert (swipe) the card" sent to the display</i> <br><br>  If the card is inserted incorrectly, the error message "Please take the card" appears on the display.  In the HCI journal, we see which UUID is responsible for displaying text and an example of the data being sent. <br><br><img src="https://habrastorage.org/webt/7y/j2/_u/7yj2_ustnlxsmrefi4vye04vcdq.png"><br><br>  <i>The message "Please take away the card" on the display of the mPOS-terminal</i> <br><br><img src="https://habrastorage.org/webt/qk/jg/z7/qkjgz7gzzyikbyoau4jfb7se5m8.png"><br><br>  <i>The first Bluetooth package is responsible for sending the message "Please take away the card"</i> <br><br><img src="https://habrastorage.org/webt/3e/9e/mf/3e9emfxppsz8aarmis9omz-afk0.png"><br><br>  <i>The second Bluetooth packet is responsible for sending the message ‚ÄúPlease take away the card‚Äù (the message is divided into two packets due to the small maximum size of one Bluetooth Low Energy packet).</i> <br><br>  The figure below shows that the value sent to the mPOS terminal consists of five parts.  It includes a prefix containing the command identifier, the value of the counter of the commands sent and the size of the payload, the main text in the form of ASCII characters, as well as the postfix, the checksum value and the terminating byte. <br><br><img src="https://habrastorage.org/webt/6z/nc/cl/6zncclsmccsn-14_qanmg2owaz0.png"><br><br>  <i>Elements of two packages responsible for sending the message "Please take the card"</i> <br><br>  In the following example, the terminal uses Bluetooth Classic to communicate with the phone.  We see the message "Insert (swipe) the card", sent to the display terminal. <br><br><img src="https://habrastorage.org/webt/xv/wt/cv/xvwtcvk1v5rjg_snnwo9qowusea.png"><br><br>  <i>The message "Insert (swipe) the card" on the display of the mPOS-terminal</i> <br><br><img src="https://habrastorage.org/webt/aq/l1/y8/aql1y87kpcjsvftvpjozf4vnfhs.png"><br><br>  <i>Bluetooth package (in the Wireshark window), which is responsible for sending the message ‚ÄúInsert (draw) a card‚Äù on the display of the mPOS terminal</i> <br><br>  The figure below shows that this data consists of three parts: the prefix, the message and the checksum.  The prefix also contains a counter, a command ID, and a payload size.  The message contains the value "Insert (swipe) the card" in ASCII.  Checksum - XOR all bytes of the message. <br><br><img src="https://habrastorage.org/webt/a0/l_/_t/a0l__tkrs8cfhrvk_b0xime-g64.png"><br><br>  <i>Package elements responsible for sending the message ‚ÄúInsert (swipe) the card‚Äù</i> <br><br>  Using this information, you can create an arbitrary command and send it to the display of the mPOS terminal.  Three of the devices we tested were vulnerable to this attack vector. <br><br><table><tbody><tr><th>  Provider </th><th>  Manufacturer </th><th>  Reader </th><th>  Region </th></tr><tr><td>  SumUp </td><td>  (not public) </td><td>  AIR1 E001 </td><td>  Europe </td></tr><tr><td>  iZettle </td><td>  DATECS </td><td>  YRWCRONE </td><td>  Europe </td></tr><tr><td>  Square </td><td>  Square </td><td>  Square (S8) </td><td>  USA </td></tr></tbody></table><br>  <i>List of terminals vulnerable to sending arbitrary commands.</i>  <i>Despite the fact that the Square reader (S8) does not have a display, an attacker can send other arbitrary commands.</i> <br><br>  This attack vector can be used in conjunction with the exploitation of other vulnerabilities in order to offer the client less secure types of operations, for example, on a magnetic strip.  This scenario is described in figures 14‚Äì16.  In addition, an attacker may send a Payment Declined message to force the cardholder to conduct several transactions. <br><br><img src="https://habrastorage.org/webt/0m/dh/ve/0mdhvebsnwxbee9ynizxxri7t4y.png"><br><br>  <i>Card holder trying to insert a card</i> <br><br><img src="https://habrastorage.org/webt/vg/65/ao/vg65ao2-vj-kjf-l8e_lvgpllxk.png"><br><br>  <i>The message ‚ÄúPlease swipe the card‚Äù sent to the terminal display forces the card holder to use a magnetic stripe.</i> <br><br><img src="https://habrastorage.org/webt/xa/ia/pm/xaiapmgmvndlezav6j6nglpfj5k.png"><br><br>  <i>The operation was carried out successfully - for the operation performed using a magnetic strip, you must leave a signature.</i> <br><h3>  Counterfeit amount </h3><br>  There are different ways to intercept traffic between the mPOS terminal and the payment system server.  We have already described one of them - the registration of HCI events on a mobile phone and the analysis of the results obtained.  To do this, you must enable the developer (Android Developer Mode).  An attacker can go in other ways, for example, to intercept HTTPS traffic between the mobile application and the payment system server.  This is possible because in most cases the server of the payment system generates commands and sends them to the mPOS terminal.  To protect the mobile application from intercepting HTTPS, all suppliers of the terminals we tested use SSL pinning. <br><br>  The figure below is an example of an initialized payment, intercepted by two different methods.  We were able to intercept HTTPS traffic using a man-in-the-middle attack (man-in-the-middle), and so turned on the debug mode.  The amount of the transaction is given in unencrypted form.  A value of 0100 corresponds to ¬£ 1.00. <br><br><img src="https://habrastorage.org/webt/0t/fg/b1/0tfgb1b88efmnziflacwdd79zoa.png"><br><br>  <i>Initial payment made with the help of mPOS-terminal</i> <br><br>  By capturing HTTPS traffic, we can change the amount of the transaction.  Then you need to recalculate the checksum.  After that we can send the changed amount to the payment system server to confirm the transaction.  We found five terminals vulnerable to amount modification in magnetic stripe operations. <br><br><table><tbody><tr><th>  Provider </th><th>  Manufacturer </th><th>  Reader </th><th>  Region </th></tr><tr><td>  SumUp </td><td></td><td>  AIR1 E001 </td><td>  Europe </td></tr><tr><td>  iZettle </td><td>  DATECS </td><td>  YRWCRONE </td><td>  Europe </td></tr><tr><td>  Square </td><td>  Miura </td><td>  Miura M010 </td><td>  USA </td></tr><tr><td></td><td>  Miura </td><td>  Miura M010 </td><td>  USA </td></tr><tr><td>  Paypal </td><td></td><td></td><td></td></tr><tr><td>  Square </td><td>  Square </td><td>  Square </td><td>  USA / Europe </td></tr><tr><td></td><td></td><td>  Magstripe Reader (S4) </td><td></td></tr></tbody></table><br>  <i>mPOS terminals vulnerable to counterfeit amounts</i> <br><br>  A dishonest seller may fraudulently force the cardholder to confirm a transaction for a much larger amount.  During the operation, the seller displays one amount to the reader‚Äôs display, but the service is sent to the provider of the mPOS terminal to confirm a large amount.  This attack is shown in the figure below. <br><br><img src="https://habrastorage.org/webt/ic/__/az/ic__azi6tjkyktr6zt8aurmpgau.png"><br><br>  <i>Left: the amount sent to the server of the payment system (¬£ 1.23).</i>  <i>Right: the amount that the cardholder sees (¬£ 1)</i> <br><br>  Terminals supporting operations using magnetic stripe are affected.  During operations, the terminal sends only encrypted data to Track2;  the operation itself is not assured.  This attack vector will not work if the operation is performed according to the EMV standard, because in such operations the sum information is stored inside the cryptogram.  Contactless PayPass and payWave payments that support Legacy modes (PayPass MAGSTRIPE and PayWave MSD) do not provide this level of protection, since the amount information is also not protected by a cryptogram. <br><br>  To understand the scale of the problem, it suffices to recall that less than 50% of transactions in the United States are carried out according to the EMV standard.  In addition, the service providers tested by us set the limits for one operation using magnetic stripe in Europe and the USA is incredibly high, at ‚Ç¨ 50,000 and $ 50,000, respectively. <br><br>  This attack can be prevented by using cryptographic control of the integrity of the amount and currency fields and comparing the amount and currency of the operation on the reader with the amount confirmed by the service provider.  It is important to note that the PCI DSS standard (current version 3.2.1), which regulates the storage, processing and transmission of card data, does not require such checks in the case of operations using magnetic stripe.  The operation requires only the transfer of data Track2. <br><br><h2>  Remote code execution </h2><br>  Two of the terminals we tested were vulnerable to remote code execution.  Operation of this vulnerability provides an attacker with full access to the operating system of the terminal.  After the attacker gets full access to the operating system, he will be able to intercept Track2 data before encrypting or enable unencrypted mode (to send a command) on the terminal's keyboard to intercept the PIN code. <br><br><table><tbody><tr><th>  Provider </th><th>  Manufacturer </th><th>  Reader </th><th>  Region </th></tr><tr><td>  Square </td><td>  Miura </td><td>  Miura M010 </td><td>  USA </td></tr><tr><td>  Paypal </td><td>  Miura </td><td>  Miura M010 </td><td>  USA </td></tr></tbody></table><br>  <i>List of terminals vulnerable to remote code execution</i> <br><br><img src="https://habrastorage.org/webt/zr/cc/xz/zrccxz4y7tpgfq5kglfczvbsshw.png"><br><br>  <i>Movie Nyan Cat on the display of the terminal Miura M010.</i>  <i>Remote code execution allows an attacker full access to the terminal‚Äôs operating system.</i> <br><h2>  Physical protection </h2><br>  The physical protection mechanisms of most mPOS terminals are quite reliable.  The Square (S4) magnetic card reader does not guarantee the level of security and technological complexity characteristic of contactless and chip card readers.  However, this should be a standard requirement for a device that is provided to the seller free of charge.  The remaining terminals provide an adequate level of physical protection, support mechanisms to prevent the opening, and other measures to prevent hacking of hardware. <br><br><h2>  Anti-tamping mechanisms </h2><br>  Anti-tamping systems help prevent opening the terminal with a drill and other tools.  When attempting to open it, an electrical circuit is broken and the device stops working.  In addition, most readers operate on proprietary standards.  Without access to developer documentation, it is impossible to obtain valuable information by physically opening the device. <br><br><img src="https://habrastorage.org/webt/wv/zl/sp/wvzlsp2uy3w3nhqqqtq8x6otcdc.png"><br><br>  <i>Inside iZettle YRWCRONE</i> <br><br><img src="https://habrastorage.org/webt/vs/ai/0k/vsai0kqukwbdjssdgvcfhogumh0.png"><br><br>  <i>System for detecting attempts to open iZettle YRWCRONE</i> <br><br><h2>  Conclusion </h2><br>  We found that more than half of the mPOS terminals are vulnerable to attack, while all of the mPOS terminal providers we analyzed were generally vulnerable.  We have documented numerous serious security issues, in particular a vulnerability for executing arbitrary commands, forging a sum and executing remote code. <br>  Terminal hardware security mechanisms are in most cases reliable and advanced.  However, other aspects, such as those associated with the mobile application and the registration procedure, are much less secure. <br><br>  Developers of mPOS-terminals emphasize the ease of registration and use of devices.  These are key elements of a business model, but it does not take into account that a reduction in barriers to entry into the card payment market must be accompanied by a significant increase in security.  There is no doubt that the fraudulent actions of sellers will remain a serious problem for the suppliers of mPOS-terminals.  It is necessary to develop a serious approach to the problem of security, including verification during registration and strict monitoring of payments. <br><br><img src="https://habrastorage.org/webt/vc/du/ct/vcductrb5zp8du00x93mc3rsz2q.png"><br><br>  <b>Authors</b> : Lee-Ann Galloway, Timur Yunusov, Artem Ivachev, Mark Kerni, Alexey Stennikov |  Positive Technologies </div><p>Source: <a href="https://habr.com/ru/post/436952/">https://habr.com/ru/post/436952/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>