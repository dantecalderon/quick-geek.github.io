<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We deploy a virtual machine with Windows with a virtual video card forwarded with QEMU and Intel GVT-g</title>
  <meta name="description" content="How to make Intel GVT-g work 


 Hello! Intel offered an excellent solution to the perennial problem: "I have a laptop on Linux and I need to run Wind...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-6974184241884155",
      enable_page_level_ads: true
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>We deploy a virtual machine with Windows with a virtual video card forwarded with QEMU and Intel GVT-g</h1><div class="post__text post__text-html js-mediator-article"><h1 id="kak-zastavit-intel-gvt-g-rabotat">  How to make Intel GVT-g work </h1><br><p>  Hello!  Intel offered an excellent solution to the perennial problem: "I have a laptop on Linux and I need to run Windows with hardware acceleration, but I do not have a heavy laptop with two GPUs and liquid cooling."  Using the architecture of their own GPUs or something else, they managed to make it so that you can split your onboard Intel GPU into two or more GPUs. </p><br><p>  Unfortunately, this is by no means so simple ... The documentation is slightly outdated, and some things break in an incomprehensible way without an obvious reason.  Therefore, in this post I will tell you how to set up a hardware accelerated Windows virtual machine with cool fast virtio and Intel GVT-g drivers. </p><br><p>  To do this, you will need a more or less modern GPU ( <em>Translator's Note</em> : <em>according to <a href="https://github.com/intel/gvt-linux/wiki/GVTg_Setup_Guide">official documentation</a> , GVT-g supports integrated graphics cards starting from the fifth generation of Intel Core and from the fourth generation of Xeon</em> ). </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/760/a80/d5e/760a80d5edea70d7ba2eb33458205f89.jpg" alt="Windows screenshot"></p><a name="habracut"></a><br><h2 id="shag-1-nastraivaem-yadro">  Step 1: configure the kernel </h2><br><p>  Check that you have a fresh version of the kernel.  It seems that the options for GVT-g were included before version 4.8, but then they definitely worked worse, so I recommend using the latest available kernel.  If you are original enough to build your kernel, enable <a href="https://github.com/intel/gvt-linux/wiki/GVTg_Setup_Guide">these options</a> .  Also disable the removal of unused ksyms, since this option <a href="https://github.com/intel/gvt-linux/issues/57">causes a bug</a> . </p><br><p>  Now we need to correct the kernel command line arguments.  Important options are: </p><br><pre><code class="plaintext hljs">i915.enable_gvt=1 kvm.ignore_msrs=1 intel_iommu=on i915.enable_guc=0</code> </pre> <br><p>  Make sure you don‚Äôt redefine <code>enable_guc=0</code> with something that will turn on GuC booting, as this will lead to the depressing crash of the i915 driver.  When you boot, log into your work environment and check for the presence of the <code>/sys/bus/pci/devices/0000:00:02.0/mdev_supported_types/</code> directory.  If it does not exist, GVT-g does not work.  Check the logs and / or cry in the pillow. </p><br><p>  As a solution to the problem, you can add <a href="https://github.com/intel/gvt-linux/wiki/GVTg_Setup_Guide">these</a> modules to the initramfs and remove the i915 from there. </p><br><p>  For more detailed logging, you can set the <code>drm.debug</code> variable to some value, for example, setting it to 0x02 will include messages from drivers. </p><br><h2 id="shag-2-sozdayom-virtualnogo-druga">  Step 2: create a virtual friend </h2><br><p>  Inside <code>mdev_supported_types</code> you can find a whole set of directories.  This set is determined by the amount of your graphics memory, each subdirectory corresponds to a type of virtual GPU.  The <code>description</code> file in it contains information about the memory and permissions supported by this virtual GPU.  If creating a virtual GPU with large memory using the UUID output in the <code>/create</code> file gives you an incomprehensible error, then you have several options.  First, go to the BIOS and add video memory, if possible.  If this does not work, you can stop your DM, switch to the framebuffer, create the desired vGPU from there, and then return to x11.  Unfortunately, this method leads to many bugs and does not allow to achieve 60 FPS on my laptop.  An alternative is to create a smaller vGPU, and use a special resolution increase program (CRU).  In this way, I managed to achieve 60 FPS and there were much less bugs and hangs. </p><br><p>  You can create vGPU with the following command: </p><br><pre> <code class="plaintext hljs">$ echo ${vGPU_UUID} | sudo tee /sys/bus/pci/devices/0000:00:02.0/mdev_supported_types/${vGPU_TYPE}/create</code> </pre> <br><p>  And delete - this: </p><br><pre> <code class="plaintext hljs">$ echo 1 | sudo tee /sys/bus/mdev/devices/${vGPU_UUID}/remove</code> </pre> <br><p>  <em>Translator's Note</em> : <br>  <em>You can generate a UUID for vGPU using the <code>uuidgen</code> command <code>uuidgen</code> no arguments.</em>  <em>The variable $ {vGPU_TYPE} denotes one of the types listed in the <code>mdev_supported_types</code> directory.</em>  <em>It is also worth noting that vGPU must be recreated every time it is rebooted, they are not saved between OS launches.</em> </p><br><h2 id="shag-3-cortana-krichit-na-vas">  Step 3: Cortana screams at you </h2><br><p>  The next step is a much better supported and significantly slower and more painful thing - installing Windows 10. You should not use torrents or unofficial downloads, or an old version of Windows, the correct link <a href="https://www.microsoft.com/en-us/software-download/windows10">here</a> .  It is also worth downloading the virtio driver disk image, designed specifically to speed up guests, <a href="">here</a> .  Install <code>libvirt</code> and <code>virt-manager</code> and run <code>libvirtd</code> : </p><br><pre> <code class="plaintext hljs"># systemctl start libvirtd</code> </pre> <br><p>  Start <code>virt-manager</code> and make sure that you are connected to the <code>libvirt</code> system session, and not the user session: <br><img src="https://habrastorage.org/getpro/habr/post_images/8e3/ca9/b29/8e3ca9b29bd86d43d7a79a2aecdaadd9.png" alt="Virt-manager window"></p><br><p>  <em>Translator's Note</em> : <br>  <em>In order for virt-manager to connect to the system session, you can run it on behalf of the superuser, but it is better to set up authorization, for example, as suggested in the <a href="https://wiki.archlinux.org/index.php/libvirt">Arch Wiki</a> .</em> </p><br><p>  Once you have done this, you can start creating a virtual machine.  In the settings dialog, select the download from the local iso-image and find the downloaded image.  If <code>virt-manager</code> did not recognize it as a Windows 10 image, select it manually, as this will speed up Windows, since <code>virt-manager</code> in this case provides some Microsoft virtualization interfaces.  Create a disk image or LVM partition and configure the configuration as you need.  The setup interface is very limited before installation, so I usually start the installation and immediately stop it in order to fully configure everything.  Here are some settings: <br><img src="https://habrastorage.org/getpro/habr/post_images/a55/104/cca/a55104cca39b9a94e2ec55fb5248a6c0.png" alt="Virtual machine CPU settings"><br><img src="https://habrastorage.org/getpro/habr/post_images/256/bde/55c/256bde55c4d6f438667ca75458ba1ab3.png" alt="Virtual Machine Network Settings"></p><br><p>  <em>Translator's Note</em> : <br>  <em>Despite the fact that the post is about setting up a virtual machine on a laptop, for some reason, the question about the distribution of the network using a wireless adapter is omitted.</em>  <em>The point is that the default network settings in virt-manager are not suitable for a wireless network.</em>  <em>In this situation, an answer to <a href="https://unix.stackexchange.com/questions/159191/setup-kvm-on-a-wireless-interface-on-a-laptop-machine">this</a> question and comments on it can help.</em>  <em>The author also suggests using BIOS instead of UEFI, probably due to the fact that UEFI requires additional configuration.</em>  <em>Also, tianocore does not seem to work with GVT-g yet, see <a href="https://bugzilla.tianocore.org/show_bug.cgi%3Fid%3D935">bug 935</a> .</em>  <em>In my case, however, VM started, but Windows did not recognize the monitor to which the integrated video card is connected.</em> </p><br><p>  If you need fast disk access or even the ability of a virtual machine to compress a disk image when deleting virtual machine files (TRIM forwarding, you need to create an image with the <code>qemu-img create -f qcow2 -o preallocation=metadata,lazy_refcounts</code> , complete instructions <a href="https://chrisirwin.ca/posts/discard-with-kvm/">here</a> ), configure the primary disk to use SCSI.  The virtual machine will need drivers for Windows to understand this format, so connect the previously downloaded virtio driver disk for Windows 10. By default, they use IDE, but you can speed up the installation many times and use less legacy code if you use it instead for dvd scsi.  Windows supports it out of the box.  You can also: </p><br><ul><li>  Make USB bus use USB 3.0 </li><li>  Add spice, spice-webdav and qemu-ga channels for copy and paste and file sharing between the VM and the host </li><li>  Remove unused virtual hardware </li><li>  Switch the emulated video card to QXL and switch the display to SPICE, NOT listening to the network (even the loopback) ( <em>Translator's note: otherwise the VM simply crashes</em> ). </li><li>  Switch the chip type to Q35, the setting is next to the BIOS settings. </li><li>  Feed the dog </li></ul><br><p>  You can also start getting used to your new <code>virsh edit</code> friend.  If you run it with <code>sudo -E</code> , your environment variables, in particular EDITOR, will be used for editing, and you will use the libvirt system session, not the user session.  In this file, you can, for example, assign a correspondence between physical and virtual processors, making the processor caches more consistent and the scheduler behaves not so strange.  Here is an example of XML that you can put there: </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">vcpu</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">placement</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'static'</span></span></span><span class="hljs-tag">&gt;</span></span>6<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">vcpu</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">cputune</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">vcpupin</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">vcpu</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'0'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">cpuset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'1'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">vcpupin</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">vcpu</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'1'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">cpuset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'2'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">vcpupin</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">vcpu</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'2'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">cpuset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'3'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">vcpupin</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">vcpu</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'3'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">cpuset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'5'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">vcpupin</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">vcpu</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'4'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">cpuset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'6'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">vcpupin</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">vcpu</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'5'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">cpuset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'7'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">cputune</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">features</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hyperv</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">relaxed</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">state</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'on'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">vapic</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">state</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'on'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">spinlocks</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">state</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'on'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">retries</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'8191'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">runtime</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">state</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'on'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">synic</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">state</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'on'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">stimer</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">state</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'on'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hyperv</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">features</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">cpu</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">mode</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'host-passthrough'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">check</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'none'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">topology</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">sockets</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'1'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">cores</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'3'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">threads</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'2'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">cpu</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  In this fragment, I configure the VM so that it sees a processor with three physical cores, each of which has two hyper-threads.  Further, each processor / hyperflow is attached to its own hyperflow, and this correspondence does not change.  The Windows scheduler knows about hyper-threads and can use them correctly, not counting them as separate processors.  I also include some Hyper-V interfaces that are turned off by default and may have no effect.  If you use SPICE, you can add the following lines to disable compression, because the external network is still not used to access the VM. </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">graphics</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'spice'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">listen</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'none'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">image</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">compression</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'off'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">jpeg</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">compression</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'never'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">zlib</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">compression</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'never'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">playback</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">compression</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'off'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">streaming</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">mode</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'off'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- &lt;gl enable='yes' rendernode='/dev/dri/by-path/pci-0000:00:02.0-render'/&gt; –ø–æ–∫–∞ —á—Ç–æ —ç—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, —ç—Ç–æ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –±—É–¥–µ—Ç —É–¥–∞–ª—ë–Ω libvirt --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">graphics</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Now you can customize the boot order and start installing Windows.  If you are using <code>virtio</code> or a SCSI disk, Windows will not find it.  You will need to install the SCSI driver from the disk that you connected, they are in the <code>virtscsi/amd64</code> directory.  Everything should go smoothly, and Windows should boot in slow and wretched, not accelerated mode.  Cortana will start screaming at you, and your network will not work.  Break through it all to the desktop.  There, launch the device manager, find all unidentified devices, and update the drivers for them from the disk that you connected.  You will get some faster windows. </p><br><h2 id="shag-4-vesyolaya-chast">  Step 4: The fun part </h2><br><p>  There are three ways to get an accelerated virtual VM display with Windows on the screen of your machine. </p><br><ul><li>  VNC or some other remote access protocol (usually a very bad solution).  In this version, you only need to connect the vGPU and disconnect all other displays and video cards.  Also set the <code>display='off'</code> setting to <code>display='off'</code> .  You do not need the <code>igd-opregion</code> , shown later. </li><li>  SPICE (I didn‚Äôt manage to achieve 30 FPS or higher, but the shared clipboard and file transfer between the VM and the host are working). </li><li>  Built-in QEMU interface on GTK + (shared clipboard and file transfer do not work, but you can achieve 60 FPS using a patch). </li></ul><br><p>  Whatever you are going to use, you still have to use the second option to install the drivers for the GPU.  Microsoft's built-in drivers do not work very well with GVT-g at the time of writing the post, and often break.  Before you connect the vGPU to the VM, it is advisable to download the <a href="https://downloadcenter.intel.com/">latest version of the driver from Intel</a> (Apparently, <a href="https://www.intel.com/content/www/us/en/support/articles/000031572/programs/intel-corporation.html">Intel changes the approach to distributing the drivers</a> , so in the future this step may be different, or it may not be necessary at all).  Now make sure you have vGPU created.  Open <code>virt-manager</code> and replace good fast QXL with slow Cirrus to avoid conflicts.  To connect a vGPU to a VM, you need to open <code>virsh edit</code> and add the following fragment somewhere: </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">domain</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'kvm'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:qemu</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'http://libvirt.org/schemas/domain/qemu/1.0'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hostdev</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">mode</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'subsystem'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'mdev'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">managed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'no'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">model</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'vfio-pci'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">display</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'on'</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><pre> <code class="plaintext hljs">&lt;address uuid='fff6f017-3417-4ad3-b05e-17ae3e1a4615'/&gt;</code> </pre> <br><pre> <code class="plaintext hljs"> &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x09' function='0x0'/&gt; &lt;rom enabled='no'/&gt; &lt;/hostdev&gt; &lt;graphics type='spice'&gt; &lt;listen type='none'/&gt; &lt;image compression='off'/&gt; &lt;jpeg compression='never'/&gt; &lt;zlib compression='never'/&gt; &lt;playback compression='off'/&gt; &lt;streaming mode='off'/&gt; &lt;gl enable='yes' rendernode='/dev/dri/by-path/pci-0000:00:02.0-render'/&gt; &lt;!-- –í–∞—à –ø—É—Ç—å –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è, virt-manager –º–æ–∂–µ—Ç –ø—Ä–æ—Å—Ç–∞–≤–∏—Ç—å —ç—Ç–æ –∑–∞ –≤–∞—Å, –µ—Å–ª–∏ –≤—ã –æ—Ç–º–µ—Ç–∏—Ç–µ —á–µ–∫–±–æ–∫—Å —Å –∞–ø–ø–∞—Ä–∞—Ç–Ω—ã–º —É—Å–∫–æ—Ä–µ–Ω–∏–µ–º GL. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç—É—Ç –ø—Ä–æ–ø–∏—Å–∞–Ω –ø—É—Ç—å –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É, –∞ –Ω–µ auto. --&gt; &lt;/graphics&gt; &lt;qemu:commandline&gt; &lt;qemu:arg value='-set'/&gt; &lt;qemu:arg value='device.hostdev0.x-igd-opregion=on'/&gt; &lt;!-- libvirt –ø–æ–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —ç—Ç—É –æ–ø—Ü–∏—é, –ø–æ—ç—Ç–æ–º—É –µ—ë –Ω–∞–¥–æ –≤—ã—Å—Ç–∞–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é --&gt; &lt;/qemu:commandline&gt; &lt;/domain&gt;</code> </pre> <br><p>  Note: When I provide an XML fragment like this, you should, if possible, add it to the current one, without replacing anything. </p><br><p>  Check that you have created unique UUIDs for all the vGPUs you are using, and that the slot numbers do not conflict with any of the other PCI devices.  If the slot number is after the Cirrus GPU, the virtual machine will fall.  Now you can start the virtual machine.  <strong>You need to install <code>virt-viewer</code> to see both displays!</strong>  You can connect to the VM using the command </p><br><pre> <code class="plaintext hljs">$ sudo -E virt-viewer --attach</code> </pre> <br><p>  One of the displays will be empty or not initialized, the second will be the familiar little non-accelerated display.  Open it and, upon entering, install the driver for the GPU.  If you are lucky, everything will work right away.  Otherwise, it is necessary to turn off and restart the VM (do not reboot) using the running screen.  Now it's time to open the terminal and run <code>dmesg -w</code> inside.  This command will give you some useful information about the problems and the general progress of work using vGPU.  For example, when booting, KVM will complain about blocked MSRs, then you should receive several messages about incorrect access when vGPU is initialized.  If there are too many of them, something is wrong. </p><br><p>  If the system is booted, you can open the display settings and turn off the non-accelerated screen.  A blank screen can be hidden through the <code>virt-viewer</code> <em>View</em> menu.  In principle, the VM can already be used, but there are a couple more things that can be done to achieve higher resolution and higher speed. </p><br><p>  <a href="https://www.monitortests.com/forum/Thread-Custom-Resolution-Utility-CRU">The CRU utility is</a> quite useful.  You can play with it, and even if you stumble upon some kind of graphical artifacts or even an almost completely black screen, as I did, you can run <code>Restart64.exe</code> , which comes with the program, to restart the Windows graphics subsystem.  I personally use this utility to use a higher resolution on a more modest vGPU. </p><br><p>  To achieve excellent 60 FPS, you need to switch to the built-in QEMU monitor on GTK + without supporting the common clipboard with the host and similar buns, and also change one line in it and rebuild QEMU.  You will also need to add a bunch of nasty command line arguments to your XML.  Remove the SPICE display and the Cirrus video card and set the <code>display</code> attribute on your vGPU to <code>off</code> (libvirt does not support the display on GTK + and will not allow to boot from <code>display='on'</code> without display). </p><br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">qemu:commandline</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">qemu:arg</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'-set'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">qemu:arg</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'device.hostdev0.x-igd-opregion=on'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">qemu:arg</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'-set'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">qemu:arg</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'device.hostdev0.display=on'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">qemu:arg</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'-display'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">qemu:arg</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'gtk,gl=on'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">qemu:env</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'DISPLAY'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">':1'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">qemu:env</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'GDK_SCALE'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'1.0'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">qemu:commandline</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Scaling for HiDPI at the QEMU monitor works very badly, so we will disable it.  Also, you will need to set the <code>DISPLAY</code> variable to the number of the display you are using.  To give the user running qemu access rights to the X server, use the command: </p><br><pre> <code class="plaintext hljs"># xhost si:localuser:nobody</code> </pre> <br><p>  If that doesn't work, try <code>xhost +</code> , but make sure you use a firewall.  Otherwise, try a more secure method. </p><br><p>  With such tricks, you still will not get above 30 FPS because of this <a href="https://github.com/intel/gvt-linux/issues/35">stupid bug</a> in QEMU, unless you patch it by changing the line, as indicated in the comments link.  Make sure you build only the QEMU for x86-64, unless you are going to use it on another platform.  I attached my PKGBUILD, which does not change the line, but only collects QEMU for x86_64 without support for network storage <a href="https://blog.bepbep.co/posts/gvt/PKGBUILD">here</a> . </p><br><p>  If you get lost somewhere along the way, you can view my current <a href="">xml for libvirt</a> . </p><br><h2 id="poleznye-ssylki">  useful links </h2><br><p>  <a href="https://github.com/intel/gvt-linux/wiki/GVTg_Setup_Guide">Official GVT-g Setup Guide</a> <br>  <a href="https://github.com/intel/gvt-linux/wiki/Dma_Buf_User_Guide">Dma-buf User Guide</a> <br>  <a href="https://nixos.wiki/wiki/IGVT-g">An article on configuring Intel GVT-g on the NixOS Wiki</a> <br>  <a href="https://wiki.archlinux.org/index.php/libvirt">An article on the Arch Wiki about libvirt</a> <br>  <a href="https://unix.stackexchange.com/questions/159191/setup-kvm-on-a-wireless-interface-on-a-laptop-machine">Network configuration in KVM on the wireless interface</a> <br>  <a href="https://01.org/igvt-g/">Intel GVT-g dedicated website</a> </p><br><p>  PS: Thank you <a href="https://habr.com/ru/users/annimon/" class="user_link">aNNiMON</a> for help in reading the translation text and correcting errors. </p></div><p>Source: <a href="https://habr.com/ru/post/437270/">https://habr.com/ru/post/437270/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>