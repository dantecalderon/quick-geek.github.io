<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Modification to the game based on dll-wrapper</title>
  <meta name="description" content="There is a game of In Verbis Virtus with unusual mechanics - to create spells using a microphone. 

 This is not a simulator of Amayak Akopyan, this i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>Modification to the game based on dll-wrapper</h1><div class="post__text post__text-html js-mediator-article">  There is a game of In Verbis Virtus with unusual mechanics - to create spells using a microphone. <br><br>  This is not a simulator of Amayak Akopyan, this is a first-person puzzle game with atypical controls. <br>  To do this, the game uses the speech recognition library Sphinx. <br><br>  The idea looks interesting, but the implementation came out so-so (recognition often misses), and frankly bored after the first 20 minutes. <br>  About how it looks from the side - generally keep quiet. <br><br>  Developers, unfortunately, did not leave the ability to control spells from the keyboard, and I decided to fix it. <br><a name="habracut"></a><br>  The first thought was to make changes to the Sphinx library, since it is open-source.  However, I found that there are a bunch of versions of this library. <br><br>  Having tried three of them (approximately the corresponding release times of the game), I didn‚Äôt find the one I needed, because each had some differences (at least in terms of the set of exported functions). <br><br>  Therefore, I decided to make a wrapper over the original library from the game. <br><br>  To do this, I used the approach proposed in the article <a href="https://floodyberry.wordpress.com/2008/09/08/generating-dll-wrappers/">Generating .DLL Wrappers</a> . <br><br>  Its essence is that you can wrap any library without any knowledge about the parameters and types of exported functions, just their names (which can be extracted even with a text editor) are sufficient. <br><br>  The export list is created using the def file of the form: <br><br><pre><code class="cpp hljs">EXPORTS func1=_func1 @<span class="hljs-number"><span class="hljs-number">1</span></span> func2=_func2 @<span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> <br>  The function wrappers themselves have the form: <br><br><pre> <code class="cpp hljs">_declspec(naked) <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> _func1() { __asm jmp dword ptr [procs + <span class="hljs-number"><span class="hljs-number">1</span></span> * <span class="hljs-number"><span class="hljs-number">4</span></span>]; }</code> </pre> <br>  This eliminates problems with passing arguments and returning the values ‚Äã‚Äãof the original functions. <br><br>  For a start, a bit of reverse engineering was required.  I created a wrapper with a single addition - logging the names of called functions. <br><br>  So I determined where, when and how the main logic of the library works. <br><br>  It turned out that at first a certain number of raw samples were collected from the microphone by the function ps_process_raw (), and then the decision itself was made in the function ps_get_hyp (). <br>  Later (too late), I still thought that at first it would be worth looking at the Sphinx documentation (where all this was described). <br><br>  It was decided to add to the ps_process_raw () function a definition of the state of the keys that will be responsible for the spells. <br><br>  To do this, you need to assign these keys.  We do this in DllMain (), along with getting the addresses of the original functions.  Here are the commercials: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">BOOL WINAPI </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DllMain</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved)</span></span></span><span class="hljs-function"> </span></span>{ HINSTANCE hinst_dll; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fdwReason == DLL_PROCESS_ATTACH) { hinst_dll = LoadLibraryA(<span class="hljs-string"><span class="hljs-string">"pocketsphinx_orig.dll"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!hinst_dll) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">93</span></span>; i++) procs[i] = GetProcAddress(hinst_dll, import_names[i]); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">256</span></span>; i++) { _itoa(i, &amp;buf[i][<span class="hljs-number"><span class="hljs-number">0</span></span>], <span class="hljs-number"><span class="hljs-number">10</span></span>); GetPrivateProfileStringA(<span class="hljs-string"><span class="hljs-string">"main"</span></span>, &amp;buf[i][<span class="hljs-number"><span class="hljs-number">0</span></span>], <span class="hljs-number"><span class="hljs-number">0</span></span>, &amp;buf[i][<span class="hljs-number"><span class="hljs-number">0</span></span>], MAX_PATH, <span class="hljs-string"><span class="hljs-string">".\\settings.ini"</span></span>); } i = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fdwReason == DLL_PROCESS_DETACH) FreeLibrary(hinst_dll); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre><br>  The settings.ini file is: <br><br><pre> <code class="cpp hljs">[main] <span class="hljs-number"><span class="hljs-number">49</span></span>=String <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span>=String <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> <br>  So, in the array buf there will be lines corresponding to the spells.  And will lie on the indices corresponding to the right keys. <br><br>  Determine the state of the keys will be like this: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">find_key</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!i) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">256</span></span>; i++) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buf[i][<span class="hljs-number"><span class="hljs-number">0</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (GetAsyncKeyState(i) &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { i = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)&amp;buf[i][<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i == <span class="hljs-number"><span class="hljs-number">256</span></span>) i = <span class="hljs-number"><span class="hljs-number">0</span></span>; } }</code> </pre> <br>  The wrapper for the ps_process_raw () function will be: <br><br><pre> <code class="cpp hljs"> _declspec(naked) <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> _ps_process_raw() { find_key(); __asm jmp dword ptr [procs + <span class="hljs-number"><span class="hljs-number">78</span></span> * <span class="hljs-number"><span class="hljs-number">4</span></span>]; }</code> </pre><br>  That is, if, at the time when you need to cast into the microphone, the user pressed a key, a pointer to the line corresponding to the pressed key was saved in the global variable i. <br><br>  Preparations are finished, it's time to implement the basic functionality. <br><br>  It is required to determine whether the spell button was pressed by the user, and if so, change the return value in the ps_get_hyp () function. <br><br>  This requires a bit of stack manipulation: <br><br><pre> <code class="cpp hljs"> _declspec(naked) <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> _ps_get_hyp() { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> return_address; _asm { <span class="hljs-comment"><span class="hljs-comment">//save return address push eax mov eax, dword ptr [esp+4] mov return_address, eax pop eax //call original ps_get_hyp add esp, 4 call dword ptr [procs + 22 * 4] sub esp, 4 //replace result (if key was pressed) cmp i, 0 je end mov eax, i xor ecx,ecx mov i, ecx end: //restore return address push eax mov eax, return_address mov dword ptr [esp+4], eax pop eax ret } }</span></span></code> </pre> <br>  The main functionality is in the piece with the comment ‚Äúreplace result (if key was pressed)‚Äù. <br>  If there is a pointer in the global variable, we substitute the returned result and reset the global variable. <br><br>  And if not, then leave everything unchanged. <br><br>  Thus, you can continue to cast through the microphone, and you can also use the buttons (they take precedence).  The goal is achieved. <br><br>  Yes, there are curved moments in the solution. <br><br>  For example, passing a pointer through a global variable, and even referred to as i (decided to reuse it after initialization in DllMain). <br><br>  Climbing someone else‚Äôs stack is also somehow not accepted (I didn‚Äôt think how to do otherwise). <br><br>  Nevertheless, the solution is quite working.  The main code is less than 100 lines, for the most part everything is trivial. <br><br>  <a href="https://gist.github.com/Himmler/fb6390e16e93550c1c94bd882105f5d7">Source code</a> <br>  <a href="https://gist.github.com/Himmler/d66e52b29715d281f5ba84cbcbdb4995">def file</a> <br>  <a href="https://yadi.sk/d/6bMXI_F93apSff">Binary + configuration file</a> <br><br>  Installation: <br><br><ul><li>  In the \ In Verbis Virtus \ Binaries \ Win32 \ folder, rename the original pocketsphinx.dll to pocketsphinx_orig.dll </li><li>  Put a number of wrappers pocketsphinx.dll </li><li>  Put settings.ini in the \ In Verbis Virtus \ Binaries \ Win32 \ UserCode folder </li></ul><br>  Criticism and suggestions are accepted. </div><p>Source: <a href="https://habr.com/ru/post/437884/">https://habr.com/ru/post/437884/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>