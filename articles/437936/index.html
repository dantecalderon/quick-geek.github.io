<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Its video platform - ffmpeg and video encoding quality. Part 2</title>
  <meta name="description" content="Lenna loves to look good - a fashion model after all. There are legends that adding it to the title of the article related to the processing of visual...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>Its video platform - ffmpeg and video encoding quality. Part 2</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/webt/-s/ru/54/-sru54pmvf-usmpvhvzgo1wxwyw.png"></div><br>  <sub>Lenna loves to look good - a fashion model after all.</sub>  <sub>There are legends that adding it to the title of the article related to the processing of visual data gives +5 to the chance for advantages.</sub> <br><br>  I continue to reveal the features of the video services.  Today notes about coding parameters and their selection. <br><br>  <a href="https://habr.com/ru/post/436568/">First part</a> <br><br>  Most codecs offer fairly balanced default values, allowing you to get a normal result without a long selection of parameters.  However, when it comes to a large archive of video materials, restrictions on bitrate, considerations of compatibility with the client‚Äôs equipment and a reasonable desire to preserve the quality of the original, everything becomes more interesting. <br><br>  Unfortunately, the magic button "to encode quite well" is not provided.  Like analogue <a href="http://caniuse.com/">caniuse</a> for coding parameters.  We'll have to understand the features of the work of codecs. <br><a name="habracut"></a><br><h3>  Introduction: Profiles </h3><br>  H264 has such a number of settings and parameters that the developers, in order not to get confused in them, decided to make a list of profiles - ‚Äúgood‚Äù configurations for different purposes.  Standard profiles have defined a lot;  Additionally, by setting your own encoding parameters, you actually create your own profile, completely confusing everyone.  So, unfortunately, it turned out as always. <br><br><img src="https://habrastorage.org/storage3/ffa/c72/7fd/ffac727fd7f9547d36657745fe7ea3a1.png"><br><br>  Initially, profiles were created to determine whether the final video will play on the desired type of devices, but now there is no definite division of players by device type and profile. <br><br>  In practice, I would single out, according to the level of decoding consumption, three groups of parameters: <br><br><ul><li>  with disabled CABAC;  conditionally main- and baseline-profiles.  They can still be used for delay-sensitive streaming broadcasting; </li><li>  CABAC enabled;  conditionally high-profile.  For everything.  Most of the modern (and not very) equipment is able to lose.  Increase efficiency compared to main - 20% +; </li><li>  with support for ten-bit sampling and other advanced parameters.  Conventionally Hi10P.  The problem with such profiles is the almost complete lack of hardware support and increased requirements for decoding equipment;  phones, even top, can not cope with such files.  Can be used for personal library if you are confident in your equipment.  Another 10-20% increase in efficiency. </li></ul><br>  The concept of profiles for other codecs is not as developed as that of H264.  For them, we can assume that if the codec is supported, then it is supported entirely, and only an excessively high bit rate, or another parameter that is clearly too high, can be a limitation during playback.  However, with the proliferation of hardware decoders VP8 and VP9, ‚Äã‚Äãthe situation may change. <br><br>  Now to the individual parameters. <br><br><h3>  Color space </h3><br>  The choice of color space has virtually no effect on coding efficiency;  This parameter could be left to the choice of the codec (it is important when processing raw, unencrypted data), if it were not for one particular feature: many players process color space information very specifically, so for a large part of users, the video can be displayed with color distortions (in mostly green). <br><br>  To preserve colors for most players, different H264 videos need to be encoded in different spaces: <br><br><ul><li>  for SD (width &lt;1280) - BT.601 </li><li>  for HD (width&gt; = 1280) - BT.709 </li></ul><br>  There is an excellent <a href="https://www.wiggler.gr/2012/02/27/bt-601-and-bt-709-compatibility/">study</a> from 2012.  on this topic.  Unfortunately, the situation with such bugs is changing very slowly, and, although some of the test results from that article are no longer relevant, such features still need to be taken into account.  There is a chance that all this time you have watched videos with the wrong colors - and it turns out that this was not a director's decision. <br>  The problem is known for H264 decoders, other formats may not have this problem. <br><br><h3>  Frame rate </h3><br>  If your source is not streaming games or action video, then it makes sense to limit the upper frame rate value to 25-30 frames - the smaller they are, the more data remains to describe a single frame.  Reducing this value is better than a multiple - so that frame dropping is uniform, otherwise the video may experience a slowdown. <br><br>  There is still such a thing as a variable frame rate.  It is inconvenient to work with VFR for two reasons: firstly, it gives bitrate peaks in high frequency sections that instantly empty the buffer;  secondly, VFR complicates the compilation of a conversion plan, forcing to use Q-parameters (I wrote about them in the first article). <br><br><h3>  GOP size </h3><br>  Groups of images are blocks within which some images can refer to the data of others.  Increasing the size of the GOP improves the efficiency of the codec in exchange for higher memory requirements.  Large values ‚Äã‚Äãare especially effective for files with the same type, cyclic movements (you know what I mean).  Also, for large values, there may be problems with video rewind, since  will need to recover more data. <br>  The name of the parameter, as well as the units of measurement, may differ from codec to codec - see the documentation. <br><br><h3>  Slices </h3><br>  To speed up decoding (and encoding) video can be divided into parts of lower resolution.  The idea is that processing four videos with a resolution of, for example, 1280x720 is simpler than one, but 2560x1440.  It makes sense at resolutions higher than FHD.  The more parts, the lower the efficiency of the codec.  Also, the use of this separation simplifies multi-thread processing. <br><br><h3>  Anamorphic pixels </h3><br>  Rectangular pixels appear when the aspect ratio and the ratio of pixel width to height are different - widescreen DVDs, where 16: 9 video has a resolution of 704 √ó 480 (3: 2 with analog VAT and wind correction).  Playing such videos will not cause problems, however, when encoding, you need to take into account both the resolution and the aspect ratio, otherwise it is easy to convert anamorphic or standard square pixels with a loss of efficiency (up to ~ 35%!), Or even get something flattened horizontally. <br><br><h3>  Bit rate control </h3><br>  There are three main modes of operation for codecs related to bitrate: <br><br><ul><li>  constant bit rate, CBR, when the quality drops in proportion to the complexity of the scene; </li><li>  constant quality, const Q VBR, when the bit rate increases in proportion to the complexity of the scene; </li><li>  Limited bitrate and quality - classic VBR. </li></ul><br>  It should be noted that most coders (including ffmpeg) do not convert codecs to CBR mode when specifying a bitrate ‚Äî VBR files are made with restrictions not always defined in documentation (CBR mode is usually enabled by specifying the same minrate and maxrate). <br><br>  VBR is well suited for online playback (and streaming as well).  it gives better quality than CBR and allows you to fit the stream in the Internet channel. <br><br>  The choice of maxrate / minrate depends on the client channel, the spread of more than 20% is better not to do. <br><br><h3>  Multipass coding </h3><br>  The distribution of data on a file in VBR mode is difficult to predict, codecs have to guess what is not always possible.  In multipass mode, the codec first maps the required bit rate, and then encodes it.  In this way, the quality of video in complex and dynamic scenes is improved (for <a href="http://btoa.tk/%3Fshow%3Dview%26id%3D7i9j9lc">example,</a> pay attention to the number of ‚Äúmoir√©‚Äù elements and the number of transitions between scenes).  Since during the first pass the codec only analyzes the source file, contrary to popular opinion, processing in this mode takes no more than twice the time, but only 10-15%. <br><br><h3>  -tune </h3><br>  For different types of source material, several presets have been prepared, adjusting some basic coding parameters such as deblocking-filiter levels, psycho-visual optimization parameters.  Using these presets improves video perception and works well if you know the source type in advance, or you have a structured set of videos (in the case of mass processing). <br><br>  Presets: <br><br><ul><li>  film - for movies and everything with a complex frame structure.  <a href="http://policat.tk/%3Fshow%3Dview%26id%3Dcxoh9lu">This</a> is definitely a film; </li><li>  animation - for videos with large monochromatic areas.  That is, <a href="http://btoa.tk/%3Fshow%3Dview%26id%3Dtjdf5jt">it is</a> better to encode with the animation preset, and <a href="http://btoa.tk/%3Fshow%3Dview%26id%3Dwnoxh7n">this</a> is the film, despite the fact that the animation is; </li><li>  stillimage - for video where there is almost no movement;  good optimization for those songs in mp4 format, where throughout the video the background is the album cover (someone tell them that even flac cannot weigh 300MB for 10 minutes!); </li><li>  grain - to encode "noisy" sources, such as surveillance cameras; </li><li>  psnr / ssim - to assess the effectiveness of the remaining parameters of the codec; </li><li>  fastdecode - forced main-profile for weak devices; </li><li>  zerolatency - as the name implies, for streaming with low latency. </li></ul><br><h3>  Pixel format </h3><br>  The format and bit depth strongly influence how files are compressed and uncompressed, in what form quality is lost.  The main parameters that describes the pixel format: <br><br><ul><li>  method of decomposing colors into components - YUV, RGB; </li><li>  color subsampling parameters (oh how! chroma subsampling is more familiar) when some color components are saved with lower resolution; </li><li>  the depth of the color components in bits. </li></ul><br>  Conscious choice of pixel format requires a separate analysis, collection of material and strongly depends on the type of source material. <br><br>  Briefly: <br><br><ul><li>  not all codecs (and, most importantly, decoders) support possible formats; </li><li>  working with some formats is more demanding of resources - Hi10P differs from just a high-profile by this; </li><li>  Working with sub-sampled formats can give a noticeable increase in compression efficiency, but it is more difficult to control quality loss. </li></ul><br><h3>  Interlaced </h3><br>  Interlacing invented to double the perceived frame rate with minimal cost - the bitrate and resolution are the same, and the frequency is higher.  However, with fast movement, the teeth become noticeable - the lines of the previous frame.  You can get rid of the effect without dropping frames and without reducing the vertical resolution, you can use filters, but they will reduce the clarity.  If the video will play in the browser, it is better to filter the interlacing when encoding, because  Realtime filtering on the client will not give the best visual results. <br><br><h3>  Putting it all together </h3><br>  Example for x264: <br><br><pre><code class="bash hljs">ffmpeg -i [–∏—Å—Ç–æ—á–Ω–∏–∫] -c:v libx264 -b:v [bitrate] <span class="hljs-comment"><span class="hljs-comment">#—Ü–µ–ª–µ–≤–æ–π –±–∏—Ç—Ä–µ–π—Ç -maxrate [bitrate] #–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –¥–µ–≤–∏–∞—Ü–∏—é –±–∏—Ç—Ä–µ–π—Ç–∞ -r [framerate] -g [size] #GOP –≤ –∫–∞–¥—Ä–∞—Ö -aspect [—Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä 16:9] #–µ—Å–ª–∏ –∏—Å—Ö–æ–¥–Ω–∏–∫ –∞–Ω–∞–º–æ—Ä—Ñ–Ω—ã–π -profile high #—Å–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± –≤–∫–ª—é—á–∏—Ç—å CABAC -color_primaries bt709 #–æ—Ç–¥–µ–ª—å–Ω–æ –∑–∞–¥–∞—ë–º —Ü–≤–µ—Ç–æ–≤–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ, –Ω–µ –ø–æ–ª–∞–≥–∞—è—Å—å –Ω–∞ –∫–æ–¥–µ–∫ -color_trc bt709 -colorspace bt709 -slices 4 #–∫–æ–¥–∏—Ä—É–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ –±–ª–æ–∫–∞–º–∏ –Ω–∏–∑–∫–æ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è -threads 4 -tune [value] -map_metadata:g -1 #–æ—á–∏—â–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ, –æ–Ω–ª–∞–π–Ω –æ–Ω–∏ –Ω–∞–º –Ω–µ –Ω—É–∂–Ω—ã -map_metadata:s:v -1 -map_metadata:s:a -1 -map_chapters -1 -pass [1|2] #–ø—Ä–∏ –º–Ω–æ–≥–æ–ø—Ä–æ—Ö–æ–¥–Ω–æ–º –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–∏ -passlogfile [file] #–µ—Å–ª–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç–µ —Ñ–∞–π–ª—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ #-map ... -a:c ... -ac ... -a:b ..., —Ñ–∏–ª—å—Ç—Ä—ã, —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è - –ø–æ –≤–∫—É—Å—É [–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ]</span></span></code> </pre> <br>  Of course, in one article it didn‚Äôt cover everything, but I‚Äôm sure this material will be enough to improve the quality of many videos. <br><br>  Read the documentation and experiment. <br><br>  Materials: <br><br>  <a href="https://ffmpeg.org/ffmpeg-all.html">ffmpeg.org/ffmpeg-all.html</a> <br>  <a href="https://en.wikipedia.org/wiki/H.264/MPEG-4_AVC">en.wikipedia.org/wiki/H.264/MPEG-4_AVC#Profiles</a> <br>  <a href="https://en.wikipedia.org/wiki/Chroma_subsampling">en.wikipedia.org/wiki/Chroma_subsampling</a> <br>  <a href="https://en.wikipedia.org/wiki/Color_space">en.wikipedia.org/wiki/Color_space</a> <br>  <a href="https://en.wikipedia.org/wiki/YUV">en.wikipedia.org/wiki/YUV</a> <br><br>  In addition to the <a href="http://policat.tk/">example</a> from the previous article, I learned about another installation of my code - <a href="http://btoa.tk/">click</a> .  Examples in the article I tried to take from these sites, but despite this: <br>  <sub>* I have no direct relation to the authors of the sites mentioned and can not share their views and opinions.</sub>  <sub>Decisions about who and how to access the code, I can not comment.</sub> <br><br>  Ready to answer questions. </div><p>Source: <a href="https://habr.com/ru/post/437936/">https://habr.com/ru/post/437936/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>