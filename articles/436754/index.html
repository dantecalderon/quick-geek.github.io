<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Q2VKPT: Completely rewritten Quake II with realistic lighting</title>
  <meta name="description" content="Q2VKPT is the first playable game with full raytracing, effectively simulating fully dynamic real-time lighting using the same state-of-the-art techno...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-6974184241884155",
      enable_page_level_ads: true
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>Q2VKPT: Completely rewritten Quake II with realistic lighting</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d02/ad6/76a/d02ad676a543a5033cd992da62006df5.jpg"></div><br>  Q2VKPT is the first playable game with full raytracing, effectively simulating fully dynamic real-time lighting using the same state-of-the-art technologies used in the film industry (see <a href="https://www.youtube.com/watch%3Fv%3DfrLwRLS_ZR0%2522">Disney's practical guide to path tracing</a> ). <br><br>  The recent release of GPU models with ray tracing functions (raytracing) has opened up completely new possibilities for the future of game graphics, but the correct use of ray tracing is not a trivial task.  While some game developers began exploring the emerging possibilities in rendering shadows and reflections, Q2VKPT was the first project to implement an effective overall solution for all types of light transport: direct, diffused and reflected lighting (see the Media section).  In the film industry, this unification has led to a significant <a href="https://jo.dreggn.org/path-tracing-in-production/2018/">improvement in flexibility and productivity</a> .  It is likely that this development of technology in games promises a similar improvement in visual accuracy and realism of graphics over the next few years.  This project should serve as a proof of concept for the field of computer graphics research and the gaming industry;  besides, it allows gamers to take a look at the potential future of game graphics.  In addition to using hardware accelerated raytracing, Q2VKPT mainly ensures its efficiency thanks to an <a href="https://cg.ivd.kit.edu/atf.php">adaptive image filtering technique</a> that intelligently tracks changes in the illumination of the scene in order to reuse as much information as possible from previous calculations. <br><a name="habracut"></a><br><h2>  about the project </h2><br>  The project is released as <a href="https://github.com/cschied/q2vkpt/">open source on GitHub</a> .  It integrates our Vulkan ray tracer into a <a href="http://skuller.net/q2pro/">Q2PRO</a> client.  The project arose from the need for computer graphics research on fast-running test content.  It is motivated by the first intriguing results of the path trace renderer, written <a href="https://amietia.com/q2pt.html">in 2016</a> . <br><br><h2>  Story </h2><br>  VKPT and Q2VKPT were created as a hobby project by Christoph Schied to test the results of computer graphics research in this game.  At the moment, the project includes 12 thousand lines of code and completely replaces the original graphic code Quake II.  Initially, his prototype was written in OpenGL with Johannes Hanika (experimental raytracing, shaders, fixes by GL / Vulkan), Addis Dittebrandt (lighting hierarchy, debugging visualization), Tobias Zirr ( <a href="https://twitter.com/alphanew">symphras</a> ) ( <a href="https://twitter.com/alphanew">symphonic theme</a> ) (symphonic lighting, debugging visualization), Tobias Zirr ( <a href="https://twitter.com/alphanew">symphonic theme</a> ) ( <a href="https://twitter.com/alphanew">symphonic theme</a> ) (symphonic theme, lighting, debug visualization), Tobias Zyrr ( <a href="https://twitter.com/alphanew">Toraz Zirr</a> ) ( <a href="https://twitter.com/alphanew">symphonic theme</a> ) ( <a href="https://twitter.com/alphanew">symphonic theme</a> ) website, informational texts) and Florian Rybold (original lighting hierarchy).  Additional help was provided by Stefan Bergmann, Emanuel Schrade, Alice Jung and Christoph Peters ( <a href="http://momentsingraphics.de/%3Fp%3D127">some noise</a> ). <br><br><h2>  Downloadable materials </h2><br><ul><li>  <a href="https://github.com/cschied/q2vkpt/">Github repository</a> </li><li>  <a href="https://github.com/cschied/q2vkpt/releases">Windows binary on github</a> </li><li>  <a href="http://q2s.tastyspleen.net/">Quake 2 Demo (for playing q2vkpt you need .pak files from the demo or full version of the game)</a> </li></ul><br><h2>  Video </h2><br><iframe width="560" height="315" src="https://www.youtube.com/embed/vrq1T93uLag" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><iframe width="560" height="315" src="https://www.youtube.com/embed/gMrEItbGXfY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Failed frames in development: <a href="https://www.youtube.com/watch%3Fv%3DAIsQ5h0bkDw">video with glitches 1</a> , <a href="https://www.youtube.com/watch%3Fv%3DFvBpAAQYvJ4">video with glitches 2</a> . <br><br><h2>  Screenshots </h2><br>  We advise you to watch the video or play the game yourself, because fully dynamic lighting is much better felt in motion. <br><br><div class="spoiler">  <b class="spoiler_title">Fully dynamic global illumination created using ray tracing.</b>  <b class="spoiler_title">Shadows are created by ray tracing, glossy reflections and one stage of indirect lighting reflection are added.</b> <div class="spoiler_text"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2a6/e6e/42a/2a6e6e42abbfb53fe75b1fa58335b078.jpg"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/387/c6d/6dd/387c6d6dd1a8ae7aa5be77a7ade9fd66.jpg"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/de0/463/5e2/de04635e23cbba8e0dc7c38a58269783.jpg"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/092/c31/3b0/092c313b01d58c40c5418b273c5c15fa.jpg"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d39/ecb/ca2/d39ecbca24876be5ce45a0f4b5a98d2b.jpg"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cb1/4b2/95a/cb14b295abfc97e524c6422908fdf6c1.jpg"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/988/e7d/838/988e7d8383c28d48576398cd97859ea7.jpg"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/df7/83f/3d3/df783f3d369bb51f05517b80fef41d35.jpg"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f65/3e1/3fa/f653e13fad37e9312f017c030b5cddce.jpg"></div></div></div><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/dg/dq/9r/dgdq9rnapdtqhqzu0ybhoilxbh0.png"></div><br>  <i>Output path tracer (left) and applied noise reduction filter (right)</i> <br><br><div class="spoiler">  <b class="spoiler_title">Screenshot Comparison</b> <div class="spoiler_text"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bce/cbf/b52/bcecbfb52000535c4a16b58dfa9fb181.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/666/5f7/092/6665f7092e70b8fd5b101c6e6399cdd6.png"></div></div></div><br><h2>  Technology </h2><br>  Q2VKPT is implemented on the Vulkan API in order to be able to use the new hardware raytracing functions that appeared last year.  Thanks to them, the game can get close to 60 FPS (2560x1440, RTX2080Ti) with full raytracing and dynamic shading with realistic models of global illumination, calculated in real time.  Using path tracing for fully dynamic lighting allows you to greatly enhance the shading detail of game scenes, naturally creating a complex interaction of sharp and smooth shadows, brilliant materials, and perspective correct reflections.  Moreover, the light can naturally propagate everywhere, linking the scene as it does in the real world.  Traditional solutions with pre-computed lighting or coarse real-time raster approximations will never be able to achieve such granularity at a comparable resolution, because the entire amount of information about lighting will surpass any memory limits. <br><br><h2>  Technical details </h2><br>  Q2VKPT uses a variety of techniques that allow you to adapt computationally costly methods to games that were previously used only in the film industry.  Their core is an adaptive time filter that intelligently reuses the results of calculations from previous frames (this is <a href="https://cg.ivd.kit.edu/atf.php">Christophe‚Äôs previous research project</a> ).  This filter is used on top of the already widespread temporal anti-aliasing and extends the process of tracking temporal changes from a simple image space to a high-dimensional space of light paths.  Tracking path changes is necessary because path tracing is a randomized algorithm, which is its strengths and weaknesses: it can process all types of light propagation in a generalized form, but it can take a long time, too long for one to make the results reliable. frame in a real time game.  A simple solution in image space (for example, temporal anti-aliasing) cannot cope with this level of uncertainty. <br><br>  Above the temporal filtering, we explored several techniques for finding sources of light that affect every surface in the game.  Choosing the right light sources is crucial for picture quality, because if you make the wrong choice, we will get very unreliable output of the path scanner, which will force the time filter to remove all the beautiful details that the path scanner should have created.  The original prototype used a complete hierarchy of sources of illumination common in the film industry: dividing sources of illumination across the hierarchy, we can simultaneously calculate the effect of several sources, which allows us to quickly exclude distant and weak sources from the calculation, as well as sources that are not in the same direction.  However, it turned out that such calculations are difficult to make accurate, and the computational costs of bypassing the hierarchy are difficult to control.  Since the original Quake II used sets of potentially visible spaces (Potentially-Visible-Set) to cut off the invisible parts of the scene, we decided to avoid extracting from these sets lists of potentially visible sources for each part of the scene.  In the current version, we have implemented a partially accurate calculation of the influence of each source in the list, randomly selecting the appropriate subset of these lists in each frame.  Therefore, the renderer quickly finds all sources of illumination, and we can perform all calculations of the influence of illumination over controlled, constant periods of time. <br><br><h2>  Questions and answers </h2><br><h4>  Why does my game crash? </h4><br>  We are engaged in this project in our spare time, so we lack the strength for careful quality control.  Please post a bug in the <a href="https://github.com/cschied/q2vkpt/issues/">issue tracker of</a> our GitHub repository! <br><br><h4>  Why are there no particles?  I need flies and sparks from railgun! </h4><br>  Unfortunately, we didn‚Äôt have enough time to add lighting sources to railgun.  As for other particles, the decision we made to perform raytracing only slightly complicated the process of rendering particles.  If we find time, we will fix it in the future! <br><br><h4>  Nowadays, games and so look realistic!  Why use path tracing? </h4><br>  Modern games have greatly expanded the capabilities of traditional, rasterized graphics.  However, these improvements have to pay their price: the rendering engines of modern games have become extremely intricate sets of narrowly focused techniques.  To achieve an acceptable image without artifacts, lighting, shadows and reflections must be calculated separately in many resolutions and scales.  Path tracing and other Monte Carlo rendering techniques make it possible to find a way out of this ever more complex system.  In fact, they have already <a href="https://jo.dreggn.org/path-tracing-in-production/2018/">solved this problem in the film industry</a> .  Our prototype is the first answer to the question of how to achieve this in the video game industry. <br><br><h4>  Quake II is an ancient game!  If these technologies had some future, then today it would work with a frequency of 6000 FPS! </h4><br>  Yes, Quake II is a fairly old game with a fairly low geometry complexity, but the main limiting factor for tracing a path is not ray tracing or geometry complexity.  In fact, the current prototype can trace much more rays without a noticeable decrease in the frame rate.  The computational cost of the technician used in the Q2VKPT prototype mainly depends on the amount of computation of (indirect) light scattering and the number of light sources.  Quake II initially had many sources of lighting, and in this respect it is still a fairly modern game.  In addition, the number of light scattering events does not depend on the complexity of the scene.  Therefore, we can assume that the techniques we use are well suited for more modern games. <br><br><h4>  Why quake II? </h4><br>  Because the sources of Quake II are publicly available, and the game itself has a long history of modding.  This is an excellent sandbox for real-world scientific research.  In particular, the game has an active and competitive gameplay, which sets high demands on the performance and reliability of the rendered rendering techniques.  And finally, Quake II in some sense still remains a fairly modern game, because it was originally released with a sophisticated and artistic lighting design. <br><br><h4>  How can Q2VKPT be used as a benchmark? </h4><br>  Open the console by pressing the "~" key.  In the demo version of Quake 2, you can use the command ‚Äútimedemo 1;  demo q2demo1 ", in the full version - the command" timedemo 1;  demo demo1.  The built-in profiler is started by the ‚Äúvkpt_profiler 1‚Äù command.  It provides details about the timing of the GPU for the individual rendering steps. <br><br><h4>  How is path tracing different from ray tracing? </h4><br>  Path tracing is an elegant algorithm that can simulate a variety of complex ways that light propagates and diffuses in virtual scenes.  His physics based lighting simulation provides high-quality rendering.  Path tracing <u>uses</u> ray tracing to determine visibility between scatter events.  However, ray tracing is simply a primitive operation that can be used for a variety of purposes.  Therefore, ray tracing alone is not capable of creating realistic images.  For this you can use light propagation algorithms like path tracing.  However, despite the fact that it is elegant and very powerful, a naive path tracing is very expensive and takes a lot of time to create stable images.  Our project uses an intelligent adaptive filter that reuses the maximum possible amount of information in several frames and pixels to create reliable and stable images. <br><br><h4>  Tracing the path and ray tracing - the future of game graphics? </h4><br>  The recent appearance of a ray tracing GPU has opened up entirely new possibilities for the future of game graphics, but a non-trivial approach is required to properly use ray tracing.  The goal of our project is to find out what is missing to create a direct path to the future graphics with ray tracing.  Although some problems have already been solved in scientific research, many real problems remain unnoticed until you start implementing the full game renderer.  In the future, we plan to explore some of these problems, for example, better lighting quality, improved filtering and a more complete renderer program structure.  In order for these changes to become large-scale, good solutions are needed for new, unfamiliar tasks of renderers based on ray tracing and paths. <br><br><h4>  Will tracing the path finally solve all the graphics problems? </h4><br>  Tracing paths and methods similar to it elegantly solve many complex tasks of game graphics.  However, their probabilistic nature adds a whole host of new tasks, the solution of which is necessary for creating clear (silent) high-quality images.  The filtering method in the Q2VKPT prototype is the first step to robust unified methods that allow the rendering of a fully unified brute force approach using path tracing.  In the coming months and years, we expect and hope to see other research in this direction! <br><br><h4>  Does Q2VKPT use lighting maps from the original game? </h4><br>  The original Quake 2 engine uses pre-computed lighting maps containing soft shadows and diffuse indirect lighting.  Q2VKPT completely replaces static lighting with fully dynamic simulation, unifying both static and dynamic lighting sources. <br><br><h4>  How many rays Q2VKPT emits per pixel? </h4><br>  The amount of light emitted depends on the first visible surface.  On opaque surfaces, Q2VKPT uses one ray for each pixel to find a direct and indirect visible surface.  In addition, for both surfaces, Q2VKPT emits a single beam to randomly selected light sources.  Therefore, Q2VKPT emits at least 4 rays for each pixel. <br><br><h4>  Is rasterization used in Q2VKPT? </h4><br>  Traditionally, a rasterizer is used to find surfaces visible from the camera in games.  In Q2VKPT, visualization is fully performed by ray tracing, so the rasterizer is not used (with the exception of two-dimensional user interface elements). </div><p>Source: <a href="https://habr.com/ru/post/436754/">https://habr.com/ru/post/436754/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>