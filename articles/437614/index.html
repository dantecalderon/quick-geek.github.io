<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Architectural pattern "Iterator" ("Iterator") in the universe "Swift"</title>
  <meta name="description" content="Iterator is one of the design patterns that programmers most often overlook, because its implementation is usually built directly into standard progra...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>Architectural pattern "Iterator" ("Iterator") in the universe "Swift"</h1><div class="post__text post__text-html js-mediator-article">  <a href="https://en.wikipedia.org/wiki/Iterator">Iterator</a> is one of the design patterns that programmers most often overlook, because its implementation is usually built directly into standard programming language tools.  However, this is also one of the behavioral patterns described in the <a href="https://en.wikipedia.org/wiki/Design_Patterns">book ‚ÄúGangs of Four‚Äù, ‚ÄúGoF‚Äù, ‚ÄúDesign Patterns‚Äù (‚ÄúDesign Patterns:</a> its device never hurts, and sometimes it can even help. <br><a name="habracut"></a><br>  <i>An "iterator" is a method of sequential access to all elements of a composite object (in particular, container types, such as an array or a set).</i> <br><br><h3>  Standard language tools </h3><br>  Create some kind of <a href="https://developer.apple.com/documentation/swift/array">array</a> : <br><br><pre><code class="plaintext hljs">let numbersArray = [0, 1, 2]</code> </pre> <br>  ... and then "walk" through it: <br><br><pre> <code class="plaintext hljs">for number in numbersArray { print(number) }</code> </pre><br>  ... seems like a very natural action, especially for modern programming languages ‚Äã‚Äãsuch as <a href="https://en.wikipedia.org/wiki/Swift_(programming_language)">Swift</a> .  However, behind the "scenes" of this simple action is the code that implements the principles of the "Iterator" pattern. <br><br>  In Swift, in order to be able to ‚Äúiterate‚Äù a variable using <code>for</code> cycles, the type of the variable must implement <a href="https://docs.swift.org/swift-book/LanguageGuide/Protocols.html">the</a> <a href="https://developer.apple.com/documentation/swift/sequence"><code>Sequence</code></a> <a href="https://docs.swift.org/swift-book/LanguageGuide/Protocols.html">protocol</a> .  Among other things, this protocol requires the type to have a <code><a href="https://docs.swift.org/swift-book/LanguageGuide/Generics.html">associatedtype</a></code> <a href="https://developer.apple.com/documentation/swift/sequence/1641120-iterator"><code>Iterator</code></a> , which in turn must implement the requirements of the <a href="https://developer.apple.com/documentation/swift/iteratorprotocol"><code>IteratorProtocol</code></a> protocol, as well as the <a href="https://en.wikipedia.org/wiki/Factory_method_pattern">factory method</a> <a href="https://developer.apple.com/documentation/swift/sequence/2885155-makeiterator"><code>makeIterator()</code></a> , which returns a specific ‚Äúiterator‚Äù for this type: <br><br><pre> <code class="plaintext hljs">protocol Sequence { associatedtype Iterator : IteratorProtocol func makeIterator() -&gt; Self.Iterator // Another requirements go here‚Ä¶ }</code> </pre><br>  The <code>IteratorProtocol</code> protocol, in turn, contains only one method - <a href="https://developer.apple.com/documentation/swift/iteratorprotocol/1641682-next"><code>next()</code></a> , which returns the next element in the sequence: <br><br><pre> <code class="plaintext hljs">protocol IteratorProtocol { associatedtype Element mutating func next() -&gt; Self.Element? }</code> </pre><br>  It sounds like a lot of complex code, but in fact it is not.  Below we will see this. <br><br>  The <code>Array</code> type implements the <code>Sequence</code> protocol (though not directly, but through the <a href="https://docs.swift.org/swift-book/LanguageGuide/Protocols.html">protocol inheritance</a> chain: <a href="https://developer.apple.com/documentation/swift/mutablecollection"><code>MutableCollection</code></a> inherits <a href="https://developer.apple.com/documentation/swift/collection"><code>Collection</code></a> requirements, and that is <code>Sequence</code> requirements), so its instances, in particular, can be ‚Äúiterated‚Äù using <code>for</code> cycles. <br><br><h3>  Custom types </h3><br>  What needs to be done to be able to iterate your own type?  As often happens, the easiest way to show an example. <br><br>  Suppose there is a type that represents a bookshelf that stores a certain set of instances of a class, which in turn represents a book: <br><br><pre> <code class="plaintext hljs">struct Book { let author: String let title: String } struct Shelf { var books: [Book] }</code> </pre><br>  To be able to "iterate" an instance of the <code>Shelf</code> class, this class must comply with the requirements of the <code>Sequence</code> protocol.  For this example, it will be enough just to implement the method <code>makeIterator()</code> , especially since the other protocol requirements have <a href="https://docs.swift.org/swift-book/LanguageGuide/Protocols.html">default implementations</a> .  This method should return an instance of the type implementing the <code>IteratorProtocol</code> protocol.  Fortunately, in the case of Swift, this is very little very simple code: <br><br><pre> <code class="plaintext hljs">struct ShelfIterator: IteratorProtocol { private var books: [Book] init(books: [Book]) { self.books = books } mutating func next() -&gt; Book? { // TODO: Return next underlying Book element. } } extension Shelf: Sequence { func makeIterator() -&gt; ShelfIterator { return ShelfIterator(books: books) } }</code> </pre><br>  The <code>next()</code> method of the <code>ShelfIterator</code> type <code>ShelfIterator</code> declared <a href="https://docs.swift.org/swift-book/LanguageGuide/Methods.html"><code>mutating</code></a> , because an instance of the type must in one way or another store the state corresponding to the current iteration: <br><br><pre> <code class="plaintext hljs">mutating func next() -&gt; Book? { defer { if !books.isEmpty { books.removeFirst() } } return books.first }</code> </pre><br>  This implementation always returns the first element in the sequence, or <code>nil</code> if the sequence is empty.  The <a href="https://docs.swift.org/swift-book/ReferenceManual/Statements.html"><code>defer</code></a> block <a href="https://docs.swift.org/swift-book/ReferenceManual/Statements.html"><code>defer</code></a> change code of the iterated collection, which deletes the element of the last iteration step immediately after the method returns. <br><br>  Usage example: <br><br><pre> <code class="plaintext hljs">let book1 = Book(author: "–§. –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π", title: "–ò–¥–∏–æ—Ç") let book2 = Book(author: "–§. –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π", title: "–ë—Ä–∞—Ç—å—è –ö–∞—Ä–∞–º–∞–∑–æ–≤—ã") let book3 = Book(author: "–§. –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π", title: "–ë–µ–¥–Ω—ã–µ –ª—é–¥–∏") let shelf = Shelf(books: [book1, book2, book3]) for book in shelf { print("\(book.author) ‚Äì \(book.title)") } /* –§. –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π ‚Äì –ò–¥–∏–æ—Ç –§. –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π ‚Äì –ë—Ä–∞—Ç—å—è –ö–∞—Ä–∞–º–∞–∑–æ–≤—ã –§. –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π ‚Äì –ë–µ–¥–Ω—ã–µ –ª—é–¥–∏ */</code> </pre><br>  Since  all types used (including <code>Array</code> , the underlying <code>Shelf</code> ) are based on the <a href="https://docs.swift.org/swift-book/LanguageGuide/ClassesAndStructures.html">semantics of values ‚Äã‚Äã(as opposed to references)</a> , you can not worry that the value of the original variable will be changed during the iteration process.  When dealing with types based on link semantics, this point should be kept in mind and taken into account when creating your own iterators. <br><br><h3>  Classic functionality </h3><br>  The classic ‚Äúiterator‚Äù described in the book ‚ÄúGangs of Four‚Äù, in addition to returning the next element of the iterated sequence, can also return the current element during the iteration at any time, the first element of the iterated sequence and the value of the ‚Äúflag‚Äù indicating elements in an iterable sequence relative to the current iteration step. <br><br>  Of course, it would be easy to declare a protocol, thus extending the capabilities of the standard <code>IteratorProtocol</code> : <br><br><pre> <code class="plaintext hljs">protocol ClassicIteratorProtocol: IteratorProtocol { var currentItem: Element? { get } var first: Element? { get } var isDone: Bool { get } }</code> </pre><br>  The first and current elements are returned as optional.  source sequence may be empty. <br><br>  Option simple implementation: <br><br><pre> <code class="plaintext hljs">struct ShelfIterator: ClassicIteratorProtocol { var currentItem: Book? = nil var first: Book? var isDone: Bool = false private var books: [Book] init(books: [Book]) { self.books = books first = books.first currentItem = books.first } mutating func next() -&gt; Book? { currentItem = books.first books.removeFirst() isDone = books.isEmpty return books.first } }</code> </pre><br>  In the original description of the pattern, the <code>next()</code> method changes the internal state of the iterator to go to the next element and is of type <a href="https://developer.apple.com/documentation/swift/void"><code>Void</code></a> , and the current element is returned by the <code>currentElement()</code> method.  In the <code>IteratorProtocol</code> protocol, these two functions are combined into one. <br><br>  The need for the <code>first()</code> method is also doubtful, since  the iterator does not change the original sequence, and we always have the opportunity to refer to its first element (if present, of course). <br><br>  And, since the <code>next()</code> method returns <code>nil</code> , when the iteration is finished, the <code>isDone()</code> method also becomes useless. <br><br>  However, for academic purposes, it is quite possible to come up with a function that could use the full functionality: <br><br><pre> <code class="plaintext hljs">func printShelf(with iterator: inout ShelfIterator) { var bookIndex = 0 while !iterator.isDone { bookIndex += 1 print("\(bookIndex). \(iterator.currentItem!.author) ‚Äì \(iterator.currentItem!.title)") _ = iterator.next() } } var iterator = ShelfIterator(books: shelf.books) printShelf(with: &amp;iterator) /* 1. –§. –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π ‚Äì –ò–¥–∏–æ—Ç 2. –§. –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π ‚Äì –ë—Ä–∞—Ç—å—è –ö–∞—Ä–∞–º–∞–∑–æ–≤—ã 3. –§. –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π ‚Äì –ë–µ–¥–Ω—ã–µ –ª—é–¥–∏ */</code> </pre><br>  The <code>iterator</code> parameter is declared <a href="https://docs.swift.org/swift-book/LanguageGuide/Functions.html"><code>inout</code></a> , because  its internal state changes during the execution of the function.  And when a function is called, the iterator instance is not transmitted directly by its own value, but by reference. <br><br>  The result of calling the <code>next()</code> method is not used, imitating the absence of the return value of the textbook implementation. <br><br><h3>  Instead of conclusion </h3><br>  It seems that is all I wanted to say this time.  All beautiful code and deliberate writing it! <br><br>  <b>My other articles about design patterns:</b> <br>  <a href="https://habr.com/ru/post/432558/">Architectural pattern "Visitor" ("Visitor") in the universe of "iOS" and "Swift"</a> </div><p>Source: <a href="https://habr.com/ru/post/437614/">https://habr.com/ru/post/437614/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>