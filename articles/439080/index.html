<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Unobvious RabbitMQ in Yii2 or why RabbitMQ writes to all queues at once</title>
  <meta name="description" content="I want to share the practical problem of configuring the RabbitMQ queue broker in Yii2. I warn the reader that I do not have an expert opinion on work...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>Unobvious RabbitMQ in Yii2 or why RabbitMQ writes to all queues at once</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/webt/7e/1v/k7/7e1vk7xprusmt0uhpyxpr3ll-j8.jpeg"></div><br>  I want to share the practical problem of configuring the RabbitMQ queue broker in Yii2.  I warn the reader that I do not have an expert opinion on working with this queue broker, but I really want to fill in the gaps of the Yii2 documentation and consolidate the result of my own torment.  So, if you have ever encountered the problem that sent messages fall into all the queues that are on the queue server, you agree that this is a problem and you do not understand why this is happening, then I ask for cat. <br><a name="habracut"></a><br>  Why can you face such behavior?  For example, if you, like I did not work with RabbitMQ before, but worked for example with Gearman.  Sam Gearman, simple as a railway ( <s>borrowed from a well-known and respected on-line character</s> ).  You create a queue with a name, put data there.  A worker is reading from a queue with the same name.  It's simple.  Now it‚Äôs time to use trendy technologies, without knowing why you choose RabbitMQ.  Then rejoice that in Yii2 <a href="https://github.com/yiisoft/yii2-queue">there is a</a> ready abstraction for many popular queue brokers.  The meager documentation prompts the default configuration to get everything started: <br><br><pre><code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-string"><span class="hljs-string">'bootstrap'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'queue'</span></span>, <span class="hljs-comment"><span class="hljs-comment">// The component registers its own console commands ], 'components' =&gt; [ 'queue' =&gt; [ 'class' =&gt; \yii\queue\amqp_interop\Queue::class, 'port' =&gt; 5672, 'user' =&gt; 'guest', 'password' =&gt; 'guest', 'queueName' =&gt; 'queue', 'driver' =&gt; yii\queue\amqp_interop\Queue::ENQUEUE_AMQP_LIB, // or 'dsn' =&gt; 'amqp://guest:guest@localhost:5672/%2F', // or, same as above 'dsn' =&gt; 'amqp:', ], ], ];</span></span></code> </pre> <br>  It would seem that everything to the <i>point of</i> insanity is simple, here's a familiar string with <i>queueName</i> , copy-paste, fix, run - it works!  Making queues for other components of the system.  We parallelize what can our php.  Commit, Push satisfied put the task in QA and go read Habr ( <s>at lunchtime</s> ). <br><br>  Here, on the most interesting, QA interrupts us in the chat, and says that something strange is happening.  For some reason, the data that workers (kosumery) write are duplicated.  I'm sorry, what?  It can not be.  We go to check the logs.  We see that the message is written to the queue, and the queue is correctly selected, hash jobId is received.  No, no, we don't have any mistakes.  We write satisfied QA, check again, it can not be this, we are fine. <br><br>  Literally half an hour later we were distracted again, the error repeated, and a notification immediately fell on the soap - the task was transferred back to work.  Well, I'm a programmer, now let's figure it out.  RabbitMQ, unlike Gearman, has a web interface, in which there is a lot of information about server operation.  This miracle looks like this: <br><br><img src="https://habrastorage.org/webt/hb/gj/mh/hbgjmh691g7hqj9zesqnl0j9dso.png"><br><br>  We throw a couple more messages into the queue, we see in the webmord that our messages are received and processed by the worker.  A casual glance observes that when we throw a message into a queue, the message rates graph jumps up in all queues. <br><br><img src="https://habrastorage.org/webt/ww/kl/6u/wwkl6u3aaqymtxvgvfjkqzmnnea.png"><br><br>  We check the configuration a hundred more times, reread the meager documentation of Yii.  We did everything right.  Go read the documentation on the site rabbit'a.  After a couple of tens of minutes wandering in the dark, we come across a <a href="https://www.rabbitmq.com/tutorials/tutorial-three-php.html">tutorial</a> .  Immediately after the first paragraph we are introduced to the cause of our misunderstandings - Exchanges.  I will not repeat the documentation, very briefly. <br><br>  In RabbitMQ, we do not write a message to a queue, we write it in exchange, a sort of proxy that accepts our messages at one end and communicates with queues on the server at the other end.  It is in his power to make decisions in which turn to put our data.  It is interesting that in the Yii documentation there is not a single line about this.  At first glance, it is not clear how to configure the exchange, dive into the intestines and in the file <i>vendor / yiisoft / yii2-queue / src / drivers / amqp_interop / Queue.php: 176</i> we find the cherished property that can be set.  Here I must say that there are a lot of drivers for RabbitMQ, in my case <i>enqueue / amqp-lib is used</i> .  We set <i>exchangeName</i> , we test, nothing changes.  We are like a real Russian engineer, first we try, and then we go thoughtfully to read the documentation again.  We read carefully again, then go to the rabbit's web and see the following: <br><br><img src="https://habrastorage.org/webt/zp/_y/o5/zp_yo5nzamanqo-lptarpv_nswu.png"><br><br>  Several of our queues are associated with the same exchange.  Bingo!  Here it is the reason, one ‚Äúbut‚Äù, I did not connect them.  Go back to the driver's gut, find the <i>setupBroker</i> method line 392 <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;context-&gt;bind(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AmqpBind($queue, $topic));</code> </pre><br>  This is unmanaged binding. <br><br>  And so, after a brief reflection, we come to the conclusion that for each queue a separate exchange must be declared, then the connection will be correct and one exchange will have only one connected queue.  this way we achieve the same gearman behavior.  By the way, the documentation describes in detail what the exchange is for, and as I understand it, one of the reasons is the possibility to associate several queues with exchange.  But I didn‚Äôt think what kind of case it is, when it may be necessary, guys write in the comments.  And write, have you encountered the situation described above, or am I doing everything wrong? </div><p>Source: <a href="https://habr.com/ru/post/439080/">https://habr.com/ru/post/439080/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>