<div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0b8/261/fcb/0b8261fcbf965321f750c1e272b37339.jpg" alt="image"></div><br>  Recently, along with the minmax.gg/chickendinner <a href="https://minmax.gg/chickendinner" rel="noopener">replays,</a> we have released a new feature that displays videos broadcast by the PUBG Twitch streamers participating in the match.  To implement it, we needed to recognize Twitch streamers by their in-game names, which turned out to be a rather interesting task. <br><a name="habracut"></a><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/728/4b0/b8f/7284b0b8f675134aa04dc46398a52e1b.gif"></div><br>  <i>Our new Twitch feature in action.</i> <br><br><h2>  The probability that you play in one match with a streamer </h2><br>  Before we started developing this feature, we wanted to make sure that the probability of a match in which some of the players were streaming on Twitch is large enough to justify our efforts.  We can make a very rough estimate by looking at the number of active players and comparing it with the number of active broadcasts. <br><br>  At the time of this writing, the game was broadcast on Twitch about 2100 users, and on Steam there were about 700 thousand active players in PUBG.  This means that at this time the streamers accounted for approximately 0.3% of the player base. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5a6/ca3/24f/5a6ca324f8fb9d22756caec476464959.png"></div><br>  Considering that 100 people most often play in a match, the likelihood that at least one of them will be a streamer is inverse to the likelihood that <em>no one</em> will be a streamer.  Since the probability that the player is not a streamer is 99.7%, the probability that none of the 100 players will be a streamer is 0.997 to the power of 100, that is, 0.74.  In other words, in any match there is approximately a 25 percent chance of finding at least one player streaming to Twitch. <br><br>  It is worth noting that we can assume on Twitch a strong shift towards the North America region compared to the general PUBG player base, so if you watch matches from North America, the percentage is likely to be much higher. <br><br><h2>  Guess the names </h2><br>  Now that we know that there is a good chance of finding a streamer in any chosen match, how do we know that the player is streaming the game on Twitch? <br><br>  For more bonuses, you can connect your Twitch account to the game, but, unfortunately, this data is not available from the <a href="https://developer.playbattlegrounds.com/" rel="noopener">PUBG API</a> .  We need another way of binding the player's name to a streamer on Twitch. <br><br>  Let's look at a hypothetical tape drive called the <em>Mitch</em> account.  Mitch regularly plays PUBG, but his Twitch channel has not yet reached the level of views that he dreams of.  Upon reflection, he changes his in-game name to <em>TwitchMitch</em> .  Now everyone knows that Mitch is streaming on Twitch. <br><br>  This principle is very common, sometimes with slightly different variations: <em>TTVMitch</em> or <em>Mitch_TV</em> .  Such names can be detected programmatically and an account can be determined from them on Twitch, allowing us to receive videos for display in the match replay. <br><br><h2>  Manual mapping </h2><br>  This approach gives us a very good reference point, but it is far from enough.  The names of most popular streamers do not match this pattern.  To discover them, you must individually link from the PUBG account to the name of their Twitch channel. <br><br>  To deal with this, we began to manually search for the most popular streamers in Twitch, and record in-game account names that are visible on the screen.  If you are lucky, you will be able to catch the moment when the player is waiting in the lobby, where you can find the name in several places: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7e0/2b0/d11/7e02b0d118ff09436f925b0e641e8c38.png"></div><br>  However, it is much more likely to find a player already playing in a match.  If he plays with a team, his name will always be visible in the lower left corner: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ad8/030/bda/ad8030bda4f3f0bc2ebf969b90fa612b.png"></div><br>  However, it is necessary to calculate which of the names belongs to him, because it will not always be the same.  The easiest way to do this is by looking at the minimap in the lower right corner, which is centered on the player’s marker, marked with a number and color. <br><br>  The most holistic approach would be to explore the bottom center of the screen, where you can find the following: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/405/15c/f0b/40515cf0b945f4a13e4f9363054bee81.png"></div><br>  This text contains the account name, the current version of the game, the last 6 characters of the match ID and the server region.  It is worth considering that it is not always as clean as shown above, because it is usually mixed with what is happening behind it on the screen.  The text is small, which means it can be blurred and poorly read when serious video artifacts arise.  But sooner or later you will catch a good enough frame to read it. <br><br>  Perhaps you are already thinking about what we realized at that time - this is an ideal task for an automatic computer solution! <br><br><h2>  Computer vision </h2><br>  Under ideal conditions, the <a href="https://en.wikipedia.org/wiki/Optical_character_recognition" rel="noopener">OCR</a> algorithm should recognize what is written in the text below.  After trying a couple of options, we finally decided that the best results are provided by the Google <a href="https://cloud.google.com/vision/" rel="noopener">Cloud Vision API</a> .  We can create a script that does the following: <br><br><ol><li>  Receives a live broadcast of PUBG and cuts the bottom of the screenshot ( <a href="https://dev.twitch.tv/">Twitch API</a> provides a full-size preview image, so we don’t need to take screenshots). </li><li>  Sends a screenshot to the Cloud Vision API and parses the name of the player from the result. </li><li>  It is convinced through the PUBG API that the player exists, and then saves the binding of the Twitch account to the PUBG account in our database. </li></ol><br>  It works great, except for one small detail: Google asks for $ 1.5 for every thousand requests to the Cloud Vision API.  At any time there can be about 2-3 thousand active streamers, so even a single script launch will cost us up to 4.5 dollars.  Taking into account the fact that we will most likely get a lot of screenshots with unreadable text, then to get some meaningful amount of data you will need to run the script several times.  In other words, this approach will quickly become a very costly undertaking.  Fortunately, we can organize requests to Cloud Vision a little smarter.  We can use the fact that Google asks for payment for individual requests, regardless of the size of the image.  That is, we can mesh multiple images into a grid: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e90/1ec/f4b/e901ecf4b93fdedc2fa645feee12912f.png"></div><br>  Then we send this image grid to the API and bind the resulting text to a streamer corresponding to the area in which the text was found. <br><br>  There is a limit on the size of data simultaneously sent by Google, so we will take on a request for 300 images glued together.  This means that we can now run the same script 300 times at the same price as before, which makes this approach very viable and efficient. <br><br><h2>  Fill in the last spaces </h2><br>  Our script worked for a couple of weeks, and so far we have scored 25 thousand comparisons between Twitch and PUBG.  However, some streamers could not bind the script, for example, those who have their own overlay on top of the text at the bottom of the screen. <br><br>  These streamers we have to bind manually.  Instead of doing this on our own, we decided to add a function that allows our visitors to send the name of any tape drive that they did not find in our database: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4cd/180/4ce/4cd1804ce5d78b7f9cad545af3544b41.png"></div><br>  We are happy to continue to experiment with ways to obtain such pairs of accounts, and even more we want to find new ways to use the information already available.  Wait for new articles from us! </div>