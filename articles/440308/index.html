<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Divide and conquer, or write slowly - read quickly</title>
  <meta name="description" content="In one of my projects, it became necessary to write digitized data sets from 3 ADC channels in sequence. The measurement results had to be saved at a ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>Divide and conquer, or write slowly - read quickly</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/pu/um/_f/puum_foe8kyeiv5ksbwofdsgvb0.jpeg"></p><br><p>  In one of my projects, it became necessary to write digitized data sets from 3 ADC channels in sequence.  The measurement results had to be saved at a speed of 6 KBytes / s, while the duration of the data collection cycle could be a day or more.  Thus, the total amount of information that needed to be stored was 500 MB or more.  As a storage device, it was decided to choose an SD card. </p><a name="habracut"></a><br><p>  The task was complicated by the fact that the design features of the device being created did not allow retrieving a card for reading data.  The <a href="http://ww1.microchip.com/downloads/en/DeviceDoc/Atmel-8387-8-and16-bit-AVR-Microcontroller-XMEGA-A4U_Datasheet.pdf">XMega128A4U</a> controller, on which the task was being implemented at that time, did not have hardware support for SDIO, but allowed working with the card via the SPI interface, the bandwidth of which was fully capable of writing at the required speed, but reading this amount of data into the computer via the SD card via SPI -&gt; controller -&gt; USB-Com converter was rather dreary and took a lot of time. </p><br><p>  After some deliberation (and unsuccessful attempts to somewhat disperse the above combination), it was decided to use a hardware SD Card Reader Controller, which was the <a href="https://datasheet.lcsc.com/szlcsc/Genesys-Logic-GL823_C48653.pdf">GL823</a> chip <a href="https://datasheet.lcsc.com/szlcsc/Genesys-Logic-GL823_C48653.pdf">that</a> supports USB 2.0.  Now it was necessary to provide separate access to the SD card from the controller side via SPI during data acquisition and from the computer side via SDIO, using the <a href="https://datasheet.lcsc.com/szlcsc/Genesys-Logic-GL823_C48653.pdf">GL823</a> during high-speed reading.  This separation was implemented using two 4x 2x1 multiplexers. </p><br><p><img src="https://habrastorage.org/webt/7u/52/xh/7u52xhuv-7zk7siz735v-izcjxi.jpeg"></p><br><p>  The lines from the U2, U3 switches with the ‚ÄúSTM‚Äù prefix are connected to the controller, the lines with the ‚ÄúSD‚Äù prefix to the SD card.  To control the circuit, the SD2MCU signals are used, switching the SD card between the MCU and <a href="https://datasheet.lcsc.com/szlcsc/Genesys-Logic-GL823_C48653.pdf">GL823</a> and GL823_PWR, switching through the mosfet power supply <a href="https://datasheet.lcsc.com/szlcsc/Genesys-Logic-GL823_C48653.pdf">GL823</a> . </p><br><p>  Initially, I considered such an approach as a kind of ‚Äúcrutch‚Äù, but, to my great surprise, it turned out to be quite efficient and was confirmed by the practice of successful operation of the device for several years. </p><br><p>  Moreover, in the following developments based on the <a href="https://www.st.com/content/ccc/resource/technical/document/reference_manual/3d/6d/5a/66/b4/99/40/d4/DM00031020.pdf/files/DM00031020.pdf/jcr:content/translations/en.DM00031020.pdf">STM32F407</a> , which has both SDIO support for accessing the card and the possibility of raising the USB 2.0 HS MSD (albeit via a parallel ULPI interface), the possibility of using a bus-based <a href="https://datasheet.lcsc.com/szlcsc/Genesys-Logic-GL823_C48653.pdf">GL823</a> solution is being considered. </p><br><p>  Using a bunch of <a href="https://www.st.com/content/ccc/resource/technical/document/reference_manual/3d/6d/5a/66/b4/99/40/d4/DM00031020.pdf/files/DM00031020.pdf/jcr:content/translations/en.DM00031020.pdf">STM32F407</a> with an external PHY USB3300, it was possible to achieve a card reading speed of ~ 41 Mbps, while using a hardware card reader, the speed reaches ~ 150 Mbps with other conditions being equal.  The measurements were made by reading a 128 MB file from an SD card formatted in FAT32.  Both approaches have their own nuances of use, but, as it seems to me, both have a ‚Äúright to life‚Äù.  As for the nuances: in my case, during the next iteration of the development of this device, the hardware had to be placed on a 26 mm wide board. </p><br><p>  The <abbr title="printed circuit board">PCB</abbr> layout for the LQFP100 of the <a href="https://www.st.com/content/ccc/resource/technical/document/reference_manual/3d/6d/5a/66/b4/99/40/d4/DM00031020.pdf/files/DM00031020.pdf/jcr:content/translations/en.DM00031020.pdf">STM32F407 package</a> is somewhat difficult in this case, but its ‚Äúyounger brother‚Äù <a href="https://www.st.com/content/ccc/resource/technical/document/reference_manual/3d/6d/5a/66/b4/99/40/d4/DM00031020.pdf/files/DM00031020.pdf/jcr:content/translations/en.DM00031020.pdf">STM32F405</a> in the LQFP64 package was even placed.  But, the <a href="https://www.st.com/content/ccc/resource/technical/document/reference_manual/3d/6d/5a/66/b4/99/40/d4/DM00031020.pdf/files/DM00031020.pdf/jcr:content/translations/en.DM00031020.pdf">STM32F405 has</a> no ULPI, hence USB 2.0 HS is not available for it, and the MSD FS implementation loses much of the speed of reading data from the card.  Using the same solution described above, you can get sufficient speed of access to the SD from the computer while reading data from the device. </p><br><p>  I would be glad if my experience will be useful for someone. </p><br></div><p>Source: <a href="https://habr.com/ru/post/440308/">https://habr.com/ru/post/440308/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>