<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Do YML programmers dream about ansible testing?</title>
  <meta name="description" content="This is the text version of the speech 2018-04-25 on the Saint-Petersburg Linux User Group . Example code here: https://github.com/ultral/ansible-role...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>Do YML programmers dream about ansible testing?</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/ct/me/vo/ctmevotjzsrr0s-5_erinl_pedk.png" alt="kitchen-ci schema"></p><br><p>  This is the text version of the <a href="https://cloud.mail.ru/public/2Rc8/EywUuHHp2">speech</a> 2018-04-25 on the <a href="http://spblug.org/">Saint-Petersburg Linux User Group</a> .  Example code here: <a href="https://github.com/ultral/ansible-role-testing">https://github.com/ultral/ansible-role-testing</a> </p><br><p>  I <a href="http://www.goncharov.xyz/it/make-cm-not-bash-ru.html">assume</a> that you are using <a href="http://www.goncharov.xyz/it/make-cm-not-bash-ru.html">configuration mangement, not bash</a> .  Those.  Your configuration is code.  If we say that infrastructure is code, then the same philosophy should be applied to its creation as for software development.  Have you thought about it?  How is this done?  And the others? </p><a name="habracut"></a><br><h1 id="prerekvizity">  Prerequisites </h1><br><p>  In the described case, there were many introductory: </p><br><ul><li>  A lot of ansible roles. </li><li>  Hyper-V as the main hypervisor. </li><li>  Private cloud with limited capabilities to create virtual machines on the fly. </li><li>  Proxy for access to the Internet. </li><li>  The inability to start testing ansible roles in the docker, because the role is the config of the whole VM, including network settings for example. </li><li>  The desire to use the green wizard policy for the repository with ansible roles. </li></ul><br><p>  Before we make our own, let's compare existing solutions. </p><br><table><thead><tr><th>  Project </th><th>  <a href="https://kitchen.ci/">Test kitchen</a> </th><th>  <a href="https://molecule.readthedocs.io/">Molecule</a> </th><th>  Its </th></tr></thead><tbody><tr><td>  Language </td><td>  ruby </td><td>  python </td><td>  bash / ruby </td></tr><tr><td>  Watchers </td><td>  132 </td><td>  126 </td><td>  0 </td></tr><tr><td>  Stars </td><td>  1413 </td><td>  1154 </td><td>  one </td></tr><tr><td>  Forks </td><td>  502 </td><td>  174 </td><td>  2 </td></tr><tr><td>  License </td><td>  Apache 2.0 </td><td>  MIT </td><td>  Any </td></tr><tr><td>  Commits </td><td>  1929 </td><td>  1264 </td><td>  0 </td></tr><tr><td>  Releases </td><td>  101 </td><td>  121 </td><td>  0 </td></tr><tr><td>  Contributors </td><td>  109 </td><td>  82 </td><td>  five </td></tr></tbody></table><br><table><thead><tr><th>  Name </th><th>  <a href="https://testinfra.readthedocs.io/">testinfra</a> </th><th>  <a href="https://serverspec.org/">serverspec</a> </th><th>  <a href="https://www.inspec.io/">inspec</a> </th><th>  Goss </th></tr></thead><tbody><tr><td>  Github </td><td>  <a href="https://github.com/philpep/testinfra">philpep / testinfra</a> </td><td>  <a href="https://github.com/mizzy/serverspec">mizzy / serverspec</a> </td><td>  <a href="https://github.com/chef/inspec">chef / inspec</a> </td><td>  <a href="https://github.com/aelsabbahy/goss">aelsabbahy / goss</a> </td></tr><tr><td>  Language </td><td>  python </td><td>  ruby </td><td>  ruby </td><td>  go </td></tr><tr><td>  Watchers </td><td>  93 </td><td>  145 </td><td>  165 </td><td>  67 </td></tr><tr><td>  Stars </td><td>  997 </td><td>  2105 </td><td>  1167 </td><td>  2170 </td></tr><tr><td>  Forks </td><td>  138 </td><td>  361 </td><td>  330 </td><td>  156 </td></tr><tr><td>  License </td><td>  Apache 2.0 </td><td>  MIT </td><td>  Apache 2.0 </td><td>  Apache 2.0 </td></tr><tr><td>  Commits </td><td>  380 </td><td>  1854 </td><td>  4609 </td><td>  309 </td></tr><tr><td>  Releases </td><td>  35 </td><td>  282 </td><td>  346 </td><td>  47 </td></tr><tr><td>  Contributors </td><td>  43 </td><td>  110 </td><td>  159 </td><td>  31 </td></tr></tbody></table><br><p>  We decided not to <a href="https://habr.com/en/post/342216/">reinvent the wheel</a> and take a turnkey solution.  Our infrastructure team knows how to ruby ‚Äã‚Äãso <a href="https://kitchen.ci/">Test Kitchen</a> &amp; <a href="https://www.inspec.io/">inspec</a> was chosen </p><br><h1 id="kitchen-ci">  Kitchen-ci </h1><br><p><img src="https://habrastorage.org/webt/ct/me/vo/ctmevotjzsrr0s-5_erinl_pedk.png" alt="kitchen-ci schema"></p><br><p>  The idea is ugly simple.  Create a new virtual machine, apply the role, run smoke-test. </p><br><h1 id="green-build-policy">  Green build policy </h1><br><p><img src="https://habrastorage.org/webt/0i/pj/ky/0ipjkykp-b0bmksesauecyoxbdi.png" alt="Green build policy schema"></p><br><p>  But we decided to go further.  Use ala github flow, i.e.  roles in separate branches and after a review in the master.  If the tests are ok, then roll the role on the infrastructure. </p><br><h1 id="vlozhennaya-virtualizaciya">  Nested Virtualization </h1><br><p>  As you remember, we had restrictions on the creation of virtual machines, so we had to make an unattractive solution in the form of nested virtualization. </p><br><p><img src="https://habrastorage.org/webt/cy/5r/pn/cy5rpnk2a-hhcqzuyfszpfnvdfo.jpeg" alt="we need to go deeper"></p><br><p>  Initially tried Virtualbox x32 not to include support of nested.  This turned out to be not so much an idea because of the stable kernel panic.  The second important factor is that we are sitting on x86_64, so the research continued (hello libvirt), but stopped at virtualbox as more common on supported OS. </p><br><h1 id="slozhnosti">  Difficulties </h1><br><p>  During the launch it was all good there were a number of difficulties </p><br><h2 id="prokinut-nastroyki-proxy-s-hosta-v-gostya-gostya">  Proxy settings proxy from host to guest </h2><br><p>  In some test scripts, proxy settings were used, while on the host with the testkitchen, a transparent proxy was used and the ansible bonus did not accept extra variables with empty values. </p><br><p>  <em>Solution:</em> trite - create an ERB template. </p><br><pre><code class="plaintext hljs">&lt;%= ENV['http_proxy'].to_s.empty? ? 'http://proxy.example.com:3128' : ENV['http_proxy'] %&gt;</code> </pre> <br><h2 id="upravlenie-setevymi-nastroykami-cherez-ansible">  Manage network settings via ansible </h2><br><p>  In some roles, the network was configured; in the tests, it looked like this: </p><br><ul><li>  We set up the network by copying the file. </li><li>  Apply network settings. </li><li>  Everything is bad. </li></ul><br><p>  <em>Solution:</em> Add an interface to the virtual machine </p><br><h2 id="esli-testovyy-nabor-soderzhi-_-vse-padaet">  If the test set contains "_" everything falls </h2><br><p>  Virtualbox cannot use "_" in the name of the virtual machine.  And the virtual machine used the name of the script. </p><br><p>  <em>Solution:</em> rename test sets "vm_" =&gt; "vm-" </p><br><h2 id="testovye-scenarii-s-ustanovkoy-oracle-bez--v-konce-imeni-virtualnoy-mashiny-padayut">  Test scripts with installing Oracle without "."  at the end of the virtual machine name fall </h2><br><p>  The role used in the conditional sale, when they decided to cover it with tests.  When you roll it over to a prepared vm - the role is fulfilled, it falls through the testkitchen. </p><br><p>  Small hint </p><br><pre> <code class="plaintext hljs">[root@vm-oracle vagrant]# getent ahosts vm-oracle 127.0.0.1 STREAM vm-oracle 127.0.0.1 DGRAM 127.0.0.1 RAW [root@vm-oracle vagrant]# getent ahosts vm-oracle. fe80::a00:27ff:febd:bd6a STREAM vm-oracle fe80::a00:27ff:febd:bd6a DGRAM fe80::a00:27ff:febd:bd6a RAW 10.0.2.15 STREAM 10.0.2.15 DGRAM 10.0.2.15 RAW [root@oracle vagrant]# getent ahosts oracle.example.com. 192.168.128.182 STREAM oracle.example.local 192.168.128.182 DGRAM 192.168.128.182 RAW</code> </pre> <br><p>  Any idea what's going on? </p><br><p>  It was a funny script: </p><br><ol><li>  We have enabled IPv4 binding only in the oracle listener settings. </li><li>  oracle uses FQDN. </li><li>  linux contains a special database "myhostname" for resolving domain names, it was used after / etc / hosts &amp; dns servers. </li><li>  Vagrant creates a VM &amp; updates <code>/etc/hosts</code> . </li></ol><br><p>  I'll explain a little: <br>  What happens in the case of <em>vm-oracle</em> ? </p><br><ol><li>  vagrant creates a virtual machine. </li><li>  vagrant updates <code>/etc/hosts</code> ( <em>vm-oracle</em> x2) </li><li>  oracle listener listens on ipv4. </li><li>  oracle listeners resolves the domain name <em>vm-oracle.</em>  &amp; gets IPv6. </li><li>  FAILED </li></ol><br><p>  What happens in the case of <em>vm-oracle.</em>  ? </p><br><ol><li>  vagrant creates a virtual machine. </li><li>  vagrant updates / etc / hosts ( <em>vm-oracle</em> &amp; <em>vm-oracle.</em> ). </li><li>  oracle listener listens on ipv4. </li><li>  oracle listeners resolves the domain name <em>vm-oracle.</em>  &amp; gets IPv4 </li><li>  Ok </li></ol><br><h2 id="oom-v-gosti-k-nam-prihodit">  OOM comes to visit us </h2><br><p>  OOM randomly killed virtual machines.  In this case, Testkitchen in its logs gave all sorts of strange messages. </p><br><p>  <em>Solution:</em> Increase the amount of memory. </p><br><h2 id="medlennye-bildy">  Slow builds </h2><br><p>  This whole scheme worked slowly, for tens of minutes, sometimes for more than an hour. </p><br><p>  <em>Solutions:</em> </p><br><ul><li>  <a href="https://www.packer.io/">Packer</a>  Precompile images of virtual machines. </li><li>  Run some test scripts in parallel </li></ul><br><h1 id="zaklyuchenie">  Conclusion </h1><br><p>  If we say that infrastructure is code, then the same philosophy should be applied to its creation as for software development.  On the one hand, the working solution turned out, but there are some unpleasant moments: </p><br><ul><li>  Not friendly it all looks. </li><li>  A mixture of ruby ‚Äã‚Äã&amp; python. </li><li>  There is no validation and impassability of roles. </li><li>  Works slowly. </li><li>  Complicated.... </li></ul><br><p>  At the output, a molecule with docker looks interesting and more native.  We are thinking about it. </p><br><h1 id="ssylki">  Links </h1><br><ul><li>  <a href="https://habr.com/en/post/436960/">English version</a> </li><li>  <a href="https://cloud.mail.ru/public/2Rc8/EywUuHHp2">Slides from the show</a> </li><li>  <a href="https://github.com/ultral/ansible-role-testing">Code example</a> </li><li>  <a href="http://kitchen.ci/">http://kitchen.ci/</a> </li><li>  <a href="https://github.com/chef/kitchen-inspec">https://github.com/chef/kitchen-inspec</a> </li><li>  <a href="https://docs.chef.io/config_yml_kitchen.html">https://docs.chef.io/config_yml_kitchen.html</a> </li><li>  <a href="https://docs.chef.io/ctl_kitchen.html">https://docs.chef.io/ctl_kitchen.html</a> </li><li>  <a href="">https://github.com/neillturner/kitchen-ansible/blob/master/provisioner_options.md</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/437004/">https://habr.com/ru/post/437004/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>