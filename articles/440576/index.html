<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Important changes in the CTE in PostgreSQL 12</title>
  <meta name="description" content="WITH w AS NOT MATERIALIZED ( SELECT * FROM very_very_big_table ) SELECT * FROM w AS w1 JOIN w AS w2 ON w1.key = w2.ref WHERE w2.key = 123;  


 Today,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-6974184241884155",
      enable_page_level_ads: true
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>Important changes in the CTE in PostgreSQL 12</h1><div class="post__text post__text-html js-mediator-article"><pre><code class="postgresql hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> w <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MATERIALIZED</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> very_very_big_table ) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> w <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> w1 <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> w <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> w2 <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> w1.key = w2.<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> w2.key = <span class="hljs-number"><span class="hljs-number">123</span></span>;</code> </pre> <br><p>  Today, a commit has been dropped into the PostgreSQL repository, which allows you to control the processing behavior of the CTE subqueries, namely: you can now explicitly specify whether the subquery will materialize separately or run as part of a single large query. </p><br><p>  This will go into PostgreSQL 12, and this is a big deal.  Let's look at why </p><a name="habracut"></a><br><p>  Programmers love CTEs because it can significantly improve the readability of the code.  Well, indeed, some analytical queries can work with dozens of tables and various groupings and filters.  Write all this in one big request - guaranteed to get something unreadable.  Therefore, with the help of the <code>WITH</code> operator, we sequentially, in small subqueries (which specify a human-readable name), describe the operation logic, and then output the result.  Very comfortably. </p><br><p>  More precisely, <b>it would be</b> very convenient if it were not for one thing: the current PostgreSQL executes these subqueries separately from each other, materializes them (writes the result into a temporary table).  This can lead to a significant slowdown compared to one large unreadable monster.  Especially if CTE subqueries return millions of rows. </p><br><p>  However, there are situations when such a separate implementation works for the good: there is such an optimization trick, when it is better to perform a part of a complex query separately, but the postgres do not understand this themselves.  Then we bring this part to the CTE subquery. </p><br><p>  In general, situations are different, which is why a commit was made in Postgres 12, adding the keywords <code>MATERIALIZED</code> and <code>NOT MATERIALIZED</code> , which indicate whether the query should materialize or inline, respectively. </p><br><p>  Moreover, the default behavior has changed.  Now the CTE subquery will default to inline if its result is used once.  Otherwise, it will materialize as before. </p></div><p>Source: <a href="https://habr.com/ru/post/440576/">https://habr.com/ru/post/440576/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>