<div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/ns/bp/do/nsbpdo-3rgtiavelrrlgrxkgluc.jpeg" alt="Old GLib vs New Clang"></p><br><p>  Tinkering in a variety of open source software, I occasionally find all sorts of interesting things: sometimes it's just a funny comment, sometimes it's something witty in a broader sense.  Such collections periodically appear in the “global Internet” and on Habré - there is, say, a well-known question on StackOverflow about comments in the code, and here a <a href="https://habr.com/ru/company/hflabs/blog/434584/">collection of</a> funny names of legal entities and toponyms was recently <a href="https://habr.com/ru/company/hflabs/blog/434584/">published</a> .  I will try and structure and lay out what I gradually accumulated.  Under the cut you are waiting for quotes from QEMU, the Linux kernel, and not only. </p><a name="habracut"></a><br><h2 id="linux-kernel">  Linux kernel </h2><br><p> I think for many it is not a secret that letters from the Linux Kernel Mailing List periodically disagree on quotes.  So let's take a look at the code.  Immediately, the kernel build system greets us with a surprise: as you know, projects compiled by Autoconf have a Makefile with two standard cleanup targets: <code>clean</code> and <code>distclean</code> .  Naturally, the kernel is not built using Autoconf, and even then only <code>menuconfig</code> costs, so there are more goals here: <code>clean</code> , <code>distclean</code> and <code>mrproper</code> — yes, Mr. Proper, <del>  core cleaner twice as fast </del>  . </p><br><p>  Speaking of the configuration system: I was surprised a long time ago when I stumbled upon it in addition to clear commands like <code>allnoconfig</code> , <code>allyesconfig</code> (I suspect that something <em>strongly debugging</em> can be compiled, so now I would not risk downloading this on real hardware .. .) and <code>allmodconfig</code> on the mysterious purpose of <code>allrandconfig</code> .  “They're mocking me,” I thought, then told my acquaintance about this observation, to which he replied that it was probably quite a meaningful command, but not for actual assembly, but for testing the correctness of the dependencies between the options — as I said now, a fazzing of configuration parameters. </p><br><p>  However, there is life in the core outside the assembly system: documentation is sometimes not only technical, but also a kind of artistic value.  Suppose you want to warn hibernation users of its fragility and risk of data loss if certain rules are not followed.  I would sadly write, they say <em>ATTENTION: &lt;substitute a couple of the most boring lines&gt;</em> .  But the developer who wrote <a href="https://github.com/torvalds/linux/blob/master/Documentation/power/swsusp.txt">this</a> acted differently: </p><br><pre> <code class="plaintext hljs">Some warnings, first. * BIG FAT WARNING ********************************************************* * * If you touch anything on disk between suspend and resume... * ...kiss your data goodbye. * * If you do resume from initrd after your filesystems are mounted... * ...bye bye root partition. * [this is actually same case as above] * * ...</code> </pre> <br><h3 id="malenkie-hitrosti">  Little tricks </h3><br><p>  Not surprisingly, not every code can be compiled with optimizations: when I tried to force them on for all object files, I naturally ran into some source of entropy or something like that, which produced <code>#error</code> if optimization was turned on.  Well, cryptography is like that.  Do you want a code that does not compile if you <strong>turn off</strong> all optimizations, inlining, etc.?  How is this possible?  And this is such a static assert: </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* SPDX-License-Identifier: GPL-2.0 */</span></span> <span class="hljs-comment"><span class="hljs-comment">// ... /* * This function doesn't exist, so you'll get a linker error if * something tries to do an invalidly-sized xchg(). */ extern void __xchg_called_with_bad_pointer(void); static inline unsigned long __xchg(unsigned long x, volatile void *ptr, int size) { unsigned long ret, flags; switch (size) { case 1: #ifdef __xchg_u8 return __xchg_u8(x, ptr); #else local_irq_save(flags); ret = *(volatile u8 *)ptr; *(volatile u8 *)ptr = x; local_irq_restore(flags); return ret; #endif /* __xchg_u8 */ // ... default: __xchg_called_with_bad_pointer(); return x; } }</span></span></code> </pre> <br><p>  It is assumed, apparently, that for any use with a constant argument, this function will unfold into only one branch of the <code>switch</code> , and when used with a <em>valid</em> argument, this branch will not be <code>default:</code> <br>  In a non-optimized form, this function will cause a linking error practically by design ... </p><br><h3 id="znaete-li-vy">  Did you know </h3><br><ul><li>  ... that the kernel has a bytecode JIT compiler from user mode?  This technology is called eBPF and is used for routing, tracing, and more.  By the way, if you are not afraid of experimental "nuclear" tools, look at the bpftools package. </li><li>  ... that the core can go for about five processor days?  There is such a system call <code>sendfile</code> that copies bytes from one file descriptor to another.  If you give it the same descriptor and set the correct offset in the file, it will rewind the same data until it copies 2 GB. </li><li>  ... that there is a variant of the hibernation work carried out by the <a href="https://github.com/torvalds/linux/blob/master/Documentation/power/userland-swsusp.txt">user process</a> - I would not be surprised if it can be saved on the network storage as well. </li></ul><br><h2 id="qemu">  QEMU </h2><br><p>  Generally, when I read Robert Love about the Linux kernel device, and then I got into the QEMU source code, I had a certain feeling of deja vu.  There were lists that are embedded in structures by value (and not like they learn in the initial programming course — via pointers), and a certain RCU subsystem (what it is, I did not fully understand, but it also exists in the kernel) and, probably a lot more similar. </p><br><p>  What is the first thing that a neat person wants to work on on a project?  Probably with a coding style.  And already in this, one might say, ceremonial, document, we see: </p><br><pre> <code class="plaintext hljs">1. Whitespace Of course, the most important aspect in any coding style is whitespace. Crusty old coders who have trouble spotting the glasses on their noses can tell the difference between a tab and eight spaces from a distance of approximately fifteen parsecs. Many a flamewar has been fought and lost on this issue.</code> </pre> <br><p>  Here is also about the perennial question about the maximum length of lines: </p><br><pre> <code class="plaintext hljs">Lines should be 80 characters; try not to make them longer. ... Rationale: - Some people like to tile their 24" screens with a 6x4 matrix of 80x24 xterms and use vi in all of them. The best way to punish them is to let them keep doing it. ...</code> </pre> <br><p>  <em>(Hmm ... It's twice as much on each axis than I sometimes use. Is it such a Linux HD?)</em> </p><br><p>  There is still a lot of interesting - <a href="https://github.com/qemu/qemu/blob/master/CODING_STYLE">read</a> . </p><br><h3 id="i-snova-hitrosti">  And again tricks </h3><br><p>  They say C is a low-level language.  But if it is good to be perverted, it is possible to manifest the wonders of compile-time code generation without any Scala or even C ++. </p><br><p>  For example, in the QEMU codebase, the file <code>softmmu_template.h</code> .  When I saw this name, I thought that it was supposed to be copied into my implementation of the TCG backend and corrected until the correct implementation of the TLB was obtained.  No matter how wrong!  Here's how <strong>to</strong> use it <strong>correctly</strong> : </p><br><p>  <strong>accel / tcg / cputlb.h:</strong> </p><br><pre> <code class="cpp hljs">define DATA_SIZE <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"softmmu_template.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> DATA_SIZE 2 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"softmmu_template.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> DATA_SIZE 4 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"softmmu_template.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> DATA_SIZE 8 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"softmmu_template.h"</span></span></span></span></code> </pre> <br><p>  As you can see, sleight of hand and no C ++.  But this is a pretty simple example.  How about something more complicated? </p><br><p>  There is such a file: <strong>tcg / tcg-opc.h</strong> .  Its content is rather mysterious and looks something like this: </p><br><pre> <code class="cpp hljs">... DEF(mov_i32, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, TCG_OPF_NOT_PRESENT) DEF(movi_i32, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, TCG_OPF_NOT_PRESENT) DEF(setcond_i32, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) DEF(movcond_i32, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, IMPL(TCG_TARGET_HAS_movcond_i32)) <span class="hljs-comment"><span class="hljs-comment">/* load/store */</span></span> DEF(ld8u_i32, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) DEF(ld8s_i32, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) DEF(ld16u_i32, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) DEF(ld16s_i32, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) ...</code> </pre> <br><p>  In fact, everything is very simple - it is used like this: </p><br><p>  <strong>tcg / tcg.h:</strong> </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> TCGOpcode { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> DEF(name, oargs, iargs, cargs, flags) INDEX_op_ ## name, #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"tcg-opc.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">undef</span></span></span><span class="hljs-meta"> DEF NB_OPS, } TCGOpcode;</span></span></code> </pre> <br><p>  Or so: </p><br><p>  <strong>tcg / tcg-common.c:</strong> </p><br><pre> <code class="cpp hljs">TCGOpDef tcg_op_defs[] = { #define DEF(s, oargs, iargs, cargs, flags) \ { #s, oargs, iargs, cargs, iargs + oargs + cargs, flags }, #include <span class="hljs-string"><span class="hljs-string">"tcg-opc.h"</span></span> #undef DEF };</code> </pre> <br><p>  It is even strange that there were no other use cases.  And note, in this case there are no tricky scripts for code generation - only C, only hardcore. </p><br><h3 id="znaete-li-vy-1">  Did you know </h3><br><ul><li>  ... that QEMU can work not only in the full system emulation mode, but also run a separate process for a different architecture, communicating with the host core? </li></ul><br><h2 id="java-jvm-i-vse-vse-vse">  Java, JVM and all-all-all </h2><br><p>  What am I all about Linux?  Let's talk about something cross-platform.  About JVM, for example.  Well, about GraalVM, probably, many developers in this ecosystem have already heard.  If not heard, then in two words: it is epic.  So, after the story of Graal, let's move on to the good old JVM. </p><br><p>  Sometimes the JVM needs to stop all managed flows — the garbage collection stage is so intricate or something else — but luck, stop the flows only at so-called safepoints.  As <a href="http://blog.ragozin.info/2012/10/safepoints-in-hotspot-jvm.html">explained here</a> , a normal global variable check takes a long time, including some shamanism with memory barriers.  What did the developers do?  They limited themselves to one reading of the variable. </p><br><div class="spoiler">  <b class="spoiler_title">Almost like in HQ9 +</b> <div class="spoiler_text"><p>  There is such a joking language - <a href="https://ru.wikipedia.org/wiki/HQ9%252B">HQ9 +</a> .  It was created as a "very convenient educational programming language", namely, it is very easy to perform typical tasks that are given to students: </p><br><ul><li>  on the 'H' command, the interpreter prints Hello, World! </li><li>  on the command 'Q' prints the text of the program itself (quine) </li><li>  on '9' he prints lyrics about <em>99 bottles of the beer</em> </li><li>  by 'i' it increases the variable <strong>i</strong> by one </li><li>  <em>he can't do anything else, but why? ..</em> </li></ul></div></div><br><p>  How does the JVM with one instruction achieve the goal?  And it's very simple - if you stop it, it removes the display for the memory page with this variable - the streams fall along SIGSEGV, and the JVM parks them and removes them from the pause when the “maintenance” ends.  I remember on StackOverflow to the question from the interview <a href="https://stackoverflow.com/questions/65200/how-do-you-crash-a-jvm">How do you crash a JVM?</a>  answered: </p><br><blockquote>  JNI.  In fact, with JNI, crashing is the default mode of operation.  You have to work. </blockquote><p>  Jokes jokes, and sometimes in the JVM it really is. </p><br><p>  Well, since I mentioned the code generation in Scala, and now we are talking about this ecosystem, here's an interesting fact for you: the code generation in Scala (the one that is macros) is approximately as follows: you write code on Scala using the API compiler, and compile it.  Then the next time you start the compiler, you simply pass the resulting code generator to the compiler classpath itself, and the latter, upon seeing a special directive, calls it, passing the syntax trees received during the call.  In response, he receives an AST, which must be substituted at the call site. </p><br><h3 id="osobennosti-ideologiy-licenzirovaniya">  Features of licensing ideologies </h3><br><p>  I like the free software ideology, but it also has some funny features. </p><br><p>  Once, about ten years ago, I updated my Debian stable and, thinking about the syntax of a command, I typed <code>man &lt;команда&gt;</code> in a familiar way, for which I received an exhaustive description like “[program name] is a program with licensed documentation GNU GFDL with unchangeable partitions, which is not DFSG-free. ”  <em>They say that this program was written by some evil proprietors from some FSF ...</em> (Now the <a href="https://www.debian.org/vote/2006/vote_001">discussion</a> is googling.) </p><br><p>  And some small but important library is considered to be non-free software by some distributions, as the author added to the standard permissive license that <em>this program should be used for good and not for evil</em> .  Laughing with laughter, and I, too, would probably be afraid of such a thing in production - is it not enough, what ideas about good and evil from the author. </p><br><h2 id="vsyakoe-raznoe">  Any different </h2><br><h3 id="osobennosti-internacionalnogo-kompilyatorostroeniya-v-period-zakona-mura">  Features of international compiler in the period of Moore's law </h3><br><p>  Severe LLVM developers have limited supported alignment: </p><br><blockquote>  The maximum alignment is 1 &lt;&lt; 29. </blockquote><p>  As they say, it <em>makes you laugh first, and then think</em> : the first thought is that who needs alignment with 512 MiB.  Then I read <a href="https://habr.com/ru/post/436606/">about the development of the kernel on Rust</a> , and there they propose to make the structure “page table” aligned to 4096 bytes.  And as you <a href="https://en.wikipedia.org/wiki/X86-64">read</a> Wikipedia, so there in general: </p><br><blockquote>  48-bit space for more than 512 GB of memory (for about 0.195% of the 256 TB virtual space). </blockquote><br><h3 id="versiya-formata-----kak-hranit">  Format version - how to store? </h3><br><p>  Once I decided to find out why export in one program does not work, <em>but it turns out that it works</em> ... Or not? </p><br><p>  Having manually started backend commands, I realized that, in principle, everything is in order, just the version should be transferred as "2.0", and it simply leaves "2".  Anticipating a trivial correction by editing the string constant, I discover the <code>double getVersion()</code> function <code>double getVersion()</code> - well, what, major is, minor is, even the point is!  However, in the end everything was decided not much harder than expected, I <del>  just increased the accuracy of the output </del>  Forwarded the data type and forwarding the lines. </p><br><h3 id="o-raznice-mezhdu-teoretikami-i-praktikami">  About the difference between theorists and practitioners </h3><br><p>  In my opinion, somewhere on Habré, I have already seen the translation of an article about what is the minimum C program that falls on startup, but still? <code>int main;</code>  - the <code>main</code> symbol is, and <em>technically</em> , you can transfer control to it.  <em><a href="https://habr.com/ru/users/sirikid/" class="user_link">sirikid</a> correctly noted that even <code>int</code> bytes are superfluous here.</em>  <em>In general, even speaking of a program of 9 bytes in size, it is better not to be scattered with statements that it <strong>is the</strong> smallest ...</em> True, the program will fall, but the rules are fully consistent. </p><br><p>  So, we can do what should work, but what about running the non-launch? </p><br><pre> <code class="plaintext hljs">$ ldd /bin/ls linux-vdso.so.1 (0x00007fff93ffa000) libselinux.so.1 =&gt; /lib/x86_64-linux-gnu/libselinux.so.1 (0x00007f0b27664000) libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f0b2747a000) libpcre.so.3 =&gt; /lib/x86_64-linux-gnu/libpcre.so.3 (0x00007f0b27406000) libdl.so.2 =&gt; /lib/x86_64-linux-gnu/libdl.so.2 (0x00007f0b27400000) /lib64/ld-linux-x86-64.so.2 (0x00007f0b278e9000) libpthread.so.0 =&gt; /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007f0b273df000) $ /lib/x86_64-linux-gnu/libc.so.6</code> </pre> <br><p>  ... and libc to him <del>  in a human voice </del>  : </p><br><pre> <code class="plaintext hljs">GNU C Library (Ubuntu GLIBC 2.28-0ubuntu1) stable release version 2.28. Copyright (C) 2018 Free Software Foundation, Inc. This is free software; see the source for copying conditions. There is NO warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. Compiled by GNU CC version 8.2.0. libc ABIs: UNIQUE IFUNC ABSOLUTE For bug reporting instructions, please see: &lt;https://bugs.launchpad.net/ubuntu/+source/glibc/+bugs&gt;.</code> </pre> <br><h3 id="programmisty-igrayut-v-golf">  Programmers play golf </h3><br><p>  There is a whole site on StackExchange dedicated to Code Golf - competitions with the style “Solve this problem with a minimum fine depending on the size of the source code”.  The format itself involves very sophisticated solutions, but sometimes they become very sophisticated.  Therefore, <a href="https://codegolf.meta.stackexchange.com/questions/1061/loopholes-that-are-forbidden-by-default">one of the questions</a> was a collection of standard forbidden loopholes.  I especially like this one: </p><br><blockquote>  Using MetaGolfScript <br>  MetaGolfScript is a family of programming languages.  For example, the program in MetaGolfScript-209180605381204854470575573749277224 prints "Hello, World!". </blockquote><br><h2 id="odnoy-strokoy">  One line </h2><br><ul><li><p>  <a href="https://stackoverflow.com/questions/54120862/does-the-c-standard-allow-for-an-uninitialized-bool-to-crash-a-program">An uninitialized bool that crashes the program</a> , or where the undefined behavior results in </p><br></li><li><p>  ... which, by the way, is magic.  Someone in LLVM joked on April 1, and another report from this made: <a href="https://channel9.msdn.com/Events/CPP/CppCon-2016/CppCon-2016-Michael-Spencer-My-Little-Optimizer-Undefined-Behavior-is-Magic">My little optimizer: undefined behavior is magic</a> </p><br></li><li><p>  Remember the ambiguous call to praise the developers of open source software in the tracker?  In Binaryen it was implemented <a href="https://github.com/WebAssembly/binaryen/issues/1689">simply and with taste</a> : </p><br><blockquote>  <strong>Issue:</strong> This project is AMAZING <br>  <strong>Resolution:</strong> wontfix, works as intended </blockquote><br></li><li><p>  in February 2009, a person <a href="https://stackoverflow.com/questions/524696/how-to-create-a-style-tag-with-javascript">asked a question</a> on StackOverflow: "How can I do this and that cross-browser? Or is it, <em>Three working browsers are great and who uses Chrome anyway?</em> " </p><br></li></ul><br><p>  Finally, where does the title of the article come from?  This is a rephrased trick from the <code>emcc</code> compiler <code>emcc</code> from <a href="https://emscripten.org/">Emscripten</a> : </p><br><pre> <code class="plaintext hljs">$ emcc --help ... emcc: supported targets: llvm bitcode, javascript, NOT elf (autoconf likes to see elf above to enable shared object support)</code> </pre> </div>