<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Setting up backup and recovery of Zimbra OSE entirely and in separate boxes without using Zextras</title>
  <meta name="description" content="1. Where to start 
 How do you start the backup? Planning. When backing up any system, you need to create a backup plan: what exactly, how often, how ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>Setting up backup and recovery of Zimbra OSE entirely and in separate boxes without using Zextras</h1><div class="post__text post__text-html js-mediator-article"><h3>  1. Where to start </h3><br>  How do you start the backup?  Planning.  When backing up any system, you need to create a backup plan: what exactly, how often, how long to store, is there enough free space?  From the answers to these questions follows the answer to the main question - how to back it up? <br><br>  If there is a lot of free space, you can store the entire virtual machine.  Make backups of the same Veeam on a schedule, and not think about the difficulties.  But as for me, it‚Äôs a waste, I‚Äôm used to doing everything as concisely as possible and, if possible, economical.  I, of course, have deployed Veeam, but I only backup them with systems that are either impossible or problematic and can be deployed from backup copies for a very long time. <br><br>  Pro scripts controls the virtual environment just meaningly say nothing. <br><br>  Zimbra has a zmmailbox tool.  And, upon closer examination of its functionality, I realized that it would be more than enough for me.  He can backup and restore boxes even on a live system.  And I liked the ability to backup critical mailboxes separately from the backup of the entire system.  Thus, the space occupied by backups will be limited by the size of the archived mailboxes multiplied by the number of ‚Äúbackup depth‚Äù days, and not by the volume of the entire system multiplied by the same number of days.  In addition, with the backup of the entire system, in the case of Zimbra, it is extremely difficult to recover.  It is much easier to copy a virtual machine using Veeam or virtual environment management tools (Hyper-V, ESXI, enter the necessary) immediately after setting up the system, and put it ‚Äúon the shelf‚Äù so that at a critical moment you can quickly deploy almost nothing weighing VM and fill in it backups of boxes.  In my opinion, this is the least expensive scenario in all respects. <br><a name="habracut"></a><br><h3>  2. Baseline: </h3><br>  <i>Server OS</i> : CentOS 7 <br><br><div class="spoiler">  <b class="spoiler_title">About the OS</b> <div class="spoiler_text">  In fact, the difference between CentOS7 and any other system will be solely in the commands to the server to install packages, and possibly the location of some files.  The work is carried out mainly with Zimbra cmdlets, so the configuration differences will be minimal. </div></div><br>  <i>Zimbra Domain</i> : zimbramail.home.local <br>  <i>Username and password for access to the shared folder</i> : ZimbraBackUp / 123123 <br>  <i>Path to the shared folder</i> : \\ BackUpServer1 \ ZM \ <br>  <i>Path mount balls on Zimbra host</i> : / mnt / ZM / <br><br><h3>  3. Customization </h3><br>  So, let's begin! <br><br>  We will write backups to a server running Windows, in a shared folder.  If you want, you can merge backup copies anywhere, but everything is set up in such a way that most backups are written exactly on BackUpServer1.home.local.  So that: <br><br>  1) Create a user in the domain to access the shared folder on this server so that you can mount it on the Zimbramail.home.local server.  Username ZimbraBackUp, password, conditionally, 123123. <br><br>  2) On the BackUpServer1 server, create a \ ZM \ directory in the repository, and share it with the ZimbraBackUp user for change.  The path to the ball will be: \\ BackUpServer1 \ ZM \ <br><br>  3) Mount the ball to the server Zimbramail.home.local.  In order for the folder to be mounted automatically, you need to correct the / etc / fstab file by adding the line to it: <br><br><pre><code class="bash hljs">//BackUpServer/ZM /mnt/ZM cifs user,uid=500,rw,suid,username=ZimbraBackUp,password=123123 0 0</code> </pre> <br>  But first you need to check if the mount works: <br><br><pre> <code class="bash hljs">$ mount -t cifs //BackUpServer/ZM /mnt/ZM -o user=ZimbraBackUp,password=123123</code> </pre> <br>  Often there is an error like this: <br><br><pre> <code class="bash hljs">mount: wrong fs <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, bad option, bad superblock on //BackUpServer1/ZM/, missing codepage or helper program, or other error (<span class="hljs-keyword"><span class="hljs-keyword">for</span></span> several filesystems (eg nfs, cifs) you might need a /sbin/mount.&lt;<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>&gt; helper program) In some cases useful info is found <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> syslog - try dmesg | tail or so.</code> </pre> <br>  You can fix it by installing cifs-utils: <br><br><pre> <code class="bash hljs">$ yum install cifs-utils</code> </pre> <br>  After setting, I recommend restarting the server. <br><br>  4) Create 3 script files: FullBackUp.sh HandBackUp.sh Restore.sh <br><br>  The first file will be used to automatically create backups on a schedule, the second to enable backup of individual mailboxes, or simply to manually launch "what if."  And the third script is the restoration of one or all of the boxes at once.  I tried to comment on the work of the scripts as much as possible and prescribed logging. <br><br><div class="spoiler">  <b class="spoiler_title">Content of the FullBackUp.sh file:</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #–ö—É–¥–∞ –ø–æ–ª–æ–∂–∏—Ç—å –±—ç–∫–∞–ø Path="/mnt/ZM/BackUps" #–ö—É–¥–∞ –ø–æ–ª–æ–∂–∏—Ç—å –∞—Ä—Ö–∏–≤ –±—ç–∫–∞–ø–∞ ArchPath="/mnt/ZM/Archive" #–ö—É–¥–∞ –ø–æ–ª–æ–∂–∏—Ç—å –º–µ—Å—è—á–Ω—ã–π –±—ç–∫–∞–ø MPath="/mnt/ZM/Mounthly" #–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–º–µ–Ω–∞ Zimbra ZDomain="zimbramail.home.local" #–°–ø–∏—Å–æ–∫ —è—â–∏–∫–æ–≤ MBoxes="/mnt/ZM/MBoxesList" #–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ CDate=$(date +%d-%m-%Y) #–ó–∞–ø–æ–º–∏–Ω–∞–µ–º –¥–µ–Ω—å –º–µ—Å—è—Ü–∞ MDay=$(date +%d) #–ö—É–¥–∞ –ø–∏—Å–∞—Ç—å –ª–æ–≥–∏ log="/mnt/ZM/BackUpLog.txt" echo -en "BackUp ALL MailBoxes started in $(date +%T)\n" &gt;&gt; $log #–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞ –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è if [ ! -d $Path ]; then #–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π echo "–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π..." mkdir -p $Path if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "BackUp dirctory was created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "BackUp dirctory was NOT created in $(date +%T)\n" &gt;&gt; $log fi else echo "–ö–∞—Ç–∞–ª–æ–≥ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–µ —á–∏—Å–ª–æ..." fi #–ü—Ä–≤–æ–µ—Ä–∫–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É if [ ! -d $Path/$CDate ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo #–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π –Ω–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–µ —á–∏—Å–ª–æ echo "–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π –Ω–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–µ —á–∏—Å–ª–æ..." mkdir -p $Path/$CDate if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "BackUp CDate dirctory was created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "BackUp CDate dirctory was NOT created in $(date +%T)\n" &gt;&gt; $log fi else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo "–ö–∞—Ç–∞–ª–æ–≥ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∑–∞–ø–∏—Å—å —Å–ø–∏—Å–∫–∞ —è—â–∏–∫–æ–≤ –≤ —Ñ–∞–π–ª..." fi #–ó–∞–ø–∏—Å—å —Å–ø–∏—Å–∫–∞ —è—â–∏–∫–æ–≤ –≤ —Ñ–∞–π–ª /opt/zimbra/bin/zmprov -l gaa $ZDomain &gt; $MBoxes #–í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∑–∞–ø–∏—Å–∏ —Å–ø–∏—Å–∫–∞ if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Mail Boxes list created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en "Mail Box list is NOT created! in $(date +%T)\n" &gt;&gt; $log exit fi #—Å–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π –∫–∞–∂–¥–æ–≥–æ —è—â–∏–∫–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ for MailBox in $( cat $MBoxes); do echo "–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ —è—â–∏–∫–∞ $MailBox..." /opt/zimbra/bin/zmmailbox -z -m $MailBox getRestUrl "//?fmt=tgz" &gt; $Path/$CDate/$MailBox if [ $? -eq 0 ]; then #–í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —è—â–∏–∫–∞ echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Mail Box $MailBox BackUp created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en "Mail Box $MailBox BackUp is NOT created! in $(date +%T)\n" &gt;&gt; $log fi done #–û—á–∏—â–∞–µ–º —Ñ–∞–π–ª —Å–æ —Å–ø–∏—Å–∫–æ–º —è—â–∏–∫–æ–≤ echo "–û—á–∏—Å—Ç–∫–∞ —Ñ–∞–π–ª–∞ —Å–æ —Å–ø–æ—Å–∫–æ–º —è—â–∏–∫–æ–≤..." echo -n &gt; $MBoxes if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "File $MBoxes clear\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "File $MBoxes can NOT be cleared\n" &gt;&gt; $log fi #–°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ –∏ —Ä–∞–±–æ—Ç–∞ —Å –∞—Ä—Ö–∏–≤–∞–º–∏ #–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞ –¥–ª—è –∞—Ä—Ö–∏–≤–∏—Ä–≤–æ–∞–Ω–∏—è if [ ! -d $ArchPath ]; then #–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∞—Ä—Ö–∏–≤–æ–≤ echo "–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∞—Ä—Ö–∏–≤–æ–≤..." mkdir -p $ArchPath if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive dirctory was created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive dirctory was NOT created in $(date +%T)\n" &gt;&gt; $log fi else echo "–ö–∞—Ç–∞–ª–æ–≥ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∞—Ä—Ö–∏–≤–æ–≤ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∞—Ä—Ö–∏–≤–∏–≤—Ä–æ–≤–∞–Ω–∏–µ..." fi tar -czf $ArchPath/$CDate.tar $Path/$CDate if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive created in $(date +%T)\n" &gt;&gt; $log #–ö–∞–∂–¥–æ–µ –ø–µ—Ä–≤–æ–µ —á–∏—Å–ª–æ –º–µ—Å—è—Ü–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ –Ω–∞ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ if [ "$MDay" = 1 ]; then #–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã—Ö –∞—Ä—Ö–∏–≤–æ–≤ if [ ! -d $ArchPath ]; then #–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–æ–ª–≥–æ–≤—Ä–æ—á–Ω—ã—Ö –∞—Ä—Ö–∏–≤–æ–≤ echo "–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–æ–ª–≥–æ—Å—Ä–æ–Ω—ã—Ö –∞—Ä—Ö–∏–≤–æ–≤..." mkdir -p $ArchPath if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Long saving dirctory was created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Long saving dirctory was NOT created in $(date +%T)\n" &gt;&gt; $log fi else #–ö–∞—Ç–∞–ª–æ–≥ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç echo "–ö–∞—Ç–∞–ª–æ–≥ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∞—Ä—Ö–∏–≤–æ–≤ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ –Ω–∞ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ..." fi cp $ArchPath/$CDate.tgz $MPath/$CDate if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive is copied in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive is NOT copied in $(date +%T)\n" &gt;&gt; $log fi echo "–£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π (—Å—Ç–∞—Ä—à–µ 1 –Ω–µ–¥–µ–ª–∏)..." #–£–¥–∞–ª–µ–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–æ–≤, —Å–æ–¥–µ—Ä–∂–∞—â–∏—Ö —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏, —Å—Ç–∞—Ä—à–µ –Ω–µ–¥–µ–ª–∏ find $Path -atime +7 | xargs rm -d if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Old BackUps files was deleted\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Old BackUps files is NOT deleted in $(date +%T)\n" &gt;&gt; $log fi #–£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –∞—Ä—Ö–∏–≤–æ–≤ –±—ç–∫–∞–ø–æ–≤ (—Å—Ç–∞—Ä—à–µ 2 –º–µ—Å—è—Ü–µ–≤) echo "–£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –∞—Ä—Ö–∏–≤–æ–≤ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π (—Å—Ç–∞—Ä—à–µ 2 –º–µ—Å—è—Ü–µ–≤)..." find $Path -atime +61 | xargs rm -f if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Old BackUps archives was deleted\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Old BackUps archives is NOT deleted in $(date +%T)\n" &gt;&gt; $log fi fi else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive is NOT created in $(date +%T)\n" &gt;&gt; $log fi echo "BackUp job finished in $(date +%T)" #–∑–∞–ø–∏—Å—å –≤ –ª–æ–≥-—Ñ–∞–π–ª –≤—Ä–µ–º–µ–Ω–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è echo -en "BackUp job finished in $(date +%T) $(date +%T)\n" &gt;&gt; $log echo -en "_____________________________________________\n" &gt;&gt; $log</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Contents of the HandBackUp.sh file:</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #–ö—É–¥–∞ –ø–æ–ª–æ–∂–∏—Ç—å –±—ç–∫–∞–ø Path="/mnt/ZM/BackUps" #–ö—É–¥–∞ –ø–æ–ª–æ–∂–∏—Ç—å –∞—Ä—Ö–∏–≤ –±—ç–∫–∞–ø–∞ ArchPath="/mnt/ZM/Archive" #–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–º–µ–Ω–∞ Zimbra ZDomain="zimbramail.home.local" #–°–ø–∏—Å–æ–∫ —è—â–∏–∫–æ–≤ MBoxes="/mnt/ZM/MBoxesList" #–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ CDate=$(date +%d-%m-%Y) #–ö—É–¥–∞ –ø–∏—Å–∞—Ç—å –ª–æ–≥–∏ log="/mnt/ZM/BackUpLog.txt" read -p "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ—á—Ç–æ–≤–æ–≥–æ —è—â–∏–∫–∞ (–±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è –¥–æ–º–µ–Ω–∞), –∏–ª–∏ ALL –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö –ø–æ—á—Ç–æ–≤—ã—Ö —è—â–∏–∫–æ–≤: " A if [[ "$A" = "ALL" || "$A" = "all" ]]; then echo -en "BackUp started in $(date +%T)\n" &gt;&gt; $log #–ó–∞–ø–∏—Å—å —Å–ø–∏—Å–∫–∞ —è—â–∏–∫–æ–≤ –≤ —Ñ–∞–π–ª echo "–ó–∞–ø–∏—Å—å —Å–ø–∏—Å–∫–∞ —è—â–∏–∫–æ–≤ –≤ —Ñ–∞–π–ª..." /opt/zimbra/bin/zmprov -l gaa $ZDomain &gt; $MBoxes if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Mail Boxes list created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en "Mail Box list is NOT created! in $(date +%T)\n" &gt;&gt; $log exit fi if ! [ -d $Path/$Date ]; then #–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è mkdir -p $Path/$CDate/ echo -en "BackUp directory created in $(date +%T)\n" &gt;&gt; $log else #–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π –∫–∞–∂–¥–æ–≥–æ —è—â–∏–∫–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ echo "–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π –∫–∞–∂–¥–æ–≥–æ —è—â–∏–∫–∞ –∏–∑ —Å–ø–∏—Å–∫–∞" for MailBox in $( cat $MBoxes); do echo "–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ —è—â–∏–∫–∞ $MailBox..." /opt/zimbra/bin/zmmailbox -z -m $MailBox getRestUrl "//?fmt=tgz" &gt; $Path/$CDate/$MailBox if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Mail Box $MailBox BackUp created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en "Mail Box $MailBox BackUp is NOT created! in $(date +%T)\n" &gt;&gt; $log fi done fi else MailBox="$A@$ZDomain" #–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—à–µ–Ω–Ω–æ–≥–æ —è—â–∏–∫–∞ echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—à–µ–Ω–Ω–æ–≥–æ —è—â–∏–∫–∞..." Result=$(/opt/zimbra/bin/zmprov getMailboxInfo $MailBox) if [ $? -eq 0 ]; then #–ó–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–π —è—â–∏–∫ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo "–ó–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–π —è—â–∏–∫ $MailBox —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ..." echo -en "Required Mail Box $MailBox exist $(date +%T)\n" &gt;&gt; $log #–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞ –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è if ! [ -d $Path/$Date ]; then #–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ —è—â–∏–∫–∞ mkdir -p $Path/$CDate/ echo -en "BackUp directory created in $(date +%T)\n" &gt;&gt; $log else #–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ —è—â–∏–∫–∞ $MailBox /opt/zimbra/bin/zmmailbox -z -m $MailBox getRestUrl "//?fmt=tgz" &gt; $Path/$CDate/$MailBox if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Mail Box $MailBox BackUp created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en "Mail Box $MailBox BackUp is NOT created! in $(date +%T)\n" &gt;&gt; $log fi fi else #–ó–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–π —è—â–∏–∫ –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤—É–µ—Ç - –≤—ã—Ö–æ–¥ echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo "–ó–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–π —è—â–∏–∫ $MailBox –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã —Å–∫—Ä–∏–ø—Ç–∞" echo -en "Required Mail Box $MailBox is not exist\n" &gt;&gt; $log exit fi fi read -p "–•–æ—Ç–∏—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∞—Ä—Ö–∏–≤–∞—Ü–∏—é —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ —è—â–∏–∫–∞ $MailBox? [N]: " F if [[ "$F" = "Y" || "$F" = "y" ]]; then #–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞ –¥–ª—è –∞—Ä—Ö–∏–≤–∏—Ä–≤–æ–∞–Ω–∏—è if [ ! -d $ArchPath ]; then #–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π echo "–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∞—Ä—Ö–∏–≤–æ–≤..." mkdir -p $ArchPath if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive dirctory was created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive dirctory was NOT created in $(date +%T)\n" &gt;&gt; $log fi else echo "–ö–∞—Ç–∞–ª–æ–≥ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∞—Ä—Ö–∏–≤–æ–≤ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∞—Ä—Ö–∏–≤–∏–≤—Ä–æ–≤–∞–Ω–∏–µ..." fi #–°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ echo "–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏..." if [[ "$A" = "ALL" || "$A" = "all" ]]; then tar -czf $ArchPath/$CDate.tar $Path/$CDate if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive is NOT created in $(date +%T)\n" &gt;&gt; $log fi else tar -czf $ArchPath/$MailBox.tar $Path/$CDate/$MailBox if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive is NOT created in $(date +%T)\n" &gt;&gt; $log fi fi else echo "–ê—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω –Ω–µ –±—É–¥–µ—Ç" echo -en "User decline archive creating\n" &gt;&gt; $log fi #–û—á–∏—â–∞–µ–º —Ñ–∞–π–ª —Å–æ —Å–ø–∏—Å–∫–æ–º —è—â–∏–∫–æ–≤ echo "–û—á–∏—Å—Ç–∫–∞ —Ñ–∞–π–ª–∞ —Å–æ —Å–ø–æ—Å–∫–æ–º —è—â–∏–∫–æ–≤..." echo -n &gt; $MBoxes if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo fi echo "BackUp job finished in $(date +%T) $(date +%T)" #–∑–∞–ø–∏—Å—å –≤ –ª–æ–≥-—Ñ–∞–π–ª –≤—Ä–µ–º–µ–Ω–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è echo -en "BackUp job finished in $(date +%T) $(date +%T)\n" &gt;&gt; $log echo -en "_____________________________________________\n" &gt;&gt; $log</span></span></code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">Contents of the Restore.sh file:</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #–ì–¥–µ –ª–µ–∂–∞—Ç –±—ç–∫–∞–ø—ã Path="/mnt/ZM/BackUps" #–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–º–µ–Ω–∞ Zimbra ZDomain="zimbramail.home.local" #–°–ø–∏—Å–æ–∫ —è—â–∏–∫–æ–≤ MBoxes="/mnt/ZM/MBoxesList" #–ö—É–¥–∞ –ø–∏—Å–∞—Ç—å –ª–æ–≥–∏ log="/mnt/ZM/RestoreLog.txt" read -p "–î–∞—Ç–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏, –∫–æ—Ç–æ—Ä—É—é –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ 02-09-2001: " Date if ! [ -d $Path/$Date ]; then echo "–ù–µ—Ç —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—É—é –¥–∞—Ç—É." echo -en "No BackUp file at $Date $(date +%T)\n" &gt; $log exit fi read -p "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ—á—Ç–æ–≤–æ–≥–æ —è—â–∏–∫–∞ (–±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è –¥–æ–º–µ–Ω–∞), –∏–ª–∏ ALL –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö –ø–æ—á—Ç–æ–≤—ã—Ö —è—â–∏–∫–æ–≤ –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—É—é –¥–∞—Ç—É: " A if [[ "$A" = "ALL" || "$A" = "all" ]]; then echo -en "Restore started in $(date +%T)\n" &gt;&gt; $log #–ó–∞–ø–∏—Å—å —Å–ø–∏—Å–∫–∞ —è—â–∏–∫–æ–≤ –≤ —Ñ–∞–π–ª ls "$Path/$Date" &gt; $MBoxes for MailBox in $( cat $MBoxes); do #–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —è—â–∏–∫–∞ echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —è—â–∏–∫–∞ $MailBox" Result=$(/opt/zimbra/bin/zmprov getMailboxInfo $MailBox) if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6) [OK]" echo echo -en "Start restore job for $MailBox $(date +%T)\n" &gt;&gt; $log echo "–Ø—â–∏–∫ $MailBox —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ..." else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Mail Box $MailBox does not exist, creating Mail Box $MailBox $(date +%T)\n" &gt;&gt; $log echo "–Ø—â–∏–∫ $MailBox –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –°–æ–∑–¥–∞–Ω–∏–µ —è—â–∏–∫–∞ $MailBox..." #–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —è—â–∏–∫–∞ Result=$(/opt/zimbra/bin/zmprov ca $MailBox 12345678 displayName "$MailBox") if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6) [OK]" echo echo -en "Mail Box $MailBox is created, starting restore $(date +%T)\n" &gt;&gt; $log echo "–Ø—â–∏–∫ $MailBox —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ..." else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Can NOT create Mail Box $MailBox ! $(date +%T)\n" &gt;&gt; $log echo "–Ø—â–∏–∫ $MailBox —Å–æ–∑–¥–∞—Ç—å –Ω–µ —É–¥–∞–ª–æ—Å—å." fi fi #–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —è—â–∏–∫–∞ Result=$(/opt/zimbra/bin/zmmailbox -z -m $MailBox postRestURL "//?fmt=tgz&amp;resolve=replace" $Path/$Date/$MailBox) if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "–Ø—â–∏–∫ $MailBox –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en "–Ø—â–∏–∫ $MailBox –ù–ï –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω! $(date +%T)\n" &gt;&gt; $log fi done else #–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—à–µ–Ω–Ω–æ–π —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ MailBox="$A@$ZDomain" if [ -a $Path/$Date/$MailBox ]; then #–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —è—â–∏–∫–∞ echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —è—â–∏–∫–∞ $MailBox..." Result=$(/opt/zimbra/bin/zmprov getMailboxInfo $MailBox) if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6) [OK]" echo echo -en "Start restore job for $MailBox $(date +%T)\n" &gt;&gt; $log echo "–Ø—â–∏–∫ $MailBox —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ..." else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Mail Box $MailBox does not exist $(date +%T)\n" &gt;&gt; $log echo "–Ø—â–∏–∫ $MailBox –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç." read -p "–•–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å –ø–æ—á—Ç–æ–≤—ã–π —è—â–∏–∫ —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º –∏–º–µ–Ω–µ–º –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤ –Ω–µ–≥–æ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é? [N]: " B if [[ "$B" = "Y" || "$B" = "y" ]]; then echo "–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—á—Ç–æ–≤–æ–≥–æ —è—â–∏–∫–∞ $MailBox..." Result=$(/opt/zimbra/bin/zmprov ca $MailBox 12345678 displayName "$MailBox") #–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —è—â–∏–∫–∞ if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6) [OK]" echo echo -en "Mail Box $MailBox is created, starting restore $(date +%T)\n" &gt;&gt; $log echo "–Ø—â–∏–∫ $MailBox —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ..." else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Can NOT create Mail Box $MailBox ! $(date +%T)\n" &gt;&gt; $log echo "–Ø—â–∏–∫ $MailBox —Å–æ–∑–¥–∞—Ç—å –Ω–µ —É–¥–∞–ª–æ—Å—å. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã —Å–∫—Ä–∏–ø—Ç–∞..." exit fi else #–Ø—â–∏–∫ –Ω–µ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω, –Ω–µ—á–µ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å. –í—ã—Ö–æ–¥ echo "–Ø—â–∏–∫ –Ω–µ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã —Å–∫—Ä–∏–ø—Ç–∞" exit fi fi #–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —è—â–∏–∫–∞ Result=$(/opt/zimbra/bin/zmmailbox -z -m $MailBox postRestURL "//?fmt=tgz&amp;resolve=replace" $Path/$Date/$MailBox) if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "–Ø—â–∏–∫ $MailBox –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en "–Ø—â–∏–∫ $MailBox –ù–ï –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω! $(date +%T)\n" &gt;&gt; $log fi else #–ó–∞–ø—Ä–æ—à–µ–Ω–Ω–æ–π —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç echo "–ó–∞–ø—Ä–æ—à–µ–Ω–Ω–æ–π —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã —Å–∫—Ä–∏–ø—Ç–∞" echo -en "Required BackUp file is not exist\n" &gt;&gt; $log exit fi fi #–û—á–∏—â–∞–µ–º —Ñ–∞–π–ª —Å–æ —Å–ø–∏—Å–∫–æ–º —è—â–∏–∫–æ–≤ echo "–û—á–∏—Å—Ç–∫–∞ —Ñ–∞–π–ª–∞ —Å–æ —Å–ø–æ—Å–∫–æ–º —è—â–∏–∫–æ–≤..." Result(echo -n &gt; $MBoxes) if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo fi echo "BackUp job finished in $(date +%T) $(date +%T)" #–∑–∞–ø–∏—Å—å –≤ –ª–æ–≥-—Ñ–∞–π–ª –≤—Ä–µ–º–µ–Ω–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è echo -en "Restore job complete in $(date +%T)\n" &gt;&gt; $log echo -en "____________________________________\n" &gt;&gt; $log</span></span></code> </pre></div></div><br>  There is one subtlety.  If you create and edit script files for bash under Windows, then when you try to run the script, you will get the error: <b>/ bin / sh ^ M: bad interpreter: No such file or directory</b> , which is that Windows editors add to the end of the line is the carriage return character "CR \ LF", which the editors in Linux do not display.  But this symbol is there, and has not gone anywhere.  To get rid of the error and remove the extra characters do the following: <br><br><pre> <code class="bash hljs">$ cat your-script.sh | tr -d <span class="hljs-string"><span class="hljs-string">'\r'</span></span> &gt; corrected-your-script.sh</code> </pre> <br>  Well, or you can use the dos2unix utility, but it still needs to be installed: <br><br><pre> <code class="bash hljs">$ yum install dos2unix $ dos2unix your-script.sh</code> </pre> <br>  5) Making the scripts executable: <br><br><pre> <code class="bash hljs">$ chmod 0740 /opt/zimbra/BkUpRestScripts/FullBackUp.sh $ chmod 0740 /opt/zimbra/BkUpRestScripts/HandBackUp.sh $ chmod 0740 /opt/zimbra/BkUpRestScripts/Restore.sh</code> </pre> <br>  6) I recommend using my hands to run scripts and check if they work and how they work. <br><br>  7) Create a task in CRON for daily mailbox backup: <br><br><pre> <code class="bash hljs">10 0 * * * root /opt/zimbra/ BkUpRestScripts/FullBackUp.sh</code> </pre> <br>  8) Enjoy <br><br><h3>  4. Script work </h3><br>  In case the comments in the scripts themselves did not help. <br><br><div class="spoiler">  <b class="spoiler_title">1) FullBaclUp.sh script:</b> <div class="spoiler_text">  At the beginning, variables are determined, which one is responsible for what - everything is commented. <br><br>  This is followed by checking the absence of a directory for backup; if it does not exist, it is created.  An output is made to the log file and to the screen (if launched by the hands) about the success or failure of the creation of the catalog. <br><br>  Check the absence of a catalog with today's date.  If it does not exist, it is created, the same output to the screen and to the log of the result of creating the directory. <br><br>  Write to the file all existing Zimbra mailboxes.  It is needed for the consistent backup of each box.  Displays the result of the command. <br><br>  Creating a backup for each box from the list.  With the output of the execution result on the screen and in the log file. <br><br>  Clearing the mailbox list file.  Since all 3 scripts work with this file, it is advisable to clean it after each pass so that there are no surprises.  You can clean it before starting the script, but somehow I‚Äôm used to not keep extra data after doing the work, but doing the same thing before and after the script‚Äôs work is a slight degree of schizophrenia. <br><br>  Next, the block to create a compressed archive. <br><br>  Checking the absence of the archive storage directory, its creation in the absence and output to the screen and to the log of the creation result <br><br>  Archiving. <br><br>  Check "Is it the first number today?".  I prefer to keep backups for the 1st of all months for a long time, I have enough of this to work with.  You can store for weeks, but often it is redundant.  But on top of it is set the condition for storing backups for the entire period of the mail server operation, so that they will forever lie there forever.  If the number is the first, the resulting archive is copied to a separate ‚ÄúMounthly‚Äù directory.  And in order to copy it there - you need to check if there is such a directory, and if not - create it, what to report on the screen and in the log file. <br><br>  Next, the storage is cleaned - all backups older than 2 weeks and archives older than 61 days are deleted.  The result of the deletion is displayed on the screen and in the log file. <br><br>  After that, the script writes the completion time in the log file and on the screen, and completes its work. </div></div><br><div class="spoiler">  <b class="spoiler_title">2) HandBackUp.sh script:</b> <div class="spoiler_text">  In the beginning, variables are also defined, also commented on why they are needed. <br><br>  Next, the user is prompted to enter the name of the mailbox, which must be backed up, and without specifying the Zimbra domain.  (it is written there in the invitation to enter), or select the backup of all mailboxes by writing ALL or all. <br><br>  If the backup of all mailboxes is selected, then the script works in almost the same way as the first one listed above, except that after creating the backups of each mailbox, it will ask if you need to archive them? <br><br>  If a specific mailbox was written, then its existence is checked in Zimbra.  If a box with the specified name exists, then the process of backing up this mailbox is started, with the relevant information displayed on the screen and in the log file.  If the specified mailbox does not exist, this will be reported to the user, and the script will complete its work. <br><br>  After completing the backup box will be prompted to archive a copy.  If the user agrees - there is a check of the absence of the catalog for storing the archive and further along the list, as in the first script. <br><br>  After archiving is completed, the mailbox file is cleared.  Just in case. <br><br>  At the end, information about the time the script ends on the screen and to the log file is displayed. </div></div><br><div class="spoiler">  <b class="spoiler_title">3) Restore.sh script:</b> <div class="spoiler_text">  As in the previous files, first - the definition of variables with comments. <br><br>  An invitation to the user to select the backup date to be restored.  If there is no specified date in the backups, the script ends by informing about it. <br><br>  If backups for the specified date exist - an invitation to the user to enter the name of the mailbox to be restored.  To restore all the boxes you need to write ALL or all. <br><br>  If the ALL parameter is selected, the script creates a list of files in the backup folder to a file, notifies of the result of the creation. <br><br>  Next is the step-by-step recovery of each mailbox.  First, check the existence of the box in the system, in case of absence, it is created, and then restored.  About each operation information is displayed in the log file and on the screen. <br><br>  If a particular box is selected, it is almost the same.  Check for the existence of a file with the requested name.  Output to the screen and to the log file of the result. <br><br>  Check the existence of the box in the system.  Output to the screen and to the log file of the result. <br>  Inviting the user to agree to the creation of the box in the absence of such in the system.  Output to the screen and to the log file of the result. <br><br>  Create a box in case of consent.  Output to the screen and to the log file of the result. <br>  Recovery box.  Output to the screen and to the log file of the result. <br><br>  Cleanup file with a list of recovery boxes. <br><br>  At the end, information about the time the script ends on the screen and to the log file is displayed. </div></div><br><h3>  5. Regarding recovery </h3><br>  If we slightly modify these scripts, they are also quite suitable for moving mail from the server to the server, simply by creating in the new place boxes with all the content.  It is also possible to restore the work of the system from scratch, when for some reason it is easier to re-raise the Zimbra server than to try to revive the old one. –ö–∞–∫ –±—ã–ª–æ –Ω–∞–ø–∏—Å–∞–Ω–æ –≤—ã—à–µ, –º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±—Ä–∞–∑ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã, —Ä–∞–∑–≤–µ—Ä–Ω—É–≤ –µ–≥–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏, –∏ –∑–∞–ª–∏–≤ –≤ –Ω–µ–≥–æ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ. –¢–æ—Ç –∂–µ –∞–ª–≥–æ—Ä–∏—Ç–º –¥–µ–π—Å—Ç–≤–∏–π –ø—Ä–∏ –ø–µ—Ä–µ–µ–∑–¥–µ —Å –æ–¥–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ Zimbra –Ω–∞ –¥—Ä—É–≥–æ–π. –ò –Ω–µ –Ω—É–∂–Ω–æ –Ω–∏–∫–∞–∫–∏—Ö –ø–ª–∞—Ç–Ω—ã—Ö —É—Ç–∏–ª–∏—Ç —Ç–∏–ø–∞ Zextras. <br><br><h3> 6. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ </h3><br> –í —Ü–µ–ª–æ–º, –Ω–∏—á–µ–≥–æ —Å–ª–æ–∂–Ω–æ–≥–æ –≤ –Ω–∞–ø–∏—Å–∞–Ω–Ω—ã—Ö –º–Ω–æ–π —Å–∫—Ä–∏–ø—Ç–∞—Ö –Ω–µ—Ç. –î–∞, –≤ –Ω–∏—Ö –º–Ω–æ–≥–æ —É—Å–ª–æ–≤–∏–π, –ø–æ—Ç–æ–º—É —á—Ç–æ —è —Å—Ç–∞—Ä–∞–ª—Å—è –ø—Ä–µ–¥–≤–∏–¥–µ—Ç—å –∫–∞–∫ –º–æ–∂–Ω–æ –±–æ–ª—å—à–µ –ø—Ä–æ–±–ª–µ–º –∏ –æ—à–∏–±–æ–∫ –≤ –∏—Ö —Ä–∞–±–æ—Ç–µ, –Ω–æ —è —Ç–∞–∫ –∂–µ –ø–æ—Å—Ç–∞—Ä–∞–ª—Å—è –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å–∫—Ä–∏–ø—Ç–∞ –∫–∞–∫ –º–æ–∂–Ω–æ –±–æ–ª–µ–µ –ø–æ–Ω—è—Ç–Ω–æ. –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, ¬´–∏–∑ –∫–æ—Ä–æ–±–∫–∏¬ª –æ–Ω–∏ –∑–∞—Ä–∞–±–æ—Ç–∞—é—Ç –Ω–µ –¥–ª—è –≤—Å–µ—Ö. –ú–æ–∂–µ—Ç –±—ã—Ç—å, –∫–æ–º—É-—Ç–æ –≤–æ–æ–±—â–µ –Ω–µ –ø–æ–¥–æ–π–¥–µ—Ç —Ç–∞–∫–æ–π —Å–ø–æ—Å–æ–± —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è. –ù–æ, –Ω–∞–¥–µ—é—Å—å, –º–Ω–æ–≥–∏–º –æ–∫–∞–∂—É—Ç—Å—è –ø–æ–ª–µ–∑–Ω—ã–º–∏. <br><br><h3> 7. PS: </h3><br> –≠—Ç–æ –≤—Ç–æ—Ä–∞—è —Å—Ç–∞—Ç—å—è –∏–∑ —Å–µ—Ä–∏–∏ ¬´–∫–∞–∫ —è ¬´Zimbra¬ª –≤–Ω–µ–¥—Ä—è–ª¬ª. –ü–µ—Ä–≤–∞—è, –ø—Ä–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ, LDAP-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —è—â–∏–∫–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π AD, <a href="https://habr.com/ru/post/439440/">–≤–æ—Ç —Ç—É—Ç</a> . <br><br> –ò –µ—â–µ —Ö–æ—á—É –æ—Ç–º–µ—Ç–∏—Ç—å, —á—Ç–æ —ç—Ç–æ –º–æ–π –ø–µ—Ä–≤—ã–π –æ–ø—ã—Ç —Å–∫—Ä–∏–ø—Ç–æ–≤–∞–Ω–∏—è –Ω–∞ –±–∞—à–µ, –∏–∑-–∑–∞ —ç—Ç–æ–≥–æ —Å–∫—Ä–∏–ø—Ç—ã –ø–æ–ª—É—á–∏–ª–∏—Å—å —Ç–∞–∫–∏–º–∏ –≥—Ä–æ–º–æ–∑–¥–∫–∏–º–∏ –∏ ¬´–¥–ª—è –æ—Å–æ–±–æ —É–º–Ω—ã—Ö¬ª, —á—Ç–æ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è. </div><p>Source: <a href="https://habr.com/ru/post/439728/">https://habr.com/ru/post/439728/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
</ul></nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>