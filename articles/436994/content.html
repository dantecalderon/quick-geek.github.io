<div class="post__text post__text-html js-mediator-article"><h2 id="vvedenie">  Introduction </h2><br><p>  Liquibase is a database version control system, mainly for the structure and, to a lesser extent, the content of the database.  At the same time, the description of the database, on the one hand, is rather abstract and allows using different DBMS at the lower level, and on the other hand, you can always switch to the SQL dialect of a specific DBMS, which is quite flexible.  Liquibase is a well-established open source project and is actively used outside of its native Java environment and does not require in-depth Java knowledge to work.  The XML format has historically been used as a description of the base structure and base changes, but now YAML and JSON are supported in parallel. </p><br><p>  In this article, we will summarize the experience of previous generations and focus on working with Liquibase using Maven.  As a test operating system, we will use Ubuntu. </p><a name="habracut"></a><br><h2 id="drugie-stati-o-liquibase">  Other Liquibase articles </h2><br><ul><li>  <a href="https://habr.com/ru/post/179425/">https://habr.com/ru/post/179425/</a> </li><li>  <a href="https://habr.com/ru/post/178665/">https://habr.com/en/en/post/178665/</a> </li><li>  <a href="https://habr.com/ru/post/333762/">https://habr.com/ru/post/333762/</a> </li><li>  <a href="https://habr.com/ru/post/251617/">https://habr.com/ru/post/251617/</a> </li><li>  <a href="https://habr.com/ru/post/251617/">https://habr.com/ru/post/251617/</a> </li></ul><br><h2 id="nastroyka-okruzheniya">  Setting up the environment </h2><br><p>  You can run Liquibase in several ways, but Maven or Gradle is most convenient to use. </p><br><pre><code class="plaintext hljs">sudo apt install maven mvn -version</code> </pre> <br><p>  The pom.xml here is the Makefile - it already contains all the necessary dependencies, settings and profiles. </p><br><div class="spoiler">  <b class="spoiler_title">pom.xml</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">&lt;?xml version="1.0" encoding="UTF-8"?&gt; &lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt; &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt; &lt;groupId&gt;com.test.db&lt;/groupId&gt; &lt;artifactId&gt;db&lt;/artifactId&gt; &lt;version&gt;1.0.0&lt;/version&gt; &lt;name&gt;db&lt;/name&gt; &lt;description&gt;Test Database&lt;/description&gt; &lt;packaging&gt;pom&lt;/packaging&gt; &lt;properties&gt; &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt; &lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt; &lt;slf4j.version&gt;1.7.24&lt;/slf4j.version&gt; &lt;logback.version&gt;1.2.3&lt;/logback.version&gt; &lt;liquibase.version&gt;3.6.2&lt;/liquibase.version&gt; &lt;postgresql.version&gt;42.2.5&lt;/postgresql.version&gt; &lt;snakeyaml.version&gt;1.23&lt;/snakeyaml.version&gt; &lt;/properties&gt; &lt;dependencies&gt; &lt;!--Logging--&gt; &lt;dependency&gt; &lt;groupId&gt;org.slf4j&lt;/groupId&gt; &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt; &lt;version&gt;${slf4j.version}&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.slf4j&lt;/groupId&gt; &lt;artifactId&gt;log4j-over-slf4j&lt;/artifactId&gt; &lt;version&gt;${slf4j.version}&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.slf4j&lt;/groupId&gt; &lt;artifactId&gt;jcl-over-slf4j&lt;/artifactId&gt; &lt;version&gt;${slf4j.version}&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt; &lt;artifactId&gt;logback-classic&lt;/artifactId&gt; &lt;version&gt;${logback.version}&lt;/version&gt; &lt;/dependency&gt; &lt;!--JDBC drivers--&gt; &lt;dependency&gt; &lt;groupId&gt;org.postgresql&lt;/groupId&gt; &lt;artifactId&gt;postgresql&lt;/artifactId&gt; &lt;version&gt;${postgresql.version}&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.liquibase&lt;/groupId&gt; &lt;artifactId&gt;liquibase-core&lt;/artifactId&gt; &lt;version&gt;${liquibase.version}&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.yaml&lt;/groupId&gt; &lt;artifactId&gt;snakeyaml&lt;/artifactId&gt; &lt;version&gt;${snakeyaml.version}&lt;/version&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;build&gt; &lt;plugins&gt; &lt;plugin&gt; &lt;groupId&gt;org.liquibase&lt;/groupId&gt; &lt;artifactId&gt;liquibase-maven-plugin&lt;/artifactId&gt; &lt;version&gt;${liquibase.version}&lt;/version&gt; &lt;configuration&gt; &lt;propertyFile&gt;${profile.propertyFile}&lt;/propertyFile&gt; &lt;changeLogFile&gt;${profile.changeLogFile}&lt;/changeLogFile&gt; &lt;dataDir&gt;${profile.dataDir}&lt;/dataDir&gt; &lt;!-- log --&gt; &lt;verbose&gt;${profile.verbose}&lt;/verbose&gt; &lt;logging&gt;${profile.logging}&lt;/logging&gt; &lt;promptOnNonLocalDatabase&gt;false&lt;/promptOnNonLocalDatabase&gt; &lt;/configuration&gt; &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt; &lt;profiles&gt; &lt;!-- Development settings, -Denv=dev --&gt; &lt;profile&gt; &lt;id&gt;dev&lt;/id&gt; &lt;activation&gt; &lt;property&gt; &lt;name&gt;env&lt;/name&gt; &lt;value&gt;dev&lt;/value&gt; &lt;/property&gt; &lt;/activation&gt; &lt;properties&gt; &lt;profile.propertyFile&gt;dev/liquibase.properties&lt;/profile.propertyFile&gt; &lt;profile.changeLogFile&gt;dev/master.xml&lt;/profile.changeLogFile&gt; &lt;profile.dataDir&gt;dev/data&lt;/profile.dataDir&gt; &lt;profile.verbose&gt;true&lt;/profile.verbose&gt; &lt;profile.logging&gt;debug&lt;/profile.logging&gt; &lt;/properties&gt; &lt;/profile&gt; &lt;!-- Production settings, -Denv=prod --&gt; &lt;profile&gt; &lt;id&gt;prod&lt;/id&gt; &lt;activation&gt; &lt;property&gt; &lt;name&gt;env&lt;/name&gt; &lt;value&gt;prod&lt;/value&gt; &lt;/property&gt; &lt;/activation&gt; &lt;properties&gt; &lt;profile.propertyFile&gt;prod/liquibase.properties&lt;/profile.propertyFile&gt; &lt;profile.changeLogFile&gt;prod/master.xml&lt;/profile.changeLogFile&gt; &lt;profile.dataDir&gt;prod/data&lt;/profile.dataDir&gt; &lt;profile.verbose&gt;false&lt;/profile.verbose&gt; &lt;profile.logging&gt;info&lt;/profile.logging&gt; &lt;/properties&gt; &lt;/profile&gt; &lt;/profiles&gt; &lt;/project&gt;</code> </pre> </div></div><br><h2 id="zapuskaem-obnovlenie">  We launch update </h2><br><p>  After we have done pom.xml, you can run an update of the database - the command liquibase: update. </p><br><p>  For this we need: </p><br><ul><li>  liquibase.properties file with database connection settings (login / password and possibly other parameters) </li><li>  xml file with database changes </li><li>  sh base launch update script </li></ul><br><h3 id="fayl-s-nastroykami-soedineniya-k-baze">  File with database connection settings </h3><br><p>  liquibase.properties </p><br><pre> <code class="plaintext hljs">username=test password=test referenceUsername=test #можно задавать и другие параметры #url=jdbc:postgresql://dev/test #referenceUrl=jdbc:postgresql://dev/test_reference</code> </pre> <br><h3 id="fayl-s-izmeneniyami-bazy">  File with database changes </h3><br><p>  The basic concept of liquibase are the so-called base changes (changesets).  They can include both changes in the structure and changes in the data.  To control the changes applied, liquibase uses the <strong>databasechangelog</strong> and <strong>databasechangeloglock</strong> tables. </p><br><pre> <code class="plaintext hljs">&lt;?xml version="1.1" encoding="UTF-8" standalone="no"?&gt; &lt;databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.6.xsd"&gt; &lt;changeSet context="legacy" author="author (generated)" id="1"&gt; &lt;createTable tableName="test"&gt; &lt;column autoIncrement="true" name="id" type="SERIAL"&gt; &lt;constraints nullable="false"/&gt; &lt;/column&gt; &lt;column name="user_name" type="VARCHAR(255)"/&gt; &lt;column name="preferences" type="TEXT"/&gt; &lt;/createTable&gt; &lt;/changeSet&gt; &lt;/databaseChangeLog&gt;</code> </pre> <br><h3 id="skript-zapuska-obnovleniya-bazy">  Script run update database </h3><br><p>  Here liquibase is executed: update for the dev profile and the database from liquibase.url, which is specified in the standard JDBC format.  After the update, the table specified in changeSet and two service tables <strong>databasechangelog</strong> and <strong>databasechangeloglock</strong> appear in the <strong>database</strong> . </p><br><pre> <code class="plaintext hljs">#!/usr/bin/env bash mvn liquibase:update\ -Denv=dev\ -Dliquibase.url="jdbc:postgresql://dev/test?prepareThreshold=0&amp;stringtype=unspecified"</code> </pre> <br><h3 id="generaciya-sql-bez-obnovleniya-bazy">  SQL generation without database update </h3><br><p>  Sometimes it is required to look at the contents of created queries before launching changes.  The liquibase: updateSQL and liquibase: rollbackSQL commands are used for this. </p><br><pre> <code class="plaintext hljs">#!/usr/bin/env bash mvn liquibase:updateSQL\ -Denv=dev\ -Dliquibase.url="jdbc:postgresql://dev/test?prepareThreshold=0&amp;stringtype=unspecified" &gt; /tmp/script.sql</code> </pre> <br><h2 id="podrobnee-o-changeset">  Read more about changeSet </h2><br><p>  Changes can be in different formats, including normal sql or it is in a separate file. </p><br><p>  Each change can include a rollback section that allows you to roll back changes with the <strong>liquibase: rollback</strong> command.  In addition, for marking changes, for example, for a more convenient rollback there, you can use <strong>tagDatabase</strong> . </p><br><h3 id="obychnyy-format">  Plain format </h3><br><pre> <code class="plaintext hljs">&lt;changeSet context="legacy" author="author (generated)" id="1"&gt; &lt;createTable tableName="test"&gt; &lt;column autoIncrement="true" name="id" type="SERIAL"&gt; &lt;constraints primaryKey="true" primaryKeyName="test_pkey"/&gt; &lt;/column&gt; &lt;column name="c1" type="VARCHAR(255)"/&gt; &lt;column name="c2" type="INTEGER"/&gt; &lt;column name="c3" type="SMALLINT"/&gt; &lt;column name="c4" type="VARCHAR(255)"/&gt; &lt;column name="c5" type="TEXT"/&gt; &lt;column name="c6" type="VARCHAR(255)"/&gt; &lt;/createTable&gt; &lt;/changeSet&gt;</code> </pre> <br><h3 id="vstroennyy-sql">  Embedded SQL </h3><br><pre> <code class="plaintext hljs">&lt;changeSet context="legacy" author="author" id="1-domain-some-domain"&gt; &lt;sql&gt; CREATE DOMAIN public.some_domain AS bigint; ALTER DOMAIN public.some_domain OWNER TO test; &lt;/sql&gt; &lt;rollback&gt; DROP DOMAIN public.some_domain; &lt;/rollback&gt; &lt;/changeSet&gt;</code> </pre> <br><h3 id="fayl-sql">  SQL file </h3><br><pre> <code class="plaintext hljs">&lt;changeSet context="legacy" author="author" id="1-user"&gt; &lt;sqlFile dbms="postgresql" path="sql/some.sql" relativeToChangelogFile="true" /&gt; &lt;rollback&gt; delete from "some"; &lt;/rollback&gt; &lt;/changeSet&gt;</code> </pre> <br><h3 id="tegi">  Tags </h3><br><pre> <code class="plaintext hljs">&lt;changeSet context="legacy" author="author" id="1-initial-changeset"&gt; &lt;tagDatabase tag="initial"/&gt; &lt;/changeSet&gt;</code> </pre> <br><h2 id="konteksty-zapuska">  Launch contexts </h2><br><p>  For more convenient management of various configurations, such as development / production, contexts can be used.  The context is specified in the <strong>changeSet</strong> context attribute and then launched by Maven with the -Dcontexts parameter. </p><br><h3 id="izmenenie-s-kontekstom">  Change with context </h3><br><pre> <code class="plaintext hljs">&lt;changeSet context="legacy" author="author" id="1-initial-changeset"&gt; &lt;tagDatabase tag="initial"/&gt; &lt;/changeSet&gt;</code> </pre> <br><h3 id="zapusk-izmeneniy-po-kontekstu">  Run changes by context </h3><br><pre> <code class="plaintext hljs">#!/usr/bin/env bash mvn liquibase:update\ -Denv=dev\ -Dliquibase.url="jdbc:postgresql://dev/test?prepareThreshold=0&amp;stringtype=unspecified"\ -Dliquibase.contexts=non-legacy</code> </pre> <br><h2 id="otkat-izmeneniy">  Roll back changes </h2><br><p>  The operation is a reverse upgrade, in most cases, is supported automatically.  For others, the task is possible through the rollback section.  Run by the liquibase: rollback command. </p><br><h3 id="izmenenie-s-otkatom">  Rollback change </h3><br><pre> <code class="plaintext hljs">&lt;changeSet context="legacy" author="author" id="1-domain-some-domain"&gt; &lt;sql&gt; CREATE DOMAIN public.some_domain AS bigint; ALTER DOMAIN public.some_domain OWNER TO test; &lt;/sql&gt; &lt;rollback&gt; DROP DOMAIN public.some_domain; &lt;/rollback&gt; &lt;/changeSet&gt;</code> </pre> <br><h3 id="zapusk-otkata">  Starting a rollback </h3><br><pre> <code class="plaintext hljs">#!/usr/bin/env bash mvn liquibase:update\ -Denv=dev\ -Dliquibase.url="jdbc:postgresql://dev/test?prepareThreshold=0&amp;stringtype=unspecified"\ -Dliquibase.contexts=non-legacy</code> </pre> <br><h2 id="sravnenie">  Comparison </h2><br><p>  In development, it is convenient to use to compare two existing bases for changes.  In the settings (or launch parameters) you will need to add a link to the reference database and data to access it. </p><br><p>  liquibase.properties </p><br><pre> <code class="plaintext hljs">referenceUsername=test referenceUrl=jdbc:postgresql://dev/test_reference</code> </pre> <br><h3 id="sravnenie-shem">  Comparison schemes </h3><br><p>  Comparing schemes url and referenceUrl. </p><br><pre> <code class="plaintext hljs">#!/usr/bin/env bash mvn liquibase:diff\ -Denv=dev\ -Dliquibase.referenceUrl="jdbc:postgresql://dev/test?prepareThreshold=0"\ -Dliquibase.url="jdbc:postgresql://dev/test_reference?prepareThreshold=0"\ -Dliquibase.diffChangeLogFile=dev/diff.xml</code> </pre> <br><h2 id="sohranenie-shemy">  Saving schema </h2><br><p>  It is also useful to keep the current database schema, with or without data.  It must be borne in mind that Liquibase keeps the scheme not fully corresponding to the original, for example, used domains or inheritance will need to be added separately (see Restrictions). </p><br><h3 id="sohranenie-shemy-bez-uchyota-dannyh">  Preservation of the scheme without data </h3><br><p>  Preservation of the existing base scheme. </p><br><pre> <code class="plaintext hljs">#!/usr/bin/env bash mvn liquibase:generateChangeLog\ -Denv=dev\ -Dliquibase.url="jdbc:postgresql://dev/test_reference?prepareThreshold=0"\ -Dliquibase.outputChangeLogFile=dev/changelog.xml</code> </pre> <br><h3 id="sohranenie-shemy-s-dannymi">  Saving a schema with data </h3><br><p>  Preservation of the existing database schema. </p><br><pre> <code class="plaintext hljs">#!/usr/bin/env bash mvn liquibase:generateChangeLog\ -Denv=dev\ -Dliquibase.url="jdbc:postgresql://dev/test_reference?prepareThreshold=0"\ -Dliquibase.outputChangeLogFile=dev/changelog.xml</code> </pre> <br><h2 id="ogranicheniya-i-problemy">  Limitations and problems </h2><br><h3 id="rabota-s-binarnymi-dannymi-v-baze">  Work with binary data in the database </h3><br><p>  There are certain problems with unloading, comparing and using binary data, in particular the problem with the generation of changes. </p><br><ul><li>  <a href="https://liquibase.jira.com/browse/CORE-2650">https://liquibase.jira.com/browse/CORE-2650</a> </li><li>  <a href="https://liquibase.jira.com/browse/CORE-2906">https://liquibase.jira.com/browse/CORE-2906</a> </li></ul><br><h3 id="nasledovanie-i-obschie-stolbcy">  Inheritance and common columns </h3><br><ul><li>  <a href="http://forum.liquibase.org/topic/postgresql-subtable-via-inherits">http://forum.liquibase.org/topic/postgresql-subtable-via-inherits</a> </li><li>  <a href="https://stackoverflow.com/questions/25840467/liquibase-common-columns">https://stackoverflow.com/questions/25840467/liquibase-common-columns</a> </li></ul><br><h2 id="ishodnyy-kod">  Source </h2><br><ul><li>  <a href="https://github.com/liquibase/liquibase">https://github.com/liquibase/liquibase</a> </li></ul><br><h2 id="alternativnye-resheniya">  Alternative solutions </h2><br><h3 id="flyway">  Flyway </h3><br><p>  Along with Liquibase it is popular in the Java community - <a href="http://flywaydb.org/documentation">http://flywaydb.org/documentation</a> </p><br><h3 id="sqitch">  Sqitch </h3><br><p>  Perl Analog - <a href="http://sqitch.org/">http://sqitch.org</a> </p><br><h3 id="fluentmigrator">  FluentMigrator </h3><br><p>  Analog for .Net - <a href="https://github.com/schambers/fluentmigrator">https://github.com/schambers/fluentmigrator</a> </p><br><h3 id="dbgeni">  DBGeni </h3><br><p>  Analog for Ruby - <a href="http://dbgeni.appsintheopen.com/manual.html">http://dbgeni.appsintheopen.com/manual.html</a> </p><br><h2 id="prilozheniya">  Applications </h2><br><h3 id="struktura-proekta">  Project structure </h3><br><pre> <code class="plaintext hljs">pom.xml - maven makefile dev liquibase.properties - login/password etc master.xml - changesets</code> </pre> <br><h3 id="kak-dobavit-liquibase-v-suschestvuyuschiy-proekt">  How to add liquibase to an existing project </h3><br><ul><li>  <a href="https://www.liquibase.org/documentation/existing_project.html">https://www.liquibase.org/documentation/existing_project.html</a> </li><li>  <a href="https://www.liquibase.org/documentation/contexts.html">https://www.liquibase.org/documentation/contexts.html</a> </li></ul><br><h3 id="kak-rabotayut-izmeneniya-bazy">  How base changes work </h3><br><ul><li>  <a href="https://www.liquibase.org/documentation/changeset.html">https://www.liquibase.org/documentation/changeset.html</a> </li><li>  <a href="https://www.liquibase.org/documentation/databasechangelog_table.html">https://www.liquibase.org/documentation/databasechangelog_table.html</a> </li></ul><br><h3 id="bolshe-o-formate-izmeneniy">  More on format changes </h3><br><ul><li>  <a href="http://www.liquibase.org/documentation/json_format.html">http://www.liquibase.org/documentation/json_format.html</a> </li><li>  <a href="https://www.liquibase.org/documentation/changes/sql.html">https://www.liquibase.org/documentation/changes/sql.html</a> </li><li>  <a href="https://www.liquibase.org/documentation/changes/sql_file.html">https://www.liquibase.org/documentation/changes/sql_file.html</a> </li><li>  <a href="https://www.liquibase.org/documentation/column.html">https://www.liquibase.org/documentation/column.html</a> </li></ul><br><h3 id="bolshe-pro-update">  More about update </h3><br><ul><li>  <a href="https://www.liquibase.org/documentation/maven/generated/update-mojo.html">https://www.liquibase.org/documentation/maven/generated/update-mojo.html</a> </li></ul><br><h3 id="bolshe-o-generacii-izmeneniy">  More on generating changes. </h3><br><ul><li>  <a href="https://www.liquibase.org/documentation/maven/generated/generateChangeLog-mojo.html">https://www.liquibase.org/documentation/maven/generated/generateChangeLog-mojo.html</a> </li></ul><br><h3 id="bolshe-o-kastomnom-sql">  More about custom SQL </h3><br><ul><li>  <a href="http://www.liquibase.org/documentation/modify_sql.html">http://www.liquibase.org/documentation/modify_sql.html</a> </li><li>  <a href="https://stackoverflow.com/questions/28240068/create-column-of-type-double-precision-with-liquibase">https://stackoverflow.com/questions/28240068/create-column-of-type-double-precision-with-liquibase</a> </li></ul><br><h3 id="obrabotka-tipov-dannyh-specifichnih-dlya-konkretnoy-bazy">  Handling database-specific data types </h3><br><pre> <code class="plaintext hljs">&lt;createTable tableName="t_name"&gt; ... &lt;column name="doubleArray" type="DOUBLE_ARRAY"/&gt; ... &lt;/createTable&gt; &lt;modifySql dbms="postgresql"&gt; &lt;replace replace="DOUBLE_ARRAY" with="double precision[][]"/&gt; &lt;/modifySql&gt;</code> </pre> <br><h3 id="prochee">  Other </h3><br><ul><li>  <a href="https://news.ycombinator.com/item%3Fid%3D10145933">https://news.ycombinator.com/item?id=10145933</a> </li></ul></div>