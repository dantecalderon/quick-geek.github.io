<div class="post__text post__text-html js-mediator-article">  The fast-paced modular trojan <a href="https://www.welivesecurity.com/%3Fs%3Ddanabot">DanaBot</a> has undergone new changes.  In the version released at the end of January 2019, a completely new communication protocol was implemented, adding several levels of encryption to the communication of the Trojan and its C &amp; C server.  In addition, the DanaBot architecture and campaign identifiers have been changed. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2r/-x/j0/2r-xj085tr128-hi_nkl5xix_fk.jpeg"></div><a name="habracut"></a><br><h4>  DanaBot Evolution </h4><br>  After being <a href="https://www.proofpoint.com/us/threat-insight/post/danabot-new-banking-trojan-surfaces-down-under-0">discovered</a> in May 2018 as part of a spam campaign targeting Australia, DanaBot featured in a number of other attacks, including a spam campaign in <a href="https://www.welivesecurity.com/2018/09/21/danabot-targeting-europe-adds-new-features/">Poland, Italy, Germany, Austria and Ukraine</a> , as well as the <a href="https://www.proofpoint.com/us/threat-insight/post/danabot-gains-popularity-and-targets-us-organizations-large-campaigns">United States</a> .  In European campaigns, the Trojan's functionality has been expanded with the help of new plug-ins and <a href="https://www.welivesecurity.com/2018/12/06/DanaBot-evolves-beyond-banking-trojan-new-spam/">spamming capabilities</a> . <br><br>  On January 25, we detected in the telemetry data unusual executable files associated with DanaBot.  Further verification revealed that these binary files are indeed versions of DanaBot, but they use a different communication protocol to communicate with the C &amp; C server.  Since January 26, Trojan operators have stopped assembling binary files with the old protocol. <br><br>  At the time of writing this post, the new version of DanaBot was distributed under two scenarios: <br><br><ol><li>  as “updates” delivered to the victims of DanaBot; </li><li>  by spamming (in Poland). </li></ol><br><h4>  New communication protocol </h4><br>  In the protocol that was used until January 25, the packets were not encrypted, as shown in Figure 1. <br><br><img src="https://habrastorage.org/webt/b-/gk/hh/b-gkhhs8ao2zo0hc8f-gkegxw70.png"><br>  <i>Figure 1. A packet capture showing the old protocol with unencrypted data</i> <br><br>  After completion, DanaBot uses the AES and RSA encryption algorithms in communication with the C &amp; C server.  The new communication protocol is more complicated because it uses several levels of encryption, as shown in the figure below. <br><br><img src="https://habrastorage.org/webt/yw/0g/p2/yw0gp28vvzyyhwda2docdtdlpsm.png"><br>  <i>Figure 2. Diagram of the new DanaBot communication protocol</i> <br><br>  These changes avoid detection using existing network signatures and make it difficult to write new rules for intrusion detection and prevention systems.  In addition, without access to the corresponding RSA keys, it is impossible to decode packets sent or received;  thus, RSAP files from cloud analysis systems (such as <a href="https://any.run/">ANY.RUN</a> ) are unsuitable for research. <br><br><img src="https://habrastorage.org/webt/un/et/ax/unetaxozodao8hdqd4b7rknum8s.png"><br>  <i>Figure 3. Capturing a packet with a new communication protocol</i> <br><br>  Each packet sent by the client has a 24 (0x18) byte header: <br><br><img src="https://habrastorage.org/webt/td/ey/gk/tdeygk9my0uhayelwswdqx_bvhg.png"><br><br>  For each packet, the header is followed by the packet data encrypted with AES, then a 4-byte value indicating the size of the AES offset, and then the AES key encrypted with RSA.  All packages are encrypted with different AES keys. <br><br>  Server responses use the same format.  Unlike previous versions, the package data in the server responses does not correspond to any particular structure (with some exceptions). <br><br><h4>  Data packet structure </h4><br>  The previous package data structure was described in detail by <a href="https://www.proofpoint.com/us/threat-insight/post/danabot-gains-popularity-and-targets-us-organizations-large-campaigns">Proofpoint</a> in October 2018.  In the latest version of DanaBot, this scheme is slightly modified, as shown in the figure below. <br><br><img src="https://habrastorage.org/webt/hc/7c/y4/hc7cy4kstqughqsadg1vff-xdue.png"><br>  <i>Figure 4. Comparing the package data structure in the old and new versions of DanaBot</i> <br><br><h4>  DanaBot architecture changes </h4><br>  In addition to the communication protocol, the architecture has been slightly modified in DanaBot.  Previous versions of the Trojan included the component that downloaded and executed the main module.  Then the main module loaded and executed plugins and configurations. <br><br>  In the latest version, these functions are performed by the new loader, which is used to download all the plug-ins along with the main module.  Persistence is ensured by registering the loader component as a service. <br><br><img src="https://habrastorage.org/webt/c2/by/_p/c2by_pcvcbrnmqztjyxwlcgqps8.png"><br>  <i>Figure 5. Comparing the architecture of the old and the new versions of DanaBot</i> <br><br><h4>  Teams </h4><br>  According to the analysis, the bootloader component uses the following commands: <br><br><ul><li>  0x12C - Hello.  The first command sent from client to server </li><li>  0x12D - download 32/64-bit launcher component </li><li>  0x12E - request list of plugins and configuration files </li><li>  0x12F - load plugins / configuration files </li></ul><br>  The downloaded plugins and configuration files are encrypted with the AES key obtained from the client ID.  In addition, plug-ins are archived in ZIP format using LZMA compression, while configuration files are zlib. <br>  Commands with ID 0x130–0x134 are sent by the main module: <br><br><ul><li>  0x130 - transfer the collected information to a C &amp; C server (for example, a screenshot of the victim's computer; system data) </li><li>  0x131 - transfer the collected information to a C &amp; C server (for example, a list of files on the infected computer’s hard disk) </li><li>  0x132 - request further commands from the C &amp; C server.  There are about 30 commands typical for backdoors, including running plugins, collecting system information and changing files in the client system. </li><li>  0x133 - update the list of C &amp; C servers via Tor proxy </li><li>  0x134 - exact destination unknown, most likely used for communication between plugins and C &amp; C server </li></ul><br><h4>  Changing Campaign IDs </h4><br>  A previous study showed that DanaBot is distributed under different IDs. <br><br>  In the previous version of DanaBot, <a href="https://asert.arbornetworks.com/danabots-travels-a-global-perspective/">about 20 campaign identifiers were used</a> .  In the latest version of the identifiers have changed slightly.  As of February 5, 2019, we see the following IDs: <br><br><ul><li>  ID = 2 apparently, a test version serving a small number of configuration files, without web injects </li><li>  ID = 3 is actively distributed, targeted at users in Poland and Italy, serves all configuration files and web injections for Polish and Italian purposes. </li><li>  ID = 5 serves configuration files for Australian purposes. </li><li>  ID = 7 is distributed in Poland only, serves web injections for Polish purposes. </li><li>  ID = 9 apparently, is also a test version with limited distribution and without special targeting, serves a limited number of configuration files, without web injects </li></ul><br><h4>  findings </h4><br>  In 2018, we observed the development of DanaBot in terms of <a href="https://www.welivesecurity.com/2018/09/21/danabot-targeting-europe-adds-new-features/">distribution</a> and <a href="https://www.welivesecurity.com/2018/12/06/danabot-evolves-beyond-banking-trojan-new-spam/">functionality</a> .  In early 2019, the Trojan underwent "internal" changes, indicating the active work of its creators.  Recent updates suggest that the creators of DanaBot are making efforts to avoid detection at the network level.  It is possible that the Trojan authors pay attention to published studies in order to promptly make changes to the code, ahead of the developers of security products. <br><br>  ESET products detect and block all DanaBot components and plugins.  Detection names are listed in the next section. <br><br><h4>  Compromise Indicators (IoCs) </h4><br>  <b>C &amp; C servers used by the new version of DanaBot</b> <br><br> <code>84.54.37[.]102 <br> 89.144.25[.]243 <br> 89.144.25[.]104 <br> 178.209.51[.]211 <br> 185.92.222[.]238 <br> 192.71.249[.]51</code> <br> <br>  <b>Web Injection and Redirect Servers</b> <br><br> <code>47.74.249[.]106 <br> 95.179.227[.]160 <br> 185.158.249[.]144</code> <br> <br>  <b>Hash examples</b> <br><br>  New DanaBot builds come out regularly, so we can provide only part of the hashes: <br>  Dropper <code>98C70361EA611BA33EE3A79816A88B2500ED7844</code> Win32 / TrojanDropper.Danabot.O <br>  Boot Loader (x86), ID = 3 <code>0DF17562844B7A0A0170C9830921C3442D59C73C</code> Win32 / Spy.Danabot.L <br>  Boot Loader (x64), ID = 3 <code>B816E90E9B71C85539EA3BB897E4F234A0422F85</code> Win64 / Spy.Danabot.G <br>  Boot Loader (x86), ID = 9 <code>5F085B19657D2511A89F3172B7887CE29FC70792</code> Win32 / Spy.Danabot.I <br>  Boot Loader (x64), ID = 9 <code>4075375A08273E65C223116ECD2CEF903BA97B1E</code> Win64 / Spy.Danabot.F <br>  The main module (x86) <code>28139782562B0E4CAB7F7885ECA75DFCA5E1D570</code> Win32 / Spy.Danabot.K <br>  The main module (x64) <code>B1FF7285B49F36FE8D65E7B896FCCDB1618EAA4B</code> Win64 / Spy.Danabot.C <br><br>  <b>Plugins</b> <br><br>  RDPWrap <code>890B5473B419057F89802E0B6DA011B315F3EF94</code> Win32 / Spy.Danabot.H <br>  Stealer (x86) <code>E50A03D12DDAC6EA626718286650B9BB858B2E69</code> Win32 / Spy.Danabot.C <br>  Stealer (x64) <code>9B0EC454401023DF6D3D4903735301BA669AADD1</code> Win64 / Spy.Danabot.E <br>  Sniffer <code>DBFD8553C66275694FC4B32F9DF16ADEA74145E6</code> Win32 / Spy.Danabot.B <br>  VNC <code>E0880DCFCB1724790DFEB7DFE01A5D54B33D80B6</code> Win32 / Spy.Danabot.D <br>  TOR <code>73A5B0BEE8C9FB4703A206608ED277A06AA1E384</code> Win32 / Spy.Danabot.G </div>