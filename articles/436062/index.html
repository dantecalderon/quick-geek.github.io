<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Arbitration system for beginners, part 1</title>
  <meta name="description" content="About 7 years ago, he had experience writing a terminal for the Moscow Exchange. Part of the team was fond of algorithmic trading, including me. Howev...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-6974184241884155",
      enable_page_level_ads: true
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>Arbitration system for beginners, part 1</h1><div class="post__text post__text-html js-mediator-article">  About 7 years ago, he had experience writing a terminal for the Moscow Exchange.  Part of the team was fond of algorithmic trading, including me.  However, I never perceived this business as a real source of income, although there were some successes in this.  It is clear that to compete with banks and various foundations, with their teams of mathematicians and programmers is difficult and easier to implement in other areas. <br><br>  Now at the hearing of cryptocurrency, there is a huge number of exchanges.  Based on the assumption that the difference in rates on different exchanges, you can earn, I decided to explore the possibility of creating an arbitration robot.  But mainly to start learning python with a real example.  So let's get started. <br><a name="habracut"></a><br>  First of all, it is required to detect currency pairs for which arbitrage trading is possible.  We need couples who, as a first approximation, are actively trading, and prices on different exchanges diverge and converge. <br><br>  Offhand, the work plan should be: <br><br><ul><li>  Creating a database where prices of currency pairs will be stored. </li><li>  The server that will save data to the database. </li><li>  Primary analysis. </li></ul><br>  Sources are available by reference <a href="">arb_analysis</a> . <br><br><h3>  Database creation </h3><br>  In order to store data, you need 3 tables. <br><br>  A list of stock exchanges will be stored in this table. <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`exchange`</span></span> ( <span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">`name`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=MyISAM;</code> </pre> <br>  List of cryptocurrency pairs. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`market`</span></span> ( <span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">`name`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`id_exchange`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=MyISAM; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> id_exchange <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> market (id_exchange);</code> </pre><br>  The table with transactions, information will also be stored here, according to data from the stock exchange glass. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`ticker`</span></span> ( <span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">`id_market`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">5</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`local_time`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">9</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`timestamp`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">9</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`last`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">DECIMAL</span></span> (<span class="hljs-number"><span class="hljs-number">11</span></span>,<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`low`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">DECIMAL</span></span> (<span class="hljs-number"><span class="hljs-number">11</span></span>,<span class="hljs-number"><span class="hljs-number">11</span></span>), <span class="hljs-string"><span class="hljs-string">`high`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">DECIMAL</span></span> (<span class="hljs-number"><span class="hljs-number">11</span></span>,<span class="hljs-number"><span class="hljs-number">11</span></span>), <span class="hljs-string"><span class="hljs-string">`bid`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">DECIMAL</span></span> (<span class="hljs-number"><span class="hljs-number">11</span></span>,<span class="hljs-number"><span class="hljs-number">11</span></span>), <span class="hljs-string"><span class="hljs-string">`ask`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">DECIMAL</span></span> (<span class="hljs-number"><span class="hljs-number">11</span></span>,<span class="hljs-number"><span class="hljs-number">11</span></span>), PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=MyISAM; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> id_market <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> ticker (id_market);</code> </pre><br><h3>  Receiving data from exchanges </h3><br>  For convenient access to the exchanges there is an open source project ccxt.  With the help of which it is possible in the same style to access various exchanges.  However, it turned out that not everything is so rosy, information could not be obtained on a number of exchanges, and some methods did not work. <br><br>  In the create_markets.py file, initialization takes place, we get a list of cryptocurrency pairs, by exchanges.  This uses the load_markets () method, which returns a list of pairs for the exchange. <br><br><pre> <code class="python hljs">name_exchange = [<span class="hljs-string"><span class="hljs-string">"acx"</span></span>, <span class="hljs-string"><span class="hljs-string">"binance"</span></span>, <span class="hljs-string"><span class="hljs-string">"bitfinex"</span></span>, <span class="hljs-string"><span class="hljs-string">"bitfinex2"</span></span>, <span class="hljs-string"><span class="hljs-string">"wex"</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create_exchange_and_market_in_db</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> exchanges = {} <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> id <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> name_exchange: exchange = getattr(ccxt, id) exchanges[id] = exchange() id_exchage = db_helper.insert_exchage_to_db(exchanges[id],cnx,cursor) markets = exchanges[id].load_markets() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> mark <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> markets: id_market = db_helper.insert_market_to_db( id_exchage, mark, cnx,cursor)</code> </pre><br>  Next, in the ex_data_saver.py file, start saving the price change for pairs: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> markets = db_helper.get_data_exch() exchanges = {} <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> id <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> name_exchange: exchange = getattr(ccxt, id) <span class="hljs-comment"><span class="hljs-comment">#isHas = exchange.hasFetchTickers #if isHas: exchanges[id] = exchange({ 'enableRateLimit': True, # or .enableRateLimit = True later }) cnx = db_helper.CreateConnection() cursor = cnx.cursor() loop = asyncio.get_event_loop() while True: start_time = time.time() input_coroutines = [fetch_ticker(exchanges, name) for name in exchanges] exch_tickers = loop.run_until_complete(asyncio.gather(*input_coroutines, return_exceptions=True)) count_exchange = 0 delta = time.time() - start_time for tickers in exch_tickers: if tickers is not None: count_exchange+=1 inserted_start = time.time() db_helper.insert_tick(markets,exch_tickers,cnx,cursor) inserted_time = time.time() print(count_exchange," ", delta, ' ', inserted_start - inserted_time)</span></span></code> </pre><br>  Asynchronous receiving of ticks for a specific pair is performed using the ccxt fetchTickers () method. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetch_ticker</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(exchanges, name)</span></span></span><span class="hljs-function">:</span></span> item = exchanges[name] <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: ticker = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> item.fetchTickers() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {name:ticker}</code> </pre><br><h3>  Preliminary data analysis </h3><br>  First of all, it is interesting on which exchanges and on which pairs, the most active trading takes place, we are interested in liquid pairs.  To do this, you need to calculate the number of deals with grouping by exchanges and specific pairs.  As a result, we get a pair, which is an active trade. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> ex.name <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> exchange_name, m.name <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> market_name, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> count_deals <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exchange</span></span> ex <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> market m <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> m.id_exchange = ex.id <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> ticker t <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> t.id_market =m.id <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> ex.id, t.id_market <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> m.name <span class="hljs-keyword"><span class="hljs-keyword">HAVING</span></span> count_deals &gt; <span class="hljs-number"><span class="hljs-number">10000</span></span>;</code> </pre><br>  Using SQL queries, you can find various patterns and filter out the data, but for detailed analysis, you need to create a test robot that works on data accumulated from various exchanges. <br><br>  The next article will be devoted to the creation of this robot.  And a test server - emulating the work of a real exchange. In the test server I want to lay down the following points: <br><br><ul><li>  Latency </li><li>  Slip. </li><li>  Commission. </li></ul></div><p>Source: <a href="https://habr.com/ru/post/436062/">https://habr.com/ru/post/436062/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>