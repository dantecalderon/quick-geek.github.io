<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Company network and MitM. Part 1</title>
  <meta name="description" content="Intercept confidential information? Get unauthorized access to various applications and systems? Disrupt normal operation? All this and more are carri...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-6974184241884155",
      enable_page_level_ads: true
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>Company network and MitM. Part 1</h1><div class="post__text post__text-html js-mediator-article">  Intercept confidential information?  Get unauthorized access to various applications and systems?  Disrupt normal operation?  All this and more are carried out by attacks like Man in the Middle. <br><br><img src="https://habrastorage.org/webt/kh/sf/0n/khsf0nyho00ib-qtgd3yqz1hoxg.jpeg"><br>  Today we begin a series of articles devoted to man-in-the-middle attacks (and a number of related ones) on typical protocols and transmission channels found in almost any company.  To begin, consider the basic levels: physical and channel. <br><br>  Interested?  Welcome under cat. <br><a name="habracut"></a><br><h3>  Some theory </h3><br>  Man in the Middle (aka ‚Äúman in the middle‚Äù attack, also known as ‚Äúmediator attack‚Äù) is generally a type of attack aimed at breaching confidentiality and, in some cases, integrity of information.  Schematically describe the "typical" attack as follows: <br><br><img src="https://habrastorage.org/webt/1t/8r/fn/1t8rfnbvyhsewwcajvs73r4a61k.jpeg"><br><br>  The main lines in the figure are both orange and red.  Orange - the estimated data path, red - the actual.  The transmission medium or protocol in this case is unimportant.  Alice can be, for example, a Wi-Fi client, and Bob can be a Wi-Fi access point.  Anyway, there is always a third party that performs any actions with the transmitted information. <br><br>  Why did we miss the transmission channel?  Because all levels of the OSI network model are subject to such an attack in one way or another.  Further we will confirm it. <br><br>  Let us proceed to consider the attack from the first and second levels of OSI - physical and channel. <br><br><h3>  Practice </h3><br>  <b>Copper</b> <br><br>  Let's start with the simplest thing - picking data from a twisted pair.  This is not exactly MitM, this is classic sniffing, but in this case it is a ‚Äúprerequisite‚Äù for more serious attacks.  In fact, to remove data from a twisted pair, say, 100Base-T, it is enough to have just an extra router on which to install any DD-WRT / OpenWRT or any other analogue.  Some time ago, a similar thing was mentioned <a href="https://habr.com/ru/post/90678/">here</a> . <br><br>  A more reliable way is to use special devices.  But he has flaws: <br><br><ol><li>  With proper physical security (access control, video surveillance) and good awareness of employees about the actions, in case of the appearance of ‚Äúsuspicious‚Äù items, the risk of detecting such devices is extremely high. </li><li>  The attacker gains access only to the data that goes on the cable to which he connected.  If the cable is connected to the security guard‚Äôs booth, then most likely the offender will be able to watch images from a number of cameras and periodic Youtube sessions, but not financial data from SAP. </li><li>  Third, and most important is traffic encryption.  In fact, now almost any server, any service works through TLS or uses any analog to encrypt the transmitted data.  Without a key, we will not decrypt the transferred data.  And in the case of using TLS 1.3 or TLS 1.2 on <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D1%2580%25D0%25BE%25D1%2582%25D0%25BE%25D0%25BA%25D0%25BE%25D0%25BB_%25D0%2594%25D0%25B8%25D1%2584%25D1%2584%25D0%25B8_%25E2%2580%2594_%25D0%25A5%25D0%25B5%25D0%25BB%25D0%25BB%25D0%25BC%25D0%25B0%25D0%25BD%25D0%25B0">Diffie-Hellman algorithms,</a> even this will not help. </li></ol><br>  Everything leads to the fact that such sniffing may not bring the desired results to the attacker.  A more ‚Äúflexible‚Äù connection is required, that is, ‚Äúembedding‚Äù into the data line.  For example, like this, a little brazenly: <br><br><img src="https://habrastorage.org/webt/j0/rq/jh/j0rqjhkhjbtfdebcavvip4cwm0s.jpeg"><br><br>  This method has many disadvantages.  For example, it is easy to detect it in the presence of various means of protection or suspicious eyes suspicious of the emergence of something new in the workplace.  But he has an advantage: full control and the possibility of modifying the transmitted data.  Let's model attack in real life.  It will take 2 things: my working machine on which this text is written, my laptop with <a href="https://www.archlinux.org/">Arch</a> on board, although any Linux distribution should work.  The connections ‚Äúmy working machine‚Äù - ‚Äúlaptop‚Äù and ‚Äúlaptop‚Äù - ‚Äúlocal network‚Äù will be made over a cable, for which a USB network adapter is connected to the laptop.  We will use <a href="https://linux.die.net/man/8/brctl">brctl</a> to configure the bridge, although this functionality is declared even by <a href="https://gitlab.freedesktop.org/NetworkManager/NetworkManager">NetworkManager</a> . <br><br>  Configure the bridge: <br><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># brctl addbr br0 // –≤–º–µ—Å—Ç–æ br0 –º–æ–∂–µ–º –≤–≤–µ—Å—Ç–∏ –ª—é–±–æ–µ —É–¥–æ–±–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ # brctl addif br0 enp14s0 // –∑–¥–µ—Å—å enp14s0 ‚Äì –º–æ–π –≤–Ω–µ—à–Ω–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, —É –≤–∞—Å, —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –æ–Ω –±—É–¥–µ—Ç –Ω–∞–∑—ã–≤–∞—Ç—å—Å—è –∏–Ω–∞—á–µ # brctl addif br0 enp0s20u4 // enp0s20u4 ‚Äì –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Ä–∞–±–æ—á–µ–≥–æ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞</span></span></code> </pre> <br>  If you want to get an IP address at the same time, you just need to set some <a href="https://linux.die.net/man/8/dhclient">dhclient</a> on br0, or set up a static IP with your hands (# ip ad add XXXX / X dev br0). <br><br>  So, the bridge interface is created on the laptop, a computer is connected to the USB interface, the main interface goes to the local area network.  We launch any traffic interception software (for convenience, I will use <a href="https://www.wireshark.org/">Wireshark</a> with GUI) and observe the following: <br><br> <a href=""><img src="https://habrastorage.org/webt/cb/__/hi/cb__hi4taxtjxwoyjro1aaob91g.jpeg"></a> <br>  <i>Figure 1. Wireshark in action</i> <br><br>  As you can see, here is the entire traffic dump of the machine with the address 192.168.139.206 (for the tests I created a test network).  In the current configuration (without <a href="https://www.juniper.net/documentation/en_US/junos/topics/concept/mac-pinning-understanding.html">MAC-pinning</a> , for example), no one will notice my presence on the network at all.  This attack allows you to get a lot of information, including logins / passwords, for example, for the site <a href="http://www.diary.ru/">diary.ru</a> : <br><br> <a href=""><img src="https://habrastorage.org/webt/kq/hw/_j/kqhw_jeehbfeyp_ujukyxdxqbys.jpeg"></a> <br>  <i>Figure 2. Ooops</i> <br><br>  In fact, everything is a little more complicated.  <a href="http://www.diary.ru/">diary.ru</a> is one of the rare sites that do not redirect the user to encrypted HTTPS.  Dealing with HTTPS is harder than open traffic.  And most of the traffic I caught is encrypted, which is actually good for the user, but not very good for me at the moment. <br><br>  How to protect yourself?  There are several options, each with its own characteristics: <br><br><ol><li>  MAC-pinning does not help: MAC'i fake all and sundry.  On the same Linux, you can use macchanger, and in Windows through the Device Manager; </li><li>  802.1X authentication is a great thing.  But there are a couple of nuances: in the mode of the simplest sniffing, it will not protect, since the attacker remains "invisible" to connect from the point of view of the switch, only the attacked device is connected to the network port.  Another thing, in the case of the impact on traffic, the chance to reveal its presence is seriously increased, because now the network through the switch starts to emit traffic from you, to which various means of protection can react.  Everything depends on the equipment used (SIEM or something similar) and the skills of the security men in the company; </li><li>  ‚ÄúUser and entity behavior analytics‚Äù (UEBA) solutions will allow you to track something suspicious on the network.  As in the case of 802.1X, with normal sniffing you remain invisible, but they will leave you behind when generating traffic.  It is used not so often, and everything again depends on the skills of the security men. </li></ol><br>  The question arises: what to do if the computer you want to access is, for example, indoors, and the cable is under cameras or hidden?  Nothing complicated, just resort to the simplest spoofing attacks.  When requesting the MAC address of a specific node, the attacking node starts ‚Äúspamming‚Äù the network with ARP packets, in which its MAC is specified as the required address, thereby causing the attacker to connect to our host. <br><br>  You must first select a target.  In my case it will be my colleague.  Now use the very ancient, but quite workable <a href="https://www.ettercap-project.org/">ettercap</a> .  We will determine the IP address of a colleague in any way, further we will designate the target of the attack.  For example, I want to find out which DNS my colleague was looking for.  After that in ettercap I drive in 2 IP addresses: the address of the DNS server and, in fact, the address of the victim.  AND‚Ä¶ <br><br> <a href=""><img src="https://habrastorage.org/webt/3w/p6/72/3wp672zogodzwj9czv7wkbi6ry0.jpeg"></a> <br>  <i>Figure 3. We catch DNS queries</i> <br><br>  It is clear that my colleague is looking for information on the Cisco website, and at the same time his system sends "service" requests to identify various MS sites. <br><br>  There is some good news.  A large list of equipment supports protection against ARP-spoofing, which can negate such attacks.  And if the company uses SOC or SIEM, then you can try to find the attacker in hot pursuit. <br><br>  <b>Optics</b> <br><br>  Fiber-optic communication lines are another, extremely common communication channel in any company.  What's up with MitM protection? <br><br>  The situation is twofold.  If we take the simplest cable without special protective reinforced shells, then for the simplest sniffing it is enough to bend it.  A special device hangs on a bend.  Part of the light goes beyond the cable to our device, from which we collect the entire dump. <br><br>  It is good that most of the traffic is still encrypted.  What to do if not?  In fact, it is difficult to defend.  The easiest way to isolate optics in such a way as to get close to it was difficult.  Another way is to use a more expensive ‚Äúprotected‚Äù cable, which includes special protection measures that allow you to detect a broken cable sheath.  But with proper skill, you can connect to it, and re-laying the cable is often an extremely unpleasant affair.  An effective way is to use special equipment that will respond to changes in the signal level when a fiber bend appears.  The price of the issue is high.  Well, perhaps the best solution is to use encryption of the transmitted traffic. <br><br>  If we want to somehow influence traffic, then everything is more complicated.  The most effective way is a tie-in, in which special equipment is built in the middle.  The disadvantage of this method is that we need for some time (rather large) to cut the cable with all the ensuing consequences, which can confuse the security men in the company.  But if successful, we will, in most cases, be able to influence a large amount of traffic, since the fiber is rarely laid up to the users computer.  Most often, this is a data transmission channel, for example, between separate branches of companies. <br><br>  An article covering a slightly larger number of fiber connection options is also available <a href="https://habr.com/ru/post/176677/">here</a> . <br><br>  <b>And what about Wi-Fi?</b> <br><br>  And all the same and even easier!  Consider for starters WPA2-PSK (connection by password).  For the ‚Äúsecrecy‚Äù of the attack, it is important to fulfill one requirement: you need to know the real password, this will allow the devices on which the automatic connection to the network is configured to connect to the ‚Äúmalicious‚Äù network without any problems.  So, we raise a Wi-Fi access point with an identical password and wait for connections.  If you don‚Äôt want to wait, you can start sending out deauth packets, which will force users to disconnect from current access points, and for some of them, for which the malicious access point will be more powerful, force them to connect to you.  To create a point, I used <a href="https://w1.fi/hostapd/">hostapd</a> - the most powerful tool for creating various networks in all possible configurations.  I connected the Wi-Fi interface to the br0 bridge so that users would not notice something amiss and could continue to work with services within the local network.  We are waiting for some time and enjoy the results. <br><br> <a href=""><img src="https://habrastorage.org/webt/zt/k8/8n/ztk88nyiocctaptvyjyesncaip0.jpeg"></a> <br>  <i>Figure 4. Watch the iPhone dump</i> <br><br>  WPA2 Enterprise (with authentication through an external service, such as RADIUS) is much better in terms of security.  If classic PSK may not even have access to the company's local network (for example, if the network is guest), then for Enterprise to work it is necessary to have access to an authentication server, which can use the same <a href="https://docs.microsoft.com/ru-ru/windows-server/networking/technologies/nps/nps-top">Windows NPS</a> .  In addition, the access point requires a <a href="https://ru.wikipedia.org/wiki/%25D0%2598%25D0%25BD%25D1%2584%25D1%2580%25D0%25B0%25D1%2581%25D1%2582%25D1%2580%25D1%2583%25D0%25BA%25D1%2582%25D1%2583%25D1%2580%25D0%25B0_%25D0%25BE%25D1%2582%25D0%25BA%25D1%2580%25D1%258B%25D1%2582%25D1%258B%25D1%2585_%25D0%25BA%25D0%25BB%25D1%258E%25D1%2587%25D0%25B5%25D0%25B9">certificate with a private key</a> , which is very problematic to obtain.  You can, of course, release a self-signed one, but this can cause some problems, because in an ideal world the client device should verify this certificate.  In general, it is possible to set up a similar access point and make clients connect to it, but with great reservations.  Most likely, the attacker will still be able to catch. <br><br>  How to protect a Wi-Fi network?  Use WPA2 Enterprise (preferably with certificates) and configure client devices to check the certificate of the access point, then it will be much more difficult to emulate the Evil Twin access point.  Be careful in setting up the authentication server.  If it is permissible, use the capabilities of the existing equipment, for example, the Cisco Wireless Intrusion Prevention System, the essence of which in this case is to search for malicious access points and prevent different clients from connecting to them. <br><br><h3>  Instead of conclusion </h3><br>  Let's summarize a little.  As you can see, in one form or another, the most common data transmission channels are subject to MitM attacks.  How to protect yourself? <br><br><ul><li>  use encryption;  it is not so difficult and very effective; </li><li>  the introduction of any information systems (yes the same Wi-Fi) networks should not take place under the slogan ‚ÄúIf only it worked!‚Äù, especially if really important information will circulate in the system, it is necessary to consider the process from the point of view of information security; </li><li>  use protective equipment or functional equipment used.  Cisco WIPS, various IPS / IDS, UEBA, etc.  This will allow if you do not stop the work of the attacker, then to detect it and take measures to catch the criminal. </li></ul><br>  But what if the attacker is a "trusted" person?  An employee of the company who has legitimate access to the local network, but who has sabotage thoughts?  What can he do to analyze encrypted traffic and, most importantly, how can you protect yourself from this?  We will tell about this in the following articles, again returning to our DNS queries and to HTTPS traffic. </div><p>Source: <a href="https://habr.com/ru/post/438996/">https://habr.com/ru/post/438996/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>