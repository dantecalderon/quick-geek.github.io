<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>My address is not a house or a street, my address is the Soviet Union?</title>
  <meta name="description" content="microBIGDATA or FIAS in your pocket 


 Peter Bruegel Junior Paying Tax , 1640 

 The last entry at low level on objects went. Continue reconnaissance...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-6974184241884155",
      enable_page_level_ads: true
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>My address is not a house or a street, my address is the Soviet Union?</h1><div class="post__text post__text-html js-mediator-article">  <b>microBIGDATA or FIAS in your pocket</b> <br><br><img src="https://habrastorage.org/webt/gq/le/vh/gqlevhij14f0jkubb4pmbjwvb5u.jpeg"><br>  <i>Peter Bruegel Junior <b>Paying Tax</b> , 1640</i> <br><br>  The last entry at low level <a href="https://habr.com/ru/post/435612/">on objects</a> went.  Continue reconnaissance in force.  Today let's talk about the hard.  Suppose it is not about BIG DATA, but it‚Äôs already inconvenient to work - rather large amounts of data.  Not everyone will fit into the RAM as a whole, and some will not even fit on the disk (not enough space, but a lot of trash).  The name of our ward <a href="https://fias.nalog.ru/Updates.aspx">FIAS DB</a> is the database of the federal address information system.  5.5 GB archive.  And this is a compressed XML archive.  After unpacking, there will be a full 53 GB (for unpacking, store 110 GB).  And as you start parsing it and converting it, then 110 GB will not be enough.  About the required amount of RAM will also be. <br><a name="habracut"></a><br>  All anything, but you can dig further.  There is such an international open project for the collection and systematization of address data - <a href="https://openaddresses.io/">OpenAddresses</a> .  So there will be more databases.  The current coverage of the planet has many white spots, for example, Russia is almost absent.  Archive size - 10 GB. <br><br>  Or a database of a fairly well-known project <a href="https://planet.openstreetmap.org/">OpenStreetMaps</a> .  It is built by volunteers on the principle of Wikipedia.  Quite detailed and multilingual.  Now a full archive of compressed XML of 74 GB. <br><blockquote>  If they started talking about addresses, unexpected <a href="https://spreadprivacy.com/duckduckgo-apple-mapkit-js/">news arrived from DuckDuckGo</a> , the best of the safe search engines today, about its transition to Apple cards.  More precisely on Apple MapKit JS.  The most interesting feature in our context is the ‚Äúimproved address search‚Äù.  Apple painstakingly collects and saves our data?  It will be necessary to trace ... </blockquote>  So, the task.  How to put all this riches of wealth into a repository that is pleasant to use, to give an opportunity to dream of a loose API (on Python, of course) and not to allow the birth gland to choke on a load that is not read.  Let's call it MicroBigData - ¬µBD or ¬µBG in English :-) <br><br>  In the economy of every second (and even the first) developer, this piece is an address directory, it is also a directory of place names, a thing very necessary.  And when there is also a normative, the right body is prepared, cleaned and well documented - just a fairy tale.  We must pay tribute, the Russian tax service is doing its digital production well.  As much as possible.  There are probably some flaws inside and data cleaning continues.  How to resolve this issue, let the state heads think.  For themselves, decide and benefit us all.  By the way, one typo from FIAS was found in the example below.  The result does not affect.  Did not fix it.  Will you find? <br><br>  I don‚Äôt know how relevant address data is relevant in your projects - these are all regions, cities, streets.  But it seems that one project for people cannot do without them.  That address, where to find a person or where to send him a parcel.  That details of the passport or any other document must be saved.  Or maybe it is the address of the working office or attractions that are recommended to visit.  And what to do?  Where to get? <br><br>  The simplest solution, without regard to errors and duplicates, is primitive objects containing simple string literals (they are also string constants, they are also string).  Let the users make the next entries in them.  And objects are able to save themselves - we have already <a href="https://habr.com/ru/post/435612/">passed</a> . <br><br>  Such objects, for example, as described in the class below.  <a href="">Right from the textbook</a> , even if it is American, but adjusted for our Russian reality - instead of their ZIP, there will be our postalCode.  I would also replace the zip code with a number, but for the sake of monotony I would leave a string.  Anyone who has recognized the language right away, and this is ObjectScript, is relied upon to receive a like. <br><br><pre><code class="plaintext hljs">Class Soviet.Address Extends %Persistent { Property streetName As %String; Property cityName As %String; Property areaName As %String; Property postalCode As %String; }</code> </pre> <br>  Of course, many will be indignant, saying that from the pockets of the object everything is sticking out (with literals).  Where has it been seen that the object has its fields publicly luminous ?!  Let us leave it so far, painfully, an example of eloquent and understandable to any schoolchild. <br><br>  In fact, this is all that is needed.  Filled in the fields.  Put in storage.  Transferred to work other objects.  Inherited further by someone.  Everything is working.  And stored! <br><blockquote>  But a few words why you should not do this, you need to say.  What is our object Address?  Why can't it just be a group of text strings?  The most obvious objections that come to mind come from the context - who uses this Address, in what form and for what purposes?  Try to put aside your programming thinking and imagine how a ‚Äúforeign tourist‚Äù, ‚Äúhistorian‚Äù, ‚Äútax inspector‚Äù, ‚Äúlawyer‚Äù and so on thinks. <br><br>  I suppose, there immediately appears a mass of additional questions-clarifications: which language to use, in what encoding to store and deliver, to what epoch should be counted, which documents were put into effect, legal or postal?  Is a city a named settlement or what?  Even the street can be a boulevard, a lane, avenue or something else.  How to deal with all these important implementation details? <br><br>  Take a living example.  Google is now managed by Sundar Pichai.  He himself is from India.  Born in the city of Chennai (aka Chennai).  Or in Madras?  In 1996, the Indians decided that the name of the city was some very Portuguese and renamed the state capital Tamil Nadu from Madras to Chennai.  And what should Sundar and 72 million of his fellow countrymen write in their electronic documents? <br><br>  In general, the whole science deals with this - <a href="https://ru.wikipedia.org/wiki/%25D0%25A2%25D0%25BE%25D0%25BF%25D0%25BE%25D0%25BD%25D0%25B8%25D0%25BC%25D0%25B8%25D0%25BA%25D0%25B0">applied toponymy</a> . </blockquote>  So it begs questions in dogonku.  How to manage <a href="https://habr.com/ru/post/274811/">time and date</a> ?  Is <a href="https://medium.com/devschacht/how-to-handle-monetary-values-in-javascript-bb0706840f0e">money obvious</a> ?  Are geographical coordinates simple?  And how is this implemented in your code?  Can you transfer to the selected database without lowering the level of abstraction?  How not to slip into atomic types of machine data and constantly think about their reconstruction?  Here you should look for the source of a primitive or, on the contrary, good-quality API.  Think about it at your leisure. <br><br>  In short, the context is the most important.  And the object model gives us the opportunity to use this directly by encapsulating ‚Äúmachine data‚Äù and implementing context-dependent ‚Äúlive‚Äù behavior.  Not at all that the low-level tuples are arranged in tables ;-) <br><br>  For now, let us return to the ‚Äúprimitive‚Äù implementation and complicate our life.  To begin with, we will eliminate errors and duplicates.  That is, we will look for a way to write addresses right away.  At the same time, we will help UI developers organize hints to users when filling in data entry fields. <br><blockquote>  When two people gather in one place - the texts and the InterSystems IRIS data platform, the developer has a real opportunity to turn around to the full without departing from the machine.  For example, using the <a href="https://habr.com/ru/company/intersystems/blog/333582/">built-in object components iKnow and iFind</a> .  These are components for working with unstructured data and <a href="https://habr.com/ru/company/intersystems/blog/243217/">full-text search</a> , respectively.  Russian language is supported out of the box. </blockquote>  First and foremost, we teach the Address to read the necessary data from the original source.  Fortunately, in the data set of the Federal Tax Service there are ready-made descriptions of the structure of XML documents.  According to the <a href="https://fias.nalog.ru/Updates.aspx">description</a> attached to the data <a href="https://fias.nalog.ru/Updates.aspx">from the FIAS website</a> , we will need the ADDROBJ data set, which, in my case, corresponds to the file AS_ADDROBJ_2_250_01_04_01_01.xsd <br><br>  Next, we will use the IRS system's XSD system converter, kindly prepared for us by the developers of IRIS, into the appropriate field structure of the% XML.Adaptor class.  The percent sign at the beginning just means that it is a class from the system library.  <a href="">Details of use are in the documentation</a> .  We will perform operations in the terminal. <br><br><pre> <code class="plaintext hljs">set xmlScheme = ##class(%XML.Utils.SchemaReader).%New() do xmlScheme.Process("http://localhost/AS_ADDROBJ_2_250_01_04_01_01.xsd")</code> </pre> <br>  The same can be obtained in <a href="">IDE Attelier</a> (in Tools&gt; Add-Ins&gt; XML Schema Wizard) or by similar requests to objects directly from the program code. <br><br><img src="https://habrastorage.org/webt/ed/3k/8c/ed3k8cfd9t_jc8gklg_euthhihy.png"><br><br>  Since we used a constructor without specifying parameters, namely the name of the package for allocating the resulting classes, they were in the Test package.  As you can see from the second command, I gave the schema file through my local Python web server: <br><br><pre> <code class="bash hljs">python3 -m http.server 80</code> </pre> <br>  You can use any other http-server that you like.  Or upload the file to your IRIS server and point the way to it. <br><br>  As a result, we have two classes that completely reflect the structure of our address XML: <br><br><div class="spoiler">  <b class="spoiler_title">Test.AddressObjects</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">/// –°–æ—Å—Ç–∞–≤ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ –∞–¥—Ä–µ—Å–æ–æ–±—Ä–∞–∑—É—é—â–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ë–î –§–ò–ê–° Class Test.AddressObjects Extends (%Persistent, %XML.Adaptor) [ ProcedureBlock ] { Parameter XMLNAME = "AddressObjects"; Parameter XMLSEQUENCE = 1; /// –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∞–¥—Ä–µ—Å–æ–æ–±—Ä–∞–∑—É—é—â–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ Relationship Object As Test.Object(XMLNAME = "Object", XMLPROJECTION = "ELEMENT") [ Cardinality = many, Inverse = AddressObjects ]; }</code> </pre> <br></div></div><div class="spoiler">  <b class="spoiler_title">Test.Object</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">/// –°–æ–∑–¥–∞–Ω–æ –∏–∑: http://localhost:28869/AS_ADDROBJ_2_250_01_04_01_01.xsd Class Test.Object Extends (%Persistent, %XML.Adaptor) [ ProcedureBlock ] { Parameter XMLNAME = "Object"; Parameter XMLSEQUENCE = 1; /// –ì–ª–æ–±–∞–ª—å–Ω—ã–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∞–¥—Ä–µ—Å–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ Property AOGUID As %String(MAXLEN = 36, MINLEN = 36, XMLNAME = "AOGUID", XMLPROJECTION = "ATTRIBUTE") [ Required ]; /// –§–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ Property FORMALNAME As %String(MAXLEN = 120, MINLEN = 1, XMLNAME = "FORMALNAME", XMLPROJECTION = "ATTRIBUTE") [ Required ]; /// –ö–æ–¥ —Ä–µ–≥–∏–æ–Ω–∞ Property REGIONCODE As %String(MAXLEN = 2, MINLEN = 2, XMLNAME = "REGIONCODE", XMLPROJECTION = "ATTRIBUTE") [ Required ]; /// –ö–æ–¥ –∞–≤—Ç–æ–Ω–æ–º–∏–∏ Property AUTOCODE As %String(MAXLEN = 1, MINLEN = 1, XMLNAME = "AUTOCODE", XMLPROJECTION = "ATTRIBUTE") [ Required ]; /// –ö–æ–¥ —Ä–∞–π–æ–Ω–∞ Property AREACODE As %String(MAXLEN = 3, MINLEN = 3, XMLNAME = "AREACODE", XMLPROJECTION = "ATTRIBUTE") [ Required ]; /// –ö–æ–¥ –≥–æ—Ä–æ–¥–∞ Property CITYCODE As %String(MAXLEN = 3, MINLEN = 3, XMLNAME = "CITYCODE", XMLPROJECTION = "ATTRIBUTE") [ Required ]; /// –ö–æ–¥ –≤–Ω—É—Ç—Ä–∏–≥–æ—Ä–æ–¥—Å–∫–æ–≥–æ —Ä–∞–π–æ–Ω–∞ Property CTARCODE As %String(MAXLEN = 3, MINLEN = 3, XMLNAME = "CTARCODE", XMLPROJECTION = "ATTRIBUTE") [ Required ]; /// –ö–æ–¥ –Ω–∞—Å–µ–ª–µ–Ω–Ω–æ–≥–æ –ø—É–Ω–∫—Ç–∞ Property PLACECODE As %String(MAXLEN = 3, MINLEN = 3, XMLNAME = "PLACECODE", XMLPROJECTION = "ATTRIBUTE") [ Required ]; /// –ö–æ–¥ —ç–ª–µ–º–µ–Ω—Ç–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–æ—á–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã Property PLANCODE As %String(MAXLEN = 4, MINLEN = 4, XMLNAME = "PLANCODE", XMLPROJECTION = "ATTRIBUTE") [ Required ]; /// –ö–æ–¥ —É–ª–∏—Ü—ã Property STREETCODE As %String(MAXLEN = 4, MINLEN = 4, XMLNAME = "STREETCODE", XMLPROJECTION = "ATTRIBUTE"); /// –ö–æ–¥ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∞–¥—Ä–µ—Å–æ–æ–±—Ä–∞–∑—É—é—â–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ Property EXTRCODE As %String(MAXLEN = 4, MINLEN = 4, XMLNAME = "EXTRCODE", XMLPROJECTION = "ATTRIBUTE") [ Required ]; /// –ö–æ–¥ –ø–æ–¥—á–∏–Ω–µ–Ω–Ω–æ–≥–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∞–¥—Ä–µ—Å–æ–æ–±—Ä–∞–∑—É—é—â–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ Property SEXTCODE As %String(MAXLEN = 3, MINLEN = 3, XMLNAME = "SEXTCODE", XMLPROJECTION = "ATTRIBUTE") [ Required ]; /// –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ Property OFFNAME As %String(MAXLEN = 120, MINLEN = 1, XMLNAME = "OFFNAME", XMLPROJECTION = "ATTRIBUTE"); /// –ü–æ—á—Ç–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å Property POSTALCODE As %String(MAXLEN = 6, MINLEN = 6, XMLNAME = "POSTALCODE", XMLPROJECTION = "ATTRIBUTE"); /// –ö–æ–¥ –ò–§–ù–° –§–õ Property IFNSFL As %String(MAXLEN = 4, MINLEN = 4, XMLNAME = "IFNSFL", XMLPROJECTION = "ATTRIBUTE"); /// –ö–æ–¥ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∞–ª—å–Ω–æ–≥–æ —É—á–∞—Å—Ç–∫–∞ –ò–§–ù–° –§–õ Property TERRIFNSFL As %String(MAXLEN = 4, MINLEN = 4, XMLNAME = "TERRIFNSFL", XMLPROJECTION = "ATTRIBUTE"); /// –ö–æ–¥ –ò–§–ù–° –Æ–õ Property IFNSUL As %String(MAXLEN = 4, MINLEN = 4, XMLNAME = "IFNSUL", XMLPROJECTION = "ATTRIBUTE"); /// –ö–æ–¥ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∞–ª—å–Ω–æ–≥–æ —É—á–∞—Å—Ç–∫–∞ –ò–§–ù–° –Æ–õ Property TERRIFNSUL As %String(MAXLEN = 4, MINLEN = 4, XMLNAME = "TERRIFNSUL", XMLPROJECTION = "ATTRIBUTE"); /// OKATO Property OKATO As %String(MAXLEN = 11, MINLEN = 11, XMLNAME = "OKATO", XMLPROJECTION = "ATTRIBUTE"); /// OKTMO Property OKTMO As %String(MAXLEN = 11, MINLEN = 8, XMLNAME = "OKTMO", XMLPROJECTION = "ATTRIBUTE"); /// –î–∞—Ç–∞ –≤–Ω–µ—Å–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ Property UPDATEDATE As %Date(XMLNAME = "UPDATEDATE", XMLPROJECTION = "ATTRIBUTE") [ Required ]; /// –ö—Ä–∞—Ç–∫–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–∏–ø–∞ –æ–±—ä–µ–∫—Ç–∞ Property SHORTNAME As %String(MAXLEN = 10, MINLEN = 1, XMLNAME = "SHORTNAME", XMLPROJECTION = "ATTRIBUTE") [ Required ]; /// –£—Ä–æ–≤–µ–Ω—å –∞–¥—Ä–µ—Å–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ Property AOLEVEL As %Integer(XMLNAME = "AOLEVEL", XMLPROJECTION = "ATTRIBUTE", XMLTotalDigits = 10) [ Required ]; /// –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –æ–±—ä–µ–∫—Ç–∞ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ Property PARENTGUID As %String(MAXLEN = 36, MINLEN = 36, XMLNAME = "PARENTGUID", XMLPROJECTION = "ATTRIBUTE"); /// –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏. –ö–ª—é—á–µ–≤–æ–µ –ø–æ–ª–µ. Property AOID As %String(MAXLEN = 36, MINLEN = 36, XMLNAME = "AOID", XMLPROJECTION = "ATTRIBUTE") [ Required ]; /// –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏ —Å–≤—è–∑—ã–≤–∞–Ω–∏—è —Å –ø—Ä–µ–¥—ã–¥—É—à–µ–π –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–π –∑–∞–ø–∏—Å—å—é Property PREVID As %String(MAXLEN = 36, MINLEN = 36, XMLNAME = "PREVID", XMLPROJECTION = "ATTRIBUTE"); /// –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏ —Å–≤—è–∑—ã–≤–∞–Ω–∏—è —Å –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–π –∑–∞–ø–∏—Å—å—é Property NEXTID As %String(MAXLEN = 36, MINLEN = 36, XMLNAME = "NEXTID", XMLPROJECTION = "ATTRIBUTE"); /// –ö–æ–¥ –∞–¥—Ä–µ—Å–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π —Å –ø—Ä–∏–∑–Ω–∞–∫–æ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –∏–∑ –ö–õ–ê–î–† 4.0. Property CODE As %String(MAXLEN = 17, MINLEN = 0, XMLNAME = "CODE", XMLPROJECTION = "ATTRIBUTE"); /// –ö–æ–¥ –∞–¥—Ä–µ—Å–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –∏–∑ –ö–õ–ê–î–† 4.0 –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π –±–µ–∑ –ø—Ä–∏–∑–Ω–∞–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏—Ö –¥–≤—É—Ö —Ü–∏—Ñ—Ä) Property PLAINCODE As %String(MAXLEN = 15, MINLEN = 0, XMLNAME = "PLAINCODE", XMLPROJECTION = "ATTRIBUTE"); /// –°—Ç–∞—Ç—É—Å –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –∞–¥—Ä–µ—Å–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –§–ò–ê–°. –ê–∫—Ç—É–∞–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å –Ω–∞ —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É. –û–±—ã—á–Ω–æ –ø–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–ø–∏—Å—å –æ–± –∞–¥—Ä–µ—Å–Ω–æ–º –æ–±—ä–µ–∫—Ç–µ. /// 0 ‚Äì –ù–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π /// 1 - –ê–∫—Ç—É–∞–ª—å–Ω—ã–π Property ACTSTATUS As %Integer(XMLNAME = "ACTSTATUS", XMLPROJECTION = "ATTRIBUTE", XMLTotalDigits = 10) [ Required ]; /// –°—Ç–∞—Ç—É—Å —Ü–µ–Ω—Ç—Ä–∞ Property CENTSTATUS As %Integer(XMLNAME = "CENTSTATUS", XMLPROJECTION = "ATTRIBUTE", XMLTotalDigits = 10) [ Required ]; /// –°—Ç–∞—Ç—É—Å –¥–µ–π—Å—Ç–≤–∏—è –Ω–∞–¥ –∑–∞–ø–∏—Å—å—é ‚Äì –ø—Ä–∏—á–∏–Ω–∞ –ø–æ—è–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ (—Å–º. –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã OperationStatus): /// 01 ‚Äì –ò–Ω–∏—Ü–∏–∞—Ü–∏—è; /// 10 ‚Äì –î–æ–±–∞–≤–ª–µ–Ω–∏–µ; /// 20 ‚Äì –ò–∑–º–µ–Ω–µ–Ω–∏–µ; /// 21 ‚Äì –ì—Ä—É–ø–ø–æ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ; /// 30 ‚Äì –£–¥–∞–ª–µ–Ω–∏–µ; /// 31 - –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–ª–µ–¥—Å—Ç–≤–∏–µ —É–¥–∞–ª–µ–Ω–∏—è –≤—ã—à–µ—Å—Ç–æ—è—â–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞; /// 40 ‚Äì –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ (—Å–ª–∏—è–Ω–∏–µ); /// 41 ‚Äì –ü–µ—Ä–µ–ø–æ–¥—á–∏–Ω–µ–Ω–∏–µ –≤—Å–ª–µ–¥—Å—Ç–≤–∏–µ —Å–ª–∏—è–Ω–∏—è –≤—ã—à–µ—Å—Ç–æ—è—â–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞; /// 42 - –ü—Ä–µ–∫—Ä–∞—â–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –≤—Å–ª–µ–¥—Å—Ç–≤–∏–µ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –¥—Ä—É–≥–æ–º—É –∞–¥—Ä–µ—Å–Ω–æ–º—É –æ–±—ä–µ–∫—Ç—É; /// 43 - –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∞–¥—Ä–µ—Å–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ —Å–ª–∏—è–Ω–∏—è –∞–¥—Ä–µ—Å–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤; /// 50 ‚Äì –ü–µ—Ä–µ–ø–æ–¥—á–∏–Ω–µ–Ω–∏–µ; /// 51 ‚Äì –ü–µ—Ä–µ–ø–æ–¥—á–∏–Ω–µ–Ω–∏–µ –≤—Å–ª–µ–¥—Å—Ç–≤–∏–µ –ø–µ—Ä–µ–ø–æ–¥—á–∏–Ω–µ–Ω–∏—è –≤—ã—à–µ—Å—Ç–æ—è—â–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞; /// 60 ‚Äì –ü—Ä–µ–∫—Ä–∞—â–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –≤—Å–ª–µ–¥—Å—Ç–≤–∏–µ –¥—Ä–æ–±–ª–µ–Ω–∏—è; /// 61 ‚Äì –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∞–¥—Ä–µ—Å–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –¥—Ä–æ–±–ª–µ–Ω–∏—è Property OPERSTATUS As %Integer(XMLNAME = "OPERSTATUS", XMLPROJECTION = "ATTRIBUTE", XMLTotalDigits = 10) [ Required ]; /// –°—Ç–∞—Ç—É—Å –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –ö–õ–ê–î–† 4 (–ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–≤–µ —Ü–∏—Ñ—Ä—ã –≤ –∫–æ–¥–µ) Property CURRSTATUS As %Integer(XMLNAME = "CURRSTATUS", XMLPROJECTION = "ATTRIBUTE", XMLTotalDigits = 10) [ Required ]; /// –ù–∞—á–∞–ª–æ –¥–µ–π—Å—Ç–≤–∏—è –∑–∞–ø–∏—Å–∏ Property STARTDATE As %Date(XMLNAME = "STARTDATE", XMLPROJECTION = "ATTRIBUTE") [ Required ]; /// –û–∫–æ–Ω—á–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –∑–∞–ø–∏—Å–∏ Property ENDDATE As %Date(XMLNAME = "ENDDATE", XMLPROJECTION = "ATTRIBUTE") [ Required ]; /// –í–Ω–µ—à–Ω–∏–π –∫–ª—é—á –Ω–∞ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç Property NORMDOC As %String(MAXLEN = 36, MINLEN = 36, XMLNAME = "NORMDOC", XMLPROJECTION = "ATTRIBUTE"); /// –ü—Ä–∏–∑–Ω–∞–∫ –¥–µ–π—Å—Ç–≤—É—é—â–µ–≥–æ –∞–¥—Ä–µ—Å–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ Property LIVESTATUS As %xsd.byte(VALUELIST = ",0,1", XMLNAME = "LIVESTATUS", XMLPROJECTION = "ATTRIBUTE") [ Required ]; /// –¢–∏–ø –∞–¥—Ä–µ—Å–∞—Ü–∏–∏: /// 0 - –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ /// 1 - –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–π; /// 2 - –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ-—Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∞–ª—å–Ω—ã–π Property DIVTYPE As %xsd.int(VALUELIST = ",0,1,2", XMLNAME = "DIVTYPE", XMLPROJECTION = "ATTRIBUTE") [ Required ]; Relationship AddressObjects As Test.AddressObjects(XMLPROJECTION = "NONE") [ Cardinality = one, Inverse = Object ]; }</code> </pre> <br></div></div><br>  Of the entire list of xml files in FIAS, we will only use the file with the names of regions, cities and streets.  At the time of preparation of the publication I had this: <br>  AS_ADDROBJ_20190106_90809714-fe22-45b2-929c-52bd950963e0.XML <br><br>  The file size is neither more nor less, but almost 3 GB.  You can‚Äôt open it with ordinary text-processing tools - they don‚Äôt digest that size. <br><blockquote>  By the way, the maximum length of a string literal (type String) in InterSystems IRIS is no more than 3,641,144 characters.  That is, uploading a file or URL directly to it will not work.  Other restrictions can be <a href="">peeped in the documentation</a> .  To work with large amounts of data you can use streams of data that do not have such a length limit. </blockquote>  Let's see what we get? <br><br>  Preparing FIAS stuffed peppers.  This is only a blank for a great future.  First we get the initial minimum set.  We need only these ingredients: <br><br><pre> <code class="plaintext hljs">Class FIAS.AddressObject Extends (%Persistent, %XML.Adaptor) [ ProcedureBlock ] { Parameter XMLNAME = "Object"; Parameter XMLSEQUENCE = 1; /// –ì–ª–æ–±–∞–ª—å–Ω—ã–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∞–¥—Ä–µ—Å–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ Property AOGUID As %String(MAXLEN = 36, MINLEN = 36, XMLNAME = "AOGUID", XMLPROJECTION = "ATTRIBUTE") [ Required ]; /// –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ Property OFFNAME As %String(MAXLEN = 120, MINLEN = 1, XMLNAME = "OFFNAME", XMLPROJECTION = "ATTRIBUTE"); /// –ü–æ—á—Ç–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å Property POSTALCODE As %String(MAXLEN = 6, MINLEN = 6, XMLNAME = "POSTALCODE", XMLPROJECTION = "ATTRIBUTE"); /// –ö—Ä–∞—Ç–∫–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–∏–ø–∞ –æ–±—ä–µ–∫—Ç–∞ Property SHORTNAME As %String(MAXLEN = 10, MINLEN = 1, XMLNAME = "SHORTNAME", XMLPROJECTION = "ATTRIBUTE") [ Required ]; /// –£—Ä–æ–≤–µ–Ω—å –∞–¥—Ä–µ—Å–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ Property AOLEVEL As %Integer(XMLNAME = "AOLEVEL", XMLPROJECTION = "ATTRIBUTE", XMLTotalDigits = 10) [ Required ]; /// –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –æ–±—ä–µ–∫—Ç–∞ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ Property PARENTGUID As %String(MAXLEN = 36, MINLEN = 36, XMLNAME = "PARENTGUID", XMLPROJECTION = "ATTRIBUTE"); /// –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏. –ö–ª—é—á–µ–≤–æ–µ –ø–æ–ª–µ. Property AOID As %String(MAXLEN = 36, MINLEN = 36, XMLNAME = "AOID", XMLPROJECTION = "ATTRIBUTE") [ Required ];</code> </pre><br>  Next, do <a href="https://docs.intersystems.com/irislatest/csp/docbook/DocBook.UI.Page.cls?KEY=GXML_import#GXML_import_">the writing</a> .  Create an object that understands XML as native - use the class from the% XML.Reader system library: <br><br><pre> <code class="plaintext hljs">set reader = ##class(%XML.Reader).%New()</code> </pre> <br>  And we instruct him who to take, and ignore the rest.  We will take one portion: <br><br><pre> <code class="plaintext hljs">do reader.Correlate("Object","FIAS.AddressObject")</code> </pre> <br>  Then there are variations on how to get the original mbd file.  If convenient, you can put it next to the storage - locally in the file system of the IRIS server.  Or, as in my example, ask to send via HTTP.  There is an even more universal option, which will be a few words below. <br><br><pre> <code class="plaintext hljs">set url="http://localhost/AS_ADDROBJ_20190106_90809714-fe22-45b2-929c-52bd950963e0.XML" write reader.OpenUrl(url)</code> </pre> <br><blockquote>  Important!  At this moment, the majority who will pass this example on themselves, there will be a terrible.  The system will return instead of the joyful "1" (everything is in order), something starting with "0 ¬∏ STORE ...".  And it will not please.  That is, the file with what seems to be a mcbd turned out to be not quite micro and does not fit into our object.  The memory allocated for it was not enough.  Solvable?  Of course.  The IRIS data platform allows you to create objects up to 4 TB in RAM.  Then what went wrong?  By default, the system settings are set to 256 MB per object.  And we need much more.  And remember, these are RAM requirements.  Is there enough stock on your computer / server? </blockquote>  What size of memory for the placement of this giant we need to install empirically - almost 10 GB.  What you need to specify in the settings (Menu&gt; Configure Memory&gt; Maximum memory capacity per process (KB)) or through the <a href="">$ ZSTORAGE system variable</a> (in kilobytes): <br><br><pre> <code class="plaintext hljs">set $ZSTORAGE=10000000</code> </pre> <br>  Have you launched a new process with the necessary memory settings?  Then everything is simple further - we read and save. <br><br>  There is also an alternative (and, probably, preferred) option - to <a href="">use the UsePPGHandler property</a> of the% XML.Reader class which allows you not to store XML in memory and works with standard memory settings. <br><br><pre> <code class="plaintext hljs">set reader = ##class(%XML.Reader).%New() set reader.UsePPGHandler = 1</code> </pre> <br>  more ... Correlate / Read, etc.  ... <br><br><pre> <code class="plaintext hljs">do reader.Next(.object) do object.%Save()</code> </pre> <br>  And so 3,722,548 times for each operation :-) <br><br>  It is tiring.  Therefore, let's add our method FIAS.AddressObject to import, based on the commands just shown: <br><br><pre> <code class="plaintext hljs">ClassMethod Import() { // –°–æ–∑–¥–∞—Ç—å –æ–±—ä–µ–∫—Ç –¥–ª—è —á—Ç–µ–Ω–∏—è XML Set reader = ##class(%XML.Reader).%New() // –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–π XML –¥–ª—è —Ä–∞–∑–±–æ—Ä–∞ Set status = reader.OpenURL("http://localhost/AS_ADDROBJ_20190106_90809714-fe22-45b2-929c-52bd950963e0.XML") If $$$ISERR(status) {Do $System.Status.DisplayError(status)} // –°–≤—è–∑–∞—Ç—å –æ–±—ä–µ–∫—Ç —Å –Ω—É–∂–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –≤—ã–±–æ—Ä–∫–∏ Do reader.Correlate("Object","FIAS.AddressObject") // –ß–∏—Ç–∞—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –æ–±—ä–µ–∫—Ç –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ While (reader.Next(.object,.status)) { Set status = object.%Save() If $$$ISERR(status) {do $System.Status.DisplayError(status)} } // –í —Å–ª—É—á–∞–µ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è –æ—à–∏–±–∫–∏ –ø—Ä–∏ —Ä–∞–∑–±–æ—Ä–µ, –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ If $$$ISERR(status) {Do $System.Status.DisplayError(status)} }</code> </pre> <br>  Let's use the power of our computer exocortex - just one command <a href="https://intersystems-community.github.io/webterminal/">in the terminal</a> : <br><br><pre> <code class="plaintext hljs">do ##class(FIAS.AddressObject).Import()</code> </pre> <br><img src="https://habrastorage.org/webt/bd/mh/t7/bdmht7k0urpyo07qcdcmkj5_nym.gif"><br><br>  I ask everyone to the table.  There were mkbd, and now the finished dish in the form of a global with verified names of Russian cities and weights is ready. <br><br><img src="https://habrastorage.org/webt/1u/he/a6/1uhea6bdexgrpwlfpmtn2b2gdyy.png"><br><br>  Finally, a couple words about when 4TB is not enough.  In this case, <a href="">we follow the streams</a> (or streams, if you like).  The documentation is all laid out on the shelves.  It is possible binary, it is possible character.  Store in the global is also not forbidden.  The recipe is as follows: we take the stream, cut it in parts and give it to the objects we need for consumption. <br><br>  Further, about beautiful address ObjectScript objects and API on Python did not fit.  There will be a separate story. <br><blockquote>  Nice: Gartner has just completed the annual collection of real user ratings and feedback in the DBMS category and, on this basis, published his ranking of the best DBMSs of 2019.  Products InterSystems Cach√© and InterSystems IRIS Data Platform received the highest rating "Consumer Choice."  From whom you have chosen and how you rated it, <a href="https://www.gartner.com/reviews/customers-choice/operational-dbms/Jan-2019">you can have a look at it yourself</a> . </blockquote>  Best Operational Database Management Systems of 2019 Reviewed by Customers <br><br><img src="https://habrastorage.org/webt/gw/jg/dd/gwjgdd1segqlvnnpfzgo9buww4y.png"></div><p>Source: <a href="https://habr.com/ru/post/438062/">https://habr.com/ru/post/438062/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>