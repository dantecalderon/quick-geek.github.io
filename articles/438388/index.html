<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Push message server</title>
  <meta name="description" content="In any modern Internet service, you can select only two main functions: 



- The first is user authorization. 
- The second is the instant dispatch o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>Push message server</h1><div class="post__text post__text-html js-mediator-article">  In any modern Internet service, you can select only two main functions: <br><br><ul><li>  The first is user authorization. </li><li>  The second is the instant dispatch of a certain event from the server to the client. </li></ul><br>  The first point, I think, does not need an explanation. <br><br>  The second point is client server technology, but vice versa.  The client does not periodically make a request to the server - are there any new messages.  The server, when a certain event occurs, immediately sends a message to the client. <br><br>  For better understanding, the service is not spherical in vacuum.  Service can be represented as: <br><br><ul><li>  Folder with files in the cloud.  Information about the change, addition and deletion is sent to other users or the current user, but to other devices. </li><li>  A computer program for reading server logs, when ‚Äúerror‚Äù records appear, sending the contents of a record to a user on a mobile phone. </li><li>  Video peephole (camera), taking pictures when moving near the door of the apartment. </li><li>  Service receiving telemetry from the android-auto application. </li><li>  Similar to the previous item service, allowing you to know whether the child reached the school or came home from school. </li></ul><br>  The list can be expanded to infinity, given, as an example, only the most well-known use cases. <br><br>  Almost all of the examples of services can be represented as a "messenger".  Some of the examples were described exactly like this, I saw articles on how to connect a camera and send pictures to one well-known messenger. <br><br>  Not so long ago there was an article that the service of cameras in the door eyes, instead of artificial intelligence was observed by strangers.  I will not focus on free services from large "good" corporations.  As they say in the famous proverb ‚ÄúFree cheese is in a mousetrap‚Äù and guided by another proverb ‚ÄúYour shirt is closer to the body‚Äù, your ‚Äúservice‚Äù is better. <br><br>  <a href="https://github.com/PloAl/push0k">The server script code is open and free.</a> <br><br><img src="https://habrastorage.org/webt/wx/2d/a4/wx2da4acw9c3g_x0a_mxj8dukju.png"><br><a name="habracut"></a><br>  To implement, I chose socket.io postgreSQL node.js, implemented the first version more than two years ago, and the service was closely related to 1c <a href="https://infostart.ru/public/545047/">https://infostart.ru/public/545047/</a> , they had never announced an interaction server anywhere.  But it was a long time ago, at the moment, the server part is not connected in any way with the mentioned program, the client part can be integrated in the form of external processing or extension. <br><br>  The name has chosen meaningful - "push0k".  The first part is taken from the phrase ‚Äúpush messages‚Äù, the second well-known English is okay abbreviated, but written through zero for greater significance. <br><br>  In this case, this is not a ‚Äúfree cheese in a mousetrap‚Äù, since it requires a windows computer, linux, macOS (server) to work through the Internet, an external ip address is needed, possibly forward.  Preferably the domain name associated with the external ip address.  Also, it is desirable, but not necessary, not a self-signed certificate associated with the domain name. <br><br>  There are no requirements for hardware as such; it can work on a home nas where there is a docker.  Docker in nas means x86-64 architecture, and postgreSQL in such nas without docker cannot be installed.  The exact understanding of how many clients such a server can support depends on the tasks ‚Äî the logic of the service and the traffic that is transmitted between clients. <br><br><h4>  Server Description: </h4><br>  The server uses additional modules: <br><br><ul><li>  socket.io - the module adds a websocket protocol with additional mass.  opportunities. </li><li>  node-postgres is a module for communicating with the postgreSQL database server. </li><li>  pm2 - module for running multiple server processes with a load balancer. </li></ul><br><h4>  Server files: </h4><br><ul><li>  starter.js - http (s) service, you can tell the server admin panel.  Through this service, the settings are changed and the processes of the main websocket server are started. </li><li>  push0k.js is the main websocket server. </li><li>  starter_cfg.js - server administrative script settings.  Connect to postgreSQL and files for https connection.  Files for https connections, as well as the domain name, may differ from the main server, for greater security.  Manually changed when first started. </li><li>  config.js - the basic settings of the entire server. </li><li>  package.js - file description version author needed modules for work. </li><li>  push0kStructure.sql - file description of the postgreSQL database for initial initialization, empty database. </li></ul><br><h4>  Installation: </h4><br>  1. Initially you need to install node.js <a href="https://nodejs.org/en/download/">nodejs.org/en/download</a> <br><br>  2. PostgreSQL should also be installed on the computer of the local network or the same <a href="https://postgrespro.ru/products/download">postgrespro.ru/products/download</a> <br><br>  On the postgreSQL server, you need to execute the file ‚Äúpush0kStructure.sql‚Äù or almost all of the queries from this file to create a database with the necessary tables. <br><br>  3. Download the first five server files, except push0kStructure.sql, to any computer directory. <br><br>  4. Edit the ‚Äústarter_cfg.js‚Äù file in any text editor.  It is important to specify the parameters for connecting to the postgreSQL server and set the port to connect to the administrative part of the server push0k. <br><br>  5. Start the terminal (console) and use the ‚Äúcd / path / of your / directory /‚Äù command to go to the server files directory.  The path specified in the terminal command must be from point 3. <br><br>  6. Run the command in the terminal ‚Äúnpm install‚Äù to install additional modules. <br>  Run the command in the node nodeterter.js terminal to start the administration service. <br><br>  7. Download and install the program push0k admin.  In "push0k admin", the basic websocket parameters, the server port, the number of processes and many others are configured.  You can control the start and stop of server processes, create and manage users and their rooms (groups). <br><br><h4>  Push0k admin application </h4><br><img src="https://habrastorage.org/webt/fk/fo/go/fkfogovxziochbj901ouycltfjq.png"><br><br>  The application is made on electron using vue.js.  Inside there is a similarity of the window system, small modal dialogs can be dragged as windows, windows headers for windows are made similar to windows 10, for Mac OS as in recent versions, but without taking into account the dark theme.  For linux I will compile later, there is a bit more difficult with the dialog headers, I think it will be like in ubuntu and, if not ubuntu, then win 10 style.  Memory consumption in win 10 and Mac OS more than 150 megabytes did not see. <br><br>  In previous versions it was not possible to add animation, did a little without fanaticism.  The previously described dialogs - windows appear from the center of the application window, gradually increasing, when closing they fly off to the center, decreasing.  Pressing buttons and required fields are also animated. <br><br><img src="https://habrastorage.org/webt/rn/ts/vr/rntsvrtjjhvvsnpu6vf_oyguwou.gif"><br><br>  When implementing, there was a great desire to make a dark theme, but since there was still no light theme, I had to be content with just the button panel on the right.  In Mac OS, this single dark part has the effect of ‚Äúvibrancy‚Äù, that is, it is partially transparent, similar to most windows of the standard interface.  Unfortunately, in Windows, a similar effect called fluent design could not be made because there is no electron-like functionality for Windows. <br><br>  As previously mentioned, the http and ws (websocket) protocols are used for control.  It is possible to use secure connections https and wss.  With secure connections, you can see the data of the certificates used.  Similarly, browsers use the ‚ÄúLock‚Äù icon - the connection is safe, ‚ÄúOpen lock‚Äù - the connection is unsafe.  And without icons, respectively - a secure connection is not used. <br><br><img src="https://habrastorage.org/webt/xz/mt/ew/xzmtew2kpyuhppeugz2fth2lxvm.png"><br><br><h4>  Common logic </h4><br>  I've never seen this kind of application.  When developing, I was guided by the fact that I myself would be interested in monitoring and what parameters to see in statistics. <br><br>  For example, in the connection table for each connection there is data ‚Äúconnection time‚Äù, ‚Äúauthorization time‚Äù, ‚Äúsynchronization time‚Äù.  First, it allows you to understand how quickly the ‚Äúws: //‚Äù connection or the secure ‚Äúwss: //‚Äù connection is established.  The second is that after the connection, a message with the authorization data is sent separately; during authorization, the user is prompted to verify the user and verify the password hash unique for each connection.  The third is the time for receiving new messages and new or updated reference data.  Also, versions of node.js, socket.io, and other described data as a whole allow to understand how the update of a node.js or a separate module influenced the speed, or some server refinement could affect. <br><br><img src="https://habrastorage.org/webt/xs/_h/ak/xs_haktlpy5r-gb_6ktxpf9_osa.png"><br><br>  In the example above, only a small portion of such data is described.  Also, in a separate table, time, size and speed of MB / s are saved.  Download sync data.  The same table stores the data of downloading attachment files to the server and downloading this data from the server. <br><br>  The time for calculating the speed is calculated on the client or server, depending on the situation.  It is impossible to use time and server and client as it cannot be perfectly synchronized.  This imposes a small lag of about the size of the ping (delivery confirmation) between the client and the server.  When uploading or downloading large files, the described lag is irrelevant. <br><br>  In the connection table, you can see the closed connection with the data "transferred bytes", "received bytes" and "size" of the synchronization data more than "transferred bytes".  When synchronizing data, the socket.io automatic compression is used; when downloading or downloading attachments, automatic compression is disabled, as often compressing an already compressed negatively affects the speed. <br><br>  As it was written at the beginning of the article, it was never the goal to make one common service and connect as many users as possible to it.  But it was always interesting how many users there could theoretically be and how much the server could handle. <br><br>  For this, I made a simple test: Online clients of a certain room (group), a message is sent with test parameters (there are only one main parameter in the parameters - the number of messages), which each client will send to other clients online.  After the test distribution, the total time of all messages, notifications, records in postgresql tables, the number of all messages, notifications and records is calculated, and accordingly, the speed is calculated, including the total of all operations on the server. <br><br><img src="https://habrastorage.org/webt/mj/ir/eo/mjireosal4qxzjintjlz4rddhao.png"><br><br>  <i>Example from the screenshot:</i> <i><br><br></i>  <i>Most surprisingly, only 10,000 messages and 390,000 gestures,</i> <i><br></i>  <i>sending 50,000 messages: Server processes: 4 Users: 3</i> <i><br></i>  <i>Total messages received 10,000 * 3 = 30,000</i> <i><br></i>  <i>Transfer to other server processes 30,000 * Server processes: 4 - 1 = 90,000</i> <i><br></i>  <i>Sent to 30,000 * Users: 3 - 1 = 60,000</i> <i><br></i>  <i>Recorded messages in the postgreSQL table 30 000</i> <i><br></i>  <i>90,000 delivery notifications received</i> <i><br></i>  <i>Written to postgreSQL table delivery notifications 90,000</i> <i><br></i>  <i>All operations 390,000</i> <br><br><h4>  Data logic in push0k admin </h4><br>  With each connection, all reference data is obtained: users, rooms, devices, databases, as well as the last 300 "log-statistical" entries: Connections, Data Synchronization, Forwarding Attachments, Messages, Log. <br><br>  Messages practically repeat the postgresql table and do not have filters, settings and a form where you can see the message completely.  The logic of the table is debugging, it is possible to quickly look at the development whether the message reached the table or not. <br><br><img src="https://habrastorage.org/webt/6y/ra/gj/6yragjyt0ycnvzmiy8cvbspfpsc.png"><br><br>  The "Users", "Rooms (groups)", "Connections" and "Log" tables are updated automatically.  For the rest of the data does not make sense in the online update. <br><br>  The push0k admin application can be downloaded here: <br><br>  Windows: <a href="https://yadi.sk/d/Jw675Octd4w3DA">push0kadmin Setup 19.1.11.exe</a> <br>  Mac OS: <a href="https://yadi.sk/d/q8EsRIm-FxL_Ww">push0kadmin-19.1.11.dmg</a> <br><br>  It is free, but unlike the server, I don‚Äôt plan to open the source code. <br><br>  In the next article I will describe the client part of the push0k desctop client, as well as a small example, the code and how to connect, log in and get data from the server. <br><br>  For the previously mentioned earlier versions, there was also an android client, immortally living in the background on 7th and 8th versions of android.  But he still, I think not long behind.  Later, I think, there will be a third article with the android client, and then you look close to iOS. </div><p>Source: <a href="https://habr.com/ru/post/438388/">https://habr.com/ru/post/438388/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>