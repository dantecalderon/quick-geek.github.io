<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>DNS proxy on Node.JS do it yourself</title>
  <meta name="description" content="The package has bumped over the bumps into the far forest behind the DNS ... 
 L. Kaganov "Hamlet at the bottom" 

 When developing a network applicat...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>DNS proxy on Node.JS do it yourself</h1><div class="post__text post__text-html js-mediator-article"><blockquote>  The package has bumped over the bumps into the far forest behind the DNS ... <br>  <em>L. Kaganov "Hamlet at the bottom"</em> </blockquote><p>  When developing a network application, it is sometimes necessary to launch it locally, but to access it by the real domain name.  The standard proven solution is to register a domain in the hosts file.  The disadvantage of the approach is that hosts require a strict correspondence of domain names, i.e.  does not support asterisks.  Those.  if there are domains like: </p><br><pre><code class="plaintext hljs">dom1.example.com, dom2.example.com, dom3.example.com, ................ domN.example.com,</code> </pre> <br><p>  then you need to register them in hosts.  In some cases, the third level domain is not known in advance.  There is a desire (I write for myself, someone might say that it‚Äôs okay to do so) to do with a line like this: </p><br><pre> <code class="plaintext hljs">*.example.com</code> </pre> <br><p>  The solution may be to install a local DNS server that will process requests according to the specified logic.  Such servers are, and quite free, and with a convenient graphical interface.  You can put and not bother.  But this article describes another way - writing your own bicycle DNS-proxy that will listen for incoming DNS-requests, and if the requested domain name is in the list, it will return the specified IP, and if not, it will request the upstream DNS server and forward the received response unchanged requesting program. </p><a name="habracut"></a><br><p>  At the same time, you can log requests and responses to them.  Since DNS is needed by everyone - browsers, and messengers, and antivirus programs, and operating system services, etc., it can be quite informative. </p><br><p>  The principle is simple.  In the network connection settings for IPv4, we change the address of the DNS server to the address of the machine with our running samopisny DNS proxy (127.0.0.1 if we are not working over the network), and in its settings we specify the address of the upstream DNS server.  And, like, everything! </p><br><p>  We will not use the standard functions of domain name resolution <em>nslookup</em> and <em>nsresolve</em> , so the system DNS settings and the contents of the <em>hosts file</em> will not affect the operation of the program.  Depending on the situation, it may be useful or not, you just need to remember this.  For simplicity, we restrict ourselves to the implementation of the most basic functionality: </p><br><ul><li>  IP spoofing only for type A (host address) and IN (internet) class records </li><li>  version 4 IP spoofed addresses only </li><li>  connection for local incoming requests via UDP only </li><li>  connection to the upstream DNS server via UDP or TLS </li><li>  if there are several network interfaces, incoming local requests will be received on any of them </li><li>  no EDNS support </li></ul><br><div class="spoiler">  <b class="spoiler_title">Speaking of tests</b> <div class="spoiler_text"><p>  There are few unit tests in the project.  True, they work according to the principle: launched, and if something imputed is displayed in the console, then everything is fine, and if an exception crashes, then there is a problem.  But even such a clumsy approach allows you to successfully localize the problem, therefore Unit. </p></div></div><br><h2 id="nachalo--server-na-53-m-portu">  Start - server on port 53 </h2><br><p>  Let's get started  The first step is to teach the application to accept incoming DNS requests.  We write a simple TCP server that simply listens to port 53 and logs incoming connections.  In the properties of a network connection, we register the address of the DNS server 127.0.0.1, launch the application, go to the browser for several pages - and ... silence in the console, the browser displays the pages normally.  Well, we change TCP to UDP, we start, we go by the browser - in the browser a connection error, in the console any binary data fell down.  So, the system sends requests via UDP, and we will listen to incoming connections via UDP on port 53.  Half an hour of work, of which 15 minutes google how to raise the TCP and UDP server on NodeJS - and we have solved the key task of the project, which determines the structure of the future application.  The code is: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> dgram = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'dgram'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> server = dgram.createSocket(<span class="hljs-string"><span class="hljs-string">'udp4'</span></span>); <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">function</span></span></span></span><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="hljs-function">) { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">server</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">on</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'error'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, (err</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">`server error:\n</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${err.stack}</span></span></span><span class="hljs-string">`</span></span>); server.close(); }); server.on(<span class="hljs-string"><span class="hljs-string">'message'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> (localReq, linfo) =&gt; { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(localReq); <span class="hljs-comment"><span class="hljs-comment">// –ó–¥–µ—Å—å –ø–æ—Ç–æ–º –±—É–¥–µ–º —Å–ª—É—à–∞—Ç—å –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –≤—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã –æ—Ç –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ }); server.on('listening', () =&gt; { const address = server.address(); console.log(`server listening ${address.address}:${address.port}`); }); const localListenPort = 53; const localListenAddress = 'localhost'; server.bind(localListenPort, localListenAddress); // server listening 0.0.0.0:53 }());</span></span></code> </pre> <br><p>  <em>Listing 1. The minimum code needed to receive local DNS queries</em> </p><br><p>  The next item is to read the received message in order to understand whether it is necessary to return our IP in response to it, or simply to transfer it further. </p><br><h2 id="dns-soobschenie">  DNS message </h2><br><p>  The structure of a DNS message is described in RFC-1035.  Both requests and replies follow this structure, and in principle they differ in a single bit flag (QR field) in the message header.  The message includes five sections: </p><br><pre> <code class="plaintext hljs">+---------------------+ | Header | +---------------------+ | Question | the question for the name server +---------------------+ | Answer | RRs answering the question +---------------------+ | Authority | RRs pointing toward an authority +---------------------+ | Additional | RRs holding additional information +---------------------+</code> </pre> <br><p>  <em>The general structure of the DNS message (s) <a href="https://tools.ietf.org/html/rfc1035">https://tools.ietf.org/html/rfc1035#section-4.1</a></em> </p><br><p>  A DNS message starts with a fixed-length header (this is the so-called <em>Header</em> section), which contains fields from 1 bit to two bytes in length (thus, one byte in the header can contain several fields).  The header starts with the ID field - this is a 16-bit request identifier, the response must have the same ID.  This is followed by fields describing the type of request, the result of its execution and the number of records in each of the subsequent sections of the message.  To describe them all for a long time, so whoever is interested is the well-known RFC: <a href="https://tools.ietf.org/html/rfc1035">https://tools.ietf.org/html/rfc1035#section-4.1.1</a> .  The <em>Header</em> section is always present in the DNS message. </p><br><pre> <code class="plaintext hljs"> 1 1 1 1 1 1 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+ | ID | +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+ |QR| Opcode |AA|TC|RD|RA| Z | RCODE | +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+ | QDCOUNT | +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+ | ANCOUNT | +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+ | NSCOUNT | +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+ | ARCOUNT | +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+</code> </pre> <br><p>  <em>DNS message header structure (s) <a href="https://tools.ietf.org/html/rfc1035">https://tools.ietf.org/html/rfc1035#section-4.1.1</a></em> </p><br><h3 id="sekciya-question">  Question Section </h3><br><p>  The <em>Question</em> section contains a record telling the server exactly what information is needed from it.  Theoretically, in the section of such records there can be one or several, their number is indicated in the QDCOUNT field in the message header, and can be 0, 1 or more.  But in practice, the Question section can contain only one entry.  If the <em>Question</em> section contained several entries, and one of them would lead to an error when processing the request on the server, an uncertain situation would arise.  Although the server will return an error code in the RCODE field in the response message, it will not be able to indicate which particular problem occurred during the processing, the specification does not describe this.  Records also do not have fields containing an indication of the error and its type.  Therefore, there is an agreement (undocumented), according to which the <em>Question</em> section can contain only one record, and the QDCOUNT field is set to 1. It is also not entirely clear how to process a request on the server side if it does contain several records in the <em>Question</em> .  Someone advises to return a message with an error request.  And, for example, Google DNS processes only the first record in the <em>Question</em> section, the others simply ignore it.  Apparently, this remains at the discretion of the developers of DNS services. </p><br><p>  In the response DNS message from the server, the <em>Question</em> section is also present and must completely copy the <em>Question</em> request (in order to avoid collisions, in case one ID field is not enough). </p><br><p>  The only entry in the <em>Question</em> section contains the fields: QNAME (domain name), QTYPE (type), QCLASS (class).  QTYPE and QCLASS are two-byte numbers denoting the type and class of the request.  Possible types and classes are described in RFC-1035 <a href="https://tools.ietf.org/html/rfc1035">https://tools.ietf.org/html/rfc1035#section-3.2</a> , everything is clear.  But on the way of recording a domain name, we will dwell in more detail in the section "Domain Name Record Format". </p><br><p>  In the case of a query, the DNS message most often ends with the <em>Question</em> section, sometimes it can be followed by the <em>Additional</em> section. </p><br><p>  If an error occurred while processing the request on the server (for example, an incoming request was formed incorrectly), the response message will also end with the <em>Question</em> or <em>Additional</em> section, and the RCODE field of the response message header will contain an error code. </p><br><h3 id="sekcii-answer-authority-i-additional">  Section <em>Answer</em> , <em>Authority</em> and <em>Additional</em> </h3><br><p>  The following sections are <em>Answer</em> , <em>Authority</em> and <em>Additional</em> ( <em>Answer</em> and <em>Authority</em> are contained only in the reply DNS message, <em>Additional</em> may be found in the request and in the answer).  They are optional, i.e.  any of them may or may not be present, depending on the incoming request.  These sections have the same structure and contain information in the format of so-called "resource records" ( <em>resourse record</em> , or RR).  Figuratively speaking, each of these sections is an array of resource records, and a record is an object with fields.  Each section can contain one or several records, their number is indicated in the corresponding field in the message header (ANCOUNT, NSCOUNT, ARCOUNT, respectively).  For example, an IP request for the "google.com" domain will return several IP addresses, so there will also be several entries in the <em>Answer</em> section, one for each address.  If there is no section, then the corresponding header field contains 0. </p><br><p>  Each <em>resource record</em> (RR) begins with the NAME field containing the domain name.  The format of this field repeats the format of the QNAME field of the <em>Question</em> section. <br>  Next to NAME are the TYPE (record type), and CLASS (its class) fields, both fields are 16-bit numeric, indicating the type and class of the record.  This also resembles the <em>Question</em> section, with the difference that its QTYPE and QCLASS can have all the same values ‚Äã‚Äãas TYPE and CLASS, and some more of their own, unique to them.  That is, to put it in a dry scientific language, the set of QTYPE and QCLASS values ‚Äã‚Äãis a superset of the TYPE and CLASS values.  Learn more about the differences in <a href="https://tools.ietf.org/html/rfc1035">https://tools.ietf.org/html/rfc1035#section-3.2.2</a> . <br>  Remaining fields: </p><br><ul><li>  TTL is a 32-bit number indicating the time the record is relevant (in seconds). </li><li>  RDLENGTH is a 16-bit number indicating the length of the next RDATA field in bytes. </li><li>  RDATA is the actual payload, the format depends on the type of recording.  For example, for an A (host address) and IN (Internet) class entry, this is 4 bytes, representing an IPv4 address. </li></ul><br><h2 id="format-zapisi-domennyh-imyon">  Domain Name Record Format </h2><br><p>  The format of a domain name record is the same for the QNAME and NAME fields, as well as for the RDATA field, if it is a CNAME, MX, NS class record or another one that assumes a domain name as a result. </p><br><p>  A domain name is a sequence of labels (name sections, subdomains - in the original this <strong>label</strong> , I did not find a better translation).  A label is a single byte of length, containing a number - the length of the contents of the label in bytes, followed by a sequence of bytes of the specified length.  The labels follow one another until a length byte containing 0 is encountered. The very first label can immediately have a zero length, which means the root domain (Root Domain) with an empty domain name (sometimes written as ""). </p><br><p>  In earlier versions, the DNS bytes in the label could have any value from (from 0 to 255).  There were rules that had the character of a strong recommendation: that the label should begin with a letter, end with a letter or a number, and contain only letters, numbers or a hyphen in 7-bit ASCII, with a zero significant bit.  The current EDNS specification already requires you to follow these rules clearly, without deviations. </p><br><p>  The two high bits of the length byte are used as a label type attribute.  If they are zero ( <em>0b00xxxxxx</em> ), then this is a common label, and the remaining bits of the length byte indicate the number of bytes of the data included in it.  The maximum mark length is 63 characters.  63 in binary encoding is just <em>0b00111111</em> . </p><br><p>  If the two most significant bits are 0 and 1, respectively ( <em>0b01xxxxxx</em> ), then this is an extended type label of the EDNS standard ( <a href="https://tools.ietf.org/html/rfc2671">https://tools.ietf.org/html/rfc2671#section-3.1</a> ), which came to us from February 1, 2019.  The lower six bits will contain the value of the label.  In this article EDNS we do not consider, but it is useful to know that this also happens. </p><br><p>  The combination of the two most significant bits, 1 and 0 ( <em>0b10xxxxxx</em> ), is reserved for future use. </p><br><p>  If both high-order bits are equal to 1 ( <em>0b11xxxxxx</em> ), this means that <em>compression of</em> domain names is used, and we will dwell on this in more detail. </p><br><h3 id="szhatie-domennyh-imyon">  Domain Name Compression </h3><br><p>  So, if a byte of length two high bits are 1 ( <em>0b11xxxxxx</em> ), this is a sign of the compression of the domain name.  Compression is used to make messages shorter and more capacious.  This is especially true when working on UDP, when the total length of a DNS message is limited to 512 bytes (although this is the old standard, see <em><a href="https://tools.ietf.org/html/rfc1035">https://tools.ietf.org/html/rfc1035#section-2.3.4</a> Size limits</em> , new EDNS allows you to send messages using the UPD protocol (longer).  The essence of the process is such that if there are domain names with the same top-level subdomains in a DNS message (for example, <em>mail.yandex.ru</em> and <em>yandex.ru</em> ), instead of re-indicating the entire domain name, the byte number in the DNS message is indicated, from which should continue reading the domain name.  This can be any byte of the DNS message, not only in the current record or section, but with the proviso that it is a byte of the length of the domain label.  Refer to the middle of the label can not be.  Suppose there is a domain <em>mail.yandex.ru</em> in the message, with the help of compression it is possible to also denote the domains <em>yandex.ru</em> , <em>ru</em> and root "" (of course, it is easier to write the root without compression, but it is technically possible to do it with compression), here to make <em>ndex.ru</em> will not work.  Also, to finish all derived domain names will be the root domain, that is, write, say, <em>mail.yandex</em> also fails. </p><br><p>  Domain name can: </p><br><ul><li>  be completely written without compression, </li><li>  start with a place that uses compression, </li><li>  start with one or more tags without compression, and then go on to compression, </li><li>  be empty (for the root domain). </li></ul><br><p>  For example, we are compiling a DNS message, and we have previously encountered the name "dom3.example.com", now we need to specify "dom4.dom3.example.com".  In this case, you can write the section "dom4" without compression, and then go to compression, that is, add a link to "dom3.example.com".  Or vice versa, if the name "dom4.dom3.example.com" was previously encountered, then to indicate "dom3.example.com" you can immediately use compression, referring to the label "dom3" in it.  What we can NOT do - as already mentioned, specify through compression part of 'dom4.dom3', because the name must end with the top level section.  If you suddenly need to specify the segments from the middle - they are simply indicated without compression. </p><br><p>  For simplicity, our program can not write domain names with compression, can only read.  The standard allows it, the reading must be implemented necessarily, the record is optional.  Technically, the reading is implemented as follows: if the two high-order bits of a length byte contain 1, then we read the next byte, and treat these two bytes as a 16-bit unsigned integer, with the order of the Big Endian bits.  The two high-order bits (containing 1) are discarded, we read the resulting 14-bit number, and we continue further reading of the domain name from a byte in the DNS message with the number corresponding to this number. </p><br><p>  The code for the function of reading a domain name is: </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readDomainName</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">buf, startOffset, objReturnValue = {}</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> currentByteIndex = startOffset; <span class="hljs-comment"><span class="hljs-comment">// –ù–æ–º–µ—Ä –±–∞–π—Ç–∞ –≤ –±—É—Ñ–µ—Ä–µ, —Å–æ–¥–µ—Ä–∂–∞—â–µ–º DNS-—Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é, –∫–æ—Ç–æ—Ä—ã–π —á–∏—Ç–∞–µ–º –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç let initOctet = buf.readUInt8(currentByteIndex); let domain = ''; // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–ª—É—á–∞–π —Å –∫–æ—Ä–Ω–µ–≤—ã–º –¥–æ–º–µ–Ω–æ–º, —Ç.–µ. –∫–æ–≥–¥–∞ –ø–µ—Ä–≤—ã–π –∂–µ –±–∞–π—Ç –¥–ª–∏–Ω—ã —Ä–∞–≤–µ–Ω 0, // –∏ —Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, –¥–æ–º–µ–Ω–Ω–æ–µ –∏–º—è —è–≤–ª—è–µ—Ç—Å—è –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π // "the root domain name has no labels." (c) RFC-1035, p. 4.1.4. Message compression objReturnValue['endOffset'] = currentByteIndex; let lengthOctet = initOctet; while (lengthOctet &gt; 0) { // –ß–∏—Ç–∞–µ–º –º–µ—Ç–∫—É –¥–æ–º–µ–Ω–Ω–æ–≥–æ –∏–º–µ–Ω–∏ var label; if (lengthOctet &gt;= 192) { // –ü—Ä–∏–∑–Ω–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–æ–º–ø—Ä–µ—Å—Å–∏–∏: –∑–Ω–∞—á–µ–Ω–∏–µ 0b1100 0000 –∏–ª–∏ –±–æ–ª—å—à–µ const pointer = buf.readUInt16BE(currentByteIndex) - 49152; // 49152 === 0b1100 0000 0000 0000 === 192 * 256 const returnValue = {} label = readDomainName(buf, pointer, returnValue); domain += ('.' + label); objReturnValue['endOffset'] = currentByteIndex + 1; // –£—á–∞—Å—Ç–æ–∫ —Å –∫–æ–º–ø—Ä–µ—Å—Å–∏–µ–π –≤—Å–µ–≥–¥–∞ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –ø–æ—ç—Ç–æ–º—É –∑–¥–µ—Å—å –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ü–∏–∫–ª–∞ break; } else { currentByteIndex++; label = buf.toString('ascii', currentByteIndex, currentByteIndex + lengthOctet); domain += ('.' + label); currentByteIndex += lengthOctet; lengthOctet = buf.readUInt8(currentByteIndex); objReturnValue['endOffset'] = currentByteIndex; } } return domain.substring(1); // –£–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π —Å–∏–º–≤–æ–ª ‚Äî —Ç–æ—á–∫—É "." }</span></span></code> </pre> <br><p>  <em>Listing 2. Reading domain names from a DNS query</em> </p><br><p>  The full code of the function of reading DNS records from the binary buffer: </p><br><div class="spoiler">  <b class="spoiler_title">Listing 3. Reading DNS records from binary buffer</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parseDnsMessageBytes</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">buf</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> msgFields = {}; <span class="hljs-comment"><span class="hljs-comment">// (c) RFC 1035 p. 4.1.1. Header section format msgFields['ID'] = buf.readUInt16BE(0); const byte_2 = buf.readUInt8(2); // –±–∞–π—Ç #2 (starting from 0) const mask_QR = 0b10000000; msgFields['QR'] = !!(byte_2 &amp; mask_QR); // –¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è: 0 "false" =&gt; –∑–∞–ø—Ä–æ—Å, 1 "true" =&gt; –æ—Ç–≤–µ—Ç const mask_Opcode = 0b01111000; const opcode = (byte_2 &amp; mask_Opcode) &gt;&gt;&gt; 3; // –∑–Ω–∞—á–∏–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–¥–µ—Å—è—Ç–∏—á–Ω—ã–µ): 0, 1, 2, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω—ã msgFields['Opcode'] = opcode; const mask_AA = 0b00000100; msgFields['AA'] = !!(byte_2 &amp; mask_AA); const mask_TC = 0b00000010; msgFields['TC'] = !!(byte_2 &amp; mask_TC); const mask_RD = 0b00000001; msgFields['RD'] = !!(byte_2 &amp; mask_RD); const byte_3 = buf.readUInt8(3); // –±–∞–π—Ç #3 const mask_RA = 0b10000000; msgFields['RA'] = !!(byte_3 &amp; mask_RA); const mask_Z = 0b01110000; msgFields['Z'] = (byte_3 &amp; mask_Z) &gt;&gt;&gt; 4; // –≤—Å–µ–≥–¥–∞ 0, –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏ const mask_RCODE = 0b00001111; msgFields['RCODE'] = (byte_3 &amp; mask_RCODE); // 0 =&gt; no error; (dec) 1, 2, 3, 4, 5 - errors, see RFC msgFields['QDCOUNT'] = buf.readUInt16BE(4); // —á–∏—Å–ª–æ –∑–∞–ø–∏—Å–µ–π –≤ —Å–µ–∫—Ü–∏–∏ Question, –ø–æ —Ñ–∞–∫—Ç—É 0 –∏–ª–∏ 1 msgFields['ANCOUNT'] = buf.readUInt16BE(6); // —á–∏—Å–ª–æ –∑–∞–ø–∏—Å–µ–π –≤ —Å–µ–∫—Ü–∏–∏ Answer msgFields['NSCOUNT'] = buf.readUInt16BE(8); // —á–∏—Å–ª–æ –∑–∞–ø–∏—Å–µ–π –≤ —Å–µ–∫—Ü–∏–∏ Authority msgFields['ARCOUNT'] = buf.readUInt16BE(10); // —á–∏—Å–ª–æ –∑–∞–ø–∏—Å–µ–π –≤ —Å–µ–∫—Ü–∏–∏ Additional // —á–∏—Ç–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–µ–∫—Ü–∏–∏ Question let currentByteIndex = 12; // —Å–µ–∫—Ü–∏—è Question –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 12-–≥–æ –±–∞–π—Ç–∞ DNS-—Å–æ–æ–±—â–µ–Ω–∏—è (c) RFC 1035 p. 4.1.2. Question section format msgFields['questions'] = []; for (let qdcount = 0; qdcount &lt; msgFields['QDCOUNT']; qdcount++) { const question = {}; const resultByteIndexObj = { endOffset: undefined }; const domain = readDomainName(buf, currentByteIndex, resultByteIndexObj); currentByteIndex = resultByteIndexObj.endOffset + 1; question['domainName'] = domain; question['qtype'] = buf.readUInt16BE(currentByteIndex); // 1 =&gt; "A" record currentByteIndex += 2; question['qclass'] = buf.readUInt16BE(currentByteIndex); // 1 =&gt; "IN" Internet currentByteIndex += 2; msgFields['questions'].push(question); } // (c) RFC 1035 p. 4.1.3. Resource record format // —á–∏—Ç–∞–µ–º —Ä–µ—Å—É—Ä—Å–Ω—ã–µ –∑–∞–ø–∏—Å–∏ (Resourse Records, RR) —Å–µ–∫—Ü–∏–π Answer, Authority, Additional ['answer', 'authority', 'additional'].forEach(function(section, i, arr) { let msgFieldsName, countFieldName; switch(section) { case 'answer': msgFieldsName = 'answers'; countFieldName = 'ANCOUNT'; break; case 'authority': msgFieldsName = 'authorities'; countFieldName = 'NSCOUNT'; break; case 'additional': msgFieldsName = 'additionals'; countFieldName = 'ARCOUNT'; break; } msgFields[msgFieldsName] = []; for (let recordsCount = 0; recordsCount &lt; msgFields[countFieldName]; recordsCount++) { let record = {}; const objReturnValue = {}; const domain = readDomainName(buf, currentByteIndex, objReturnValue); currentByteIndex = objReturnValue['endOffset'] + 1; record['domainName'] = domain; record['type'] = buf.readUInt16BE(currentByteIndex); // 1 =&gt; "A" record currentByteIndex += 2; record['class'] = buf.readUInt16BE(currentByteIndex); // 1 =&gt; "IN" Internet currentByteIndex += 2; // TTL –∑–∞–Ω–∏–º–∞–µ—Ç 4 –±–∞–π—Ç–∞ record['ttl'] = buf.readUIntBE(currentByteIndex, 4); currentByteIndex += 4; record['rdlength'] = buf.readUInt16BE(currentByteIndex); currentByteIndex += 2; const rdataBinTempBuf = buf.slice(currentByteIndex, currentByteIndex + record['rdlength']); record['rdata_bin'] = Buffer.alloc(record['rdlength'], rdataBinTempBuf); if (record['type'] === 1 &amp;&amp; record['class'] === 1) { // –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—Ç —Å–æ–±–æ–π –∞–¥—Ä–µ—Å IPv4, —á–∏—Ç–∞–µ–º –∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Å—Ç—Ä–æ–∫—É let ipStr = ''; for (ipv4ByteIndex = 0; ipv4ByteIndex &lt; 4; ipv4ByteIndex++) { ipStr += '.' + buf.readUInt8(currentByteIndex).toString(); currentByteIndex++; } record['IPv4'] = ipStr.substring(1); // —É–±–∏—Ä–∞–µ–º –∑–∞–≥–ª–∞–≤–Ω—É—é —Ç–æ—á–∫—É '.' } else { // –∏–Ω–∞—á–µ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ, –Ω–µ —á–∏—Ç–∞—è currentByteIndex += record['rdlength']; } msgFields[msgFieldsName].push(record); } }); return msgFields; }</span></span></code> </pre> <br><p>  <em>Listing 3. Reading DNS records from binary buffer</em> </p></div></div><br><p>  Finally, a request from a local client is received and parsed. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Ñ–∏–∫—Ç–∏–≤–Ω—ã–π –æ—Ç–≤–µ—Ç, –∏ –µ—Å–ª–∏ –¥–∞, —Ç–æ —Ñ–æ—Ä–º–∏—Ä—É–µ–º –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º. –ï—Å–ª–∏ –∂–µ –Ω–µ—Ç, —Ç–æ –ø–æ—Å—ã–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å —É–¥–∞–ª—ë–Ω–Ω–æ–º—É DNS-—Å–µ—Ä–≤–µ—Ä—É, –ø—Ä—è–º–æ —Ç–∞–∫ –∫–∞–∫ –æ–Ω –ø–æ–ª—É—á–µ–Ω, –≤ –¥–≤–æ–∏—á–Ω–æ–º –≤–∏–¥–µ. –ü–æ–ª—É—á–∏–≤ –æ—Ç–≤–µ—Ç, –ø–µ—Ä–µ–¥–∞—ë–º –µ–≥–æ –∞–¥—Ä–µ—Å–∞—Ç—É —Ç–∞–∫ –∂–µ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π. </p><br><p> –†–∞–∑–±–æ—Ä –∑–∞–ø—Ä–æ—Å–∞, –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –±—É–¥–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –≤ –∫–æ–ª–ª-–±—ç–∫–µ <code>server.on("message", () =&gt; {})</code> –∏–∑ –ª–∏—Å—Ç–∏–Ω–≥–∞ 1. –ö–æ–¥ –ø–æ–ª—É—á–∞–µ—Ç—Å—è —Ç–∞–∫–∏–º: </p><br><div class="spoiler"> <b class="spoiler_title">–õ–∏—Å—Ç–∏–Ω–≥ 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–µ–≥–æ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ DNS-–∑–∞–ø—Ä–æ—Å–∞</b> <div class="spoiler_text"><pre> <code class="javascript hljs">server.on(<span class="hljs-string"><span class="hljs-string">'message'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> (localReq, linfo) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> dnsRequest = functions.parseDnsMessageBytes(localReq); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> question = dnsRequest.questions[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-comment"><span class="hljs-comment">// currently, only one question per query is supported by DNS implementations let forgingHostParams = undefined; // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –¥–æ–º–µ–Ω–Ω–æ–≥–æ –∏–º–µ–Ω–∏ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –Ω–∞—à IP for (let i = 0; i &lt; config.requestsToForge.length; i++) { const requestToForge = config.requestsToForge[i]; const targetDomainName = requestToForge.hostName; if (functions.domainNameMatchesTemplate(question.domainName, targetDomainName) &amp;&amp; question.qclass === 1 &amp;&amp; question.qtype === 1) { forgingHostParams = requestToForge; break; } } // –ï—Å–ª–∏ –¥–∞, —Ç–æ —Ñ–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é DNS-–æ—Ç–≤–µ—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ –ª–æ–∫–∞–ª—å–Ω–æ–º—É –∫–ª–∏–µ–Ω—Ç—É if (!!forgingHostParams) { const forgeIp = forgingHostParams.ip; const answers = []; answers.push({ domainName: question.domainName, type: question.qtype, class: question.qclass, ttl: forgedRequestsTTL, rdlength: 4, rdata_bin: functions.ip4StringToBuffer(forgeIp), IPv4: forgeIp }); const localDnsResponse = { ID: dnsRequest.ID, QR: dnsRequest.QR, Opcode: dnsRequest.Opcode, AA: dnsRequest.AA, TC: false, // dnsRequest.TC, RD: dnsRequest.RD, RA: true, Z: dnsRequest.Z, RCODE: 0, // dnsRequest.RCODE, 0 - no errors, look in RFC-1035 for other error conditions QDCOUNT: dnsRequest.QDCOUNT, ANCOUNT: answers.length, NSCOUNT: dnsRequest.NSCOUNT, ARCOUNT: dnsRequest.ARCOUNT, questions: dnsRequest.questions, answers: answers } // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –æ–±—ä–µ–∫—Ç —Å –ø–æ–ª—è–º–∏ DNS-–æ—Ç–≤–µ—Ç–∞ –≤ –±–∏–Ω–∞—Ä–Ω—ã–π –±—É—Ñ–µ—Ä const responseBuf = functions.composeDnsMessageBin(localDnsResponse); console.log('response composed for: ', localDnsResponse.questions[0]); server.send(responseBuf, linfo.port, linfo.address, (err, bytes) =&gt; {}); } // –ò–Ω–∞—á–µ, –¥–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã—à–µ—Å—Ç–æ—è—â–∏–π DNS-—Å–µ—Ä–≤–µ—Ä, –∏ –ø–µ—Ä–µ–¥–∞—ë–º –µ–≥–æ –æ—Ç–≤–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–º—É –∫–ª–∏–µ–Ω—Ç—É –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π else { // –ü—Ä–∏ —Å–≤—è–∑–∏ —Å —É–¥–∞–ª—ë–Ω–Ω—ã–º DNS-—Å–µ—Ä–≤–µ—Ä–æ–º –ø–æ UDP, –ø–µ—Ä–µ—Å—ã–ª–∞–µ–º –µ–º—É –ª–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å const responseBuf = await functions.getRemoteDnsResponseBin(localReq, upstreamDnsIP, upstreamDnsPort); // –∏ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–º—É –∫–ª–∏–µ–Ω—Ç—É –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç server.send(responseBuf, linfo.port, linfo.address, (err, bytes) =&gt; {}); // –ü—Ä–∏ —Å–≤—è–∑–∏ —Å —É–¥–∞–ª—ë–Ω–Ω—ã–º DNS-—Å–µ—Ä–≤–µ—Ä–æ–º –ø–æ TLS, –º–µ—Ö–∞–Ω–∏–∑–º –±—É–¥–µ—Ç –¥—Ä—É–≥–∏–º, —Å–º. –ª–∏—Å—Ç–∏–Ω–≥ 9 } });</span></span></code> </pre> <br><p> <em>–õ–∏—Å—Ç–∏–Ω–≥ 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–µ–≥–æ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ DNS-–∑–∞–ø—Ä–æ—Å–∞</em> </p></div></div><br><h2 id="dobavlyaem-podderzhku-tls"> –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É TLS </h2><br><p> –í –ø–æ—Å–ª–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –º–Ω–æ–≥–∏—Ö –∑–∞–±–æ—Ç–∏—Ç –≤–æ–ø—Ä–æ—Å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è DNS-—Ç—Ä–∞—Ñ–∏–∫–∞. –ß—Ç–æ–±—ã –±—ã—Ç—å –≤ —Ç—Ä–µ–Ω–¥–µ, –¥–æ–±–∞–≤–∏–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –≤—ã—à–µ—Å—Ç–æ—è—â–µ–º—É DNS-—Å–µ—Ä–≤–µ—Ä—É –ø–æ –ø—Ä–æ—Ç–æ–∫–æ–ª—É TLS (HTTPS –ø–æ–∫–∞ —Ç—Ä–æ–≥–∞—Ç—å –Ω–µ –±—É–¥–µ–º). –û–±–º–µ–Ω DNS-—Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –ø–æ TLS –ø–æ—Ö–æ–∂ –Ω–∞ —Ç–∞–∫–æ–≤–æ–π –ø–æ TCP, —Ä–∞–∑–Ω–∏—Ü–∞ —Ç–æ–ª—å–∫–æ –≤ —Ç–æ–º, —á—Ç–æ –¥–ª—è TLS –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–∞–Ω–∞–ª. –ù–æ –≤–Ω—É—Ç—Ä–∏ —ç—Ç–æ–≥–æ –∫–∞–Ω–∞–ª–∞ –æ–±–º–µ–Ω –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –∏–¥—ë—Ç —Å—Ö–æ–¥–Ω–æ —Å TCP, –∏ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è RFC-7766 DNS Transport over TCP ( <a href="https://tools.ietf.org/html/rfc7766">https://tools.ietf.org/html/rfc7766</a> ). –ß—Ç–æ–±—ã –Ω–∏–∫–æ–≥–æ –Ω–µ –ø—É—Ç–∞—Ç—å, —Å—Ä–∞–∑—É –æ—Ç–º–µ—á—É: –º—ã –¥–æ–±–∞–≤–ª—è–µ–º –≤ –ø—Ä–æ–≥—Ä–∞–º–º—É –ø–æ–¥–¥–µ—Ä–∂–∫—É TLS, —Ä–∞–±–æ—Ç–∞—Ç—å —Å TCP –Ω–µ –±—É–¥–µ–º (–≤ –ø—Ä–∏–Ω—Ü–∏–ø–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É —Å–≤—è–∑–∏ —Å –≤–Ω–µ—à–Ω–∏–º DNS –ø–æ TCP, –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –∑–∞–º–µ–Ω–∏—Ç—å –≤ –ø—Ä–æ–≥—Ä–∞–º–º–µ TLS-—Å–æ–∫–µ—Ç –Ω–∞ TCP-—Å–æ–∫–µ—Ç, –Ω–æ —Å–µ–π—á–∞—Å –º—ã —ç—Ç–æ –ø—Ä–æ–ø—É—Å—Ç–∏–º). </p><br><h3 id="ustanovka-tls-soedineniya"> –£—Å—Ç–∞–Ω–æ–≤–∫–∞ TLS-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è </h3><br><p> –£—Å—Ç–∞–Ω–æ–≤–∫–∞ TLS-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –≤–ª–µ—á—ë—Ç –∑–∞ —Å–æ–±–æ–π –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã —Å–µ—Ä–≤–µ—Ä–∞ –∏ –∫–ª–∏–µ–Ω—Ç–∞, –ø–æ—ç—Ç–æ–º—É –µ–≥–æ —Ü–µ–ª–µ—Å–æ–æ–±—Ä–∞–∑–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–º –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å, –µ—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à—ë–ª —Ä–∞–∑—Ä—ã–≤. –í–æ–æ–±—â–µ –≥–æ–≤–æ—Ä—è, –Ω–∏–∫—Ç–æ –Ω–µ –∑–∞–ø—Ä–µ—â–∞–µ—Ç –Ω–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤–æ–µ TLS-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ, –∏ —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º —É–ø—Ä–æ—Å—Ç–∏—Ç—å –ª–æ–≥–∏–∫—É —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ù–æ RFC-7858 –≤—Å—ë-—Ç–∞–∫–∏ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞–∑–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤: </p><br><pre> <code class="plaintext hljs">In order to amortize TCP and TLS connection setup costs, clients and servers SHOULD NOT immediately close a connection after each response. Instead, clients and servers SHOULD reuse existing connections for subsequent queries as long as they have sufficient resources. In some cases, this means that clients and servers may need to keep idle connections open for some amount of time. (—Å) https://tools.ietf.org/html/rfc7858#section-3.4</code> </pre> <br><p> –ü–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å, –∞–∫—Ç–∏–≤–Ω–æ –ª–∏ TLS-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ, –∏ –µ—Å–ª–∏ –¥–∞, —Ç–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ –Ω–µ–≥–æ, –∞ –µ—Å–ª–∏ –Ω–µ—Ç, —Ç–æ —Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤–æ–µ, –∏ –æ–ø—è—Ç—å –∂–µ –ø–æ—à–ª—ë—Ç –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ –Ω–µ–≥–æ. –¢–∞–∫ –∂–µ –¥–æ–≥–æ–≤–æ—Ä–∏–º—Å—è, —á—Ç–æ –µ—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ –∞–∫—Ç–∏–≤–Ω–æ –≤ —Ç–µ—á–µ–Ω–∏–µ 30 —Å–µ–∫—É–Ω–¥, –∑–∞–∫—Ä–æ–µ–º –µ–≥–æ —Å–∞–º–∏, –∏ –ø–æ—Ç–æ–º –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å–æ–∑–¥–∞–¥–∏–º –Ω–æ–≤–æ–µ, —á—Ç–æ–±—ã –Ω–µ –∑–∞–Ω–∏–º–∞—Ç—å –ø–æ–ø—É—Å—Ç—É —Ä–µ—Å—É—Ä—Å—ã –Ω–∞ —É–¥–∞–ª—ë–Ω–Ω–æ–º DNS-—Å–µ—Ä–≤–µ—Ä–µ. –í—Ä–µ–º—è 30 —Å–µ–∫—É–Ω–¥ ~–≤–∑—è—Ç–æ —Å –ø–æ—Ç–æ–ª–∫–∞~ –≤—ã–±—Ä–∞–Ω–æ –º–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ, –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å 15 –∏–ª–∏ 60 —Å–µ–∫, –∏–ª–∏ –≤–æ–æ–±—â–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ —ç—Ç–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –∏–∑ —Ñ–∞–π–ª–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏. –ú–æ–∂–Ω–æ –≤–æ–æ–±—â–µ –¥–µ—Ä–∂–∞—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç—ã–º —Å–∫–æ–ª—å–∫–æ —É–≥–æ–¥–Ω–æ –¥–æ–ª–≥–æ, —É–¥–∞–ª—ë–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä —Å–∞–º –µ–≥–æ –∑–∞–∫—Ä–æ–µ—Ç –≤ —Å–ª—É—á–∞–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤. –ù–æ —ç—Ç–æ –∫–∞–∫-—Ç–æ –Ω–µ—ç–ª–µ–≥–∞–Ω—Ç–Ω–æ. </p><br><p> TLS-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –±—É–¥–µ–º —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏ NodeJS. –ß—Ç–æ–±—ã –Ω–µ –∑–∞—Ö–ª–∞–º–ª—è—Ç—å –∫–æ–¥, –ª–æ–≥–∏–∫—É —Ä–∞–±–æ—Ç—ã —Å TLS-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º —Ü–µ–ª–µ—Å–æ–æ–±—Ä–∞–∑–Ω–æ –≤—ã–Ω–µ—Å—Ç–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–æ–¥—É–ª—å: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> tls = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'tls'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> TLS_SOCKET_IDLE_TIMEOUT = <span class="hljs-number"><span class="hljs-number">30000</span></span>; <span class="hljs-comment"><span class="hljs-comment">// –∏–Ω—Ç–µ—Ä–≤–∞–ª –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤ –º–∏–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö, –ø–æ—Å–ª–µ –∫–æ—Ç–æ—Ä–æ–≥–æ –º—ã –∑–∞–∫—Ä–æ–µ–º TLS-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ function Module(connectionOptions, funcOnData, funcOnError, funcOnClose, funcOnEnd) { let socket; function connect() { socket = tls.connect(connectionOptions, () =&gt; { console.log('client connection established:', socket.authorized ? 'authorized' : 'unauthorized'); }); socket.on('data', funcOnData); // connection.on('end', () =&gt; {}); socket.on('close', (hasTransmissionError) =&gt; { // –ù–µ –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –∑–∞–∫—Ä—ã—Ç–æ —É–¥–∞–ª—ë–Ω–Ω—ã–º —Å–µ—Ä–≤–µ—Ä–æ–º. // –û—Ç–∫—Ä–æ–µ–º –Ω–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ, –∫–æ–≥–¥–∞ –ø–æ—Å—Ç—É–ø–∏—Ç –≤—Ö–æ–¥—è—â–∏–π –∑–∞–ø—Ä–æ—Å console.log('connection closed; transmission error:', hasTransmissionError); }); socket.on('end', () =&gt; { console.log('remote TLS server connection closed.') }); socket.on('error', (err) =&gt; { console.log('connection error:', err); console.log('\tmessage:', err.message); console.log('\tstack:', err.stack); }) socket.setTimeout(TLS_SOCKET_IDLE_TIMEOUT); socket.on('timeout', () =&gt; { console.log('socket idle timeout, disconnected.'); socket.end(); }); } this.write = function (dataBuf) { if (socket &amp;&amp; socket.writable) { // —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ, –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è } else { connect(); } socket.write(dataBuf); } return this; } module.exports = Module;</span></span></code> </pre> <br><p> <em>–õ–∏—Å—Ç–∏–Ω–≥ 5. –ú–æ–¥—É–ª—å, –æ—Ç–≤–µ—á–∞—é—â–∏–π –∑–∞ TLS-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</em> </p><br><p> –≠—Ç–æ–≥–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ø—É–±–ª–∏—á–Ω—ã–º–∏ DNS-over-TLS —Å–µ—Ä–≤–∏—Å–∞–º–∏, —Ç–∞–∫–∏–º–∏ –∫–∞–∫ Google DNS. –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä —Ç—Ä–µ–±—É–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å –ø–æ–º–æ—â—å—é –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞, –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –µ—â—ë –¥–æ–±–∞–≤–∏—Ç—å —á—Ç–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –∏ –ø–µ—Ä–µ–¥–∞—á—É –µ–≥–æ –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è <code>socket = tls.connect(connectionOptions, () =&gt; {})</code> . –≠—Ç–æ –æ–ø–∏—Å–∞–Ω–æ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ NodeJS: <a href="https://nodejs.org/api/tls.html">https://nodejs.org/api/tls.html#tls_tls_connect_options_callback</a> , –∑–¥–µ—Å—å –º—ã —ç—Ç–æ—Ç —Å–ª—É—á–∞–π —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –Ω–µ –±—É–¥–µ–º. </p><br><p> –£—Å—Ç–∞–Ω–æ–≤–∫–∞ TLS-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é –º–æ–¥—É–ª—è: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> options = { <span class="hljs-attr"><span class="hljs-attr">port</span></span>: config.upstreamDnsTlsPort, <span class="hljs-comment"><span class="hljs-comment">// —Ä–∞–±–æ—Ç–∞ —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π –æ–ø–∏—Å–∞–Ω–∞ –¥–∞–ª–µ–µ –≤ —Å—Ç–∞—Ç—å–µ host: config.upstreamDnsTlsHost } const onData = (data) =&gt; { // –ó–¥–µ—Å—å –±—É–¥–µ–º –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ø–æ—Å—Ç—É–ø–∏–≤—à–∏–µ –æ—Ç–≤–µ—Ç—ã, —Å–º. –æ–ø–∏—Å–∞–Ω–∏–µ –¥–∞–ª–µ–µ –≤ —Å—Ç–∞—Ç—å–µ –∏ –õ–∏—Å—Ç–∏–Ω–≥ 7 }; remoteTlsClient = new TlsClient(options, onData);</span></span></code> </pre> <br><p> <em>–õ–∏—Å—Ç–∏–Ω–≥ 6. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ TLS-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</em> </p><br><p> –ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ, –¥–∞–ª—å–Ω–µ–π—à–∞—è —Ä–∞–±–æ—Ç–∞ —Å –Ω–∏–º –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –æ–±—ã—á–Ω–æ–º—É TCP-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—é. –í –æ–¥–Ω–æ–º TCP/TLS-—Å–æ–æ–±—â–µ–Ω–∏–∏ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å—Å—è –æ–¥–Ω–æ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ DNS-—Å–æ–æ–±—â–µ–Ω–∏–π, —Å–ª–µ–¥—É—é—â–∏—Ö –ø–æ–¥—Ä—è–¥ –æ–¥–Ω–æ –∑–∞ –¥—Ä—É–≥–∏–º, –∏ —á—Ç–æ–±—ã —Ä–∞–∑–ª–∏—á–∞—Ç—å –∏—Ö, –∫–∞–∂–¥–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é –ø—Ä–µ–¥—à–µ—Å—Ç–≤—É—é—Ç –¥–≤–∞ –±–∞–π—Ç–∞, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ –µ–≥–æ –¥–ª–∏–Ω—É. –ü—Ä–∏ —Ä–∞–±–æ—Ç–µ –ø–æ TCP (–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ TLS), –¥–ª–∏–Ω–∞ DNS-—Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç—Å—è 512 –±–∞–π—Ç–∞–º–∏, –≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç UDP (—Ö–æ—Ç—è, –≤ EDNS —ç—Ç–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª—è UDP —Ç–æ–∂–µ —Å–Ω—è—Ç–æ). –í –æ—Å—Ç–∞–ª—å–Ω–æ–º, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ DNS-—Å–æ–æ–±—â–µ–Ω–∏—è –∏–¥–µ–Ω—Ç–∏—á–Ω–∞ —Ç–∞–∫–æ–≤–æ–π –¥–ª—è UDP, –∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –µ–≥–æ –º—ã –ø—Ä–∏–º–µ–Ω—è–µ–º –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –º–µ—Ç–æ–¥—ã. –ü–æ–ª—É—á–∏–≤—à–∏–π—Å—è –∫–æ–¥ –ø–æ–º–µ—â–∞–µ–º –≤ —Ç–µ–ª–æ —Ñ—É–Ω–∫—Ü–∏–∏ <strong>onData()</strong> –∏–∑ –ª–∏—Å—Ç–∏–Ω–≥–∞ 6. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> onData = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-comment"><span class="hljs-comment">// –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç —É–¥–∞–ª—ë–Ω–Ω–æ–≥–æ DNS-—Å–µ—Ä–≤–µ—Ä–∞, —Å —É—á—ë—Ç–æ–º —Ç–æ–≥–æ —á—Ç–æ –≤ –æ–¥–Ω–æ–º TLS-—Å–æ–æ–±—â–µ–Ω–∏–∏ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å—Å—è // –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç–æ–≤, –∏ –∫–∞–∂–¥–æ–º—É –æ—Ç–≤–µ—Ç—É –ø—Ä–µ–¥—à–µ—Å—Ç–≤—É–µ—Ç 2 –±–∞–π—Ç–∞, —Å–æ–¥–µ—Ä–∂–∞—â–∏—Ö –¥–ª–∏–Ω—É –≤ –±–∞–π—Ç–∞—Ö —ç—Ç–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ let dataCurrentPos = 0; try { while (dataCurrentPos &lt; data.length) { const respLen = data.readUInt16BE(dataCurrentPos); respBuf = data.slice(dataCurrentPos + 2, dataCurrentPos + 2 + respLen); const respData = functions.parseDnsMessageBytes(respBuf); const requestKey = functions.getRequestIdentifier(respData); const localResponseParams = localRequestsAwaiting.get(requestKey); localRequestsAwaiting.delete(requestKey); server.send(respBuf, localResponseParams.port, localResponseParams.address, (err, bytesNum) =&gt; {}); dataCurrentPos += 2 + respLen; } } catch (err) { console.error(err); // –ù–∞ –≤—Ä–µ–º—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏, –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏ –±—Ä–æ—Å–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ throw err; } };</span></span></code> </pre> <br><p> <em>–õ–∏—Å—Ç–∏–Ω–≥ 7. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–Ω–æ–≥–æ TLS-—Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –≤—ã—à–µ—Å—Ç–æ—è—â–µ–≥–æ DNS-—Å–µ—Ä–≤–µ—Ä–∞ –∏–∑ –ª–∏—Å—Ç–∏–Ω–≥–∞ 6</em> </p><br><h3 id="poryadok-otvetov-ot-udalyonnogo-dns-servera"> –ü–æ—Ä—è–¥–æ–∫ –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç —É–¥–∞–ª—ë–Ω–Ω–æ–≥–æ DNS-—Å–µ—Ä–≤–µ—Ä–∞ </h3><br><p> –ü–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É, –æ—Ç–≤–µ—Ç—ã –æ—Ç —É–¥–∞–ª—ë–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–ª–∂–Ω—ã –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –≤ —Ç–æ–º –∂–µ –ø–æ—Ä—è–¥–∫–µ, –≤ –∫–æ—Ç–æ—Ä–æ–º –±—ã–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –∑–∞–ø—Ä–æ—Å—ã. –ù–∞ —ç—Ç–æ—Ç —Å–ª—É—á–∞–π, —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–µ–¥–ø–∏—Å—ã–≤–∞–µ—Ç —Å–æ–ø–æ—Å—Ç–∞–≤–ª—è—Ç—å –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –∑–∞–ø—Ä–æ—Å–∞–º –ø–æ –ø–æ–ª—é ID –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –ø–æ–ª—è–º QNAME, QTYPE –∏ QCLASS —Å–µ–∫—Ü–∏–∏ <em>Question</em> : </p><br><pre> <code class="plaintext hljs">Since pipelined responses can arrive out of order, clients MUST match responses to outstanding queries on the same TLS connection using the Message ID. If the response contains a Question Section, the client MUST match the QNAME, QCLASS, and QTYPE fields. (—Å) https://tools.ietf.org/html/rfc7858#section-3.3</code> </pre> <br><p> –ü–æ—ç—Ç–æ–º—É –Ω–∞–º –Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º, –æ–ø—Ä–µ–¥–µ–ª—è—é—â–∏–π –∞–¥—Ä–µ—Å–∞—Ç–∞, –∫–æ—Ç–æ—Ä–æ–º—É –±—É–¥–µ—Ç –ø–µ—Ä–µ–¥–∞–Ω –æ—Ç–≤–µ—Ç, –Ω–∞ –æ—Å–Ω–æ–≤–µ ID –∏ —Å–µ–∫—Ü–∏–∏ <em>Question</em> (–∫–∞–∫ —É–∂–µ –±—ã–ª–æ —Å–∫–∞–∑–∞–Ω–æ, –æ–Ω–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç —É –∑–∞–ø—Ä–æ—Å–∞ –∏ –æ—Ç–≤–µ—Ç–∞). </p><br><p> –ö–æ–≥–¥–∞ –º—ã –æ–±—â–∞–ª–∏—Å—å —Å —É–¥–∞–ª—ë–Ω–Ω—ã–º —Å–µ—Ä–≤–µ—Ä–æ–º –ø–æ UDP (—Å–º. –ª–∏—Å—Ç–∏–Ω–≥ 4), —ç—Ç–æ –±—ã–ª–æ –Ω–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ, –ø–æ—Ç–æ–º—É —á—Ç–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã —è —Ä–µ—à–∏–ª –≤ –∫–∞–∂–¥–æ–º –∫–æ–ª–ª-–±—ç–∫–µ, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—â–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –≤—Ö–æ–¥—è—â–∏–π –∑–∞–ø—Ä–æ—Å, —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–π UDP-—Å–æ–∫–µ—Ç –¥–ª—è —Å–≤—è–∑–∏ —Å —É–¥–∞–ª—ë–Ω–Ω—ã–º —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–æ–∫–µ—Ç–∞ –µ–º—É –≤—ã–¥–µ–ª—è–µ—Ç—Å—è —Å–≤–æ–±–æ–¥–Ω—ã–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –ø–æ—Ä—Ç, —Å –∫–æ—Ç–æ—Ä–æ–≥–æ —Å–æ–∫–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç –∑–∞–ø—Ä–æ—Å —É–¥–∞–ª—ë–Ω–Ω–æ–º—É DNS-—Å–µ—Ä–≤–µ—Ä—É, –∏ –ø–æ–ª—É—á–∏—Ç –æ—Ç–≤–µ—Ç –Ω–∞ —ç—Ç–æ—Ç –∂–µ –ø–æ—Ä—Ç. –ü–æ–ª—É—á–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∑–∞–ø—Ä–æ—Å–∏–≤—à–µ–º—É –µ–≥–æ –∫–ª–∏–µ–Ω—Ç—É –ø–æ –ª–æ–∫–∞–ª—å–Ω–æ–º—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é, —Å–≤–æ–π—Å—Ç–≤–∞ –∫–æ—Ç–æ—Ä–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —ç—Ç–æ–º –∂–µ –∫–æ–ª–ª-–±—ç–∫–µ. –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –æ—Ç–≤–µ—Ç—ã —É–¥–∞–ª—ë–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–µ –ø–µ—Ä–µ–ø—É—Ç–∞—é—Ç—Å—è, –ø–æ—Ç–æ–º—É —á—Ç–æ –±—É–¥—É—Ç –ø–æ–ª—É—á–µ–Ω—ã —Ä–∞–∑–Ω—ã–º–∏ UDP-—Å–æ–∫–µ—Ç–∞–º–∏ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –ø–æ—Ä—Ç–∞—Ö –∏ –ø–µ—Ä–µ–¥–∞–Ω—ã –∞–¥—Ä–µ—Å–∞—Ç–∞–º –≤ —Ä–∞–∑–Ω—ã—Ö –∫–æ–ª–ª-–±—ç–∫–∞—Ö. –ù—É –∏, –ø–æ–ª—É—á–∏–≤ –æ—Ç–≤–µ—Ç, –Ω–µ –∑–∞–±—ã–≤–∞–µ–º –∑–∞–∫—Ä—ã–≤–∞—Ç—å —Å–æ–∫–µ—Ç. </p><br><p> –ê –≤–æ—Ç –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ –ø–æ TLS, –æ—Ç–≤–µ—Ç—ã –≤—ã—à–µ—Å—Ç–æ—è—â–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ª–æ–∫–∞–¥—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –±—É–¥—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –ø–æ –æ–¥–Ω–æ–º—É –∏ —Ç–æ–º—É –∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é. –ü–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è —Ö—Ä–∞–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ (IP –∏ –ø–æ—Ä—Ç), –∞ —Ç–∞–∫ –∂–µ –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å, –∫–∞–∫–æ–º—É –∏–∑ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –∫–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç. </p><br><p> –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –±—É–¥–µ–º —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –µ–≥–æ IP –∏ –ø–æ—Ä—Ç –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –ø–∞—Ä "–∫–ª—é—á-–∑–Ω–∞—á–µ–Ω–∏–µ". –í –∫–∞—á–µ—Å—Ç–≤–µ –∫–ª—é—á–∞, –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –∏ –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏, —É—Å–ª–æ–≤–∏–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫—É, –ø–æ–ª—É—á–µ–Ω–Ω—É—é –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏–µ–π –≤—ã—à–µ—É–∫–∞–∑–∞–Ω–Ω—ã—Ö –ø–æ–ª–µ–π DNS-—Å–æ–æ–±—â–µ–Ω–∏—è. –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞, –µ–≥–æ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –ø—Ä–æ—á–∏—Ç–∞—Ç—å, —á—Ç–æ–±—ã –ø–æ —ç—Ç–∏–º –∂–µ –ø–æ–ª—è–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ IP –∏ –ø–æ—Ä—Ç, –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É –æ—Ç–≤–µ—Ç –±—É–¥–µ—Ç –ø–µ—Ä–µ–ø—Ä–∞–≤–ª–µ–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —ç—Ç–∏ —Å—Ç—Ä–æ–∫–∏ –≤ –ª–∏—Å—Ç–∏–Ω–≥–µ 7: </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// –ü–æ–ª—É—á–∞–µ–º –∫–ª—é—á –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–ª–µ–π –≤—Ö–æ–¥—è—â–µ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è const requestKey = functions.getRequestIdentifier(respData); // –ü–æ–ª—É—á–∞–µ–º –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ IP –∏ –ø–æ—Ä—Ç –ª–æ–∞–∫–ª—å–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ –æ—Ç–≤–µ—Ç—É const localResponseParams = localRequestsAwaiting.get(requestKey); localRequestsAwaiting.delete(requestKey); // –ü–µ—Ä–µ–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ –ø–æ–ª—É—á–µ–Ω–Ω—ã–º –ª–æ–∫–∞–ª—å–Ω–æ–º—É IP –∏ –ø–æ—Ä—Ç—É server.send(respBuf, localResponseParams.port, localResponseParams.address, (err, bytesNum) =&gt; {});</span></span></code> </pre> <br><p> <em>–õ–∏—Å—Ç–∏–Ω–≥ 8. –ü–æ—è—Å–Ω–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤ –∫–æ–¥–µ –ª–∏—Å—Ç–∏–Ω–≥–∞ 7</em> </p><br><p> –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —É–¥–∞–ª—ë–Ω–Ω–æ–º—É —Å–µ—Ä–≤–µ—Ä—É –ø–æ TLS-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é: </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// –¥–∞–Ω–Ω—ã–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è, –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É –ø–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å const localReqParams = { address: linfo.address, port: linfo.port }; // –ü–æ–ª—É—á–∞–µ–º –∫–ª—é—á –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–ª–µ–π –≤—Ö–æ–¥—è—â–µ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è const requestKey = functions.getRequestIdentifier(dnsRequest); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ª–æ–∫–∞–ª—å–Ω–æ–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é localRequestsAwaiting.set(requestKey, localReqParams); // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–¥ –±–∞–π—Ç–æ–≤—ã–º –±—É—Ñ–µ—Ä–æ–º –∑–∞–ø—Ä–æ—Å–∞ –¥–≤–∞ –±–∞–π—Ç–∞, —Ö—Ä–∞–Ω—è—â–∏–µ –µ–≥–æ –¥–ª–∏–Ω—É –≤ –±–∞–π—Ç–∞—Ö const lenBuf = Buffer.alloc(2); lenBuf.writeUInt16BE(localReq.length); const prepReqBuf = Buffer.concat([lenBuf, localReq], 2 + localReq.length); remoteTlsClient.write(prepReqBuf); // —Å–æ–≥–ª–∞—Å–Ω–æ RFC-7766 p.8, 2 –±–∞–π—Ç–∞ –¥–ª–∏–Ω—ã –∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –±–∞–π—Ç –∑–∞–ø—Ä–æ—Å–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –∑–∞ –æ–¥–∏–Ω –≤—ã–∑–æ–≤ –º–µ—Ç–æ–¥–∞ –∑–∞–ø–∏—Å–∏ —Å–æ–∫–µ—Ç–∞</span></span></code> </pre> <br><p> <em>–õ–∏—Å—Ç–∏–Ω–≥ 9. –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —É–¥–∞–ª—ë–Ω–Ω–æ–º—É DNS-—Å–µ—Ä–≤–µ—Ä—É –ø–æ TLS-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é (—Ç–∞–∫ –∂–µ —Å–º. –ª–∏—Å—Ç–∏–Ω–≥ 4)</em> </p><br><h2 id="chtenie-konfiguracii-iz-fayla-i-eyo-obnovlenie"> –ß—Ç–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–∑ —Ñ–∞–π–ª–∞ –∏ –µ—ë –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ </h2><br><p> –ù—É –∏ –Ω–∞–∫–æ–Ω–µ—Ü, –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–∞—Ä–Ω–æ–≥–æ —É–¥–æ–±—Å—Ç–≤–∞, –≤—ã–Ω–µ—Å–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã –≤ —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–Ω–≥—É—Ä–∞—Ü–∏–∏. –í—ã–±–µ—Ä–µ–º –¥–ª—è –Ω–µ–≥–æ —Ñ–æ—Ä–º–∞—Ç JSON, —Å –Ω–∏–º —É–¥–æ–±–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å, –ø–æ—Ç–æ–º—É —á—Ç–æ NodeJS —É–º–µ–µ—Ç –ø–æ–¥–∫–ª—é—á–∞—Ç—å JSON-—Ñ–∞–π–ª—ã –∫–∞–∫ –º–æ–¥—É–ª–∏ –∏ –ø–∞—Ä—Å–∏—Ç—å –∏—Ö –ø—Ä–æ–∑—Ä–∞—á–Ω–æ. –ú–∏–Ω—É—Å JSON ‚Äî —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–µ —Å–º–æ–∂–µ—Ç —Å–æ–∂–¥–µ—Ä–∂–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, –∞ –æ–Ω–∏ –±—ã–≤–∞—é—Ç –æ—Ö –∫–∞–∫ –Ω—É–∂–Ω—ã. –ö–∞–∫ –≤–∞—Ä–∏–∞–Ω—Ç, –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –≤ JSON-–µ –ø–æ–ª–µ "comment" (–∏–ª–∏ –ª—é–±–æ–µ –ø–æ—Ö–æ–∂–µ–µ) –∏ –≤ –µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏–∏ –ø–æ–º–µ—â–∞—Ç—å —Ç–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è. –•–æ—Ç—è, –∫–æ–Ω–µ—á–Ω–æ –∂–µ, —ç—Ç–æ –∫–æ—Å—Ç—ã–ª—å, –Ω–æ –≤—Å—ë –∂–µ –ª—É—á—à–µ, —á–µ–º –Ω–∏—á–µ–≥–æ. –¢–∞–∫ –∂–µ, –ø–æ–∫–∞ –Ω–µ –±—É–¥–µ–º –¥–µ–ª–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, —ç—Ç–æ –ø—Ä–∏–¥—ë—Ç—Å—è –¥–µ—Ä–∂–∞—Ç—å –≤ —É–º–µ. –ß—Ç–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ –ø–æ–¥–∫–ª—é—á–∞–µ–º—ã–π –º–æ–¥—É–ª—å, –∫–æ—Ç–æ—Ä—ã–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–∏–Ω–≥–ª—Ç–æ–Ω-—ç–∫–∑–µ–º–ø–ª—è—Ä –æ–±—ä–µ–∫—Ç–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, –µ–¥–∏–Ω—ã–π –¥–ª—è –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∞ —Ç–∞–∫ –∂–µ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏ NodeJS. –ï—Å–ª–∏ —Ñ–∞–π–ª –±—ã–ª –∏–∑–º–µ–Ω—ë–Ω, –æ–Ω —Å–Ω–æ–≤–∞ —Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è, –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –Ω–∞ –ª–µ—Ç—É. –¢–æ –µ—Å—Ç—å, –ø—Ä–∏ –≤–Ω–µ—Å–µ–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø—Ä–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É –Ω–µ –Ω—É–∂–Ω–æ, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–æ—Å—Ç–æ –ø–æ–ø—Ä–∞–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥ –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ; –∫–∞–∫ –ø–æ –º–Ω–µ, —ç—Ç–æ –≤–µ—Å—å–º–∞ —É–¥–æ–±–Ω–æ. –•–æ—Ç—è –ø—Ä–∏ —Ä–∞–∑—Ä–∞—Å—Ç–∞–Ω–∏–∏ –∏ —É—Å–ª–æ–∂–Ω–µ–Ω–∏–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫–æ–Ω—Ñ–∏–≥–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –¥–æ–ø—É—Å—Ç–∏—Ç—å –æ—à–∏–±–∫—É –≤–æ–∑—Ä–∞—Å—Ç—ë—Ç, –∏ —Å —ç—Ç–∏–º –ø—Ä–∏–¥—ë—Ç—Å—è —á—Ç–æ-—Ç–æ —Ä–µ—à–∞—Ç—å. </p><br><div class="spoiler"> <b class="spoiler_title">–õ–∏—Å—Ç–∏–Ω–≥ 10. –ú–æ–¥—É–ª—å —á—Ç–µ–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> path = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'path'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> fs = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'fs'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CONFIG_FILE_PATH = path.resolve(<span class="hljs-string"><span class="hljs-string">'./config.json'</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Module</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// config —è–≤–ª—è–µ—Ç—Å—è –æ–±—ä–µ–∫—Ç–æ–º-–∫–æ–Ω—Å—Ç–∞–Ω—Ç–æ–π, –ø–æ—ç—Ç–æ–º—É –º–æ–∂–µ—Ç –±—ã—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω –¥—Ä—É–≥–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π. // –ù–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞ config –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∏ –ø–æ—Å–ª–µ–¥—É—é—â–µ–º —á—Ç–µ–Ω–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞, // –ø–æ—ç—Ç–æ–º—É –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –Ω–∏–º –º–æ–∂–Ω–æ –∫–∞–∫ –∫ —Å–≤–æ–π—Å—Ç–≤–∞–º –æ–±—ä–µ–∫—Ç–∞. –ù–∞–ø—Ä–∏–º–µ—Ä, –≤—ã –º–æ–∂–µ—Ç–µ —Å–¥–µ–ª–∞—Ç—å —Ç–∞–∫: // const conf = config; // –∏ —Å–≤–æ–π—Å—Ç–≤–∞ conf –±—É–¥—É—Ç –æ–±–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, –Ω–æ –∏–∑–±–µ–≥–∞–π—Ç–µ –¥–µ–ª–∞—Ç—å —Ç–∞–∫: // const requestsToForge = config.requestsToForge; // –ø–æ—Å–∫–æ–ª—å–∫—É –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, requestsToForge –Ω–µ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—ë–Ω. const config = {}; Object.defineProperty(this, 'config', { get() { return config; }, enumerable: true }) this.initConfig = async function() { const fileContents = await readConfigFile(CONFIG_FILE_PATH); console.log('initConfig:'); console.log(fileContents); console.log('fileContents logged ^^'); const parsedConfigData = parseConfig(fileContents); Object.assign(config, parsedConfigData); }; async function readConfigFile(configPath) { const promise = new Promise((resolve, reject) =&gt; { fs.readFile(configPath, { encoding: 'utf8', flag: 'r' }, (err, data) =&gt; { if (err) { console.log('readConfigFile err to throw'); throw err; } resolve(data); }); }) .then( fileContents =&gt; { return fileContents; } ) .catch(err =&gt; { console.log('readConfigFile error: ', err); }); return promise; } function parseConfig(fileContents) { const configData = JSON.parse(fileContents); return configData; } // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–≥—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø—Ä–æ–≥—Ä–∞–º–º—ã, –µ—Å–ª–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª –±—ã–ª –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω –∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω. // –ù–∞ Windows, –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ fs.watch –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –¥–≤–∞–∂–¥—ã —Å –Ω–µ–±–æ–ª—å—à–∏–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º, // –ø–æ—ç—Ç–æ–º—É —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–ª–∞–≥ configReadInProgress let configReadInProgress = false; fs.watch(CONFIG_FILE_PATH, async () =&gt; { if(!configReadInProgress) { configReadInProgress = true; console.log('===== config changed, run initConfig() ====='); try { await this.initConfig(); } catch (err) { console.log('===== error initConfig(), skip =====,', err); configReadInProgress = false; } configReadInProgress = false; } else { console.log('===== config changed, initConfig() already running, skip ====='); } }); } let instance; async function getInstance() { if(!instance) { instance = new Module(); await instance.initConfig(); } return instance; } module.exports = getInstance;</span></span></code> </pre> <br><p> <em>–õ–∏—Å—Ç–∏–Ω–≥ 10. –ú–æ–¥—É–ª—å —á—Ç–µ–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏</em> </p></div></div><br><h2 id="itogo"> –ò—Ç–æ–≥–æ </h2><br><p> –ú—ã –Ω–∞–ø–∏—Å–∞–ª–∏ –Ω–µ–±–æ–ª—å—à–æ–π DNS-–ø—Ä–æ–∫—Å–∏ –Ω–∞ NodeJS, –Ω–µ –ø—Ä–∏–º–µ–Ω—è—è –ø—Ä–∏ —ç—Ç–æ–º <em>npm</em> –∏ —Å—Ç–æ—Ä–æ–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏. –•–æ—Ç—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –µ–≥–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã, —Å –∑–∞–¥–∞—á–µ–π –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –æ–Ω –≤–ø–æ–ª–Ω–µ —Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è, –∞ —Ç–∞–∫ –∂–µ, –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏, –º–æ–∂–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç—É–ø–∞—é—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏–∑—É—á–µ–Ω–∏—è. </p><br><p> <strong><a href="https://github.com/kolobok86/dns-proxy">–ü–æ–ª–Ω—ã–π –∫–æ–¥ –Ω–∞ GitHub</a></strong> </p><br><h3 id="istochniki"> –ò—Å—Ç–æ—á–Ω–∏–∫–∏: </h3><br><ul><li> <a href="https://tools.ietf.org/html/rfc1035">RFC-1035</a> DOMAIN NAMES ‚Äî IMPLEMENTATION AND SPECIFICATION </li><li> <a href="https://tools.ietf.org/html/rfc7858">RFC-7858</a> Specification for DNS over Transport Layer Security (TLS) </li><li> <a href="https://tools.ietf.org/html/rfc7766">RFC-7766</a> DNS Transport over TCP ‚Äî Implementation Requirements </li><li> <a href="https://stackoverflow.com/questions/4082081/requesting-a-and-aaaa-records-in-single-dns-query/4083071">https://stackoverflow.com/questions/4082081/requesting-a-and-aaaa-records-in-single-dns-query/4083071#4083071</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/440050/">https://habr.com/ru/post/440050/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
</ul></nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>