<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Technical support 3CX responds: configure the router for the PBX VoIP server</title>
  <meta name="description" content="If you plan to connect SIP trunks from telecom operators or remote users to the 3CX system, and your PBX is located in a private network - a static pu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-6974184241884155",
      enable_page_level_ads: true
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>Technical support 3CX responds: configure the router for the PBX VoIP server</h1><div class="post__text post__text-html js-mediator-article">  If you plan to connect SIP trunks from telecom operators or remote users to the 3CX system, and your PBX is located in a private network - a static publication (‚Äúforwarding‚Äù) of ports should be performed on the firewall. <br><br>  VoIP applications use RTP to transfer multimedia streams (audio and video).  Difficulties may arise when passing edge network devices (firewalls and routers).  This is due to the fact that RTP uses random port numbers to send and receive multimedia traffic.  An incorrect configuration of the firewall manifests itself as one-way audibility or no sound at all from a VoIP provider and remote users. <a name="habracut"></a><br><br><h2>  The problem of VoIP with symmetric NAT (Symmetric NAT) </h2><br>  When using symmetric NAT, the edge network device dynamically changes the port number to which the audio stream is received.  For example, when making an outgoing call via the operator's SIP trunk, 3CX first makes a STUN request to determine its external IP address and the current port number.  Then this address and port are transmitted to the operator's SIP-server for mutual communications.  But at this time, your firewall dynamically closes this port (which has already been transferred to the operator - indicated in the INVITE header).  There is an audio transfer failure.  Obviously, because of this feature, it is impossible to ensure reliable operation of VoIP.  In the firewall configuration guides, this technology is called symmetric NAT (Symmetric NAT). <br><img src="https://habrastorage.org/getpro/habr/post_images/bc6/850/25a/bc685025a888ee36512c638004a25b8c.png"><br><h2>  Solving the problem with one-way audibility in VoIP - Full Cone NAT </h2><br>  To solve the problem of one-way audibility (or complete "silence"), you should configure the so-called conical NAT (Full Cone NAT), which is also known as one-to-one NAT.  In it, the necessary ports on the external address of the router are mapped (or ‚Äúforwarded‚Äù) to a specific internal address (the port number is preserved).  The external host exchanges RTP packets with the internal host, sending them first to the external address of the router and the external (mapped) port. <br><img src="https://habrastorage.org/getpro/habr/post_images/eaa/03d/cc3/eaa03dcc323d2ea12c015d0a6f345838.png"><br>  In fact, the vast majority of network devices support this mode.  As a rule, it is called "Static port mapping".  Static publishing ensures that a particular port always remains open and never changes with a firewall.  Some very cheap routers incorrectly implement this function, but most, as was said, allow you to properly configure the "forwarding" of ports.  At the end of the article are examples of the appropriate configuration of various network devices. <br><br><h2>  Checking the correct operation of the firewall service 3CX Firewall Checker </h2><br>  A good way to check the configuration of a network device (finding out if you are behind Symmetric NAT and other configuration problems) is to use the 3CX Firewall Checker service. <br><br>  3CX Firewall Checker allows you to check in advance that your edge network device correctly processes VoIP traffic from SIP operators, 3CX bridges, external SIP clients and connections using 3CX Tunnel technology.  Consider a simple example of how to use this service.  For example, let's assume that the 3CX server has an address of 192.168.0.100, testing is performed on port 9500, and the external address of your network is 11.22.33.44. <br><br>  As it was said, the correct publication of the port means that any outgoing UDP packet from the PBX server with the source IP :: Port source address - 192.168.0.100::9500 should reach the recipient (usually this is the carrier‚Äôs SIP server, remote IP phone or another PBX 3CX) with the ‚Äúrewritten‚Äù source address of source IP :: Port - 11.22.33.44::9500.  Although the address is being broadcast (which is necessary for routing a packet on a public WAN), the <b>packet port does not change</b> .  In addition, any UDP packet coming from the WAN with the destination IP :: Port destination address - 11.22.33.44::9500 must reach the 3CX server with the destination IP :: Port address - 192.168.0.100::9500.  3CX Firewall Checker is just used to check the correct address translation, and also finds out another important one. <br><br>  To launch 3CX Firewall Checker, go to the 3CX management interface&gt; Home section&gt; PBX Status section&gt; click Firewall&gt; Start. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/21e/897/489/21e897489d0fe7984d4bb75f8fbfe6e3.png"><br><br>  After starting, the network tests will begin.  Depending on the type of edge device and the actual configuration, you will see the result along with troubleshooting tips. <br><br>  <b>Attention:</b> Starting 3CX Firewall Checker stops some 3CX services, so during the tests, the PBX will be unavailable.  If the port is tested successfully, it takes 1 second.  Unsuccessful testing of the port is stretched for 5-10 seconds.  By default, ports in the range of 9000 - 10999 are tested. If initially everything is configured correctly, testing will take less than a minute.  If problems arise, testing is delayed for 4-9 minutes.  However, at any time you can stop the test. <br><br>  The service uses the STUN server of 3CX, which must be installed in Settings&gt; Network&gt; Public IP.  Some firewalls may incorrectly qualify this test as port scans.  If this happens, 3CX Firewall Checker reports a problem at the very beginning of the test.  Therefore, in the firewall, you should disable the scan scan before testing. <br><br><h2>  3CX Firewall Checker Tests </h2><br>  The utility checks the correctness of the hardware configuration, making various requests to the STUN-servers.  Conducted two tests. <br><br><h3>  Internet accessibility </h3><br>  This test checks the availability of STUN servers from the 3CX server's verifiable ports.  The operation of the DNS is also checked (STUN servers in 3CX are indicated by FQDN). <br><br>  If this test fails, the following problems are possible: <br><br><ul><li>  The general problem of Internet access.  If a browser is installed on the server, try to just go to a website.  Perhaps you need to open access from the PBX server to the Internet on the ports indicated in this <a href="https://www.3cx.com/docs/ports/">manual</a> . <br></li><li>  The test may fail if the STUN server is unavailable.  Check the settings in Settings&gt; Network&gt; Public IP or use a backup server. <br></li><li>  Check which port is listed for STUN (default 3478) <br></li><li>  Ensure that the firewall on the 3CX server itself, such as Windows Firewall, allows connections to the ports under test.  Antiviruses or other security programs can also block ports.  Disable or even completely remove them from the server for the duration of the test (simple disconnection does not always help). <br></li><li>  Blocking ports can also be on the side of your Internet operator - it is worth excluding this possibility. <br></li></ul><br><h3>  The correctness of the publication of ports (Full Cone NAT) </h3><br>  This test tests the ability of the server on the Internet to communicate with the 3CX server on the internal network.  The configuration of the one-to-one port translation (Full Cone NAT) is being tested. <br><br>  3CX Firewall Checker sends a request to the STUN server from the (number) port that is being checked, and requests the STUN server to create a connection to the PBX server on this port from the external IP address.  If the second test fails, check the following settings: <br><br><ul><li>  Your firewall should have a one-to-one static port publishing rule.  Inexpensive devices, as a rule, offer only this type of rules. <br></li><li>  Some ports require a rule for both TCP and UDP traffic.  See the <a href="https://www.3cx.com/docs/ports/">list of ports required for 3CX operation</a> . <br></li></ul><br><h2>  Test results / error messages </h2><br>  We list the test results and errors returned by the Firewall Checker. <br><br>  <b>This is a port for forwarding.</b>  <b>VoIP can work.</b>  <b>This configuration is supported (Success - the port is published correctly. VoIP communications will work. This configuration is supported by 3CX).</b> <br><br>  All tests passed successfully.  Your border device allows traffic to the Internet from the tested port and correctly converts the ports one to one.  Configuration supported. <br><br>  <b>STUN server has no second address (STUN server does not have a second address).</b> <br><br>  The message appears if the STUN server is configured incorrectly in the 3CX interface.  STUN server must have two addresses.  In Settings&gt; Network&gt; Public IP, specify the following STUN servers: stun-eu.3cx.com, stun2.3cx.com, stun3.3cx.com. <br><br>  <b>Failed - No response received or port mapping is closed.</b>  <b>Port forwarding is not configured correctly. The answer is not received or the port is closed. Incorrect setting of the publication of the port.</b> <br><br>  The publication of the checked port is incorrectly configured.  In this case, VoIP operators and remote IP phones will not work.  Configure publishing ports for <a href="https://www.3cx.com/support/firewall-configuration/">these guides</a> . <br><br>  <b>Failed - Firewall check failed.</b>  <b>Some errors were detected.</b>  <b>Please check your firewall configuration and try the test again (Failed - the firewall check failed. Errors were detected. Check the firewall configuration and try again).</b> <br><br>  This message appears if some ports have passed the test, but some have not.  Pay attention to which specific ports failed the test and publish them.  Also make sure that these ports are no longer published on the router for a different internal IP address. <br><br>  <b>Failed - Malformed response received - (aka Symmetric NAT).</b>  <b>Port forwarding not correctly implemented (failed - an incorrect response was received (possibly symmetric NAT). The publication of ports was incorrectly configured).</b> <br><br>  The answer indicates that Full Cone NAT does not work correctly for you. <br><br>  <b>The STUN server did not respond or port forwarding (the STUN server did not respond or did not configure the publication of ports on the firewall).</b> <br><br>  Your STUN server is not responding.  Possible reasons: <br><br><ul><li>  The STUN server is not accessible from the 3CX server. <br></li><li>  STUN server is currently disabled. <br></li><li>  Port publishing not configured. <br></li></ul><br>  <b>STUN server address cannot be resolved (the server‚Äôs IP address is not resolved by DNS).</b> <br><br>  Could not determine the IP address of the STUN server by its name.  This may indicate problems with your DNS server, but also that this STUN server has stopped working forever. <br><br>  <b>Failed - Malformed servers STUN servers.</b>  <b>STUN servers from Settings ‚Üí Network ‚Üí External IP Configuration section Check for an Internet connection, DNS settings, or use another STUN in the Settings ‚Üí Network ‚Üí section. External IP).</b> <br><br>  The answer says that the ports are published correctly or your firewall blocks packets. <br><br>  <b>Failed - Port {0} or SIP port.</b>  <b>The 3CX Firewall checker requires the SIP port to be free (The port is being used by another application on this server OR the SIP port is used by the {0} process. The 3CX Firewall checker service requires a free SIP port.</b> <br><br>  The test port is being used by another application installed on this server.  To determine the specific process run the command <br><br> <code>netstat -ano | findstr /I /C:"PID" /C:":9500"</code> <br> <br>  where 9500 is the port number.  In the PID column, you will see the process ID.  Use Task Manager to identify the process.  You can also execute the command <br><br> <code>tasklist /fi "pid eq 4"</code> <br> <br>  where 4 is the process ID. <br><br>  <b>STUN servers are not reachable.</b>  <b>Cannot perform Firewall check.</b>  <b>This configuration is not supported (STUN servers are unavailable. Cannot perform firewall check. Configuration is not supported).</b> <br><br>  STUN servers configured in the 3CX interface are not available.  As a rule, this is due to problems with Internet access.  In Settings&gt; Network&gt; Public IP, specify the following STUN servers: stun-eu.3cx.com, stun2.3cx.com, stun3.3cx.com. <br><br><h3>  Additional Information </h3><br><ul><li>  <a href="https://ru.wikipedia.org/wiki/NAT">Different types of NAT</a> <br></li><li>  <a href="https://www.asteriskguru.com/tutorials/sip_nat_oneway_or_no_audio_asterisk.html">Work NAT and VoIP</a> <br></li><li>  <a href="https://www.3cx.com/docs/configuring-lancom-firewall/">Lancom firewall</a> <br></li><li>  <a href="https://www.3cx.com/docs/sonicwall-firewall-configuration/">Sonic firewall</a> <br></li><li>  <a href="https://www.3cx.com/docs/draytek-firewall-configuration/">Draytek 2820</a> <br></li><li>  <a href="https://www.3cx.com/docs/zyxel-router-configuration/">Zyxel P-662H-D1</a> <br></li><li>  <a href="https://www.3cx.com/docs/avm-fritzbox-firewall-configuration/">AVM FritzBox</a> <br></li><li>  <a href="https://www.3cx.com/docs/cisco-router-configuration/">CISCO</a> <br></li><li>  <a href="https://www.3cx.com/docs/fortigate-firewall-configuration/">FortiGate 80C</a> <br></li><li>  <a href="https://www.3cx.com/docs/watchguard-xtm-firewall/">WatchGuard XTM</a> <br></li><li>  <a href="https://www.3cx.com/docs/pfsense-firewall/">pfSense</a> <br></li><li>  <a href="https://www.3cx.com/docs/kerio-control-appliance-configuration/">Kerio control</a> <br></li><li>  <a href="https://www.3cx.com/docs/mikrotik-firewall-configuration/">MikroTik</a> <br></li></ul></div><p>Source: <a href="https://habr.com/ru/post/437442/">https://habr.com/ru/post/437442/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>