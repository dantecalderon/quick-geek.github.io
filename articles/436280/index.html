<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Implementing honeypot on Cisco routers</title>
  <meta name="description" content="I had the idea to make some kind of fail2ban package on the Cisco router, using only the router's own tools. 

 It works like this. In the access list...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-6974184241884155",
      enable_page_level_ads: true
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>Implementing honeypot on Cisco routers</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/w8/x1/n-/w8x1n-0iyfkeg1-5jzexhxudfrq.jpeg"><br><br>  I had the idea to make some kind of fail2ban package on the Cisco router, using only the router's own tools. <br><br>  It works like this.  In the access list attached to the interface of the border Internet router, trap rules are created.  When the rule is triggered, an event is recorded in the log.  Each line of such an event contains a special label to make it easier to select.  The log is analyzed, and all trapped IP addresses are entered into a special object group.  This group can be used in the same access list to block hackers from accessing all the IP addresses and ports of our network. <br><br>  To understand this article, you need to know what access lists are and what they are for, as well as how to use object groups in access lists. <br><a name="habracut"></a><br><h4>  Access list traps </h4><br>  For example, we will write a rule for the incoming access list, under which all attempts to get from the Internet to the telnet port of our devices fall.  Please note that at the end of the rule, a unique label ‚ÄúHONEYPOT001‚Äù is affixed.  According to it, then we will look for triggers in the log. <br><br><pre><code class="plaintext hljs">ip access-list extended acl-WAN-In ‚Ä¶ deny tcp any any eq telnet log HONEYPOT001 ‚Ä¶</code> </pre> <br>  It is important to choose the right criteria for traps. <br><br>  Attempts to connect from the outside on port 23 (telnet) are perhaps the most common.  In this case, the object group will be instantly filled with the IP addresses of bots from all over the Internet, and the memory allocated for access lists will simply end. <br><br>  You can catch attempts to connect to your equipment on port 22 (ssh).  They are an order of magnitude smaller than telnet.  You can catch attempts to access any one of your device. <br><br>  A large number of bots climbs on port 7547, trying to connect using the CPE WAN Management protocol. <br><br>  Another option would be to catch attempts to use the Smart Install Client, enabled on port 4786. <br><br>  Also, you can make a trap on port 80 by selecting an IP address where you do not have a web server.  The main thing is that the search engine robots should not fall into it. <br><br>  Here is an example of a trap on an IP address [192.0.2.10]. <br><br><pre> <code class="plaintext hljs">ip access-list extended acl-WAN-In ‚Ä¶ deny tcp any host 192.0.2.10 eq www log HONEYPOT002 ‚Ä¶</code> </pre><br><h4>  Log Analysis </h4><br>  Logging on the router, of course, must be enabled beforehand, then something like this gets into the log: <br><br><pre> <code class="plaintext hljs">225435: Jan 11 08:57:13.838: %SEC-6-IPACCESSLOGP: list acl-WAN-In denied tcp 123.199.32.7(59472) -&gt; 192.0.2.9(23), 1 packet [HONEYPOT001]</code> </pre> <br>  We see that from an external IP address [123.199.32.7] an attempt was made to contact the 23rd port of our IP address [192.0.2.9].  The label "HONEYPOT001" in the line is also present.  By the way, [123.199.32.7] is a real attacker caught while writing an article. <br><br>  To analyze the log, we will use Embedded Event Manager (EEM) - a tool for automating tasks and customizing software behavior built into Cisco IOS. <br><br>  In the configuration mode of the router, we create an applet that analyzes the log and, while in the log line of the ‚ÄúHONEYPOT001‚Äù tag, cuts the attacker's IP address and adds this address to the BlackList object group. <br><br><pre> <code class="plaintext hljs">event manager applet honeypot event syslog occurs 1 pattern "HONEYPOT001" action 100 regexp "([0-9]+\.[0-9]+\.[0-9]+\.[0-9]+)" "$_syslog_msg" result IP_address action 200 if $_regexp_result eq "1" action 210 cli command "enable" action 220 cli command "conf t" action 230 cli command "object-group network hosts-BlackList" action 240 cli command "h $IP_address" action 250 cli command "end" action 260 syslog msg "IP address $IP_address added to blacklist" action 270 end action 300 cli command "exit"</code> </pre><br><ul><li>  when the next line with the label ‚ÄúHONEYPOT001‚Äù occurs in the log, an event occurs; </li><li>  in the event handler itself, from the log line using the pattern ‚Äú([0-9] + \. [0-9] + \. [0-9] + \. [0-9] +)‚Äù, the attacker's IP address is cut out and assigned IP_address variable (action 100); </li><li>  if the address is successfully cut out, and no problems with parsing the string happened (action 200), then console commands are executed that add the IP address to the object group (action 210 - 250); </li><li>  A trap is written to the log (action 260). </li></ul><br><h4>  Access lock </h4><br>  The first thing that comes to mind is to use the object group to completely block intruders to all resources of our network. <br><br>  The blocking rule must be in the access list above the rule with a trap so that the banned IP address does not fall into the trap again and again. <br><br><pre> <code class="plaintext hljs">ip access-list extended acl-WAN-In ‚Ä¶ deny ip object-group hosts-BlackList any ‚Ä¶ deny tcp any any eq telnet log HONEYPOT001 ‚Ä¶</code> </pre><br><h4>  Amnesty </h4><br>  Sooner or later, the object group will exceed all permissible sizes, so you will have to do an amnesty by cleaning out old IP addresses from it.  To do this, we write an applet that will do this, for example, once a week at midnight on Sunday. <br><br>  On the way of writing, we will meet two pitfalls. <br><br>  You cannot delete an object group that is used in the access list.  Therefore, you first need to find out the row number of the access list in which the group is used.  In our example, this is line 60. We will use this number to remove the line with the group from the access list, and then return it back to its original place. <br><br>  Cannot create an empty object group.  Therefore, immediately when creating a group, we will add an IP address to it [255.255.255.255].  This address is never forwarded by routers that connect the local network to other networks, so we do not expect connections from it. <br><br><pre> <code class="plaintext hljs">event manager applet DeleteBlackList event timer cron name timer-cron1 cron-entry "@weekly" action 100 cli command "enable" action 200 cli command "conf t" action 210 cli command "ip access-list ext acl-WAN-In" action 215 cli command "no 60" action 220 cli command "exit" action 225 cli command "no object-group net hosts-BlackList" action 230 cli command "object-group net hosts-BlackList " action 240 cli command "host 255.255.255.255" action 245 cli command "exit" action 250 cli command "ip access-list ext acl-WAN-In" action 255 cli command "60 deny ip object-group hosts-BlackList any" action 260 cli command "exit" action 265 cli command "end" action 300 syslog msg "Completed" action 400 cli command "exit"</code> </pre><br><ul><li>  remove from the access list the rule with the object group.  (action 210 - 220); </li><li>  delete the group itself (action 225); </li><li>  we create the object group again, and insert the broadcast IP address into it.  (action 230 - 245); </li><li>  we return to the access list the rule for the old place.  (action 250 - 260). </li></ul><br><h4>  What to do if tags in the access list are not supported </h4><br>  Many IOSs, despite the fact that the ‚ÄúACL Syslog Correlation‚Äù function is stated in them, do not allow to mark lines of access lists with labels. <br><br>  In this case, you can use the so-called generated hash values.  (device-generated hash value) to be added to the log message lines. <br><br>  If IOS-does not support both options, then it is necessary to complicate analysis a little. <br>  Modify the rule with a trap in the access list.  Instead of ‚Äúlog‚Äù we will use ‚Äúlog-input‚Äù. <br><br><pre> <code class="plaintext hljs">ip access-list extended acl-WAN-In ‚Ä¶ deny tcp any any eq telnet log-input ‚Ä¶</code> </pre><br>  In this case, the log will additionally receive information about the name of the physical interface and, possibly, the MAC address of the router-neighbor that sent the packet. <br>  For example, the following message appears in the log: <br><br><pre> <code class="plaintext hljs">Jan 11 00:20:23 172.25.100.43 2394768: Jan 10 20:20:22.808: %FMANFP-6-IPACCESSLOGP: SIP1: fman_fp_image: list acl-WAN-In denied tcp 123.199.32.7(7537) Port-channel1.88-&gt; 192.0.2.9(23), 1 packet</code> </pre> <br><br>  Then the rule for activating an event will look like this: <br><br><pre> <code class="plaintext hljs">event syslog occurs 1 pattern "Port-channel1\.88-&gt; 192\.0\.2\."</code> </pre><br><h4>  What to read </h4><br>  About the unique identification of the rules that generated the message in the log: <br>  <a href="https://www.cisco.com/c/en/us/td/docs/ios-xml/ios/sec_data_acl/configuration/15-sy/sec-data-acl-15-sy-book/sec-acl-syslog.pdf">ACL Syslog Correlation</a> <br><br>  About Embedded Event Manager: <br>  <a href="https://www.cisco.com/c/en/us/td/docs/ios-xml/ios/eem/configuration/15-mt/eem-15-mt-book.pdf">Embedded Event Manager Configuration Guide</a> </div><p>Source: <a href="https://habr.com/ru/post/436280/">https://habr.com/ru/post/436280/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>