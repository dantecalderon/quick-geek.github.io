<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Where more than 20 million transport cards in Russia are vulnerable: disassemble and develop MIFARE Classic</title>
  <meta name="description" content="The MIFARE Classic contactless card standard was created more than 20 years ago and, despite a number of vulnerabilities found since then, is still wi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>Where more than 20 million transport cards in Russia are vulnerable: disassemble and develop MIFARE Classic</h1><div class="post__text post__text-html js-mediator-article">  The MIFARE Classic contactless card standard was created more than 20 years ago and, despite a number of vulnerabilities found since then, is still widely used (particularly in Moscow and St. Petersburg).  In this article, we will recall what vulnerabilities were found and describe how they can be fixed. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ead/64e/f3a/ead64ef3ac72b887d38f83510bc7e2a4.png"><br>  <i>Source: Instagram <a href="https://www.instagram.com/pro.ticketing/">@ pro.ticketing</a></i> <br><br>  Traditionally for such articles we recall that in Russia the falsification and sale of tickets are prosecuted by law (Art. 327 and 165 of the Criminal Code of the Russian Federation), and we urge readers to remain on the bright side of power. <br><a name="habracut"></a><br><h2>  MIFARE Classic structure </h2><br>  The NIFP MIFARE Classics Standard is a whole family of cards.  It includes MIFARE Classic 1K, 4K, EV1 1K, EV1 4K, MIFARE ID, MIFARE Mini.  This standard can also be emulated by other, newer NXP cards (MIFARE Plus, JCOP and others). <br><br>  The card's work with readers is based on the ISO 14443A standard, the frequency is 13.56 MHz. <br>  MIFARE Classic 1K cards provide a memory area organized into sectors of 64 bytes.  Each sector is divided into 4 blocks of 16 bytes: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7df/c4a/96e/7dfc4a96e4b1676475107b013d9de471.png"><br><br>  For 4K cards, the first 2048 bytes are organized into 32 sectors of 64 bytes, and the rest into 8 sectors of 256 bytes (or 16 blocks).  The last block of each sector is called the sector trailer, it contains the keys and parameters of access to the sector.  Zero sector zero block is a special block that is locked for writing; it contains the identifier and information of the card manufacturer.  In order for one card to have several different applications - for example, a social card with information about benefits, tickets for the metro and train - in the remaining blocks of sector zero, it is recorded how each sector is used - <a href="https://www.nxp.com/docs/en/application-note/AN10787.pdf">MIFARE Application Directory (MAD)</a> . <br><br>  Before accessing the sector for reading or writing, it is necessary to perform authorization using a 6-byte key.  Authorization takes place on a three-stage protocol, close to that described in chapter 5.2.2.  ISO / IEC 9798-2: 1999.  It uses the proprietary stream encryption algorithm CRYPTO1: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f50/082/120/f500821205a71e2f902686e973559cec.png"><br><br><ol><li>  The reader sends an authorization request, indicating the sector number to which authorization occurs. <br></li><li>  The card reads the access key from the internal memory, generates a random sequence and returns it to the reader. <br></li><li>  The reader calculates the response using the sector access key and the CRYPTO1 encryption algorithm, then sends it with a newly generated random sequence. <br></li><li>  The card checks the response calculated by the reader.  It then computes the answer to the read device call and returns it. <br></li><li>  The reader checks the response from the card. <br></li></ol><br>  Further transfer of the contents of the sectors is carried out in an encrypted form.  If you need to authorize to another sector (the so-called secondary authorization), then re-authorization is performed.  The main difference is that the entire exchange is encrypted first with the old and then with the new key. <br><br><h2>  MIFARE Classic Known Vulnerabilities </h2><br>  Cryptography cards are well researched.  The vulnerability of the implementation of the pseudo-random number generator (PRNG) card and the vulnerability of the CRYPTO1 algorithm is found.  In practice, these vulnerabilities are used in the following attacks: <br><br><ol><li>  <i>Dark side</i> - attack uses PRNG vulnerability.  Works on generation MIFARE Classic cards up to EV1 (in EV1 the PRNG vulnerability has already been eliminated).  To attack you need only a map, you do not need to know the keys. <br></li><li>  <i>Nested</i> - the attack exploits the CRYPTO1 vulnerability.  The attack is made on secondary authorizations, so for the attack you need to know one valid card key.  In practice, for the zero sector, standard keys are often used for the operation of the MAD ‚Äî they begin with it.  Works for any cards on CRYPTO1 (MIFARE Classic and its emulation).  The attack was demonstrated in the article ‚ÄúThe vulnerability of the Plantain map: free trips in land transport in St. Petersburg.‚Äù <br></li><li>  <i>Attack listening exchange</i> - the attack uses a vulnerability CRYPTO1.  To attack, you need to overhear the primary authorization between the reader and the card.  For this you need special equipment.  Works for any cards on CRYPTO1 (MIFARE Classic and its emulation).  The attack is demonstrated in the article "Hacking transport cards" Citycard "(Nizhny Novgorod)." <br></li></ol><br>  All this in practice allows you to get access keys to all sectors of the map, having only the map initialized with access keys.  Then a replay attack on the contents of the card can be carried out or a clone of the card can be made on special blanks with a rewritable card identifier. <br><br>  In addition, there is a vulnerability of access key infrastructure.  Since cryptography on CRYPTO1 is implemented on the side of the card reader (CRYPTO1 is implemented only in hardware), it follows that the access keys: <br><br><ul><li>  either transferred to the reader before working with the card, <br></li><li>  either stored on the reader itself in secure hardware storage (for example, <a href="https://www.mifare.net/ru/%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B4%25D1%2583%25D0%25BA%25D1%2586%25D0%25B8%25D1%258F/infrastructure-components/mifare-sam/">MIFARE SAM</a> ), <br></li><li>  or stored in read-only memory. <br></li></ul><br>  And if in special equipment such as information terminals or turnstiles, you can use secure hardware key storage, in the case of an Android application, only the option of transferring keys and storage in the device‚Äôs memory remains.  This makes it possible to intercept these keys by hacking the application or analyzing the application traffic.  What was demonstrated in the article "Research of the security of the Troika card". <br><br><h2>  Methods of dealing with vulnerabilities MIFARE Classic </h2><br><h3>  Key diversification </h3><br>  Diversification is the process of obtaining access keys on the master key using some unique input data for the card.  The process of obtaining keys can be implemented in the application software that works with reading devices, or using the SAM-module. <br><br>  For example, this might work like this: <br><br><ol><li>  As input for diversification, the card identifier and sector number, the key to which we want to get, is used; <br></li><li>  This data is encrypted (in the SAM module or application software) by the master key, the result is truncated to 6 bytes and used as the access key to the corresponding sector. <br></li></ol><br><img src="https://habrastorage.org/getpro/habr/post_images/3f7/2b1/cce/3f72b1ccefbba8c00b7cd616ade87c4d.png"><br><br>  As a result, each card receives its unique sector access keys.  Even if the keys for some specific cards are compromised, it will not lead to the massive use of these keys.  But it must be understood that diversification is a half-measure and does not protect against the breaking of single cards and the possibility of modifying an Android application in order to intercept and use diversified keys. <br><br><h3>  Transition to MIFARE Plus and SL3 security level </h3><br>  To solve the CRYPTO1 vulnerability issues, the MIFARE Plus family of cards has been developed.  The cards are similar in structure to MIFARE Classic, only the cryptography of cards has been updated.  They can work in two modes: <br><br><ol><li>  MIFARE Classic emulation mode (this mode of operation is called Security level 1 or SL1), which allows them to be used on the existing infrastructure of card reader devices and does not require modifications to the software that works with the cards; <br></li><li>  Security level 3 (SL3) mode, which requires authorization to the sectors and encryption of data exchange using the AES algorithm with the optional addition of imitations. <br></li></ol><br>  These cards have eliminated the PRNG vulnerability and, thus, in SL1 mode, these cards are still vulnerable to attacks on CRYPTO1, and in SL3 mode there are currently no known attacks. <br><br>  Unlike SL1, in SL3 authorization and encryption can be implemented in software.  Thanks to this, you can protect yourself from intercepting keys through an Android client.  To do this, the server must perform authentication and encryption.  Then the keys do not leave the server, and the Android client simply proxies requests and responses from the card.  This will require the application to connect to the Internet, which can be inconvenient, so you can configure the card so that the sector is read with one key and write with another key.  Then the user will be able to view information about the card while being offline, and can only replenish the balance or buy tickets for it online. <br><br>  Do not forget that for AES keys you can make diversification by modifying the algorithm on the keys with a length of 16 bytes. <br><br>  Existing transport cards based on MIFARE Plus SL1 cards can be transferred to SL3 mode in two stages: <br><br><ol><li>  The infrastructure of devices that work with cards (turnstiles, ticket booths, vending machines, terminals) is being prepared for use with MIFARE Plus.  The software for reading devices in the work with maps is being finalized. <br></li><li>  Already issued transport cards based on the MIFARE Plus are transferred to SL3 mode - this can occur during normal use of the card, for example, passing through a turnstile or attaching a card to an information terminal.  The process of transferring the card is invisible to the passenger and takes about 100 ms. <br></li></ol><br><h3>  Switch to MIFARE DESFire </h3><br>  The cryptography of the MIFARE DESFire card is similar to that of MIFARE Plus - before working with the application, a three-step authorization is performed using one of the algorithms to choose a card issuer: DES, 3DES, AES.  Further exchange with the card is in encrypted form with optional imitations. <br><br>  The card is functionally different from MIFARE Classic.  Memory card is organized into a file system.  There may be several applications on the map, each application may have several files. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f4c/230/8de/f4c2308dede5fd7846e84d08b920f14e.png"><br><br>  Work with the card begins with the choice of the application by its identifier and authorization to it.  Next comes the work with files - create, delete, read, write.  Files can be of different types, for example, flat memory, wallet balance, cyclically rewritable file. <br><br>  The main difficulty of the transition is that you need to upgrade the software that works with maps.  It is necessary to move from the use of memory, divided into sectors, to applications and files, and, accordingly, change the authorization order from sectors to authorization to the application and / or files.  From a hardware point of view, the cards impose the same restriction on the reader infrastructure as MIFARE Plus. <br>  The advantage over MIFARE Plus is that, based on MIFARE DESFire, it is easier to implement multi-brand cards - different combinations of cards on one carrier: Troika-Arrow, Troika-Plantain, social cards with the ability to record tickets for transport).  On MIFARE Plus, this is achieved through administrative allocation of sectors on the map for different applications.  Here, each system can work with the application that it needs, and may not know that there are some other applications on the map.  The second advantage is that additional file types allow you to implement some special scenarios - for example, replenish the wallet balance with one access key, and spend money from the balance with another access key or return the amount within the spent one. <br><br>  Today, SIM card manufacturers (STM, Gemalto, G &amp; D, Oberthur) have commercially available SIM cards and embedded security features with MIFARE DESFire emulation. <br><br>  The Oyster Card (London Public Transport Transport Card) was transferred to MIFARE DESFire in 2009; since 2010, MIFARE Classic cards have not been used.  The SUBE (Argentina) transport card is in the process of transition to MIFARE Plus SL3.  In Dublin public transport, 3 types of cards: Luas (trams), Dublin Bus and DART (suburban railway transport) - were built on the basis of the MIFARE Classic and were replaced with one Leap card already on the basis of the MIFARE DESFire.  Modern transport solutions are often initially built on protected media. <br><br><h3>  Transition to other transport cards (CALYPSO, CIPURSE, FeliCa) </h3><br>  From a security point of view, these cards are similar to MIFARE Plus and DESFire cards - AES-based cryptography, three-step authorization, working with imitations, secure hardware storage ( <a href="https://en.wikipedia.org/wiki/Secure_access_module">Secure Access Module (SAM))</a> , a number of cards can emulate MIFARE Classic.  They also work on the basis of the ISO / IEC 14443A standard. <br><br><h2>  MIFARE - champion </h2><br><img src="https://habrastorage.org/getpro/habr/post_images/0bf/cc9/df4/0bfcc9df43013b5ed8bbdbb61a7d1fd6.png"><br>  <i>ABI Research Q1 2017</i> <br><br>  The share of MIFARE cards in transport in the world was 75% in 2017 and, according to forecasts, by 2021 it will not fall below 70%. <br><br>  The share of MIFARE in the world is reduced mainly due to the growth of Other cards, which, first of all, include bank cards (EMV) and card virtualization (switching to smartphones) to replace the function of the ticket carrier.  Bank cards are better protected than transport cards - but you have to pay for it.  Bank card servicing requires online, reading devices cost more due to banking certification requirements, the transport operator loses cash flow from replenishing its transport cards.  All this creates a certain balance of power, thanks to which both standards (MIFARE and EMV) find their niches and occupy them. <br><br>  The volume of transport cards on standards other than NXP (Calypso, CIPURSE) is now less than 5%.  Basically, these technologies are concentrated in countries where maps have historically developed - Japan and France - and do not go beyond them.  This is understandable - the creation of a local ecosystem of production and support of maps is not always economically viable and must be supported by a sales market.  It is possible that Russia will join a number of countries that have supported these standards.  To do this, first of all you need a political solution. <br><br>  The links below provide additional information about Mifare Classic: <br><br><ul><li>  <a href="https://www.nxp.com/docs/en/data-sheet/MF1S50YYX_V1.pdf">MIFARE Classic EV1 1K short data sheet</a> <br></li><li>  <a href="https://www.nxp.com/docs/en/data-sheet/MF1P_H_X1Y1_SDS.pdf">MIFARE Plus EV1 short data sheet</a> <br></li><li>  <a href="http://www.proxmark.org/files/Documents/13.56%2520MHz%2520-%2520MIFARE%2520Classic/Implementing_an_RFID_MIFARE_CLASSIC_Attack.pdf">Implementing an RFID 'Mifare Classic' Attack</a> <br></li><li>  <a href="http://cs.ru.nl/~rverdult/Ciphertext-only_Cryptanalysis_on_Hardened_Mifare_Classic_Cards-CCS_2015.pdf">Ciphertext-only Cryptanalysis on Hardened Mifare Classic</a> <br></li><li>  <a href="https://www.nxp.com/docs/en/application-note/AN10922.pdf">Symmetric key diversifications</a> <br></li></ul><br><h2>  Conclusion </h2><br>  We will be happy to answer questions in the comments on the article and on Instagram <i><a href="https://www.instagram.com/pro.ticketing/">@ pro.ticketing</a></i> .  In January 2019, our company opened a number of <b>vacancies</b> for a new project in the transport area in Moscow, including the ability to attract <b>teams of 3-4 people</b> .  The <b>accelerator of start-ups</b> in the field of new technologies for payment and validation of travel in public transport has been opened. <br><br><ul><li>  <a href="https://hh.ru/vacancy/20580563">Architect</a> <br></li><li>  <a href="https://hh.ru/vacancy/29681849">Timlid c #</a> <br></li><li>  <a href="https://hh.ru/vacancy/29681855">Lead C # ASP.NET CORE Programmer</a> <br></li><li>  <a href="https://hh.ru/vacancy/29681842">Lead Programmer .NET C # Backend</a> <br></li></ul></div><p>Source: <a href="https://habr.com/ru/post/437414/">https://habr.com/ru/post/437414/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>