<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Synthetic symbols and modules (WinDbg / DbgEng)</title>
  <meta name="description" content="In this publication, we discuss the synthetic modules and symbols of the Windows debugging engine (debugger engine). That is, about entities that can ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-6974184241884155",
      enable_page_level_ads: true
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>Synthetic symbols and modules (WinDbg / DbgEng)</h1><div class="post__text post__text-html js-mediator-article"><p>  In this publication, we discuss the synthetic modules and symbols of the Windows debugging engine (debugger engine).  That is, about entities that can be artificially added to the debugger for <em>coloring</em> memory addresses. </p><br><p><img src="https://habrastorage.org/webt/it/zq/x2/itzqx23xm_48b5cu4ues9blvojk.png"></p><a name="habracut"></a><br><h2 id="sinteticheskie-moduli">  Synthetic modules </h2><br><p>  In general, a <a href="https://docs.microsoft.com/windows-hardware/drivers/debugger/modules">module</a> within the debugging engine (debugger engine) is a certain continuous area of ‚Äã‚Äãvirtual memory: the base address of the module (the address of the first byte of the projected file) and its size.  For each type of debugging (live debugging / dump analysis, user mode / kernel mode, etc.), the debugger has its own mechanism for reading and keeping up to date the list of loaded modules.  The easiest way to force the updating of the list of loaded modules is with <a href="https://docs.microsoft.com/windows-hardware/drivers/debugger/-reload--reload-module-">the .reload command with the / s parameter</a> . </p><br><p>  If we talk, for example, about live debugging of the user-mode process, the list of loaded modules is based on <a href="">three main loader lists</a> : the module loading order list (InLoadOrderModuleList), the list of modules in memory (InMemoryOrderModuleList) and the initialization order list (InInitializationOrderModuleList).  On the one hand, we ( <a href="https://habr.com/ru/post/358650/">almost</a> ) do not interfere with taking arbitrary data (from a <abbr title="Portable executable">PE</abbr> file on a disk, for example) and manually marking it in memory for execution.  On the other hand, the removal techniques of a <abbr title="Dynamic Link Library">DLL</abbr> loaded with regular tools from the above-mentioned three bootloader lists (hiding a module) have long been known. </p><br><p>  In both cases, when debugging such a situation, it will be useful to be able to mark the area of ‚Äã‚Äãthe hidden module.  For this fit synthetic modules.  As a practical experiment, you can simply force WinDbg to discard the loaded module from its internal list with the same <a href="https://docs.microsoft.com/windows-hardware/drivers/debugger/-reload--reload-module-">.reload</a> command <a href="https://docs.microsoft.com/windows-hardware/drivers/debugger/-reload--reload-module-">, but with the / u parameter</a> . </p><br><p>  Next, as the listed listings, I will use the usual debugging process of the user mode (notepad.exe).  First, let's remember the base address of the ntdll module (0x07ffa8a160000) and calculate its size (0x01e1000): </p><br><pre><code class="plaintext hljs">0:007&gt; lm m ntdll Browse full module list start end module name 00007ffa`8a160000 00007ffa`8a341000 ntdll 0:007&gt; ? 00007ffa`8a341000-00007ffa`8a160000 Evaluate expression: 1970176 = 00000000`001e1000</code> </pre> <br><p>  Consider the <a href="https://docs.microsoft.com/windows-hardware/drivers/debugger/uf--unassemble-function-">list of the</a> simple function RtlFreeSid from the ntdll module, which calls the function RtlFreeHeap from this module, simultaneously remembering the addresses of the characters RtlFreeSid and RtlFreeHeap (0x7ffa8a1cbc20 and 0x7ffa8a176df0): </p><br><pre> <code class="plaintext hljs">0:007&gt; uf ntdll!RtlFreeSid ntdll!RtlFreeSid: 00007ffa`8a1cbc20 4053 push rbx 00007ffa`8a1cbc22 4883ec20 sub rsp,20h 00007ffa`8a1cbc26 488bd9 mov rbx,rcx 00007ffa`8a1cbc29 33d2 xor edx,edx 00007ffa`8a1cbc2b 65488b0c2560000000 mov rcx,qword ptr gs:[60h] 00007ffa`8a1cbc34 4c8bc3 mov r8,rbx 00007ffa`8a1cbc37 488b4930 mov rcx,qword ptr [rcx+30h] 00007ffa`8a1cbc3b e8b0b1faff call ntdll!RtlFreeHeap (00007ffa`8a176df0) 00007ffa`8a1cbc40 33c9 xor ecx,ecx 00007ffa`8a1cbc42 85c0 test eax,eax 00007ffa`8a1cbc44 480f45d9 cmovne rbx,rcx 00007ffa`8a1cbc48 488bc3 mov rax,rbx 00007ffa`8a1cbc4b 4883c420 add rsp,20h 00007ffa`8a1cbc4f 5b pop rbx 00007ffa`8a1cbc50 c3 ret</code> </pre> <br><p>  Also, according to the above listing, it is easy to calculate the size of the function ntdll! RtlFreeSid: </p><br><pre> <code class="plaintext hljs">0:007&gt; ? 00007ffa`8a1cbc51 - 0x07ffa8a1cbc20 Evaluate expression: 49 = 00000000`00000031</code> </pre> <br><p>  And the size of the function ntdll! RtlFreeHeap is not important for our experiment, so for simplicity we can take it equal to one byte. </p><br><p>  Now simulate hiding the ntdll module: </p><br><pre> <code class="plaintext hljs">0:007&gt; .reload /u ntdll Unloaded ntdll</code> </pre> <br><p>  The field of this work with the address of the function ntdll! RtlFreeSid in the debugger is not so informative (and you can already access the beginning of the function only at the virtual address): </p><br><pre> <code class="plaintext hljs">0:007&gt; uf 00007ffa`8a1cbc20 00007ffa`8a1cbc20 4053 push rbx 00007ffa`8a1cbc22 4883ec20 sub rsp,20h 00007ffa`8a1cbc26 488bd9 mov rbx,rcx 00007ffa`8a1cbc29 33d2 xor edx,edx 00007ffa`8a1cbc2b 65488b0c2560000000 mov rcx,qword ptr gs:[60h] 00007ffa`8a1cbc34 4c8bc3 mov r8,rbx 00007ffa`8a1cbc37 488b4930 mov rcx,qword ptr [rcx+30h] 00007ffa`8a1cbc3b e8b0b1faff call 00007ffa`8a176df0 00007ffa`8a1cbc40 33c9 xor ecx,ecx 00007ffa`8a1cbc42 85c0 test eax,eax 00007ffa`8a1cbc44 480f45d9 cmovne rbx,rcx 00007ffa`8a1cbc48 488bc3 mov rax,rbx 00007ffa`8a1cbc4b 4883c420 add rsp,20h 00007ffa`8a1cbc4f 5b pop rbx 00007ffa`8a1cbc50 c3 ret</code> </pre> <br><p>  In order to add a synthetic module, you need to call the <a href="https://docs.microsoft.com/windows-hardware/drivers/ddi/content/dbgeng/nf-dbgeng-idebugsymbols3-addsyntheticmodule">IDebugSymbols3 :: AddSyntheticModule</a> program interface. <del>  There are simply no built-in commands that would allow you to make this call (to my knowledge). </del>  <a href="https://githomelab.ru/izmmisha">Mikhail I. Izmestev</a> suggested that there is a similar mechanism - the same <a href="https://docs.microsoft.com/windows-hardware/drivers/debugger/-reload--reload-module-">.reload</a> , but with the name, address and size parameters: "Module = Address, Size" (and, perhaps, it is implemented on synthetic modules). </p><br><div class="spoiler">  <b class="spoiler_title">.reload ntdll = 00007ff8`470e1000,001e1000</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">0:007&gt; .reload ntdll=00007ff8`470e1000,001e1000 *** WARNING: Unable to verify timestamp for ntdll *** ERROR: Module load completed but symbols could not be loaded for ntdll 0:007&gt; uf 00007ff8`4714bc20 ntdll+0x6ac20: 00007ff8`4714bc20 4053 push rbx 00007ff8`4714bc22 4883ec20 sub rsp,20h 00007ff8`4714bc26 488bd9 mov rbx,rcx 00007ff8`4714bc29 33d2 xor edx,edx 00007ff8`4714bc2b 65488b0c2560000000 mov rcx,qword ptr gs:[60h] 00007ff8`4714bc34 4c8bc3 mov r8,rbx 00007ff8`4714bc37 488b4930 mov rcx,qword ptr [rcx+30h] 00007ff8`4714bc3b e8b0b1faff call ntdll+0x15df0 (00007ff8`470f6df0) 00007ff8`4714bc40 33c9 xor ecx,ecx 00007ff8`4714bc42 85c0 test eax,eax 00007ff8`4714bc44 480f45d9 cmovne rbx,rcx 00007ff8`4714bc48 488bc3 mov rax,rbx 00007ff8`4714bc4b 4883c420 add rsp,20h 00007ff8`4714bc4f 5b pop rbx 00007ff8`4714bc50 c3 ret</code> </pre> </div></div><br><p>  Well, we'll use the debugger extension, and then <a href="https://githomelab.ru/pykd/pykd">pykd</a> will come to the <a href="https://githomelab.ru/pykd/pykd">rescue</a> <img src="https://habrastorage.org/webt/kz/-m/2t/kz-m2tie3aamd7obq0j1pmczjn8.png">  .  In the most recent (at the time of writing) release <a href="">0.3.4.3</a> , functions for managing synthetic modules were added: <strong>addSyntheticModule</strong> (...) (which is needed in our case) and <strong>removeSyntheticModule</strong> (...). </p><br><p>  According to the previously memorized base address and module size, we add information about the <em>hidden</em> ntdll module to the debugger (if an error occurs, an exception will be thrown, so silent execution is a sign of success, printing warnings can be ignored): </p><br><pre> <code class="plaintext hljs">0:007&gt; !py Python 2.7.15 (v2.7.15:ca079a3ea3, Apr 30 2018, 16:30:26) [MSC v.1500 64 bit (AMD64)] on win32 Type "help", "copyright", "credits" or "license" for more information. (InteractiveConsole) &gt;&gt;&gt; addSyntheticModule(0x07ffa8a160000, 0x01e1000, 'ntdll') *** WARNING: Unable to verify timestamp for ntdll &gt;&gt;&gt; exit()</code> </pre> <br><p>  Now the disassembler listing has become a bit more informative: </p><br><pre> <code class="plaintext hljs">0:007&gt; uf 00007ffa`8a1cbc20 ntdll+0x6bc20: 00007ffa`8a1cbc20 4053 push rbx 00007ffa`8a1cbc22 4883ec20 sub rsp,20h 00007ffa`8a1cbc26 488bd9 mov rbx,rcx 00007ffa`8a1cbc29 33d2 xor edx,edx 00007ffa`8a1cbc2b 65488b0c2560000000 mov rcx,qword ptr gs:[60h] 00007ffa`8a1cbc34 4c8bc3 mov r8,rbx 00007ffa`8a1cbc37 488b4930 mov rcx,qword ptr [rcx+30h] 00007ffa`8a1cbc3b e8b0b1faff call ntdll+0x16df0 (00007ffa`8a176df0) 00007ffa`8a1cbc40 33c9 xor ecx,ecx 00007ffa`8a1cbc42 85c0 test eax,eax 00007ffa`8a1cbc44 480f45d9 cmovne rbx,rcx 00007ffa`8a1cbc48 488bc3 mov rax,rbx 00007ffa`8a1cbc4b 4883c420 add rsp,20h 00007ffa`8a1cbc4f 5b pop rbx 00007ffa`8a1cbc50 c3 ret</code> </pre> <br><p>  Or rather, we see that a function inside the ntdll module calls another function inside the same module. </p><br><h2 id="sinteticheskie-simvoly">  Synthetic characters </h2><br><p>  Listing, after adding a synthetic module, has become more informative, but still not as eloquent as the original one.  It lacks <a href="https://docs.microsoft.com/windows-hardware/drivers/debugger/symbols">characters</a> (in our case, the names of the functions RtlFreeSid and RtlFreeHeap).  To fix this again, a call is required, but another software interface - <a href="https://docs.microsoft.com/windows-hardware/drivers/ddi/content/dbgeng/nf-dbgeng-idebugsymbols3-addsyntheticsymbol">IDebugSymbols3 :: AddSyntheticSymbol</a> .  <a href="https://githomelab.ru/pykd/pykd">Pykd</a> again <img src="https://habrastorage.org/webt/kz/-m/2t/kz-m2tie3aamd7obq0j1pmczjn8.png">  ready to help us with this: </p><br><pre> <code class="plaintext hljs">0:007&gt; !py Python 2.7.15 (v2.7.15:ca079a3ea3, Apr 30 2018, 16:30:26) [MSC v.1500 64 bit (AMD64)] on win32 Type "help", "copyright", "credits" or "license" for more information. (InteractiveConsole) &gt;&gt;&gt; addSyntheticSymbol(0x07ffa8a1cbc20, 0x31, 'RtlFreeSid') &lt;pykd.syntheticSymbol object at 0x0000014D47699518&gt; &gt;&gt;&gt; addSyntheticSymbol(0x07ffa8a176df0, 1, 'RtlFreeHeap') &lt;pykd.syntheticSymbol object at 0x0000014D476994A8&gt; &gt;&gt;&gt; exit()</code> </pre> <br><p>  The result is very similar to that when using symbols from the pdb file ntdll: </p><br><pre> <code class="plaintext hljs">0:007&gt; uf 00007ffa`8a1cbc20 ntdll!RtlFreeSid: 00007ffa`8a1cbc20 4053 push rbx 00007ffa`8a1cbc22 4883ec20 sub rsp,20h 00007ffa`8a1cbc26 488bd9 mov rbx,rcx 00007ffa`8a1cbc29 33d2 xor edx,edx 00007ffa`8a1cbc2b 65488b0c2560000000 mov rcx,qword ptr gs:[60h] 00007ffa`8a1cbc34 4c8bc3 mov r8,rbx 00007ffa`8a1cbc37 488b4930 mov rcx,qword ptr [rcx+30h] 00007ffa`8a1cbc3b e8b0b1faff call ntdll!RtlFreeHeap (00007ffa`8a176df0) 00007ffa`8a1cbc40 33c9 xor ecx,ecx 00007ffa`8a1cbc42 85c0 test eax,eax 00007ffa`8a1cbc44 480f45d9 cmovne rbx,rcx 00007ffa`8a1cbc48 488bc3 mov rax,rbx 00007ffa`8a1cbc4b 4883c420 add rsp,20h 00007ffa`8a1cbc4f 5b pop rbx 00007ffa`8a1cbc50 c3 ret</code> </pre> <br><h2 id="osobennosti-sinteticheskih-suschnostey">  Features of synthetic entities </h2><br><p>  It should be noted that the creation of synthetic symbols is allowed in any existing modules, and not only in synthetic ones.  That is, you can add symbols both to modules <a href="https://docs.microsoft.com/windows/desktop/dxtecharts/debugging-with-symbols">with accessible pdb files</a> , and to modules for which we do not have debug information files.  But characters outside modules cannot be created.  That is, to mark an arbitrary memory address outside the boundaries of existing modules, you need to create an embedding synthetic module at the beginning, and then (if necessary, the module name may be enough for <em>coloring</em> ) to create a synthetic symbol in it. </p><br><p>  It is also useful to mention that synthetic modules and symbols can be removed by <em>careless</em> hand movement: </p><br><ul><li>  reloading the module debugging symbols removes all the synthetic symbols of this module; </li><li>  rebooting all modules removes all synthetic modules. </li></ul><br><h2 id="synextshttpsgithubcomkiteresynexts">  <a href="https://github.com/kITerE/synexts">! synexts</a> </h2><br><p>  Although the use of <strong>pykd is</strong> convenient in the overwhelming majority of cases (especially given the presence of a <a href="https://githomelab.ru/pykd/pykd-ext">bootstarpper</a> to it), sometimes you can get into a situation where you need to spend considerable power to use pykd.  For example, I once needed to debug with the host machine, which was running Windows XP.  As it turned out, for a long time now, pykd does not support XP, and I needed synthetic symbols and modules.  It seemed to me that for this task it is easier to assemble a separate small extension that will solve a narrow circle of necessary tasks than to restore full XP support for pykd.  As a result, a separate <a href="https://github.com/kITerE/synexts">! Synexts</a> project was created. </p><br><p>  This is a simple extension that has two exports available to the user: </p><br><ul><li>  ! synexts.addsymbol - creates a synthetic symbol in any existing module; </li><li>  ! synexts.addmodule - creates a synthetic module in the internal list of the debug engine. </li></ul><br><p>  To demonstrate, we again imitate the hiding of the ntdll module: </p><br><pre> <code class="plaintext hljs">0:007&gt; .reload /u ntdll Unloaded ntdll 0:007&gt; uf 00007ffa`8a1cbc20 00007ffa`8a1cbc20 4053 push rbx 00007ffa`8a1cbc22 4883ec20 sub rsp,20h 00007ffa`8a1cbc26 488bd9 mov rbx,rcx 00007ffa`8a1cbc29 33d2 xor edx,edx 00007ffa`8a1cbc2b 65488b0c2560000000 mov rcx,qword ptr gs:[60h] 00007ffa`8a1cbc34 4c8bc3 mov r8,rbx 00007ffa`8a1cbc37 488b4930 mov rcx,qword ptr [rcx+30h] 00007ffa`8a1cbc3b e8b0b1faff call 00007ffa`8a176df0 00007ffa`8a1cbc40 33c9 xor ecx,ecx 00007ffa`8a1cbc42 85c0 test eax,eax 00007ffa`8a1cbc44 480f45d9 cmovne rbx,rcx 00007ffa`8a1cbc48 488bc3 mov rax,rbx 00007ffa`8a1cbc4b 4883c420 add rsp,20h 00007ffa`8a1cbc4f 5b pop rbx 00007ffa`8a1cbc50 c3 ret</code> </pre> <br><p>  Again, we restore knowledge about the module and the characters in the form of synthetic entities, but using the! Synexts extension: </p><br><pre> <code class="plaintext hljs">0:007&gt; !synexts.addmodule ntdll C:\Windows\System32\ntdll.dll 00007ffa`8a160000 0x01e1000 *** WARNING: Unable to verify timestamp for C:\Windows\System32\ntdll.dll Synthetic module successfully added 0:007&gt; !synexts.addsymbol RtlFreeSid 00007ffa`8a1cbc20 31 Synthetic symbol successfully added 0:007&gt; !synexts.addsymbol RtlFreeHeap 00007ffa`8a176df0 1 Synthetic symbol successfully added</code> </pre> <br><p>  It is assumed that the <a href="https://github.com/kITerE/synexts/releases">compiled synexts.dll library</a> (corresponding to the bit width used by WinDbg) you have already copied to the winext directory of the debugger: </p><br><pre> <code class="plaintext hljs">0:007&gt; .chain Extension DLL search Path: C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\WINXP;C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\winext;C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\winext\arcade;C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\pri;C:\Program Files (x86)\Windows Kits\10\Debuggers\x64;&lt;‚Ä¶&gt; Extension DLL chain: pykd.pyd: image 0.3.4.3, API 1.0.0, built Thu Jan 10 19:56:25 2019 [path: C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\winext\pykd.pyd] synexts: API 1.0.0, built Fri Jan 18 17:38:17 2019 [path: C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\winext\synexts.dll] &lt;‚Ä¶&gt;</code> </pre> <br><p>  And again we see the result of adding synthetic symbols to the synthetic module: </p><br><pre> <code class="plaintext hljs">0:007&gt; uf 00007ffa`8a1cbc20 ntdll!RtlFreeSid: 00007ffa`8a1cbc20 4053 push rbx 00007ffa`8a1cbc22 4883ec20 sub rsp,20h 00007ffa`8a1cbc26 488bd9 mov rbx,rcx 00007ffa`8a1cbc29 33d2 xor edx,edx 00007ffa`8a1cbc2b 65488b0c2560000000 mov rcx,qword ptr gs:[60h] 00007ffa`8a1cbc34 4c8bc3 mov r8,rbx 00007ffa`8a1cbc37 488b4930 mov rcx,qword ptr [rcx+30h] 00007ffa`8a1cbc3b e8b0b1faff call ntdll!RtlFreeHeap (00007ffa`8a176df0) 00007ffa`8a1cbc40 33c9 xor ecx,ecx 00007ffa`8a1cbc42 85c0 test eax,eax 00007ffa`8a1cbc44 480f45d9 cmovne rbx,rcx 00007ffa`8a1cbc48 488bc3 mov rax,rbx 00007ffa`8a1cbc4b 4883c420 add rsp,20h 00007ffa`8a1cbc4f 5b pop rbx 00007ffa`8a1cbc50 c3 ret</code> </pre> </div><p>Source: <a href="https://habr.com/ru/post/436644/">https://habr.com/ru/post/436644/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>