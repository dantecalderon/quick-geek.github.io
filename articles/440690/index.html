<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Features of working with Mesh in Unity</title>
  <meta name="description" content="Computer graphics, as is known, is the basis of the gaming industry. In the process of creating graphic content, we inevitably encounter difficulties ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>Features of working with Mesh in Unity</h1><div class="post__text post__text-html js-mediator-article">  Computer graphics, as is known, is the basis of the gaming industry.  In the process of creating graphic content, we inevitably encounter difficulties associated with the difference in its presentation in the creation environment and in the application.  The risks of simple human inattention are added to these difficulties.  Given the scale of game development, such problems occur either frequently or in large quantities. <br><br>  The struggle against such difficulties brought us to the thought of automation and writing articles on this topic.  Most of the material will relate to working with <b>Unity 3D</b> , since it is the main development tool in Plarium Krasnodar.  Hereinafter, 3D models and textures will be considered as graphic content. <br><br>  In this article we will talk about the features of access to data representation of 3D-objects in <b>Unity</b> .  The material will be useful primarily for beginners, as well as for those developers who rarely interact with the internal presentation of such models. <br><br><img src="https://habrastorage.org/webt/sh/4a/ou/sh4aousvny7jcs3jpcplosm9tbw.jpeg"><a name="habracut"></a><br><br><h3>  About 3D models in Unity - for the youngest </h3><br><img src="https://habrastorage.org/webt/_f/ir/tm/_firtmofn97mha8zhd0mxrhoigw.png"><br><br>  In the standard approach, <b>Unity</b> uses the <a href="https://docs.unity3d.com/ScriptReference/MeshFilter.html">MeshFilter</a> and <a href="https://docs.unity3d.com/Manual/class-MeshRenderer.html">MeshRenderer</a> components to render the model.  MeshFilter refers to the <a href="https://docs.unity3d.com/ScriptReference/Mesh.html">Mesh</a> -asset that represents the model.  For most shaders, geometry information is a mandatory minimum component for drawing a model on the screen.  Data on texture scanning and animation bones may be missing if they are not involved.  How this class is implemented inside and how everything is stored there is a secret for a <s>certain amount of money with</s> seven seals. <br><br>  From the outside, the mesh as an object provides access to the following data sets: <br><br><ul><li>  <b>vertices</b> - a set of positions of the vertices of the geometry in three-dimensional space with its own origin; </li><li>  <b>normals, tangents</b> - sets of normal vectors and tangents to vertices, which are usually used to calculate lighting; </li><li>  <b>uv, uv2, uv3, uv4, uv5, uv6, uv7, uv8</b> - sets of coordinates for the texture scan; </li><li>  <b>colors, colors32</b> - sets of vertex color values, a textbook example of which use is mask blending; </li><li>  <b>bindposes</b> - sets of matrices for positioning the vertices relative to the bones; </li><li>  <b>boneWeights</b> - coefficients of the influence of bones on the vertices; </li><li>  <b>triangles</b> - a set of indexes of vertices processed 3 at a time;  each such triple represents a polygon (in this case a triangle) of the model. </li></ul><br>  Access to information about vertices and polygons is implemented through the corresponding properties ( <b>properties</b> ), each of which returns an array of structures.  A person who <s>does not read the documentation</s> rarely works with meshes in <b>Unity</b> , it may not be obvious that whenever you access vertex data in memory, a copy of the corresponding set is created as an array with a length equal to the number of vertices.  This nuance is discussed in a small <a href="https://docs.unity3d.com/Manual/BestPracticeUnderstandingPerformanceInUnity4-1.html">block of documentation</a> .  Also warn about this comments to the properties of the class <b>Mesh</b> , as discussed above.  The reason for this behavior is the architectural feature of <b>Unity</b> in the context of the <a href="https://en.wikipedia.org/wiki/Mono_(software)">Mono</a> runtime <a href="https://en.wikipedia.org/wiki/Mono_(software)">environment</a> .  Schematically, this can be represented as: <br><br><img src="https://habrastorage.org/webt/wn/xp/0y/wnxp0y08-wuonzrdzmf6defkzac.jpeg"><br><br>  The engine core (UnityEngine (native)) is isolated from the developer scripts, and its functionality is accessed via the UnityEngine library (C #).  In fact, it is an adapter, since most methods serve as a layer for receiving data from the kernel.  At the same time, the kernel and the rest of it, including your scripts, rotate under different processes and the script part only knows the list of commands.  Thus, direct access to the memory used by the kernel from the script is missing. <br><br><h3>  About access to internal data, or How bad things can be </h3><br>  To demonstrate how bad things can be, let's analyze the amount of Garbage Collector memory being cleaned using the example from the documentation.  For ease of profiling, wrap the same code in the Update method. <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MemoryTest</span></span> : <span class="hljs-title"><span class="hljs-title">MonoBehaviour</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Mesh Mesh; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Update</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; Mesh.vertexCount; i++) { <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> x = Mesh.vertices[i].x; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> y = Mesh.vertices[i].y; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> z = Mesh.vertices[i].z; DoSomething(x, y, z); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DoSomething</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> z</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//nothing to do } }</span></span></code> </pre> <br>  We drove this script with a standard primitive - a sphere (515 vertices).  Using the <a href="https://docs.unity3d.com/Manual/Profiler.html">Profiler</a> tool, in the <a href="https://docs.unity3d.com/Manual/ProfilerMemory.html">Memory</a> tab, you can see how much memory was marked for cleaning by the garbage collector in each of the frames.  On our working machine, this value was ~ 9.2 MB. <br><br><img src="https://habrastorage.org/webt/fy/v0/zl/fyv0zl3ooi-u6vn5nmvyskzbrrg.png"><br><br>  This is quite a lot even for a loaded application, and we here started a scene with one object, on which the simplest script was hung. <br><br>  It is important to mention the features of the <b>.Net</b> compiler and code optimization.  Walking through the call chain, you may find that calling <b>Mesh.vertices</b> entails calling the <b>extern</b> method of the engine.  This prevents the compiler from optimizing the code inside our <b>Update ()</b> method, despite the fact that <b>DoSomething () is</b> empty and the <b>x, y, z</b> variables are unused for this reason. <br><br>  Now we cache the array of positions at the start. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MemoryTest</span></span> : <span class="hljs-title"><span class="hljs-title">MonoBehaviour</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Mesh Mesh; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Vector3[] _vertices; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Start</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _vertices = Mesh.vertices; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Update</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; _vertices.Length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> x = _vertices[i].x; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> y = _vertices[i].y; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> z = _vertices[i].z; DoSomething(x, y, z); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DoSomething</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> z</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//nothing to do } }</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/sf/fr/fd/sffrfdqcfcx_3ybl9eg94rd1vhm.png"><br><br>  An average of 6 KB.  Another thing! <br><br>  This feature was one of the reasons why we had to implement our own structure for storing and processing mesh data. <br><br><h3>  How we do it </h3><br>  While working on large projects, an idea arose to make a tool for analyzing and editing imported graphic content.  We will talk about the methods of analysis and transformation in the following articles.  Now let's consider the data structure that we decided to write for the convenience of algorithm implementation, taking into account the peculiarities of access to information about the mesh. <br><br>  Initially, this structure looked like this: <br><br><img src="https://habrastorage.org/webt/ep/2f/jx/ep2fjx87onpgda5ogkqgkg-u_ri.jpeg"><br><br>  Here the <b>CustomMesh</b> class represents the mesh itself.  Separately, in the form of <b>Utility,</b> we implemented the conversion from <b>UntiyEngine.Mesh</b> and back.  A mesh is defined by its array of triangles.  Each triangle contains exactly three edges, which in turn are defined by two vertices.  We decided to add to the vertices only the information that we need for analysis, namely: position, normal, two channels of the texture scan ( <b>uv0</b> for the main texture, <b>uv2</b> for lighting) and color. <br><br>  After some time, it became necessary to move up the hierarchy.  For example, to find out from the triangle which mesh it belongs to.  In addition, turning Down from <b>CustomMesh</b> to <b>Vertex</b> looked pretentious, and the unreasonable and significant amount of duplicate values ‚Äã‚Äãgot on my nerves.  For these reasons, the structure had to be reworked. <br><br><img src="https://habrastorage.org/webt/m5/8_/0p/m58_0pneh5z97etazjao0yofeli.jpeg"><br><br>  <b>CustomMeshPool</b> implements methods for easy management and access to all processed <b>CustomMesh</b> .  At the expense of the <b>MeshId</b> field in each of the entities there is access to the information of the entire mesh.  This data structure meets the requirements for the initial tasks.  It is easy to expand by adding the appropriate data set to <b>CustomMesh</b> and the necessary methods to <b>Vertex</b> . <br><br>  It should be noted that this approach is not optimal in terms of performance.  At the same time, most of the algorithms we implement are focused on analyzing the content in the <b>Unity</b> editor, which is why we don‚Äôt often have to think about the amount of memory used.  For this reason, we literally cache everything we can.  We first test the implemented algorithm and then refactor its methods and in some cases simplify data structures to optimize the execution time. <br><br>  That's all for now.  In the next article, we will discuss how to edit the 3D models already included in the project, and use the considered data structure. </div><p>Source: <a href="https://habr.com/ru/post/440690/">https://habr.com/ru/post/440690/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>