<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>As a programmer dataseativistam wrote</title>
  <meta name="description" content="Few people believe that a modern data science stack can be built not in Python, but there are such precedents :). The Odnoklassniki stack was formed f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>As a programmer dataseativistam wrote</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/efd/8f1/c81/efd8f1c8188db9553019884eb6b9bda1.png"><br><br>  Few people believe that a modern data science stack can be built not in Python, but there are such precedents :).  The Odnoklassniki stack was formed for many years, primarily by programmers who switched to data science, but still remained close to the products, so it is based on open JVM stack technologies: Hadoop, Spark, Kafka, Cassandra, etc.  This helps us to reduce the time and cost of commissioning models, but sometimes creates difficulties.  For example, when preparing basic solutions for the participants of <a href="https://snahackathon.org/">SNA Hackathon 2019,</a> I had to squeeze the will into a fist and plunge into the world of dynamic typing.  Details (and easy trolling) under the cut :) <br><a name="habracut"></a><br><h3>  Installation </h3><br><img src="https://habrastorage.org/getpro/habr/post_images/dc2/4eb/aff/dc24ebaff7995594e4a9abdef0f65bf6.jpg"><br><br>  Some kind of python can be found on almost any developer machine.  He was also found on mine, already in duplicate - 2.7 and 3.4.  Having rummaged in the memory bins, I remembered that I installed version 3.4 three years ago, after at SNA Hackathon 2016, participants ran into epic problems, trying to decompose a 1.5GB graph in memory (a small <a href="https://www.youtube.com/watch%3Fv%3DZlXjxB-3ISo%26feature%3Dyoutu.be">instructional video</a> and a <a href="https://mlbootcamp.ru/round/13/sandbox/">separate competition</a> resulted), but today it‚Äôs the economy is already morally obsolete and needed to be updated. <br><br>  In the world of Java, every project when assembling indicates everything that it wants to absorb in itself, and with it it lives on.  In theory, everything is simple and beautiful, but in practice, when you need library A and library B, you will surely find out that they both need library C, with two different incompatible versions :).  In vain attempts to break this vicious circle, some libraries pack all their dependencies into <a href="https://maven.apache.org/plugins/maven-shade-plugin/">themselves</a> and hide from the rest, while the rest spin as they can. <br><br>  What's wrong with that python?  There is no project as such, but there is an ‚Äúenvironment‚Äù, and within each environment, an independent ecosystem can be formed from packages of certain versions.  At the same time, there are <a href="https://www.anaconda.com/distribution/">tools for the lazy</a> , with the help of which the local Python environment is no more difficult to manage than the distributed heterogeneous cluster of Clouder or Horton.  But the mutual conflicts of the package versions are not going anywhere. I immediately ran into the fact that the release of <a href="http://pandas.pydata.org/pandas-docs/version/0.24/">Pandas 0.24</a> translated the <b>_maybe_box_datetimelike</b> private method into a public API, and it suddenly turned out that many people used it in its previous form and now fell off :) (and yes, Java world is all <a href="https://habr.com/ru/post/322840/">the same</a> ).  But in the end, I managed to fix everything, not counting the terrible varnings about new deprikeshishin, earned. <br><br><h3>  Collaborative baseline </h3><br><img src="https://habrastorage.org/getpro/habr/post_images/014/e7e/7b5/014e7e7b5ff3aa7c85a439e588e738fd.png" alt="image"><br><br>  Tasks on <a href="https://snahackathon.org/">SNA Hackathon 2019 are</a> divided into three areas - recommendations on logs, on texts and on pictures.  Let's start with the logs (the spoiler - the Cmd + C / Cmd + V megapattern with the stackflow also works with python).  Data was collected from live production - each user randomly, without weighing, showed some feed from his environment, after which all signs at the time of the show and the final reaction were recorded in the log.  The task of piece of cake: take the signs, shove in <a href="https://en.wikipedia.org/wiki/Logistic_regression">logreg</a> , profit! <br><br>  But the plan was filed at the first stage, on reading the data.  In theory, there is a wonderful <a href="https://arrow.apache.org/">Apache Arrow</a> package that should unify work with data in different ecosystems and, in particular, allow reading <a href="https://parquet.apache.org/">‚Äúparquet‚Äù files</a> from python without Spark.  In practice, it turned out.  that even with reading simple nested structures he has <a href="https://issues.apache.org/jira/browse/ARROW-1599">problems</a> , and our beautiful hierarchy has become a flat squalor :(. <br><br>  But there were also positive sides.  <a href="https://jupyter.org/">Jupyter</a> , in general, was pleased, he is almost as comfortable, though not as cute as <a href="http://zeppelin.apache.org/">Zeppelin</a> .  Even <a href="https://toree.apache.org/">the core rock</a> is!  Well, the speed of the logistic regression on a small piece of data in memory pleased me - it does not reach the power of the distributed variant, but it learns instantly on four signs and a couple of hundreds of thousands of examples. <br><br>  Then, however, there was enthusiasm that was hit hard in the stomach: if the necessary data transformation (grouped by key and put into list) is absent from the standard list and <b>apply</b> or <b>map</b> appears, then the speed drops by orders of magnitude.  As a result, 80% of the baseline time is taken not by reading the data, joins, model training and sorting, but banal listing. <br><br>  By the way, it is precisely because of this feature that I am always surprised at pySpark users - almost all standard functionality is available in the form of Spark SQL, which is the same in python and in the rock, and after the appearance of the first ten-thousand python computer with something personal the cluster turns into a pumpkin ... <br><br>  But in the end, all obstacles were overcome and <a href="https://github.com/MailRuChamps/snahackathon/blob/master/2019/Collaborative.ipynb">nine 0.6 paragraphs were</a> enough for score 0.65! <br><br><h3>  Text baseline </h3><br><img src="https://habrastorage.org/webt/f2/tq/ei/f2tqei-pbxqoaan8z1jhmyesija.png"><br><br>  Well, now we have a more difficult task - if the logreg can be found in hundreds of implementations for all platforms, then there is more variety of tools for working with texts under python.  Fortunately, the texts are already going not only raw, but also processed by our standard preprocessing system based on Spark and <a href="http://lucene.apache.org/">Lucene</a> .  Therefore, you can immediately take a list of tokens and not to steam by tokenization / lematization / steaming. <br><br>  For some time, I doubted what to take: the domestic <a href="https://bigartm.readthedocs.io/en/stable/">BigARTM</a> or the imported <a href="https://radimrehurek.com/gensim/">Gensim</a> .  As a result, I stopped at the second one and copied them with <a href="https://radimrehurek.com/gensim/models/doc2vec.html">doc2vec tutorial</a> :).  I hope my colleagues from the BigARTM team will not fail to take a chance and show the advantages of their library in the competition. <br><br>  We have a simple plan again: we take all the texts from the test, we train the Doc2Vec model, then we infer it on the tray and learn the logreg from its results (stacking is our everything!).  But, as usual, the problems started right away.  Despite the relatively modest amount of texts in the training set (only one and a half gigabytes), while trying to draw them into the pandas, the python devoured 20 (20, Karl!) Gigabytes of memory, went to the swap and did not return.  I had to eat an elephant in parts. <br><br>  When reading, we always indicate which columns to lift from the parquet, which allows us not to read the raw text in memory.  This saves its use by half, the test set documents are loaded into the memory for learning without problems.  With the training sample of such a trick is not enough, therefore, at a time we upload no more than one "parquet" file.  Further, in the downloaded file, we leave only the ID of those days that we want to use for training, and already on them is the embedding. <br><br>  Logreg over this works just as fast, and as a result we get <a href="https://github.com/MailRuChamps/snahackathon/blob/master/2019/Texts.ipynb">14 paragraphs</a> and score 0.54 :) <br><br><h3>  Picture baseline </h3><br><img src="https://habrastorage.org/webt/7_/6s/aw/7_6sawssmwohrrk1spxk9_zuqy8.jpeg"><br><br>  What could be more popular than deep learning?  Only seals!  Therefore, for a picture baseline, we made a brilliantly simple plan: we run a cat detector on the pictures from the test set, and then we rank the content according to the obtained score :) <br><br>  And again there is plenty to choose from.  Classification or detection?  pyTorch or Tensorflow?  The main criterion is the ease of implementation by copy-paste.  And the winner is ... <a href="https://gluon-cv.mxnet.io/build/examples_detection/demo_yolo.html">YOLOv3 on MXNet</a> :).  The laconicism of their demo captivated at first sight, but then, as usual, the problems started. <br><br>  What usually starts working with big data?  With an assessment of performance and the required machine time!  I wanted to make the baseline as autonomous as possible, so we taught it to work directly with the <a href="https://docs.python.org/3/library/tarfile.html">tar file</a> and quickly realized that at a speed of extracting from tar to tmpfs 200 photos per second, 352,758 images would need about half an hour to process.  We add loading and preprocessing of photos - 100 per second, about an hour for everything, norms.  Add a neural grid calculation - 20 pics per second, 5 hours, well, ok ... Add result retrieval - 1 photo per second, week, WTF? <br><br>  After a couple of hours of dancing with tambourines, an understanding comes that <b>NDArray</b> , which we observe, is never numpy, and the internal structure of MXNet, which does all the calculations, is lazy.  Bingo!  What to do?  Any beginner diplerner knows that the whole thing is in the size of a batch!  If MXNet calculates the score lazily, then if we first request them for a couple of dozen photos, and then we start extracting them, then perhaps the processing of photos will go batch?  And yes, after adding a batching at a speed of 10 photos per second, we managed to find all the seals :). <br><br>  Then we apply already known machinery and for <a href="https://github.com/MailRuChamps/snahackathon/blob/master/2019/Images.ipynb">10 paragraphs</a> we get score 0.504 :). <br><br><h3>  findings </h3><br><img src="https://habrastorage.org/webt/aq/yf/0n/aqyf0navjrowlvcgvn0k3a7hcne.jpeg"><br><br>  When one wise Sensei was asked, "Who will win, the master of aikido or karate?", He replied, "The master will win."  This experiment led us to roughly the same conclusions: there is not and cannot be an ideal language for all occasions.  With Python, you can quickly assemble a solution from ready-made blocks, but trying to move away from them with sufficiently large amounts of data will bring a lot of pain.  In Java and Scala you can also find many ready-made tools and easily implement your own ideas, but the languages ‚Äã‚Äãthemselves will be more demanding on the quality of the code. <br><br>  And, of course, good luck to all participants of <a href="https://snahackathon.org/">SNA Hackathon 2019</a> ! </div><p>Source: <a href="https://habr.com/ru/post/439394/">https://habr.com/ru/post/439394/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
</ul></nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>