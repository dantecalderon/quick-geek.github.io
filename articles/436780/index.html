<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The pitfalls of developing Google Play Instant</title>
  <meta name="description" content="Hi, Habr! My name is Kamo Spertsyan, I am engaged in Android development in PROFI.RU. I recently wrote an application with instant launch for our clie...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-6974184241884155",
      enable_page_level_ads: true
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>The pitfalls of developing Google Play Instant</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/8s/0b/hr/8s0bhr6qfo6kdcob953wsyx_0ci.png"><br><br>  Hi, Habr!  My name is Kamo Spertsyan, I am engaged in Android development in PROFI.RU.  I recently wrote an application with instant launch for our clients.  If you are not familiar with the technology, I invite you to first visit the <a href="https://developer.android.com/topic/google-play-instant/">Android Developers</a> . <br><br>  More than two years have passed since the presentation of Instant Apps (Google Play Instant) on Google I / O 2016.  There are many articles on the web on how to create applications with instant launch.  Judging by them, nothing complicated about it.  But in fact, this is not entirely true.  I will try to describe the main difficulties that I had to go from creating an empty project to publishing the Instant App on Google Play.  I hope the article will be useful to developers who still have this way. <br><a name="habracut"></a><br><h3>  Choice of approach </h3><br>  Most sources describe the process of converting the entire main application to the Instant App.  However, our application didn‚Äôt meet the 4MB limit and provided much more functionality than was required to familiarize with the service before installation.  Now Google in test mode has increased the allowable size of the application with an instant launch of up to 10 MB. <br><br>  I had a choice of two approaches to creating an Instant App.  The first is to take the finished application and cut out unnecessary functionality from it.  The second is to create an empty project and transfer into it the functionality that is needed.  Considering the first option fast, my colleagues and I tried it on a local hackathon and at the same time we were convinced that it was hopeless.  First, it took a lot of time (about 40 man-hours).  Secondly, the size of the application turned out to be very large due to the extra code and resources.  Thirdly, the extra code complicated maintenance.  We frantically tried to fit the resulting application of 4 MB during the hackathon, and in the end we still did not have time. <br><br><h3>  Migration of functionality </h3><br>  Having learned from bitter experience, I created an empty project and began to copy into it only the necessary application modules.  We have a modular architecture, so it was easy to do.  Here I ran into the first problem - in Instant Apps you cannot use services.  In my case, this restriction was not critical: we used the service to upload photos, and in the Instant App, we rejected this feature, motivating users to download the main application.  But this point should be taken into account if your application also uses services. <br><br>  To my surprise, the application obtained by copying only the necessary pieces of code still did not fit into the permissible 4 MB and weighed about 5 MB.  In <a href="https://developer.android.com/topic/google-play-instant/guides/reduce-module-size">this article,</a> Google gives advice on this case, but they helped me a little.  The only thing we could refuse was custom fonts, but their weight did not significantly affect the size of the APK. <br><br>  Then I remembered that ProGuard in our project is disabled in debug builds.  Simple inclusion <br><br><pre><code class="kotlin hljs">minifyEnabled <span class="hljs-literal"><span class="hljs-literal">true</span></span></code> </pre> <br>  reduced the size of the application almost doubled.  About a miracle - the limit of 4 MB is met! <br><br><h3>  Data migration </h3><br>  Next was to solve the issue with the migration of data.  As you know, Instant Apps are supported by the Android operating system from version 5.0.  At the same time, automatic data migration works only starting from Android 8.0.  To do this, it is enough to use the shared names in the two applications with the same name.  For versions from 5.0 to 7.1, you need to write the migration manually using the <a href="https://github.com/googlesamples/android-instant-apps/tree/master/cookie-api">Cookie API</a> or <a href="https://github.com/googlesamples/android-instant-apps/tree/master/storage-api">Storage API</a> .  I took advantage of the cookie and did not encounter any special problems - however, this required changes not only on the Instant App side, but also in the installed application.  So in the end I had to release a new version of the application and roll it out to the entire audience for the release of Instant App. <br><br><h3>  Debugging </h3><br>  With debugging, everything was not so simple. <br><br>  First, Google Play Instant does not support unprotected network connections, so forget about http, only https.  For me, this meant testing on production-servers, since all the test benches worked on http.  Not critical, but pleasant enough. <br><br>  Secondly, the launch of the Instant App itself: you can test the application as usual, installed, but only for a while.  When running via Android Studio, it is impossible to check the update of the Instant App to a ‚Äúfull-fledged‚Äù application.  For example, test how well the user data is transferred.  To do this, you need to run the application with an instant launch just like the Instant App.  This can be done in two ways: <br><br><ol><li>  run the application using a special utility from the Android SDK; </li><li>  put it in the console for internal testing and run through the Play Market. </li></ol><br>  The first method is quite convenient.  The utility is included in the Android SDK, but is not installed by default.  To install in Android Studio, follow these steps: <br><br><ol><li>  go to <i>Preferences</i> -&gt; <i>Appearance &amp; Behavior</i> -&gt; <i>System Settings</i> -&gt; <i>Android SDK</i> ; </li><li>  select the <i>SDK Tools</i> tab; </li><li>  put a tick near the <i>Google Play Instant Development SDK</i> and click <i>Apply</i> . </li></ol><br><img src="https://habrastorage.org/webt/v4/js/dw/v4jsdwq8brx2kcids6tgeann2-8.gif"><br>  In the last step, pay attention to the directory where the utility will be installed.  Further, regarding this path, we will be interested in the <abbr>./extras/google/instantapps/ia</abbr> file.  With it, you can simulate an instant application launch by running the command <br><br><pre> <code class="java hljs">ia run &lt;–ø—É—Ç—å –∫ APK-—Ñ–∞–π–ª—É, bundle-—É –∏–ª–∏ URL&gt;</code> </pre> <br>  Until the moment I came across this utility, I used the second method, with the constant publication of the application in the Google Play Console.  But since the published application does not appear in the store immediately, but after an indefinite time (it took me from half an hour to a day), this method of testing was worthless.  However, it is not intended for this.  By the way, if you publish the Instant App in the Google Play Console with great frequency, I advise you to provide the ability to determine the application version code after launch.  Otherwise, it is difficult to understand whether the last published version or the previous one was launched. <br><br><h3>  Publication </h3><br>  Finally, when your application is tested and ready for publication, do not rush to relax!  First, the version code ( <i>versionCode</i> ) of the Instant App should not exceed the version code of the application being installed.  I recommend giving space for creativity in advance: when you release the main application, indicate the obviously great value of the code so as not to tie your hands.  Delete released Instant App from the console in order to ‚Äúrelease‚Äù the version code for the other assembly will not work.  Formally, you have <code><i>NM</i></code> opportunities to release Instant App while you have a main application on Google Play with <code><i>versionCode = N</i></code> and an application with instant launch with <code><i>versionCode = M</i></code> <br><br>  Also for the release of Instant App make sure that it will be available to no larger audience than the main application.  In other words, every Instant App user should be able to install the main application. <br><br>  The audience‚Äôs permissions are primarily affected by the permissions of the application, specified in the Manifest file ( <i>permissions</i> ) - they must be the same for both applications (except for permissions that do not affect the audience).  For example, if your main application requires permission to determine geo-location, and in the Instant App it is not necessary, you still need to specify it there and there. <br><br>  Also some auxiliary libraries can narrow down the circle of end users.  So it was in our case.  The console gave the error <i>"targeting apk difference"</i> , although the permissions of both applications were the same.  In search of a solution, I came across <a href="https://stackoverflow.com/questions/45975231/google-play-console-error-non-upgradable-to-installed-app">this question</a> from Stack Overflow, where it is advised to run the APK application files through the <i>aapt</i> utility.  It will display detailed information about the files, including all dependencies.  Having calculated the difference in output for both files, I noticed a clue: the application being installed had the use <code>uses-gl-es: '0x20000'</code> , which was missing in the Instant App.  A brief surfing on the net led me to a clue: this line says that the application uses the OpenGL library, which, in turn, is used in maps.  Indeed, our main application used the <code>play-services-maps</code> library, but the Instant App did not.  Adding this dependency to the Instant App allowed me to finally release the application. <br><br><h3>  Summarize </h3><br><ol><li>  In Instant Apps, you cannot use services and unprotected networks (http).  The size of the final APK-file should not exceed 4 MB (perhaps soon this limit will be simplified to 10 MB). </li><li>  To reduce the size of the APK file, you can use optimizers and code obfuscators (for example, ProGuard). </li><li>  The transfer of SharedPreferences from the Instant App to the main application happens automatically for Android 8.0+, for earlier versions it is necessary to write manually through the <a href="https://github.com/googlesamples/android-instant-apps/tree/master/cookie-api">Cookie API</a> or the <a href="https://github.com/googlesamples/android-instant-apps/tree/master/storage-api">Storage API</a> .  It is necessary to take into account the need to release an application to be prepared for data migration before the release of Instant App. </li><li>  To debug the Instant App, you can use a special utility from the Google Play Instant Development SDK, included in the Android SDK. </li><li>  The appearance of the instant app published in the console on end devices can occur with a delay of half an hour to a day.  It is necessary to take care of the possibility to unambiguously determine which version of the Instant App has now been launched from the Play Market. </li><li>  The version code of the Instant App should not exceed the version code of the main application. </li><li>  The list of devices to which Instant App will be available should not exceed the list of devices to which the main application is available.  To do this, specify the same permissions in the Manifest files, and also pay attention to possible restrictions due to the auxiliary libraries. </li></ol><br>  That's all.  I hope this information will be useful to you.  I would appreciate any feedback! <br><br><h4>  Useful sources: </h4><br><ol><li>  <a href="https://developer.android.com/topic/google-play-instant/">Google Play Instant documentation on Android Developers</a> </li><li>  <a href="https://developer.android.com/topic/google-play-instant/guides/reduce-module-size">Tips for reducing the size of the APK file Instant App</a> </li><li>  <a href="https://developer.android.com/topic/google-play-instant/faqs">Google Play Instant FAQ</a> </li><li>  <a href="https://github.com/googlesamples/android-instant-apps/tree/master/cookie-api">Data Migration with Cookie API</a> </li><li>  <a href="https://github.com/googlesamples/android-instant-apps/tree/master/storage-api">Data Migration with the Storage API</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/436780/">https://habr.com/ru/post/436780/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>