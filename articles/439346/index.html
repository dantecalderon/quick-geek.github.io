<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Laravel + Docker: Our Successful Experience</title>
  <meta name="description" content="What is this article about 
 The article will talk about our experience of using Docker to quickly configure a scalable dev environment for web develo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>Laravel + Docker: Our Successful Experience</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/ih/ks/g2/ihksg2gat_j0kgx8le5kg9ihj24.jpeg" alt="image"><br><br><h2>  What is this article about </h2><br>  The article will talk about our experience of using Docker to quickly configure a scalable dev environment for web development.  I will briefly talk about the tasks that we faced and the tools that were chosen to solve these problems.  The article is marked with the tutorial icon, because you will find instructions on how to deploy the environment in it.  Compared to similar articles (links at the end of the article), there will be less technical details and more living examples. <br><a name="habracut"></a><br><h2>  What challenges we faced </h2><br>  It so happens that a new developer connects to an existing team.  So that he could start to perform tasks (in other words, write code and check his work), it‚Äôs not enough to get the source code.  You need an environment that includes a web server, a php compiler and a database.  This is the minimum set.  Depending on the project, the environment may include: <br><br><ul><li>  NoSQL; </li><li>  Queue server; </li><li>  Full-text search engine; </li><li>  Caching solution; </li><li>  Collectors; </li><li>  Useful developer tools; </li></ul><br>  All this should be installed locally by the developer, and be the same version as the rest of the team members.  And here there are difficulties: <br><br><ol><li>  After installation, you need to configure; </li><li>  The software is already installed, but it is a different version; </li><li>  It is long; </li></ol><br>  And the fact that developers work on different platforms (windows, linux, os x) complicates things even more. <br><br>  Docker was chosen to solve the problem.  Perhaps the main reason is that it fit easily into the existing infrastructure.  It works great on Linux, and most of our developers are on this OS. <br><br>  <b>Alternative</b> <br><br>  Laravel provides its own solution for organizing a local environment called Homestead.  This is a set of configs and scripts for Vagrant, with the help of which the necessary software is deployed in a VirtualBox virtual machine.  But the description of Homestead is beyond the scope of this article. <br><br><h2>  Project laradock </h2><br>  At the beginning, this project was aimed exclusively at launching Laravel on Docker, which is reflected in its name.  But as popularity grew in the php community, Laradock began to support other php projects: Symfony, CodeIgniter, WordPress, Drupal.  The project is really popular, it is actively supported and developed: <br><br><img src="https://habrastorage.org/webt/ir/yi/z5/iryiz5lvz9e3sjbqj1gx9sjgm7e.png" alt="image"><br><br>  Laradock is a set of pre-configured, independent Docker images that can be connected based on the requirements of your project.  Well documented and extremely easy to use.  To run the components, simply list them: <br><br><pre><code class="bash hljs">docker-compose up apache2 php-fpm mysql phpmyadmin</code> </pre> <br>  or <br><br><pre> <code class="bash hljs">docker-compose up nginx php-fpm mariadb adminer</code> </pre> <br>  <b>Note</b> : there is no need to explicitly specify php-fpm, since when you start the web server of the php-fpm containers, the container starts automatically. <br><br>  There are more than 48 containers in the repository, including: <br><br><ul><li>  <b>Databases</b> : MySQL, MariaDB, Percona, MongoDB, MSSQL, PostgreSQL </li><li>  <b>Database Management</b> : PhpMyAdmin, Adminer, PgAdmin </li><li>  <b>Web servers</b> : nginx, Apache2, Caddy </li><li>  <b>PHP compilers</b> : PHP FPM, HHVM </li><li>  <b>Miscellaneous</b> : Selenium, Jenkins, ElasticSearch, Kibana, Gitlab, Mailhog, MailDev, Laravel Echo, Phalcon </li><li>  <b>Tools</b> : PHP CLI, Composer, Git, Linuxbrew, Node, V8JS, Gulp, SQLite, xDebug, Envoy, Deployer, Vim, Yarn, Drush </li></ul><br><h2>  Requirements and initial conditions </h2><br>  You will need: <br><br><ul><li>  Git </li><li>  Docker </li></ul>  and the console in which commands will be executed.  The docker‚Äôs website has comprehensive installation documentation for various platforms (links are also at the end of the article).  If you have not yet installed git, do it according to the instructions from the official site. <br><br><h2>  Git repository architecture: main project and Laradock </h2><br>  Laradock can be used in two versions: <br><br><ul><li>  Separate laradock for each project </li><li>  One laradock on many projects </li></ul><br>  In the first case, the directory structure will look like this: <br><br><img src="https://habrastorage.org/webt/r3/lb/gq/r3lbgqvrv_fw68kiffdrva8pmh4.png" alt="image"><br><br>  In the second so: <br><br><img src="https://habrastorage.org/webt/a0/qf/6a/a0qf6aiftkofyuc0mjmb-y7tg14.png" alt="image"><br><br>  We <i>always</i> use the first option: one project - one laradock.  This approach provides the flexibility and independence of one project from another. <br><br>  The second important question: create one common repository or two separate ones?  In other words, do I need to add laradock files to the main repository with the project?  The answer is necessary, but in the form of a sub-module to the main repository.  Docker-environment is a supporting part of the project and it is not always required.  For example, on staging and production servers it is not necessary.  When deploying through git, the environment files will not get there. <br><br><h3>  Environment Directory Name </h3><br>  By default, the names of the containers use the name of the current directory as a suffix: laradock_nginx_1, laradock_mysql_1, etc.  To avoid confusing data inside volumes, you need unique directory names for your environments.  This is easy to achieve if you stick to the chosen scheme: add the project name to the name of the directory with the environment, for example: <br><br><ul><li>  laradock-mysite </li><li>  laradock-proj1 </li><li>  laradock-mobapp </li></ul><br>  that is, the prefix ‚Äúlaradock‚Äù and the name of the project directory through a hyphen. <br><br><h2>  Single site launch </h2><br>  How do we start the site launch? <br><br>  As we mentioned in the third chapter, we use Laradoc to create the environment. <br>  The startup process consists of stages of setting up the environment and laravel-application. <br><br><h3>  Project Settings </h3><br>  Laradoc has an environment configuration example file.  We create a copy of it for our project. <br><br><pre> <code class="bash hljs">cp env-example .env</code> </pre> <br>  The .env options are pretty obvious.  In the parameters we set the access to databases, e-mail parameters, access to third-party services, if we use in our project. <br><br>  Starting and stopping environment applications are done with docker-compose commands. <br><br><pre> <code class="bash hljs">docker-compose up</code> </pre> <br>  and <br><br><pre> <code class="bash hljs">docker-compose stop</code> </pre> <br>  If necessary, in the start-up team, you can load the necessary services.  For example, I will load three additional services: <br><br><pre> <code class="bash hljs">docker-compose up -d nginx percona adminer</code> </pre> <br>  You can remove this command in a separate shell script in order not to enter it manually each time. <br><br>  The startup script can be called ‚Äústart.sh‚Äù, or at your convenience: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env bash docker-compose up -d nginx percona adminer;</span></span></code> </pre> <br>  The service stop script can be called ‚Äústop.sh‚Äù, or ‚Äúdown.sh‚Äù: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env bash docker-compose stop;</span></span></code> </pre><br><img src="https://habrastorage.org/webt/yj/-8/-p/yj-8-pad9mq1b1eqdyi7k15i8pk.png" alt="image"><br><br><h3>  Project Initialization </h3><br>  The transition to the container environment is performed by the command <br><br><pre> <code class="bash hljs">docker-compose <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> --user=laradock workspace bash</code> </pre> <br><h3>  Deployment errors </h3><br>  When installing Laradoc in a linux environment, there may be a problem with file permissions. <br><br>  In this case, the files may be the wrong owner, or insufficient access rights. <br><br>  <b>Symptoms</b> : when you try to start the environment with the ‚Äúdocker-compose up‚Äù command or switch to the container with the ‚Äúdocker-compose exec ...‚Äù command, as in the example above, errors similar to <br><blockquote>  / var / www / vendor created </blockquote><blockquote>  The stream or file "/var/www/storage/logs/laravel.log" couldn‚Äôt be streaming: Permission denied </blockquote>  The reason for the error is that in the sample configuration of the docker environment, the User ID and User Group are strictly indicated, the default is 1000 and 1000, respectively. <br><br>  If in our unix-system these IDs are already occupied by other entities, then you need to manually edit the configuration. <br><br><h4>  Procedure for eliminating errors </h4><br>  We check the user and group directories: <br><br><pre> <code class="bash hljs">ls -la /var/www</code> </pre> <br>  File and directory owners (User and User Group) must be laradock laradock. <br><br>  If, instead of laradock: laradock, the owner and group are designated by numbers (1001: 1001, 1001: 13002 and similar combinations), then you need to make changes to the configuration files. <br><br>  If the ID of your Account and User Group (/ etc / passwd, / etc / group) do not coincide with the specified ones, then in order to work correctly, you need to make changes to the following files: <br><br>  / laradock / php-fpm / Dockerfile *, in line <br><br>  ‚Äú <b>RUN usermod -u 1000 www-data</b> ‚Äù <br><br>  replace 1000 with user ID <br><br>  /laradock/.env in rows <br><br>  WORKSPACE_PUID = 1000 <br>  WORKSPACE_PGID = 1000 <br><br>  WORKSPACE_PUID - specify your user ID, WORKSPACE_PGID - user group ID <br><br>  / laradock / workspace / Dockerfile *, in rows <br><br>  ARG PUID = 10315 <br>  ARG PGID = 10004 <br><br>  PUID - user ID, PGID - user group ID <br><br>  After making the changes, rebuild the workspace and php-fpm and then run the container: <br><br><pre> <code class="bash hljs">docker-compose build workspace php-fpm</code> </pre> <br>  If you encounter such a problem, you need to check the access rights to the Laravel framework directories.  Set permissions for directories that require write permissions: <br><br><pre> <code class="bash hljs">sudo chgrp -R www-data storage bootstrap/cache; sudo chmod -R ug+rwx storage bootstrap/cache</code> </pre> <br><h2>  SSL certificates and https </h2><br>  Most likely your site in production will work under a secure protocol.  It makes sense and local development to lead to https.  This is not very difficult to do, you need an SSL certificate and small settings.  Details are described in this article <a href="https://habr.com/post/352722/">How to issue a self-signed SSL certificate</a> . <br><br><h2>  Running multiple sites </h2><br>  So, all projects work according to the ‚ÄúOne Laradock - One Project‚Äù scheme.  But one project is not necessarily one site.  Sometimes you need to run several sites at the same time, because they will interact with each other. <br><br>  In this case, two laradock at the same time do not start, because each of them has a web server running that listens on port 80 ‚Äî we get a conflict.  But we have access to the nginx configs, let's configure it. <br><br>  But first, a note about architecture and git repositories.  In the case of several sites, we use the directory structure from the second option: <br><br><img src="https://habrastorage.org/webt/xe/jk/6o/xejk6oough4k7ovjnrb8sbs2n5e.png" alt="image"><br><br>  The git repository with laradock is no longer a submodule of another repository, but becomes completely independent. <br><br>  The web server configuration will be shown on the example of nginx.  In the laradock directory, go to nginx / sites.  We see the default.conf and several * .conf.example files.  Based on default.conf or sample files we create configurations for sites. <br><br>  Pay attention to the document root.  By default, the root directive looks like this: <br><br><pre> <code class="plaintext hljs">root /var/www/public;</code> </pre> <br>  and should like this: <br><br><pre> <code class="plaintext hljs">root /var/www/site-1/public; root /var/www/site-2/public;</code> </pre><br><blockquote>  <b>Important!</b> <br>  Look at the contents of .gitignore in this directory.  All * .conf files except default.conf are ignored.  You need to add the created files to the exceptions, that is, do not ignore them. <br></blockquote>  Configure the crontab so that the laravel scheduler can work correctly.  To do this, in the workspace / crontab / laradock file, add the following paths: <br><br><pre> <code class="plaintext hljs">* * * * * laradock /usr/bin/php /var/www/site-1/artisan schedule:run &gt;&gt; /dev/null 2&gt;&amp;1 * * * * * laradock /usr/bin/php /var/www/site-2/artisan schedule:run &gt;&gt; /dev/null 2&gt;&amp;1</code> </pre><br>  For successful communication sites inside containers, add aliases.  In the file docker-compose.yml we find the section <br><br><pre> <code class="plaintext hljs">### NGINX Server ###</code> </pre> <br>  and add an alias for each domain: <br><br><img src="https://habrastorage.org/webt/i1/ic/ia/i1iciamtphnc0sk1a7v4rl_jd9k.png" alt="image"><br><br>  This is all you need to do to run a project with multiple domains.  Outside the article, there remains the question of organizing https for several domains.  All by analogy with the organization of ssl for one domain, which is described in the section above.  Add a comment if there are difficulties, I will answer it or describe the features in a separate article. <br><br><h2>  Additional features </h2><br>  In the Docker environment space, it is possible to configure the applications we need.  The basic configuration of Laradoc already includes application packages: <br><br><table><tbody><tr><td>  Web application server </td><td>  Apache2 caddy </td></tr><tr><td>  Web Application Caching </td><td>  Nginx, Varnish </td></tr><tr><td>  Databases and Caching Services </td><td>  Mongo, Redis, Mssql, Mysql, Percona, Mariadb, Elasticsearch, Memcached, Redis, RethinkDb, Aerospike </td></tr><tr><td>  Web interfaces to databases </td><td>  Adminer, phpMyAdmin </td></tr><tr><td>  Load balancer </td><td>  Haproxy </td></tr><tr><td>  Programming, programming shells and frameworks </td><td>  Php, Python, Symfony, Laravel, Node </td></tr><tr><td>  Utilities </td><td>  Php, Python, Symfony, Laravel, Node </td></tr><tr><td>  Package manager </td><td>  Yarn, composer </td></tr><tr><td>  Testing tool </td><td>  Jenkins </td></tr><tr><td>  Application Infrastructure Configuration Tool </td><td>  Terraform </td></tr></tbody></table><br>  Briefly consider the most mentioned applications. <br><br>  <b>RabbitMQ</b> <br><br>  The mechanism of messaging between applications.  The developer of this package defines its designation as: ‚Äúqueue manager‚Äù, ‚Äúmessage broker‚Äù (message broker), or ‚Äúmessage queue‚Äù (message-queuing). <br><br>  A message can contain any data set. <br><br>  In the scenario of working with the queue manager, the message from one application - the sender - is saved until another application (receiver) connects and takes the message from the queue. <br><br>  <b>Redis</b> <br><br>  Create an in-memory data cache.  It can also be used as a data warehouse along with the database server, or by replacing it. <br><br>  Redis supports strings, lists, sets, ordered sets, and hash tables. <br>  The main disadvantage of radishes is data loss in case of clearing the RAM, when the OS is restarted, or when the hardware is turned off.  Radish developers have provided a similar scenario: in AOF (Append Only File) mode, data is added to the disk file every second. <br><br>  The main advantage of radishes is the fastest access to data with the speed of accessing RAM. <br><br><h2>  Links to materials </h2><br>  <a href="https://laravel.com/">Laravel</a> <br><br>  <a href="https://www.docker.com/">Docker</a> <br><br>  <a href="https://laradock.io/">Laradock</a> <br><br>  <a href="https://laravel.com/docs/5.7/homestead">Laravel homestead</a> <br><br>  <a href="https://habr.com/post/352722/">"How to issue a self-signed SSL certificate and make your browser trust it"</a> <br><br>  <a href="https://habr.com/post/425101">Docker + Laravel =</a> <br><br><h2>  Conclusion </h2><br>  Having chosen the Laravel + Docker solution for web development, we won the most valuable prize: time. <br><br>  Following the development scenario in WAMP or LAMP, we had to spend time <br>  useless and nowhere. <br><br>  Both WAMP and LAMP require a certain level of qualification from a php developer in areas that are not directly related to web development: configuring a web server, setting php parameters, etc. <br><br>  Using Laradoc allows us, once having created the entire project environment, to deploy it in a new workplace in the shortest time possible.  And get started right away. <br><br>  In conclusion, we note the advantages of using Laradoc: <br><br><ul><li>  unified, at every workplace, infrastructure: a web server, sql server, a set of frameworks and libraries; </li><li>  rational use of working time; </li><li>  quick entry of a new developer into the project. </li></ul><br>  Write in the comments how your team works with the environment, what tools and approaches you use. </div><p>Source: <a href="https://habr.com/ru/post/439346/">https://habr.com/ru/post/439346/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>