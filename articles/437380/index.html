<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Everyone scolds samopisnye test frameworks. And we are happy</title>
  <meta name="description" content="My name is Elena Rastorgueva, I am responsible for the ‚ÄúFactor‚Äù product in HFLabs . ‚ÄúFactor‚Äù is a damn complex algorithmic enterprise, it processes da...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-6974184241884155",
      enable_page_level_ads: true
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>Everyone scolds samopisnye test frameworks. And we are happy</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/nt/p-/0f/ntp-0fxrjpsarus7awbwtsdgdhu.jpeg"><br><br>  My name is Elena Rastorgueva, I am responsible for the ‚ÄúFactor‚Äù product in <a href="http://www.hflabs.ru/">HFLabs</a> .  ‚ÄúFactor‚Äù is a damn complex algorithmic enterprise, it processes data on an industrial scale. <br><br>  In the article I will tell you how we started to test "Factor", how we developed autotests and why we came up with self-written frameworks. <br><a name="habracut"></a><br><h2>  What kind of product is this - "Factor" </h2><br>  "Factor" cleans up data in databases with millions of customers: it removes typos in name, phone numbers and emails, checks passports, does a whole lot more.  The most difficult thing is to correct postal addresses. <br><br><img src="https://habrastorage.org/webt/sc/le/g8/scleg8hmrcclix90ouwukypheke.png"><br>  <sub>Addresses are written in hundreds of ways, so under the hood of the "Factor" is not weak algorithmic apparatus</sub> <br><br>  "Factor" works as a service: input data - data output. <br><br>  This is a stateless system, where each appeal does not depend on previous ones.  Stateless greatly simplifies the life of a tester.  It is much more difficult to test a stateful system when the sequence of actions is important. <br><br>  The product must be reliable as the MKS, because it is used by banks, mobile operators, insurance, retailers of the ‚ÄúRibbon‚Äù level.  For errors, we are responsible for the fact that the absence of errors is part of the SLA in the contract with the customer. <br><br>  Because of the reliability requirements of autotests, we wrote from the very beginning of development.  One of the criteria for the readiness of the task is ‚ÄúAutoTests added‚Äù. <br><br><h2>  Started with manual checks and autotests. </h2><br>  We released "Factor" in 2005 and first tested it with our hands.  In the morning, the tester ran autotests on a case file and compared the result of data processing with the result of the previous day: what changed after yesterday's code commit. <br><br>  The process could take half a day, this alignment was no good.  Therefore, we took the minimum set of tests for key functionality and wrapped it in unit tests.  These tests are fast, and the developer himself started them before the commit. <br><br>  Unit tests are so comfortable and work so fast that we add thousands of them.  And then they came up against it: when the tests look like a sheet of thousands of pieces of code, it is not easy even to reach the right place.  Not to mention adding or updating. <br><br><img src="https://habrastorage.org/webt/vd/a5/ua/vda5uatnzsl6du95r_x_jjbpsle.png"><br>  <sub>Unit test for checking the format of SNILS</sub> <br><br>  In addition, in the industrial data regularly there is something sudden that does not cover unit tests.  For example, a new customer has come with new features in the addresses, unit tests do not cover these features.  We need to sit down and see which tests to add for new data.  We still did it manually. <br><br><h2>  Created your own framework </h2><br>  In traditional unit tests, the data and code go interspersed, trying to find the right parts is difficult. <br><br>  Therefore, we tried autotests in the <a href="https://en.wikipedia.org/wiki/Data-driven_testing">Data Driven Testing (DDT)</a> paradigm.  DDT is when data for testing is stored separately from code for testing. <br><br>  Cases were loaded from an excel-file, they lay in the columns "Unclean data" and "Expected result".  DDT has become a breakthrough: updating cases in an exelnik is unspeakably simpler. <br><br>  Little by little, we developed an approach and developed our own framework for testing.  It accepts text files as input, inside them the source data and the expected result. <br><br><img src="https://habrastorage.org/webt/4z/ux/b2/4zuxb2hzdkjzampel0ioln9qksa.png"><br>  <sub>We refused excel files as storage: text files open faster, do not change content, it is easier to take data from them</sub> <br><br>  Standard tools help the framework: <br><br><ul><li>  TeamCity automatically runs tests every night; </li><li>  testNG compares the expected and actual results. </li></ul><br><img src="https://habrastorage.org/webt/js/3p/3x/js3p3xatz9q9u7qhd1hk7ahinfq.png"><br>  <sub>If the result is different from the expected one, the test turns red in TeamCity.</sub>  <sub>If everything is as it should, the test is green.</sub> <br><br><h2>  Finished the framework for themselves </h2><br>  12 years have passed since then.  During this time, the framework has acquired capabilities that are not found in standard solutions. <br><br>  <b>Accounting for task status in Jira.</b>  HFLabs adheres to <a href="https://ru.wikipedia.org/wiki/%25D0%25A0%25D0%25B0%25D0%25B7%25D1%2580%25D0%25B0%25D0%25B1%25D0%25BE%25D1%2582%25D0%25BA%25D0%25B0_%25D1%2587%25D0%25B5%25D1%2580%25D0%25B5%25D0%25B7_%25D1%2582%25D0%25B5%25D1%2581%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5">Test Driven Development</a> : first write a test or add test cases to a new behavior, and only then change the functionality. <br><br>  We have disabled new cases by commenting on the line.  Otherwise, at first they fell and interfered, because cases added before features or bug fixes. <br><br>  But the corresponding test case may not be completed: the bug will be extremely rare, or the customer will bring something more important.  Some tasks hung for months with low priority, and disconnected cases accumulated.  In this case, it is not clear to which task each case belongs, whether it is possible to delete this case. <br><br>  Therefore, we added a task number to the disconnected cases and screwed in some automation.  Now everything works like this: <br><br><ul><li>  the test case is disabled by matching the open task in Jira; <br><br><img src="https://habrastorage.org/webt/ny/xd/rb/nyxdrbvmz4np0kkgjgn5srct-cw.png"><br>  <sub>To bind the case to the task, we write in front of it <i>#</i> and the number of the task</sub> <br></li><li>  The framework runs tests even on disconnected cases.  But it ignores crashes, as long as the task is open in Jira; </li><li>  as soon as the task is closed, the test begins to fall on the cases attached to it.  This is a signal: the task was passed, and the cases were forgotten to be included; </li><li>  if suddenly the test for a disconnected case began to take place with an open task, the framework also reports this.  Perhaps it's time to turn on the case or close the task attached to it (plus update the release notes and inform customers). <br><br><img src="https://habrastorage.org/webt/ah/eb/vt/ahebvthx1cfsge12a5ofyjms408.png"><br>  <sub>The framework says that the disconnected case passes.</sub>  <sub>Perhaps someone corrected the code in another task, and now everything is working.</sub> <br></li></ul><br>  So we kept the TDD and won the forgetfulness while managing the test cases. <br><br><img src="https://habrastorage.org/webt/8s/df/1w/8sdf1wf1xib-di08-upv-njfwd8.png"><br>  <sub>We documented all the options with the status of test cases and related tasks in order not to forget</sub> <br><br>  <b>Actualization of test cases in semi-automatic mode.</b>  It would seem that if the test fails, look for an error in the code.  But for us this is not always the case.  It happens that it is necessary to update the test cases, because the requirements for the result have changed. <br><br>  For example, in the past, the customer wanted ‚ÄúMr.  Moscow "one field.  Now he has changed the architecture of the database, wants a ‚Äúcity‚Äù in one field, ‚ÄúMoscow‚Äù in another.  It's time to change test cases. <br><br>  For the fallen test TeamCity shows the difference between the expected and actual results.  We used to copy this difference and update test cases with our hands.  For massive changes - a very costly undertaking. <br><br><img src="https://habrastorage.org/webt/2g/cv/iu/2gcviu56ac4pgtbtb3me4k5cc_0.png"><br>  <sub>A living example: we taught "Factor" to determine the country by phone number, tests in TeamCity fell.</sub>  <sub>A new benchmark can be taken from the actual result, but it takes a long time.</sub> <br><br>  We made it so that the framework itself updated the standard.  To do this, after running the tests, it replaces in the benchmark the expected cleaning results with actual ones where they did not match.  The result is saved in artifacts as a case update file. <br><br><img src="https://habrastorage.org/webt/6e/ok/dp/6eokdpdk8hqlbsggw2e2zxsyxty.png"><br>  <sub>The first file is a new benchmark in which the framework updated the expected results.</sub>  <sub>The remaining files are input data, the old standard and the actual data for the fallen cases.</sub> <br><br>  With the new benchmark, the tester updates the cases in three steps. <br><br><ol><li>  Downloads the generated file. </li><li>  Checks through any tool merging, what changes have fallen into the new standard.  Leaves only the necessary. </li><li>  Commit </li></ol><br><img src="https://habrastorage.org/webt/wp/o8/xn/wpo8xnrbcyzdhqkbif0mafezhbs.png"><br>  <sub>The tester checks if the updates in the new benchmark are correct and commits them.</sub> <br><br>  Yes, if you update thoughtlessly, nothing good will come out.  But the risk of mindless updating is also when working manually. <br><br>  <b>Stabilization of test data stubs.</b>  "Factor" returns the processed data in dozens of fields.  In the address alone there are a lot of components: index, region, type of region, type of city, city, type of street, house, building, building, apartment.  To them, "Factor" clings to the Federal Tax Service Inspectorate, OKATO, OKTMO and even small things.  So from one line on an input tens values ‚Äã‚Äãare obtained. <br><br>  Not all fields from the result should be checked with test cases.  For example, recognition of the same address directly depends on the state directory - FIAS.  And in it fields regularly change, for our tasks absolutely strangers.  Updating any KLADR codes for homes dropped hundreds of test cases. <br><br>  We added stubs to the expected result when we realized that we were wasting time analyzing unimportant falls. <br><br>  When the field does not need to be checked at all, the tester writes the following symbol to the expected result: <i>$$ DNV $$</i> .  When the field is to be filled, but the value itself is not important: <i>$$ NE $$</i> . <br><br><img src="https://habrastorage.org/webt/ol/v6/e_/olv6e_wixlpjexljoquxpcgo4l8.png"><br>  <sub>FIAS ID in the address is always there, so we check it on all tests.</sub>  <sub>If the field is empty, something is wrong.</sub>  <sub>But the index may not be, therefore, when checking the FIAS ID index, we ignore</sub> <br><br>  It was possible to go the other way and divide the tests: on each field its own.  But it is difficult, because not everything can be isolated.  For example, the "city" and "street" are parts of the address and without each other does not make sense. <br><br><h2>  Self-written framework is more convenient </h2><br>  Therefore, I do not think that creating my own framework is a silly idea.  If we didn‚Äôt create our own tool, we wouldn‚Äôt get so many new opportunities and such flexibility. <br><br>  Turning off the text-case on the status of the task, the generation of a new standard, stubs on the result - these are the things that our testers are asking for in the other frameworks.  If we had taken standard solutions, we would never have been able to do this. <br><br>  <i>If you like to do complex things in the enterprise, come to us.</i>  <i>Now <a href="https://hh.ru/vacancy/29607794">we are looking for a java-developer</a> , salary from 135 000 ‚ÇΩ without deduction of personal income tax.</i> </div><p>Source: <a href="https://habr.com/ru/post/437380/">https://habr.com/ru/post/437380/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>