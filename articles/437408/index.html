<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>802.1x, EX2200, NPS and all-all-all ...</title>
  <meta name="description" content="The idea of ‚Äã‚Äãusing 802.1x as a means to combat unauthorized access to the network is not new. Each of us must have come across a courier from the del...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-6974184241884155",
      enable_page_level_ads: true
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>802.1x, EX2200, NPS and all-all-all ...</h1><div class="post__text post__text-html js-mediator-article">  The idea of ‚Äã‚Äãusing 802.1x as a means to combat unauthorized access to the network is not new.  Each of us must have come across a courier from the delivery service, who has a patchcord from the sleeve of his signature jacket, and you can already see how he, noticing a free RJ-45 outlet, rushes to her and‚Ä¶ <br><br>  However, if in the general concept of using and configuring 802.1x with authorization via RADIUS is beaten and simple, in this case there was an incident, the solution of which I propose below. <br><a name="habracut"></a><br>  <b>Given:</b> <br><br><ul><li>  Access switch - EX2200, JunOS 12.3R2. </li><li>  RADIUS server based on NPS Windows Server 2012R2. </li></ul><br><ul><li>  A diverse zoo of devices of the form - TVs, AppleTV, printers and other small network animals, unable as normal and adequate members of the network to authenticate with certificates or PEAP.  For each of the devices in Active Directory, its own account in the corresponding OU with sAMAccountName = MAC (in lower case, without division signs), password = sAMAccountName. </li></ul><br>  A separate FineGrainedPasswordPolicy has been created for departments or security groups containing these devices in order to be able to set passwords that do not meet security standards. <br><br>  Original config for 802.1x on EX2200: <br><br><pre><code class="plaintext hljs">//set actual interfaces set interfaces interface-range ACCESS_PORTS member "ge-0/0/[0-40]" // Config interface range as L2 ports set interfaces interface-range ACCESS_PORTS unit 0 family ethernet-switching set protocols dot1x authenticator authentication-profile-name dynamicvlan set protocols dot1x authenticator radius-options use-vlan-id set protocols dot1x authenticator interface ACCESS_PORTS supplicant single set protocols dot1x authenticator interface ACCESS_PORTS transmit-period 10 set protocols dot1x authenticator interface ACCESS_PORTS retries 0 set protocols dot1x authenticator interface ACCESS_PORTS mac-radius set protocols dot1x authenticator interface ACCESS_PORTS supplicant-timeout 10 //set actual reject-vlan and fail-vlan set protocols dot1x authenticator interface ACCESS_PORTS server-reject-vlan default set protocols dot1x authenticator interface ACCESS_PORTS server-fail vlan-name default set protocols dot1x authenticator interface ACCESS_PORTS guest-vlan default //set actual password set access radius-server 172.17.xx secret "xxx" set access profile dynamicvlan authentication-order radius set access profile dynamicvlan radius authentication-server 172.17.xx</code> </pre> <br>  All workstations are logged in without any problems, but any of the above riffraffs is not.  <b>Wireshark</b> persistently showed that NPS sends an Access-Reject with EAP code 4, which, as is well known in narrow circles, means Failure. <br><br>  Informative, however, as always ... <br><br>  The protocol used by supplicant for mac-radius authentication, the default is EAP-MD5. <br><br>  There are more options for PEAP and PAP. <br><br>  PEAP is not available for EX2200. <br><br>  We try to configure PAP.  In plain text, of course, I didn‚Äôt really want to, but, for not having the best, we drive in the cherished team <br><br><pre> <code class="plaintext hljs">set protocols dot1x authenticator interface ACCESS_PORTS mac-radius authentication-protocol pap</code> </pre><br>  and (drum roll) - Syntax error - Juniper helpfully informs us. <br><br>  During fights, threats with a soldering iron and other repressive measures, the Juniper site suggested that this option is available only for firmware from the 15.1 release. <br><br>  It would seem, here it is, the solution.  But no, the same Juniper not only recommends, but also in every possible way protects customers from such lewdness as firmware 15.1 on EX2200.  Grit, utilization of the CPU and RAM is above the norm, therefore 12.3 is the ceiling of the JunOS version for the lucky owners of EX2200. <br><br>  OK, we will deal with the protocol that sends the switch data to the NPS. <br><br>  So it turned out that by default he sends them to eap-md5, which one?  - correctly, disabled in Windows Server, starting already with the 2008 release - they say, non-securized.  Several queries to Google give the desired result - a reg-file that includes the protocol we need. <br><br>  However, the NPS persistently responds to requests from printers and other <b>Access-Rejects</b> . <br>  He took out cigarettes, remembered that he had thrown, hid ... <br><br>  Google, who in the world ... But no, this is from another opera ... <br><br>  Ok Google?  <i>802.1x MAC authentication with NPS RADIUS</i> <br><br>  After a few pages of Google, on the forum ubnt found the desired.  It is necessary to include several parameters for credentials of devices, then recreate passwords and - voila - Miracle.  Moreover, it turned out even better than expected.  Eap-md5, of course, is not God's message, but still better than plain text. <br><br>  The resulting config, settings and screenshots of the policy under the spoiler. <br><br><div class="spoiler">  <b class="spoiler_title">EX2200 configuration, NPS policy</b> <div class="spoiler_text">  <i>The magic reg-file that includes support for EAP-MD5 in Windows Server 2012 R2</i> <br><br><pre> <code class="plaintext hljs">Windows Registry Editor Version 5.00 [HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\RasMan\PPP\EAP\4] "RolesSupported"=dword:0000000a "FriendlyName"="MD5-Challenge" "Path"=hex(2):25,00,53,00,79,00,73,00,74,00,65,00,6d,00,52,00,6f,00,6f,00,74,\ 00,25,00,5c,00,53,00,79,00,73,00,74,00,65,00,6d,00,33,00,32,00,5c,00,52,00,\ 61,00,73,00,63,00,68,00,61,00,70,00,2e,00,64,00,6c,00,6c,00,00,00 "InvokeUsernameDialog"=dword:00000001 "InvokePasswordDialog"=dword:00000001</code> </pre> <br>  After making changes to the registry, you must restart the NPS service. <br><br><pre> <code class="plaintext hljs">Stop-Service IAS Start-Service IAS</code> </pre> <br>  <i>The script that exposes the necessary settings for accounts of devices:</i> <br><br><pre> <code class="plaintext hljs">$devices=Get-ADUser -SearchBase "ou=802.1x-groups,ou=devices_groups,dc=company,dc=local" -Filter * foreach ($device in $devices) { set-aduser -Identity $device.name -UserPrincipalName ($device.name+"@company.local") -PasswordNeverExpires $true -AllowReversiblePasswordEncryption $true -CannotChangePassword $true Set-ADAccountPassword -Identity $device.name -NewPassword (ConvertTo-SecureString -AsPlainText $device.name -force) }</code> </pre> <br>  In fact, it sets the parameters equivalent to the screenshot.  But one thing is to put down for a couple of devices, and quite another when you have more than twenty of them.  Also, the script resets the password for the device account, which is necessary after enabling reversible encryption. <br><br><img src="https://habrastorage.org/webt/an/bg/be/anbgbeol62k1b6z8ggilno0mdry.png" alt="image"><br><br>  <i>NPS policy settings:</i> <br><br><ul><li>  Specify the group with the device and the type of port. <br><br><img src="https://habrastorage.org/webt/3m/56/nf/3m56nfzul_m4hgqajodg8_1o9he.png"></li><li>  After manipulating the registry, our coveted MD5-Challenge appears in the list of available protocols.  His and choose. <br><br><img src="https://habrastorage.org/webt/iv/or/bz/ivorbzx3cc3owpxytsmfzcjzpgu.png"></li><li>  The remaining settings are set based on the requirements of the logical implementation.  No different from the standard RADIUS + 802.1x configuration. <br><br><img src="https://habrastorage.org/webt/q6/ta/z9/q6taz9g0pganoesjbos2kwu6_ai.png"></li></ul><br></div></div><br>  <b>Total:</b> <br><br><ul><li>  Network devices, such as TVs, Apple TV, printers are authenticated to 802.1x and group membership. </li><li>  Passwords are not transmitted in the clear, but somehow it is encrypted. </li></ul><br>  <b>List of tips, guides and resources:</b> <br><br>  <a href="https://kb.juniper.net/InfoCenter/index%3Fpage%3Dcontent%26id%3DKB21476">Juniper recommendations for software version on EX2200</a> <br>  <a href="https://apps.juniper.net/feature-explorer/feature-info.html%3FfKey%3D7076%26fn%3DEAP-PAP%2520protocol%2520support%2520for%2520MAC%2520RADIUS%2520authentication">Juniper EAP-PAP support for MAC RADIUS Authentication</a> <br>  <a href="https://community.ubnt.com/t5/UniFi-Routing-Switching/802-1x-MAC-authentication-with-NPS-RADIUS-on-UniFi-switch/m-p/2619736">UBNT community, which gave the last kick in the right direction</a> </div><p>Source: <a href="https://habr.com/ru/post/437408/">https://habr.com/ru/post/437408/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>