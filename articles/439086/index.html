<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Causes of ANR and how to avoid it</title>
  <meta name="description" content="ANR (Application Not Responding) - an error that occurs when an application does not respond. As a result, a dialog opens prompting the user to wait o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-6974184241884155",
      enable_page_level_ads: true
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>Causes of ANR and how to avoid it</h1><div class="post__text post__text-html js-mediator-article">  ANR (Application Not Responding) - an error that occurs when an application does not respond.  As a result, a dialog opens prompting the user to wait or close the application. <br><img src="https://habrastorage.org/webt/50/gr/0g/50gr0gslgsaj7gzonmj9g_8pb3w.png" alt="image alt" align="left"><br><h4>  ANR conditions </h4><br><ul><li>  Input events (buttons and touch events) are not processed for 5 seconds; </li><li>  BroadcastReceiver (onRecieve ()) was not processed within the specified time (foreground - 10 s, background - 60 s); </li><li>  ContentProvider not completed within 10 seconds. </li></ul><br>  Normally the main thread is blocked. <br><br>  If you read my articles, you probably already got used to the fact that we are crawling into the source code.  So let's see what <a href="">ANR</a> looks like <a href="">under the hood</a> . <br><br>  The class <a href="">AppErrors</a> deals with processing not only ANR, but also other errors that may occur in the application, including crash.  The handleShowAnrUi () method just opens this scary window for many developers and users, displaying ANR. <a name="habracut"></a><br><br><pre><code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppErrors</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleShowAnrUi</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Message msg)</span></span></span><span class="hljs-function"> </span></span>{ Dialog dialogToShow = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (mService) { AppNotRespondingDialog.Data data = (AppNotRespondingDialog.Data) msg.obj; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProcessRecord proc = data.proc; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (proc == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { Slog.e(TAG, <span class="hljs-string"><span class="hljs-string">"handleShowAnrUi: proc is null"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (proc.anrDialog != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { Slog.e(TAG, <span class="hljs-string"><span class="hljs-string">"App already has anr dialog: "</span></span> + proc); MetricsLogger.action(mContext, MetricsProto.MetricsEvent.ACTION_APP_ANR, AppNotRespondingDialog.ALREADY_SHOWING); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } Intent intent = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(<span class="hljs-string"><span class="hljs-string">"android.intent.action.ANR"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!mService.mProcessesReady) { intent.addFlags(Intent.FLAG_RECEIVER_REGISTERED_ONLY | Intent.FLAG_RECEIVER_FOREGROUND); } mService.broadcastIntentLocked(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, intent, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, AppOpsManager.OP_NONE, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, MY_PID, Process.SYSTEM_UID, <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-comment"><span class="hljs-comment">/* </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> Verify */</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> showBackground = Settings.Secure.getInt(mContext.getContentResolver(), Settings.Secure.ANR_SHOW_BACKGROUND, <span class="hljs-number"><span class="hljs-number">0</span></span>) != <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mService.canShowErrorDialogs() || showBackground) { dialogToShow = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AppNotRespondingDialog(mService, mContext, data); proc.anrDialog = dialogToShow; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { MetricsLogger.action(mContext, MetricsProto.MetricsEvent.ACTION_APP_ANR, AppNotRespondingDialog.CANT_SHOW); <span class="hljs-comment"><span class="hljs-comment">// Just kill the app if there is no dialog to be shown. mService.killAppAtUsersRequest(proc, null); } } // If we've created a crash dialog, show it without the lock held if (dialogToShow != null) { dialogToShow.show(); } } ...</span></span></code> </pre> <br>  However, ANR does not start here.  As I said above, one of the first causes of this error is the delay in the input event, which is 5 seconds.  With a short search, we can find where this value is given. <br><br><pre> <code class="java hljs">namespace android { <span class="hljs-comment"><span class="hljs-comment">// Default input dispatching timeout if there is no focused application or paused window // from which to determine an appropriate dispatching timeout. const nsecs_t DEFAULT_INPUT_DISPATCHING_TIMEOUT = 5000 * 1000000LL; // 5 sec</span></span></code> </pre> <br>  Now we can see in the code where the native part is called.  This happens in the <a href="">InputManagerService</a> class. <br><br><pre> <code class="java hljs"> <span class="hljs-comment"><span class="hljs-comment">// Native callback. private long notifyANR(InputApplicationHandle inputApplicationHandle, InputWindowHandle inputWindowHandle, String reason) { return mWindowManagerCallbacks.notifyANR( inputApplicationHandle, inputWindowHandle, reason); }</span></span></code> </pre><br>  And here is the mWindowManagerCallbacks in <a href="">InputMonitor</a> : <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (appWindowToken != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; appWindowToken.appToken != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// Notify the activity manager about the timeout and let it decide whether // to abort dispatching or keep waiting. final AppWindowContainerController controller = appWindowToken.getController(); final boolean abort = controller != null &amp;&amp; controller.keyDispatchingTimedOut(reason, (windowState != null) ? windowState.mSession.mPid : -1); if (!abort) { // The activity manager declined to abort dispatching. // Wait a bit longer and timeout again later. return appWindowToken.mInputDispatchingTimeoutNanos; } } else if (windowState != null) { try { // Notify the activity manager about the timeout and let it decide whether // to abort dispatching or keep waiting. long timeout = ActivityManager.getService().inputDispatchingTimedOut( windowState.mSession.mPid, aboveSystem, reason); if (timeout &gt;= 0) { // The activity manager declined to abort dispatching. // Wait a bit longer and timeout again later. return timeout * 1000000L; // nanoseconds } } catch (RemoteException ex) { } } return 0; // abort dispatching }</span></span></code> </pre> <br>  Let's take a closer look at inputDispatchingTimedOut ().  This is where we show the message through the ActivityManager about the timeout and let the user decide whether to cancel the action or continue waiting.  And it is in <a href="">ActivityManagerService</a> that AppErrors is called in case of a crash or ANR. <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makeAppCrashingLocked</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ProcessRecord app, String shortMsg, String longMsg, String stackTrace)</span></span></span><span class="hljs-function"> </span></span>{ app.crashing = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; app.crashingReport = generateProcessError(app, ActivityManager.ProcessErrorStateInfo.CRASHED, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, shortMsg, longMsg, stackTrace); startAppProblemLocked(app); app.stopFreezingAllLocked(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> handleAppCrashLocked(app, shortMsg, longMsg, stackTrace); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makeAppNotRespondingLocked</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ProcessRecord app, String activity, String shortMsg, String longMsg)</span></span></span><span class="hljs-function"> </span></span>{ app.notResponding = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; app.notRespondingReport = generateProcessError(app, ActivityManager.ProcessErrorStateInfo.NOT_RESPONDING, activity, shortMsg, longMsg, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); startAppProblemLocked(app); app.stopFreezingAllLocked(); }</code> </pre> <br><h4>  ANR root causes </h4><br><ul><li>  I / O lock </li><li>  Network overload </li><li>  Blocking threads </li><li>  Endless cycle </li><li>  Business logic takes too long </li></ul><br><h4>  How to avoid ANR </h4><br><ul><li>  The main user interface thread executes logic associated only with the user interface; </li><li>  Complex calculations (for example, database operations, I / O operations, network operations, etc.) are performed in a separate thread; </li><li>  Use Handler to communicate between the user interface thread and the workflow; </li><li>  Use RxJava, etc.  for processing asynchronous operations. </li></ul><br><h4>  How to catch ANR </h4><br><ul><li>  Information about the <a href="https://developer.android.com/topic/performance/vitals/anr">ANR</a> can be stored in the file /data/anr/traces.txt, or in another path / data / anr / anr_ *.  You can get it using the following commands: <br><br><pre> <code class="bash hljs">adb root adb shell ls /data/anr adb pull /data/anr/&lt;filename&gt;</code> </pre> </li><li>  Use the open source project <a href="https://github.com/SalomonBrys/ANR-WatchDog">ANR-WatchDog</a> to detect ANR </li><li>  See How to avoid ANR :) </li></ul><br>  PS I publish all the selections in the <a href="https://t.me/paradisecurity">@paradisecurity</a> telegram. </div><p>Source: <a href="https://habr.com/ru/post/439086/">https://habr.com/ru/post/439086/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container">Waiting for the list from <a href="../../index.html">here</a>...</nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>