<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The adapter for working with the blockchain Ethereum for the InterSystems IRIS data platform</title>
  <meta name="description" content="1. Blockchain 
 Now, when I write this article, the Bitcoin course has fallen more than 5 times relative to the maximum value and telling me that I di...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>The adapter for working with the blockchain Ethereum for the InterSystems IRIS data platform</h1><div class="post__text post__text-html js-mediator-article"><h4>  1. Blockchain </h4><br>  Now, when I write this article, the Bitcoin course has fallen more than 5 times relative to the maximum value and telling me that I did something related to the blockchain, the first thing I hear is undisguised skepticism - ‚Äúwho needs all this blokchain now‚Äù . <br><br>  Yes, really, the HYIP around the blockchain is over.  But the underlying technologies remain, they evolve and will continue to evolve and be used in certain niches. <a name="habracut"></a>  On the Internet and in particular on Habr√© a lot of materials describing both the general directions of application of technologies (for example, <a href="https://habr.com/company/bitfury/blog/353350/">habr.com/company/bitfury/blog/353350</a> and more particular examples <a href="https://habr.com/company/raiffeisenbank/blog/332756/">habr.com/company/raiffeisenbank/blog/332756</a> ). <br><br>  As is known, the blockchain is a distributed registry, i.e.  a database that is distributed among several nodes, with each node keeping a complete copy of the registry.  The feature of the blockchain is that the records (transactions) are grouped into blocks, and the blocks are combined into a chain of blocks.  In this case, only operations for adding data are available.  All this leads to the fact that it is almost impossible to make changes to transactions already stored in the blockchain. <br><br>  There are a lot of materials about how the blockchain works (if you have not heard anything about the blockchain before, then you can start with <a href="https://www.youtube.com/watch%3Fv%3DpqUy1s8PSPM">this simple video</a> ). <br><br>  At the time of the maximum burst of interest in the blockchain technology, there were many calls to use the blockchain absolutely everywhere.  However, there are certain signs of projects / tasks that may require a blockchain. <br><br>  First, the participation of a large number of players (users) who record data, while it is necessary to prevent discrepancies and increase the level of trust. <br><br>  Secondly, the absence of a third party that everyone trusts. <br><br>  Thirdly, the need for a mechanism for public data verification. <br>  If all the above conditions are met - you need to think about using the blockchain. <br><br>  Such tasks can arise in any industry.  The project <a href="http://www.101blockchains.com/">www.101blockchains.com</a> collects information about both potential and implemented projects, as well as about the peculiarities of using blockchain in different areas. <br><br>  For example, in the healthcare sector, the blockchain can be used: <br><br><ul><li>  for the safe management of patient data; </li><li>  to combat counterfeit drugs through unchanged transactions throughout the supply chain; </li><li>  to improve the monitoring and effectiveness of clinical trials by eliminating fraud and manipulating data. </li></ul><br>  When using the blockchain in the corporate segment, a private blockchain is usually used with a different level of permissions (Private Permissioned Blockchain).  In such networks there is a special set of nodes for confirming transactions. <br><br>  However, when developing the first InterSystems IRIS adapter for working with the blockchain, we chose <a href="https://www.ethereum.org/">Ethereum</a> , which belongs to the category of Permissionless Blockchain - an open platform without a governing body.  This choice is associated with the popularity of Ethereum and a well-developed infrastructure: the presence of various tools and libraries.  You can also notice that using the software for working with Ethereum, you can <a href="https://habr.com/ru/post/341466/">create a private blockchain</a> . <br><br><h4>  2. Adapter </h4><br>  Now it's time to go to the adapter itself. <br><br>  An adapter in InterSystems IRIS (as well as in Ensemble) is a class or class package of InterSystems IRIS classes that provide the ability to work with an external system.  InterSystems IRIS adapters are divided into incoming (to receive data from an external system when the external system is the initiator of interaction) and outgoing (to work with the external system when the initiator of the interaction is InterSystems IRIS). <br><br>  The IRIS Ethereum adapter is an outbound adapter and is slightly different from most other InterSystems IRIS adapters, since part of this adapter is the InterSystems IRIS class package, but the adapter also includes a small NodeJS module.  The architecture is shown in Figure 1. <br><br><img src="https://habrastorage.org/webt/mo/kz/3c/mokz3cufv-4t24zab_oeouy5ef8.png"><br>  <i>Picture 1.</i> <br><br>  The NodeJS adapter module uses the existing NodeJS libraries to work with Ethereum. <br><br>  The adapter provides the following features: <br><br><ul><li>  Place a smart contract in Ethereum (we are planning to prepare another article in which we will tell you more about smart contracts, development tools and discuss an example). </li><li>  Call methods of smart contracts: as methods that do not change the state of the blockchain, and methods that change the state of the blockchain </li><li>  Saving transaction (transfer of funds from wallet to wallet) </li><li>  Calling helper methods to get blockchain status </li><li>  Log all requests (performs NodeJS module, useful for debugging) </li></ul><br>  <a href="https://openexchange.intersystems.com/package/Ethereum-Interoperability-Adapter">The adapter is available with <b>OpenExchange</b> source codes</a> . <br><br><h4>  3. A simple example </h4><br>  Along with the adapter, the ‚ÄúHello world‚Äù example is installed. <br><br>  To get started with Ethereum (including starting this example) you will need: <br><br><ul><li>  Choose which network you will work with.  For development usually use test networks such as Ropsten. </li><li>  Create a wallet in this network and top it up </li><li>  Install a local Ethereum client (for example, Geth) or get a key for working with a cloud provider (for example, Infura) </li></ul><br>  When setting up a business transaction, you need to set (Figure 2): <br><br><ol><li>  Server and port where NodeJS module is running (port 3000 by default) </li><li>  Provider settings (in this case, access to Infura) </li><li>  Access credentials (in the credentials of access, you must specify your wallet as the user name, as the password - the private key of the purse. In InterSystems IRIS, the credentials of access are stored in a separate database for which you need to enable encryption) </li></ol><br><img src="https://habrastorage.org/webt/ei/kr/bv/eikrbvchchjm5xwkbrfv9qm4olk.png"><br>  <i>Figure 2.</i> <br><br>  To work with smart contracts, you will need to create (for each smart contract you will apply) a folder in the file system and place 2 files there: <br>  * abi.txt <br>  * bytecode.txt <br><br>  These files must have ABI smart contract and Bytecode.  ABI smart contract - a formal description of the interface of a smart contract in json-format.  ABI and Bytecode are created at the time of compiling the smart contract. <br><br>  Bytecode is required only to deploy a contract. <br><br>  Using the testing service, you can verify the operation of a business transaction. <br><br>  In Figure 3, a smart contract is deployed using the test service.  The result of calling this business operation is a message containing the transaction hash. <br><br><img src="https://habrastorage.org/webt/it/qm/wk/itqmwkzesdspagy8vxdwh0klpn4.png"><br>  <i>Figure 3.</i> <br><br>  Using the ropsten.etherscan.io browser (https://etherscan.io/), you can find this transaction and get the address of the placed smart contract. <br><br>  To implement the smart contract methods using the adapter, you must specify the settings in the product configuration: ContractFolder and ContractAddress. <br><br>  The code for calling a smart contract method is quite simple: <br><br><pre><code class="go hljs">set ..ContractABI = [].%FromJSON(..ContractFolder_<span class="hljs-string"><span class="hljs-string">"abi.txt"</span></span>) set contract = ..Adapter.GetContract( ##class(Ethereum.Address).%New(..ContractAddress), ..ContractABI) set result = contract.hello() set pResponse = ##class(Ens.StringContainer).%New(result.args)</code> </pre> <br>  Using the GetContract adapter method, which is passed the address of the smart contract and the ABI, a smart contract object is created, which is then used to invoke the methods.  In this case, the hello () method that returns the string must be defined in the smart contract. <br><br>  In this example, the hello () method does not change the state of the blockchain, so it can be called synchronously.  However, methods changing the blockchain state can take quite a long time (waiting for confirmation of the transaction). <br><br>  To call such methods, you can use the deferred response mechanism in InterSystems IRIS.  The adapter needs to send a deferred token (deferred) and then when confirming the NodeJS transaction, the module will transfer the result of its execution to InterSystems IRIS.  To do this, you need to configure the web application and add a business transaction to the products that will process the response received. <br><br>  The code to call the method that changes the state of the blockchain: <br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// getting EthereumAccount(wallet) and privateKey do ##class(Ens.Config.Credentials).GetCredentialsObj(.cred, "Ethereum.Demo.EthereumOperation", "Ens.Config.Credentials", ..Credentials) set account = ##class(Ethereum.Address).%New(cred.Username) set privateKey = cred.Password //reading contract ABI set ..ContractABI = [].%FromJSON(..ContractFolder_"abi.txt") // get contract object set contract = ..Adapter.GetContract( ##class(Ethereum.Address).%New(..ContractAddress), ..ContractABI) $$$ThrowOnError(..DeferResponse(.deferred)) // estimate gas do contract.SetOptions(account) set gasJSON = contract.EstimateGas("setName",pRequest.Name) $$$TRACE(gasJSON.gas) do contract.SetOptions(account, privateKey, ##class(Ethereum.Wei).%New(1000000000), ##class(Ethereum.Wei).%New(100*gasJSON.gas),,deferred) set result = contract.setName(pRequest.Name)</span></span></code> </pre> <br>  In this case, before calling the setName () smart contract method, you must specify a number of parameters, including a delayed response token. <br><br>  In our next article, we will discuss in more detail about smart contracts and give an example of solving an applied problem using the InterSystems IRIS Ethereum adapter. </div><p>Source: <a href="https://habr.com/ru/post/439560/">https://habr.com/ru/post/439560/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
</ul></nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52319614 = new Ya.Metrika({
                  id:52319614,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52319614" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>